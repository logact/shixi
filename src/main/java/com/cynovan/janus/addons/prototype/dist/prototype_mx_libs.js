/**
 * Copyright (c) 2006-2019, JGraph Ltd
 * Copyright (c) 2006-2019, draw.io AG
 */

// urlParams is null when used for embedding
window.urlParams = window.urlParams || {};

// isLocalStorage controls access to local storage
window.isLocalStorage = window.isLocalStorage || false;

// Disables loading settings in configured mode
window.mxLoadSettings = window.mxLoadSettings || urlParams['configure'] != '1';

// Checks for SVG support
window.isSvgBrowser = window.isSvgBrowser || (navigator.userAgent.indexOf('MSIE') < 0 || document.documentMode >= 9);

// CUSTOM_PARAMETERS - URLs for save and export
window.EXPORT_URL = window.EXPORT_URL || 'https://exp.draw.io/ImageExport4/export';
window.PLANT_URL = window.PLANT_URL || 'https://exp-plant.draw.io/plantuml4';
window.DRAW_MATH_URL = window.DRAW_MATH_URL || 'https://www.draw.io/math';
window.SAVE_URL = window.SAVE_URL || 'save';
window.OPEN_URL = window.OPEN_URL || 'open';
window.PROXY_URL = window.PROXY_URL || 'proxy';
window.VIEWER_URL = null;

// Paths and files
window.SHAPES_PATH = window.SHAPES_PATH || 'shapes';
// Path for images inside the diagram
window.GRAPH_IMAGE_PATH = window.GRAPH_IMAGE_PATH || 'img';
window.ICONSEARCH_PATH = window.ICONSEARCH_PATH || ((navigator.userAgent.indexOf('MSIE') >= 0 ||
    urlParams['dev']) && window.location.protocol != 'file:' ? 'iconSearch' : 'https://www.draw.io/iconSearch');
window.TEMPLATE_PATH = window.TEMPLATE_PATH || 'templates';
window.NEW_DIAGRAM_CATS_PATH = window.NEW_DIAGRAM_CATS_PATH || 'newDiagramCats';
window.PLUGINS_BASE_PATH = window.PLUGINS_BASE_PATH || '';

// Directory for i18 files and basename for main i18n file
window.RESOURCES_PATH = window.RESOURCES_PATH || 'resources';
window.RESOURCE_BASE = window.RESOURCE_BASE || RESOURCES_PATH + '/dia';

// Specifies global configuration via variable
window.DRAWIO_CONFIG = window.DRAWIO_CONFIG || null;

// Sets the base path, the UI language via URL param and configures the
// supported languages to avoid 404s. The loading of all core language
// resources is disabled as all required resources are in grapheditor.
// properties. Note that in this example the loading of two resource
// files (the special bundle and the default bundle) is disabled to
// save a GET request. This requires that all resources be present in
// the special bundle.
window.mxLoadResources = window.mxLoadResources || false;
window.mxLanguage = window.mxLanguage || (function () {
    var lang = (urlParams['offline'] == '1') ? 'en' : urlParams['lang'];

    // Known issue: No JSON object at this point in quirks in IE8
    if (lang == null && typeof (JSON) != 'undefined') {
        // Cannot use mxSettings here
        if (isLocalStorage) {
            try {
                var value = localStorage.getItem('.drawio-config');

                if (value != null) {
                    lang = JSON.parse(value).language || null;
                }
            } catch (e) {
                // cookies are disabled, attempts to use local storage will cause
                // a DOM error at a minimum on Chrome
                isLocalStorage = false;
            }
        }
    }

    return lang;
})();

// Add new languages here. First entry is translated to [Automatic]
// in the menu defintion in Diagramly.js.
window.mxLanguageMap = window.mxLanguageMap ||
    {
        'i18n': '',
        'id': 'Bahasa Indonesia',
        'ms': 'Bahasa Melayu',
        'bs': 'Bosanski',
        'bg': 'Bulgarian',
        'ca': 'Català',
        'cs': 'Čeština',
        'da': 'Dansk',
        'de': 'Deutsch',
        'et': 'Eesti',
        'en': 'English',
        'es': 'Español',
        'fil': 'Filipino',
        'fr': 'Français',
        'it': 'Italiano',
        'hu': 'Magyar',
        'nl': 'Nederlands',
        'no': 'Norsk',
        'pl': 'Polski',
        'pt-br': 'Português (Brasil)',
        'pt': 'Português (Portugal)',
        'ro': 'Română',
        'fi': 'Suomi',
        'sv': 'Svenska',
        'vi': 'Tiếng Việt',
        'tr': 'Türkçe',
        'el': 'Ελληνικά',
        'ru': 'Русский',
        'sr': 'Српски',
        'uk': 'Українська',
        'he': 'עברית',
        'ar': 'العربية',
        'th': 'ไทย',
        'ko': '한국어',
        'ja': '日本語',
        'zh': '简体中文',
        'zh-tw': '繁體中文'
    };

if (typeof window.mxBasePath === 'undefined') {
    window.mxBasePath = 'mxgraph';
}

if (window.mxLanguages == null) {
    window.mxLanguages = [];

    // Populates the list of supported special language bundles
    for (var lang in mxLanguageMap) {
        // Empty means default (ie. browser language), "en" means English (default for unsupported languages)
        // Since "en" uses no extension this must not be added to the array of supported language bundles.
        if (lang != 'en') {
            window.mxLanguages.push(lang);
        }
    }
}

/**
 * Returns the global UI setting before runngin static draw.io code
 */
window.uiTheme = window.uiTheme || (function () {
    var ui = urlParams['ui'];

    // Known issue: No JSON object at this point in quirks in IE8
    if (ui == null && typeof JSON !== 'undefined') {
        // Cannot use mxSettings here
        if (isLocalStorage) {
            try {
                var value = localStorage.getItem('.drawio-config');

                if (value != null) {
                    ui = JSON.parse(value).ui || null;
                }
            } catch (e) {
                // cookies are disabled, attempts to use local storage will cause
                // a DOM error at a minimum on Chrome
                isLocalStorage = false;
            }
        }
    }

    // Uses minimal theme on small screens
    try {
        if (ui == null) {
            var iw = window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth;

            if (iw <= 414) {
                ui = 'min';
            }
        }
    } catch (e) {
        // ignore
    }

    return ui;
})();

/**
 * Global function for loading local files via servlet
 */
function setCurrentXml(data, filename) {
    if (window.parent != null && window.parent.openFile != null) {
        window.parent.openFile.setData(data, filename);
    }
};

/**
 * Overrides splash URL parameter via local storage
 */
(function () {
    // Known issue: No JSON object at this point in quirks in IE8
    if (typeof JSON !== 'undefined') {
        // Cannot use mxSettings here
        if (isLocalStorage) {
            try {
                var value = localStorage.getItem('.drawio-config');
                var showSplash = true;

                if (value != null) {
                    showSplash = JSON.parse(value).showStartScreen;
                }

                // Undefined means true
                if (showSplash == false) {
                    urlParams['splash'] = '0';
                }
            } catch (e) {
                // ignore
            }
        }
    }

    // Customizes export URL
    var ex = urlParams['export'];

    if (ex != null) {
        ex = decodeURIComponent(ex);

        if (ex.substring(0, 7) != 'http://' && ex.substring(0, 8) != 'https://') {
            ex = 'http://' + ex;
        }

        EXPORT_URL = ex;
    }

    // Customizes gitlab URL
    var glUrl = urlParams['gitlab'];

    if (glUrl != null) {
        glUrl = decodeURIComponent(glUrl);

        if (glUrl.substring(0, 7) != 'http://' && glUrl.substring(0, 8) != 'https://') {
            glUrl = 'http://' + glUrl;
        }

        DRAWIO_GITLAB_URL = glUrl;
    }

    var glId = urlParams['gitlab-id'];

    if (glId != null) {
        DRAWIO_GITLAB_ID = glId;
    }

    // URL for logging
    window.DRAWIO_LOG_URL = window.DRAWIO_LOG_URL || '';

    //Adds hard-coded logging domain for draw.io domains
    var host = window.location.host;

    if (host != 'test.draw.io') {
        var searchString = 'draw.io';
        var position = host.length - searchString.length;
        var lastIndex = host.lastIndexOf(searchString, position);

        if (lastIndex !== -1 && lastIndex === position) {
            window.DRAWIO_LOG_URL = 'https://log.draw.io';
        }
    }
})();

// Enables offline mode
if (urlParams['offline'] == '1' || urlParams['demo'] == '1' || urlParams['stealth'] == '1' || urlParams['local'] == '1') {
    urlParams['picker'] = '0';
    urlParams['gapi'] = '0';
    urlParams['db'] = '0';
    urlParams['od'] = '0';
    urlParams['gh'] = '0';
    urlParams['tr'] = '0';
}

// Disables math in offline mode
if (urlParams['offline'] == '1' || urlParams['local'] == '1') {
    urlParams['math'] = '0';
}

// Lightbox enables chromeless mode
if (urlParams['lightbox'] == '1') {
    urlParams['chrome'] = '0';
}

// Fallback for cases where the hash property is not available
if ((window.location.hash == null || window.location.hash.length <= 1) &&
    urlParams['open'] != null) {
    window.location.hash = urlParams['open'];
}

// urlParams is null when used for embedding
window.urlParams = window.urlParams || {};

// Public global variables
window.MAX_REQUEST_SIZE = window.MAX_REQUEST_SIZE || 10485760;
window.MAX_AREA = window.MAX_AREA || 15000 * 15000;

// URLs for save and export
window.EXPORT_URL = window.EXPORT_URL || '/export';
window.SAVE_URL = window.SAVE_URL || '/save';
window.OPEN_URL = window.OPEN_URL || '/open';
window.RESOURCES_PATH = window.RESOURCES_PATH || 'resources';
window.RESOURCE_BASE = window.RESOURCE_BASE || window.RESOURCES_PATH + '/grapheditor';
window.STENCIL_PATH = window.STENCIL_PATH || 'stencils';
window.IMAGE_PATH = window.IMAGE_PATH || 'images';
window.STYLE_PATH = window.STYLE_PATH || 'styles';
window.CSS_PATH = window.CSS_PATH || 'styles';
window.OPEN_FORM = window.OPEN_FORM || 'open.html';

// Sets the base path, the UI language via URL param and configures the
// supported languages to avoid 404s. The loading of all core language
// resources is disabled as all required resources are in grapheditor.
// properties. Note that in this example the loading of two resource
// files (the special bundle and the default bundle) is disabled to
// save a GET request. This requires that all resources be present in
// each properties file since only one file is loaded.
window.mxBasePath = window.mxBasePath || '../../../src';
window.mxLanguage = window.mxLanguage || urlParams['lang'];
window.mxLanguages = window.mxLanguages || ['de'];

NeptuneHandler = function (_graph, _editor) {
    this.graph = _graph;
    this.editor = _editor;
    this.bindEvent();
};

NeptuneHandler.prototype.bindEvent = function () {
    var self = this;
    this.graph.addListener(mxEvent.CELLS_ADDED, function (graph, mxEvent) {
        var mxCell = _.get(mxEvent, 'properties.cells[0]');
        if (mxCell) {
            self.renderMxCell(mxCell);
        }
    });

    this.graph.addListener(mxEvent.CELLS_RESIZED, function (graph, mxEvent) {
        var mxCell = _.get(mxEvent, 'properties.cells[0]');
        if (mxCell) {
            self.renderMxCell(mxCell);
        }
    });

    this.editor.addListener('fileLoaded', function () {
        self.renderPage();
    });

    this.editor.addListener('pageSelected', function () {
        self.renderPage();
    });
};

NeptuneHandler.prototype.renderPage = function () {
    var cells = this.graph.getChildVertices(this.graph.getDefaultParent());
    var self = this;
    _.each(cells, function (mxCell) {
        self.renderMxCell(mxCell);
    });
};

NeptuneHandler.prototype.renderMxCell = function (cell) {
    var self = this;
    var style = cell.style;
    if (style.indexOf('tag2=field') !== -1) {
        self.renderField(cell);
    } else if (style.indexOf('tag2=linechart') !== -1) {
        self.renderLineChart(cell);
    } else if (style.indexOf('tag2=control') !== -1) {
        self.renderControlField(cell);
    } else if (style.indexOf('tag2=dashboard') !== -1) {
        self.renderDashboard(cell);
    } else if (style.indexOf('tag2=historychart') !== -1) {
        self.renderHistoryDataChart(cell);
    } else if (style.indexOf("tag2=timeline") !== -1) {
        self.renderTimeline(cell);
    } else if (style.indexOf("tag2=flowbar") !== -1) {
        self.renderFlowBar(cell);
    } else if (style.indexOf("tag2=progressbar") !== -1) {
        self.renderProgressBar(cell);
    } else if (style.indexOf("tag2=map") !== -1) {
        self.renderMap(cell);
    } else if (style.indexOf("tag2=realtime") !== -1) {
        self.renderRealtime(cell);
    }
};

NeptuneHandler.prototype.getCellAttr = function (mxCell, key) {
    return this.graph.getAttributeForCell(mxCell, key);
};

NeptuneHandler.prototype.renderTimeline = function (mxCell, uuid) {
    var self = this;
    var deferred = $.Deferred();

    var componentId = this.getComponentId(mxCell);
    var geometry = mxCell.geometry;
    var content = `<div class="component-content timeline_component" id="${componentId}" style="width:${geometry.width}px;height:${geometry.height}px;">
                        <div class="timeline-action" style="position: absolute;z-index: 100">
                            <div class="timeline-btn">
                                <button class="timeline-action-btn today btn-primary btn btn-xs ">今天</button>
                                <button class="timeline-action-btn yesterday  btn-success btn btn-xs ">昨天</button>
                            </div>
                            <div class="status-info">
                                <span><i class="fa fa-circle" style="color:#029359"></i> 正常<br><span class="normal" ></span></span>
                                <span><i class="fa fa-circle" style="color:#F0C600"></i> 警告<br><span class="warning"></span></span>
                                <span><i class="fa fa-circle" style="color:#D50C38"></i> 报警<br><span class="alarm"></span></span>
                                <span><i class="fa fa-circle" style="color:#CCCCCC"></i> 离线<br><span class="offline"></span></span>                                  
                            </div>                                                      
                        </div>                                          
                        <div class="component-status-chart"></div>         
                        <div class="component-timeline"></div>                    
                    </div>`;
    this.setLabel(mxCell, content);

    var range = self.getCellAttr(mxCell, 'timeline_range');
    if (_.isEmpty(range)) {
        range = 'today';
    }
    setTimeout(function () {
        DeviceTimelineService.getChartConfig(echarts, uuid, range, "", "").done(function (config) {
            var timeline_options = config.options;
            var state_options = config.stateoptions;
            _.set(timeline_options, "dataZoom[0].height", 8);

            let normal_duration = moment.duration(config.normalduration);
            let warning_duration = moment.duration(config.warningduration);
            let alarm_duration = moment.duration(config.alarmduration);
            let offline_duration = moment.duration(config.offlineduration);
            if (!uuid) {
                timeline_options.yAxis.data = [];
                timeline_options.series[0].data = [];
                _.set(state_options, "series[0].data", [0, 0, 0]);
            }
            var component = $('#' + componentId);
            var status_info = component.find(".status-info");
            status_info.find(".normal").text(getTime(normal_duration, uuid));
            status_info.find(".warning").text(getTime(warning_duration, uuid));
            status_info.find(".alarm").text(getTime(alarm_duration, uuid));
            status_info.find(".offline").text(getTime(offline_duration, uuid));

            var timeline_chart = echarts.init(component.find('.component-timeline')[0], null, {
                width: (geometry.width / 4) * 2.6,
                height: geometry.height
            });
            var stateChart = echarts.init(component.find('.component-status-chart')[0], null, {
                width: (geometry.width / 4) * 1.4,
                height: geometry.height
            });
            timeline_chart.setOption(timeline_options);
            stateChart.setOption(config.stateoptions);
            deferred.resolve(timeline_chart, config, stateChart);
        });
    }, 300);

    function getTime(duration, uuid) {
        if (uuid) {
            return duration.hours() + 'h' + duration.minutes() + 'm' + duration.seconds() + 's';
        } else {
            return '0h0m0s';
        }
    }

    return deferred;
};

NeptuneHandler.prototype.renderHistoryDataChart = function (mxCell) {
    var self = this;
    var componentId = this.getComponentId(mxCell);
    var geometry = mxCell.geometry;
    var content = `<div class="component-content" id="${componentId}" style="width:${geometry.width}px;height:${geometry.height}px;"><div class="component-chart"></div></div>`;

    this.setLabel(mxCell, content);

    var deferred = $.Deferred();
    var fields = self.getCellAttr(mxCell, 'fields');
    var chartType = self.getCellAttr(mxCell, 'chart_type') || 'line-chart1';// 历史数据图表类型.
    if (fields) {
        fields = JSON.parse(fields);
    }
    var style = self.graph.getCellStyle(mxCell);
    var type = "line";
    if (chartType === 'line-chart1') {
        type = "line";
    } else if (chartType === 'bar-chart1') {
        type = "bar";
    }
    var series = [];
    var legendData = [];
    _.each(fields, function (item) {
        legendData.push(item.name);
        series.push({
            name: item.name,
            key: item.id,
            type: type,
            data: []
        });
    });
    var xData = [];
    var option = {
        tooltip: {
            trigger: 'axis'
        },
        legend: {
            data: legendData,
            textStyle: {
                color: style.fontColor,
            }
        },
        grid: [{}],
        textStyle: {
            color: style.fontColor
        },
        xAxis: {
            type: 'category',
            data: xData,
            axisLine: {
                lineStyle: {
                    color: style.fontColor
                }
            }
        },
        yAxis: {
            type: 'value',
            axisLine: {
                lineStyle: {
                    color: style.fontColor
                }
            }
        },
        series: series
    };
    setTimeout(function () {
        var myChart = echarts.init($('#' + componentId).find('.component-chart')[0], null, {
            width: geometry.width,
            height: geometry.height
        });

        myChart.setOption(option);
        deferred.resolve(myChart, xData, series);
    }, 300);
    return deferred;
};

NeptuneHandler.prototype.renderLineChart = function (mxCell) {
    var self = this;
    var deferred = $.Deferred();
    //替换里面的内容
    var componentId = this.getComponentId(mxCell);
    var geometry = mxCell.geometry;
    var content = `<div class="component-content" id="${componentId}" style="width:${geometry.width}px;height:${geometry.height}px;"><div class="component-chart"></div></div>`;

    this.setLabel(mxCell, content);

    var device_uuid = self.getCellAttr(mxCell, 'device_uuid');
    var device_fields = self.getCellAttr(mxCell, 'device_fields');
    if (device_fields) {
        device_fields = JSON.parse(device_fields);
    }
    var style = self.graph.getCellStyle(mxCell);
    var series = [];
    var legendData = [];

    _.each(device_fields, function (item) {
        legendData.push(item.name);
        series.push({
            name: item.name,
            key: item.key,
            type: 'line',
            data: []
        });
    });
    var xData = [];
    var option = {
        tooltip: {
            trigger: 'axis'
        },
        legend: {
            data: legendData,
            textStyle: {
                color: style.fontColor,
            }
        },
        grid: [{
            left: 50,
            right: 20,
            bottom: 25,
            top: 35
        }],
        textStyle: {
            color: style.fontColor
        },
        xAxis: {
            type: 'category',
            boundaryGap: false,
            data: xData,
            axisLine: {
                lineStyle: {
                    color: style.fontColor
                }
            }
        },
        yAxis: {
            type: 'value',
            axisLine: {
                lineStyle: {
                    color: style.fontColor
                }
            }
        },
        series: series
    };
    setTimeout(function () {
        var myChart = echarts.init($('#' + componentId).find('.component-chart')[0], null, {
            width: geometry.width,
            height: geometry.height
        });
        myChart.setOption(option);
        deferred.resolve(myChart, xData, series);
    }, 300);
    return deferred;
};
NeptuneHandler.prototype.renderDashboard = function (mxCell) {
    var deferred = $.Deferred();
    var self = this;
    var componentId = this.getComponentId(mxCell);
    var geometry = mxCell.geometry;
    var content = `<div class="component-content" style="width:${geometry.width}px;height:${geometry.height}px;"><canvas style="position: relative;left: 5px" id="${componentId}"></canvas></div>`;
    this.setLabel(mxCell, content);

    var min = self.getCellAttr(mxCell, 'dashboard_min') || 0;
    var max = self.getCellAttr(mxCell, 'dashboard_max') || 100;
    var units = self.getCellAttr(mxCell, 'dashboard_units') || "";
    var type = self.getCellAttr(mxCell, 'dashboard_type') || 'radial';// 仪表板类型.
    var threshold = self.getCellAttr(mxCell, "dashboard_threshold") || max * 0.8;
    max = parseInt(max);
    threshold = parseInt(threshold);
    if (threshold < min) {
        threshold = max * 0.8;
    }
    if (threshold > max) {
        threshold = max * 0.8;
    }

    var majorTicksArr = [];
    min = parseInt(min);
    max = parseInt(max);
    var diff = (max - min) / 5;
    for (let i = 0; i <= 5; i++) {
        majorTicksArr.push(min + diff * i);
    }


    var options = {
        renderTo: componentId,
        width: geometry.width - 10,
        height: geometry.height - 10,
        value: 0,
        valueDec: 2,
        valueBoxWidth: 30,
        valueInt: 1,
        minValue: min,
        maxValue: max,
        units: units,
        valueBox: true,
        strokeTicks: true,
        majorTicks: majorTicksArr,
        save_units: units,
        highlights: [
            {
                "from": threshold,
                "to": max,
                "color": "rgba(200, 50, 50, .75)"
            }
        ],
        colorPlate: "#fff",
        borderShadowWidth: 0,
        borders: false,
        needleType: "arrow",
        needleWidth: 2,
        needleCircleSize: 2,
        needleCircleOuter: true,
        needleCircleInner: false,
        animationDuration: 1500,
        animationRule: "linear"
    };
    setTimeout(function () {
        var gauge;
        if (type === 'radial') {
            gauge = new RadialGauge(options).draw();
        } else if (type === 'half-radial') {
            options.startAngle = 90;
            options.ticksAngle = 180;
            options.valueBox = false;
            gauge = new RadialGauge(options).draw();
        } else if (type === 'linear') {
            gauge = new LinearGauge(options).draw();
        }
        deferred.resolve(gauge);
    }, 300);
    return deferred;
};
NeptuneHandler.prototype.renderControlField = function (mxCell) {
    var componentId = this.getComponentId(mxCell);
    //替换里面的内容
    var geometry = mxCell.geometry;
    var content = [];

    var width = geometry.width;
    content.push(`<div class="component-content" style="width:${width}px;height:${geometry.height}px;" id="${componentId}"><div class="component-field" style="width: ${width}px; margin-bottom: 5px;">`);

    var control_cmd_type = this.graph.getAttributeForCell(mxCell, 'control_cmd_type');
    if (control_cmd_type === 'singleDeviceValue') {
        var fieldStr = this.graph.getAttributeForCell(mxCell, 'device_fields');
        var fields = [];
        if (fieldStr) {
            fields = JSON.parse(fieldStr);
        }
        var item = _.first(fields) || {
            key: '',
            name: ''
        };
        var device_field_boolean_status = this.graph.getAttributeForCell(mxCell, 'device_control_boolean_status');
        var device_fields = this.graph.getAttributeForCell(mxCell, 'device_fields');
        var array;
        if (device_fields) {
            array = JSON.parse(device_fields);
        }
        var field = _.head(array);
        if (field && field.type === 'boo') {
            content.push(`<div class="pretty p-switch p-fill"><input type="checkbox" class="control-send" name="${item.key}"/><div class="state"><label></label></div></div>`);
        } else {
            content.push(`<div class="single-ctrl-div-d" style=""><input type="text" style="width: 70%;height: ${geometry.height - 2}px;margin-left: 2px;" placeholder="${item.name}" name="${item.key}"/><button class="control-send" style="width: 30%;height: ${geometry.height - 2}px;"><i class="fa fa-send-o control-send"></i></button></div>`);
        }
    } else if (control_cmd_type === 'multipleDeviceValue') {
        var btnName = this.graph.getAttributeForCell(mxCell, 'control_cmd_btn_name') || '下发';
        content.push(`<input type="button" class="control-send" style="height: ${geometry.height - 2}px;width: 100%" value="${btnName}"/>`);
    } else {
        content.push('数据下发');
    }
    content.push('</div></div>');
    content = content.join('');
    this.setLabel(mxCell, content);

    neptuneHandler.fontSize(mxCell);
};

NeptuneHandler.prototype.fontSize = function (mxCell, fontSize) {
    var graph = this.graph;
    var componentId = this.getComponentId(mxCell);
    var geometry = mxCell.geometry;
    var font_size = geometry.height - (geometry.height / 2.2);

    if (fontSize) {
        font_size = fontSize;
    }
    font_size = parseInt(font_size);

    graph.setCellStyles(mxConstants.STYLE_FONTSIZE, font_size, graph.getSelectionCells());
    graph.getModel().beginUpdate();
    try {
        graph.updateLabelElements(graph.getSelectionCells(), function (elt) {
            elt.style.fontSize = font_size + 'px';
            elt.removeAttribute('size');
        });
    } finally {
        graph.getModel().endUpdate();
    }

    _.defer(function () {
        $(`#${componentId}`).closest("foreignObject").find("div").first().css({
            "font-size": `${font_size}px`,
            "display": "flex"
        });
    }, 100)
};

NeptuneHandler.prototype.renderField = function (mxCell) {
    var componentId = this.getComponentId(mxCell);
    //替换里面的内容
    var geometry = mxCell.geometry;
    var field = this.getCellAttr(mxCell, 'device_fields');
    var fieldName = '';
    if (field) {
        field = JSON.parse(field);
        _.each(field, function (item) {
            fieldName = item.name;
        });
    }
    fieldName = fieldName || '数据栏位';
    var device_field_scroll_status = this.graph.getAttributeForCell(mxCell, 'device_field_scroll_status');
    var scrollClass = device_field_scroll_status === 'true' ? 'scrollField' : '';
    var content = [];
    content.push(`<div class="component-content ${scrollClass}" style="width:${geometry.width}px;height:${geometry.height}px;" id="${componentId}"><div class="component-field ${scrollClass}">`);
    var device_field_boolean_status = this.graph.getAttributeForCell(mxCell, 'device_field_boolean_status');
    if (device_field_boolean_status === 'true') {
        var button_height = geometry.height - (geometry.height / 3);
        content.push(`<div class="pretty p-switch p-fill" style="font-size: ${button_height}px" ><input type="checkbox"  ng-checked=""/><div class="state"><label></label></div></div>`);
    } else {
        content.push(`<span class="component-field-name">${fieldName}</span>`);
    }
    content.push('</div></div>');
    content = content.join('');
    this.setLabel(mxCell, content);

    _.defer(function () {
        $(`#${componentId}`).closest("foreignObject").find("div").first().css({
            "font-size": "initial"
        });
    }, 100)
};

NeptuneHandler.prototype.getComponentId = function (mxCell) {
    return 'component-' + mxCell.id;
};

NeptuneHandler.prototype.setLabel = function (mxCell, label) {
    this.graph.getModel().beginUpdate();
    try {
        this.graph.setAttributeForCell(mxCell, 'label', label);
    } finally {
        this.graph.getModel().endUpdate();
    }
};

NeptuneHandler.prototype.renderFlowBar = function (mxCell) {
    var self = this;
    //替换里面的内容
    var componentId = this.getComponentId(mxCell);
    var geometry = mxCell.geometry;
    var content = `<div class="component-content" id="${componentId}" style="width:${geometry.width - 2}px;height:${geometry.height}px;"><div class="progress-bar progress-bar-striped" style="width: 100%; transform: translateY(-2.5px);height: calc(100% - 2px); animation: 3s linear 0s infinite normal none progress-bar-stripes-reverse; background-image: linear-gradient(90deg, rgb(56, 149, 255) 25%, transparent 25%, transparent 50%, rgb(56, 149, 255) 50%, rgb(56, 149, 255) 75%, transparent 75%, transparent); background-color: rgb(255, 255, 255);"></div></div>`;

    this.setLabel(mxCell, content);

    var is_use_flowbar_expression = self.getCellAttr(mxCell, 'is_use_flowbar_expression') || "false";
    var flow_code_expression = self.getCellAttr(mxCell, 'flow_code_expression') || "";
    var flow_direction = self.getCellAttr(mxCell, 'flow_direction') || 'normal';
    var flow_speed = self.getCellAttr(mxCell, 'flow_speed') || 3;
    var flow_color = self.getCellAttr(mxCell, 'flow_color') || '#3895ff';
    var flow_background = self.getCellAttr(mxCell, 'flow_background') || '#ffffff';

    var animation = `${flow_speed}s linear 0s infinite normal none ${flow_direction === 'normal' ? 'progress-bar-stripes-reverse' : 'progress-bar-stripes'}`;

    if (is_use_flowbar_expression === "true" && flow_code_expression) {
        $('#' + componentId + ' >div.progress-bar').addClass('stop');
    } else {
        $('#' + componentId + ' >div.progress-bar').removeClass('stop');
    }

    setTimeout(function () {
        $('#' + componentId + ' >div.progress-bar').css({
            'height': 'calc(100% - 2px)',
            'animation': animation,
            'background-image': `linear-gradient(90deg, ${flow_color} 25%, transparent 25%, transparent 50%, ${flow_color} 50%, ${flow_color} 75%, transparent 75%, transparent)`,
            'background-color': flow_background
        });

    }, 0);

};

NeptuneHandler.prototype.renderProgressBar = function (mxCell) {
    var self = this;
    //替换里面的内容
    var componentId = this.getComponentId(mxCell);
    var geometry = mxCell.geometry;
    var content = `<div class="component-content" id="${componentId}" style="width:${geometry.width - 2}px;height:${geometry.height}px;"><div class="progress janus-progress"><div class="progress-bar janus-progress-bar show-percentage" style="width: 0%;"><span>0%</span></div></div></div>`;

    this.setLabel(mxCell, content);

    var is_use_progressbar_expression = self.getCellAttr(mxCell, 'is_use_progressbar_expression') || "false";
    var progress_percent = self.getCellAttr(mxCell, 'progress_percent') || "40";
    var progress_percent_label_show = self.getCellAttr(mxCell, 'progress_percent_label_show') || "true";
    var progressbar_code_expression = self.getCellAttr(mxCell, 'progressbar_code_expression') || "";
    var progress_font_color = self.getCellAttr(mxCell, 'progress_font_color') || '#ffffff';
    var progress_color = self.getCellAttr(mxCell, 'progress_color') || '#3895ff';
    var progress_background = self.getCellAttr(mxCell, 'progress_background') || '#98ceff';


    setTimeout(function () {
        if (is_use_progressbar_expression === "true" && progressbar_code_expression) {
            $('#' + componentId + ' div.progress-bar').addClass('show-percentage');
            progress_percent = 0;
        } else {
            $('#' + componentId + ' div.progress-bar').removeClass('show-percentage');
        }
        $('#' + componentId + ' div.progress-bar').css({
            width: progress_percent + '%'
        });

        if (progress_percent_label_show === 'true') {
            $('#' + componentId + ' div.progress-bar').removeClass('hide-percentage');
            $('#' + componentId + ' div.progress-bar').addClass('show-percentage');
            $('#' + componentId + ' div.show-percentage >span').html(progress_percent + '%');
        } else {
            $('#' + componentId + ' div.progress-bar').removeClass('show-percentage');
            $('#' + componentId + ' div.progress-bar').addClass('hide-percentage');
        }

        $('#' + componentId + ' div.progress').css({
            'background-color': progress_background
        });
        $('#' + componentId + ' div.progress-bar').css({
            'background-color': progress_color,
            'color': progress_font_color
        });
    }, 0);
};

NeptuneHandler.prototype.renderMap = function (mxCell) {
    var self = this;
    //替换里面的内容
    var componentId = this.getComponentId(mxCell);
    var geometry = mxCell.geometry;
    var content = `<div class="component-content" id="${componentId}" style="width:${geometry.width - 2}px;height:${geometry.height}px;"><div class="map-container" id="${componentId + '_map_container'}" style="width:100%;height:100%;margin-bottom: 4px;z-index: 1"></div></div>`;

    let noAmap = _.isEmpty(window.AMap);
    if (noAmap) {
        content = `<div class="component-content" id="${componentId}" style="width:${geometry.width - 2}px;height:${geometry.height}px;"><div><i class="fa fa-warning" title="未连接到互联网，无法定位，请稍后重试！" style="font-size: 30px"></i></div></div>`
    }

    this.setLabel(mxCell, content);

    var map_url_type = self.getCellAttr(mxCell, 'map_url_type') || 'user_add';
    var poi = self.getCellAttr(mxCell, 'poi') || {};
    if (!_.isEmpty(poi)) {
        poi = JSON.parse(poi);
    }

    if (!noAmap) {
        setTimeout(function () {
            var mapId = componentId + '_map_container';
            var map = new AMap.Map(mapId, {
                zoom: 8
            });
            $('#' + mapId).data('map', map);
            if (map_url_type === 'user_add' && !_.isEmpty(poi)) {
                NeptuneUtils.addMapMarker(componentId, poi, '', true);
            }
        }, 0);
    }
};

NeptuneHandler.prototype.renderRealtime = function (mxCell) {
    var self = this;
    var deferred = $.Deferred();

    var componentId = this.getComponentId(mxCell);
    var geometry = mxCell.geometry;

    var time_now = moment().format("HH:mm:ss");
    var content = `<div class="component-content realtime_component" id="${componentId}" style="width:${geometry.width}px;height:${geometry.height}px;"><span class="time_now">${time_now}</span></div>`;
    this.setLabel(mxCell, content);

    return deferred;
};
window.NeptuneHttp = {
    ajax: function () {
        var arr = _.toArray(arguments);
        var cfg = {
            type: 'get',
            dataType: 'json',
            cache: false
        };
        _.extend(cfg, arr[0]);
        arr.shift();

        var flag = true;
        if (arr && arr.length) {
            flag = _.last(arr);
            if (flag === false) {
                arr.pop();
            }
            var data = _.last(arr);
            if (_.isObject(data)) {
                cfg.data = arr.pop();
            }
        }

        cfg.url = cynovan.c_path + '/' + arr.join('/');
        if (flag === false) {
            cfg.exec = function () {
                return $.ajax(cfg);
            };
            return cfg;
        }
        return $.ajax(cfg);
    },
    get: function () {
        var arr = _.toArray(arguments);
        arr.unshift({
            type: 'get'
        });
        return this.ajax.apply(null, arr);
    },
    post: function () {
        var arr = _.toArray(arguments);
        arr.unshift({
            type: 'post'
        });
        return this.ajax.apply(null, arr);
    }
};


window.NeptuneUtils = {
    deviceList: [],
    placeholderList: [],
    clsList: [],
    clsCode_device_map: {},
    clsCode_clsDDList_map: {},
    getDeviceClsData: function () {
        var deferred = $.Deferred();
        if (!_.size(this.clsList)) {
            NeptuneHttp.get('monitor_developer/loadDevices').done(function (result) {
                var clsList = _.get(result, 'datas.clsList', []);
                NeptuneUtils.clsCode_device_map = _.get(result, "datas.deviceClsMap", {});
                NeptuneUtils.clsList = clsList;
                let res = {
                    clsList: NeptuneUtils.clsList,
                    clsCode_device_map: NeptuneUtils.clsCode_device_map
                };
                deferred.resolve(res);
            });
        } else {
            let res = {
                clsList: NeptuneUtils.clsList,
                clsCode_device_map: NeptuneUtils.clsCode_device_map
            };
            deferred.resolve(res);
        }
        return deferred;
    },
    getClsDDList: function (clsCode) {
        var deferred = $.Deferred();
        let ddList = _.get(NeptuneUtils.clsCode_clsDDList_map, clsCode, []);
        if (_.isEmpty(ddList)) {
            NeptuneHttp.get('monitor_developer/loadClsDDList', {
                clsCode: clsCode
            }).done(function (result) {
                console.log(result);
                var list = _.get(result, 'datas.list.data_definition.details', []);
                _.set(NeptuneUtils.clsCode_clsDDList_map, clsCode, list);
                deferred.resolve(list);
            });
        } else {
            deferred.resolve(ddList);
        }
        return deferred;
    },
    getEditorZtreeData: function (id) {
        var deferred = $.Deferred();
        let ztreeData = _.get(NeptuneUtils, "ztreeData", []);
        if (_.size(ztreeData) === 0) {
            NeptuneHttp.get("monitor_developer/getDeviceFieldsData", {
                id: id
            }).done(function (result) {
                if (_.size(result) !== 0) {
                    _.set(NeptuneUtils, "ztreeData", result);
                    deferred.resolve(result);
                }
            });
        } else {
            deferred.resolve(ztreeData);
        }
        return deferred;
    },
    getPlaceholderList: function (id) {
        var deferred = $.Deferred();
        if (!_.size(this.placeholderList)) {
            NeptuneHttp.get('monitor_developer/getDevicePlaceholders', {
                id: id,
            }).done(function (result) {
                var list = _.get(result, 'datas.placeholders', []);
                NeptuneUtils.placeholderList = list;
                deferred.resolve(NeptuneUtils.placeholderList);
            });
        } else {
            deferred.resolve(NeptuneUtils.placeholderList);
        }
        return deferred;
    },
    findGetParameter: function (parameterName) {
        var result = null,
            tmp = [];
        location.search
            .substr(1)
            .split("&")
            .forEach(function (item) {
                tmp = item.split("=");
                if (tmp[0] === parameterName) result = decodeURIComponent(tmp[1]);
            });
        return result;
    },
    showExpressionDialog: function (params) {
        var deferred = $.Deferred();
        require(['vs/editor/editor.main'], function () {
            /*var selectOpHtml = [];
            _.each(NeptuneUtils.placeholderList, function (placeholder) {
                selectOpHtml.push(`<option value="${placeholder.name}">${placeholder.name}(${placeholder.uuid})</option>`);
            });*/
            var id = NeptuneUtils.findGetParameter('id');
            var html = `<ul id="myTab" class="nav nav-tabs">
                           <li class="active"><a href="#editCode" data-toggle="tab">处理代码</a></li>
                           <li><a href="#testData" data-toggle="tab">测试数据</a></li>
                        </ul>
                        <div id="myTabContent" class="tab-content">
                           <div class="tab-pane fade in active" id="editCode">
                                <div class="row">
                                    <div class="col-xs-12" style="padding: 10px">   
                                        <button class="btn btn-primary btn-outline btn-xs helpDoc" type="button"><i class="fa fa-question"></i> 帮助文档</button>
                                        <button class="btn btn-danger btn-xs testRun" type="button">执行测试</button>
                                        <button class="btn btn-primary btn-outline btn-xs" type="button" whenClicked="=="> 等于</button>
                                        <button class="btn btn-primary btn-outline btn-xs" type="button" whenClicked="!="> 不等于</button>
                                        <button class="btn btn-primary btn-outline btn-xs" type="button" whenClicked="string.contains(,)"> 包含</button>
                                        <button class="btn btn-primary btn-outline btn-xs" type="button" whenClicked="!string.contains(,)"> 不包含</button>
                                        <button class="btn btn-primary btn-outline btn-xs" type="button" whenClicked=">"> 大于</button>
                                        <button class="btn btn-primary btn-outline btn-xs" type="button" whenClicked=">="> 大于等于</button>
                                        <button class="btn btn-primary btn-outline btn-xs" type="button" whenClicked="<"> 小于</button>
                                        <button class="btn btn-primary btn-outline btn-xs" type="button" whenClicked="<="> 小于等于</button>
                                        <button class="btn btn-primary btn-outline btn-xs" type="button" whenClicked="&amp;&amp;"> And</button>
                                        <button class="btn btn-primary btn-outline btn-xs" type="button" whenClicked="||"> 或</button>
                                   </div>
                                   <div class="col-xs-12">
                                        <div class="mxgraph-expression-dialog">
                                            <div id="cls_dd_tree" class="ztree"></div>
                                            <div id="mxgraph-express-code-editor"></div>
                                        </div>
                                   </div>
                               </div>
                           </div>
                           <div class="tab-pane fade" id="testData">
                           <div class="row">
                               <div class="col-xs-6">
                                    <div class="mxgraph-expression-dialog">                                        
                                        <div id="mxgraph-express-testdata-editor"></div>
                                    </div>
                                  </div>
                                  <div class="col-xs-6">
                                    <div class="mxgraph-expression-dialog"><div id="mxgraph-express-outputdata-editor"></div></div>
                                  </div>
                                </div>
                           </div>
                        </div>`;

            var editor = null, editor1 = null, editor2 = null;
            var element = bootbox.dialog({
                title: false,
                message: html,
                buttons: {
                    'success': {
                        label: "确认",
                        className: "btn btn-success",
                        callback: function () {
                            var value = '', value1 = '', value2 = '';
                            if (editor) {
                                value = editor.getValue();
                            }
                            if (editor1) {
                                value1 = editor1.getValue();
                            }
                            if (editor2) {
                                value2 = editor2.getValue();
                            }
                            params.value.code = value;
                            params.value.testdata = value1;
                            params.value.outputdata = value2;
                            deferred.resolve(params);
                            return true;
                        }
                    },
                    'cancel': {
                        label: '取消',
                        className: 'btn btn-default',
                        callback: function (event) {
                            return true;
                        }
                    }
                }
            });
            element.find('.modal-dialog').width(1200);

            /*init the monaco editor*/
            var monacoObj = {
                language: 'javascript',
                automaticLayout: true,
                height: '350px'
            };
            var monacoJsonObj = {
                language: 'json',
                automaticLayout: true,
                height: '350px'
            };
            var editorEle = document.getElementById('mxgraph-express-code-editor');
            var editorEle1 = document.getElementById('mxgraph-express-testdata-editor');
            var editorEle2 = document.getElementById('mxgraph-express-outputdata-editor');
            editor = monaco.editor.create(editorEle, monacoObj);// 处理代码
            editor1 = monaco.editor.create(editorEle1, monacoJsonObj); // 测试数据
            editor2 = monaco.editor.create(editorEle2, monacoJsonObj); // 输出结果
            if (editor) {
                editor.setValue(params.value.code);
            }
            if (editor1) {
                if (_.isEmpty(params.value.testdata)) {
                    var fictitious_data = {
                        "name": {
                            "static": {
                                "baseInfo": {
                                    "name": "设备名称"
                                },
                                "uuid": "设备uuid"
                            },
                            "dynamic": {
                                "key1": "30"
                            }
                        }
                    };
                    NeptuneUtils.getPlaceholderList(id).done(function (list) {
                        var placeholders = list;
                        if (_.size(placeholders)) {
                            var first = _.first(placeholders);
                            var name = "$" + first.name + "$";
                            _.set(fictitious_data, name, fictitious_data.name);
                            _.unset(fictitious_data, "name");
                        }
                        fictitious_data = JSON.stringify(fictitious_data, null, "\t");
                        editor1.setValue(fictitious_data);
                    });
                } else {
                    editor1.setValue(params.value.testdata);
                }
            }
            if (editor2) {
                editor2.setValue(params.value.outputdata);
            }

            // 初始化ztree
            NeptuneUtils.getEditorZtreeData(id).done(function (data) {
                let tree = $("#cls_dd_tree");
                var zTreeObj;
                var onDblClick = function (event, treeId, treeNode, clickFlag) {
                    if (!treeNode.isParent) {
                        var firstP = _.head(treeNode.getPath());
                        var device_name = _.get(firstP, "name");
                        var key = treeNode.key;
                        var type = treeNode.deviceDataType;
                        var name = _.join(['root["$' + device_name + '$"]["' + type + '"]["', key, '"]'], '');
                        NeptuneUtils.addExpress(editor, name);
                    }
                };
                var setting = {
                    callback: {
                        onDblClick: onDblClick
                    }
                };
                zTreeObj = $.fn.zTree.init(tree, setting, data);
            });


            // 选择设备.
            $('.format-input').on('change', function (item) {
                var name = this.value;
                if (name) {
                    // uuid length > 4, 设备 else 设备域
                    if (name.length > 4) {
                        name = _.join(['$', name, '$'], '');
                    } else {
                        name = _.join(['$', name, '$'], '');
                    }
                    NeptuneUtils.addExpress(editor, name);
                }
            });

            // 处理代码: editor在所在光标处加入当前点击的运算符.
            var buttons = document.getElementsByClassName('btn-primary');
            for (var i = 0; i < buttons.length; i++) {
                var button = buttons[i];
                button.onclick = function () {
                    var whenClicked = this.getAttribute('whenClicked');
                    if (whenClicked != null) {
                        NeptuneUtils.addExpress(editor, whenClicked);
                    }
                }
            }

            // 执行测试.
            $('.testRun').on('click', function () {
                NeptuneUtils.testRun(editor, editor1, editor2);
            });

            // 帮助文档.
            $('.helpDoc').on('click', function () {
                $('.modal-dialog').hide();// 隐藏处理代码dialog
                NeptuneUtils.showHelpDocumentDialog();
            });

            element.on('hidden.bs.modal', function () {
                if (editor) {
                    editor.dispose();
                }
                if (editor1) {
                    editor1.dispose();
                }
                if (editor2) {
                    editor2.dispose();
                }
            });
        });
        return deferred;
    },
    addExpress: function (editor, express) {
        var express = ' ' + express;
        editor.executeEdits("", [{
            range: {
                startLineNumber: editor.getPosition().lineNumber,
                startColumn: editor.getPosition().column,
                endLineNumber: editor.getPosition().lineNumber,
                endColumn: editor.getPosition().column
            },
            text: express
        }]);
    },
    testRun: function (editor, editor1, editor2) {
        var flag = NeptuneUtils.execCode(editor, editor1, editor2);
        if (flag === true) {
            alert('执行通过，请点击[处理后数据]查看结果');
        }
    },
    execCode: function (editor, editor1, editor2) {
        var code = editor.getValue();
        var testdata = editor1.getValue();

        var data = {};
        try {
            data = JSON.parse(testdata);
        } catch (e) {
            alert("请输入正确的测试数据");
            return false;
        }
        try {
            var func = new Function("root", code);
            func(data);
        } catch (e) {
            alert('测试错误');
            return false;
        }
        editor2.setValue(JSON.stringify(data));
        editor2.getAction('editor.action.formatDocument').run();// format outputdata code
        return true;
    },
    showHelpDocumentDialog: function () {
        var html = [];
        html.push(`<div class="code_title" style="font-size: 16px;padding-top: 5px;">提示:</div>
                   <div class="code_title">1.使用root即可引用数据，例如root["$AGV小车$"]["static"]["company"]代表引用AGV小车设备静态数据中的company栏位</div>
                   <div class="code_title">2.表达式必须有明确的返回值，条件表达式时返回true/false</div>
                   <div class="code_title" style="font-size: 16px;padding-top: 10px;">数据示例:</div>
<pre class="code-area">
{
     "$上下料机器人$": {
         "dynamic":{
             "temp":"30",
             "error_code":"ERROR001"
         }
     },
     "$AGV小车$": {
         "dynamic":{
             "position":"1"
         },
         "static":{
             "company":"cynovan"
         }
     },
}
</pre>
                   <div class="code_title" style="font-size: 16px;padding-top: 10px;">代码示例:</div>
                   <div class="code_title">1. $上下料机器人$设备的动态数据温度大于20</div>
                   <div class="code-area">return root["$上下料机器人$"]["dynamic"]["temp"] > 20</div>
                   <div class="code_title">2. $上下料机器人$设备的动态数据报警代码为'ERROR001'</div>
                   <div class="code-area">return root["$上下料机器人$"]["dynamic"]["error_code"] == 'ERROR001'</div>`);
        html = html.join('');

        var element = bootbox.dialog({
            title: '帮助文档',
            message: html,
            buttons: {
                'cancel': {
                    label: '取消',
                    className: 'btn btn-default',
                    callback: function () {
                        $('.modal-dialog').show();// 显示处理代码dialog
                        return true;
                    }
                }
            }, onEscape: function () {
                $('.modal-dialog').show();// 显示处理代码dialog
            }
        });
        element.find('.modal-dialog').width(1000);
    },
    showDevicePlaceHolderDialog: function (params) {
        var deferred = $.Deferred();
        NeptuneUtils.placeholderList = _.cloneDeep(params.value.devicePlaceHolderList);
        NeptuneUtils.getDeviceClsData().done(function (res) {
            let list = _.get(res, "clsList", []);
            let clsCode_device_map = _.get(res, "clsCode_device_map", {});
            var html = [];
            html.push(`<div style="padding-left: 30px;padding-right: 30px">`);
            html.push(`<table class="device-placeholder-list table table-condensed table-bordered edittable no-padding">`);
            html.push(`<thead><tr><th style="width: 45px">序号</th><th>名称</th><th>设备分类</th><th>默认设备</th></th><th>操作</th></tr></thead>`);
            html.push(`<tbody>`);
            if (_.size(NeptuneUtils.placeholderList)) {
                var rows = [];
                _.each(NeptuneUtils.placeholderList, function (item, idx) {
                    var clsSelectOpHtml = [];
                    var deviceSelectOpHtml = [];
                    let deviceList = _.get(clsCode_device_map, item.clsCode, []);
                    _.each(list, function (cls) {
                        if (cls.code === item.clsCode) {
                            clsSelectOpHtml.push(`<option value="${cls.code}" selected="selected">${cls.name}</option>`);
                        } else {
                            clsSelectOpHtml.push(`<option value="${cls.code}">${cls.name}</option>`);
                        }
                    });
                    deviceSelectOpHtml.push(`<option  value="">无</option>`);
                    _.each(deviceList, function (device) {
                        // 是否选中设备
                        if (device.uuid === item.default) {
                            deviceSelectOpHtml.push(`<option value="${device.uuid}" selected="selected">${device.uuid}(${device.baseInfo.name})</option>`);
                        } else {
                            deviceSelectOpHtml.push(`<option value="${device.uuid}">${device.uuid}(${device.baseInfo.name})</option>`);
                        }
                    });
                    rows.push(NeptuneUtils.addPlaceholderRow(item, idx, clsSelectOpHtml, deviceSelectOpHtml));
                });
                if (_.size(rows)) {
                    html.push(rows.join(''));
                }
            }

            html.push(`</tbody></table>`);
            html.push(`<button type="button" class="btn btn-primary btn-outline btn-sm addPlaceholder" title="添加"><i class="fa fa-plus"></i> 添加</button>`);
            html.push(`</div>`);
            html = html.join('');

            var element = bootbox.dialog({
                title: '创建设备关联',
                message: html,
                closeButton: false,
                buttons: {
                    'success': {
                        label: "确认",
                        className: "btn btn-success",
                        callback: function () {
                            var emptyFlag = true;// 检查名称是否为空
                            var ruleFlag = true;// 检查名称是否含有特殊字符
                            let isClsEmpty = false;
                            let isDvsEmpty = false;
                            var rule = new RegExp("[`~!@#$^&*()=|{}':;',\\[\\].<>《》/?~！@#￥……&*（）——|{}【】‘；：”“'。，、？ ]");

                            _.each(NeptuneUtils.placeholderList, function (item) {
                                if (_.isEmpty(item.name)) {
                                    emptyFlag = false;
                                } else if (rule.test(item.name)) {
                                    ruleFlag = false;
                                }
                                if (_.isEmpty(item.clsCode)) {
                                    isClsEmpty = true;
                                }
                                if (_.isEmpty(item.default)) {
                                    isDvsEmpty = true;
                                }
                            });
                            if (emptyFlag === false) {
                                alert('名称不能为空');
                                return false;
                            }
                            if (ruleFlag === false) {
                                alert('名称不能含有特殊字符');
                                return false;
                            }
                            if (_.size(_.uniqBy(NeptuneUtils.placeholderList, 'name')) != _.size(NeptuneUtils.placeholderList)) {
                                alert('名称不能重复');
                                return false
                            }
                            if (isClsEmpty) {
                                alert('请选择分类');
                                return false;
                            }
                            params.value.devicePlaceHolderList = _.cloneDeep(NeptuneUtils.placeholderList);
                            _.set(NeptuneUtils, "ztreeData", []);
                            deferred.resolve(params);

                            return true;
                        }
                    },
                    'cancel': {
                        label: '取消',
                        className: 'btn btn-default',
                        callback: function (event) {
                            NeptuneUtils.placeholderList = params.value.devicePlaceHolderList;
                            return true;
                        }
                    }
                }
            });
            element.find('.modal-dialog').width(1100);
            element.on('hidden.bs.modal', function () {

            });
            // 添加一行.
            $('.addPlaceholder').on('click', function () {
                NeptuneUtils.placeholderList.push({});
                NeptuneUtils.addPlaceholderRows();
            });
            var rowElement = $('.device-placeholder-list tbody');
            NeptuneUtils.managePlaceholderRow(rowElement);
        });
        return deferred;
    },
    showClsDataStruDialog: function (options) {
        let placeholder_clsCode = options.placeholder_clsCode;
        let device_fields = options.device_fields;
        let isMultiple = options.isMultiple;
        let tag2 = options.tag2;
        let control_cmd_type = options.control_cmd_type;

        if (_.isEmpty(device_fields)) {
            device_fields.push({});
        }
        NeptuneUtils.clsDDCollection = device_fields;
        var deferred = $.Deferred();
        require([], function () {
            NeptuneUtils.getClsDDList(placeholder_clsCode).done(function (clsDDList) {
                var html = [];
                html.push(`<div class="clsDDListTableDiv">`);
                html.push(`<table class="clsDDListTable table table-condensed table-bordered edittable no-padding">`);
                let isValue = tag2 === "control" && isMultiple;
                if (tag2 === 'control') {
                    if (isMultiple) {
                        html.push(`<thead><tr><th style="width: 45px">序号</th><th style="width:294px">数据栏位</th><th>下发数据值</th><th>操作</th></tr></thead>`);
                    } else {
                        html.push(`<thead><tr><th style="width: 45px">序号</th><th style="width:375px">数据栏位</th><th>操作</th></tr></thead>`);
                    }
                } else {
                    html.push(`<thead><tr><th style="width: 45px">序号</th><th style="width:294px">数据栏位</th><th>数据名称</th></th><th>操作</th></tr></thead>`);
                }
                html.push(`<tbody>`);
                // 表格的每一行
                if (_.size(device_fields)) {
                    var rows = [];
                    _.each(device_fields, function (item, idx) {
                        var selectOpHtml = [];
                        selectOpHtml.push('<option value="">请选择栏位...</option>');
                        _.each(clsDDList, function (clsDDItem) {
                            if (clsDDItem.key === item.key) {
                                selectOpHtml.push(`<option value="${clsDDItem.key}" selected="selected">${clsDDItem.name} (${clsDDItem.key})</option>`);
                            } else {
                                selectOpHtml.push(`<option value="${clsDDItem.key}">${clsDDItem.name} (${clsDDItem.key})</option>`);
                            }
                        });
                        rows.push(NeptuneUtils.addClsDDRow(item, idx, selectOpHtml, tag2, options.control_cmd_type));
                    });
                    if (_.size(rows)) {
                        html.push(rows.join(''));
                    }
                }
                html.push(`</tbody></table>`);
                if (isMultiple) {
                    html.push(`<button type="button" class="btn btn-primary btn-sm addClsDDBtn btn-outline" title="添加" style="margin-top: 8px">
                                    <i class="fa fa-plus"></i> 添加
                                </button>`);
                }
                html.push(`<div>`);
                html = html.join('');
                var element = bootbox.dialog({
                    title: '栏位设置',
                    message: html,
                    buttons: {
                        'success': {
                            label: "确认",
                            className: "btn btn-success",
                            callback: function () {
                                var nameNotEmpty = true;// 检查名称是否为空
                                var ruleFlag = true;// 检查名称是否含有特殊字符
                                var keyNotEmpty = true;
                                var rule = new RegExp("[`~!@#$^&*()=|{}':;',\\[\\].<>《》/?~！@#￥……&*（）——|{}【】‘；：”“'。，、？ ]");
                                _.each(NeptuneUtils.clsDDCollection, function (item) {
                                    if (_.isEmpty(item.name)) {
                                        nameNotEmpty = false;
                                    } else if (rule.test(item.name)) {
                                        ruleFlag = false;
                                    }
                                    if (_.isEmpty(item.key)) {
                                        keyNotEmpty = false;
                                    }
                                });
                                if (keyNotEmpty === false) {
                                    alert("请选择栏位");
                                    return false;
                                }
                                if (nameNotEmpty === false) {
                                    alert('名称不能为空');
                                    return false;
                                }
                                if (ruleFlag === false) {
                                    alert('名称不能含有特殊字符');
                                    return false;
                                }
                                if (_.size(_.uniqBy(NeptuneUtils.clsDDCollection, 'key')) != _.size(NeptuneUtils.clsDDCollection)) {
                                    alert('所选栏位重复!');
                                    return false
                                }
                                let clsDDCollection = _.cloneDeep(NeptuneUtils.clsDDCollection);
                                deferred.resolve(clsDDCollection);
                                return true;
                            }
                        },
                        'cancel': {
                            label: '取消',
                            className: 'btn btn-default',
                            callback: function (event) {
                            }
                        }
                    }
                });

                element.find('.modal-dialog').width(800);
                // 添加一行.
                $('.addClsDDBtn').on('click', function () {
                    if (isMultiple) {
                        NeptuneUtils.clsDDCollection.push({});
                        let options = {
                            placeholder_clsCode: placeholder_clsCode,
                            "clsDDCollection": NeptuneUtils.clsDDCollection,
                            isValue: isValue,
                            tag2: tag2,
                            control_cmd_type: control_cmd_type
                        };
                        NeptuneUtils.addClsDDRows(options);
                    } else {
                        if (_.size(NeptuneUtils.clsDDCollection) > 0) {
                            alert("只能选择一个栏位");
                            return;
                        }
                        NeptuneUtils.clsDDCollection.push({});
                    }
                });
                var rowElement = $('.clsDDListTable tbody');
                NeptuneUtils.manageAddClsDDRow(rowElement, clsDDList);
            });
        });
        return deferred;
    },
    addPlaceholderRows: function () {
        var rows = [];
        _.each(NeptuneUtils.placeholderList, function (item, idx) {
            var clsSelectOpHtml = [];
            clsSelectOpHtml.push('<option value="">请选择分类...</option>');
            var deviceSelectOpHtml = [];
            let deviceList = _.get(NeptuneUtils.clsCode_device_map, item.clsCode, []);
            deviceSelectOpHtml.push(`<option value="">无</option>`);
            _.each(deviceList, function (device) {
                // 是否选中设备
                if (device.uuid === item.default) {
                    deviceSelectOpHtml.push(`<option value="${device.uuid}" selected="selected">${device.uuid}(${device.baseInfo.name})</option>`);
                } else {
                    deviceSelectOpHtml.push(`<option value="${device.uuid}">${device.uuid}(${device.baseInfo.name})</option>`);
                }
            });
            _.each(NeptuneUtils.clsList, function (cls) {
                if (cls.code === item.clsCode) {
                    clsSelectOpHtml.push(`<option value="${cls.code}" selected="selected">${cls.name}</option>`);
                } else {
                    clsSelectOpHtml.push(`<option value="${cls.code}">${cls.name}</option>`);
                }
            });
            rows.push(NeptuneUtils.addPlaceholderRow(item, idx, clsSelectOpHtml, deviceSelectOpHtml));
        });

        var rowElement = $('.device-placeholder-list tbody');
        rowElement.html(rows.join(''));

        NeptuneUtils.managePlaceholderRow(rowElement);
    },
    addPlaceholderRow: function (item, idx, clsSelectOpHtml, deviceSelectOpHtml) {
        var rows = [];
        rows.push(`<tr class="mxgraph-device-placeholder-row"  data-index="${idx}">
                        <td style="vertical-align:middle;text-align: center">${idx + 1}</td>`);
        rows.push(`<td><input type="text" class="form-control mxgraph-device-placeholder-input" value="${item.name || ''}" placeholder="名称"/></td>`);
        rows.push(`<td style="width:300px"><select class="form-control clsSelect">` + clsSelectOpHtml.join('') + `</select></td>`);
        rows.push(`<td style="width:300px"><select class="form-control dvsSelect">` + deviceSelectOpHtml.join('') + `</select></td>`);
        rows.push(`<td style="vertical-align: middle;width: 70px;text-align: center"><button class="btn btn-primary btn-outline btn-xs" type="button" >
                                          <i class="fa fa-trash-o" title="删除"></i> 删除</button></td>`);
        rows.push('</tr>');
        return rows.join('');
    },
    addClsDDRow: function (item, idx, selectOpHtml, tag2, control_cmd_type) {
        var rows = [];
        rows.push(`<tr class="addClsDDTblTr"  data-index="${idx}"><td class="align-center-center">${idx + 1}</td>`);
        rows.push(`<td class="cls-dd-chosen"><select class="form-control addClsDDRowSelect chosen-select">` + selectOpHtml.join('') + `</select></td>`);
        if (tag2 === 'control') {
            if (control_cmd_type === 'multipleDeviceValue') {
                rows.push(`<td><input type="text" class="form-control addClsDDRowSelectValue" value="${item.value || ''}" placeholder="数据值"/></td>`);
            }
        } else {
            rows.push(`<td class="addClsDDRowSelectName"> ${item.name || ''} </td>`);
        }
        rows.push(`<td class="addClsDDDeleteTd">
                        <button class="btn btn-primary btn-outline btn-xs" type="button"><i class="fa fa-trash-o" title="删除"></i> 删除</button></td>`);
        rows.push('</tr>');
        return rows.join('');
    },
    addClsDDRows: function (options) {
        let placeholder_clsCode = options.placeholder_clsCode;
        let clsDDList = _.get(NeptuneUtils.clsCode_clsDDList_map, placeholder_clsCode, []);
        var rows = [];
        _.each(NeptuneUtils.clsDDCollection, function (item, idx) {
            var selectOpHtml = [];
            var value = '';
            selectOpHtml.push('<option value="">请选择栏位...</option>');
            _.each(clsDDList, function (clsDDItem) {
                value = clsDDItem.value;
                if (clsDDItem.key === item.key) {
                    selectOpHtml.push(`<option value="${clsDDItem.key}" selected="selected">${clsDDItem.name} (${clsDDItem.key})</option>`);
                } else {
                    selectOpHtml.push(`<option value="${clsDDItem.key}">${clsDDItem.name} (${clsDDItem.key})</option>`);
                }
            });
            rows.push(NeptuneUtils.addClsDDRow(item, idx, selectOpHtml, options.tag2, options.control_cmd_type));
        });
        // 将表格元素放到dialog table上
        var rowElement = $('.clsDDListTable tbody');
        rowElement.html(rows.join(''));

        NeptuneUtils.manageAddClsDDRow(rowElement, clsDDList);
    },
    manageAddClsDDRow: function (rowElement, clsDDList) {
        // 删除当前行.
        rowElement.find('.fa').closest('button').click(function (event) {
            var row = $(event.target).closest('.addClsDDTblTr');
            var idx = _.parseInt(row.data('index'));
            NeptuneUtils.clsDDCollection.splice(idx, 1);
            row.remove();
        });
        // 选中栏位后更新table以及相关的对象集合
        rowElement.find('.addClsDDRowSelect').closest('select').change(function (event) {
            let selectedIndex = $(this).prop('selectedIndex');
            var row = $(event.target).closest('.addClsDDTblTr');
            var idx = _.parseInt(row.data('index'));
            if (selectedIndex !== 0) {
                // 选择栏位
                let item = _.nth(clsDDList, selectedIndex - 1);
                NeptuneUtils.clsDDCollection[idx] = {
                    key: item.key,
                    name: item.name,
                    id: item.id,
                    type: item.rule,
                    suffix: item.suffix
                };
                row.find(".addClsDDRowSelectName").text(item.name);
            } else {
                // 未选择
                row.find(".addClsDDRowSelectName").text("");
                NeptuneUtils.clsDDCollection[idx] = {};
            }
        });
        // 名称改变
        rowElement.find(".addClsDDRowSelectName").change(function (event) {
            var row = $(event.target).closest('.addClsDDTblTr');
            var idx = _.parseInt(row.data('index'));
            if (!_.isEmpty($(this).val())) {
                NeptuneUtils.clsDDCollection[idx].name = $(this).val();
            }
        });
        // 下发值
        rowElement.find(".addClsDDRowSelectValue").change(function (event) {
            var row = $(event.target).closest('.addClsDDTblTr');
            var idx = _.parseInt(row.data('index'));
            if (!_.isEmpty($(this).val())) {
                NeptuneUtils.clsDDCollection[idx].value = $(this).val();
            }
        });
        var element = $(".modal-dialog");
        let dd_selects = element.find(".cls-dd-chosen .chosen-select");
        _.each(dd_selects, function (item) {
            $(item).chosen({
                search_contains: true,
                allow_single_deselect: true,
                no_results_text: "没有匹配结果"
            }).change(function (event, item) {
                console.log(item);
            });
        });
    },
    managePlaceholderRow: function (rowElement) {
        // 删除当前行.
        rowElement.find('.fa').closest('button').click(function (event) {
            var row = $(event.target).closest('.mxgraph-device-placeholder-row');
            var idx = _.parseInt(row.data('index'));
            NeptuneUtils.placeholderList.splice(idx, 1);
            row.remove();
        });

        // 更改占位符名称.
        rowElement.find('input').change(function (event) {
            var row = $(event.target).closest('.mxgraph-device-placeholder-row');
            var idx = _.parseInt(row.data('index'));
            var item = NeptuneUtils.placeholderList[idx];
            if (!item.uuid) {
                _.set(item, 'uuid', NeptuneUtils.generatePlaceholderid());
            }
            _.set(item, 'name', event.target.value);
        });

        // 更改设备分类
        rowElement.find('select.clsSelect').change(function (event) {
            var row = $(event.target).closest('.mxgraph-device-placeholder-row');
            var idx = _.parseInt(row.data('index'));
            var item = NeptuneUtils.placeholderList[idx];
            _.set(item, 'clsCode', event.target.value);
            let deviceList = _.get(NeptuneUtils.clsCode_device_map, event.target.value, []);
            // 更新当前row分类下的设备列表
            let dvsOpsHtml = [];
            dvsOpsHtml.push(`<option value="">无</option>`);
            _.each(deviceList, function (device) {
                dvsOpsHtml.push(`<option value="${device.uuid}">${device.uuid}(${device.baseInfo.name})</option>`);
            });
            row.find('select.dvsSelect').html(dvsOpsHtml.join(''));
            _.set(item, 'default', row.find('select.dvsSelect').val() || "");
        });

        // 更改默认设备.
        rowElement.find('select.dvsSelect').change(function (event) {
            var row = $(event.target).closest('.mxgraph-device-placeholder-row');
            var idx = _.parseInt(row.data('index'));
            var item = NeptuneUtils.placeholderList[idx];
            _.set(item, 'default', event.target.value);
        });
    },
    generatePlaceholderid: function () {
        var d = new Date().getTime();
        var uuid = 'PH-yxxx'.replace(/[xy]/g, function (c) {
            var r = (d + Math.random() * 16) % 16 | 0;
            d = Math.floor(d / 16);
            return (c == 'x' ? r : (r & 0x7 | 0x8)).toString(16);
        });
        var exists = _.find(NeptuneUtils.placeholderList, function (item) {
            return item.id === uuid;
        });
        if (exists) {
            return NeptuneUtils.generatePlaceholderid();
        }
        return uuid;
    },
    addHistoryDataFieldRows: function (fields, clsDDList) {

        var rows = [];
        _.each(fields, function (field, filedIndex) {

            rows.push(NeptuneUtils.addHistoryDataFieldRow(filedIndex, field, clsDDList));
        });
        return _.join(rows, '');
    },
    addHistoryDataFieldRow: function (filedIndex, field, clsDDList, useOrigin) {
        var staticsTypes = [{
            id: '$count',
            name: '计数'
        }, {
            id: '$sum',
            name: '求和'
        }, {
            id: '$avg',
            name: '平均数'
        }, {
            id: '$max',
            name: '最大值'
        }, {
            id: '$min',
            name: '最小值'
        }];
        var selectOpHtml = [];
        var isDisabled = true;
        _.each(clsDDList, function (clsDDItem) {
            if (clsDDItem.key === field.id) {
                if (clsDDItem.rule === 'number') {
                    isDisabled = false;
                }
                selectOpHtml.push(`<option value="${clsDDItem.key}" selected="selected">${clsDDItem.name}</option>`);
            } else {
                selectOpHtml.push(`<option value="${clsDDItem.key}">${clsDDItem.name}</option>`);
            }
        });
        selectOpHtml = _.join(selectOpHtml, '');
        var staticsOpHtml = [];
        _.each(staticsTypes, function (statics) {
            if (statics.id === field.statis) {
                staticsOpHtml.push(`<option value="${statics.id}" selected="selected">${statics.name}</option>`);
            } else {
                staticsOpHtml.push(`<option value="${statics.id}">${statics.name}</option>`);
            }
        });
        staticsOpHtml = _.join(staticsOpHtml);
        var fieldStaticsHtml = `<select class="form-control field-statics" style="${useOrigin ? `display:none` : ''}">${staticsOpHtml}</select>`;
        if (isDisabled) {
            fieldStaticsHtml = `<select class="form-control field-statics" style="${useOrigin ? `display:none` : ''}" disabled="disabled">${staticsOpHtml}</select>`;
        }
        fieldStaticsHtml = _.join(fieldStaticsHtml, '');
        var rowHtml = `
        <div class="axis_row" data-index="${filedIndex}">
            <select class="form-control field-key">${selectOpHtml}</select>
            ${fieldStaticsHtml}
            <span class="axis_oper_box">
                <i class="axis_oper_icon add-row" title="添加"></i>
                <i class="axis_oper_icon minus-row" title="删除"></i>
            </span>
        </div>`;
        return rowHtml;
    },
    showHistoryDataChartDialog: function (params) {
        let virtualDeviceCls = params.virtualDeviceCls || '';
        let chartType = params.chartType || 'line-chart1';
        let useOrigin = params.useOrigin || false;
        let rangeType = params.rangeType || 'D1';
        let startDate = params.startDate || '';
        let endDate = params.endDate || '';
        let groups = params.groups || {};//{field:'','format':''}
        if (_.isEmpty(groups)) {
            _.set(groups, 'id', 'time');
            _.set(groups, 'time_format', '%Y');
            _.set(groups, 'name', '时间(年份)');
        } else {
            groups = JSON.parse(groups);
        }
        let fields = params.fields || [{'id': 'time', 'statis': '$count', 'name': '时间(计数)'}];//[{'field':'','type':''}]
        if (_.isEmpty(fields)) {
            fields = [{'id': 'time', 'statis': '$count', 'name': '时间(计数)'}];
        } else {
            fields = JSON.parse(fields);
        }
        var deferred = $.Deferred();
        NeptuneUtils.getClsDDList(virtualDeviceCls).done(function (clsDDList) {
            var clsDDFirst = _.nth(clsDDList, 0);
            if (clsDDFirst && clsDDFirst.key !== 'time' && (chartType === 'line-chart1' && !useOrigin)) {
                clsDDList.unshift({
                    key: 'time',
                    name: '时间',
                    rule: 'str'
                });
            }
            var timeFormats = [{
                id: '%Y',
                name: '年份',
                example: '2016'
            }, {
                id: '%Y-%m',
                name: '年-月',
                example: '2016-5'
            }, {
                id: '%Y-%m-%d',
                name: '年-月-日',
                example: '2016-5-6'
            }, {
                id: '%H:%M',
                name: '时:分',
                example: '15:30'
            }, {
                id: '%H:%M:%S',
                name: '时:分:秒',
                example: '15:30:36'
            }, {
                id: '%H:%M:%S.%L',
                name: '时:分:秒.毫秒',
                example: '15:30:36.568'
            }, {
                id: '%Y-%m-%d %H',
                name: '年-月-日 时',
                example: '2016-05-06 15'
            }, {
                id: '%Y-%m-%d %H:%M',
                name: '年-月-日 时-分',
                example: '2016-05-06 15:30'
            }];

            var timeFormatHtml = [];
            _.each(timeFormats, function (item) {
                if (item.id === groups.time_format) {
                    timeFormatHtml.push(`<option value="${item.id}" selected="selected">${item.name}</option>`);
                } else {
                    timeFormatHtml.push(`<option value="${item.id}">${item.name}</option>`);
                }
            });

            var selectOpHtml = [], disabledGroup = '';
            if (chartType === 'line-chart1' && useOrigin) {
                selectOpHtml.push(`<option value="time" selected="selected">时间</option>`);
                disabledGroup = `disabled='disabled'`;
            }
            _.each(clsDDList, function (clsDDItem) {
                if (clsDDItem.key === groups.id) {
                    selectOpHtml.push(`<option value="${clsDDItem.key}" selected="selected">${clsDDItem.name}</option>`);
                } else {
                    selectOpHtml.push(`<option value="${clsDDItem.key}">${clsDDItem.name}</option>`);
                }
            });
            var fieldHtml = NeptuneUtils.addHistoryDataFieldRows(fields, clsDDList);

            var html = `<div class="chart_setting_body">
<div class="chart_sub_title"> <i class="fa fa-circle-o"></i> <span>图表类型</span> </div>
<div class="chart_setting_row">
    <img style="cursor: pointer;" class="line-chart-history" data-key="line-chart1" src="${cynovan.r_path}prototype/monitor/img/lib/neptune/line_chart1.png" title="折线图"/>
    <img style="cursor: pointer;" class="bar-chart-history" data-key="bar-chart1" src="${cynovan.r_path}prototype/monitor/img/lib/neptune/bar_chart1.png" title="柱状图"/>
</div>
<div class="chart_sub_title"> <i class="fa fa-circle-o"></i> <span>数据筛选</span> </div>
<div class="chart_setting_row">
    <select class="form-control date_range_type">
        <option value="D1">今天</option>
        <option value="D2">昨天</option>
        <option value="D3">过去7天</option>
        <option value="D4">过去30天</option>
        <option value="D5">过去60天</option>
        <option value="D6">过去90天</option>
        <option value="D7">过去180天</option>
        <option value="D100">日期范围</option>
    </select>
<div class="date_range_box" style="display: none">
    <input type="date" class="data-start-date form-control date" data-key="startDate" />
    <input type="date" class="data-end-date form-control date" data-key="dateEnd" /></div>
</div>
<div class="chart_sub_title"> 
    <i class="fa fa-circle-o"></i> <span>分组栏位</span>
    <span class="use-origin-span" style="margin-left: 10px;cursor: pointer">
        <label style="font-size: 14px;font-weight: 500;margin-bottom: 0;display: inline-flex; align-items: center; align-content: center;">
            <input type="checkbox" class="use-origin-value" style="margin: 0 5px;"> 使用原值
        </label> 
    </span>
</div>
<div class="chart_setting_row">
    <select class="form-control group-field" ${disabledGroup}>${selectOpHtml.join('')}</select>
    <select class="form-control group-format"> ${timeFormatHtml.join('')}</select>
</div>
<div class="chart_sub_title"> <i class="fa fa-circle-o"></i> <span>数据栏位</span></div>
<div class="chart_setting_row data-field">
    ${fieldHtml}
</div>`;

            var element = bootbox.dialog({
                title: '历史数据图表设置',
                message: html,
                buttons: {
                    'success': {
                        label: "确认",
                        className: "btn btn-success",
                        callback: function () {
                            var fieldsArray = [];
                            var fieldsRow = $('.data-field .axis_row');
                            let noClose = false;
                            let allFieldKeys = [];
                            _.each(fieldsRow, function (row) {
                                let key = $(row).find('.field-key').val();
                                if (key === '') {
                                    noClose = true;
                                }
                                allFieldKeys.push(key);
                                let fieldInfo = {};
                                _.set(fieldInfo, 'id', key);
                                let name = $(row).find('.field-key option:selected').text() + '(' + $(row).find('.field-statics option:selected').text() + ')';
                                if (useOrigin) {
                                    name = $(row).find('.field-key option:selected').text();
                                }
                                _.set(fieldInfo, 'name', name);
                                _.set(fieldInfo, 'statis', $(row).find('.field-statics').val());
                                fieldsArray.push(fieldInfo)
                            });
                            let override = allFieldKeys.length === _.uniq(allFieldKeys).length ? false : true;

                            if (noClose) {
                                alert('请选择栏位');
                                return false;
                            }
                            if (override) {
                                alert('栏位重复，请检查');
                                return false;
                            }

                            let params = {
                                updateTime: new Date().getTime(),
                                chartType: chartType,
                                rangeType: rangeType,
                                startDate: startDate,
                                endDate: endDate,
                                useOrigin: useOrigin,
                                groups: JSON.stringify(groups),
                                fields: JSON.stringify(fieldsArray)
                            };

                            deferred.resolve(params);
                            return true;
                        }
                    },
                    'cancel': {
                        label: '取消',
                        className: 'btn btn-default',
                        callback: function (event) {
                            return true;
                        }
                    }
                }
            });
            element.find('.modal-dialog').width(800);

            element.find('.bootbox-body').css({
                'max-height': window.innerHeight - 210 + 'px',
                'overflow-y': 'scroll'
            });

            /**选择图表类型start*/
            var addSelectBorder = function (chartType) {
                if (chartType === 'line-chart1') {
                    $('.chart_setting_row >.line-chart-history').css({
                        "border": "solid 1px #488eff"
                    });
                    $('.chart_setting_row >.bar-chart-history').css({
                        "border": "none"
                    });
                    $('.use-origin-span').css('display', 'inline-block');
                } else if (chartType === 'bar-chart1') {
                    $('.chart_setting_row >.line-chart-history').css({
                        "border": "none"
                    });
                    $('.chart_setting_row >.bar-chart-history').css({
                        "border": "solid 1px #488eff"
                    });
                    $('.use-origin-span').css('display', 'none');
                }
            };
            addSelectBorder(chartType);
            element.find('.chart_setting_row >img').click(function (event) {
                var img = $(this);
                chartType = img.data('key');
                let checked = $('.use-origin-value')[0].checked;
                if (chartType === 'bar-chart1') {
                    checked = false;
                }
                initUseOrigin(checked);
                addSelectBorder(chartType);
            });
            /**选择图表类型end*/

            /**数据范围start*/
            element.find('.date_range_type').change(function (event) {
                let select = $(this);
                let value = select.val();
                if (value && value === 'D100') {
                    $('.date_range_box').css('display', 'inline-flex');
                    let defaultDate = new Date();
                    if (_.isEmpty(startDate)) {
                        startDate = defaultDate.toISOString().split('T')[0];
                    }
                    if (_.isEmpty(endDate)) {
                        endDate = defaultDate.toISOString().split('T')[0];
                    }
                    $('.date_range_box .data-start-date').val(startDate);
                    $('.date_range_box .data-end-date').val(endDate);
                } else {
                    $('.date_range_box').css('display', 'none');
                }
                rangeType = value;
            });
            element.find('.data-start-date').change(function (event) {
                let select = $(this);
                let value = select.val();
                startDate = value;
            });
            element.find('.data-end-date').change(function (event) {
                let select = $(this);
                let value = select.val();
                endDate = value;
            });
            element.find('.date_range_type').val(rangeType);
            if (rangeType === 'D100') {
                $('.date_range_box .data-start-date').val(startDate);
                $('.date_range_box .data-end-date').val(endDate);
            }

            /**数据范围end*/

            /**分组栏位start*/
            function initUseOrigin(isOrigin) {
                if (isOrigin) {
                    $('.group-field').val('time');
                    $('.group-field').attr('disabled', 'disabled');
                    $('.group-format').css('display', 'none');
                    $('.field-statics').css('display', 'none');
                    _.each($('.field-key'), function (f) {
                        let opFirst = $(f).find('option:nth-child(1)');
                        if (opFirst.val() && opFirst.val() === 'time') {
                            $(`<option value=""></option>`).insertBefore(opFirst);
                            opFirst.remove();
                        }
                    });
                } else {
                    $('.group-field').removeAttr('disabled');
                    if ($('.group-field').val() === 'time') {
                        $('.group-format').css('display', 'inline-flex');
                    }
                    $('.field-statics').css('display', 'inline-block');
                    _.each($('.field-key'), function (f) {
                        let opFirst = $(f).find('option:nth-child(1)');
                        if (opFirst.val() !== 'time') {
                            $(`<option value="time">时间</option>`).insertBefore(opFirst);
                            if (opFirst.val() === '') {
                                opFirst.remove();
                            }
                        }
                    });
                }
            };
            if (chartType === 'line-chart1' && useOrigin) {
                $('.use-origin-value')[0].checked = true;
                initUseOrigin(useOrigin);
            }
            element.find('.use-origin-value').change(function (event) {
                let isOrigin = $('.use-origin-value')[0].checked;
                useOrigin = isOrigin;
                initUseOrigin(isOrigin);
            });
            element.find('.group-field').change(function (event) {
                let select = $(this);
                let value = select.val();
                if (value && value === 'time') {
                    $('.group-format').css('display', 'inline-flex');
                    _.set(groups, 'id', 'time');
                    _.set(groups, 'time_format', '%Y');
                    _.set(groups, 'name', '时间(年份)');
                } else {
                    $('.group-format').css('display', 'none');
                    _.set(groups, 'id', value);
                    _.unset(groups, "time_format");
                    _.unset(groups, "name");
                }
            });
            element.find('.group-format').change(function (event) {
                let select = $(this);
                let value = select.val();
                _.set(groups, 'time_format', value);
            });
            element.find('.group-field').val(groups.id);
            if (groups.time_format) {
                element.find('.group-format').val(groups.time_format);
            }

            /**分组栏位end*/

            /**数据栏位start*/
            function fieldChange(event) {
                let selectedIndex = $(event.target).prop('selectedIndex');
                let row = $(event.target).closest('.axis_row');
                let item = _.nth(clsDDList, selectedIndex);
                if (item.rule === 'number') {
                    row.find('.field-statics').removeAttr('disabled');
                } else {
                    row.find('.field-statics').val('$count');//不是数字，则默认选择计数方式
                    row.find('.field-statics').attr('disabled', 'disabled');
                }
            }

            element.find('.field-key').closest('select').change(function (event) {
                fieldChange(event);
            });

            // 添加一行.
            function addRow(event) {
                var row = $(event.target).closest('.axis_row');
                var idx = _.parseInt(row.data('index')) + 1;
                var newField = {'field': 'time', 'type': '$count'};
                if (useOrigin) {
                    if (clsDDFirst.key === 'time') {
                        clsDDList.splice(0, 1)
                    }
                }
                var newRowHtml = NeptuneUtils.addHistoryDataFieldRow(idx, newField, clsDDList, useOrigin);

                var newRow = $(newRowHtml).insertAfter(row);
                newRow.find('.field-key').closest('select').change(function (event) {
                    fieldChange(event);
                });
                newRow.find('.add-row').closest('i').click(function (event) {
                    addRow(event);
                });
                newRow.find('.minus-row').closest('i').click(function (event) {
                    removeRow(event);
                });

            };
            element.find('.add-row').closest('i').click(function (event) {
                addRow(event);
            });

            // 删除当前行.
            function removeRow(event) {
                var row = $(event.target).closest('.axis_row');
                var rowLength = $('.data-field .axis_row').length;
                if (rowLength === 1) {
                    return;
                }
                row.remove();
            };
            element.find('.minus-row').closest('i').click(function (event) {
                removeRow(event)
            });
            /**数据栏位end*/
        });

        return deferred;
    },
    addMapMarker: function (componentId, poi, deviceName, showTip) {
        let mapId = '#' + componentId + '_map_container';
        let map = $(mapId).data('map');
        let title = deviceName ? deviceName : poi.name;
        var marker = new AMap.Marker({
            title: title
        });
        marker.setPosition(poi.location);
        map.setCenter([poi.location.lng, poi.location.lat]);
        map.add(marker);

        var infoWindow = new AMap.InfoWindow({
            offset: new AMap.Pixel(0, -20)
        });
        infoWindow.setMap(map);
        infoWindow.setPosition(poi.location);
        if (showTip) {
            var html = [];
            html.push(`<div class="marker-device-name">${title}</div>`);
            html.push('<div>' + (poi.district || '') + '</div>');
            html.push('<div>' + (poi.address || '') + '</div>');
            html.push('<div>' + (poi.name || '') + '</div>');
            infoWindow.setContent(html.join(''));
        }
        infoWindow.open(map, marker.getPosition());
        setTimeout(function () {
            /*清除href属性，防止跳转页面*/
            $(mapId).find(".amap-info-close").removeAttr('href');
        }, 400);
    }
};


/**
 * Copyright (c) 2006-2012, JGraph Ltd
 */
/**
 * Editor constructor executed on page load.
 */
Editor = function (chromeless, themes, model, graph, editable) {
    mxEventSource.call(this);
    this.chromeless = (chromeless != null) ? chromeless : this.chromeless;
    this.initStencilRegistry();
    this.graph = graph || this.createGraph(themes, model);
    /*Aric.chen:重写mxGraph的tooltip函数，隐藏tooltip*/
    this.graph.tooltipHandler.isEnabled = function () {
        return false;
    }
    this.editable = (editable != null) ? editable : !chromeless;
    this.undoManager = this.createUndoManager();
    this.status = '';

    this.getOrCreateFilename = function () {
        return this.filename || mxResources.get('drawing', [Editor.pageCounter]) + '.xml';
    };

    this.getFilename = function () {
        return this.filename;
    };

    // Sets the status and fires a statusChanged event
    this.setStatus = function (value) {
        this.status = value;
        this.fireEvent(new mxEventObject('statusChanged'));
    };

    // Returns the current status
    this.getStatus = function () {
        return this.status;
    };

    // Updates modified state if graph changes
    this.graphChangeListener = function (sender, eventObject) {
        var edit = (eventObject != null) ? eventObject.getProperty('edit') : null;

        if (edit == null || !edit.ignoreEdit) {
            this.setModified(true);
        }
    };

    this.graph.getModel().addListener(mxEvent.CHANGE, mxUtils.bind(this, function () {
        this.graphChangeListener.apply(this, arguments);
    }));

    // Sets persistent graph state defaults
    this.graph.resetViewOnRootChange = false;
    this.init();
};

/**
 * Counts open editor tabs (must be global for cross-window access)
 */
Editor.pageCounter = 0;

// Cross-domain window access is not allowed in FF, so if we
// were opened from another domain then this will fail.
(function () {
    try {
        var op = window;

        while (op.opener != null && typeof op.opener.Editor !== 'undefined' &&
        !isNaN(op.opener.Editor.pageCounter) &&
        // Workaround for possible infinite loop in FF https://drawio.atlassian.net/browse/DS-795
        op.opener != op) {
            op = op.opener;
        }

        // Increments the counter in the first opener in the chain
        if (op != null) {
            op.Editor.pageCounter++;
            Editor.pageCounter = op.Editor.pageCounter;
        }
    } catch (e) {
        // ignore
    }
})();

/**
 * Specifies if local storage should be used (eg. on the iPad which has no filesystem)
 */
Editor.useLocalStorage = typeof (Storage) != 'undefined' && mxClient.IS_IOS;

/**
 * Images below are for lightbox and embedding toolbars.
 */
Editor.helpImage = (mxClient.IS_SVG) ? 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0Ij48cGF0aCBmaWxsPSJub25lIiBkPSJNMCAwaDI0djI0SDB6Ii8+PHBhdGggZD0iTTExIDE4aDJ2LTJoLTJ2MnptMS0xNkM2LjQ4IDIgMiA2LjQ4IDIgMTJzNC40OCAxMCAxMCAxMCAxMC00LjQ4IDEwLTEwUzE3LjUyIDIgMTIgMnptMCAxOGMtNC40MSAwLTgtMy41OS04LThzMy41OS04IDgtOCA4IDMuNTkgOCA4LTMuNTkgOC04IDh6bTAtMTRjLTIuMjEgMC00IDEuNzktNCA0aDJjMC0xLjEuOS0yIDItMnMyIC45IDIgMmMwIDItMyAxLjc1LTMgNWgyYzAtMi4yNSAzLTIuNSAzLTUgMC0yLjIxLTEuNzktNC00LTR6Ii8+PC9zdmc+' :
    IMAGE_PATH + '/help.png';

/**
 * Sets the default font size.
 */
Editor.checkmarkImage = (mxClient.IS_SVG) ? 'data:image/gif;base64,R0lGODlhFQAVAMQfAGxsbHx8fIqKioaGhvb29nJycvr6+sDAwJqamltbW5OTk+np6YGBgeTk5Ly8vJiYmP39/fLy8qWlpa6ursjIyOLi4vj4+N/f3+3t7fT09LCwsHZ2dubm5r6+vmZmZv///yH/C1hNUCBEYXRhWE1QPD94cGFja2V0IGJlZ2luPSLvu78iIGlkPSJXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQiPz4gPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iQWRvYmUgWE1QIENvcmUgNS4wLWMwNjAgNjEuMTM0Nzc3LCAyMDEwLzAyLzEyLTE3OjMyOjAwICAgICAgICAiPiA8cmRmOlJERiB4bWxuczpyZGY9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkvMDIvMjItcmRmLXN5bnRheC1ucyMiPiA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IFdpbmRvd3MiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6OEY4NTZERTQ5QUFBMTFFMUE5MTVDOTM5MUZGMTE3M0QiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6OEY4NTZERTU5QUFBMTFFMUE5MTVDOTM5MUZGMTE3M0QiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDo4Rjg1NkRFMjlBQUExMUUxQTkxNUM5MzkxRkYxMTczRCIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDo4Rjg1NkRFMzlBQUExMUUxQTkxNUM5MzkxRkYxMTczRCIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PgH//v38+/r5+Pf29fTz8vHw7+7t7Ovq6ejn5uXk4+Lh4N/e3dzb2tnY19bV1NPS0dDPzs3My8rJyMfGxcTDwsHAv769vLu6ubi3trW0s7KxsK+urayrqqmop6alpKOioaCfnp2cm5qZmJeWlZSTkpGQj46NjIuKiYiHhoWEg4KBgH9+fXx7enl4d3Z1dHNycXBvbm1sa2ppaGdmZWRjYmFgX15dXFtaWVhXVlVUU1JRUE9OTUxLSklIR0ZFRENCQUA/Pj08Ozo5ODc2NTQzMjEwLy4tLCsqKSgnJiUkIyIhIB8eHRwbGhkYFxYVFBMSERAPDg0MCwoJCAcGBQQDAgEAACH5BAEAAB8ALAAAAAAVABUAAAVI4CeOZGmeaKqubKtylktSgCOLRyLd3+QJEJnh4VHcMoOfYQXQLBcBD4PA6ngGlIInEHEhPOANRkaIFhq8SuHCE1Hb8Lh8LgsBADs=' :
    IMAGE_PATH + '/checkmark.gif';

/**
 * Images below are for lightbox and embedding toolbars.
 */
Editor.maximizeImage = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABUAAAAVBAMAAABbObilAAAAElBMVEUAAAAAAAAAAAAAAAAAAAAAAADgKxmiAAAABXRSTlMA758vX1Pw3BoAAABJSURBVAjXY8AJQkODGBhUQ0MhbAUGBiYY24CBgRnGFmZgMISwgwwDGRhEhVVBbAVmEQYGRwMmBjIAQi/CTIRd6G5AuA3dzYQBAHj0EFdHkvV4AAAAAElFTkSuQmCC';

/**
 * Specifies the image URL to be used for the transparent background.
 */
Editor.zoomOutImage = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABUAAAAVBAMAAABbObilAAAAElBMVEUAAAAAAAAsLCxxcXEhISFgYGChjTUxAAAAAXRSTlMAQObYZgAAAEdJREFUCNdjIAMwCQrB2YKCggJQJqMwA7MglK1owMBgqABVApITgLJZXFxgbIQ4Qj3CHIT5ggoIe5kgNkM1KSDYKBKqxPkDAPo5BAZBE54hAAAAAElFTkSuQmCC';

/**
 * Specifies the image URL to be used for the transparent background.
 */
Editor.zoomInImage = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABUAAAAVBAMAAABbObilAAAAElBMVEUAAAAAAAAsLCwhISFxcXFgYGBavKaoAAAAAXRSTlMAQObYZgAAAElJREFUCNdjIAMwCQrB2YKCggJQJqMIA4sglK3owMzgqABVwsDMwCgAZTMbG8PYCHGEeoQ5CPMFFRD2MkFshmpSQLBRJFSJ8wcAEqcEM2uhl2MAAAAASUVORK5CYII=';

/**
 * Specifies the image URL to be used for the transparent background.
 */
Editor.zoomFitImage = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABUAAAAVBAMAAABbObilAAAAD1BMVEUAAAAAAAAwMDBwcHBgYGC1xl09AAAAAXRSTlMAQObYZgAAAEFJREFUCNdjIAMwCQrB2YKCggJQJqMwA7MglK1owMBgqABVApITwMdGqEeYgzBfUAFhLxPEZqgmBQQbRUKFOH8AAK5OA3lA+FFOAAAAAElFTkSuQmCC';

/**
 * Specifies the image URL to be used for the transparent background.
 */
Editor.layersImage = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABUAAAAVCAMAAACeyVWkAAAAaVBMVEUAAAAgICAICAgdHR0PDw8WFhYICAgLCwsXFxcvLy8ODg4uLi4iIiIqKiokJCQYGBgKCgonJycFBQUCAgIqKiocHBwcHBwODg4eHh4cHBwnJycJCQkUFBQqKiojIyMuLi4ZGRkgICAEBATOWYXAAAAAGnRSTlMAD7+fnz8/H7/ff18/77+vr5+fn39/b28fH2xSoKsAAACQSURBVBjTrYxJEsMgDARZZMAY73sgCcn/HxnhKtnk7j6oRq0psfuoyndZ/SuODkHPLzfVT6KeyPePnJ7KrnkRjWMXTn4SMnN8mXe2SSM3ts8L/ZUxxrbAULSYJJULE0Iw9pjpenoICcgcX61mGgTgtCv9Be99pzCoDhNQWQnchD1mup5++CYGcoQexajZbfwAj/0MD8ZOaUgAAAAASUVORK5CYII=';

/**
 * Specifies the image URL to be used for the transparent background.
 */
Editor.previousImage = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAABmJLR0QA/wD/AP+gvaeTAAAAh0lEQVQ4je3UsQnCUBCA4U8hpa1NsoEjpHQJS0dxADdwEMuMIJkgA1hYChbGQgMi+JC8q4L/AB/vDu7x74cWWEZhJU44RmA1zujR5GIbXF9YNrjD/Q0bDRY4fEBZ4P4LlgTnCbAf84pUM8/9hY08tMUtEoQ1LpEgrNBFglChFXR6Q6GfwwR6AGKJMF74Vtt3AAAAAElFTkSuQmCC';

/**
 * Specifies the image URL to be used for the transparent background.
 */
Editor.nextImage = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAABmJLR0QA/wD/AP+gvaeTAAAAi0lEQVQ4jeXUIQ7CUAwA0MeGxWI2yylwnALJUdBcgYvM7QYLmjOQIAkIPmJZghiIvypoUtX0tfnJL38X5ZfaEgUeUcManFBHgS0SLlhHggk3bCPBhCf2keCQR8wjwYTDp6YiZxJmOU1jGw7vGALescuBxsArNlOwd/CM1VSM/ut1qCIw+uOwiMJ+OF4CQzBCXm3hyAAAAABJRU5ErkJggg==';

/**
 * Specifies the image URL to be used for the transparent background.
 */
Editor.editImage = (mxClient.IS_SVG) ? 'data:image/gif;base64,R0lGODlhCwALAIABAFdXV////yH5BAEAAAEALAAAAAALAAsAAAIZjB8AiKuc4jvLOGqzrjX6zmkWyChXaUJBAQA7' : IMAGE_PATH + '/edit.gif';

/**
 * Specifies the image URL to be used for the transparent background.
 */
Editor.zoomOutLargeImage = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAAilBMVEUAAAD////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////2N2iNAAAALXRSTlMA+vTcKMM96GRBHwXxi0YaX1HLrKWhiHpWEOnOr52Vb2xKSDcT19PKv5l/Ngdk8+viAAABJklEQVQ4y4WT2XaDMAxEvWD2nSSUNEnTJN3r//+9Sj7ILAY6L0ijC4ONYVZRpo6cByrz2YKSUGorGTpz71lPVHvT+avoB5wIkU/mxk8veceSuNoLg44IzziXjvpih72wKQnm8yc2UoiP/LAd8jQfe2Xf4Pq+2EyYIvv9wbzHHCgwxDdlBtWZOdqDfTCVgqpygQpsZaojVAVc9UjQxnAJDIBhiQv84tq3gMQCAVTxVoSibXJf8tMuc7e1TB/DCmejBNg/w1Y3c+AM5vv4w7xM59/oXamrHaLVqPQ+OTCnmMZxgz0SdL5zji0/ld6j88qGa5KIiBB6WeJGKfUKwSMKLuXgvl1TW0tm5R9UQL/efSDYsnzxD8CinhBsTTdugJatKpJwf8v+ADb8QmvW7AeAAAAAAElFTkSuQmCC';

/**
 * Specifies the image URL to be used for the transparent background.
 */
Editor.zoomInLargeImage = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAAilBMVEUAAAD////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////2N2iNAAAALXRSTlMA+vTcKMM96GRBHwXxi0YaX1HLrKWhiHpWEOnOr52Vb2xKSDcT19PKv5l/Ngdk8+viAAABKElEQVQ4y4WT6WKCMBCENwkBwn2oFKvWqr3L+79es4EkQIDOH2d3Pxk2ABiJlB8JCXjqw4LikHVGLHTm3nM3UeVN5690GBBN0GwyV/3kkrUQR+WeKnREeKpzaXWd77CmJiXGfPIEI4V4yQ9TIW/ntlcMBe731Vts9w5TWG8F5j3mQI4hvrKpdGeYA7CX9qAcl650gVJartxRuhyHVghF8idQAIbFLvCLu28BsQEC6aKtCK6Pyb3JT7PmbmtNH8Ny56CotD/2qOs5cJbuffxgXmCib+xddVU5RNOhkvvkhTlFehzVWCOh3++MYElOhfdovaImnRYVmqDdsuhNp1QrBBE6uGC2+3ZNjGdg5B94oD+9uyVgWT79BwAxEBTWdOu3bWBVgsn/N/AHUD9IC01Oe40AAAAASUVORK5CYII=';

/**
 * Specifies the image URL to be used for the transparent background.
 */
Editor.actualSizeLargeImage = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAAilBMVEUAAAD////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////2N2iNAAAALXRSTlMA+vTcKMM96GRBHwXxi0YaX1HLrKWhiHpWEOnOr52Vb2xKSDcT19PKv5l/Ngdk8+viAAABIUlEQVQ4y4WT2XqDIBCFBxDc9yTWNEnTJN3r+79eGT4BEbXnaubMr8dBBaM450dCQp4LWFAascGIRd48eB4cNYE7f6XjgGiCFs5c+dml6CFN6j1V6IQIlHPpdV/usKcmJcV88gQTRXjLD9Mhb+fWq8YG9/uCmTCFjeeDeY85UGKIUGUuqzN42kv7oCouq9oHamlzVR1lVfpAIu1QVRiW+sAv7r4FpAYIZZVsRXB9TP5Dfpo1d1trCgzz1iiptH/sUbdz4CzN9+mLeXHn3+hdddd4RDegsrvzwZwSs2GLPRJidAqCLTlVwaMPqpYMWjTWBB2WRW86pVkhSKyDK2bdt2tmagZG4sBD/evdLQHLEvQfAOKRoLCmG1FAB6uKmby+gz+REDn7O5+EwQAAAABJRU5ErkJggg==';

/**
 * Specifies the image URL to be used for the transparent background.
 */
Editor.printLargeImage = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAAXVBMVEUAAAD///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////9RKvvlAAAAHnRSTlMAydnl77qbMLT093H7K4Nd4Ktn082+lYt5bkklEgP44nQSAAAApUlEQVQ4y73P2Q6DIBRF0cOgbRHHzhP//5m9mBAQKjG1cT0Yc7ITAMu1LNQgUZiQ2DYoNQ0sCQb6qgHAfRx48opq3J9AZ6xuF7uOew8Ik1OsCZRS2UAC9V+D9a+QZYxNA45YFQftPtSkATOhw7dAc0vPBwKWiIOjP0JZ0yMuQJ27g36DipOUsqRAM0dR8KD1/ILHaHSE/w8DIx09E3g/BTce6rHUB5sAPKvfF+JdAAAAAElFTkSuQmCC';

/**
 * Specifies the image URL to be used for the transparent background.
 */
Editor.layersLargeImage = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAAmVBMVEUAAAD////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////+/v7///+bnZkkAAAAMnRSTlMABPr8ByiD88KsTi/rvJb272mjeUA1CuPe1M/KjVxYHxMP6KZ0S9nYzGRGGRaznpGIbzaGUf0AAAHESURBVDjLbZLZYoIwEEVDgLCjbKIgAlqXqt3m/z+uNwu1rcyDhjl3ktnYL7OY254C0VX3yWFZfzDrOClbbgKxi0YDHjwl4jbnRkXxJS/C1YP3DbBhD1n7Ex4uaAqdVDb3yJ/4J/3nJD2to/ngQz/DfUvzMp4JJ5sSCaF5oXmemgQDfDxzbi+Kq4sU+vNcuAmx94JtyOP2DD4Epz2asWSCz4Z/4fECxyNj9zC9xNLHcdPEO+awDKeSaUu0W4twZQiO2hYVisTR3RCtK/c1X6t4xMEpiGqXqVntEBLolkZZsKY4QtwH6jzq67dEHlJysB1aNOD3XT7n1UkasQN59L4yC2RELMDSeCRtz3yV22Ub3ozIUTknYx8JWqDdQxbUes98cR2kZtUSveF/bAhcedwEWmlxIkpZUy4XOCb6VBjjxHvbwo/1lBAHHi2JCr0NI570QhyHq/DhJoE2lLgyA4RVe6KmZ47O/3b86MCP0HWa73A8/C3SUc5Qc1ajt6fgpXJ+RGpMvDSchepZDOOQRcZVIKcK90x2D7etqtI+56+u6n3sPriO6nfphitR4+O2m3EbM7lh3me1FM1o+LMI887rN+s3/wZdTFlpNVJiOAAAAABJRU5ErkJggg==';

/**
 * Specifies the image URL to be used for the transparent background.
 */
Editor.closeLargeImage = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAAUVBMVEUAAAD///////////////////////////////////////////////////////////////////////////////////////////////////////8IN+deAAAAGnRSTlMAuvAIg/dDM/QlOeuFhj0S5s4vKgzjxJRQNiLSey0AAADNSURBVDjLfZLbEoMgDEQjRRRs1XqX///QNmOHJSnjPkHOGR7IEmeoGtJZstnwjqbRfIsmgEdtPCqe9Ynz7ZSc07rE2QiSc+qv8TvjRXA2PDUm3dpe82iJhOEUfxJJo3aCv+jKmRmH4lcCjCjeh9GWOdL/GZZkXH3PYYDrHBnfc4D/RVZf5sjoC1was+Y6HQxwaUxFvq/a0Pv343VCTxfBSRiB+ab3M3eiQZXmMNBJ3Y8pGRZtYQ7DgHMXJEdPLTaN/qBjzJOBc3nmNcbsA16bMR0oLqf+AAAAAElFTkSuQmCC';

/**
 * Specifies the image URL to be used for the transparent background.
 */
Editor.editLargeImage = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAAgVBMVEUAAAD///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////9d3yJTAAAAKnRSTlMA+hzi3nRQWyXzkm0h2j3u54gzEgSXjlYoTBgJxL2loGpAOS3Jt7Wxm35Ga7gRAAAA6UlEQVQ4y63Q2XaCMBSF4Q0JBasoQ5DJqbXjfv8HbCK2BZNwo/8FXHx7rcMC7lQu0iX8qU/qtvAWCpoqH8dYzS0SwaV5eK/UAf8X9pd2CWKzuF5Jrftp1owXwnIGLUaL3PYndOHf4kNNXWrXK/m7CHunk7K8LE6YtBpcknwG9GKxnroY+ylBXcx4xKyx/u/EuXi509cP9V7OO1oyHnzrdFTcqLG/4ibBA5pIMr/4xvKzuQDkVy9wW8SgBFD6HDvuzMvrZcC9QlkfMzI7w64m+b4PqBMNHB05lH21PVxJo2/fBXxV4hB38PcD+5AkI4FuETsAAAAASUVORK5CYII=';

/**
 * Specifies the image URL to be used for the transparent background.
 */
Editor.previousLargeImage = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAAPFBMVEUAAAD////////////////////////////////////////////////////////////////////////////YSWgTAAAAE3RSTlMA7fci493c0MW8uJ6CZks4MxQHEZL6ewAAAFZJREFUOMvdkskRgDAMA4lDwg2B7b9XOlge/KKvdsa25KFb5XlRvxXC/DNBEv8IFNjBgGdDgXtFgTyhwDXiQAUHCvwa4Uv6mR6UR+1led2mVonvl+tML45qCQNQLIx7AAAAAElFTkSuQmCC';

/**
 * Specifies the image URL to be used for the transparent background.
 */
Editor.nextLargeImage = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAAPFBMVEUAAAD////////////////////////////////////////////////////////////////////////////YSWgTAAAAE3RSTlMA7fci493c0MW8uJ6CZks4MxQHEZL6ewAAAFRJREFUOMvd0skRgCAQBVEFwQ0V7fxzNQP6wI05v6pZ/kyj1b7FNgik2gQzzLcAwiUAigHOTwDHK4A1CmB5BJANJG1hQ9qafYcqFlZP3IFc9eVGrR+iIgkDQRUXIAAAAABJRU5ErkJggg==';

/**
 * Specifies the image to be used for the refresh button.
 */
Editor.refreshLargeImage = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAAolBMVEUAAAD///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////8ELnaCAAAANXRSTlMABfyE2QKU+dfNyyDyoVYKwnTv7N+6rntsYlFNQjEqEw316uSzf2c1JB3GvqebiVw6GAjQB4DQr10AAAE7SURBVDjLvZLXcoMwEABPIgRCx3TT3A3udqL//7UgAdGRcR4yk8k+idsdmgS/QyWEqD/axS2JDV33zlnzLHIzQ2MDq9OeJ3m8l76KKENYlxrmM/b65Ys1+8YxnTEZFIEY0vVhszFWfUGZDJpQTDznTgAe5k4XhQxILB7ruzBQn+kkyDXuHfRtjoYDEvH7J9Lz98dBZXXL94X0Ofco2PFlChKbjVzEdakoSlKjoNoqPYkJ/wUZAYwc+PpLj1Ei7+jdoBWlwQZoJv2H1w3CWgRvo7dd9DP5btgwCWz0M02+oVoxCcIWeY9PNmR6B++m9prMxYEISpCBYBlfy9bc745is7UUULAem1Ww7FfalsiA2uaJsgmWP3pQI9q9/yMLkaaHAp2fxhHff/cNq7dBdHXhGW7l+Mo2zU0Cf8knJ2xA0oJ8enwAAAAASUVORK5CYII=';

/**
 * Specifies the image to be used for the back button.
 */
Editor.backLargeImage = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAAclBMVEUAAAD////////////////+/v7////////////////////////////////////////////+/v7///////////////////////////////////////////////////////////////////////////////8vKLfTAAAAJXRSTlMACh7h9gby3NLIwzwZ55uVJgH57b+8tbCljYV1RRMQ46FrTzQw+vtxOQAAAJ5JREFUOMuF00cWgzAQA1DRDQFCbwFSdf8rZpdVrNH2z3tuMv7mldZQ2WN2yi8x+TT8JvyTkqvwpiKvwsOIrA1fWr+XGTklfj8dOQR+D3KyUF6QufBkJN0hfCazEv6sZBRCJDUcPasGKpu1RLtYE8lkHAPBQLoTsK/SfAyRw5FjAuhCzC2MSj0gJ+66lHatgXdKboD9tfREB5m9/+3iC9jHDYvsGNcUAAAAAElFTkSuQmCC';

/**
 * Specifies the image to be used for the back button.
 */
Editor.fullscreenLargeImage = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAAllBMVEUAAAD////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////AJcWoAAAAMXRSTlMA+wIFxPWPCIb446tnUxmsoIykgxTe29jQnpKBe2MNsZhVTR/KyLuWbFhEPjUq7L9z+bQj+gAAAWxJREFUOMttk4l2gkAMRTODCO4FtQgIbnWpS9v8/881iZFh8R51NO8GJ+gAjMN8zuTRFSw04cIOHQcqFHH6oaQFGxf0jeBjEgB8Y52TpW9Ag4zB5QICWOtHrgwGuFZBcw+gPP0MFS7+iiD5inOmDIQS9sZgTwUzwEzyxhxHVEEU7NdDUXsqUPtqjIgR2IZSCT4upzSeIeOdcMHnfDsx3giPoezfU6MrQGB5//SckLEG2xYscK4GfnUFqaix39zrwooaOD/cXoYuvHKQIc7pzd3HVPusp6t2FAW/RmjMonbl8vwHDeZo/GkleJC7e+p5XA/rAq1X/V10wKag04rBpa2/d0LL4OYYceOEtsG5jyMntI1wS+N1BGcQBl/CoLoPOl9ABrW/BP53e1bwSJHHlkIVchJwmHwyyfJ4kIvEnKtwkxNSEct83KSChT7WiWgDZ3ccZ0BM4tloJow2YUAtifNT3njnyD+y/pMsnP4DN3Y4yl1Gyk0AAAAASUVORK5CYII=';

/**
 * Specifies the image URL to be used for the transparent background.
 */
Editor.ctrlKey = (mxClient.IS_MAC) ? 'Cmd' : 'Ctrl';

/**
 * Specifies if the diagram should be saved automatically if possible. Default
 * is true.
 */
Editor.popupsAllowed = true;

/**
 * Editor inherits from mxEventSource
 */
mxUtils.extend(Editor, mxEventSource);

/**
 * Stores initial state of mxClient.NO_FO.
 */
Editor.prototype.originalNoForeignObject = mxClient.NO_FO;

/**
 * Specifies the image URL to be used for the transparent background.
 */
Editor.prototype.transparentImage = (mxClient.IS_SVG) ? 'data:image/gif;base64,R0lGODlhMAAwAIAAAP///wAAACH5BAEAAAAALAAAAAAwADAAAAIxhI+py+0Po5y02ouz3rz7D4biSJbmiabqyrbuC8fyTNf2jef6zvf+DwwKh8Si8egpAAA7' :
    IMAGE_PATH + '/transparent.gif';

/**
 * Specifies if the canvas should be extended in all directions. Default is true.
 */
Editor.prototype.extendCanvas = true;

/**
 * Specifies if the app should run in chromeless mode. Default is false.
 * This default is only used if the contructor argument is null.
 */
Editor.prototype.chromeless = false;

/**
 * Specifies the order of OK/Cancel buttons in dialogs. Default is true.
 * Cancel first is used on Macs, Windows/Confluence uses cancel last.
 */
Editor.prototype.cancelFirst = true;

/**
 * Specifies if the editor is enabled. Default is true.
 */
Editor.prototype.enabled = true;

/**
 * Contains the name which was used for the last save. Default value is null.
 */
Editor.prototype.filename = null;

/**
 * Contains the current modified state of the diagram. This is false for
 * new diagrams and after the diagram was saved.
 */
Editor.prototype.modified = false;

/**
 * Specifies if the diagram should be saved automatically if possible. Default
 * is true.
 */
Editor.prototype.autosave = true;

/**
 * Specifies the top spacing for the initial page view. Default is 0.
 */
Editor.prototype.initialTopSpacing = 0;

/**
 * Specifies the app name. Default is document.title.
 */
Editor.prototype.appName = document.title;

/**
 *
 */
Editor.prototype.editBlankUrl = window.location.protocol + '//' + window.location.host + '/';

/**
 * Default value for the graph container overflow style.
 */
Editor.prototype.defaultGraphOverflow = 'hidden';

/**
 * Initializes the environment.
 */
Editor.prototype.init = function () {
};

/**
 * Sets the XML node for the current diagram.
 */
Editor.prototype.isChromelessView = function () {
    return this.chromeless;
};

/**
 * Sets the XML node for the current diagram.
 */
Editor.prototype.setAutosave = function (value) {
    this.autosave = value;
    this.fireEvent(new mxEventObject('autosaveChanged'));
};

/**
 *
 */
Editor.prototype.getEditBlankUrl = function (params) {
    return this.editBlankUrl + params;
}

/**
 *
 */
Editor.prototype.editAsNew = function (xml, title) {
    var p = (title != null) ? '?title=' + encodeURIComponent(title) : '';

    if (urlParams['ui'] != null) {
        p += ((p.length > 0) ? '&' : '?') + 'ui=' + urlParams['ui'];
    }

    if (this.editorWindow != null && !this.editorWindow.closed) {
        this.editorWindow.focus();
    } else {
        if (typeof window.postMessage !== 'undefined' && (document.documentMode == null || document.documentMode >= 10)) {
            if (this.editorWindow == null) {
                mxEvent.addListener(window, 'message', mxUtils.bind(this, function (evt) {
                    if (evt.data == 'ready' && evt.source == this.editorWindow) {
                        this.editorWindow.postMessage(xml, '*');
                    }
                }));
            }

            this.editorWindow = this.graph.openLink(this.getEditBlankUrl(p +
                ((p.length > 0) ? '&' : '?') + 'client=1'), null, true);
        } else {
            this.editorWindow = this.graph.openLink(this.getEditBlankUrl(p) +
                '#R' + encodeURIComponent(xml));
        }
    }
};

/**
 * Sets the XML node for the current diagram.
 */
Editor.prototype.createGraph = function (themes, model) {
    var graph = new Graph(null, model, null, null, themes);
    graph.transparentBackground = false;

    // Opens all links in a new window while editing
    if (!this.chromeless) {
        graph.isBlankLink = function (href) {
            return !this.isExternalProtocol(href);
        };
    }

    return graph;
};

/**
 * Sets the XML node for the current diagram.
 */
Editor.prototype.resetGraph = function () {
    this.graph.gridEnabled = !this.isChromelessView() || urlParams['grid'] == '1';
    this.graph.graphHandler.guidesEnabled = true;
    this.graph.setTooltips(true);
    this.graph.setConnectable(true);
    this.graph.foldingEnabled = true;
    this.graph.scrollbars = this.graph.defaultScrollbars;
    this.graph.pageVisible = this.graph.defaultPageVisible;
    this.graph.pageBreaksVisible = this.graph.pageVisible;
    this.graph.preferPageSize = this.graph.pageBreaksVisible;
    this.graph.background = null;
    this.graph.pageScale = mxGraph.prototype.pageScale;
    this.graph.pageFormat = mxGraph.prototype.pageFormat;
    this.graph.currentScale = 1;
    this.graph.currentTranslate.x = 0;
    this.graph.currentTranslate.y = 0;
    this.updateGraphComponents();
    this.graph.view.setScale(1);
};

/**
 * Sets the XML node for the current diagram.
 */
Editor.prototype.readGraphState = function (node) {
    this.graph.gridEnabled = node.getAttribute('grid') != '0' && (!this.isChromelessView() || urlParams['grid'] == '1');
    this.graph.gridSize = parseFloat(node.getAttribute('gridSize')) || mxGraph.prototype.gridSize;
    this.graph.graphHandler.guidesEnabled = node.getAttribute('guides') != '0';
    this.graph.setTooltips(node.getAttribute('tooltips') != '0');
    this.graph.setConnectable(node.getAttribute('connect') != '0');
    this.graph.connectionArrowsEnabled = node.getAttribute('arrows') != '0';
    this.graph.foldingEnabled = node.getAttribute('fold') != '0';

    if (this.isChromelessView() && this.graph.foldingEnabled) {
        this.graph.foldingEnabled = urlParams['nav'] == '1';
        this.graph.cellRenderer.forceControlClickHandler = this.graph.foldingEnabled;
    }

    var ps = parseFloat(node.getAttribute('pageScale'));

    if (!isNaN(ps) && ps > 0) {
        this.graph.pageScale = ps;
    } else {
        this.graph.pageScale = mxGraph.prototype.pageScale;
    }

    if (!this.graph.isLightboxView()) {
        var pv = node.getAttribute('page');

        if (pv != null) {
            this.graph.pageVisible = (pv != '0');
        } else {
            this.graph.pageVisible = this.graph.defaultPageVisible;
        }
    } else {
        this.graph.pageVisible = false;
    }

    this.graph.pageBreaksVisible = this.graph.pageVisible;
    this.graph.preferPageSize = this.graph.pageBreaksVisible;

    var pw = parseFloat(node.getAttribute('pageWidth'));
    var ph = parseFloat(node.getAttribute('pageHeight'));

    if (!isNaN(pw) && !isNaN(ph)) {
        this.graph.pageFormat = new mxRectangle(0, 0, pw, ph);
    }

    // Loads the persistent state settings
    var bg = node.getAttribute('background');

    if (bg != null && bg.length > 0) {
        this.graph.background = bg;
    } else {
        this.graph.background = null;
    }
};

/**
 * Sets the XML node for the current diagram.
 */
Editor.prototype.setGraphXml = function (node) {
    if (node != null) {
        var dec = new mxCodec(node.ownerDocument);

        if (node.nodeName == 'mxGraphModel') {
            this.graph.model.beginUpdate();

            try {
                this.graph.model.clear();
                this.graph.view.scale = 1;
                this.readGraphState(node);
                this.updateGraphComponents();
                dec.decode(node, this.graph.getModel());
            } finally {
                this.graph.model.endUpdate();
            }

            this.fireEvent(new mxEventObject('resetGraphView'));
        } else if (node.nodeName == 'root') {
            this.resetGraph();

            // Workaround for invalid XML output in Firefox 20 due to bug in mxUtils.getXml
            var wrapper = dec.document.createElement('mxGraphModel');
            wrapper.appendChild(node);

            dec.decode(wrapper, this.graph.getModel());
            this.updateGraphComponents();
            this.fireEvent(new mxEventObject('resetGraphView'));
        } else {
            throw {
                message: mxResources.get('cannotOpenFile'),
                node: node,
                toString: function () {
                    return this.message;
                }
            };
        }
    } else {
        this.resetGraph();
        this.graph.model.clear();
        this.fireEvent(new mxEventObject('resetGraphView'));
    }
};

/**
 * Returns the XML node that represents the current diagram.
 */
Editor.prototype.getGraphXml = function (ignoreSelection) {
    ignoreSelection = (ignoreSelection != null) ? ignoreSelection : true;
    var node = null;

    if (ignoreSelection) {
        var enc = new mxCodec(mxUtils.createXmlDocument());
        node = enc.encode(this.graph.getModel());
    } else {
        node = this.graph.encodeCells(mxUtils.sortCells(this.graph.model.getTopmostCells(
            this.graph.getSelectionCells())));
    }

    if (this.graph.view.translate.x != 0 || this.graph.view.translate.y != 0) {
        node.setAttribute('dx', Math.round(this.graph.view.translate.x * 100) / 100);
        node.setAttribute('dy', Math.round(this.graph.view.translate.y * 100) / 100);
    }

    node.setAttribute('grid', (this.graph.isGridEnabled()) ? '1' : '0');
    node.setAttribute('gridSize', this.graph.gridSize);
    node.setAttribute('guides', (this.graph.graphHandler.guidesEnabled) ? '1' : '0');
    node.setAttribute('tooltips', (this.graph.tooltipHandler.isEnabled()) ? '1' : '0');
    node.setAttribute('connect', (this.graph.connectionHandler.isEnabled()) ? '1' : '0');
    node.setAttribute('arrows', (this.graph.connectionArrowsEnabled) ? '1' : '0');
    node.setAttribute('fold', (this.graph.foldingEnabled) ? '1' : '0');
    node.setAttribute('page', (this.graph.pageVisible) ? '1' : '0');
    node.setAttribute('pageScale', this.graph.pageScale);
    node.setAttribute('pageWidth', this.graph.pageFormat.width);
    node.setAttribute('pageHeight', this.graph.pageFormat.height);

    if (this.graph.background != null) {
        node.setAttribute('background', this.graph.background);
    }

    return node;
};

/**
 * Keeps the graph container in sync with the persistent graph state
 */
Editor.prototype.updateGraphComponents = function () {
    var graph = this.graph;

    if (graph.container != null) {
        graph.view.validateBackground();
        graph.container.style.overflow = (graph.scrollbars) ? 'auto' : this.defaultGraphOverflow;

        this.fireEvent(new mxEventObject('updateGraphComponents'));
    }
};

/**
 * Sets the modified flag.
 */
Editor.prototype.setModified = function (value) {
    this.modified = value;
};

/**
 * Sets the filename.
 */
Editor.prototype.setFilename = function (value) {
    this.filename = value;
};

/**
 * Creates and returns a new undo manager.
 */
Editor.prototype.createUndoManager = function () {
    var graph = this.graph;
    var undoMgr = new mxUndoManager();

    this.undoListener = function (sender, evt) {
        undoMgr.undoableEditHappened(evt.getProperty('edit'));
    };

    // Installs the command history
    var listener = mxUtils.bind(this, function (sender, evt) {
        this.undoListener.apply(this, arguments);
    });

    graph.getModel().addListener(mxEvent.UNDO, listener);
    graph.getView().addListener(mxEvent.UNDO, listener);

    // Keeps the selection in sync with the history
    var undoHandler = function (sender, evt) {
        var cand = graph.getSelectionCellsForChanges(evt.getProperty('edit').changes);
        var model = graph.getModel();
        var cells = [];

        for (var i = 0; i < cand.length; i++) {
            if (graph.view.getState(cand[i]) != null) {
                cells.push(cand[i]);
            }
        }

        graph.setSelectionCells(cells);
    };

    undoMgr.addListener(mxEvent.UNDO, undoHandler);
    undoMgr.addListener(mxEvent.REDO, undoHandler);

    return undoMgr;
};

/**
 * Adds basic stencil set (no namespace).
 */
Editor.prototype.initStencilRegistry = function () {
};

/**
 * Creates and returns a new undo manager.
 */
Editor.prototype.destroy = function () {
    if (this.graph != null) {
        this.graph.destroy();
        this.graph = null;
    }
};

/**
 * Class for asynchronously opening a new window and loading a file at the same
 * time. This acts as a bridge between the open dialog and the new editor.
 */
OpenFile = function (done) {
    this.producer = null;
    this.consumer = null;
    this.done = done;
    this.args = null;
};

/**
 * Registers the editor from the new window.
 */
OpenFile.prototype.setConsumer = function (value) {
    this.consumer = value;
    this.execute();
};

/**
 * Sets the data from the loaded file.
 */
OpenFile.prototype.setData = function () {
    this.args = arguments;
    this.execute();
};

/**
 * Displays an error message.
 */
OpenFile.prototype.error = function (msg) {
    this.cancel(true);
    mxUtils.alert(msg);
};

/**
 * Consumes the data.
 */
OpenFile.prototype.execute = function () {
    if (this.consumer != null && this.args != null) {
        this.cancel(false);
        this.consumer.apply(this, this.args);
    }
};

/**
 * Cancels the operation.
 */
OpenFile.prototype.cancel = function (cancel) {
    if (this.done != null) {
        this.done((cancel != null) ? cancel : true);
    }
};

/**
 * Basic dialogs that are available in the viewer (print dialog).
 */
function Dialog(editorUi, elt, w, h, modal, closable, onClose, noScroll, transparent, onResize, ignoreBgClick) {
    var dx = 0;

    if (mxClient.IS_VML && (document.documentMode == null || document.documentMode < 8)) {
        // Adds padding as a workaround for box model in older IE versions
        // This needs to match the total padding of geDialog in CSS
        dx = 80;
    }

    w += dx;
    h += dx;

    var w0 = w;
    var h0 = h;

    // clientHeight check is attempted fix for print dialog offset in viewer lightbox
    var ds = mxUtils.getDocumentSize();
    var dh = ds.height;
    var left = Math.max(1, Math.round((ds.width - w - 64) / 2));
    var top = Math.max(1, Math.round((dh - h - editorUi.footerHeight) / 3));

    // Keeps window size inside available space
    if (!mxClient.IS_QUIRKS) {
        elt.style.maxHeight = '100%';
    }

    w = (document.body != null) ? Math.min(w, document.body.scrollWidth - 64) : w;
    h = Math.min(h, dh - 64);

    // Increments zIndex to put subdialogs and background over existing dialogs and background
    if (editorUi.dialogs.length > 0) {
        this.zIndex += editorUi.dialogs.length * 2;
    }

    if (this.bg == null) {
        this.bg = editorUi.createDiv('background');
        this.bg.style.position = 'absolute';
        this.bg.style.background = Dialog.backdropColor;
        this.bg.style.height = dh + 'px';
        this.bg.style.right = '0px';
        this.bg.style.zIndex = this.zIndex - 2;

        mxUtils.setOpacity(this.bg, this.bgOpacity);

        if (mxClient.IS_QUIRKS) {
            new mxDivResizer(this.bg);
        }
    }

    var origin = mxUtils.getDocumentScrollOrigin(document);
    this.bg.style.left = origin.x + 'px';
    this.bg.style.top = origin.y + 'px';
    left += origin.x;
    top += origin.y;

    if (modal) {
        document.body.appendChild(this.bg);
    }

    var div = editorUi.createDiv(transparent ? 'geTransDialog' : 'geDialog');
    var pos = this.getPosition(left, top, w, h);
    left = pos.x;
    top = pos.y;

    div.style.width = w + 'px';
    div.style.height = h + 'px';
    div.style.left = left + 'px';
    div.style.top = top + 'px';
    div.style.zIndex = this.zIndex;

    div.appendChild(elt);
    document.body.appendChild(div);

    // Adds vertical scrollbars if needed
    if (!noScroll && elt.clientHeight > div.clientHeight - 64) {
        elt.style.overflowY = 'auto';
    }

    if (closable) {
        var img = document.createElement('img');

        img.setAttribute('src', Dialog.prototype.closeImage);
        img.setAttribute('title', mxResources.get('close'));
        img.className = 'geDialogClose';
        img.style.top = (top + 14) + 'px';
        img.style.left = (left + w + 38 - dx) + 'px';
        img.style.zIndex = this.zIndex;

        mxEvent.addListener(img, 'click', mxUtils.bind(this, function () {
            editorUi.hideDialog(true);
        }));

        document.body.appendChild(img);
        this.dialogImg = img;

        if (!ignoreBgClick) {
            mxEvent.addGestureListeners(this.bg, null, null, mxUtils.bind(this, function (evt) {
                editorUi.hideDialog(true);
            }));
        }
    }

    this.resizeListener = mxUtils.bind(this, function () {
        if (onResize != null) {
            var newWH = onResize();

            if (newWH != null) {
                w0 = w = newWH.w;
                h0 = h = newWH.h;
            }
        }

        var ds = mxUtils.getDocumentSize();
        dh = ds.height;
        this.bg.style.height = dh + 'px';

        left = Math.max(1, Math.round((ds.width - w - 64) / 2));
        top = Math.max(1, Math.round((dh - h - editorUi.footerHeight) / 3));
        w = (document.body != null) ? Math.min(w0, document.body.scrollWidth - 64) : w0;
        h = Math.min(h0, dh - 64);

        var pos = this.getPosition(left, top, w, h);
        left = pos.x;
        top = pos.y;

        div.style.left = left + 'px';
        div.style.top = top + 'px';
        div.style.width = w + 'px';
        div.style.height = h + 'px';

        // Adds vertical scrollbars if needed
        if (!noScroll && elt.clientHeight > div.clientHeight - 64) {
            elt.style.overflowY = 'auto';
        }

        if (this.dialogImg != null) {
            this.dialogImg.style.top = (top + 14) + 'px';
            this.dialogImg.style.left = (left + w + 38 - dx) + 'px';
        }
    });

    mxEvent.addListener(window, 'resize', this.resizeListener);

    this.onDialogClose = onClose;
    this.container = div;

    editorUi.editor.fireEvent(new mxEventObject('showDialog'));
};

/**
 *
 */
Dialog.backdropColor = 'white';

/**
 *
 */
Dialog.prototype.zIndex = mxPopupMenu.prototype.zIndex - 1;

/**
 *
 */
Dialog.prototype.noColorImage = (!mxClient.IS_SVG) ? IMAGE_PATH + '/nocolor.png' : 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAMAAAAoLQ9TAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyBpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBXaW5kb3dzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOkEzRDlBMUUwODYxMTExRTFCMzA4RDdDMjJBMEMxRDM3IiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOkEzRDlBMUUxODYxMTExRTFCMzA4RDdDMjJBMEMxRDM3Ij4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6QTNEOUExREU4NjExMTFFMUIzMDhEN0MyMkEwQzFEMzciIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6QTNEOUExREY4NjExMTFFMUIzMDhEN0MyMkEwQzFEMzciLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz5xh3fmAAAABlBMVEX////MzMw46qqDAAAAGElEQVR42mJggAJGKGAYIIGBth8KAAIMAEUQAIElnLuQAAAAAElFTkSuQmCC';

/**
 *
 */
Dialog.prototype.closeImage = (!mxClient.IS_SVG) ? IMAGE_PATH + '/close.png' : 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAkAAAAJAQMAAADaX5RTAAAABlBMVEV7mr3///+wksspAAAAAnRSTlP/AOW3MEoAAAAdSURBVAgdY9jXwCDDwNDRwHCwgeExmASygSL7GgB12QiqNHZZIwAAAABJRU5ErkJggg==';

/**
 *
 */
Dialog.prototype.clearImage = (!mxClient.IS_SVG) ? IMAGE_PATH + '/clear.gif' : 'data:image/gif;base64,R0lGODlhDQAKAIABAMDAwP///yH/C1hNUCBEYXRhWE1QPD94cGFja2V0IGJlZ2luPSLvu78iIGlkPSJXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQiPz4gPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iQWRvYmUgWE1QIENvcmUgNS4wLWMwNjAgNjEuMTM0Nzc3LCAyMDEwLzAyLzEyLTE3OjMyOjAwICAgICAgICAiPiA8cmRmOlJERiB4bWxuczpyZGY9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkvMDIvMjItcmRmLXN5bnRheC1ucyMiPiA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IFdpbmRvd3MiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6OUIzOEM1NzI4NjEyMTFFMUEzMkNDMUE3NjZERDE2QjIiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6OUIzOEM1NzM4NjEyMTFFMUEzMkNDMUE3NjZERDE2QjIiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDo5QjM4QzU3MDg2MTIxMUUxQTMyQ0MxQTc2NkREMTZCMiIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDo5QjM4QzU3MTg2MTIxMUUxQTMyQ0MxQTc2NkREMTZCMiIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PgH//v38+/r5+Pf29fTz8vHw7+7t7Ovq6ejn5uXk4+Lh4N/e3dzb2tnY19bV1NPS0dDPzs3My8rJyMfGxcTDwsHAv769vLu6ubi3trW0s7KxsK+urayrqqmop6alpKOioaCfnp2cm5qZmJeWlZSTkpGQj46NjIuKiYiHhoWEg4KBgH9+fXx7enl4d3Z1dHNycXBvbm1sa2ppaGdmZWRjYmFgX15dXFtaWVhXVlVUU1JRUE9OTUxLSklIR0ZFRENCQUA/Pj08Ozo5ODc2NTQzMjEwLy4tLCsqKSgnJiUkIyIhIB8eHRwbGhkYFxYVFBMSERAPDg0MCwoJCAcGBQQDAgEAACH5BAEAAAEALAAAAAANAAoAAAIXTGCJebD9jEOTqRlttXdrB32PJ2ncyRQAOw==';

/**
 *
 */
Dialog.prototype.lockedImage = (!mxClient.IS_SVG) ? IMAGE_PATH + '/locked.png' : 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAwAAAAMCAMAAABhq6zVAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyJpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBNYWNpbnRvc2giIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6MzdDMDZCODExNzIxMTFFNUI0RTk5NTg4OTcyMUUyODEiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6MzdDMDZCODIxNzIxMTFFNUI0RTk5NTg4OTcyMUUyODEiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDozN0MwNkI3RjE3MjExMUU1QjRFOTk1ODg5NzIxRTI4MSIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDozN0MwNkI4MDE3MjExMUU1QjRFOTk1ODg5NzIxRTI4MSIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PvqMCFYAAAAVUExURZmZmb+/v7KysqysrMzMzLGxsf///4g8N1cAAAAHdFJOU////////wAaSwNGAAAAPElEQVR42lTMQQ4AIQgEwUa0//9kTQirOweYOgDqAMbZUr10AGlAwx4/BJ2QJ4U0L5brYjovvpv32xZgAHZaATFtMbu4AAAAAElFTkSuQmCC';

/**
 *
 */
Dialog.prototype.unlockedImage = (!mxClient.IS_SVG) ? IMAGE_PATH + '/unlocked.png' : 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAwAAAAMCAMAAABhq6zVAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyJpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBNYWNpbnRvc2giIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6MzdDMDZCN0QxNzIxMTFFNUI0RTk5NTg4OTcyMUUyODEiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6MzdDMDZCN0UxNzIxMTFFNUI0RTk5NTg4OTcyMUUyODEiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDozN0MwNkI3QjE3MjExMUU1QjRFOTk1ODg5NzIxRTI4MSIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDozN0MwNkI3QzE3MjExMUU1QjRFOTk1ODg5NzIxRTI4MSIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PkKMpVwAAAAYUExURZmZmbKysr+/v6ysrOXl5czMzLGxsf///zHN5lwAAAAIdFJOU/////////8A3oO9WQAAADxJREFUeNpUzFESACAEBNBVsfe/cZJU+8Mzs8CIABCidtfGOndnYsT40HDSiCcbPdoJo10o9aI677cpwACRoAF3dFNlswAAAABJRU5ErkJggg==';

/**
 * Removes the dialog from the DOM.
 */
Dialog.prototype.bgOpacity = 80;

/**
 * Removes the dialog from the DOM.
 */
Dialog.prototype.getPosition = function (left, top) {
    return new mxPoint(left, top);
};

/**
 * Removes the dialog from the DOM.
 */
Dialog.prototype.close = function (cancel, isEsc) {
    if (this.onDialogClose != null) {
        if (this.onDialogClose(cancel, isEsc) == false) {
            return false;
        }

        this.onDialogClose = null;
    }

    if (this.dialogImg != null) {
        this.dialogImg.parentNode.removeChild(this.dialogImg);
        this.dialogImg = null;
    }

    if (this.bg != null && this.bg.parentNode != null) {
        this.bg.parentNode.removeChild(this.bg);
    }

    mxEvent.removeListener(window, 'resize', this.resizeListener);
    this.container.parentNode.removeChild(this.container);
};

/**
 *
 */
var ErrorDialog = function (editorUi, title, message, buttonText, fn, retry, buttonText2, fn2, hide, buttonText3, fn3) {
    hide = (hide != null) ? hide : true;

    var div = document.createElement('div');
    div.style.textAlign = 'center';

    if (title != null) {
        var hd = document.createElement('div');
        hd.style.padding = '0px';
        hd.style.margin = '0px';
        hd.style.fontSize = '18px';
        hd.style.paddingBottom = '16px';
        hd.style.marginBottom = '10px';
        hd.style.borderBottom = '1px solid #c0c0c0';
        hd.style.color = 'gray';
        hd.style.whiteSpace = 'nowrap';
        hd.style.textOverflow = 'ellipsis';
        hd.style.overflow = 'hidden';
        mxUtils.write(hd, title);
        hd.setAttribute('title', title);
        div.appendChild(hd);
    }

    var p2 = document.createElement('div');
    p2.style.lineHeight = '1.2em';
    p2.style.padding = '6px';
    p2.innerHTML = message;
    div.appendChild(p2);

    var btns = document.createElement('div');
    btns.style.marginTop = '12px';
    btns.style.textAlign = 'center';

    if (retry != null) {
        var retryBtn = mxUtils.button(mxResources.get('tryAgain'), function () {
            editorUi.hideDialog();
            retry();
        });
        retryBtn.className = 'geBtn';
        btns.appendChild(retryBtn);

        btns.style.textAlign = 'center';
    }

    if (buttonText3 != null) {
        var btn3 = mxUtils.button(buttonText3, function () {
            if (fn3 != null) {
                fn3();
            }
        });

        btn3.className = 'geBtn';
        btns.appendChild(btn3);
    }

    var btn = mxUtils.button(buttonText, function () {
        if (hide) {
            editorUi.hideDialog();
        }

        if (fn != null) {
            fn();
        }
    });

    btn.className = 'geBtn';
    btns.appendChild(btn);

    if (buttonText2 != null) {
        var mainBtn = mxUtils.button(buttonText2, function () {
            if (hide) {
                editorUi.hideDialog();
            }

            if (fn2 != null) {
                fn2();
            }
        });

        mainBtn.className = 'geBtn gePrimaryBtn';
        btns.appendChild(mainBtn);
    }

    this.init = function () {
        btn.focus();
    };

    div.appendChild(btns);

    this.container = div;
};

/**
 * Constructs a new print dialog.
 */
var PrintDialog = function (editorUi, title) {
    this.create(editorUi, title);
};

/**
 * Constructs a new print dialog.
 */
PrintDialog.prototype.create = function (editorUi) {
    var graph = editorUi.editor.graph;
    var row, td;

    var table = document.createElement('table');
    table.style.width = '100%';
    table.style.height = '100%';
    var tbody = document.createElement('tbody');

    row = document.createElement('tr');

    var onePageCheckBox = document.createElement('input');
    onePageCheckBox.setAttribute('type', 'checkbox');
    td = document.createElement('td');
    td.setAttribute('colspan', '2');
    td.style.fontSize = '10pt';
    td.appendChild(onePageCheckBox);

    var span = document.createElement('span');
    mxUtils.write(span, ' ' + mxResources.get('fitPage'));
    td.appendChild(span);

    mxEvent.addListener(span, 'click', function (evt) {
        onePageCheckBox.checked = !onePageCheckBox.checked;
        pageCountCheckBox.checked = !onePageCheckBox.checked;
        mxEvent.consume(evt);
    });

    mxEvent.addListener(onePageCheckBox, 'change', function () {
        pageCountCheckBox.checked = !onePageCheckBox.checked;
    });

    row.appendChild(td);
    tbody.appendChild(row);

    row = row.cloneNode(false);

    var pageCountCheckBox = document.createElement('input');
    pageCountCheckBox.setAttribute('type', 'checkbox');
    td = document.createElement('td');
    td.style.fontSize = '10pt';
    td.appendChild(pageCountCheckBox);

    var span = document.createElement('span');
    mxUtils.write(span, ' ' + mxResources.get('posterPrint') + ':');
    td.appendChild(span);

    mxEvent.addListener(span, 'click', function (evt) {
        pageCountCheckBox.checked = !pageCountCheckBox.checked;
        onePageCheckBox.checked = !pageCountCheckBox.checked;
        mxEvent.consume(evt);
    });

    row.appendChild(td);

    var pageCountInput = document.createElement('input');
    pageCountInput.setAttribute('value', '1');
    pageCountInput.setAttribute('type', 'number');
    pageCountInput.setAttribute('min', '1');
    pageCountInput.setAttribute('size', '4');
    pageCountInput.setAttribute('disabled', 'disabled');
    pageCountInput.style.width = '50px';

    td = document.createElement('td');
    td.style.fontSize = '10pt';
    td.appendChild(pageCountInput);
    mxUtils.write(td, ' ' + mxResources.get('pages') + ' (max)');
    row.appendChild(td);
    tbody.appendChild(row);

    mxEvent.addListener(pageCountCheckBox, 'change', function () {
        if (pageCountCheckBox.checked) {
            pageCountInput.removeAttribute('disabled');
        } else {
            pageCountInput.setAttribute('disabled', 'disabled');
        }

        onePageCheckBox.checked = !pageCountCheckBox.checked;
    });

    row = row.cloneNode(false);

    td = document.createElement('td');
    mxUtils.write(td, mxResources.get('pageScale') + ':');
    row.appendChild(td);

    td = document.createElement('td');
    var pageScaleInput = document.createElement('input');
    pageScaleInput.setAttribute('value', '100 %');
    pageScaleInput.setAttribute('size', '5');
    pageScaleInput.style.width = '50px';

    td.appendChild(pageScaleInput);
    row.appendChild(td);
    tbody.appendChild(row);

    row = document.createElement('tr');
    td = document.createElement('td');
    td.colSpan = 2;
    td.style.paddingTop = '20px';
    td.setAttribute('align', 'right');

    // Overall scale for print-out to account for print borders in dialogs etc
    function preview(print) {
        var autoOrigin = onePageCheckBox.checked || pageCountCheckBox.checked;
        var printScale = parseInt(pageScaleInput.value) / 100;

        if (isNaN(printScale)) {
            printScale = 1;
            pageScaleInput.value = '100%';
        }

        // Workaround to match available paper size in actual print output
        printScale *= 0.75;

        var pf = graph.pageFormat || mxConstants.PAGE_FORMAT_A4_PORTRAIT;
        var scale = 1 / graph.pageScale;

        if (autoOrigin) {
            var pageCount = (onePageCheckBox.checked) ? 1 : parseInt(pageCountInput.value);

            if (!isNaN(pageCount)) {
                scale = mxUtils.getScaleForPageCount(pageCount, graph, pf);
            }
        }

        // Negative coordinates are cropped or shifted if page visible
        var gb = graph.getGraphBounds();
        var border = 0;
        var x0 = 0;
        var y0 = 0;

        // Applies print scale
        pf = mxRectangle.fromRectangle(pf);
        pf.width = Math.ceil(pf.width * printScale);
        pf.height = Math.ceil(pf.height * printScale);
        scale *= printScale;

        // Starts at first visible page
        if (!autoOrigin && graph.pageVisible) {
            var layout = graph.getPageLayout();
            x0 -= layout.x * pf.width;
            y0 -= layout.y * pf.height;
        } else {
            autoOrigin = true;
        }

        var preview = PrintDialog.createPrintPreview(graph, scale, pf, border, x0, y0, autoOrigin);
        preview.open();

        if (print) {
            PrintDialog.printPreview(preview);
        }
    };

    var cancelBtn = mxUtils.button(mxResources.get('cancel'), function () {
        editorUi.hideDialog();
    });
    cancelBtn.className = 'geBtn';

    if (editorUi.editor.cancelFirst) {
        td.appendChild(cancelBtn);
    }

    if (!editorUi.editor.cancelFirst) {
        td.appendChild(cancelBtn);
    }

    row.appendChild(td);
    tbody.appendChild(row);

    table.appendChild(tbody);
    this.container = table;
};

/**
 * Constructs a new print dialog.
 */
PrintDialog.printPreview = function (preview) {
    try {
        if (preview.wnd != null) {
            var printFn = function () {
                preview.wnd.focus();
                preview.wnd.print();
                preview.wnd.close();
            };

            // Workaround for Google Chrome which needs a bit of a
            // delay in order to render the SVG contents
            // Needs testing in production
            if (mxClient.IS_GC) {
                window.setTimeout(printFn, 500);
            } else {
                printFn();
            }
        }
    } catch (e) {
        // ignores possible Access Denied
    }
};

/**
 * Constructs a new print dialog.
 */
PrintDialog.createPrintPreview = function (graph, scale, pf, border, x0, y0, autoOrigin) {
    var preview = new mxPrintPreview(graph, scale, pf, border, x0, y0);
    preview.title = mxResources.get('preview');
    preview.printBackgroundImage = true;
    preview.autoOrigin = autoOrigin;
    var bg = graph.background;

    if (bg == null || bg == '' || bg == mxConstants.NONE) {
        bg = '#ffffff';
    }

    preview.backgroundColor = bg;

    var writeHead = preview.writeHead;

    // Adds a border in the preview
    preview.writeHead = function (doc) {
        writeHead.apply(this, arguments);

        doc.writeln('<style type="text/css">');
        doc.writeln('@media screen {');
        doc.writeln('  body > div { padding:30px;box-sizing:content-box; }');
        doc.writeln('}');
        doc.writeln('</style>');
    };

    return preview;
};

/**
 * Specifies if the preview button should be enabled. Default is true.
 */
PrintDialog.previewEnabled = true;

/**
 * Constructs a new page setup dialog.
 */
var PageSetupDialog = function (editorUi) {
    var graph = editorUi.editor.graph;
    var row, td;

    var table = document.createElement('table');
    table.style.width = '100%';
    table.style.height = '100%';
    var tbody = document.createElement('tbody');

    row = document.createElement('tr');

    td = document.createElement('td');
    td.style.verticalAlign = 'top';
    td.style.fontSize = '10pt';
    mxUtils.write(td, mxResources.get('paperSize') + ':');

    row.appendChild(td);

    td = document.createElement('td');
    td.style.verticalAlign = 'top';
    td.style.fontSize = '10pt';

    var accessor = PageSetupDialog.addPageFormatPanel(td, 'pagesetupdialog', graph.pageFormat);

    row.appendChild(td);
    tbody.appendChild(row);

    row = document.createElement('tr');

    td = document.createElement('td');
    mxUtils.write(td, mxResources.get('background') + ':');

    row.appendChild(td);

    td = document.createElement('td');
    td.style.whiteSpace = 'nowrap';

    var backgroundInput = document.createElement('input');
    backgroundInput.setAttribute('type', 'text');
    var backgroundButton = document.createElement('button');

    backgroundButton.style.width = '18px';
    backgroundButton.style.height = '18px';
    backgroundButton.style.marginRight = '20px';
    backgroundButton.style.backgroundPosition = 'center center';
    backgroundButton.style.backgroundRepeat = 'no-repeat';

    var newBackgroundColor = graph.background;

    function updateBackgroundColor() {
        if (newBackgroundColor == null || newBackgroundColor == mxConstants.NONE) {
            backgroundButton.style.backgroundColor = '';
            backgroundButton.style.backgroundImage = 'url(\'' + Dialog.prototype.noColorImage + '\')';
        } else {
            backgroundButton.style.backgroundColor = newBackgroundColor;
            backgroundButton.style.backgroundImage = '';
        }
    };

    updateBackgroundColor();

    mxEvent.addListener(backgroundButton, 'click', function (evt) {
        editorUi.pickColor(newBackgroundColor || 'none', function (color) {
            newBackgroundColor = color;
            updateBackgroundColor();
        });
        mxEvent.consume(evt);
    });

    td.appendChild(backgroundButton);

    mxUtils.write(td, mxResources.get('gridSize') + ':');

    var gridSizeInput = document.createElement('input');
    gridSizeInput.setAttribute('type', 'number');
    gridSizeInput.setAttribute('min', '0');
    gridSizeInput.style.width = '40px';
    gridSizeInput.style.marginLeft = '6px';

    gridSizeInput.value = graph.getGridSize();
    td.appendChild(gridSizeInput);

    mxEvent.addListener(gridSizeInput, 'change', function () {
        var value = parseInt(gridSizeInput.value);
        gridSizeInput.value = Math.max(1, (isNaN(value)) ? graph.getGridSize() : value);
    });

    row.appendChild(td);
    tbody.appendChild(row);

    row = document.createElement('tr');
    td = document.createElement('td');

    mxUtils.write(td, mxResources.get('image') + ':');

    row.appendChild(td);
    td = document.createElement('td');

    var changeImageLink = document.createElement('a');
    changeImageLink.style.textDecoration = 'underline';
    changeImageLink.style.cursor = 'pointer';
    changeImageLink.style.color = '#a0a0a0';

    var newBackgroundImage = graph.backgroundImage;

    function updateBackgroundImage() {
        if (newBackgroundImage == null) {
            changeImageLink.removeAttribute('title');
            changeImageLink.style.fontSize = '';
            changeImageLink.innerHTML = mxResources.get('change') + '...';
        } else {
            changeImageLink.setAttribute('title', newBackgroundImage.src);
            changeImageLink.style.fontSize = '11px';
            changeImageLink.innerHTML = newBackgroundImage.src.substring(0, 42) + '...';
        }
    };

    mxEvent.addListener(changeImageLink, 'click', function (evt) {
        editorUi.showBackgroundImageDialog(function (image) {
            newBackgroundImage = image;
            updateBackgroundImage();
        });

        mxEvent.consume(evt);
    });

    updateBackgroundImage();

    td.appendChild(changeImageLink);

    row.appendChild(td);
    tbody.appendChild(row);

    row = document.createElement('tr');
    td = document.createElement('td');
    td.colSpan = 2;
    td.style.paddingTop = '16px';
    td.setAttribute('align', 'right');

    var cancelBtn = mxUtils.button(mxResources.get('cancel'), function () {
        editorUi.hideDialog();
    });
    cancelBtn.className = 'geBtn';

    if (editorUi.editor.cancelFirst) {
        td.appendChild(cancelBtn);
    }

    var applyBtn = mxUtils.button(mxResources.get('apply'), function () {
        editorUi.hideDialog();

        if (graph.gridSize !== gridSizeInput.value) {
            graph.setGridSize(parseInt(gridSizeInput.value));
        }

        var change = new ChangePageSetup(editorUi, newBackgroundColor,
            newBackgroundImage, accessor.get());
        change.ignoreColor = graph.background == newBackgroundColor;

        var oldSrc = (graph.backgroundImage != null) ? graph.backgroundImage.src : null;
        var newSrc = (newBackgroundImage != null) ? newBackgroundImage.src : null;

        change.ignoreImage = oldSrc === newSrc;

        if (graph.pageFormat.width != change.previousFormat.width ||
            graph.pageFormat.height != change.previousFormat.height ||
            !change.ignoreColor || !change.ignoreImage) {
            graph.model.execute(change);
        }
    });
    applyBtn.className = 'geBtn gePrimaryBtn';
    td.appendChild(applyBtn);

    if (!editorUi.editor.cancelFirst) {
        td.appendChild(cancelBtn);
    }

    row.appendChild(td);
    tbody.appendChild(row);

    table.appendChild(tbody);
    this.container = table;
};

/**
 *
 */
PageSetupDialog.addPageFormatPanel = function (div, namePostfix, pageFormat, pageFormatListener) {
    var formatName = 'format-' + namePostfix;

    var portraitCheckBox = document.createElement('input');
    portraitCheckBox.setAttribute('name', formatName);
    portraitCheckBox.setAttribute('type', 'radio');
    portraitCheckBox.setAttribute('value', 'portrait');

    var landscapeCheckBox = document.createElement('input');
    landscapeCheckBox.setAttribute('name', formatName);
    landscapeCheckBox.setAttribute('type', 'radio');
    landscapeCheckBox.setAttribute('value', 'landscape');

    var paperSizeSelect = document.createElement('select');
    paperSizeSelect.style.marginBottom = '8px';
    paperSizeSelect.style.width = '202px';

    var formatDiv = document.createElement('div');
    formatDiv.style.marginLeft = '4px';
    formatDiv.style.width = '210px';
    formatDiv.style.height = '24px';

    portraitCheckBox.style.marginRight = '6px';
    portraitCheckBox.style.display = 'none';
    formatDiv.appendChild(portraitCheckBox);

    var portraitSpan = document.createElement('span');
    portraitSpan.style.maxWidth = '100px';
    mxUtils.write(portraitSpan, mxResources.get('portrait'));
    // formatDiv.appendChild(portraitSpan);

    landscapeCheckBox.style.marginLeft = '10px';
    landscapeCheckBox.style.marginRight = '6px';
    landscapeCheckBox.style.display = 'none';
    formatDiv.appendChild(landscapeCheckBox);

    var landscapeSpan = document.createElement('span');
    landscapeSpan.style.width = '100px';
    mxUtils.write(landscapeSpan, mxResources.get('landscape'));
    // formatDiv.appendChild(landscapeSpan)

    var customDiv = document.createElement('div');
    customDiv.style.marginLeft = '4px';
    customDiv.style.width = '210px';
    customDiv.style.height = '24px';

    var widthInput = document.createElement('input');
    widthInput.setAttribute('size', '7');
    widthInput.style.textAlign = 'right';
    customDiv.appendChild(widthInput);
    mxUtils.write(customDiv, ' in x ');

    var heightInput = document.createElement('input');
    heightInput.setAttribute('size', '7');
    heightInput.style.textAlign = 'right';
    customDiv.appendChild(heightInput);
    mxUtils.write(customDiv, ' in');

    formatDiv.style.display = 'none';
    customDiv.style.display = 'none';

    var pf = new Object();
    var formats = PageSetupDialog.getFormats();

    for (var i = 0; i < formats.length; i++) {
        var f = formats[i];
        pf[f.key] = f;

        var paperSizeOption = document.createElement('option');
        paperSizeOption.setAttribute('value', f.key);
        mxUtils.write(paperSizeOption, f.title);
        paperSizeSelect.appendChild(paperSizeOption);
    }

    var customSize = false;

    function listener(sender, evt, force) {
        if (force || (widthInput != document.activeElement && heightInput != document.activeElement)) {
            var detected = false;

            for (var i = 0; i < formats.length; i++) {
                var f = formats[i];

                // Special case where custom was chosen
                if (customSize) {
                    if (f.key == 'custom') {
                        paperSizeSelect.value = f.key;
                        customSize = false;
                    }
                } else if (f.format != null) {
                    // Fixes wrong values for previous A4 and A5 page sizes
                    if (f.key == 'a4') {
                        if (pageFormat.width == 826) {
                            pageFormat = mxRectangle.fromRectangle(pageFormat);
                            pageFormat.width = 827;
                        } else if (pageFormat.height == 826) {
                            pageFormat = mxRectangle.fromRectangle(pageFormat);
                            pageFormat.height = 827;
                        }
                    } else if (f.key == 'a5') {
                        if (pageFormat.width == 584) {
                            pageFormat = mxRectangle.fromRectangle(pageFormat);
                            pageFormat.width = 583;
                        } else if (pageFormat.height == 584) {
                            pageFormat = mxRectangle.fromRectangle(pageFormat);
                            pageFormat.height = 583;
                        }
                    }
                    if (pageFormat.width == f.format.width && pageFormat.height == f.format.height) {
                        paperSizeSelect.value = f.key;
                        portraitCheckBox.setAttribute('checked', 'checked');
                        portraitCheckBox.defaultChecked = true;
                        portraitCheckBox.checked = true;
                        landscapeCheckBox.removeAttribute('checked');
                        landscapeCheckBox.defaultChecked = false;
                        landscapeCheckBox.checked = false;
                        detected = true;
                    } else if (pageFormat.width == f.format.height && pageFormat.height == f.format.width) {
                        paperSizeSelect.value = f.key;
                        portraitCheckBox.removeAttribute('checked');
                        portraitCheckBox.defaultChecked = false;
                        portraitCheckBox.checked = false;
                        landscapeCheckBox.setAttribute('checked', 'checked');
                        landscapeCheckBox.defaultChecked = true;
                        landscapeCheckBox.checked = true;
                        detected = true;
                    }
                }
            }

            // Selects custom format which is last in list
            if (!detected) {
                widthInput.value = pageFormat.width / 100;
                heightInput.value = pageFormat.height / 100;
                portraitCheckBox.setAttribute('checked', 'checked');
                paperSizeSelect.value = 'custom';
                formatDiv.style.display = 'none';
                customDiv.style.display = '';
            } else {
                formatDiv.style.display = '';
                customDiv.style.display = 'none';
            }
        }
    };

    listener();

    div.appendChild(paperSizeSelect);
    mxUtils.br(div);

    div.appendChild(formatDiv);
    div.appendChild(customDiv);

    var currentPageFormat = pageFormat;

    var update = function (evt, selectChanged) {
        var f = pf[paperSizeSelect.value];
        if (!f) {
            paperSizeSelect.value = 'pc';
            f = pf[paperSizeSelect.value];
        }

        if (f.format != null) {
            widthInput.value = f.format.width / 100;
            heightInput.value = f.format.height / 100;
            customDiv.style.display = 'none';
            formatDiv.style.display = '';
        } else {
            formatDiv.style.display = 'none';
            customDiv.style.display = '';
        }

        var wi = parseFloat(widthInput.value);

        if (isNaN(wi) || wi <= 0) {
            widthInput.value = pageFormat.width / 100;
        }

        var hi = parseFloat(heightInput.value);

        if (isNaN(hi) || hi <= 0) {
            heightInput.value = pageFormat.height / 100;
        }

        var newPageFormat = new mxRectangle(0, 0,
            Math.floor(parseFloat(widthInput.value) * 100),
            Math.floor(parseFloat(heightInput.value) * 100));

        if (paperSizeSelect.value != 'custom' && landscapeCheckBox.checked) {
            newPageFormat = new mxRectangle(0, 0, newPageFormat.height, newPageFormat.width);
        }

        // Initial select of custom should not update page format to avoid update of combo
        if ((!selectChanged || !customSize) && (newPageFormat.width != currentPageFormat.width ||
            newPageFormat.height != currentPageFormat.height)) {
            currentPageFormat = newPageFormat;

            // Updates page format and reloads format panel
            if (pageFormatListener != null) {
                pageFormatListener(currentPageFormat);
            }
        }
    };

    mxEvent.addListener(portraitSpan, 'click', function (evt) {
        portraitCheckBox.checked = true;
        update(evt);
        mxEvent.consume(evt);
    });

    mxEvent.addListener(landscapeSpan, 'click', function (evt) {
        landscapeCheckBox.checked = true;
        update(evt);
        mxEvent.consume(evt);
    });

    mxEvent.addListener(widthInput, 'blur', update);
    mxEvent.addListener(widthInput, 'click', update);
    mxEvent.addListener(heightInput, 'blur', update);
    mxEvent.addListener(heightInput, 'click', update);
    mxEvent.addListener(landscapeCheckBox, 'change', update);
    mxEvent.addListener(portraitCheckBox, 'change', update);
    mxEvent.addListener(paperSizeSelect, 'change', function (evt) {
        // Handles special case where custom was chosen
        customSize = paperSizeSelect.value == 'custom';
        update(evt, true);
    });

    update();

    return {
        set: function (value) {
            pageFormat = value;
            listener(null, null, true);
        }, get: function () {
            return currentPageFormat;
        }, widthInput: widthInput,
        heightInput: heightInput
    };
};

/**
 *
 */
PageSetupDialog.getFormats = function () {
    return [{key: 'pc', title: '网页', format: new mxRectangle(0, 0, 1440, 1024)},
        {key: 'pad', title: '平板', format: new mxRectangle(0, 0, 768, 1024)},
        {key: 'phone', title: '手机', format: new mxRectangle(0, 0, 375, 811)}];
};

/**
 * Static overrides
 */
(function () {
    // Uses HTML for background pages (to support grid background image)
    mxGraphView.prototype.validateBackgroundPage = function () {
        var graph = this.graph;

        if (graph.container != null && !graph.transparentBackground) {
            if (graph.pageVisible) {
                var bounds = this.getBackgroundPageBounds();

                if (this.backgroundPageShape == null) {
                    // Finds first element in graph container
                    var firstChild = graph.container.firstChild;

                    while (firstChild != null && firstChild.nodeType != mxConstants.NODETYPE_ELEMENT) {
                        firstChild = firstChild.nextSibling;
                    }

                    if (firstChild != null) {
                        this.backgroundPageShape = this.createBackgroundPageShape(bounds);
                        this.backgroundPageShape.scale = 1;

                        // Shadow filter causes problems in outline window in quirks mode. IE8 standards
                        // also has known rendering issues inside mxWindow but not using shadow is worse.
                        this.backgroundPageShape.isShadow = !mxClient.IS_QUIRKS;
                        this.backgroundPageShape.dialect = mxConstants.DIALECT_STRICTHTML;
                        this.backgroundPageShape.init(graph.container);

                        // Required for the browser to render the background page in correct order
                        firstChild.style.position = 'absolute';
                        graph.container.insertBefore(this.backgroundPageShape.node, firstChild);
                        this.backgroundPageShape.redraw();

                        this.backgroundPageShape.node.className = 'geBackgroundPage';

                        // Adds listener for double click handling on background
                        mxEvent.addListener(this.backgroundPageShape.node, 'dblclick',
                            mxUtils.bind(this, function (evt) {
                                graph.dblClick(evt);
                            })
                        );

                        // Adds basic listeners for graph event dispatching outside of the
                        // container and finishing the handling of a single gesture
                        mxEvent.addGestureListeners(this.backgroundPageShape.node,
                            mxUtils.bind(this, function (evt) {
                                graph.fireMouseEvent(mxEvent.MOUSE_DOWN, new mxMouseEvent(evt));
                            }),
                            mxUtils.bind(this, function (evt) {
                                // Hides the tooltip if mouse is outside container
                                if (graph.tooltipHandler != null && graph.tooltipHandler.isHideOnHover()) {
                                    graph.tooltipHandler.hide();
                                }

                                if (graph.isMouseDown && !mxEvent.isConsumed(evt)) {
                                    graph.fireMouseEvent(mxEvent.MOUSE_MOVE, new mxMouseEvent(evt));
                                }
                            }),
                            mxUtils.bind(this, function (evt) {
                                graph.fireMouseEvent(mxEvent.MOUSE_UP, new mxMouseEvent(evt));
                            })
                        );
                    }
                } else {
                    this.backgroundPageShape.scale = 1;
                    this.backgroundPageShape.bounds = bounds;
                    this.backgroundPageShape.redraw();
                }
            } else if (this.backgroundPageShape != null) {
                this.backgroundPageShape.destroy();
                this.backgroundPageShape = null;
            }

            this.validateBackgroundStyles();
        }
    };

    // Updates the CSS of the background to draw the grid
    mxGraphView.prototype.validateBackgroundStyles = function () {
        var graph = this.graph;
        var color = (graph.background == null || graph.background == mxConstants.NONE) ? graph.defaultPageBackgroundColor : graph.background;
        var gridColor = (color != null && this.gridColor != color.toLowerCase()) ? this.gridColor : '#ffffff';
        var image = 'none';
        var position = '';

        if (graph.isGridEnabled()) {
            var phase = 10;

            if (mxClient.IS_SVG) {
                // Generates the SVG required for drawing the dynamic grid
                image = unescape(encodeURIComponent(this.createSvgGrid(gridColor)));
                image = (window.btoa) ? btoa(image) : Base64.encode(image, true);
                image = 'url(' + 'data:image/svg+xml;base64,' + image + ')'
                phase = graph.gridSize * this.scale * this.gridSteps;
            } else {
                // Fallback to grid wallpaper with fixed size
                image = 'url(' + this.gridImage + ')';
            }

            var x0 = 0;
            var y0 = 0;

            if (graph.view.backgroundPageShape != null) {
                var bds = this.getBackgroundPageBounds();

                x0 = 1 + bds.x;
                y0 = 1 + bds.y;
            }

            // Computes the offset to maintain origin for grid
            position = -Math.round(phase - mxUtils.mod(this.translate.x * this.scale - x0, phase)) + 'px ' +
                -Math.round(phase - mxUtils.mod(this.translate.y * this.scale - y0, phase)) + 'px';
        }

        var canvas = graph.view.canvas;

        if (canvas.ownerSVGElement != null) {
            canvas = canvas.ownerSVGElement;
        }

        if (graph.view.backgroundPageShape != null) {
            graph.view.backgroundPageShape.node.style.backgroundPosition = position;
            graph.view.backgroundPageShape.node.style.backgroundImage = image;
            graph.view.backgroundPageShape.node.style.backgroundColor = color;
            graph.container.className = 'geDiagramContainer geDiagramBackdrop';
            canvas.style.backgroundImage = 'none';
            canvas.style.backgroundColor = '';
        } else {
            graph.container.className = 'geDiagramContainer';
            canvas.style.backgroundPosition = position;
            canvas.style.backgroundColor = color;
            canvas.style.backgroundImage = image;
        }
    };

    // Returns the SVG required for painting the background grid.
    mxGraphView.prototype.createSvgGrid = function (color) {
        var tmp = this.graph.gridSize * this.scale;

        while (tmp < this.minGridSize) {
            tmp *= 2;
        }

        var tmp2 = this.gridSteps * tmp;

        // Small grid lines
        var d = [];

        for (var i = 1; i < this.gridSteps; i++) {
            var tmp3 = i * tmp;
            d.push('M 0 ' + tmp3 + ' L ' + tmp2 + ' ' + tmp3 + ' M ' + tmp3 + ' 0 L ' + tmp3 + ' ' + tmp2);
        }

        // KNOWN: Rounding errors for certain scales (eg. 144%, 121% in Chrome, FF and Safari). Workaround
        // in Chrome is to use 100% for the svg size, but this results in blurred grid for large diagrams.
        var size = tmp2;
        var svg = '<svg width="' + size + '" height="' + size + '" xmlns="' + mxConstants.NS_SVG + '">' +
            '<defs><pattern id="grid" width="' + tmp2 + '" height="' + tmp2 + '" patternUnits="userSpaceOnUse">' +
            '<path d="' + d.join(' ') + '" fill="none" stroke="' + color + '" opacity="0.2" stroke-width="1"/>' +
            '<path d="M ' + tmp2 + ' 0 L 0 0 0 ' + tmp2 + '" fill="none" stroke="' + color + '" stroke-width="1"/>' +
            '</pattern></defs><rect width="100%" height="100%" fill="url(#grid)"/></svg>';

        return svg;
    };

    // Adds panning for the grid with no page view and disabled scrollbars
    var mxGraphPanGraph = mxGraph.prototype.panGraph;
    mxGraph.prototype.panGraph = function (dx, dy) {
        mxGraphPanGraph.apply(this, arguments);

        if (this.shiftPreview1 != null) {
            var canvas = this.view.canvas;

            if (canvas.ownerSVGElement != null) {
                canvas = canvas.ownerSVGElement;
            }

            var phase = this.gridSize * this.view.scale * this.view.gridSteps;
            var position = -Math.round(phase - mxUtils.mod(this.view.translate.x * this.view.scale + dx, phase)) + 'px ' +
                -Math.round(phase - mxUtils.mod(this.view.translate.y * this.view.scale + dy, phase)) + 'px';
            canvas.style.backgroundPosition = position;
        }
    };

    // Draws page breaks only within the page
    mxGraph.prototype.updatePageBreaks = function (visible, width, height) {
        var scale = this.view.scale;
        var tr = this.view.translate;
        var fmt = this.pageFormat;
        var ps = scale * this.pageScale;

        var bounds2 = this.view.getBackgroundPageBounds();

        width = bounds2.width;
        height = bounds2.height;
        var bounds = new mxRectangle(scale * tr.x, scale * tr.y, fmt.width * ps, fmt.height * ps);

        // Does not show page breaks if the scale is too small
        visible = visible && Math.min(bounds.width, bounds.height) > this.minPageBreakDist;

        var horizontalCount = (visible) ? Math.ceil(height / bounds.height) - 1 : 0;
        var verticalCount = (visible) ? Math.ceil(width / bounds.width) - 1 : 0;
        var right = bounds2.x + width;
        var bottom = bounds2.y + height;

        if (this.horizontalPageBreaks == null && horizontalCount > 0) {
            this.horizontalPageBreaks = [];
        }

        if (this.verticalPageBreaks == null && verticalCount > 0) {
            this.verticalPageBreaks = [];
        }

        var drawPageBreaks = mxUtils.bind(this, function (breaks) {
            if (breaks != null) {
                var count = (breaks == this.horizontalPageBreaks) ? horizontalCount : verticalCount;

                for (var i = 0; i <= count; i++) {
                    var pts = (breaks == this.horizontalPageBreaks) ?
                        [new mxPoint(Math.round(bounds2.x), Math.round(bounds2.y + (i + 1) * bounds.height)),
                            new mxPoint(Math.round(right), Math.round(bounds2.y + (i + 1) * bounds.height))] :
                        [new mxPoint(Math.round(bounds2.x + (i + 1) * bounds.width), Math.round(bounds2.y)),
                            new mxPoint(Math.round(bounds2.x + (i + 1) * bounds.width), Math.round(bottom))];

                    if (breaks[i] != null) {
                        breaks[i].points = pts;
                        breaks[i].redraw();
                    } else {
                        var pageBreak = new mxPolyline(pts, this.pageBreakColor);
                        pageBreak.dialect = this.dialect;
                        pageBreak.isDashed = this.pageBreakDashed;
                        pageBreak.pointerEvents = false;
                        pageBreak.init(this.view.backgroundPane);
                        pageBreak.redraw();

                        breaks[i] = pageBreak;
                    }
                }

                for (var i = count; i < breaks.length; i++) {
                    breaks[i].destroy();
                }

                breaks.splice(count, breaks.length - count);
            }
        });

        drawPageBreaks(this.horizontalPageBreaks);
        drawPageBreaks(this.verticalPageBreaks);
    };

    // Disables removing relative children from parents
    var mxGraphHandlerShouldRemoveCellsFromParent = mxGraphHandler.prototype.shouldRemoveCellsFromParent;
    mxGraphHandler.prototype.shouldRemoveCellsFromParent = function (parent, cells, evt) {
        for (var i = 0; i < cells.length; i++) {
            if (this.graph.getModel().isVertex(cells[i])) {
                var geo = this.graph.getCellGeometry(cells[i]);

                if (geo != null && geo.relative) {
                    return false;
                }
            }
        }

        return mxGraphHandlerShouldRemoveCellsFromParent.apply(this, arguments);
    };

    // Overrides to ignore hotspot only for target terminal
    var mxConnectionHandlerCreateMarker = mxConnectionHandler.prototype.createMarker;
    mxConnectionHandler.prototype.createMarker = function () {
        var marker = mxConnectionHandlerCreateMarker.apply(this, arguments);

        marker.intersects = mxUtils.bind(this, function (state, evt) {
            if (this.isConnecting()) {
                return true;
            }

            return mxCellMarker.prototype.intersects.apply(marker, arguments);
        });

        return marker;
    };

    // Creates background page shape
    mxGraphView.prototype.createBackgroundPageShape = function (bounds) {
        return new mxRectangleShape(bounds, '#ffffff', this.graph.defaultPageBorderColor);
    };

    // Fits the number of background pages to the graph
    mxGraphView.prototype.getBackgroundPageBounds = function () {
        var gb = this.getGraphBounds();

        // Computes unscaled, untranslated graph bounds
        var x = (gb.width > 0) ? gb.x / this.scale - this.translate.x : 0;
        var y = (gb.height > 0) ? gb.y / this.scale - this.translate.y : 0;
        var w = gb.width / this.scale;
        var h = gb.height / this.scale;

        var fmt = this.graph.pageFormat;
        var ps = this.graph.pageScale;

        var pw = fmt.width * ps;
        var ph = fmt.height * ps;

        var x0 = Math.floor(Math.min(0, x) / pw);
        var y0 = Math.floor(Math.min(0, y) / ph);
        var xe = Math.ceil(Math.max(1, x + w) / pw);
        var ye = Math.ceil(Math.max(1, y + h) / ph);

        var rows = xe - x0;
        var cols = ye - y0;

        var bounds = new mxRectangle(this.scale * (this.translate.x + x0 * pw), this.scale *
            (this.translate.y + y0 * ph), this.scale * rows * pw, this.scale * cols * ph);

        return bounds;
    };

    // Add panning for background page in VML
    var graphPanGraph = mxGraph.prototype.panGraph;
    mxGraph.prototype.panGraph = function (dx, dy) {
        graphPanGraph.apply(this, arguments);

        if ((this.dialect != mxConstants.DIALECT_SVG && this.view.backgroundPageShape != null) &&
            (!this.useScrollbarsForPanning || !mxUtils.hasScrollbars(this.container))) {
            this.view.backgroundPageShape.node.style.marginLeft = dx + 'px';
            this.view.backgroundPageShape.node.style.marginTop = dy + 'px';
        }
    };

    /**
     * Consumes click events for disabled menu items.
     */
    var mxPopupMenuAddItem = mxPopupMenu.prototype.addItem;
    mxPopupMenu.prototype.addItem = function (title, image, funct, parent, iconCls, enabled) {
        var result = mxPopupMenuAddItem.apply(this, arguments);

        if (enabled != null && !enabled) {
            mxEvent.addListener(result, 'mousedown', function (evt) {
                mxEvent.consume(evt);
            });
        }

        return result;
    };

    // Selects ancestors before descendants
    var graphHandlerGetInitialCellForEvent = mxGraphHandler.prototype.getInitialCellForEvent;
    mxGraphHandler.prototype.getInitialCellForEvent = function (me) {
        var model = this.graph.getModel();
        var psel = model.getParent(this.graph.getSelectionCell());
        var cell = graphHandlerGetInitialCellForEvent.apply(this, arguments);
        var parent = model.getParent(cell);

        if (psel == null || (psel != cell && psel != parent)) {
            while (!this.graph.isCellSelected(cell) && !this.graph.isCellSelected(parent) &&
            model.isVertex(parent) && !this.graph.isContainer(parent)) {
                cell = parent;
                parent = this.graph.getModel().getParent(cell);
            }
        }

        return cell;
    };

    // Selection is delayed to mouseup if ancestor is selected
    var graphHandlerIsDelayedSelection = mxGraphHandler.prototype.isDelayedSelection;
    mxGraphHandler.prototype.isDelayedSelection = function (cell, me) {
        var result = graphHandlerIsDelayedSelection.apply(this, arguments);

        if (!result) {
            var model = this.graph.getModel();
            var parent = model.getParent(cell);

            while (parent != null) {
                // Inconsistency for unselected parent swimlane is intended for easier moving
                // of stack layouts where the container title section is too far away
                if (this.graph.isCellSelected(parent) && model.isVertex(parent)) {
                    result = true;
                    break;
                }

                parent = model.getParent(parent);
            }
        }

        return result;
    };

    // Delayed selection of parent group
    mxGraphHandler.prototype.selectDelayed = function (me) {
        if (!this.graph.popupMenuHandler.isPopupTrigger(me)) {
            var cell = me.getCell();

            if (cell == null) {
                cell = this.cell;
            }

            // Selects folded cell for hit on folding icon
            var state = this.graph.view.getState(cell)

            if (state != null && me.isSource(state.control)) {
                this.graph.selectCellForEvent(cell, me.getEvent());
            } else {
                var model = this.graph.getModel();
                var parent = model.getParent(cell);

                while (!this.graph.isCellSelected(parent) && model.isVertex(parent)) {
                    cell = parent;
                    parent = model.getParent(cell);
                }

                this.graph.selectCellForEvent(cell, me.getEvent());
            }
        }
    };

    // Returns last selected ancestor
    mxPopupMenuHandler.prototype.getCellForPopupEvent = function (me) {
        var cell = me.getCell();
        var model = this.graph.getModel();
        var parent = model.getParent(cell);

        while (model.isVertex(parent) && !this.graph.isContainer(parent)) {
            if (this.graph.isCellSelected(parent)) {
                cell = parent;
            }

            parent = model.getParent(parent);
        }

        return cell;
    };

})();

/**
 * Copyright (c) 2006-2012, JGraph Ltd
 */
/**
 * Constructs a new graph editor
 */
EditorUi = function (editor, container, lightbox) {
    mxEventSource.call(this);

    this.destroyFunctions = [];
    this.editor = editor || new Editor();
    this.container = container || document.body;

    var graph = this.editor.graph;
    graph.lightbox = lightbox;

    //Aric.chen .add neptune handler event
    // debugger;
    window.neptuneHandler = new NeptuneHandler(graph, this.editor);

    // Faster scrollwheel zoom is possible with CSS transforms
    if (graph.useCssTransforms) {
        this.lazyZoomDelay = 0;
    }

    // Pre-fetches submenu image or replaces with embedded image if supported
    if (mxClient.IS_SVG) {
        mxPopupMenu.prototype.submenuImage = 'data:image/gif;base64,R0lGODlhCQAJAIAAAP///zMzMyH5BAEAAAAALAAAAAAJAAkAAAIPhI8WebHsHopSOVgb26AAADs=';
    } else {
        new Image().src = mxPopupMenu.prototype.submenuImage;
    }

    // Pre-fetches connect image
    if (!mxClient.IS_SVG && mxConnectionHandler.prototype.connectImage != null) {
        new Image().src = mxConnectionHandler.prototype.connectImage.src;
    }

    // Disables graph and forced panning in chromeless mode
    if (this.editor.chromeless && !this.editor.editable) {
        this.footerHeight = 0;
        graph.isEnabled = function () {
            return false;
        };
        graph.panningHandler.isForcePanningEvent = function (me) {
            return !mxEvent.isPopupTrigger(me.getEvent());
        };
    }

    // Creates the user interface
    this.actions = new Actions(this);
    this.menus = this.createMenus();
    this.createDivs();
    this.createUi();
    this.refresh();

    // Disables HTML and text selection
    var textEditing = mxUtils.bind(this, function (evt) {
        if (evt == null) {
            evt = window.event;
        }

        return graph.isEditing() || (evt != null && this.isSelectionAllowed(evt));
    });

    // Disables text selection while not editing and no dialog visible
    if (this.container == document.body) {
        this.menubarContainer.onselectstart = textEditing;
        this.menubarContainer.onmousedown = textEditing;
        this.toolbarContainer.onselectstart = textEditing;
        this.toolbarContainer.onmousedown = textEditing;
        this.diagramContainer.onselectstart = textEditing;
        this.diagramContainer.onmousedown = textEditing;
        this.sidebarContainer.onselectstart = textEditing;
        this.sidebarContainer.onmousedown = textEditing;
        this.formatContainer.onselectstart = textEditing;
        this.formatContainer.onmousedown = textEditing;
        this.footerContainer.onselectstart = textEditing;
        this.footerContainer.onmousedown = textEditing;

        if (this.tabContainer != null) {
            // Mouse down is needed for drag and drop
            this.tabContainer.onselectstart = textEditing;
        }
    }

    // And uses built-in context menu while editing
    if (!this.editor.chromeless || this.editor.editable) {
        // Allows context menu for links in hints
        var linkHandler = function (evt) {
            if (evt != null) {
                var source = mxEvent.getSource(evt);

                if (source.nodeName == 'A') {
                    while (source != null) {
                        if (source.className == 'geHint') {
                            return true;
                        }

                        source = source.parentNode;
                    }
                }
            }

            return textEditing(evt);
        };

        if (mxClient.IS_IE && (typeof (document.documentMode) === 'undefined' || document.documentMode < 9)) {
            mxEvent.addListener(this.diagramContainer, 'contextmenu', linkHandler);
        } else {
            // Allows browser context menu outside of diagram and sidebar
            this.diagramContainer.oncontextmenu = linkHandler;
        }
    } else {
        graph.panningHandler.usePopupTrigger = false;
    }

    // Contains the main graph instance inside the given panel
    graph.init(this.diagramContainer);

    // Improves line wrapping for in-place editor
    if (mxClient.IS_SVG && graph.view.getDrawPane() != null) {
        var root = graph.view.getDrawPane().ownerSVGElement;

        if (root != null) {
            root.style.position = 'absolute';
        }
    }

    // Creates hover icons
    this.hoverIcons = this.createHoverIcons();

    // Adds tooltip when mouse is over scrollbars to show space-drag panning option
    mxEvent.addListener(this.diagramContainer, 'mousemove', mxUtils.bind(this, function (evt) {
        var off = mxUtils.getOffset(this.diagramContainer);

        if (mxEvent.getClientX(evt) - off.x - this.diagramContainer.clientWidth > 0 ||
            mxEvent.getClientY(evt) - off.y - this.diagramContainer.clientHeight > 0) {
            this.diagramContainer.setAttribute('title', mxResources.get('panTooltip'));
        } else {
            this.diagramContainer.removeAttribute('title');
        }
    }));

    // Escape key hides dialogs, adds space+drag panning
    var spaceKeyPressed = false;

    // Overrides hovericons to disable while space key is pressed
    var hoverIconsIsResetEvent = this.hoverIcons.isResetEvent;

    this.hoverIcons.isResetEvent = function (evt, allowShift) {
        return spaceKeyPressed || hoverIconsIsResetEvent.apply(this, arguments);
    };

    this.keydownHandler = mxUtils.bind(this, function (evt) {
        if (evt.which == 32 /* Space */) {
            spaceKeyPressed = true;
            this.hoverIcons.reset();
            graph.container.style.cursor = 'move';

            // Disables scroll after space keystroke with scrollbars
            if (!graph.isEditing() && mxEvent.getSource(evt) == graph.container) {
                mxEvent.consume(evt);
            }
        } else if (!mxEvent.isConsumed(evt) && evt.keyCode == 27 /* Escape */) {
            this.hideDialog(null, true);
        }
    });

    mxEvent.addListener(document, 'keydown', this.keydownHandler);

    this.keyupHandler = mxUtils.bind(this, function (evt) {
        graph.container.style.cursor = '';
        spaceKeyPressed = false;
    });

    mxEvent.addListener(document, 'keyup', this.keyupHandler);

    // Forces panning for middle and right mouse buttons
    var panningHandlerIsForcePanningEvent = graph.panningHandler.isForcePanningEvent;
    graph.panningHandler.isForcePanningEvent = function (me) {
        // Ctrl+left button is reported as right button in FF on Mac
        return panningHandlerIsForcePanningEvent.apply(this, arguments) ||
            spaceKeyPressed || (mxEvent.isMouseEvent(me.getEvent()) &&
                (this.usePopupTrigger || !mxEvent.isPopupTrigger(me.getEvent())) &&
                ((!mxEvent.isControlDown(me.getEvent()) &&
                    mxEvent.isRightMouseButton(me.getEvent())) ||
                    mxEvent.isMiddleMouseButton(me.getEvent())));
    };

    // Ctrl/Cmd+Enter applies editing value except in Safari where Ctrl+Enter creates
    // a new line (while Enter creates a new paragraph and Shift+Enter stops)
    var cellEditorIsStopEditingEvent = graph.cellEditor.isStopEditingEvent;
    graph.cellEditor.isStopEditingEvent = function (evt) {
        return cellEditorIsStopEditingEvent.apply(this, arguments) ||
            (evt.keyCode == 13 && ((!mxClient.IS_SF && mxEvent.isControlDown(evt)) ||
                (mxClient.IS_MAC && mxEvent.isMetaDown(evt)) ||
                (mxClient.IS_SF && mxEvent.isShiftDown(evt))));
    };

    // Switches toolbar for text editing
    var textMode = false;
    var fontMenu = null;
    var sizeMenu = null;
    var nodes = null;

    var updateToolbar = mxUtils.bind(this, function () {
        if (this.toolbar != null && textMode != graph.cellEditor.isContentEditing()) {
            var node = this.toolbar.container.firstChild;
            var newNodes = [];

            while (node != null) {
                var tmp = node.nextSibling;

                if (mxUtils.indexOf(this.toolbar.staticElements, node) < 0) {
                    node.parentNode.removeChild(node);
                    newNodes.push(node);
                }

                node = tmp;
            }

            // Saves references to special items
            var tmp1 = this.toolbar.fontMenu;
            var tmp2 = this.toolbar.sizeMenu;

            if (nodes == null) {
                this.toolbar.createTextToolbar();
            } else {
                for (var i = 0; i < nodes.length; i++) {
                    this.toolbar.container.appendChild(nodes[i]);
                }

                // Restores references to special items
                this.toolbar.fontMenu = fontMenu;
                this.toolbar.sizeMenu = sizeMenu;
            }

            textMode = graph.cellEditor.isContentEditing();
            fontMenu = tmp1;
            sizeMenu = tmp2;
            nodes = newNodes;
        }
    });

    var ui = this;

    // Overrides cell editor to update toolbar
    var cellEditorStartEditing = graph.cellEditor.startEditing;
    graph.cellEditor.startEditing = function () {
        cellEditorStartEditing.apply(this, arguments);
        updateToolbar();

        if (graph.cellEditor.isContentEditing()) {
            var updating = false;

            var updateCssHandler = function () {
                if (!updating) {
                    updating = true;

                    window.setTimeout(function () {
                        var selectedElement = graph.getSelectedElement();
                        var node = selectedElement;

                        while (node != null && node.nodeType != mxConstants.NODETYPE_ELEMENT) {
                            node = node.parentNode;
                        }

                        if (node != null) {
                            var css = mxUtils.getCurrentStyle(node);

                            if (css != null && ui.toolbar != null) {
                                // Strips leading and trailing quotes
                                var ff = css.fontFamily;

                                if (ff.charAt(0) == '\'') {
                                    ff = ff.substring(1);
                                }

                                if (ff.charAt(ff.length - 1) == '\'') {
                                    ff = ff.substring(0, ff.length - 1);
                                }

                                ui.toolbar.setFontName(ff);
                                ui.toolbar.setFontSize(parseInt(css.fontSize));
                            }
                        }

                        updating = false;
                    }, 0);
                }
            };

            mxEvent.addListener(graph.cellEditor.textarea, 'input', updateCssHandler)
            mxEvent.addListener(graph.cellEditor.textarea, 'touchend', updateCssHandler);
            mxEvent.addListener(graph.cellEditor.textarea, 'mouseup', updateCssHandler);
            mxEvent.addListener(graph.cellEditor.textarea, 'keyup', updateCssHandler);
            updateCssHandler();
        }
    };

    var cellEditorStopEditing = graph.cellEditor.stopEditing;
    graph.cellEditor.stopEditing = function (cell, trigger) {
        cellEditorStopEditing.apply(this, arguments);
        updateToolbar();
    };

    // Enables scrollbars and sets cursor style for the container
    graph.container.setAttribute('tabindex', '0');
    graph.container.style.cursor = 'default';

    // Workaround for page scroll if embedded via iframe
    if (window.self === window.top && graph.container.parentNode != null) {
        try {
            graph.container.focus();
        } catch (e) {
            // ignores error in old versions of IE
        }
    }

    // Keeps graph container focused on mouse down
    var graphFireMouseEvent = graph.fireMouseEvent;
    graph.fireMouseEvent = function (evtName, me, sender) {
        if (evtName == mxEvent.MOUSE_DOWN) {
            this.container.focus();
        }
        graphFireMouseEvent.apply(this, arguments);
    };

    // Configures automatic expand on mouseover
    graph.popupMenuHandler.autoExpand = true;

    // Installs context menu
    if (this.menus != null) {
        graph.popupMenuHandler.factoryMethod = mxUtils.bind(this, function (menu, cell, evt) {
            this.menus.createPopupMenu(menu, cell, evt);
        });
    }

    // Hides context menu
    mxEvent.addGestureListeners(document, mxUtils.bind(this, function (evt) {
        graph.popupMenuHandler.hideMenu();
    }));

    // Create handler for key events
    this.keyHandler = this.createKeyHandler(editor);

    // Getter for key handler
    this.getKeyHandler = function () {
        return keyHandler;
    };

    // Stores the current style and assigns it to new cells
    var styles = ['rounded', 'shadow', 'glass', 'dashed', 'dashPattern', 'comic', 'labelBackgroundColor'];
    var connectStyles = ['shape', 'edgeStyle', 'curved', 'rounded', 'elbow', 'comic', 'jumpStyle', 'jumpSize'];

    // Note: Everything that is not in styles is ignored (styles is augmented below)
    this.setDefaultStyle = function (cell) {
        try {
            var state = graph.view.getState(cell);

            if (state != null) {
                // Ignores default styles
                var clone = cell.clone();
                clone.style = ''
                var defaultStyle = graph.getCellStyle(clone);
                var values = [];
                var keys = [];

                for (var key in state.style) {
                    if (defaultStyle[key] != state.style[key]) {
                        values.push(state.style[key]);
                        keys.push(key);
                    }
                }

                // Handles special case for value "none"
                var cellStyle = graph.getModel().getStyle(state.cell);
                var tokens = (cellStyle != null) ? cellStyle.split(';') : [];

                for (var i = 0; i < tokens.length; i++) {
                    var tmp = tokens[i];
                    var pos = tmp.indexOf('=');

                    if (pos >= 0) {
                        var key = tmp.substring(0, pos);
                        var value = tmp.substring(pos + 1);

                        if (defaultStyle[key] != null && value == 'none') {
                            values.push(value);
                            keys.push(key);
                        }
                    }
                }

                // Resets current style
                if (graph.getModel().isEdge(state.cell)) {
                    graph.currentEdgeStyle = {};
                } else {
                    graph.currentVertexStyle = {}
                }

                this.fireEvent(new mxEventObject('styleChanged', 'keys', keys, 'values', values, 'cells', [state.cell]));
            }
        } catch (e) {
            this.handleError(e);
        }
    };

    this.clearDefaultStyle = function () {
        graph.currentEdgeStyle = mxUtils.clone(graph.defaultEdgeStyle);
        graph.currentVertexStyle = mxUtils.clone(graph.defaultVertexStyle);

        // Updates UI
        this.fireEvent(new mxEventObject('styleChanged', 'keys', [], 'values', [], 'cells', []));
    };

    // Keys that should be ignored if the cell has a value (known: new default for all cells is html=1 so
    // for the html key this effecticely only works for edges inserted via the connection handler)
    var valueStyles = ['fontFamily', 'fontSize', 'fontColor'];

    // Keys that always update the current edge style regardless of selection
    var alwaysEdgeStyles = ['edgeStyle', 'startArrow', 'startFill', 'startSize', 'endArrow',
        'endFill', 'endSize'];

    // Keys that are ignored together (if one appears all are ignored)
    var keyGroups = [['startArrow', 'startFill', 'startSize', 'sourcePerimeterSpacing',
        'endArrow', 'endFill', 'endSize', 'targetPerimeterSpacing'],
        ['strokeColor', 'strokeWidth'],
        ['fillColor', 'gradientColor'],
        valueStyles,
        ['opacity'],
        ['align'],
        ['html']];

    // Adds all keys used above to the styles array
    for (var i = 0; i < keyGroups.length; i++) {
        for (var j = 0; j < keyGroups[i].length; j++) {
            styles.push(keyGroups[i][j]);
        }
    }

    for (var i = 0; i < connectStyles.length; i++) {
        if (mxUtils.indexOf(styles, connectStyles[i]) < 0) {
            styles.push(connectStyles[i]);
        }
    }

    // Implements a global current style for edges and vertices that is applied to new cells
    var insertHandler = function (cells, asText) {
        var model = graph.getModel();

        model.beginUpdate();
        try {
            // Applies only basic text styles
            if (asText) {
                var edge = model.isEdge(cell);
                var current = (edge) ? graph.currentEdgeStyle : graph.currentVertexStyle;
                var textStyles = ['fontSize', 'fontFamily', 'fontColor'];

                for (var j = 0; j < textStyles.length; j++) {
                    var value = current[textStyles[j]];

                    if (value != null) {
                        graph.setCellStyles(textStyles[j], value, cells);
                    }
                }
            } else {
                for (var i = 0; i < cells.length; i++) {
                    var cell = cells[i];

                    // Removes styles defined in the cell style from the styles to be applied
                    var cellStyle = model.getStyle(cell);
                    var tokens = (cellStyle != null) ? cellStyle.split(';') : [];
                    var appliedStyles = styles.slice();

                    for (var j = 0; j < tokens.length; j++) {
                        var tmp = tokens[j];
                        var pos = tmp.indexOf('=');

                        if (pos >= 0) {
                            var key = tmp.substring(0, pos);
                            var index = mxUtils.indexOf(appliedStyles, key);

                            if (index >= 0) {
                                appliedStyles.splice(index, 1);
                            }

                            // Handles special cases where one defined style ignores other styles
                            for (var k = 0; k < keyGroups.length; k++) {
                                var group = keyGroups[k];

                                if (mxUtils.indexOf(group, key) >= 0) {
                                    for (var l = 0; l < group.length; l++) {
                                        var index2 = mxUtils.indexOf(appliedStyles, group[l]);

                                        if (index2 >= 0) {
                                            appliedStyles.splice(index2, 1);
                                        }
                                    }
                                }
                            }
                        }
                    }

                    // Applies the current style to the cell
                    var edge = model.isEdge(cell);
                    var current = (edge) ? graph.currentEdgeStyle : graph.currentVertexStyle;
                    var newStyle = model.getStyle(cell);

                    for (var j = 0; j < appliedStyles.length; j++) {
                        var key = appliedStyles[j];
                        var styleValue = current[key];

                        if (styleValue != null && (key != 'shape' || edge)) {
                            // Special case: Connect styles are not applied here but in the connection handler
                            if (!edge || mxUtils.indexOf(connectStyles, key) < 0) {
                                newStyle = mxUtils.setStyle(newStyle, key, styleValue);
                            }
                        }
                    }

                    model.setStyle(cell, newStyle);
                }
            }
        } finally {
            model.endUpdate();
        }
    };

    graph.addListener('cellsInserted', function (sender, evt) {
        insertHandler(evt.getProperty('cells'));
    });

    graph.addListener('textInserted', function (sender, evt) {
        insertHandler(evt.getProperty('cells'), true);
    });

    graph.connectionHandler.addListener(mxEvent.CONNECT, function (sender, evt) {
        var cells = [evt.getProperty('cell')];

        if (evt.getProperty('terminalInserted')) {
            cells.push(evt.getProperty('terminal'));
        }

        insertHandler(cells);
    });

    this.addListener('styleChanged', mxUtils.bind(this, function (sender, evt) {
        // Checks if edges and/or vertices were modified
        var cells = evt.getProperty('cells');
        var vertex = false;
        var edge = false;

        if (cells.length > 0) {
            for (var i = 0; i < cells.length; i++) {
                vertex = graph.getModel().isVertex(cells[i]) || vertex;
                edge = graph.getModel().isEdge(cells[i]) || edge;

                if (edge && vertex) {
                    break;
                }
            }
        } else {
            vertex = true;
            edge = true;
        }

        var keys = evt.getProperty('keys');
        var values = evt.getProperty('values');

        for (var i = 0; i < keys.length; i++) {
            var common = mxUtils.indexOf(valueStyles, keys[i]) >= 0;

            // Ignores transparent stroke colors
            if (keys[i] != 'strokeColor' || (values[i] != null && values[i] != 'none')) {
                // Special case: Edge style and shape
                if (mxUtils.indexOf(connectStyles, keys[i]) >= 0) {
                    if (edge || mxUtils.indexOf(alwaysEdgeStyles, keys[i]) >= 0) {
                        if (values[i] == null) {
                            delete graph.currentEdgeStyle[keys[i]];
                        } else {
                            graph.currentEdgeStyle[keys[i]] = values[i];
                        }
                    }
                    // Uses style for vertex if defined in styles
                    else if (vertex && mxUtils.indexOf(styles, keys[i]) >= 0) {
                        if (values[i] == null) {
                            delete graph.currentVertexStyle[keys[i]];
                        } else {
                            graph.currentVertexStyle[keys[i]] = values[i];
                        }
                    }
                } else if (mxUtils.indexOf(styles, keys[i]) >= 0) {
                    if (vertex || common) {
                        if (values[i] == null) {
                            delete graph.currentVertexStyle[keys[i]];
                        } else {
                            graph.currentVertexStyle[keys[i]] = values[i];
                        }
                    }

                    if (edge || common || mxUtils.indexOf(alwaysEdgeStyles, keys[i]) >= 0) {
                        if (values[i] == null) {
                            delete graph.currentEdgeStyle[keys[i]];
                        } else {
                            graph.currentEdgeStyle[keys[i]] = values[i];
                        }
                    }
                }
            }
        }

        if (this.toolbar != null) {
            this.toolbar.setFontName(graph.currentVertexStyle['fontFamily'] || Menus.prototype.defaultFont);
            this.toolbar.setFontSize(graph.currentVertexStyle['fontSize'] || Menus.prototype.defaultFontSize);

            if (this.toolbar.edgeStyleMenu != null) {
                // Updates toolbar icon for edge style
                var edgeStyleDiv = this.toolbar.edgeStyleMenu.getElementsByTagName('div')[0];

                if (graph.currentEdgeStyle['edgeStyle'] == 'orthogonalEdgeStyle' && graph.currentEdgeStyle['curved'] == '1') {
                    edgeStyleDiv.className = 'geSprite geSprite-curved';
                } else if (graph.currentEdgeStyle['edgeStyle'] == 'straight' || graph.currentEdgeStyle['edgeStyle'] == 'none' ||
                    graph.currentEdgeStyle['edgeStyle'] == null) {
                    edgeStyleDiv.className = 'geSprite geSprite-straight';
                } else if (graph.currentEdgeStyle['edgeStyle'] == 'entityRelationEdgeStyle') {
                    edgeStyleDiv.className = 'geSprite geSprite-entity';
                } else if (graph.currentEdgeStyle['edgeStyle'] == 'elbowEdgeStyle') {
                    edgeStyleDiv.className = 'geSprite geSprite-' + ((graph.currentEdgeStyle['elbow'] == 'vertical') ?
                        'verticalelbow' : 'horizontalelbow');
                } else if (graph.currentEdgeStyle['edgeStyle'] == 'isometricEdgeStyle') {
                    edgeStyleDiv.className = 'geSprite geSprite-' + ((graph.currentEdgeStyle['elbow'] == 'vertical') ?
                        'verticalisometric' : 'horizontalisometric');
                } else {
                    edgeStyleDiv.className = 'geSprite geSprite-orthogonal';
                }
            }

            if (this.toolbar.edgeShapeMenu != null) {
                // Updates icon for edge shape
                var edgeShapeDiv = this.toolbar.edgeShapeMenu.getElementsByTagName('div')[0];

                if (graph.currentEdgeStyle['shape'] == 'link') {
                    edgeShapeDiv.className = 'geSprite geSprite-linkedge';
                } else if (graph.currentEdgeStyle['shape'] == 'flexArrow') {
                    edgeShapeDiv.className = 'geSprite geSprite-arrow';
                } else if (graph.currentEdgeStyle['shape'] == 'arrow') {
                    edgeShapeDiv.className = 'geSprite geSprite-simplearrow';
                } else {
                    edgeShapeDiv.className = 'geSprite geSprite-connection';
                }
            }

            // Updates icon for optinal line start shape
            if (this.toolbar.lineStartMenu != null) {
                var lineStartDiv = this.toolbar.lineStartMenu.getElementsByTagName('div')[0];

                lineStartDiv.className = this.getCssClassForMarker('start',
                    graph.currentEdgeStyle['shape'], graph.currentEdgeStyle[mxConstants.STYLE_STARTARROW],
                    mxUtils.getValue(graph.currentEdgeStyle, 'startFill', '1'));
            }

            // Updates icon for optinal line end shape
            if (this.toolbar.lineEndMenu != null) {
                var lineEndDiv = this.toolbar.lineEndMenu.getElementsByTagName('div')[0];

                lineEndDiv.className = this.getCssClassForMarker('end',
                    graph.currentEdgeStyle['shape'], graph.currentEdgeStyle[mxConstants.STYLE_ENDARROW],
                    mxUtils.getValue(graph.currentEdgeStyle, 'endFill', '1'));
            }
        }
    }));

    // Update font size and font family labels
    if (this.toolbar != null) {
        var update = mxUtils.bind(this, function () {
            var ff = graph.currentVertexStyle['fontFamily'] || 'Helvetica';
            var fs = String(graph.currentVertexStyle['fontSize'] || '12');
            var state = graph.getView().getState(graph.getSelectionCell());

            if (state != null) {
                ff = state.style[mxConstants.STYLE_FONTFAMILY] || ff;
                fs = state.style[mxConstants.STYLE_FONTSIZE] || fs;

                if (ff.length > 10) {
                    ff = ff.substring(0, 8) + '...';
                }
            }

            this.toolbar.setFontName(ff);
            this.toolbar.setFontSize(fs);
        });

        graph.getSelectionModel().addListener(mxEvent.CHANGE, update);
        graph.getModel().addListener(mxEvent.CHANGE, update);
    }

    // Makes sure the current layer is visible when cells are added
    graph.addListener(mxEvent.CELLS_ADDED, function (sender, evt) {
        var cells = evt.getProperty('cells');
        var parent = evt.getProperty('parent');

        if (graph.getModel().isLayer(parent) && !graph.isCellVisible(parent) && cells != null && cells.length > 0) {
            graph.getModel().setVisible(parent, true);
        }
    });

    // Global handler to hide the current menu
    this.gestureHandler = mxUtils.bind(this, function (evt) {
        if (this.currentMenu != null && mxEvent.getSource(evt) != this.currentMenu.div) {
            this.hideCurrentMenu();
        }
    });

    mxEvent.addGestureListeners(document, this.gestureHandler);

    // Updates the editor UI after the window has been resized or the orientation changes
    // Timeout is workaround for old IE versions which have a delay for DOM client sizes.
    // Should not use delay > 0 to avoid handle multiple repaints during window resize
    this.resizeHandler = mxUtils.bind(this, function () {
        window.setTimeout(mxUtils.bind(this, function () {
            if (this.editor.graph != null) {
                this.refresh();
            }
        }), 0);
    });

    mxEvent.addListener(window, 'resize', this.resizeHandler);

    this.orientationChangeHandler = mxUtils.bind(this, function () {
        this.refresh();
    });

    mxEvent.addListener(window, 'orientationchange', this.orientationChangeHandler);

    // Workaround for bug on iOS see
    // http://stackoverflow.com/questions/19012135/ios-7-ipad-safari-landscape-innerheight-outerheight-layout-issue
    if (mxClient.IS_IOS && !window.navigator.standalone) {
        this.scrollHandler = mxUtils.bind(this, function () {
            window.scrollTo(0, 0);
        });

        mxEvent.addListener(window, 'scroll', this.scrollHandler);
    }

    /**
     * Sets the initial scrollbar locations after a file was loaded.
     */
    this.editor.addListener('resetGraphView', mxUtils.bind(this, function () {
        this.resetScrollbars();
    }));

    /**
     * Repaints the grid.
     */
    this.addListener('gridEnabledChanged', mxUtils.bind(this, function () {
        graph.view.validateBackground();
    }));

    this.addListener('backgroundColorChanged', mxUtils.bind(this, function () {
        graph.view.validateBackground();
    }));

    /**
     * Repaints the grid.
     */
    graph.addListener('gridSizeChanged', mxUtils.bind(this, function () {
        if (graph.isGridEnabled()) {
            graph.view.validateBackground();
        }
    }));

    // Resets UI, updates action and menu states
    this.editor.resetGraph();
    this.init();
    this.open();
};

// Extends mxEventSource
mxUtils.extend(EditorUi, mxEventSource);

/**
 * Global config that specifies if the compact UI elements should be used.
 */
EditorUi.compactUi = true;

/**
 * Specifies the size of the split bar.
 */
EditorUi.prototype.splitSize = (mxClient.IS_TOUCH || mxClient.IS_POINTER) ? 12 : 8;

/**
 * Specifies the height of the menubar. Default is 34.
 */
EditorUi.prototype.menubarHeight = 30;

/**
 * Specifies the width of the format panel should be enabled. Default is true.
 */
EditorUi.prototype.formatEnabled = true;

/**
 * Specifies the width of the format panel. Default is 240.
 */
EditorUi.prototype.formatWidth = 240;

/**
 * Specifies the height of the toolbar. Default is 40.
 */
EditorUi.prototype.toolbarHeight = 40;

/**
 * Specifies the height of the footer. Default is 28.
 */
EditorUi.prototype.footerHeight = 28;

/**
 * Specifies the height of the optional sidebarFooterContainer. Default is 34.
 */
EditorUi.prototype.sidebarFooterHeight = 34;

/**
 * Specifies the position of the horizontal split bar. Default is 240 or 118 for
 * screen widths <= 640px.
 */
EditorUi.prototype.hsplitPosition = (screen.width <= 640) ? 118 : ((urlParams['sidebar-entries'] != 'large') ? 212 : 240);

/**
 * Specifies if animations are allowed in <executeLayout>. Default is true.
 */
EditorUi.prototype.allowAnimation = true;

/**
 * Specifies if animations are allowed in <executeLayout>. Default is true.
 */
EditorUi.prototype.lightboxMaxFitScale = 2;

/**
 * Specifies if animations are allowed in <executeLayout>. Default is true.
 */
EditorUi.prototype.lightboxVerticalDivider = 4;

/**
 * Specifies if single click on horizontal split should collapse sidebar. Default is false.
 */
EditorUi.prototype.hsplitClickEnabled = false;

/**
 * Installs the listeners to update the action states.
 */
EditorUi.prototype.init = function () {
    /**
     * Keypress starts immediate editing on selection cell
     */
    var graph = this.editor.graph;

    mxEvent.addListener(graph.container, 'keydown', mxUtils.bind(this, function (evt) {
        this.onKeyDown(evt);
    }));
    mxEvent.addListener(graph.container, 'keypress', mxUtils.bind(this, function (evt) {
        this.onKeyPress(evt);
    }));

    // Updates action states
    this.addUndoListener();
    this.addBeforeUnloadListener();

    graph.getSelectionModel().addListener(mxEvent.CHANGE, mxUtils.bind(this, function () {
        this.updateActionStates();
    }));

    graph.getModel().addListener(mxEvent.CHANGE, mxUtils.bind(this, function () {
        this.updateActionStates();
    }));

    // Changes action states after change of default parent
    var graphSetDefaultParent = graph.setDefaultParent;
    var ui = this;

    this.editor.graph.setDefaultParent = function () {
        graphSetDefaultParent.apply(this, arguments);
        ui.updateActionStates();
    };

    // Hack to make editLink available in vertex handler
    graph.editLink = ui.actions.get('editLink').funct;

    this.updateActionStates();
    this.initClipboard();
    this.initCanvas();

    if (this.format != null) {
        this.format.init();
    }
};

/**
 * Returns true if the given event should start editing. This implementation returns true.
 */
EditorUi.prototype.onKeyDown = function (evt) {
    var graph = this.editor.graph;

    // Tab selects next cell
    if (evt.which == 9 && graph.isEnabled() && !mxEvent.isAltDown(evt)) {
        if (graph.isEditing()) {
            graph.stopEditing(false);
        } else {
            graph.selectCell(!mxEvent.isShiftDown(evt));
        }

        mxEvent.consume(evt);
    }
};

/**
 * Returns true if the given event should start editing. This implementation returns true.
 */
EditorUi.prototype.onKeyPress = function (evt) {
    var graph = this.editor.graph;

    // KNOWN: Focus does not work if label is empty in quirks mode
    if (this.isImmediateEditingEvent(evt) && !graph.isEditing() && !graph.isSelectionEmpty() && evt.which !== 0 &&
        !mxEvent.isAltDown(evt) && !mxEvent.isControlDown(evt) && !mxEvent.isMetaDown(evt)) {
        graph.escape();
        graph.startEditing();

        // Workaround for FF where char is lost if cursor is placed before char
        if (mxClient.IS_FF) {
            var ce = graph.cellEditor;
            ce.textarea.innerHTML = String.fromCharCode(evt.which);

            // Moves cursor to end of textarea
            var range = document.createRange();
            range.selectNodeContents(ce.textarea);
            range.collapse(false);
            var sel = window.getSelection();
            sel.removeAllRanges();
            sel.addRange(range);
        }
    }
};

/**
 * Returns true if the given event should start editing. This implementation returns true.
 */
EditorUi.prototype.isImmediateEditingEvent = function (evt) {
    return true;
};

/**
 * Private helper method.
 */
EditorUi.prototype.getCssClassForMarker = function (prefix, shape, marker, fill) {
    var result = '';

    if (shape == 'flexArrow') {
        result = (marker != null && marker != mxConstants.NONE) ?
            'geSprite geSprite-' + prefix + 'blocktrans' : 'geSprite geSprite-noarrow';
    } else {
        if (marker == mxConstants.ARROW_CLASSIC) {
            result = (fill == '1') ? 'geSprite geSprite-' + prefix + 'classic' : 'geSprite geSprite-' + prefix + 'classictrans';
        } else if (marker == mxConstants.ARROW_CLASSIC_THIN) {
            result = (fill == '1') ? 'geSprite geSprite-' + prefix + 'classicthin' : 'geSprite geSprite-' + prefix + 'classicthintrans';
        } else if (marker == mxConstants.ARROW_OPEN) {
            result = 'geSprite geSprite-' + prefix + 'open';
        } else if (marker == mxConstants.ARROW_OPEN_THIN) {
            result = 'geSprite geSprite-' + prefix + 'openthin';
        } else if (marker == mxConstants.ARROW_BLOCK) {
            result = (fill == '1') ? 'geSprite geSprite-' + prefix + 'block' : 'geSprite geSprite-' + prefix + 'blocktrans';
        } else if (marker == mxConstants.ARROW_BLOCK_THIN) {
            result = (fill == '1') ? 'geSprite geSprite-' + prefix + 'blockthin' : 'geSprite geSprite-' + prefix + 'blockthintrans';
        } else if (marker == mxConstants.ARROW_OVAL) {
            result = (fill == '1') ? 'geSprite geSprite-' + prefix + 'oval' : 'geSprite geSprite-' + prefix + 'ovaltrans';
        } else if (marker == mxConstants.ARROW_DIAMOND) {
            result = (fill == '1') ? 'geSprite geSprite-' + prefix + 'diamond' : 'geSprite geSprite-' + prefix + 'diamondtrans';
        } else if (marker == mxConstants.ARROW_DIAMOND_THIN) {
            result = (fill == '1') ? 'geSprite geSprite-' + prefix + 'thindiamond' : 'geSprite geSprite-' + prefix + 'thindiamondtrans';
        } else if (marker == 'openAsync') {
            result = 'geSprite geSprite-' + prefix + 'openasync';
        } else if (marker == 'dash') {
            result = 'geSprite geSprite-' + prefix + 'dash';
        } else if (marker == 'cross') {
            result = 'geSprite geSprite-' + prefix + 'cross';
        } else if (marker == 'async') {
            result = (fill == '1') ? 'geSprite geSprite-' + prefix + 'async' : 'geSprite geSprite-' + prefix + 'asynctrans';
        } else if (marker == 'circle' || marker == 'circlePlus') {
            result = (fill == '1' || marker == 'circle') ? 'geSprite geSprite-' + prefix + 'circle' : 'geSprite geSprite-' + prefix + 'circleplus';
        } else if (marker == 'ERone') {
            result = 'geSprite geSprite-' + prefix + 'erone';
        } else if (marker == 'ERmandOne') {
            result = 'geSprite geSprite-' + prefix + 'eronetoone';
        } else if (marker == 'ERmany') {
            result = 'geSprite geSprite-' + prefix + 'ermany';
        } else if (marker == 'ERoneToMany') {
            result = 'geSprite geSprite-' + prefix + 'eronetomany';
        } else if (marker == 'ERzeroToOne') {
            result = 'geSprite geSprite-' + prefix + 'eroneopt';
        } else if (marker == 'ERzeroToMany') {
            result = 'geSprite geSprite-' + prefix + 'ermanyopt';
        } else {
            result = 'geSprite geSprite-noarrow';
        }
    }

    return result;
};

/**
 * Overridden in Menus.js
 */
EditorUi.prototype.createMenus = function () {
    return null;
};

/**
 * Hook for allowing selection and context menu for certain events.
 */
EditorUi.prototype.updatePasteActionStates = function () {
    var graph = this.editor.graph;
    var paste = this.actions.get('paste');
    var pasteHere = this.actions.get('pasteHere');

    paste.setEnabled(this.editor.graph.cellEditor.isContentEditing() || (!mxClipboard.isEmpty() &&
        graph.isEnabled() && !graph.isCellLocked(graph.getDefaultParent())));
    pasteHere.setEnabled(paste.isEnabled());
};

/**
 * Hook for allowing selection and context menu for certain events.
 */
EditorUi.prototype.initClipboard = function () {
    var ui = this;

    var mxClipboardCut = mxClipboard.cut;
    mxClipboard.cut = function (graph) {
        if (graph.cellEditor.isContentEditing()) {
            document.execCommand('cut', false, null);
        } else {
            mxClipboardCut.apply(this, arguments);
        }

        ui.updatePasteActionStates();
    };

    var mxClipboardCopy = mxClipboard.copy;
    mxClipboard.copy = function (graph) {
        if (graph.cellEditor.isContentEditing()) {
            document.execCommand('copy', false, null);
        } else {
            mxClipboardCopy.apply(this, arguments);
        }

        ui.updatePasteActionStates();
    };

    var mxClipboardPaste = mxClipboard.paste;
    mxClipboard.paste = function (graph) {
        var result = null;

        if (graph.cellEditor.isContentEditing()) {
            document.execCommand('paste', false, null);
        } else {
            result = mxClipboardPaste.apply(this, arguments);
        }

        ui.updatePasteActionStates();

        return result;
    };

    // Overrides cell editor to update paste action state
    var cellEditorStartEditing = this.editor.graph.cellEditor.startEditing;

    this.editor.graph.cellEditor.startEditing = function () {
        cellEditorStartEditing.apply(this, arguments);
        ui.updatePasteActionStates();
    };

    var cellEditorStopEditing = this.editor.graph.cellEditor.stopEditing;

    this.editor.graph.cellEditor.stopEditing = function (cell, trigger) {
        cellEditorStopEditing.apply(this, arguments);
        ui.updatePasteActionStates();
    };

    this.updatePasteActionStates();
};

/**
 * Initializes the infinite canvas.
 */
EditorUi.prototype.lazyZoomDelay = 20;

/**
 * Initializes the infinite canvas.
 */
EditorUi.prototype.initCanvas = function () {
    // Initial page layout view, scrollBuffer and timer-based scrolling
    var graph = this.editor.graph;
    graph.timerAutoScroll = true;

    /**
     * Returns the padding for pages in page view with scrollbars.
     */
    graph.getPagePadding = function () {
        return new mxPoint(Math.max(0, Math.round((graph.container.offsetWidth - 34) / graph.view.scale)),
            Math.max(0, Math.round((graph.container.offsetHeight - 34) / graph.view.scale)));
    };

    // Fits the number of background pages to the graph
    graph.view.getBackgroundPageBounds = function () {
        var layout = this.graph.getPageLayout();
        var page = this.graph.getPageSize();

        return new mxRectangle(this.scale * (this.translate.x + layout.x * page.width),
            this.scale * (this.translate.y + layout.y * page.height),
            this.scale * layout.width * page.width,
            this.scale * layout.height * page.height);
    };

    graph.getPreferredPageSize = function (bounds, width, height) {
        var pages = this.getPageLayout();
        var size = this.getPageSize();

        return new mxRectangle(0, 0, pages.width * size.width, pages.height * size.height);
    };

    // Scales pages/graph to fit available size
    var resize = null;
    var ui = this;

    if (this.editor.isChromelessView()) {
        resize = mxUtils.bind(this, function (autoscale, maxScale, cx, cy) {
            if (graph.container != null) {
                cx = (cx != null) ? cx : 0;
                cy = (cy != null) ? cy : 0;

                var bds = (graph.pageVisible) ? graph.view.getBackgroundPageBounds() : graph.getGraphBounds();
                var scroll = mxUtils.hasScrollbars(graph.container);
                var tr = graph.view.translate;
                var s = graph.view.scale;

                // Normalizes the bounds
                var b = mxRectangle.fromRectangle(bds);
                b.x = b.x / s - tr.x;
                b.y = b.y / s - tr.y;
                b.width /= s;
                b.height /= s;

                var st = graph.container.scrollTop;
                var sl = graph.container.scrollLeft;
                var sb = (mxClient.IS_QUIRKS || document.documentMode >= 8) ? 20 : 14;

                if (document.documentMode == 8 || document.documentMode == 9) {
                    sb += 3;
                }

                var cw = graph.container.offsetWidth - sb;
                var ch = graph.container.offsetHeight - sb;

                var ns = (autoscale) ? Math.max(0.3, Math.min(maxScale || 1, cw / b.width)) : s;
                var dx = ((cw - ns * b.width) / 2) / ns;
                var dy = (this.lightboxVerticalDivider == 0) ? 0 : ((ch - ns * b.height) / this.lightboxVerticalDivider) / ns;

                if (scroll) {
                    dx = Math.max(dx, 0);
                    dy = Math.max(dy, 0);
                }

                if (scroll || bds.width < cw || bds.height < ch) {
                    graph.view.scaleAndTranslate(ns, Math.floor(dx - b.x), Math.floor(dy - b.y));
                    graph.container.scrollTop = st * ns / s;
                    graph.container.scrollLeft = sl * ns / s;
                } else if (cx != 0 || cy != 0) {
                    var t = graph.view.translate;
                    graph.view.setTranslate(Math.floor(t.x + cx / s), Math.floor(t.y + cy / s));
                }
            }
        });

        // Hack to make function available to subclassers
        this.chromelessResize = resize;

        // Hook for subclassers for override
        this.chromelessWindowResize = mxUtils.bind(this, function () {
            this.chromelessResize(false);
        });

        // Removable resize listener
        var autoscaleResize = mxUtils.bind(this, function () {
            this.chromelessWindowResize(false);
        });

        mxEvent.addListener(window, 'resize', autoscaleResize);

        this.destroyFunctions.push(function () {
            mxEvent.removeListener(window, 'resize', autoscaleResize);
        });

        this.editor.addListener('resetGraphView', mxUtils.bind(this, function () {
            this.chromelessResize(true);
        }));

        this.actions.get('zoomIn').funct = mxUtils.bind(this, function (evt) {
            graph.zoomIn();
            this.chromelessResize(false);
        });
        this.actions.get('zoomOut').funct = mxUtils.bind(this, function (evt) {
            graph.zoomOut();
            this.chromelessResize(false);
        });

        // Creates toolbar for viewer - do not use CSS here
        // as this may be used in a viewer that has no CSS
        if (urlParams['toolbar'] != '0') {
            var toolbarConfig = JSON.parse(decodeURIComponent(urlParams['toolbar-config'] || '{}'));

            this.chromelessToolbar = document.createElement('div');
            this.chromelessToolbar.style.position = 'fixed';
            this.chromelessToolbar.style.overflow = 'hidden';
            this.chromelessToolbar.style.boxSizing = 'border-box';
            this.chromelessToolbar.style.whiteSpace = 'nowrap';
            this.chromelessToolbar.style.backgroundColor = '#000000';
            this.chromelessToolbar.style.padding = '10px 10px 8px 10px';
            this.chromelessToolbar.style.left = '50%';

            if (!mxClient.IS_VML) {
                mxUtils.setPrefixedStyle(this.chromelessToolbar.style, 'borderRadius', '20px');
                mxUtils.setPrefixedStyle(this.chromelessToolbar.style, 'transition', 'opacity 600ms ease-in-out');
            }

            var updateChromelessToolbarPosition = mxUtils.bind(this, function () {
                var css = mxUtils.getCurrentStyle(graph.container);
                this.chromelessToolbar.style.bottom = ((css != null) ? parseInt(css['margin-bottom'] || 0) : 0) +
                    ((this.tabContainer != null) ? (20 + parseInt(this.tabContainer.style.height)) : 20) + 'px';
            });

            this.editor.addListener('resetGraphView', updateChromelessToolbarPosition);
            updateChromelessToolbarPosition();

            var btnCount = 0;

            var addButton = mxUtils.bind(this, function (fn, imgSrc, tip) {
                btnCount++;

                var a = document.createElement('span');
                a.style.paddingLeft = '8px';
                a.style.paddingRight = '8px';
                a.style.cursor = 'pointer';
                mxEvent.addListener(a, 'click', fn);

                if (tip != null) {
                    a.setAttribute('title', tip);
                }

                var img = document.createElement('img');
                img.setAttribute('border', '0');
                img.setAttribute('src', imgSrc);

                a.appendChild(img);
                this.chromelessToolbar.appendChild(a);

                return a;
            });

            if (toolbarConfig.backBtn != null) {
                addButton(mxUtils.bind(this, function (evt) {
                    window.location.href = toolbarConfig.backBtn.url;
                    mxEvent.consume(evt);
                }), Editor.backLargeImage, mxResources.get('back', null, 'Back'));
            }

            var prevButton = addButton(mxUtils.bind(this, function (evt) {
                this.actions.get('previousPage').funct();
                mxEvent.consume(evt);
            }), Editor.previousLargeImage, mxResources.get('previousPage'));

            var pageInfo = document.createElement('div');
            pageInfo.style.display = 'inline-block';
            pageInfo.style.verticalAlign = 'top';
            pageInfo.style.fontFamily = 'Helvetica,Arial';
            pageInfo.style.marginTop = '8px';
            pageInfo.style.fontSize = '14px';
            pageInfo.style.color = '#ffffff';
            this.chromelessToolbar.appendChild(pageInfo);

            var nextButton = addButton(mxUtils.bind(this, function (evt) {
                this.actions.get('nextPage').funct();
                mxEvent.consume(evt);
            }), Editor.nextLargeImage, mxResources.get('nextPage'));

            var updatePageInfo = mxUtils.bind(this, function () {
                if (this.pages != null && this.pages.length > 1 && this.currentPage != null) {
                    pageInfo.innerHTML = '';
                    mxUtils.write(pageInfo, (mxUtils.indexOf(this.pages, this.currentPage) + 1) + ' / ' + this.pages.length);
                }
            });

            prevButton.style.paddingLeft = '0px';
            prevButton.style.paddingRight = '4px';
            nextButton.style.paddingLeft = '4px';
            nextButton.style.paddingRight = '0px';

            var updatePageButtons = mxUtils.bind(this, function () {
                if (this.pages != null && this.pages.length > 1 && this.currentPage != null) {
                    nextButton.style.display = '';
                    prevButton.style.display = '';
                    pageInfo.style.display = 'inline-block';
                } else {
                    nextButton.style.display = 'none';
                    prevButton.style.display = 'none';
                    pageInfo.style.display = 'none';
                }

                updatePageInfo();
            });

            this.editor.addListener('resetGraphView', updatePageButtons);
            this.editor.addListener('pageSelected', updatePageInfo);

            addButton(mxUtils.bind(this, function (evt) {
                this.actions.get('zoomOut').funct();
                mxEvent.consume(evt);
            }), Editor.zoomOutLargeImage, mxResources.get('zoomOut') + ' (Alt+Mousewheel)');

            addButton(mxUtils.bind(this, function (evt) {
                this.actions.get('zoomIn').funct();
                mxEvent.consume(evt);
            }), Editor.zoomInLargeImage, mxResources.get('zoomIn') + ' (Alt+Mousewheel)');

            addButton(mxUtils.bind(this, function (evt) {
                if (graph.isLightboxView()) {
                    if (graph.view.scale == 1) {
                        this.lightboxFit();
                    } else {
                        graph.zoomTo(1);
                    }

                    this.chromelessResize(false);
                } else {
                    this.chromelessResize(true);
                }

                mxEvent.consume(evt);
            }), Editor.actualSizeLargeImage, mxResources.get('fit'));

            // Changes toolbar opacity on hover
            var fadeThread = null;
            var fadeThread2 = null;

            var fadeOut = mxUtils.bind(this, function (delay) {
                if (fadeThread != null) {
                    window.clearTimeout(fadeThread);
                    fadeThead = null;
                }

                if (fadeThread2 != null) {
                    window.clearTimeout(fadeThread2);
                    fadeThead2 = null;
                }

                fadeThread = window.setTimeout(mxUtils.bind(this, function () {
                    mxUtils.setOpacity(this.chromelessToolbar, 0);
                    fadeThread = null;

                    fadeThread2 = window.setTimeout(mxUtils.bind(this, function () {
                        this.chromelessToolbar.style.display = 'none';
                        fadeThread2 = null;
                    }), 600);
                }), delay || 200);
            });

            var fadeIn = mxUtils.bind(this, function (opacity) {
                if (fadeThread != null) {
                    window.clearTimeout(fadeThread);
                    fadeThead = null;
                }

                if (fadeThread2 != null) {
                    window.clearTimeout(fadeThread2);
                    fadeThead2 = null;
                }

                this.chromelessToolbar.style.display = '';
                mxUtils.setOpacity(this.chromelessToolbar, opacity || 30);
            });

            if (urlParams['layers'] == '1') {
                this.layersDialog = null;

                var layersButton = addButton(mxUtils.bind(this, function (evt) {
                    if (this.layersDialog != null) {
                        this.layersDialog.parentNode.removeChild(this.layersDialog);
                        this.layersDialog = null;
                    } else {
                        this.layersDialog = graph.createLayersDialog();

                        mxEvent.addListener(this.layersDialog, 'mouseleave', mxUtils.bind(this, function () {
                            this.layersDialog.parentNode.removeChild(this.layersDialog);
                            this.layersDialog = null;
                        }));

                        var r = layersButton.getBoundingClientRect();

                        mxUtils.setPrefixedStyle(this.layersDialog.style, 'borderRadius', '5px');
                        this.layersDialog.style.position = 'fixed';
                        this.layersDialog.style.fontFamily = 'Helvetica,Arial';
                        this.layersDialog.style.backgroundColor = '#000000';
                        this.layersDialog.style.width = '160px';
                        this.layersDialog.style.padding = '4px 2px 4px 2px';
                        this.layersDialog.style.color = '#ffffff';
                        mxUtils.setOpacity(this.layersDialog, 70);
                        this.layersDialog.style.left = r.left + 'px';
                        this.layersDialog.style.bottom = parseInt(this.chromelessToolbar.style.bottom) +
                            this.chromelessToolbar.offsetHeight + 4 + 'px';

                        // Puts the dialog on top of the container z-index
                        var style = mxUtils.getCurrentStyle(this.editor.graph.container);
                        this.layersDialog.style.zIndex = style.zIndex;

                        document.body.appendChild(this.layersDialog);
                    }

                    mxEvent.consume(evt);
                }), Editor.layersLargeImage, mxResources.get('layers'));

                // Shows/hides layers button depending on content
                var model = graph.getModel();

                model.addListener(mxEvent.CHANGE, function () {
                    layersButton.style.display = (model.getChildCount(model.root) > 1) ? '' : 'none';
                });
            }
            // this.addChromelessToolbarItems(addButton);

            if (this.editor.editButtonLink != null || this.editor.editButtonFunc != null) {
                addButton(mxUtils.bind(this, function (evt) {
                    if (this.editor.editButtonFunc != null) {
                        this.editor.editButtonFunc();
                    } else if (this.editor.editButtonLink == '_blank') {
                        this.editor.editAsNew(this.getEditBlankXml());
                    } else {
                        graph.openLink(this.editor.editButtonLink, 'editWindow');
                    }

                    mxEvent.consume(evt);
                }), Editor.editLargeImage, mxResources.get('edit'));
            }

            if (this.lightboxToolbarActions != null) {
                for (var i = 0; i < this.lightboxToolbarActions.length; i++) {
                    var lbAction = this.lightboxToolbarActions[i];
                    addButton(lbAction.fn, lbAction.icon, lbAction.tooltip);
                }
            }

            if (toolbarConfig.refreshBtn != null) {
                addButton(mxUtils.bind(this, function (evt) {
                    if (toolbarConfig.refreshBtn.url) {
                        window.location.href = toolbarConfig.refreshBtn.url;
                    } else {
                        window.location.reload();
                    }

                    mxEvent.consume(evt);
                }), Editor.refreshLargeImage, mxResources.get('refresh', null, 'Refresh'));
            }

            if (toolbarConfig.fullscreenBtn != null && window.self !== window.top) {
                addButton(mxUtils.bind(this, function (evt) {
                    if (toolbarConfig.fullscreenBtn.url) {
                        graph.openLink(toolbarConfig.fullscreenBtn.url);
                    } else {
                        graph.openLink(window.location.href);
                    }

                    mxEvent.consume(evt);
                }), Editor.fullscreenLargeImage, mxResources.get('openInNewWindow', null, 'Open in New Window'));
            }

            if ((toolbarConfig.closeBtn && window.self === window.top) ||
                (graph.lightbox && (urlParams['close'] == '1' || this.container != document.body))) {
                addButton(mxUtils.bind(this, function (evt) {
                    if (urlParams['close'] == '1' || toolbarConfig.closeBtn) {
                        window.close();
                    } else {
                        this.destroy();
                        mxEvent.consume(evt);
                    }
                }), Editor.closeLargeImage, mxResources.get('close') + ' (Escape)');
            }

            // Initial state invisible
            this.chromelessToolbar.style.display = 'none';
            mxUtils.setPrefixedStyle(this.chromelessToolbar.style, 'transform', 'translate(-50%,0)');
            graph.container.appendChild(this.chromelessToolbar);

            mxEvent.addListener(graph.container, (mxClient.IS_POINTER) ? 'pointermove' : 'mousemove', mxUtils.bind(this, function (evt) {
                if (!mxEvent.isTouchEvent(evt)) {
                    if (!mxEvent.isShiftDown(evt)) {
                        fadeIn(30);
                    }

                    fadeOut();
                }
            }));

            mxEvent.addListener(this.chromelessToolbar, (mxClient.IS_POINTER) ? 'pointermove' : 'mousemove', function (evt) {
                mxEvent.consume(evt);
            });

            mxEvent.addListener(this.chromelessToolbar, 'mouseenter', mxUtils.bind(this, function (evt) {
                if (!mxEvent.isShiftDown(evt)) {
                    fadeIn(100);
                } else {
                    fadeOut();
                }
            }));

            mxEvent.addListener(this.chromelessToolbar, 'mousemove', mxUtils.bind(this, function (evt) {
                if (!mxEvent.isShiftDown(evt)) {
                    fadeIn(100);
                } else {
                    fadeOut();
                }

                mxEvent.consume(evt);
            }));

            mxEvent.addListener(this.chromelessToolbar, 'mouseleave', mxUtils.bind(this, function (evt) {
                if (!mxEvent.isTouchEvent(evt)) {
                    fadeIn(30);
                }
            }));

            // Shows/hides toolbar for touch devices
            var tol = graph.getTolerance();

            graph.addMouseListener(
                {
                    startX: 0,
                    startY: 0,
                    scrollLeft: 0,
                    scrollTop: 0,
                    mouseDown: function (sender, me) {
                        this.startX = me.getGraphX();
                        this.startY = me.getGraphY();
                        this.scrollLeft = graph.container.scrollLeft;
                        this.scrollTop = graph.container.scrollTop;
                    },
                    mouseMove: function (sender, me) {
                    },
                    mouseUp: function (sender, me) {
                        if (mxEvent.isTouchEvent(me.getEvent())) {
                            if ((Math.abs(this.scrollLeft - graph.container.scrollLeft) < tol &&
                                Math.abs(this.scrollTop - graph.container.scrollTop) < tol) &&
                                (Math.abs(this.startX - me.getGraphX()) < tol &&
                                    Math.abs(this.startY - me.getGraphY()) < tol)) {
                                if (parseFloat(ui.chromelessToolbar.style.opacity || 0) > 0) {
                                    fadeOut();
                                } else {
                                    fadeIn(30);
                                }
                            }
                        }
                    }
                });
        } // end if toolbar

        // Installs handling of highlight and handling links to relative links and anchors
        if (!this.editor.editable) {
            this.addChromelessClickHandler();
        }
    } else if (this.editor.extendCanvas) {
        /**
         * Guesses autoTranslate to avoid another repaint (see below).
         * Works if only the scale of the graph changes or if pages
         * are visible and the visible pages do not change.
         */
        var graphViewValidate = graph.view.validate;
        graph.view.validate = function () {
            if (this.graph.container != null && mxUtils.hasScrollbars(this.graph.container)) {
                var pad = this.graph.getPagePadding();
                var size = this.graph.getPageSize();

                // Updating scrollbars here causes flickering in quirks and is not needed
                // if zoom method is always used to set the current scale on the graph.
                var tx = this.translate.x;
                var ty = this.translate.y;
                this.translate.x = pad.x - (this.x0 || 0) * size.width;
                this.translate.y = pad.y - (this.y0 || 0) * size.height;
            }

            graphViewValidate.apply(this, arguments);
        };

        var graphSizeDidChange = graph.sizeDidChange;
        graph.sizeDidChange = function () {
            if (this.container != null && mxUtils.hasScrollbars(this.container)) {
                var pages = this.getPageLayout();
                var pad = this.getPagePadding();
                var size = this.getPageSize();

                // Updates the minimum graph size
                var minw = Math.ceil(2 * pad.x + pages.width * size.width);
                var minh = Math.ceil(2 * pad.y + pages.height * size.height);

                var min = graph.minimumGraphSize;

                // LATER: Fix flicker of scrollbar size in IE quirks mode
                // after delayed call in window.resize event handler
                if (min == null || min.width != minw || min.height != minh) {
                    graph.minimumGraphSize = new mxRectangle(0, 0, minw, minh);
                }

                // Updates auto-translate to include padding and graph size
                var dx = pad.x - pages.x * size.width;
                var dy = pad.y - pages.y * size.height;

                if (!this.autoTranslate && (this.view.translate.x != dx || this.view.translate.y != dy)) {
                    this.autoTranslate = true;
                    this.view.x0 = pages.x;
                    this.view.y0 = pages.y;

                    // NOTE: THIS INVOKES THIS METHOD AGAIN. UNFORTUNATELY THERE IS NO WAY AROUND THIS SINCE THE
                    // BOUNDS ARE KNOWN AFTER THE VALIDATION AND SETTING THE TRANSLATE TRIGGERS A REVALIDATION.
                    // SHOULD MOVE TRANSLATE/SCALE TO VIEW.
                    var tx = graph.view.translate.x;
                    var ty = graph.view.translate.y;
                    graph.view.setTranslate(dx, dy);

                    // LATER: Fix rounding errors for small zoom
                    graph.container.scrollLeft += Math.round((dx - tx) * graph.view.scale);
                    graph.container.scrollTop += Math.round((dy - ty) * graph.view.scale);

                    this.autoTranslate = false;

                    return;
                }

                graphSizeDidChange.apply(this, arguments);
            } else {
                // Fires event but does not invoke superclass
                this.fireEvent(new mxEventObject(mxEvent.SIZE, 'bounds', this.getGraphBounds()));
            }
        };
    }

    // Accumulates the zoom factor while the rendering is taking place
    // so that not the complete sequence of zoom steps must be painted
    graph.updateZoomTimeout = null;
    graph.cumulativeZoomFactor = 1;

    var cursorPosition = null;

    graph.lazyZoom = function (zoomIn) {
        if (this.updateZoomTimeout != null) {
            window.clearTimeout(this.updateZoomTimeout);
        }

        // Switches to 1% zoom steps below 15%
        // Lower bound depdends on rounding below
        if (zoomIn) {
            if (this.view.scale * this.cumulativeZoomFactor < 0.15) {
                this.cumulativeZoomFactor = (this.view.scale + 0.01) / this.view.scale;
            } else {
                // Uses to 5% zoom steps for better grid rendering in webkit
                // and to avoid rounding errors for zoom steps
                this.cumulativeZoomFactor *= this.zoomFactor;
                this.cumulativeZoomFactor = Math.round(this.view.scale * this.cumulativeZoomFactor * 20) / 20 / this.view.scale;
            }
        } else {
            if (this.view.scale * this.cumulativeZoomFactor <= 0.15) {
                this.cumulativeZoomFactor = (this.view.scale - 0.01) / this.view.scale;
            } else {
                // Uses to 5% zoom steps for better grid rendering in webkit
                // and to avoid rounding errors for zoom steps
                this.cumulativeZoomFactor /= this.zoomFactor;
                this.cumulativeZoomFactor = Math.round(this.view.scale * this.cumulativeZoomFactor * 20) / 20 / this.view.scale;
            }
        }

        this.cumulativeZoomFactor = Math.max(0.01, Math.min(this.view.scale * this.cumulativeZoomFactor, 160) / this.view.scale);

        this.updateZoomTimeout = window.setTimeout(mxUtils.bind(this, function () {
            var offset = mxUtils.getOffset(graph.container);
            var dx = 0;
            var dy = 0;

            if (cursorPosition != null) {
                dx = graph.container.offsetWidth / 2 - cursorPosition.x + offset.x;
                dy = graph.container.offsetHeight / 2 - cursorPosition.y + offset.y;
            }

            var prev = this.view.scale;
            this.zoom(this.cumulativeZoomFactor);
            var s = this.view.scale;

            if (s != prev) {
                if (resize != null) {
                    ui.chromelessResize(false, null, dx * (this.cumulativeZoomFactor - 1),
                        dy * (this.cumulativeZoomFactor - 1));
                }

                if (mxUtils.hasScrollbars(graph.container) && (dx != 0 || dy != 0)) {
                    graph.container.scrollLeft -= dx * (this.cumulativeZoomFactor - 1);
                    graph.container.scrollTop -= dy * (this.cumulativeZoomFactor - 1);
                }
            }

            this.cumulativeZoomFactor = 1;
            this.updateZoomTimeout = null;
        }), this.lazyZoomDelay);
    };

    mxEvent.addMouseWheelListener(mxUtils.bind(this, function (evt, up) {
        // Ctrl+wheel (or pinch on touchpad) is a native browser zoom event is OS X
        // LATER: Add support for zoom via pinch on trackpad for Chrome in OS X
        if ((this.dialogs == null || this.dialogs.length == 0) && graph.isZoomWheelEvent(evt)) {
            var source = mxEvent.getSource(evt);

            while (source != null) {
                if (source == graph.container) {
                    cursorPosition = new mxPoint(mxEvent.getClientX(evt), mxEvent.getClientY(evt));
                    graph.lazyZoom(up);
                    mxEvent.consume(evt);

                    return false;
                }

                source = source.parentNode;
            }
        }
    }), graph.container);
};

/**
 * Creates a temporary graph instance for rendering off-screen content.
 */
EditorUi.prototype.addChromelessToolbarItems = function (addButton) {
    addButton(mxUtils.bind(this, function (evt) {
        this.actions.get('print').funct();
        mxEvent.consume(evt);
    }), Editor.printLargeImage, mxResources.get('print'));
};

/**
 * Creates a temporary graph instance for rendering off-screen content.
 */
EditorUi.prototype.createTemporaryGraph = function (stylesheet) {
    var graph = new Graph(document.createElement('div'), null, null, stylesheet);
    graph.resetViewOnRootChange = false;
    graph.setConnectable(false);
    graph.gridEnabled = false;
    graph.autoScroll = false;
    graph.setTooltips(false);
    graph.setEnabled(false);

    // Container must be in the DOM for correct HTML rendering
    graph.container.style.visibility = 'hidden';
    graph.container.style.position = 'absolute';
    graph.container.style.overflow = 'hidden';
    graph.container.style.height = '1px';
    graph.container.style.width = '1px';

    return graph;
};

/**
 *
 */
EditorUi.prototype.addChromelessClickHandler = function () {
    var hl = urlParams['highlight'];

    // Adds leading # for highlight color code
    if (hl != null && hl.length > 0) {
        hl = '#' + hl;
    }
    this.editor.graph.addClickHandler(hl);
};

/**
 *
 */
EditorUi.prototype.toggleFormatPanel = function (forceHide) {
    if (this.format != null) {
        this.formatWidth = (forceHide || this.formatWidth > 0) ? 0 : 240;
        this.formatContainer.style.display = (forceHide || this.formatWidth > 0) ? '' : 'none';
        this.refresh();
        this.format.refresh();
        this.fireEvent(new mxEventObject('formatWidthChanged'));
    }
};

/**
 * Adds support for placeholders in labels.
 */
EditorUi.prototype.lightboxFit = function (maxHeight) {
    if (this.isDiagramEmpty()) {
        this.editor.graph.view.setScale(1);
    } else {
        var p = urlParams['border'];
        var border = 60;

        if (p != null) {
            border = parseInt(p);
        }

        // LATER: Use initial graph bounds to avoid rounding errors
        this.editor.graph.maxFitScale = this.lightboxMaxFitScale;
        this.editor.graph.fit(border, null, null, null, null, null, maxHeight);
        this.editor.graph.maxFitScale = null;
    }
};

/**
 * Translates this point by the given vector.
 *
 * @param {number} dx X-coordinate of the translation.
 * @param {number} dy Y-coordinate of the translation.
 */
EditorUi.prototype.isDiagramEmpty = function () {
    var model = this.editor.graph.getModel();

    return model.getChildCount(model.root) == 1 && model.getChildCount(model.getChildAt(model.root, 0)) == 0;
};

/**
 * Hook for allowing selection and context menu for certain events.
 */
EditorUi.prototype.isSelectionAllowed = function (evt) {
    return mxEvent.getSource(evt).nodeName == 'SELECT' || (mxEvent.getSource(evt).nodeName == 'INPUT' &&
        mxUtils.isAncestorNode(this.formatContainer, mxEvent.getSource(evt)));
};

/**
 * Installs dialog if browser window is closed without saving
 * This must be disabled during save and image export.
 */
EditorUi.prototype.addBeforeUnloadListener = function () {
    // Installs dialog if browser window is closed without saving
    // This must be disabled during save and image export
    window.onbeforeunload = mxUtils.bind(this, function () {
        if (!this.editor.isChromelessView()) {
            return this.onBeforeUnload();
        }
    });
};

/**
 * Sets the onbeforeunload for the application
 */
EditorUi.prototype.onBeforeUnload = function () {
    if (this.editor.modified) {
        return mxResources.get('allChangesLost');
    }
};

/**
 * Opens the current diagram via the window.opener if one exists.
 */
EditorUi.prototype.open = function () {
    // Cross-domain window access is not allowed in FF, so if we
    // were opened from another domain then this will fail.
    try {
        if (window.opener != null && window.opener.openFile != null) {
            window.opener.openFile.setConsumer(mxUtils.bind(this, function (xml, filename) {
                try {
                    var doc = mxUtils.parseXml(xml);
                    this.editor.setGraphXml(doc.documentElement);
                    this.editor.setModified(false);
                    this.editor.undoManager.clear();

                    if (filename != null) {
                        this.editor.setFilename(filename);
                        this.updateDocumentTitle();
                    }

                    return;
                } catch (e) {
                    mxUtils.alert(mxResources.get('invalidOrMissingFile') + ': ' + e.message);
                }
            }));
        }
    } catch (e) {
        // ignore
    }

    // Fires as the last step if no file was loaded
    this.editor.graph.view.validate();

    // Required only in special cases where an initial file is opened
    // and the minimumGraphSize changes and CSS must be updated.
    this.editor.graph.sizeDidChange();
    this.editor.fireEvent(new mxEventObject('resetGraphView'));
};

/**
 * Sets the current menu and element.
 */
EditorUi.prototype.setCurrentMenu = function (menu, elt) {
    this.currentMenuElt = elt;
    this.currentMenu = menu;
};

/**
 * Resets the current menu and element.
 */
EditorUi.prototype.resetCurrentMenu = function () {
    this.currentMenuElt = null;
    this.currentMenu = null;
};

/**
 * Hides and destroys the current menu.
 */
EditorUi.prototype.hideCurrentMenu = function () {
    if (this.currentMenu != null) {
        this.currentMenu.hideMenu();
        this.resetCurrentMenu();
    }
};

/**
 * Updates the document title.
 */
EditorUi.prototype.updateDocumentTitle = function () {
    var title = this.editor.getOrCreateFilename();

    if (this.editor.appName != null) {
        title += ' - ' + this.editor.appName;
    }

    document.title = title;
};

/**
 * Updates the document title.
 */
EditorUi.prototype.createHoverIcons = function () {
    return new HoverIcons(this.editor.graph);
};

/**
 * Returns the URL for a copy of this editor with no state.
 */
EditorUi.prototype.redo = function () {
    try {
        var graph = this.editor.graph;

        if (graph.isEditing()) {
            document.execCommand('redo', false, null);
        } else {
            this.editor.undoManager.redo();
        }
    } catch (e) {
        // ignore all errors
    }
};

/**
 * Returns the URL for a copy of this editor with no state.
 */
EditorUi.prototype.undo = function () {
    try {
        var graph = this.editor.graph;

        if (graph.isEditing()) {
            // Stops editing and executes undo on graph if native undo
            // does not affect current editing value
            var value = graph.cellEditor.textarea.innerHTML;
            document.execCommand('undo', false, null);

            if (value == graph.cellEditor.textarea.innerHTML) {
                graph.stopEditing(true);
                this.editor.undoManager.undo();
            }
        } else {
            this.editor.undoManager.undo();
        }
    } catch (e) {
        // ignore all errors
    }
};

/**
 * Returns the URL for a copy of this editor with no state.
 */
EditorUi.prototype.canRedo = function () {
    return this.editor.graph.isEditing() || this.editor.undoManager.canRedo();
};

/**
 * Returns the URL for a copy of this editor with no state.
 */
EditorUi.prototype.canUndo = function () {
    return this.editor.graph.isEditing() || this.editor.undoManager.canUndo();
};

/**
 *
 */
EditorUi.prototype.getEditBlankXml = function () {
    return mxUtils.getXml(this.editor.getGraphXml());
};

/**
 * Returns the URL for a copy of this editor with no state.
 */
EditorUi.prototype.getUrl = function (pathname) {
    var href = (pathname != null) ? pathname : window.location.pathname;
    var parms = (href.indexOf('?') > 0) ? 1 : 0;

    // Removes template URL parameter for new blank diagram
    for (var key in urlParams) {
        if (parms == 0) {
            href += '?';
        } else {
            href += '&';
        }

        href += key + '=' + urlParams[key];
        parms++;
    }

    return href;
};

/**
 * Specifies if the graph has scrollbars.
 */
EditorUi.prototype.setScrollbars = function (value) {
    var graph = this.editor.graph;
    var prev = graph.container.style.overflow;
    graph.scrollbars = value;
    this.editor.updateGraphComponents();

    if (prev != graph.container.style.overflow) {
        if (graph.container.style.overflow == 'hidden') {
            var t = graph.view.translate;
            graph.view.setTranslate(t.x - graph.container.scrollLeft / graph.view.scale, t.y - graph.container.scrollTop / graph.view.scale);
            graph.container.scrollLeft = 0;
            graph.container.scrollTop = 0;
            graph.minimumGraphSize = null;
            graph.sizeDidChange();
        } else {
            var dx = graph.view.translate.x;
            var dy = graph.view.translate.y;

            graph.view.translate.x = 0;
            graph.view.translate.y = 0;
            graph.sizeDidChange();
            graph.container.scrollLeft -= Math.round(dx * graph.view.scale);
            graph.container.scrollTop -= Math.round(dy * graph.view.scale);
        }
    }

    this.fireEvent(new mxEventObject('scrollbarsChanged'));
};

/**
 * Returns true if the graph has scrollbars.
 */
EditorUi.prototype.hasScrollbars = function () {
    return this.editor.graph.scrollbars;
};

/**
 * Resets the state of the scrollbars.
 */
EditorUi.prototype.resetScrollbars = function () {
    var graph = this.editor.graph;

    if (!this.editor.extendCanvas) {
        graph.container.scrollTop = 0;
        graph.container.scrollLeft = 0;

        if (!mxUtils.hasScrollbars(graph.container)) {
            graph.view.setTranslate(0, 0);
        }
    } else if (!this.editor.isChromelessView()) {
        if (mxUtils.hasScrollbars(graph.container)) {
            if (graph.pageVisible) {
                var pad = graph.getPagePadding();
                graph.container.scrollTop = Math.floor(pad.y - this.editor.initialTopSpacing) - 1;
                graph.container.scrollLeft = Math.floor(Math.min(pad.x,
                    (graph.container.scrollWidth - graph.container.clientWidth) / 2)) - 1;

                // Scrolls graph to visible area
                var bounds = graph.getGraphBounds();

                if (bounds.width > 0 && bounds.height > 0) {
                    if (bounds.x > graph.container.scrollLeft + graph.container.clientWidth * 0.9) {
                        graph.container.scrollLeft = Math.min(bounds.x + bounds.width - graph.container.clientWidth, bounds.x - 10);
                    }

                    if (bounds.y > graph.container.scrollTop + graph.container.clientHeight * 0.9) {
                        graph.container.scrollTop = Math.min(bounds.y + bounds.height - graph.container.clientHeight, bounds.y - 10);
                    }
                }
            } else {
                var bounds = graph.getGraphBounds();
                var width = Math.max(bounds.width, graph.scrollTileSize.width * graph.view.scale);
                var height = Math.max(bounds.height, graph.scrollTileSize.height * graph.view.scale);
                graph.container.scrollTop = Math.floor(Math.max(0, bounds.y - Math.max(20, (graph.container.clientHeight - height) / 4)));
                graph.container.scrollLeft = Math.floor(Math.max(0, bounds.x - Math.max(0, (graph.container.clientWidth - width) / 2)));
            }
        } else {
            // This code is not actively used since the default for scrollbars is always true
            if (graph.pageVisible) {
                var b = graph.view.getBackgroundPageBounds();
                graph.view.setTranslate(Math.floor(Math.max(0, (graph.container.clientWidth - b.width) / 2) - b.x),
                    Math.floor(Math.max(0, (graph.container.clientHeight - b.height) / 2) - b.y));
            } else {
                var bounds = graph.getGraphBounds();
                graph.view.setTranslate(Math.floor(Math.max(0, Math.max(0, (graph.container.clientWidth - bounds.width) / 2) - bounds.x)),
                    Math.floor(Math.max(0, Math.max(20, (graph.container.clientHeight - bounds.height) / 4)) - bounds.y));
            }
        }
    }
};

/**
 * Loads the stylesheet for this graph.
 */
EditorUi.prototype.setPageVisible = function (value) {
    var graph = this.editor.graph;
    var hasScrollbars = mxUtils.hasScrollbars(graph.container);
    var tx = 0;
    var ty = 0;

    if (hasScrollbars) {
        tx = graph.view.translate.x * graph.view.scale - graph.container.scrollLeft;
        ty = graph.view.translate.y * graph.view.scale - graph.container.scrollTop;
    }

    graph.pageVisible = value;
    graph.pageBreaksVisible = value;
    graph.preferPageSize = value;
    graph.view.validateBackground();

    // Workaround for possible handle offset
    if (hasScrollbars) {
        var cells = graph.getSelectionCells();
        graph.clearSelection();
        graph.setSelectionCells(cells);
    }

    // Calls updatePageBreaks
    graph.sizeDidChange();

    if (hasScrollbars) {
        graph.container.scrollLeft = graph.view.translate.x * graph.view.scale - tx;
        graph.container.scrollTop = graph.view.translate.y * graph.view.scale - ty;
    }

    this.fireEvent(new mxEventObject('pageViewChanged'));
};

/**
 * Change types
 */
function ChangePageSetup(ui, color, image, format) {
    this.ui = ui;
    this.color = color;
    this.previousColor = color;
    this.image = image;
    this.previousImage = image;
    this.format = format;
    this.previousFormat = format;

    // Needed since null are valid values for color and image
    this.ignoreColor = false;
    this.ignoreImage = false;
}

/**
 * Implementation of the undoable page rename.
 */
ChangePageSetup.prototype.execute = function () {
    var graph = this.ui.editor.graph;

    if (!this.ignoreColor) {
        this.color = this.previousColor;
        var tmp = graph.background;
        this.ui.setBackgroundColor(this.previousColor);
        this.previousColor = tmp;
    }

    if (!this.ignoreImage) {
        this.image = this.previousImage;
        var tmp = graph.backgroundImage;
        this.ui.setBackgroundImage(this.previousImage);
        this.previousImage = tmp;
    }

    if (this.previousFormat != null) {
        this.format = this.previousFormat;
        var tmp = graph.pageFormat;

        if (this.previousFormat.width != tmp.width ||
            this.previousFormat.height != tmp.height) {
            this.ui.setPageFormat(this.previousFormat);
            this.previousFormat = tmp;
        }
    }

    if (this.foldingEnabled != null && this.foldingEnabled != this.ui.editor.graph.foldingEnabled) {
        this.ui.setFoldingEnabled(this.foldingEnabled);
        this.foldingEnabled = !this.foldingEnabled;
    }
};

// Registers codec for ChangePageSetup
(function () {
    var codec = new mxObjectCodec(new ChangePageSetup(), ['ui', 'previousColor', 'previousImage', 'previousFormat']);

    codec.afterDecode = function (dec, node, obj) {
        obj.previousColor = obj.color;
        obj.previousImage = obj.image;
        obj.previousFormat = obj.format;

        if (obj.foldingEnabled != null) {
            obj.foldingEnabled = !obj.foldingEnabled;
        }

        return obj;
    };

    mxCodecRegistry.register(codec);
})();

/**
 * Loads the stylesheet for this graph.
 */
EditorUi.prototype.setBackgroundColor = function (value) {
    this.editor.graph.background = value;
    this.editor.graph.view.validateBackground();

    this.fireEvent(new mxEventObject('backgroundColorChanged'));
};

/**
 * Loads the stylesheet for this graph.
 */
EditorUi.prototype.setFoldingEnabled = function (value) {
    this.editor.graph.foldingEnabled = value;
    this.editor.graph.view.revalidate();

    this.fireEvent(new mxEventObject('foldingEnabledChanged'));
};

/**
 * Loads the stylesheet for this graph.
 */
EditorUi.prototype.setPageFormat = function (value) {
    this.editor.graph.pageFormat = value;

    if (!this.editor.graph.pageVisible) {
        this.actions.get('pageView').funct();
    } else {
        this.editor.graph.view.validateBackground();
        this.editor.graph.sizeDidChange();
    }

    this.fireEvent(new mxEventObject('pageFormatChanged'));
};

/**
 * Loads the stylesheet for this graph.
 */
EditorUi.prototype.setPageScale = function (value) {
    this.editor.graph.pageScale = value;

    if (!this.editor.graph.pageVisible) {
        this.actions.get('pageView').funct();
    } else {
        this.editor.graph.view.validateBackground();
        this.editor.graph.sizeDidChange();
    }

    this.fireEvent(new mxEventObject('pageScaleChanged'));
};

/**
 * Loads the stylesheet for this graph.
 */
EditorUi.prototype.setGridColor = function (value) {
    this.editor.graph.view.gridColor = value;
    this.editor.graph.view.validateBackground();
    this.fireEvent(new mxEventObject('gridColorChanged'));
};

/**
 * Updates the states of the given undo/redo items.
 */
EditorUi.prototype.addUndoListener = function () {
    var undo = this.actions.get('undo');
    var redo = this.actions.get('redo');

    var undoMgr = this.editor.undoManager;

    var undoListener = mxUtils.bind(this, function () {
        undo.setEnabled(this.canUndo());
        redo.setEnabled(this.canRedo());
    });

    undoMgr.addListener(mxEvent.ADD, undoListener);
    undoMgr.addListener(mxEvent.UNDO, undoListener);
    undoMgr.addListener(mxEvent.REDO, undoListener);
    undoMgr.addListener(mxEvent.CLEAR, undoListener);

    // Overrides cell editor to update action states
    var cellEditorStartEditing = this.editor.graph.cellEditor.startEditing;

    this.editor.graph.cellEditor.startEditing = function () {
        cellEditorStartEditing.apply(this, arguments);
        undoListener();
    };

    var cellEditorStopEditing = this.editor.graph.cellEditor.stopEditing;

    this.editor.graph.cellEditor.stopEditing = function (cell, trigger) {
        cellEditorStopEditing.apply(this, arguments);
        undoListener();
    };

    // Updates the button states once
    undoListener();
};

/**
 * Updates the states of the given toolbar items based on the selection.
 */
EditorUi.prototype.updateActionStates = function () {
    var graph = this.editor.graph;
    var selected = !graph.isSelectionEmpty();
    var vertexSelected = false;
    var edgeSelected = false;

    var cells = graph.getSelectionCells();

    if (cells != null) {
        for (var i = 0; i < cells.length; i++) {
            var cell = cells[i];

            if (graph.getModel().isEdge(cell)) {
                edgeSelected = true;
            }

            if (graph.getModel().isVertex(cell)) {
                vertexSelected = true;
            }

            if (edgeSelected && vertexSelected) {
                break;
            }
        }
    }

    // Updates action states
    var actions = ['cut', 'copy', 'bold', 'italic', 'underline', 'delete', 'duplicate',
        'editTooltip', 'editLink', 'backgroundColor', 'borderColor',
        'edit', 'toFront', 'toBack', 'lockUnlock', 'solid', 'dashed', 'pasteSize',
        'dotted', 'fillColor', 'gradientColor', 'shadow', 'fontColor',
        'formattedText', 'rounded', 'toggleRounded', 'sharp', 'strokeColor'];

    for (var i = 0; i < actions.length; i++) {
        this.actions.get(actions[i]).setEnabled(selected);
    }

    this.actions.get('setAsDefaultStyle').setEnabled(graph.getSelectionCount() == 1);
    this.actions.get('clearWaypoints').setEnabled(!graph.isSelectionEmpty());
    this.actions.get('copySize').setEnabled(graph.getSelectionCount() == 1);
    this.actions.get('turn').setEnabled(!graph.isSelectionEmpty());
    this.actions.get('curved').setEnabled(edgeSelected);
    this.actions.get('rotation').setEnabled(vertexSelected);
    this.actions.get('wordWrap').setEnabled(vertexSelected);
    this.actions.get('autosize').setEnabled(vertexSelected);
    var oneVertexSelected = vertexSelected && graph.getSelectionCount() == 1;
    this.actions.get('group').setEnabled(graph.getSelectionCount() > 1 ||
        (oneVertexSelected && !graph.isContainer(graph.getSelectionCell())));
    this.actions.get('ungroup').setEnabled(graph.getSelectionCount() == 1 &&
        (graph.getModel().getChildCount(graph.getSelectionCell()) > 0 ||
            (oneVertexSelected && graph.isContainer(graph.getSelectionCell()))));
    this.actions.get('removeFromGroup').setEnabled(oneVertexSelected &&
        graph.getModel().isVertex(graph.getModel().getParent(graph.getSelectionCell())));

    // Updates menu states
    var state = graph.view.getState(graph.getSelectionCell());
    this.menus.get('navigation').setEnabled(selected || graph.view.currentRoot != null);
    this.actions.get('collapsible').setEnabled(vertexSelected &&
        (graph.isContainer(graph.getSelectionCell()) || graph.model.getChildCount(graph.getSelectionCell()) > 0));
    this.actions.get('home').setEnabled(graph.view.currentRoot != null);
    this.actions.get('exitGroup').setEnabled(graph.view.currentRoot != null);
    this.actions.get('enterGroup').setEnabled(graph.getSelectionCount() == 1 && graph.isValidRoot(graph.getSelectionCell()));
    var foldable = graph.getSelectionCount() == 1 && graph.isCellFoldable(graph.getSelectionCell());
    this.actions.get('expand').setEnabled(foldable);
    this.actions.get('collapse').setEnabled(foldable);
    this.actions.get('editLink').setEnabled(graph.getSelectionCount() == 1);
    this.actions.get('openLink').setEnabled(graph.getSelectionCount() == 1 &&
        graph.getLinkForCell(graph.getSelectionCell()) != null);
    this.actions.get('guides').setEnabled(graph.isEnabled());
    this.actions.get('grid').setEnabled(!this.editor.chromeless || this.editor.editable);

    var unlocked = graph.isEnabled() && !graph.isCellLocked(graph.getDefaultParent());
    this.menus.get('layout').setEnabled(unlocked);
    this.menus.get('insert').setEnabled(unlocked);
    this.menus.get('direction').setEnabled(unlocked && vertexSelected);
    this.menus.get('align').setEnabled(unlocked && vertexSelected && graph.getSelectionCount() > 1);
    this.menus.get('distribute').setEnabled(unlocked && vertexSelected && graph.getSelectionCount() > 1);
    this.actions.get('selectVertices').setEnabled(unlocked);
    this.actions.get('selectEdges').setEnabled(unlocked);
    this.actions.get('selectAll').setEnabled(unlocked);
    this.actions.get('selectNone').setEnabled(unlocked);

    this.updatePasteActionStates();
};

/**
 * Refreshes the viewport.
 */
EditorUi.prototype.refresh = function (sizeDidChange) {
    sizeDidChange = (sizeDidChange != null) ? sizeDidChange : true;

    var quirks = mxClient.IS_IE && (document.documentMode == null || document.documentMode == 5);
    var w = this.container.clientWidth;
    var h = this.container.clientHeight;

    if (this.container == document.body) {
        w = document.body.clientWidth || document.documentElement.clientWidth;
        h = (quirks) ? document.body.clientHeight || document.documentElement.clientHeight : document.documentElement.clientHeight;
    }

    // Workaround for bug on iOS see
    // http://stackoverflow.com/questions/19012135/ios-7-ipad-safari-landscape-innerheight-outerheight-layout-issue
    // FIXME: Fix if footer visible
    var off = 0;

    if (mxClient.IS_IOS && !window.navigator.standalone) {
        if (window.innerHeight != document.documentElement.clientHeight) {
            off = document.documentElement.clientHeight - window.innerHeight;
            window.scrollTo(0, 0);
        }
    }

    var effHsplitPosition = Math.max(0, Math.min(this.hsplitPosition, w - this.splitSize - 20));
    var tmp = 0;

    if (this.menubar != null) {
        this.menubarContainer.style.height = this.menubarHeight + 'px';
        tmp += this.menubarHeight;
    }

    if (urlParams['preview_header'] == '1') {
        tmp += 50;
    }

    if (this.toolbar != null) {
        this.toolbarContainer.style.top = this.menubarHeight + 'px';
        this.toolbarContainer.style.height = this.toolbarHeight + 'px';
        tmp += this.toolbarHeight;
    }

    if (tmp > 0 && !mxClient.IS_QUIRKS) {
        tmp += 1;
    }

    var sidebarFooterHeight = 0;

    if (this.sidebarFooterContainer != null) {
        var bottom = this.footerHeight + off;
        sidebarFooterHeight = Math.max(0, Math.min(h - tmp - bottom, this.sidebarFooterHeight));
        this.sidebarFooterContainer.style.width = effHsplitPosition + 'px';
        this.sidebarFooterContainer.style.height = sidebarFooterHeight + 'px';
        this.sidebarFooterContainer.style.bottom = bottom + 'px';
    }

    var fw = (this.format != null) ? this.formatWidth : 0;
    this.sidebarContainer.style.top = tmp + 'px';
    this.sidebarContainer.style.width = effHsplitPosition + 'px';
    this.formatContainer.style.top = tmp + 'px';
    this.formatContainer.style.width = fw + 'px';
    this.formatContainer.style.display = (this.format != null) ? '' : 'none';

    this.diagramContainer.style.left = (this.hsplit.parentNode != null) ? (effHsplitPosition + this.splitSize) + 'px' : '0px';
    this.diagramContainer.style.top = this.sidebarContainer.style.top;
    this.footerContainer.style.height = this.footerHeight + 'px';
    this.hsplit.style.top = this.sidebarContainer.style.top;
    this.hsplit.style.bottom = (this.footerHeight + off) + 'px';
    this.hsplit.style.left = effHsplitPosition + 'px';
    this.footerContainer.style.display = (this.footerHeight == 0) ? 'none' : '';

    if (this.tabContainer != null) {
        this.tabContainer.style.left = this.diagramContainer.style.left;
    }

    if (quirks) {
        this.menubarContainer.style.width = w + 'px';
        this.toolbarContainer.style.width = this.menubarContainer.style.width;
        var sidebarHeight = Math.max(0, h - this.footerHeight - this.menubarHeight - this.toolbarHeight);
        this.sidebarContainer.style.height = (sidebarHeight - sidebarFooterHeight) + 'px';
        this.formatContainer.style.height = sidebarHeight + 'px';
        this.diagramContainer.style.width = (this.hsplit.parentNode != null) ? Math.max(0, w - effHsplitPosition - this.splitSize - fw) + 'px' : w + 'px';
        this.footerContainer.style.width = this.menubarContainer.style.width;
        var diagramHeight = Math.max(0, h - this.footerHeight - this.menubarHeight - this.toolbarHeight);

        if (this.tabContainer != null) {
            this.tabContainer.style.width = this.diagramContainer.style.width;
            this.tabContainer.style.bottom = (this.footerHeight + off) + 'px';
            diagramHeight -= this.tabContainer.clientHeight;
        }

        this.diagramContainer.style.height = diagramHeight + 'px';
        this.hsplit.style.height = diagramHeight + 'px';
    } else {
        if (this.footerHeight > 0) {
            this.footerContainer.style.bottom = off + 'px';
        }

        this.diagramContainer.style.right = fw + 'px';
        var th = 0;

        if (this.tabContainer != null) {
            this.tabContainer.style.bottom = (this.footerHeight + off) + 'px';
            this.tabContainer.style.right = this.diagramContainer.style.right;
            th = this.tabContainer.clientHeight;
        }

        this.sidebarContainer.style.bottom = (this.footerHeight + sidebarFooterHeight + off) + 'px';
        this.formatContainer.style.bottom = (this.footerHeight + off) + 'px';
        this.diagramContainer.style.bottom = (this.footerHeight + off + th) + 'px';
    }

    if (sizeDidChange) {
        this.editor.graph.sizeDidChange();
    }
};

/**
 * Creates the required containers.
 */
EditorUi.prototype.createTabContainer = function () {
    return null;
};

/**
 * Creates the required containers.
 */
EditorUi.prototype.createDivs = function () {
    this.menubarContainer = this.createDiv('geMenubarContainer');
    this.toolbarContainer = this.createDiv('geToolbarContainer');
    this.sidebarContainer = this.createDiv('geSidebarContainer');
    this.formatContainer = this.createDiv('geSidebarContainer geFormatContainer');
    this.diagramContainer = this.createDiv('geDiagramContainer');
    this.footerContainer = this.createDiv('geFooterContainer');
    this.hsplit = this.createDiv('geHsplit');
    this.hsplit.setAttribute('title', mxResources.get('collapseExpand'));

    // Sets static style for containers
    this.menubarContainer.style.top = '0px';
    this.menubarContainer.style.left = '0px';
    this.menubarContainer.style.right = '0px';
    this.toolbarContainer.style.left = '0px';
    this.toolbarContainer.style.right = '0px';
    this.sidebarContainer.style.left = '0px';
    this.formatContainer.style.right = '0px';
    this.formatContainer.style.zIndex = '1';
    this.diagramContainer.style.right = ((this.format != null) ? this.formatWidth : 0) + 'px';
    this.footerContainer.style.left = '0px';
    this.footerContainer.style.right = '0px';
    this.footerContainer.style.bottom = '0px';
    this.footerContainer.style.zIndex = mxPopupMenu.prototype.zIndex - 2;
    this.hsplit.style.width = this.splitSize + 'px';
    this.sidebarFooterContainer = this.createSidebarFooterContainer();

    if (this.sidebarFooterContainer) {
        this.sidebarFooterContainer.style.left = '0px';
    }

    if (!this.editor.chromeless) {
        this.tabContainer = this.createTabContainer();
    } else {
        this.diagramContainer.style.border = 'none';
    }
};

/**
 * Hook for sidebar footer container. This implementation returns null.
 */
EditorUi.prototype.createSidebarFooterContainer = function () {
    return null;
};

/**
 * Creates the required containers.
 */
EditorUi.prototype.createUi = function () {
    // Creates menubar
    this.menubar = (this.editor.chromeless) ? null : this.menus.createMenubar(this.createDiv('geMenubar'));

    if (this.menubar != null) {
        this.menubarContainer.appendChild(this.menubar.container);
    }

    // Adds status bar in menubar
    if (this.menubar != null) {
        this.statusContainer = this.createStatusContainer();

        // Connects the status bar to the editor status
        this.editor.addListener('statusChanged', mxUtils.bind(this, function () {
            this.setStatusText(this.editor.getStatus());
        }));

        this.setStatusText(this.editor.getStatus());
        this.menubar.container.appendChild(this.statusContainer);

        // Inserts into DOM
        this.container.appendChild(this.menubarContainer);
    }

    // Creates the sidebar
    this.sidebar = (this.editor.chromeless) ? null : this.createSidebar(this.sidebarContainer);

    if (this.sidebar != null) {
        this.container.appendChild(this.sidebarContainer);
    }

    // Creates the format sidebar
    this.format = (this.editor.chromeless || !this.formatEnabled) ? null : this.createFormat(this.formatContainer);

    if (this.format != null) {
        this.container.appendChild(this.formatContainer);
    }

    // Creates the footer
    var footer = (this.editor.chromeless) ? null : this.createFooter();

    if (footer != null) {
        this.footerContainer.appendChild(footer);
        this.container.appendChild(this.footerContainer);
    }

    if (this.sidebar != null && this.sidebarFooterContainer) {
        this.container.appendChild(this.sidebarFooterContainer);
    }

    this.container.appendChild(this.diagramContainer);

    if (this.container != null && this.tabContainer != null) {
        this.container.appendChild(this.tabContainer);
    }

    // Creates toolbar
    this.toolbar = (this.editor.chromeless) ? null : this.createToolbar(this.createDiv('geToolbar'));

    if (this.toolbar != null) {
        this.toolbarContainer.appendChild(this.toolbar.container);
        this.container.appendChild(this.toolbarContainer);
    }

    // HSplit
    if (this.sidebar != null) {
        this.container.appendChild(this.hsplit);

        this.addSplitHandler(this.hsplit, true, 0, mxUtils.bind(this, function (value) {
            this.hsplitPosition = value;
            this.refresh();
        }));
    }
};

/**
 * Creates a new toolbar for the given container.
 */
EditorUi.prototype.createStatusContainer = function () {
    var container = document.createElement('a');
    container.className = 'geItem geStatus';

    if (screen.width < 420) {
        container.style.maxWidth = Math.max(20, screen.width - 320) + 'px';
        container.style.overflow = 'hidden';
    }

    return container;
};

/**
 * Creates a new toolbar for the given container.
 */
EditorUi.prototype.setStatusText = function (value) {
    this.statusContainer.innerHTML = value;
};

/**
 * Creates a new toolbar for the given container.
 */
EditorUi.prototype.createToolbar = function (container) {
    return new Toolbar(this, container);
};

/**
 * Creates a new sidebar for the given container.
 */
EditorUi.prototype.createSidebar = function (container) {
    return new Sidebar(this, container);
};

/**
 * Creates a new sidebar for the given container.
 */
EditorUi.prototype.createFormat = function (container) {
    return new Format(this, container);
};

/**
 * Creates and returns a new footer.
 */
EditorUi.prototype.createFooter = function () {
    return this.createDiv('geFooter');
};

/**
 * Creates the actual toolbar for the toolbar container.
 */
EditorUi.prototype.createDiv = function (classname) {
    var elt = document.createElement('div');
    elt.className = classname;

    return elt;
};

/**
 * Updates the states of the given undo/redo items.
 */
EditorUi.prototype.addSplitHandler = function (elt, horizontal, dx, onChange) {
    var start = null;
    var initial = null;
    var ignoreClick = true;
    var last = null;

    // Disables built-in pan and zoom in IE10 and later
    if (mxClient.IS_POINTER) {
        elt.style.touchAction = 'none';
    }

    var getValue = mxUtils.bind(this, function () {
        var result = parseInt(((horizontal) ? elt.style.left : elt.style.bottom));

        // Takes into account hidden footer
        if (!horizontal) {
            result = result + dx - this.footerHeight;
        }

        return result;
    });

    function moveHandler(evt) {
        if (start != null) {
            var pt = new mxPoint(mxEvent.getClientX(evt), mxEvent.getClientY(evt));
            onChange(Math.max(0, initial + ((horizontal) ? (pt.x - start.x) : (start.y - pt.y)) - dx));
            mxEvent.consume(evt);

            if (initial != getValue()) {
                ignoreClick = true;
                last = null;
            }
        }
    };

    function dropHandler(evt) {
        moveHandler(evt);
        initial = null;
        start = null;
    };

    mxEvent.addGestureListeners(elt, function (evt) {
        start = new mxPoint(mxEvent.getClientX(evt), mxEvent.getClientY(evt));
        initial = getValue();
        ignoreClick = false;
        mxEvent.consume(evt);
    });

    mxEvent.addListener(elt, 'click', mxUtils.bind(this, function (evt) {
        if (!ignoreClick && this.hsplitClickEnabled) {
            var next = (last != null) ? last - dx : 0;
            last = getValue();
            onChange(next);
            mxEvent.consume(evt);
        }
    }));

    mxEvent.addGestureListeners(document, null, moveHandler, dropHandler);

    this.destroyFunctions.push(function () {
        mxEvent.removeGestureListeners(document, null, moveHandler, dropHandler);
    });
};

/**
 * Translates this point by the given vector.
 *
 * @param {number} dx X-coordinate of the translation.
 * @param {number} dy Y-coordinate of the translation.
 */
EditorUi.prototype.handleError = function (resp, title, fn, invokeFnOnClose, notFoundMessage) {
    var e = (resp != null && resp.error != null) ? resp.error : resp;

    if (e != null || title != null) {
        var msg = mxUtils.htmlEntities(mxResources.get('unknownError'));
        var btn = mxResources.get('ok');
        title = (title != null) ? title : mxResources.get('error');

        if (e != null && e.message != null) {
            msg = mxUtils.htmlEntities(e.message);
        }

        this.showError(title, msg, btn, fn, null, null, null, null, null,
            null, null, null, (invokeFnOnClose) ? fn : null);
    } else if (fn != null) {
        fn();
    }
};

/**
 * Translates this point by the given vector.
 *
 * @param {number} dx X-coordinate of the translation.
 * @param {number} dy Y-coordinate of the translation.
 */
EditorUi.prototype.showError = function (title, msg, btn, fn, retry, btn2, fn2, btn3, fn3, w, h, hide, onClose) {
    var dlg = new ErrorDialog(this, title, msg, btn || mxResources.get('ok'),
        fn, retry, btn2, fn2, hide, btn3, fn3);
    var lines = Math.ceil((msg != null) ? msg.length / 50 : 1);
    this.showDialog(dlg.container, w || 340, h || (100 + lines * 80), true, false, onClose);
    dlg.init();
};

/**
 * Displays a print dialog.
 */
EditorUi.prototype.showDialog = function (elt, w, h, modal, closable, onClose, noScroll, transparent, onResize, ignoreBgClick) {
    this.editor.graph.tooltipHandler.hideTooltip();

    if (this.dialogs == null) {
        this.dialogs = [];
    }

    this.dialog = new Dialog(this, elt, w, h, modal, closable, onClose, noScroll, transparent, onResize, ignoreBgClick);
    this.dialogs.push(this.dialog);
};

/**
 * Displays a print dialog.
 */
EditorUi.prototype.hideDialog = function (cancel, isEsc) {
    if (this.dialogs != null && this.dialogs.length > 0) {
        var dlg = this.dialogs.pop();

        if (dlg.close(cancel, isEsc) == false) {
            //add the dialog back if dialog closing is cancelled
            this.dialogs.push(dlg);
            return;
        }

        this.dialog = (this.dialogs.length > 0) ? this.dialogs[this.dialogs.length - 1] : null;
        this.editor.fireEvent(new mxEventObject('hideDialog'));

        if (this.dialog == null && this.editor.graph.container.style.visibility != 'hidden') {
            window.setTimeout(mxUtils.bind(this, function () {
                if (this.editor.graph.isEditing() && this.editor.graph.cellEditor.textarea != null) {
                    this.editor.graph.cellEditor.textarea.focus();
                } else {
                    mxUtils.clearSelection();
                    this.editor.graph.container.focus();
                }
            }), 0);
        }
    }
};

/**
 * Display a color dialog.
 */
EditorUi.prototype.pickColor = function (color, apply) {
    var graph = this.editor.graph;
    var selState = graph.cellEditor.saveSelection();
    var h = 270 + ((Math.ceil(ColorDialog.prototype.presetColors.length / 12) +
        Math.ceil(ColorDialog.prototype.defaultColors.length / 12)) * 17);

    var dlg = new ColorDialog(this, color || 'none', function (color) {
        graph.cellEditor.restoreSelection(selState);
        apply(color);
    }, function () {
        graph.cellEditor.restoreSelection(selState);
    });
    this.showDialog(dlg.container, 300, h, true, false);
    dlg.init();
};

/**
 * Adds the label menu items to the given menu and parent.
 */
EditorUi.prototype.openFile = function () {
    // Closes dialog after open
    window.openFile = new OpenFile(mxUtils.bind(this, function (cancel) {
        this.hideDialog(cancel);
    }));

    // Removes openFile if dialog is closed
    this.showDialog(new OpenDialog(this).container, (Editor.useLocalStorage) ? 640 : 320,
        (Editor.useLocalStorage) ? 480 : 220, true, true, function () {
            window.openFile = null;
        });
};

/**
 * Extracs the graph model from the given HTML data from a data transfer event.
 */
EditorUi.prototype.extractGraphModelFromHtml = function (data) {
    var result = null;

    try {
        var idx = data.indexOf('&lt;mxGraphModel ');

        if (idx >= 0) {
            var idx2 = data.lastIndexOf('&lt;/mxGraphModel&gt;');

            if (idx2 > idx) {
                result = data.substring(idx, idx2 + 21).replace(/&gt;/g, '>').replace(/&lt;/g, '<').replace(/\\&quot;/g, '"').replace(/\n/g, '');
            }
        }
    } catch (e) {
        // ignore
    }

    return result;
};

/**
 * Opens the given files in the editor.
 */
EditorUi.prototype.extractGraphModelFromEvent = function (evt) {
    var result = null;
    var data = null;

    if (evt != null) {
        var provider = (evt.dataTransfer != null) ? evt.dataTransfer : evt.clipboardData;

        if (provider != null) {
            if (document.documentMode == 10 || document.documentMode == 11) {
                data = provider.getData('Text');
            } else {
                data = (mxUtils.indexOf(provider.types, 'text/html') >= 0) ? provider.getData('text/html') : null;

                if (mxUtils.indexOf(provider.types, 'text/plain' && (data == null || data.length == 0))) {
                    data = provider.getData('text/plain');
                }
            }

            if (data != null) {
                data = Graph.zapGremlins(mxUtils.trim(data));

                // Tries parsing as HTML document with embedded XML
                var xml = this.extractGraphModelFromHtml(data);

                if (xml != null) {
                    data = xml;
                }
            }
        }
    }

    if (data != null && this.isCompatibleString(data)) {
        result = data;
    }

    return result;
};

/**
 * Hook for subclassers to return true if event data is a supported format.
 * This implementation always returns false.
 */
EditorUi.prototype.isCompatibleString = function (data) {
    return false;
};

/**
 * Adds the label menu items to the given menu and parent.
 */
EditorUi.prototype.saveFile = function (forceDialog) {
    if (!forceDialog && this.editor.filename != null) {
        this.save(this.editor.getOrCreateFilename());
    } else {
        var dlg = new FilenameDialog(this, this.editor.getOrCreateFilename(), mxResources.get('save'), mxUtils.bind(this, function (name) {
            this.save(name);
        }), null, mxUtils.bind(this, function (name) {
            if (name != null && name.length > 0) {
                return true;
            }

            mxUtils.confirm(mxResources.get('invalidName'));

            return false;
        }));
        this.showDialog(dlg.container, 300, 100, true, true);
        dlg.init();
    }
};

/**
 * Saves the current graph under the given filename.
 */
EditorUi.prototype.save = function (name) {
    if (name != null) {
        if (this.editor.graph.isEditing()) {
            this.editor.graph.stopEditing();
        }

        var xml = mxUtils.getXml(this.editor.getGraphXml());

        try {
            if (Editor.useLocalStorage) {
                if (localStorage.getItem(name) != null &&
                    !mxUtils.confirm(mxResources.get('replaceIt', [name]))) {
                    return;
                }

                localStorage.setItem(name, xml);
                this.editor.setStatus(mxUtils.htmlEntities(mxResources.get('saved')) + ' ' + new Date());
            } else {
                if (xml.length < MAX_REQUEST_SIZE) {
                    new mxXmlRequest(SAVE_URL, 'filename=' + encodeURIComponent(name) +
                        '&xml=' + encodeURIComponent(xml)).simulate(document, '_blank');
                } else {
                    mxUtils.alert(mxResources.get('drawingTooLarge'));
                    mxUtils.popup(xml);

                    return;
                }
            }

            this.editor.setModified(false);
            this.editor.setFilename(name);
            this.updateDocumentTitle();
        } catch (e) {
            this.editor.setStatus(mxUtils.htmlEntities(mxResources.get('errorSavingFile')));
        }
    }
};

/**
 * Executes the given layout.
 */
EditorUi.prototype.executeLayout = function (exec, animate, post) {
    var graph = this.editor.graph;

    if (graph.isEnabled()) {
        graph.getModel().beginUpdate();
        try {
            exec();
        } catch (e) {
            throw e;
        } finally {
            // Animates the changes in the graph model except
            // for Camino, where animation is too slow
            if (this.allowAnimation && animate && navigator.userAgent.indexOf('Camino') < 0) {
                // New API for animating graph layout results asynchronously
                var morph = new mxMorphing(graph);
                morph.addListener(mxEvent.DONE, mxUtils.bind(this, function () {
                    graph.getModel().endUpdate();

                    if (post != null) {
                        post();
                    }
                }));

                morph.startAnimation();
            } else {
                graph.getModel().endUpdate();

                if (post != null) {
                    post();
                }
            }
        }
    }
};

/**
 * Hides the current menu.
 */
EditorUi.prototype.showImageDialog = function (title, value, fn, ignoreExisting) {
    var cellEditor = this.editor.graph.cellEditor;
    var selState = cellEditor.saveSelection();
    var newValue = mxUtils.prompt(title, value);
    cellEditor.restoreSelection(selState);

    if (newValue != null && newValue.length > 0) {
        var img = new Image();

        img.onload = function () {
            fn(newValue, img.width, img.height);
        };
        img.onerror = function () {
            fn(null);
            mxUtils.alert(mxResources.get('fileNotFound'));
        };

        img.src = newValue;
    } else {
        fn(null);
    }
};

/**
 * Hides the current menu.
 */
EditorUi.prototype.showLinkDialog = function (value, btnLabel, fn) {
    var dlg = new LinkDialog(this, value, btnLabel, fn);
    this.showDialog(dlg.container, 420, 90, true, true);
    dlg.init();
};

/**
 * Hides the current menu.
 */
EditorUi.prototype.showDataDialog = function (cell) {
    if (cell != null) {
        var dlg = new EditDataDialog(this, cell);
        this.showDialog(dlg.container, 480, 220, true, false, null, false);
        dlg.init();
    }
};

/**
 * Hides the current menu.
 */
EditorUi.prototype.showBackgroundImageDialog = function (apply) {
    apply = (apply != null) ? apply : mxUtils.bind(this, function (image) {
        var change = new ChangePageSetup(this, null, image);
        change.ignoreColor = true;

        this.editor.graph.model.execute(change);
    });

    var newValue = mxUtils.prompt(mxResources.get('backgroundImage'), '');

    if (newValue != null && newValue.length > 0) {
        var img = new Image();

        img.onload = function () {
            apply(new mxImage(newValue, img.width, img.height));
        };
        img.onerror = function () {
            apply(null);
            mxUtils.alert(mxResources.get('fileNotFound'));
        };

        img.src = newValue;
    } else {
        apply(null);
    }
};

/**
 * Loads the stylesheet for this graph.
 */
EditorUi.prototype.setBackgroundImage = function (image) {
    this.editor.graph.setBackgroundImage(image);
    this.editor.graph.view.validateBackgroundImage();

    this.fireEvent(new mxEventObject('backgroundImageChanged'));
};

/**
 * Creates the keyboard event handler for the current graph and history.
 */
EditorUi.prototype.confirm = function (msg, okFn, cancelFn) {
    if (mxUtils.confirm(msg)) {
        if (okFn != null) {
            okFn();
        }
    } else if (cancelFn != null) {
        cancelFn();
    }
};

/**
 * Creates the keyboard event handler for the current graph and history.
 */
EditorUi.prototype.createOutline = function (wnd) {
    var outline = new mxOutline(this.editor.graph);
    outline.border = 20;

    mxEvent.addListener(window, 'resize', function () {
        outline.update();
    });

    this.addListener('pageFormatChanged', function () {
        outline.update();
    });

    return outline;
};

// Alt+Shift+Keycode mapping to action
EditorUi.prototype.altShiftActions = {
    67: 'clearWaypoints', // Alt+Shift+C
    65: 'connectionArrows', // Alt+Shift+A
    76: 'editLink', // Alt+Shift+L
    80: 'connectionPoints', // Alt+Shift+P
    84: 'editTooltip', // Alt+Shift+T
    86: 'pasteSize', // Alt+Shift+V
    88: 'copySize' // Alt+Shift+X
};

/**
 * Creates the keyboard event handler for the current graph and history.
 */
EditorUi.prototype.createKeyHandler = function (editor) {
    var editorUi = this;
    var graph = this.editor.graph;
    var keyHandler = new mxKeyHandler(graph);

    var isEventIgnored = keyHandler.isEventIgnored;
    keyHandler.isEventIgnored = function (evt) {
        // Handles undo/redo/ctrl+./,/u via action and allows ctrl+b/i only if editing value is HTML (except for FF and Safari)
        return (!this.isControlDown(evt) || mxEvent.isShiftDown(evt) || (evt.keyCode != 90 && evt.keyCode != 89 &&
            evt.keyCode != 188 && evt.keyCode != 190 && evt.keyCode != 85)) && ((evt.keyCode != 66 && evt.keyCode != 73) ||
            !this.isControlDown(evt) || (this.graph.cellEditor.isContentEditing() && !mxClient.IS_FF && !mxClient.IS_SF)) &&
            isEventIgnored.apply(this, arguments);
    };

    // Ignores graph enabled state but not chromeless state
    keyHandler.isEnabledForEvent = function (evt) {
        return (!mxEvent.isConsumed(evt) && this.isGraphEvent(evt) && this.isEnabled() &&
            (editorUi.dialogs == null || editorUi.dialogs.length == 0));
    };

    // Routes command-key to control-key on Mac
    keyHandler.isControlDown = function (evt) {
        return mxEvent.isControlDown(evt) || (mxClient.IS_MAC && evt.metaKey);
    };

    var queue = [];
    var thread = null;

    // Helper function to move cells with the cursor keys
    function nudge(keyCode, stepSize, resize) {
        queue.push(function () {
            if (!graph.isSelectionEmpty() && graph.isEnabled()) {
                stepSize = (stepSize != null) ? stepSize : 1;

                if (resize) {
                    // Resizes all selected vertices
                    graph.getModel().beginUpdate();
                    try {
                        var cells = graph.getSelectionCells();

                        for (var i = 0; i < cells.length; i++) {
                            if (graph.getModel().isVertex(cells[i]) && graph.isCellResizable(cells[i])) {
                                var geo = graph.getCellGeometry(cells[i]);

                                if (geo != null) {
                                    geo = geo.clone();

                                    if (keyCode == 37) {
                                        geo.width = Math.max(0, geo.width - stepSize);
                                    } else if (keyCode == 38) {
                                        geo.height = Math.max(0, geo.height - stepSize);
                                    } else if (keyCode == 39) {
                                        geo.width += stepSize;
                                    } else if (keyCode == 40) {
                                        geo.height += stepSize;
                                    }

                                    graph.getModel().setGeometry(cells[i], geo);
                                }
                            }
                        }
                    } finally {
                        graph.getModel().endUpdate();
                    }
                } else {
                    // Moves vertices up/down in a stack layout
                    var cell = graph.getSelectionCell();
                    var parent = graph.model.getParent(cell);
                    var layout = null;

                    if (graph.getSelectionCount() == 1 && graph.model.isVertex(cell) &&
                        graph.layoutManager != null && !graph.isCellLocked(cell)) {
                        layout = graph.layoutManager.getLayout(parent);
                    }

                    if (layout != null && layout.constructor == mxStackLayout) {
                        var index = parent.getIndex(cell);

                        if (keyCode == 37 || keyCode == 38) {
                            graph.model.add(parent, cell, Math.max(0, index - 1));
                        } else if (keyCode == 39 || keyCode == 40) {
                            graph.model.add(parent, cell, Math.min(graph.model.getChildCount(parent), index + 1));
                        }
                    } else {
                        var dx = 0;
                        var dy = 0;

                        if (keyCode == 37) {
                            dx = -stepSize;
                        } else if (keyCode == 38) {
                            dy = -stepSize;
                        } else if (keyCode == 39) {
                            dx = stepSize;
                        } else if (keyCode == 40) {
                            dy = stepSize;
                        }

                        graph.moveCells(graph.getMovableCells(graph.getSelectionCells()), dx, dy);
                    }
                }
            }
        });

        if (thread != null) {
            window.clearTimeout(thread);
        }

        thread = window.setTimeout(function () {
            if (queue.length > 0) {
                graph.getModel().beginUpdate();
                try {
                    for (var i = 0; i < queue.length; i++) {
                        queue[i]();
                    }

                    queue = [];
                } finally {
                    graph.getModel().endUpdate();
                }
                graph.scrollCellToVisible(graph.getSelectionCell());
            }
        }, 200);
    };

    // Overridden to handle special alt+shift+cursor keyboard shortcuts
    var directions = {
        37: mxConstants.DIRECTION_WEST, 38: mxConstants.DIRECTION_NORTH,
        39: mxConstants.DIRECTION_EAST, 40: mxConstants.DIRECTION_SOUTH
    };

    var keyHandlerGetFunction = keyHandler.getFunction;

    mxKeyHandler.prototype.getFunction = function (evt) {
        if (graph.isEnabled()) {
            // TODO: Add alt modified state in core API, here are some specific cases
            if (mxEvent.isShiftDown(evt) && mxEvent.isAltDown(evt)) {
                var action = editorUi.actions.get(editorUi.altShiftActions[evt.keyCode]);

                if (action != null) {
                    return action.funct;
                }
            }

            if (evt.keyCode == 9 && mxEvent.isAltDown(evt)) {
                if (mxEvent.isShiftDown(evt)) {
                    // Alt+Shift+Tab
                    return function () {
                        graph.selectParentCell();
                    };
                } else {
                    // Alt+Tab
                    return function () {
                        graph.selectChildCell();
                    };
                }
            } else if (directions[evt.keyCode] != null && !graph.isSelectionEmpty()) {
                if (mxEvent.isShiftDown(evt) && mxEvent.isAltDown(evt)) {
                    if (graph.model.isVertex(graph.getSelectionCell())) {
                        return function () {
                            var cells = graph.connectVertex(graph.getSelectionCell(), directions[evt.keyCode],
                                graph.defaultEdgeLength, evt, true);

                            if (cells != null && cells.length > 0) {
                                if (cells.length == 1 && graph.model.isEdge(cells[0])) {
                                    graph.setSelectionCell(graph.model.getTerminal(cells[0], false));
                                } else {
                                    graph.setSelectionCell(cells[cells.length - 1]);
                                }

                                graph.scrollCellToVisible(graph.getSelectionCell());

                                if (editorUi.hoverIcons != null) {
                                    editorUi.hoverIcons.update(graph.view.getState(graph.getSelectionCell()));
                                }
                            }
                        };
                    }
                } else {
                    // Avoids consuming event if no vertex is selected by returning null below
                    // Cursor keys move and resize (ctrl) cells
                    if (this.isControlDown(evt)) {
                        return function () {
                            nudge(evt.keyCode, (mxEvent.isShiftDown(evt)) ? graph.gridSize : null, true);
                        };
                    } else {
                        return function () {
                            nudge(evt.keyCode, (mxEvent.isShiftDown(evt)) ? graph.gridSize : null);
                        };
                    }
                }
            }
        }

        return keyHandlerGetFunction.apply(this, arguments);
    };

    // Binds keystrokes to actions
    keyHandler.bindAction = mxUtils.bind(this, function (code, control, key, shift) {
        var action = this.actions.get(key);

        if (action != null) {
            var f = function () {
                if (action.isEnabled()) {
                    action.funct();
                }
            };

            if (control) {
                if (shift) {
                    keyHandler.bindControlShiftKey(code, f);
                } else {
                    keyHandler.bindControlKey(code, f);
                }
            } else {
                if (shift) {
                    keyHandler.bindShiftKey(code, f);
                } else {
                    keyHandler.bindKey(code, f);
                }
            }
        }
    });

    var ui = this;
    var keyHandlerEscape = keyHandler.escape;
    keyHandler.escape = function (evt) {
        keyHandlerEscape.apply(this, arguments);
    };

    // Ignores enter keystroke. Remove this line if you want the
    // enter keystroke to stop editing. N, W, T are reserved.
    keyHandler.enter = function () {
    };

    keyHandler.bindControlShiftKey(36, function () {
        graph.exitGroup();
    }); // Ctrl+Shift+Home
    keyHandler.bindControlShiftKey(35, function () {
        graph.enterGroup();
    }); // Ctrl+Shift+End
    keyHandler.bindKey(36, function () {
        graph.home();
    }); // Home
    keyHandler.bindKey(35, function () {
        graph.refresh();
    }); // End
    keyHandler.bindAction(107, true, 'zoomIn'); // Ctrl+Plus
    keyHandler.bindAction(109, true, 'zoomOut'); // Ctrl+Minus
    keyHandler.bindAction(80, true, 'print'); // Ctrl+P
    keyHandler.bindAction(79, true, 'outline', true); // Ctrl+Shift+O
    keyHandler.bindAction(112, false, 'about'); // F1

    if (!this.editor.chromeless || this.editor.editable) {
        keyHandler.bindControlKey(36, function () {
            if (graph.isEnabled()) {
                graph.foldCells(true);
            }
        }); // Ctrl+Home
        keyHandler.bindControlKey(35, function () {
            if (graph.isEnabled()) {
                graph.foldCells(false);
            }
        }); // Ctrl+End
        keyHandler.bindControlKey(13, function () {
            if (graph.isEnabled()) {
                graph.setSelectionCells(graph.duplicateCells(graph.getSelectionCells(), false));
            }
        }); // Ctrl+Enter
        keyHandler.bindAction(8, false, 'delete'); // Backspace
        keyHandler.bindAction(8, true, 'deleteAll'); // Backspace
        keyHandler.bindAction(46, false, 'delete'); // Delete
        keyHandler.bindAction(46, true, 'deleteAll'); // Ctrl+Delete
        keyHandler.bindAction(72, true, 'resetView'); // Ctrl+H
        keyHandler.bindAction(72, true, 'fitWindow', true); // Ctrl+Shift+H
        keyHandler.bindAction(74, true, 'fitPage'); // Ctrl+J
        keyHandler.bindAction(74, true, 'fitTwoPages', true); // Ctrl+Shift+J
        keyHandler.bindAction(48, true, 'customZoom'); // Ctrl+0
        keyHandler.bindAction(82, true, 'turn'); // Ctrl+R
        keyHandler.bindAction(82, true, 'clearDefaultStyle', true); // Ctrl+Shift+R
        keyHandler.bindAction(83, true, 'save'); // Ctrl+S
        keyHandler.bindAction(83, true, 'saveAs', true); // Ctrl+Shift+S
        keyHandler.bindAction(65, true, 'selectAll'); // Ctrl+A
        keyHandler.bindAction(65, true, 'selectNone', true); // Ctrl+A
        keyHandler.bindAction(73, true, 'selectVertices', true); // Ctrl+Shift+I
        keyHandler.bindAction(69, true, 'selectEdges', true); // Ctrl+Shift+E
        // keyHandler.bindAction(69, true, 'editStyle'); // Ctrl+E
        keyHandler.bindAction(66, true, 'bold'); // Ctrl+B
        keyHandler.bindAction(66, true, 'toBack', true); // Ctrl+Shift+B
        keyHandler.bindAction(70, true, 'toFront', true); // Ctrl+Shift+F
        keyHandler.bindAction(68, true, 'duplicate'); // Ctrl+D
        keyHandler.bindAction(68, true, 'setAsDefaultStyle', true); // Ctrl+Shift+D
        keyHandler.bindAction(90, true, 'undo'); // Ctrl+Z
        keyHandler.bindAction(89, true, 'autosize', true); // Ctrl+Shift+Y
        keyHandler.bindAction(88, true, 'cut'); // Ctrl+X
        keyHandler.bindAction(67, true, 'copy'); // Ctrl+C
        keyHandler.bindAction(86, true, 'paste'); // Ctrl+V
        keyHandler.bindAction(71, true, 'group'); // Ctrl+G
        keyHandler.bindAction(77, true, 'editData'); // Ctrl+M
        keyHandler.bindAction(71, true, 'grid', true); // Ctrl+Shift+G
        keyHandler.bindAction(73, true, 'italic'); // Ctrl+I
        keyHandler.bindAction(76, true, 'lockUnlock'); // Ctrl+L
        keyHandler.bindAction(76, true, 'layers', true); // Ctrl+Shift+L
        keyHandler.bindAction(80, true, 'formatPanel', true); // Ctrl+Shift+P
        keyHandler.bindAction(85, true, 'underline'); // Ctrl+U
        keyHandler.bindAction(85, true, 'ungroup', true); // Ctrl+Shift+U
        keyHandler.bindAction(190, true, 'superscript'); // Ctrl+.
        keyHandler.bindAction(188, true, 'subscript'); // Ctrl+,
        keyHandler.bindKey(13, function () {
            if (graph.isEnabled()) {
                graph.startEditingAtCell();
            }
        }); // Enter
        keyHandler.bindKey(113, function () {
            if (graph.isEnabled()) {
                graph.startEditingAtCell();
            }
        }); // F2
    }

    if (!mxClient.IS_WIN) {
        keyHandler.bindAction(90, true, 'redo', true); // Ctrl+Shift+Z
    } else {
        keyHandler.bindAction(89, true, 'redo'); // Ctrl+Y
    }

    return keyHandler;
};

/**
 * Creates the keyboard event handler for the current graph and history.
 */
EditorUi.prototype.destroy = function () {
    if (this.editor != null) {
        this.editor.destroy();
        this.editor = null;
    }

    if (this.menubar != null) {
        this.menubar.destroy();
        this.menubar = null;
    }

    if (this.toolbar != null) {
        this.toolbar.destroy();
        this.toolbar = null;
    }

    if (this.sidebar != null) {
        this.sidebar.destroy();
        this.sidebar = null;
    }

    if (this.keyHandler != null) {
        this.keyHandler.destroy();
        this.keyHandler = null;
    }

    if (this.keydownHandler != null) {
        mxEvent.removeListener(document, 'keydown', this.keydownHandler);
        this.keydownHandler = null;
    }

    if (this.keyupHandler != null) {
        mxEvent.removeListener(document, 'keyup', this.keyupHandler);
        this.keyupHandler = null;
    }

    if (this.resizeHandler != null) {
        mxEvent.removeListener(window, 'resize', this.resizeHandler);
        this.resizeHandler = null;
    }

    if (this.gestureHandler != null) {
        mxEvent.removeGestureListeners(document, this.gestureHandler);
        this.gestureHandler = null;
    }

    if (this.orientationChangeHandler != null) {
        mxEvent.removeListener(window, 'orientationchange', this.orientationChangeHandler);
        this.orientationChangeHandler = null;
    }

    if (this.scrollHandler != null) {
        mxEvent.removeListener(window, 'scroll', this.scrollHandler);
        this.scrollHandler = null;
    }

    if (this.destroyFunctions != null) {
        for (var i = 0; i < this.destroyFunctions.length; i++) {
            this.destroyFunctions[i]();
        }

        this.destroyFunctions = null;
    }

    var c = [this.menubarContainer, this.toolbarContainer, this.sidebarContainer,
        this.formatContainer, this.diagramContainer, this.footerContainer,
        this.chromelessToolbar, this.hsplit, this.sidebarFooterContainer,
        this.layersDialog];

    for (var i = 0; i < c.length; i++) {
        if (c[i] != null && c[i].parentNode != null) {
            c[i].parentNode.removeChild(c[i]);
        }
    }
};

/**
 * Copyright (c) 2006-2012, JGraph Ltd
 */
/**
 * Construcs a new sidebar for the given editor.
 */
function Sidebar(editorUi, container) {
    this.editorUi = editorUi;
    this.container = container;
    this.palettes = new Object();
    this.taglist = new Object();
    this.showTooltips = true;
    this.graph = editorUi.createTemporaryGraph(this.editorUi.editor.graph.getStylesheet());
    this.graph.cellRenderer.minSvgStrokeWidth = this.minThumbStrokeWidth;
    this.graph.cellRenderer.antiAlias = this.thumbAntiAlias;
    this.graph.container.style.visibility = 'hidden';
    this.graph.foldingEnabled = false;

    document.body.appendChild(this.graph.container);

    this.pointerUpHandler = mxUtils.bind(this, function () {
        this.showTooltips = true;
    });

    mxEvent.addListener(document, (mxClient.IS_POINTER) ? 'pointerup' : 'mouseup', this.pointerUpHandler);

    this.pointerDownHandler = mxUtils.bind(this, function () {
        this.showTooltips = false;
        this.hideTooltip();
    });

    mxEvent.addListener(document, (mxClient.IS_POINTER) ? 'pointerdown' : 'mousedown', this.pointerDownHandler);

    this.pointerMoveHandler = mxUtils.bind(this, function (evt) {
        var src = mxEvent.getSource(evt);

        while (src != null) {
            if (src == this.currentElt) {
                return;
            }

            src = src.parentNode;
        }

        this.hideTooltip();
    });

    mxEvent.addListener(document, (mxClient.IS_POINTER) ? 'pointermove' : 'mousemove', this.pointerMoveHandler);

    // Handles mouse leaving the window
    this.pointerOutHandler = mxUtils.bind(this, function (evt) {
        if (evt.toElement == null && evt.relatedTarget == null) {
            this.hideTooltip();
        }
    });

    mxEvent.addListener(document, (mxClient.IS_POINTER) ? 'pointerout' : 'mouseout', this.pointerOutHandler);

    // Enables tooltips after scroll
    mxEvent.addListener(container, 'scroll', mxUtils.bind(this, function () {
        this.showTooltips = true;
        this.hideTooltip();
    }));

    this.init();
};

/**
 * Adds all palettes to the sidebar.
 */
Sidebar.prototype.init = function () {
    var dir = STENCIL_PATH;

    this.addSearchPalette(true);
    this.addGeneralPalette(true);
    this.addMiscPalette(false);
    this.addAdvancedPalette(false);
    this.addBasicPalette(dir);
    this.addStencilPalette('arrows', mxResources.get('arrows'), dir + '/arrows.xml',
        ';whiteSpace=wrap;html=1;fillColor=#ffffff;strokeColor=#000000;strokeWidth=2');
    this.addUmlPalette(false);
    this.addBpmnPalette(dir, false);
    this.addStencilPalette('flowchart', 'Flowchart', dir + '/flowchart.xml',
        ';whiteSpace=wrap;html=1;fillColor=#ffffff;strokeColor=#000000;strokeWidth=2');
    this.addImagePalette('clipart', mxResources.get('clipart'), dir + '/clipart/', '_128x128.png',
        ['Earth_globe', 'Empty_Folder', 'Full_Folder', 'Gear', 'Lock', 'Software', 'Virus', 'Email',
            'Database', 'Router_Icon', 'iPad', 'iMac', 'Laptop', 'MacBook', 'Monitor_Tower', 'Printer',
            'Server_Tower', 'Workstation', 'Firewall_02', 'Wireless_Router_N', 'Credit_Card',
            'Piggy_Bank', 'Graph', 'Safe', 'Shopping_Cart', 'Suit1', 'Suit2', 'Suit3', 'Pilot1',
            'Worker1', 'Soldier1', 'Doctor1', 'Tech1', 'Security1', 'Telesales1'], null,
        {
            'Wireless_Router_N': 'wireless router switch wap wifi access point wlan',
            'Router_Icon': 'router switch'
        });
};

/**
 * Sets the default font size.
 */
Sidebar.prototype.collapsedImage = (!mxClient.IS_SVG) ? IMAGE_PATH + '/collapsed.gif' : 'data:image/gif;base64,R0lGODlhDQANAIABAJmZmf///yH/C1hNUCBEYXRhWE1QPD94cGFja2V0IGJlZ2luPSLvu78iIGlkPSJXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQiPz4gPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iQWRvYmUgWE1QIENvcmUgNS4wLWMwNjAgNjEuMTM0Nzc3LCAyMDEwLzAyLzEyLTE3OjMyOjAwICAgICAgICAiPiA8cmRmOlJERiB4bWxuczpyZGY9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkvMDIvMjItcmRmLXN5bnRheC1ucyMiPiA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozNUQyRTJFNjZGNUYxMUU1QjZEOThCNDYxMDQ2MzNCQiIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozNUQyRTJFNzZGNUYxMUU1QjZEOThCNDYxMDQ2MzNCQiI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOjFERjc3MEUxNkY1RjExRTVCNkQ5OEI0NjEwNDYzM0JCIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjFERjc3MEUyNkY1RjExRTVCNkQ5OEI0NjEwNDYzM0JCIi8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+Af/+/fz7+vn49/b19PPy8fDv7u3s6+rp6Ofm5eTj4uHg397d3Nva2djX1tXU09LR0M/OzczLysnIx8bFxMPCwcC/vr28u7q5uLe2tbSzsrGwr66trKuqqainpqWko6KhoJ+enZybmpmYl5aVlJOSkZCPjo2Mi4qJiIeGhYSDgoGAf359fHt6eXh3dnV0c3JxcG9ubWxramloZ2ZlZGNiYWBfXl1cW1pZWFdWVVRTUlFQT05NTEtKSUhHRkVEQ0JBQD8+PTw7Ojk4NzY1NDMyMTAvLi0sKyopKCcmJSQjIiEgHx4dHBsaGRgXFhUUExIREA8ODQwLCgkIBwYFBAMCAQAAIfkEAQAAAQAsAAAAAA0ADQAAAhSMj6lrwAjcC1GyahV+dcZJgeIIFgA7';

/**
 * Sets the default font size.
 */
Sidebar.prototype.expandedImage = (!mxClient.IS_SVG) ? IMAGE_PATH + '/expanded.gif' : 'data:image/gif;base64,R0lGODlhDQANAIABAJmZmf///yH/C1hNUCBEYXRhWE1QPD94cGFja2V0IGJlZ2luPSLvu78iIGlkPSJXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQiPz4gPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iQWRvYmUgWE1QIENvcmUgNS4wLWMwNjAgNjEuMTM0Nzc3LCAyMDEwLzAyLzEyLTE3OjMyOjAwICAgICAgICAiPiA8cmRmOlJERiB4bWxuczpyZGY9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkvMDIvMjItcmRmLXN5bnRheC1ucyMiPiA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDoxREY3NzBERjZGNUYxMUU1QjZEOThCNDYxMDQ2MzNCQiIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDoxREY3NzBFMDZGNUYxMUU1QjZEOThCNDYxMDQ2MzNCQiI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOjFERjc3MERENkY1RjExRTVCNkQ5OEI0NjEwNDYzM0JCIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjFERjc3MERFNkY1RjExRTVCNkQ5OEI0NjEwNDYzM0JCIi8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+Af/+/fz7+vn49/b19PPy8fDv7u3s6+rp6Ofm5eTj4uHg397d3Nva2djX1tXU09LR0M/OzczLysnIx8bFxMPCwcC/vr28u7q5uLe2tbSzsrGwr66trKuqqainpqWko6KhoJ+enZybmpmYl5aVlJOSkZCPjo2Mi4qJiIeGhYSDgoGAf359fHt6eXh3dnV0c3JxcG9ubWxramloZ2ZlZGNiYWBfXl1cW1pZWFdWVVRTUlFQT05NTEtKSUhHRkVEQ0JBQD8+PTw7Ojk4NzY1NDMyMTAvLi0sKyopKCcmJSQjIiEgHx4dHBsaGRgXFhUUExIREA8ODQwLCgkIBwYFBAMCAQAAIfkEAQAAAQAsAAAAAA0ADQAAAhGMj6nL3QAjVHIu6azbvPtWAAA7';

/**
 *
 */
Sidebar.prototype.searchImage = (!mxClient.IS_SVG) ? IMAGE_PATH + '/search.png' : 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAwAAAAMCAYAAABWdVznAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAIGNIUk0AAHolAACAgwAA+f8AAIDpAAB1MAAA6mAAADqYAAAXb5JfxUYAAAEaSURBVHjabNGxS5VxFIfxz71XaWuQUJCG/gCHhgTD9VpEETg4aMOlQRp0EoezObgcd220KQiXmpretTAHQRBdojlQEJyukPdt+b1ywfvAGc7wnHP4nlZd1yKijQW8xzNc4Su+ZOYfQ3T6/f4YNvEJYzjELXp4VVXVz263+7cR2niBxAFeZ2YPi3iHR/gYERPDwhpOsd6sz8x/mfkNG3iOlWFhFj8y89J9KvzGXER0GuEaD42mgwHqUtoljbcRsTBCeINpfM/MgZLKPpaxFxGbOCqDXmILN7hoJrTKH+axhxmcYRxP0MIDnOBDZv5q1XUNIuJxifJp+UNV7t7BFM6xeic0RMQ4Bpl5W/ol7GISx/eEUUTECrbx+f8A8xhiZht9zsgAAAAASUVORK5CYII=';

/**
 *
 */
Sidebar.prototype.dragPreviewBorder = '1px dashed black';

/**
 * Specifies if tooltips should be visible. Default is true.
 */
Sidebar.prototype.enableTooltips = true;

/**
 * Specifies the delay for the tooltip. Default is 16 px.
 */
Sidebar.prototype.tooltipBorder = 16;

/**
 * Specifies the delay for the tooltip. Default is 300 ms.
 */
Sidebar.prototype.tooltipDelay = 300;

/**
 * Specifies the delay for the drop target icons. Default is 200 ms.
 */
Sidebar.prototype.dropTargetDelay = 200;

/**
 * Specifies the URL of the gear image.
 */
Sidebar.prototype.gearImage = STENCIL_PATH + '/clipart/Gear_128x128.png';

/**
 * Specifies the width of the thumbnails.
 */
Sidebar.prototype.thumbWidth = 42;

/**
 * Specifies the height of the thumbnails.
 */
Sidebar.prototype.thumbHeight = 42;

/**
 * Specifies the width of the thumbnails.
 */
Sidebar.prototype.minThumbStrokeWidth = 1;

/**
 * Specifies the width of the thumbnails.
 */
Sidebar.prototype.thumbAntiAlias = false;

/**
 * Specifies the padding for the thumbnails. Default is 3.
 */
Sidebar.prototype.thumbPadding = (document.documentMode >= 5) ? 2 : 3;

/**
 * Specifies the delay for the tooltip. Default is 2 px.
 */
Sidebar.prototype.thumbBorder = 2;

/*
 * Experimental smaller sidebar entries
 */
if (urlParams['sidebar-entries'] != 'large') {
    Sidebar.prototype.thumbPadding = (document.documentMode >= 5) ? 0 : 1;
    Sidebar.prototype.thumbBorder = 1;
    Sidebar.prototype.thumbWidth = 32;
    Sidebar.prototype.thumbHeight = 30;
    Sidebar.prototype.minThumbStrokeWidth = 1.3;
    Sidebar.prototype.thumbAntiAlias = true;
}

/**
 * Specifies the size of the sidebar titles.
 */
Sidebar.prototype.sidebarTitleSize = 9;

/**
 * Specifies if titles in the sidebar should be enabled.
 */
Sidebar.prototype.sidebarTitles = false;

/**
 * Specifies if titles in the tooltips should be enabled.
 */
Sidebar.prototype.tooltipTitles = true;

/**
 * Specifies if titles in the tooltips should be enabled.
 */
Sidebar.prototype.maxTooltipWidth = 400;

/**
 * Specifies if titles in the tooltips should be enabled.
 */
Sidebar.prototype.maxTooltipHeight = 400;

/**
 * Specifies if stencil files should be loaded and added to the search index
 * when stencil palettes are added. If this is false then the stencil files
 * are lazy-loaded when the palette is shown.
 */
Sidebar.prototype.addStencilsToIndex = true;

/**
 * Specifies the width for clipart images. Default is 80.
 */
Sidebar.prototype.defaultImageWidth = 80;

/**
 * Specifies the height for clipart images. Default is 80.
 */
Sidebar.prototype.defaultImageHeight = 80;

/**
 * Adds all palettes to the sidebar.
 */
Sidebar.prototype.getTooltipOffset = function () {
    return new mxPoint(0, 0);
};

/**
 * Adds all palettes to the sidebar.
 */
Sidebar.prototype.showTooltip = function (elt, cells, w, h, title, showLabel) {
    if (this.enableTooltips && this.showTooltips) {
        if (this.currentElt != elt) {
            if (this.thread != null) {
                window.clearTimeout(this.thread);
                this.thread = null;
            }

            var show = mxUtils.bind(this, function () {
                // Lazy creation of the DOM nodes and graph instance
                if (this.tooltip == null) {
                    this.tooltip = document.createElement('div');
                    this.tooltip.className = 'geSidebarTooltip';
                    this.tooltip.style.zIndex = mxPopupMenu.prototype.zIndex - 1;
                    document.body.appendChild(this.tooltip);

                    this.graph2 = new Graph(this.tooltip, null, null, this.editorUi.editor.graph.getStylesheet());
                    this.graph2.resetViewOnRootChange = false;
                    this.graph2.foldingEnabled = false;
                    this.graph2.gridEnabled = false;
                    this.graph2.autoScroll = false;
                    this.graph2.setTooltips(false);
                    this.graph2.setConnectable(false);
                    this.graph2.setEnabled(false);

                    if (!mxClient.IS_SVG) {
                        this.graph2.view.canvas.style.position = 'relative';
                    }
                }

                this.graph2.model.clear();
                this.graph2.view.setTranslate(this.tooltipBorder, this.tooltipBorder);

                if (w > this.maxTooltipWidth || h > this.maxTooltipHeight) {
                    this.graph2.view.scale = Math.round(Math.min(this.maxTooltipWidth / w, this.maxTooltipHeight / h) * 100) / 100;
                } else {
                    this.graph2.view.scale = 1;
                }

                this.tooltip.style.display = 'block';
                this.graph2.labelsVisible = (showLabel == null || showLabel);
                var fo = mxClient.NO_FO;
                mxClient.NO_FO = Editor.prototype.originalNoForeignObject;
                this.graph2.addCells(cells);
                mxClient.NO_FO = fo;

                var bounds = this.graph2.getGraphBounds();
                var width = bounds.width + 2 * this.tooltipBorder + 4;
                var height = bounds.height + 2 * this.tooltipBorder;

                if (mxClient.IS_QUIRKS) {
                    height += 4;
                    this.tooltip.style.overflow = 'hidden';
                } else {
                    this.tooltip.style.overflow = 'visible';
                }

                this.tooltip.style.width = width + 'px';
                var w2 = width;

                // Adds title for entry
                if (this.tooltipTitles && title != null && title.length > 0) {
                    if (this.tooltipTitle == null) {
                        this.tooltipTitle = document.createElement('div');
                        this.tooltipTitle.style.borderTop = '1px solid gray';
                        this.tooltipTitle.style.textAlign = 'center';
                        this.tooltipTitle.style.width = '100%';
                        this.tooltipTitle.style.overflow = 'hidden';
                        this.tooltipTitle.style.position = 'absolute';
                        this.tooltipTitle.style.paddingTop = '6px';
                        this.tooltipTitle.style.bottom = '6px';

                        this.tooltip.appendChild(this.tooltipTitle);
                    } else {
                        this.tooltipTitle.innerHTML = '';
                    }

                    this.tooltipTitle.style.display = '';
                    mxUtils.write(this.tooltipTitle, title);

                    // Allows for wider labels
                    w2 = Math.min(this.maxTooltipWidth, Math.max(width, this.tooltipTitle.scrollWidth + 4));
                    var ddy = this.tooltipTitle.offsetHeight + 10;
                    height += ddy;

                    if (mxClient.IS_SVG) {
                        this.tooltipTitle.style.marginTop = (2 - ddy) + 'px';
                    } else {
                        height -= 6;
                        this.tooltipTitle.style.top = (height - ddy) + 'px';
                    }
                } else if (this.tooltipTitle != null && this.tooltipTitle.parentNode != null) {
                    this.tooltipTitle.style.display = 'none';
                }

                // Updates width if label is wider
                if (w2 > width) {
                    this.tooltip.style.width = w2 + 'px';
                }

                this.tooltip.style.height = height + 'px';
                var x0 = -Math.round(bounds.x - this.tooltipBorder) + (w2 - width) / 2;
                var y0 = -Math.round(bounds.y - this.tooltipBorder);

                var b = document.body;
                var d = document.documentElement;
                var off = this.getTooltipOffset();
                var bottom = Math.max(b.clientHeight || 0, d.clientHeight);
                var left = this.container.clientWidth + this.editorUi.splitSize + 3 + this.editorUi.container.offsetLeft + off.x;
                var top = Math.min(bottom - height - 20 /*status bar*/, Math.max(0, (this.editorUi.container.offsetTop +
                    this.container.offsetTop + elt.offsetTop - this.container.scrollTop - height / 2 + 16))) + off.y;

                if (mxClient.IS_SVG) {
                    if (x0 != 0 || y0 != 0) {
                        this.graph2.view.canvas.setAttribute('transform', 'translate(' + x0 + ',' + y0 + ')');
                    } else {
                        this.graph2.view.canvas.removeAttribute('transform');
                    }
                } else {
                    this.graph2.view.drawPane.style.left = x0 + 'px';
                    this.graph2.view.drawPane.style.top = y0 + 'px';
                }

                // Workaround for ignored position CSS style in IE9
                // (changes to relative without the following line)
                this.tooltip.style.position = 'absolute';
                this.tooltip.style.left = left + 'px';
                this.tooltip.style.top = top + 'px';
            });

            if (this.tooltip != null && this.tooltip.style.display != 'none') {
                show();
            } else {
                this.thread = window.setTimeout(show, this.tooltipDelay);
            }

            this.currentElt = elt;
        }
    }
};

/**
 * Hides the current tooltip.
 */
Sidebar.prototype.hideTooltip = function () {
    if (this.thread != null) {
        window.clearTimeout(this.thread);
        this.thread = null;
    }

    if (this.tooltip != null) {
        this.tooltip.style.display = 'none';
        this.currentElt = null;
    }
};

/**
 * Hides the current tooltip.
 */
Sidebar.prototype.addDataEntry = function (tags, width, height, title, data) {
    return this.addEntry(tags, mxUtils.bind(this, function () {
        return this.createVertexTemplateFromData(data, width, height, title);
    }));
};

/**
 * Adds the give entries to the search index.
 */
Sidebar.prototype.addEntries = function (images) {
    for (var i = 0; i < images.length; i++) {
        (mxUtils.bind(this, function (img) {
            var data = img.data;

            if (data != null && img.title != null) {
                this.addEntry(img.title, mxUtils.bind(this, function () {
                    data = this.editorUi.convertDataUri(data);
                    var s = 'shape=image;verticalLabelPosition=bottom;verticalAlign=top;imageAspect=0;';

                    if (img.aspect == 'fixed') {
                        s += 'aspect=fixed;'
                    }

                    return this.createVertexTemplate(s + 'image=' +
                        data, img.w, img.h, '', img.title || '', false, false, true)
                }));
            } else if (img.xml != null && img.title != null) {
                this.addEntry(img.title, mxUtils.bind(this, function () {
                    var cells = this.editorUi.stringToCells(Graph.decompress(img.xml));

                    return this.createVertexTemplateFromCells(
                        cells, img.w, img.h, img.title || '', true, false, true);
                }));
            }
        }))(images[i]);
    }
};

/**
 * Hides the current tooltip.
 */
Sidebar.prototype.addEntry = function (tags, fn) {
    if (this.taglist != null && tags != null && tags.length > 0) {
        // Replaces special characters
        var tmp = tags.toLowerCase().replace(/[\/\,\(\)]/g, ' ').split(' ');

        var doAddEntry = mxUtils.bind(this, function (tag) {
            if (tag != null && tag.length > 1) {
                var entry = this.taglist[tag];

                if (typeof entry !== 'object') {
                    entry = {entries: [], dict: new mxDictionary()};
                    this.taglist[tag] = entry;
                }

                // Ignores duplicates
                if (entry.dict.get(fn) == null) {
                    entry.dict.put(fn, fn);
                    entry.entries.push(fn);
                }
            }
        });

        for (var i = 0; i < tmp.length; i++) {
            doAddEntry(tmp[i]);

            // Adds additional entry with removed trailing numbers
            var normalized = tmp[i].replace(/\.*\d*$/, '');

            if (normalized != tmp[i]) {
                doAddEntry(normalized);
            }
        }
    }

    return fn;
};

/**
 * Adds shape search UI.
 */
Sidebar.prototype.searchEntries = function (searchTerms, count, page, success, error) {
    if (this.taglist != null && searchTerms != null) {
        var tmp = searchTerms.toLowerCase().split(' ');
        var dict = new mxDictionary();
        var max = (page + 1) * count;
        var results = [];
        var index = 0;

        for (var i = 0; i < tmp.length; i++) {
            if (tmp[i].length > 0) {
                var entry = this.taglist[tmp[i]];
                var tmpDict = new mxDictionary();

                if (entry != null) {
                    var arr = entry.entries;
                    results = [];

                    for (var j = 0; j < arr.length; j++) {
                        var entry = arr[j];

                        // NOTE Array does not contain duplicates
                        if ((index == 0) == (dict.get(entry) == null)) {
                            tmpDict.put(entry, entry);
                            results.push(entry);

                            if (i == tmp.length - 1 && results.length == max) {
                                success(results.slice(page * count, max), max, true, tmp);

                                return;
                            }
                        }
                    }
                } else {
                    results = [];
                }

                dict = tmpDict;
                index++;
            }
        }

        var len = results.length;
        success(results.slice(page * count, (page + 1) * count), len, false, tmp);
    } else {
        success([], null, null, tmp);
    }
};

/**
 * Adds shape search UI.
 */
Sidebar.prototype.filterTags = function (tags) {
    if (tags != null) {
        var arr = tags.split(' ');
        var result = [];
        var hash = {};

        // Ignores tags with leading numbers, strips trailing numbers
        for (var i = 0; i < arr.length; i++) {
            // Removes duplicates
            if (hash[arr[i]] == null) {
                hash[arr[i]] = '1';
                result.push(arr[i]);
            }
        }

        return result.join(' ');
    }

    return null;
};

/**
 * Adds the general palette to the sidebar.
 */
Sidebar.prototype.cloneCell = function (cell, value) {
    var clone = cell.clone();

    if (value != null) {
        clone.value = value;
    }

    return clone;
};

/**
 * Adds shape search UI.
 */
Sidebar.prototype.addSearchPalette = function (expand) {
    var elt = document.createElement('div');
    elt.style.visibility = 'hidden';
    this.container.appendChild(elt);

    var div = document.createElement('div');
    div.className = 'geSidebar';
    div.style.boxSizing = 'border-box';
    div.style.overflow = 'hidden';
    div.style.width = '100%';
    div.style.padding = '8px';
    div.style.paddingTop = '14px';
    div.style.paddingBottom = '0px';

    if (!expand) {
        div.style.display = 'none';
    }

    var inner = document.createElement('div');
    inner.style.whiteSpace = 'nowrap';
    inner.style.textOverflow = 'clip';
    inner.style.paddingBottom = '8px';
    inner.style.cursor = 'default';

    var input = document.createElement('input');
    input.setAttribute('placeholder', mxResources.get('searchShapes'));
    input.setAttribute('type', 'text');
    input.style.fontSize = '12px';
    input.style.overflow = 'hidden';
    input.style.boxSizing = 'border-box';
    input.style.border = 'solid 1px #d5d5d5';
    input.style.borderRadius = '4px';
    input.style.width = '100%';
    input.style.outline = 'none';
    input.style.padding = '6px';
    input.style.paddingRight = '20px';
    inner.appendChild(input);

    var cross = document.createElement('img');
    cross.setAttribute('src', Sidebar.prototype.searchImage);
    cross.setAttribute('title', mxResources.get('search'));
    cross.style.position = 'relative';
    cross.style.left = '-18px';

    if (mxClient.IS_QUIRKS) {
        input.style.height = '28px';
        cross.style.top = '-4px';
    } else {
        cross.style.top = '1px';
    }

    // Needed to block event transparency in IE
    cross.style.background = 'url(\'' + this.editorUi.editor.transparentImage + '\')';

    var find;

    inner.appendChild(cross);
    div.appendChild(inner);

    var center = document.createElement('center');
    var button = mxUtils.button(mxResources.get('moreResults'), function () {
        find();
    });
    button.style.display = 'none';

    // Workaround for inherited line-height in quirks mode
    button.style.lineHeight = 'normal';
    button.style.marginTop = '4px';
    button.style.marginBottom = '8px';
    center.style.paddingTop = '4px';
    center.style.paddingBottom = '4px';

    center.appendChild(button);
    div.appendChild(center);

    var searchTerm = '';
    var active = false;
    var complete = false;
    var page = 0;
    var hash = new Object();

    // Count is dynamically updated below
    var count = 12;

    var clearDiv = mxUtils.bind(this, function () {
        active = false;
        this.currentSearch = null;
        var child = div.firstChild;

        while (child != null) {
            var next = child.nextSibling;

            if (child != inner && child != center) {
                child.parentNode.removeChild(child);
            }

            child = next;
        }
    });

    mxEvent.addListener(cross, 'click', function () {
        if (cross.getAttribute('src') == Dialog.prototype.closeImage) {
            cross.setAttribute('src', Sidebar.prototype.searchImage);
            cross.setAttribute('title', mxResources.get('search'));
            button.style.display = 'none';
            input.value = '';
            searchTerm = '';
            clearDiv();
        }

        input.focus();
    });

    find = mxUtils.bind(this, function () {
        // Shows 4 rows (minimum 4 results)
        count = 4 * Math.max(1, Math.floor(this.container.clientWidth / (this.thumbWidth + 10)));
        this.hideTooltip();

        if (input.value != '') {
            if (center.parentNode != null) {
                if (searchTerm != input.value) {
                    clearDiv();
                    searchTerm = input.value;
                    hash = new Object();
                    complete = false;
                    page = 0;
                }

                if (!active && !complete) {
                    button.setAttribute('disabled', 'true');
                    button.style.display = '';
                    button.style.cursor = 'wait';
                    button.innerHTML = mxResources.get('loading') + '...';
                    active = true;

                    // Ignores old results
                    var current = new Object();
                    this.currentSearch = current;

                    this.searchEntries(searchTerm, count, page, mxUtils.bind(this, function (results, len, more, terms) {
                        if (this.currentSearch == current) {
                            results = (results != null) ? results : [];
                            active = false;
                            page++;
                            this.insertSearchHint(div, searchTerm, count, page, results, len, more, terms);

                            // Allows to repeat the search
                            if (results.length == 0 && page == 1) {
                                searchTerm = '';
                            }

                            if (center.parentNode != null) {
                                center.parentNode.removeChild(center);
                            }

                            for (var i = 0; i < results.length; i++) {
                                try {
                                    var elt = results[i]();

                                    // Avoids duplicates in results
                                    if (hash[elt.innerHTML] == null) {
                                        hash[elt.innerHTML] = '1';
                                        div.appendChild(elt);
                                    }
                                } catch (e) {
                                    // ignore
                                }
                            }

                            if (more) {
                                button.removeAttribute('disabled');
                                button.innerHTML = mxResources.get('moreResults');
                            } else {
                                button.innerHTML = mxResources.get('reset');
                                button.style.display = 'none';
                                complete = true;
                            }

                            button.style.cursor = '';
                            div.appendChild(center);
                        }
                    }), mxUtils.bind(this, function () {
                        // TODO: Error handling
                        button.style.cursor = '';
                    }));
                }
            }
        } else {
            clearDiv();
            input.value = '';
            searchTerm = '';
            hash = new Object();
            button.style.display = 'none';
            complete = false;
            input.focus();
        }
    });

    mxEvent.addListener(input, 'keydown', mxUtils.bind(this, function (evt) {
        if (evt.keyCode == 13 /* Enter */) {
            find();
            mxEvent.consume(evt);
        }
    }));

    mxEvent.addListener(input, 'keyup', mxUtils.bind(this, function (evt) {
        if (input.value == '') {
            cross.setAttribute('src', Sidebar.prototype.searchImage);
            cross.setAttribute('title', mxResources.get('search'));
        } else {
            cross.setAttribute('src', Dialog.prototype.closeImage);
            cross.setAttribute('title', mxResources.get('reset'));
        }

        if (input.value == '') {
            complete = true;
            button.style.display = 'none';
        } else if (input.value != searchTerm) {
            button.style.display = 'none';
            complete = false;
        } else if (!active) {
            if (complete) {
                button.style.display = 'none';
            } else {
                button.style.display = '';
            }
        }
    }));

    // Workaround for blocked text selection in Editor
    mxEvent.addListener(input, 'mousedown', function (evt) {
        if (evt.stopPropagation) {
            evt.stopPropagation();
        }

        evt.cancelBubble = true;
    });

    // Workaround for blocked text selection in Editor
    mxEvent.addListener(input, 'selectstart', function (evt) {
        if (evt.stopPropagation) {
            evt.stopPropagation();
        }

        evt.cancelBubble = true;
    });

    var outer = document.createElement('div');
    outer.appendChild(div);
    this.container.appendChild(outer);

    // Keeps references to the DOM nodes
    this.palettes['search'] = [elt, outer];
};

/**
 * Adds the general palette to the sidebar.
 */
Sidebar.prototype.insertSearchHint = function (div, searchTerm, count, page, results, len, more, terms) {
    if (results.length == 0 && page == 1) {
        var err = document.createElement('div');
        err.className = 'geTitle';
        err.style.cssText = 'background-color:transparent;border-color:transparent;' +
            'color:gray;padding:6px 0px 0px 0px !important;margin:4px 8px 4px 8px;' +
            'text-align:center;cursor:default !important';

        mxUtils.write(err, mxResources.get('noResultsFor', [searchTerm]));
        div.appendChild(err);
    }
};

/**
 * Adds the general palette to the sidebar.
 */
Sidebar.prototype.addGeneralPalette = function (expand) {
    var lineTags = 'line lines connector connectors connection connections arrow arrows ';

    var fns = [
        this.createVertexTemplateEntry('rounded=0;whiteSpace=wrap;html=1;', 120, 60, '', 'Rectangle', null, null, 'rect rectangle box'),
        this.createVertexTemplateEntry('rounded=1;whiteSpace=wrap;html=1;', 120, 60, '', 'Rounded Rectangle', null, null, 'rounded rect rectangle box'),
        // Explicit strokecolor/fillcolor=none is a workaround to maintain transparent background regardless of current style
        this.createVertexTemplateEntry('text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;',
            40, 20, 'Text', 'Text', null, null, 'text textbox textarea label'),
        this.createVertexTemplateEntry('text;html=1;strokeColor=none;fillColor=none;spacing=5;spacingTop=-20;whiteSpace=wrap;overflow=hidden;rounded=0;', 190, 120,
            '<h1>Heading</h1><p>Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.</p>',
            'Textbox', null, null, 'text textbox textarea'),
        this.createVertexTemplateEntry('ellipse;whiteSpace=wrap;html=1;', 120, 80, '', 'Ellipse', null, null, 'oval ellipse state'),
        this.createVertexTemplateEntry('whiteSpace=wrap;html=1;aspect=fixed;', 80, 80, '', 'Square', null, null, 'square'),
        this.createVertexTemplateEntry('ellipse;whiteSpace=wrap;html=1;aspect=fixed;', 80, 80, '', 'Circle', null, null, 'circle'),
        this.createVertexTemplateEntry('shape=process;whiteSpace=wrap;html=1;backgroundOutline=1;', 120, 60, '', 'Process', null, null, 'process task'),
        this.createVertexTemplateEntry('rhombus;whiteSpace=wrap;html=1;', 80, 80, '', 'Diamond', null, null, 'diamond rhombus if condition decision conditional question test'),
        this.createVertexTemplateEntry('shape=parallelogram;perimeter=parallelogramPerimeter;whiteSpace=wrap;html=1;', 120, 60, '', 'Parallelogram'),
        this.createVertexTemplateEntry('shape=hexagon;perimeter=hexagonPerimeter2;whiteSpace=wrap;html=1;', 120, 80, '', 'Hexagon', null, null, 'hexagon preparation'),
        this.createVertexTemplateEntry('triangle;whiteSpace=wrap;html=1;', 60, 80, '', 'Triangle', null, null, 'triangle logic inverter buffer'),
        this.createVertexTemplateEntry('shape=cylinder;whiteSpace=wrap;html=1;boundedLbl=1;backgroundOutline=1;', 60, 80, '', 'Cylinder', null, null, 'cylinder data database'),
        this.createVertexTemplateEntry('ellipse;shape=cloud;whiteSpace=wrap;html=1;', 120, 80, '', 'Cloud', null, null, 'cloud network'),
        this.createVertexTemplateEntry('shape=document;whiteSpace=wrap;html=1;boundedLbl=1;', 120, 80, '', 'Document'),
        this.createVertexTemplateEntry('shape=internalStorage;whiteSpace=wrap;html=1;backgroundOutline=1;', 80, 80, '', 'Internal Storage'),
        this.createVertexTemplateEntry('shape=cube;whiteSpace=wrap;html=1;boundedLbl=1;backgroundOutline=1;darkOpacity=0.05;darkOpacity2=0.1;', 120, 80, '', 'Cube'),
        this.createVertexTemplateEntry('shape=step;perimeter=stepPerimeter;whiteSpace=wrap;html=1;fixedSize=1;', 120, 80, '', 'Step'),
        this.createVertexTemplateEntry('shape=trapezoid;perimeter=trapezoidPerimeter;whiteSpace=wrap;html=1;', 120, 60, '', 'Trapezoid'),
        this.createVertexTemplateEntry('shape=tape;whiteSpace=wrap;html=1;', 120, 100, '', 'Tape'),
        this.createVertexTemplateEntry('shape=note;whiteSpace=wrap;html=1;backgroundOutline=1;darkOpacity=0.05;', 80, 100, '', 'Note'),
        this.createVertexTemplateEntry('shape=card;whiteSpace=wrap;html=1;', 80, 100, '', 'Card'),
        this.createVertexTemplateEntry('shape=callout;whiteSpace=wrap;html=1;perimeter=calloutPerimeter;', 120, 80, '', 'Callout', null, null, 'bubble chat thought speech message'),
        this.createVertexTemplateEntry('shape=umlActor;verticalLabelPosition=bottom;labelBackgroundColor=#ffffff;verticalAlign=top;html=1;outlineConnect=0;', 30, 60, 'Actor', 'Actor', false, null, 'user person human stickman'),
        this.createVertexTemplateEntry('shape=xor;whiteSpace=wrap;html=1;', 60, 80, '', 'Or', null, null, 'logic or'),
        this.createVertexTemplateEntry('shape=or;whiteSpace=wrap;html=1;', 60, 80, '', 'And', null, null, 'logic and'),
        this.createVertexTemplateEntry('shape=dataStorage;whiteSpace=wrap;html=1;', 100, 80, '', 'Data Storage'),
        this.addEntry('curve', mxUtils.bind(this, function () {
            var cell = new mxCell('', new mxGeometry(0, 0, 50, 50), 'curved=1;endArrow=classic;html=1;');
            cell.geometry.setTerminalPoint(new mxPoint(0, 50), true);
            cell.geometry.setTerminalPoint(new mxPoint(50, 0), false);
            cell.geometry.points = [new mxPoint(50, 50), new mxPoint(0, 0)];
            cell.geometry.relative = true;
            cell.edge = true;

            return this.createEdgeTemplateFromCells([cell], cell.geometry.width, cell.geometry.height, 'Curve');
        })),
        this.createEdgeTemplateEntry('shape=flexArrow;endArrow=classic;startArrow=classic;html=1;', 50, 50, '', 'Bidirectional Arrow', null, lineTags + 'bidirectional'),
        this.createEdgeTemplateEntry('shape=flexArrow;endArrow=classic;html=1;', 50, 50, '', 'Arrow', null, lineTags + 'directional directed'),
        this.createEdgeTemplateEntry('shape=link;html=1;', 50, 50, '', 'Link', null, lineTags + 'link'),
        this.createEdgeTemplateEntry('endArrow=none;dashed=1;html=1;', 50, 50, '', 'Dashed Line', null, lineTags + 'dashed undirected no'),
        this.createEdgeTemplateEntry('endArrow=none;html=1;', 50, 50, '', 'Line', null, lineTags + 'simple undirected plain blank no'),
        this.createEdgeTemplateEntry('endArrow=classic;startArrow=classic;html=1;', 50, 50, '', 'Bidirectional Connector', null, lineTags + 'bidirectional'),
        this.createEdgeTemplateEntry('endArrow=classic;html=1;', 50, 50, '', 'Directional Connector', null, lineTags + 'directional directed')
    ];

    this.addPaletteFunctions('general', mxResources.get('general'), (expand != null) ? expand : true, fns);
};

/**
 * Adds the general palette to the sidebar.
 */
Sidebar.prototype.addBasicPalette = function (dir) {
    this.addStencilPalette('basic', mxResources.get('basic'), dir + '/basic.xml',
        ';whiteSpace=wrap;html=1;fillColor=#ffffff;strokeColor=#000000;strokeWidth=2',
        null, null, null, null, [
            this.createVertexTemplateEntry('shape=partialRectangle;whiteSpace=wrap;html=1;top=0;bottom=0;fillColor=none;', 120, 60, '', 'Partial Rectangle'),
            this.createVertexTemplateEntry('shape=partialRectangle;whiteSpace=wrap;html=1;right=0;top=0;bottom=0;fillColor=none;routingCenterX=-0.5;', 120, 60, '', 'Partial Rectangle'),
            this.createVertexTemplateEntry('shape=partialRectangle;whiteSpace=wrap;html=1;bottom=0;right=0;fillColor=none;', 120, 60, '', 'Partial Rectangle'),
            this.createVertexTemplateEntry('shape=partialRectangle;whiteSpace=wrap;html=1;top=0;left=0;fillColor=none;', 120, 60, '', 'Partial Rectangle')
        ]);
};

/**
 * Adds the general palette to the sidebar.
 */
Sidebar.prototype.addMiscPalette = function (expand) {
    var sb = this;
    var lineTags = 'line lines connector connectors connection connections arrow arrows '

    var fns = [
        this.createVertexTemplateEntry('text;strokeColor=none;fillColor=none;html=1;fontSize=24;fontStyle=1;verticalAlign=middle;align=center;', 100, 40, 'Title', 'Title', null, null, 'text heading title'),
        this.createVertexTemplateEntry('text;strokeColor=none;fillColor=none;html=1;whiteSpace=wrap;verticalAlign=middle;overflow=hidden;', 100, 80,
            '<ul><li>Value 1</li><li>Value 2</li><li>Value 3</li></ul>', 'Unordered List'),
        this.createVertexTemplateEntry('text;strokeColor=none;fillColor=none;html=1;whiteSpace=wrap;verticalAlign=middle;overflow=hidden;', 100, 80,
            '<ol><li>Value 1</li><li>Value 2</li><li>Value 3</li></ol>', 'Ordered List'),
        this.createVertexTemplateEntry('text;html=1;strokeColor=#c0c0c0;fillColor=#ffffff;overflow=fill;rounded=0;', 280, 160,
            '<table border="1" width="100%" height="100%" cellpadding="4" style="width:100%;height:100%;border-collapse:collapse;">' +
            '<tr style="background-color:#A7C942;color:#ffffff;border:1px solid #98bf21;"><th align="left">Title 1</th><th align="left">Title 2</th><th align="left">Title 3</th></tr>' +
            '<tr style="border:1px solid #98bf21;"><td>Value 1</td><td>Value 2</td><td>Value 3</td></tr>' +
            '<tr style="background-color:#EAF2D3;border:1px solid #98bf21;"><td>Value 4</td><td>Value 5</td><td>Value 6</td></tr>' +
            '<tr style="border:1px solid #98bf21;"><td>Value 7</td><td>Value 8</td><td>Value 9</td></tr>' +
            '<tr style="background-color:#EAF2D3;border:1px solid #98bf21;"><td>Value 10</td><td>Value 11</td><td>Value 12</td></tr></table>', 'Table 1'),
        this.createVertexTemplateEntry('text;html=1;strokeColor=#c0c0c0;fillColor=none;overflow=fill;', 180, 140,
            '<table border="0" width="100%" height="100%" style="width:100%;height:100%;border-collapse:collapse;">' +
            '<tr><td align="center">Value 1</td><td align="center">Value 2</td><td align="center">Value 3</td></tr>' +
            '<tr><td align="center">Value 4</td><td align="center">Value 5</td><td align="center">Value 6</td></tr>' +
            '<tr><td align="center">Value 7</td><td align="center">Value 8</td><td align="center">Value 9</td></tr></table>', 'Table 2'),
        this.createVertexTemplateEntry('text;html=1;strokeColor=none;fillColor=none;overflow=fill;', 180, 140,
            '<table border="1" width="100%" height="100%" style="width:100%;height:100%;border-collapse:collapse;">' +
            '<tr><td align="center">Value 1</td><td align="center">Value 2</td><td align="center">Value 3</td></tr>' +
            '<tr><td align="center">Value 4</td><td align="center">Value 5</td><td align="center">Value 6</td></tr>' +
            '<tr><td align="center">Value 7</td><td align="center">Value 8</td><td align="center">Value 9</td></tr></table>', 'Table 3'),
        this.createVertexTemplateEntry('text;html=1;strokeColor=none;fillColor=none;overflow=fill;', 160, 140,
            '<table border="1" width="100%" height="100%" cellpadding="4" style="width:100%;height:100%;border-collapse:collapse;">' +
            '<tr><th align="center"><b>Title</b></th></tr>' +
            '<tr><td align="center">Section 1.1\nSection 1.2\nSection 1.3</td></tr>' +
            '<tr><td align="center">Section 2.1\nSection 2.2\nSection 2.3</td></tr></table>', 'Table 4'),
        this.addEntry('link hyperlink', mxUtils.bind(this, function () {
            var cell = new mxCell('Link', new mxGeometry(0, 0, 60, 40), 'text;html=1;strokeColor=none;fillColor=none;whiteSpace=wrap;align=center;verticalAlign=middle;fontColor=#0000EE;fontStyle=4;');
            cell.vertex = true;
            this.graph.setLinkForCell(cell, 'https://www.draw.io');

            return this.createVertexTemplateFromCells([cell], cell.geometry.width, cell.geometry.height, 'Link');
        })),
        this.addEntry('timestamp date time text label', mxUtils.bind(this, function () {
            var cell = new mxCell('%date{ddd mmm dd yyyy HH:MM:ss}%', new mxGeometry(0, 0, 160, 20), 'text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;overflow=hidden;');
            cell.vertex = true;
            this.graph.setAttributeForCell(cell, 'placeholders', '1');

            return this.createVertexTemplateFromCells([cell], cell.geometry.width, cell.geometry.height, 'Timestamp');
        })),
        this.addEntry('variable placeholder metadata hello world text label', mxUtils.bind(this, function () {
            var cell = new mxCell('%name% Text', new mxGeometry(0, 0, 80, 20), 'text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;overflow=hidden;');
            cell.vertex = true;
            this.graph.setAttributeForCell(cell, 'placeholders', '1');
            this.graph.setAttributeForCell(cell, 'name', 'Variable');

            return this.createVertexTemplateFromCells([cell], cell.geometry.width, cell.geometry.height, 'Variable');
        })),
        this.createVertexTemplateEntry('shape=ext;double=1;rounded=0;whiteSpace=wrap;html=1;', 120, 80, '', 'Double Rectangle', null, null, 'rect rectangle box double'),
        this.createVertexTemplateEntry('shape=ext;double=1;rounded=1;whiteSpace=wrap;html=1;', 120, 80, '', 'Double Rounded Rectangle', null, null, 'rounded rect rectangle box double'),
        this.createVertexTemplateEntry('ellipse;shape=doubleEllipse;whiteSpace=wrap;html=1;', 100, 60, '', 'Double Ellipse', null, null, 'oval ellipse start end state double'),
        this.createVertexTemplateEntry('shape=ext;double=1;whiteSpace=wrap;html=1;aspect=fixed;', 80, 80, '', 'Double Square', null, null, 'double square'),
        this.createVertexTemplateEntry('ellipse;shape=doubleEllipse;whiteSpace=wrap;html=1;aspect=fixed;', 80, 80, '', 'Double Circle', null, null, 'double circle'),
        this.createEdgeTemplateEntry('rounded=0;comic=1;strokeWidth=2;endArrow=blockThin;html=1;fontFamily=Comic Sans MS;fontStyle=1;', 50, 50, '', 'Comic Arrow'),
        this.createVertexTemplateEntry('html=1;whiteSpace=wrap;comic=1;strokeWidth=2;fontFamily=Comic Sans MS;fontStyle=1;', 120, 60, 'RECTANGLE', 'Comic Rectangle', true, null, 'comic rectangle rect box text retro'),
        this.createVertexTemplateEntry('rhombus;html=1;align=center;whiteSpace=wrap;comic=1;strokeWidth=2;fontFamily=Comic Sans MS;fontStyle=1;', 100, 100, 'DIAMOND', 'Comic Diamond', true, null, 'comic diamond rhombus if condition decision conditional question test retro'),
        this.createVertexTemplateEntry('html=1;whiteSpace=wrap;aspect=fixed;shape=isoRectangle;', 150, 90, '', 'Isometric Square', true, null, 'rectangle rect box iso isometric'),
        this.createVertexTemplateEntry('html=1;whiteSpace=wrap;aspect=fixed;shape=isoCube;backgroundOutline=1;', 90, 100, '', 'Isometric Cube', true, null, 'cube box iso isometric'),
        this.createEdgeTemplateEntry('edgeStyle=isometricEdgeStyle;endArrow=none;html=1;', 50, 100, '', 'Isometric Edge 1'),
        this.createEdgeTemplateEntry('edgeStyle=isometricEdgeStyle;endArrow=none;html=1;elbow=vertical;', 50, 100, '', 'Isometric Edge 2'),
        this.createVertexTemplateEntry('shape=curlyBracket;whiteSpace=wrap;html=1;rounded=1;', 20, 120, '', 'Curly Bracket'),
        this.createVertexTemplateEntry('line;strokeWidth=2;html=1;', 160, 10, '', 'Horizontal Line'),
        this.createVertexTemplateEntry('line;strokeWidth=2;direction=south;html=1;', 10, 160, '', 'Vertical Line'),
        this.createVertexTemplateEntry('line;strokeWidth=4;html=1;perimeter=backbonePerimeter;points=[];outlineConnect=0;', 160, 10, '', 'Horizontal Backbone', false, null, 'backbone bus network'),
        this.createVertexTemplateEntry('line;strokeWidth=4;direction=south;html=1;perimeter=backbonePerimeter;points=[];outlineConnect=0;', 10, 160, '', 'Vertical Backbone', false, null, 'backbone bus network'),
        this.createVertexTemplateEntry('shape=crossbar;whiteSpace=wrap;html=1;rounded=1;', 120, 20, '', 'Crossbar', false, null, 'crossbar distance measure dimension unit'),
        this.createVertexTemplateEntry('shape=image;html=1;verticalLabelPosition=bottom;labelBackgroundColor=#ffffff;verticalAlign=top;imageAspect=1;aspect=fixed;image=' + this.gearImage, 52, 61, '', 'Image (Fixed Aspect)', false, null, 'fixed image icon symbol'),
        this.createVertexTemplateEntry('shape=image;html=1;verticalLabelPosition=bottom;labelBackgroundColor=#ffffff;verticalAlign=top;imageAspect=0;image=' + this.gearImage, 50, 60, '', 'Image (Variable Aspect)', false, null, 'strechted image icon symbol'),
        this.createVertexTemplateEntry('icon;html=1;image=' + this.gearImage, 60, 60, 'Icon', 'Icon', false, null, 'icon image symbol'),
        this.createVertexTemplateEntry('label;whiteSpace=wrap;html=1;image=' + this.gearImage, 140, 60, 'Label', 'Label 1', null, null, 'label image icon symbol'),
        this.createVertexTemplateEntry('label;whiteSpace=wrap;html=1;align=center;verticalAlign=bottom;spacingLeft=0;spacingBottom=4;imageAlign=center;imageVerticalAlign=top;image=' + this.gearImage, 120, 80, 'Label', 'Label 2', null, null, 'label image icon symbol'),
        this.addEntry('shape group container', function () {
            var cell = new mxCell('Label', new mxGeometry(0, 0, 160, 70),
                'html=1;whiteSpace=wrap;container=1;recursiveResize=0;collapsible=0;');
            cell.vertex = true;

            var symbol = new mxCell('', new mxGeometry(20, 20, 20, 30), 'triangle;html=1;whiteSpace=wrap;');
            symbol.vertex = true;
            cell.insert(symbol);

            return sb.createVertexTemplateFromCells([cell], cell.geometry.width, cell.geometry.height, 'Shape Group');
        }),
        this.createVertexTemplateEntry('shape=partialRectangle;whiteSpace=wrap;html=1;left=0;right=0;fillColor=none;', 120, 60, '', 'Partial Rectangle'),
        this.createVertexTemplateEntry('shape=partialRectangle;whiteSpace=wrap;html=1;bottom=1;right=1;left=1;top=0;fillColor=none;routingCenterX=-0.5;', 120, 60, '', 'Partial Rectangle'),
        this.createEdgeTemplateEntry('edgeStyle=segmentEdgeStyle;endArrow=classic;html=1;', 50, 50, '', 'Manual Line', null, lineTags + 'manual'),
        this.createEdgeTemplateEntry('shape=filledEdge;rounded=0;fixDash=1;endArrow=none;strokeWidth=10;fillColor=#ffffff;edgeStyle=orthogonalEdgeStyle;', 60, 40, '', 'Filled Edge'),
        this.createEdgeTemplateEntry('edgeStyle=elbowEdgeStyle;elbow=horizontal;endArrow=classic;html=1;', 50, 50, '', 'Horizontal Elbow', null, lineTags + 'elbow horizontal'),
        this.createEdgeTemplateEntry('edgeStyle=elbowEdgeStyle;elbow=vertical;endArrow=classic;html=1;', 50, 50, '', 'Vertical Elbow', null, lineTags + 'elbow vertical')
    ];

    this.addPaletteFunctions('misc', mxResources.get('misc'), (expand != null) ? expand : true, fns);
};
/**
 * Adds the container palette to the sidebar.
 */
Sidebar.prototype.addAdvancedPalette = function (expand) {
    this.addPaletteFunctions('advanced', mxResources.get('advanced'), (expand != null) ? expand : false, this.createAdvancedShapes());
};

/**
 * Adds the container palette to the sidebar.
 */
Sidebar.prototype.createAdvancedShapes = function () {
    // Avoids having to bind all functions to "this"
    var sb = this;

    // Reusable cells
    var field = new mxCell('List Item', new mxGeometry(0, 0, 60, 26), 'text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;');
    field.vertex = true;

    return [
        this.createVertexTemplateEntry('shape=tapeData;whiteSpace=wrap;html=1;perimeter=ellipsePerimeter;', 80, 80, '', 'Tape Data'),
        this.createVertexTemplateEntry('shape=manualInput;whiteSpace=wrap;html=1;', 80, 80, '', 'Manual Input'),
        this.createVertexTemplateEntry('shape=loopLimit;whiteSpace=wrap;html=1;', 100, 80, '', 'Loop Limit'),
        this.createVertexTemplateEntry('shape=offPageConnector;whiteSpace=wrap;html=1;', 80, 80, '', 'Off Page Connector'),
        this.createVertexTemplateEntry('shape=delay;whiteSpace=wrap;html=1;', 80, 40, '', 'Delay'),
        this.createVertexTemplateEntry('shape=display;whiteSpace=wrap;html=1;', 80, 40, '', 'Display'),
        this.createVertexTemplateEntry('shape=singleArrow;direction=west;whiteSpace=wrap;html=1;', 100, 60, '', 'Arrow Left'),
        this.createVertexTemplateEntry('shape=singleArrow;whiteSpace=wrap;html=1;', 100, 60, '', 'Arrow Right'),
        this.createVertexTemplateEntry('shape=singleArrow;direction=north;whiteSpace=wrap;html=1;', 60, 100, '', 'Arrow Up'),
        this.createVertexTemplateEntry('shape=singleArrow;direction=south;whiteSpace=wrap;html=1;', 60, 100, '', 'Arrow Down'),
        this.createVertexTemplateEntry('shape=doubleArrow;whiteSpace=wrap;html=1;', 100, 60, '', 'Double Arrow'),
        this.createVertexTemplateEntry('shape=doubleArrow;direction=south;whiteSpace=wrap;html=1;', 60, 100, '', 'Double Arrow Vertical', null, null, 'double arrow'),
        this.createVertexTemplateEntry('shape=actor;whiteSpace=wrap;html=1;', 40, 60, '', 'User', null, null, 'user person human'),
        this.createVertexTemplateEntry('shape=cross;whiteSpace=wrap;html=1;', 80, 80, '', 'Cross'),
        this.createVertexTemplateEntry('shape=corner;whiteSpace=wrap;html=1;', 80, 80, '', 'Corner'),
        this.createVertexTemplateEntry('shape=tee;whiteSpace=wrap;html=1;', 80, 80, '', 'Tee'),
        this.createVertexTemplateEntry('shape=datastore;whiteSpace=wrap;html=1;', 60, 60, '', 'Data Store', null, null, 'data store cylinder database'),
        this.createVertexTemplateEntry('shape=orEllipse;perimeter=ellipsePerimeter;whiteSpace=wrap;html=1;backgroundOutline=1;', 80, 80, '', 'Or', null, null, 'or circle oval ellipse'),
        this.createVertexTemplateEntry('shape=sumEllipse;perimeter=ellipsePerimeter;whiteSpace=wrap;html=1;backgroundOutline=1;', 80, 80, '', 'Sum', null, null, 'sum circle oval ellipse'),
        this.createVertexTemplateEntry('shape=lineEllipse;perimeter=ellipsePerimeter;whiteSpace=wrap;html=1;backgroundOutline=1;', 80, 80, '', 'Ellipse with horizontal divider', null, null, 'circle oval ellipse'),
        this.createVertexTemplateEntry('shape=lineEllipse;line=vertical;perimeter=ellipsePerimeter;whiteSpace=wrap;html=1;backgroundOutline=1;', 80, 80, '', 'Ellipse with vertical divider', null, null, 'circle oval ellipse'),
        this.createVertexTemplateEntry('shape=sortShape;perimeter=rhombusPerimeter;whiteSpace=wrap;html=1;', 80, 80, '', 'Sort', null, null, 'sort'),
        this.createVertexTemplateEntry('shape=collate;whiteSpace=wrap;html=1;', 80, 80, '', 'Collate', null, null, 'collate'),
        this.createVertexTemplateEntry('shape=switch;whiteSpace=wrap;html=1;', 60, 60, '', 'Switch', null, null, 'switch router'),
        this.addEntry('process bar', function () {
            return sb.createVertexTemplateFromData('zZXRaoMwFIafJpcDjbNrb2233rRQ8AkyPdPQaCRJV+3T7yTG2rUVBoOtgpDzn/xJzncCIdGyateKNeVW5iBI9EqipZLS9KOqXYIQhAY8J9GKUBrgT+jbRDZ02aBhCmrzEwPtDZ9MHKBXdkpmoDWKCVN9VptO+Kw+8kqwGqMkK7nIN6yTB7uTNizbD1FSSsVPsjYMC1qFKHxwIZZSSIVxLZ1/nJNar5+oQPMT7IYCrqUta1ENzuqGaeOFTArBGs3f3Vmtoo2Se7ja1h00kSoHK4bBIKUNy3hdoPYU0mF91i9mT8EEL2ocZ3gKa00ayWujLZY4IfHKFonVDLsRGgXuQ90zBmWgneyTk3yT1iArMKrDKUeem9L3ajHrbSXwohxsQd/ggOleKM7ese048J2/fwuim1uQGmhQCW8vQMkacP3GCQgBFMftHEsr7cYYe95CnmKTPMFbYD8CQ++DGQy+/M5X4ku5wHYmdIktfvk9tecpavThqS3m/0YtnqIWPTy1cD77K2wYjo+Ay317I74A', 296, 100, 'Process Bar');
        }),
        this.createVertexTemplateEntry('swimlane;', 200, 200, 'Container', 'Container', null, null, 'container swimlane lane pool group'),
        this.addEntry('list group erd table', function () {
            var cell = new mxCell('List', new mxGeometry(0, 0, 140, 110),
                'swimlane;fontStyle=0;childLayout=stackLayout;horizontal=1;startSize=26;fillColor=none;horizontalStack=0;' +
                'resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;');
            cell.vertex = true;
            cell.insert(sb.cloneCell(field, 'Item 1'));
            cell.insert(sb.cloneCell(field, 'Item 2'));
            cell.insert(sb.cloneCell(field, 'Item 3'));

            return sb.createVertexTemplateFromCells([cell], cell.geometry.width, cell.geometry.height, 'List');
        }),
        this.addEntry('list item entry value group erd table', function () {
            return sb.createVertexTemplateFromCells([sb.cloneCell(field, 'List Item')], field.geometry.width, field.geometry.height, 'List Item');
        })
    ];
};

/**
 * Adds the general palette to the sidebar.
 */
Sidebar.prototype.addUmlPalette = function (expand) {
    // Avoids having to bind all functions to "this"
    var sb = this;

    // Reusable cells
    var field = new mxCell('+ field: type', new mxGeometry(0, 0, 100, 26), 'text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;');
    field.vertex = true;

    var divider = new mxCell('', new mxGeometry(0, 0, 40, 8), 'line;strokeWidth=1;fillColor=none;align=left;verticalAlign=middle;spacingTop=-1;spacingLeft=3;spacingRight=3;rotatable=0;labelPosition=right;points=[];portConstraint=eastwest;');
    divider.vertex = true;

    // Default tags
    var dt = 'uml static class ';

    var fns = [
        this.createVertexTemplateEntry('html=1;', 110, 50, 'Object', 'Object', null, null, dt + 'object instance'),
        this.createVertexTemplateEntry('html=1;', 110, 50, '&laquo;interface&raquo;<br><b>Name</b>', 'Interface', null, null, dt + 'interface object instance annotated annotation'),
        this.addEntry(dt + 'object instance', function () {
            var cell = new mxCell('Classname', new mxGeometry(0, 0, 160, 90),
                'swimlane;fontStyle=1;align=center;verticalAlign=top;childLayout=stackLayout;horizontal=1;startSize=26;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;');
            cell.vertex = true;
            cell.insert(field.clone());
            cell.insert(divider.clone());
            cell.insert(sb.cloneCell(field, '+ method(type): type'));

            return sb.createVertexTemplateFromCells([cell], cell.geometry.width, cell.geometry.height, 'Class');
        }),
        this.addEntry(dt + 'section subsection', function () {
            var cell = new mxCell('Classname', new mxGeometry(0, 0, 140, 110),
                'swimlane;fontStyle=0;childLayout=stackLayout;horizontal=1;startSize=26;fillColor=none;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;');
            cell.vertex = true;
            cell.insert(field.clone());
            cell.insert(field.clone());
            cell.insert(field.clone());

            return sb.createVertexTemplateFromCells([cell], cell.geometry.width, cell.geometry.height, 'Class 2');
        }),
        this.addEntry(dt + 'item member method function variable field attribute label', function () {
            return sb.createVertexTemplateFromCells([sb.cloneCell(field, '+ item: attribute')], field.geometry.width, field.geometry.height, 'Item 1');
        }),
        this.addEntry(dt + 'item member method function variable field attribute label', function () {
            var cell = new mxCell('item: attribute', new mxGeometry(0, 0, 120, field.geometry.height), 'label;fontStyle=0;strokeColor=none;fillColor=none;align=left;verticalAlign=top;overflow=hidden;' +
                'spacingLeft=28;spacingRight=4;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;imageWidth=16;imageHeight=16;image=' + sb.gearImage);
            cell.vertex = true;

            return sb.createVertexTemplateFromCells([cell], cell.geometry.width, cell.geometry.height, 'Item 2');
        }),
        this.addEntry(dt + 'divider hline line separator', function () {
            return sb.createVertexTemplateFromCells([divider.clone()], divider.geometry.width, divider.geometry.height, 'Divider');
        }),
        this.addEntry(dt + 'spacer space gap separator', function () {
            var cell = new mxCell('', new mxGeometry(0, 0, 20, 14), 'text;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;spacingTop=-1;spacingLeft=4;spacingRight=4;rotatable=0;labelPosition=right;points=[];portConstraint=eastwest;');
            cell.vertex = true;

            return sb.createVertexTemplateFromCells([cell.clone()], cell.geometry.width, cell.geometry.height, 'Spacer');
        }),
        this.createVertexTemplateEntry('text;align=center;fontStyle=1;verticalAlign=middle;spacingLeft=3;spacingRight=3;strokeColor=none;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;',
            80, 26, 'Title', 'Title', null, null, dt + 'title label'),
        this.addEntry(dt + 'component', function () {
            var cell = new mxCell('&laquo;Annotation&raquo;<br/><b>Component</b>', new mxGeometry(0, 0, 180, 90), 'html=1;');
            cell.vertex = true;

            var symbol = new mxCell('', new mxGeometry(1, 0, 20, 20), 'shape=component;jettyWidth=8;jettyHeight=4;');
            symbol.vertex = true;
            symbol.geometry.relative = true;
            symbol.geometry.offset = new mxPoint(-27, 7);
            cell.insert(symbol);

            return sb.createVertexTemplateFromCells([cell], cell.geometry.width, cell.geometry.height, 'Component');
        }),
        this.addEntry(dt + 'component', function () {
            var cell = new mxCell('<p style="margin:0px;margin-top:6px;text-align:center;"><b>Component</b></p>' +
                '<hr/><p style="margin:0px;margin-left:8px;">+ Attribute1: Type<br/>+ Attribute2: Type</p>', new mxGeometry(0, 0, 180, 90),
                'align=left;overflow=fill;html=1;');
            cell.vertex = true;

            var symbol = new mxCell('', new mxGeometry(1, 0, 20, 20), 'shape=component;jettyWidth=8;jettyHeight=4;');
            symbol.vertex = true;
            symbol.geometry.relative = true;
            symbol.geometry.offset = new mxPoint(-24, 4);
            cell.insert(symbol);

            return sb.createVertexTemplateFromCells([cell], cell.geometry.width, cell.geometry.height, 'Component with Attributes');
        }),
        this.createVertexTemplateEntry('verticalAlign=top;align=left;spacingTop=8;spacingLeft=2;spacingRight=12;shape=cube;size=10;direction=south;fontStyle=4;html=1;',
            180, 120, 'Block', 'Block', null, null, dt + 'block'),
        this.createVertexTemplateEntry('shape=component;align=left;spacingLeft=36;', 120, 60, 'Module', 'Module', null, null, dt + 'module'),
        this.createVertexTemplateEntry('shape=folder;fontStyle=1;spacingTop=10;tabWidth=40;tabHeight=14;tabPosition=left;html=1;', 70, 50,
            'package', 'Package', null, null, dt + 'package'),
        this.createVertexTemplateEntry('verticalAlign=top;align=left;overflow=fill;fontSize=12;fontFamily=Helvetica;html=1;',
            160, 90, '<p style="margin:0px;margin-top:4px;text-align:center;text-decoration:underline;"><b>Object:Type</b></p><hr/>' +
            '<p style="margin:0px;margin-left:8px;">field1 = value1<br/>field2 = value2<br>field3 = value3</p>', 'Object',
            null, null, dt + 'object instance'),
        this.createVertexTemplateEntry('verticalAlign=top;align=left;overflow=fill;html=1;', 180, 90,
            '<div style="box-sizing:border-box;width:100%;background:#e4e4e4;padding:2px;">Tablename</div>' +
            '<table style="width:100%;font-size:1em;" cellpadding="2" cellspacing="0">' +
            '<tr><td>PK</td><td>uniqueId</td></tr><tr><td>FK1</td><td>' +
            'foreignKey</td></tr><tr><td></td><td>fieldname</td></tr></table>', 'Entity', null, null, 'er entity table'),
        this.addEntry(dt + 'object instance', function () {
            var cell = new mxCell('<p style="margin:0px;margin-top:4px;text-align:center;">' +
                '<b>Class</b></p>' +
                '<hr size="1"/><div style="height:2px;"></div>', new mxGeometry(0, 0, 140, 60),
                'verticalAlign=top;align=left;overflow=fill;fontSize=12;fontFamily=Helvetica;html=1;');
            cell.vertex = true;

            return sb.createVertexTemplateFromCells([cell.clone()], cell.geometry.width, cell.geometry.height, 'Class 3');
        }),
        this.addEntry(dt + 'object instance', function () {
            var cell = new mxCell('<p style="margin:0px;margin-top:4px;text-align:center;">' +
                '<b>Class</b></p>' +
                '<hr size="1"/><div style="height:2px;"></div><hr size="1"/><div style="height:2px;"></div>', new mxGeometry(0, 0, 140, 60),
                'verticalAlign=top;align=left;overflow=fill;fontSize=12;fontFamily=Helvetica;html=1;');
            cell.vertex = true;

            return sb.createVertexTemplateFromCells([cell.clone()], cell.geometry.width, cell.geometry.height, 'Class 4');
        }),
        this.addEntry(dt + 'object instance', function () {
            var cell = new mxCell('<p style="margin:0px;margin-top:4px;text-align:center;">' +
                '<b>Class</b></p>' +
                '<hr size="1"/><p style="margin:0px;margin-left:4px;">+ field: Type</p><hr size="1"/>' +
                '<p style="margin:0px;margin-left:4px;">+ method(): Type</p>', new mxGeometry(0, 0, 160, 90),
                'verticalAlign=top;align=left;overflow=fill;fontSize=12;fontFamily=Helvetica;html=1;');
            cell.vertex = true;

            return sb.createVertexTemplateFromCells([cell.clone()], cell.geometry.width, cell.geometry.height, 'Class 5');
        }),
        this.addEntry(dt + 'object instance', function () {
            var cell = new mxCell('<p style="margin:0px;margin-top:4px;text-align:center;">' +
                '<i>&lt;&lt;Interface&gt;&gt;</i><br/><b>Interface</b></p>' +
                '<hr size="1"/><p style="margin:0px;margin-left:4px;">+ field1: Type<br/>' +
                '+ field2: Type</p>' +
                '<hr size="1"/><p style="margin:0px;margin-left:4px;">' +
                '+ method1(Type): Type<br/>' +
                '+ method2(Type, Type): Type</p>', new mxGeometry(0, 0, 190, 140),
                'verticalAlign=top;align=left;overflow=fill;fontSize=12;fontFamily=Helvetica;html=1;');
            cell.vertex = true;

            return sb.createVertexTemplateFromCells([cell.clone()], cell.geometry.width, cell.geometry.height, 'Interface 2');
        }),
        this.createVertexTemplateEntry('shape=providedRequiredInterface;html=1;verticalLabelPosition=bottom;', 20, 20, '', 'Provided/Required Interface', null, null, 'uml provided required interface lollipop notation'),
        this.createVertexTemplateEntry('shape=requiredInterface;html=1;verticalLabelPosition=bottom;', 10, 20, '', 'Required Interface', null, null, 'uml required interface lollipop notation'),
        this.addEntry('uml lollipop notation provided required interface', function () {
            return sb.createVertexTemplateFromData('zVTBrptADPyavVYEkt4b0uQd3pMq5dD2uAUD27dgZJwE8vX1spsQlETtpVWRIjFjex3PmFVJWvc70m31hjlYlXxWSUqI7N/qPgVrVRyZXCUbFceR/FS8fRJdjNGo1QQN/0lB7AuO2h7AM57oeLCBIDw0Obj8SCVrJK6wxEbbV8RWyIWQP4F52Juzq9AHRqEqrm2IQpN/IsKTwAYb8MzWWBuO9B0hL2E2BGsqIQyxvJ9rzApD7QBrYBokhcBqNsf5UbrzsLzmXUu/oJET42jwGat5QYcHyiDkTDLKy03TiRrFfSx08m+FrrQtUkOZvZdbFKThmwMfVhf4fQ43/W3uZriiPPT+KKhjwnf4anKuQv//wsg+NPJ7/9d9Xf7eVykwbeeMOFWGYd/qzEVO8tHP/Suw4a2ujXV/+gXsEdhkOgSC8os44BQt0tggicZHeG1N2QiXibhAV48epRayEDd8MT7Ct06TUaXVWq027tCuhcx5VZjebeeaoDNn/WMcb/p+j0AM/dNr6InLl4Lgzylsk6OCgRWYsuI592gNZh5OhgmcblPv7+1l+ws=',
                40, 10, 'Lollipop Notation');
        }),
        this.createVertexTemplateEntry('shape=umlBoundary;whiteSpace=wrap;html=1;', 100, 80, 'Boundary Object', 'Boundary Object', null, null, 'uml boundary object'),
        this.createVertexTemplateEntry('ellipse;shape=umlEntity;whiteSpace=wrap;html=1;', 80, 80, 'Entity Object', 'Entity Object', null, null, 'uml entity object'),
        this.createVertexTemplateEntry('ellipse;shape=umlControl;whiteSpace=wrap;html=1;', 70, 80, 'Control Object', 'Control Object', null, null, 'uml control object'),
        this.createVertexTemplateEntry('shape=umlActor;verticalLabelPosition=bottom;labelBackgroundColor=#ffffff;verticalAlign=top;html=1;', 30, 60, 'Actor', 'Actor', false, null, 'uml actor'),
        this.createVertexTemplateEntry('ellipse;whiteSpace=wrap;html=1;', 140, 70, 'Use Case', 'Use Case', null, null, 'uml use case usecase'),
        this.addEntry('uml activity state start', function () {
            var cell = new mxCell('', new mxGeometry(0, 0, 30, 30),
                'ellipse;html=1;shape=startState;fillColor=#000000;strokeColor=#ff0000;');
            cell.vertex = true;

            var edge = new mxCell('', new mxGeometry(0, 0, 0, 0), 'edgeStyle=orthogonalEdgeStyle;html=1;verticalAlign=bottom;endArrow=open;endSize=8;strokeColor=#ff0000;');
            edge.geometry.setTerminalPoint(new mxPoint(15, 90), false);
            edge.geometry.relative = true;
            edge.edge = true;

            cell.insertEdge(edge, true);

            return sb.createVertexTemplateFromCells([cell, edge], 30, 90, 'Start');
        }),
        this.addEntry('uml activity state', function () {
            var cell = new mxCell('Activity', new mxGeometry(0, 0, 120, 40),
                'rounded=1;whiteSpace=wrap;html=1;arcSize=40;fontColor=#000000;fillColor=#ffffc0;strokeColor=#ff0000;');
            cell.vertex = true;

            var edge = new mxCell('', new mxGeometry(0, 0, 0, 0), 'edgeStyle=orthogonalEdgeStyle;html=1;verticalAlign=bottom;endArrow=open;endSize=8;strokeColor=#ff0000;');
            edge.geometry.setTerminalPoint(new mxPoint(60, 100), false);
            edge.geometry.relative = true;
            edge.edge = true;

            cell.insertEdge(edge, true);

            return sb.createVertexTemplateFromCells([cell, edge], 120, 100, 'Activity');
        }),
        this.addEntry('uml activity composite state', function () {
            var cell = new mxCell('Composite State', new mxGeometry(0, 0, 160, 60),
                'swimlane;html=1;fontStyle=1;align=center;verticalAlign=middle;childLayout=stackLayout;horizontal=1;startSize=30;horizontalStack=0;resizeParent=0;resizeLast=1;container=0;fontColor=#000000;collapsible=0;rounded=1;arcSize=30;strokeColor=#ff0000;fillColor=#ffffc0;swimlaneFillColor=#ffffc0;');
            cell.vertex = true;

            var cell1 = new mxCell('Subtitle', new mxGeometry(0, 0, 200, 26), 'text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;spacingLeft=4;spacingRight=4;whiteSpace=wrap;overflow=hidden;rotatable=0;fontColor=#000000;');
            cell1.vertex = true;
            cell.insert(cell1);

            var edge = new mxCell('', new mxGeometry(0, 0, 0, 0), 'edgeStyle=orthogonalEdgeStyle;html=1;verticalAlign=bottom;endArrow=open;endSize=8;strokeColor=#ff0000;');
            edge.geometry.setTerminalPoint(new mxPoint(80, 120), false);
            edge.geometry.relative = true;
            edge.edge = true;

            cell.insertEdge(edge, true);

            return sb.createVertexTemplateFromCells([cell, edge], 160, 120, 'Composite State');
        }),
        this.addEntry('uml activity condition', function () {
            var cell = new mxCell('Condition', new mxGeometry(0, 0, 80, 40), 'rhombus;whiteSpace=wrap;html=1;fillColor=#ffffc0;strokeColor=#ff0000;');
            cell.vertex = true;

            var edge1 = new mxCell('no', new mxGeometry(0, 0, 0, 0), 'edgeStyle=orthogonalEdgeStyle;html=1;align=left;verticalAlign=bottom;endArrow=open;endSize=8;strokeColor=#ff0000;');
            edge1.geometry.setTerminalPoint(new mxPoint(180, 20), false);
            edge1.geometry.relative = true;
            edge1.geometry.x = -1;
            edge1.edge = true;

            cell.insertEdge(edge1, true);

            var edge2 = new mxCell('yes', new mxGeometry(0, 0, 0, 0), 'edgeStyle=orthogonalEdgeStyle;html=1;align=left;verticalAlign=top;endArrow=open;endSize=8;strokeColor=#ff0000;');
            edge2.geometry.setTerminalPoint(new mxPoint(40, 100), false);
            edge2.geometry.relative = true;
            edge2.geometry.x = -1;
            edge2.edge = true;

            cell.insertEdge(edge2, true);

            return sb.createVertexTemplateFromCells([cell, edge1, edge2], 180, 100, 'Condition');
        }),
        this.addEntry('uml activity fork join', function () {
            var cell = new mxCell('', new mxGeometry(0, 0, 200, 10), 'shape=line;html=1;strokeWidth=6;strokeColor=#ff0000;');
            cell.vertex = true;

            var edge = new mxCell('', new mxGeometry(0, 0, 0, 0), 'edgeStyle=orthogonalEdgeStyle;html=1;verticalAlign=bottom;endArrow=open;endSize=8;strokeColor=#ff0000;');
            edge.geometry.setTerminalPoint(new mxPoint(100, 80), false);
            edge.geometry.relative = true;
            edge.edge = true;

            cell.insertEdge(edge, true);

            return sb.createVertexTemplateFromCells([cell, edge], 200, 80, 'Fork/Join');
        }),
        this.createVertexTemplateEntry('ellipse;html=1;shape=endState;fillColor=#000000;strokeColor=#ff0000;', 30, 30, '', 'End', null, null, 'uml activity state end'),
        this.createVertexTemplateEntry('shape=umlLifeline;perimeter=lifelinePerimeter;whiteSpace=wrap;html=1;container=1;collapsible=0;recursiveResize=0;outlineConnect=0;', 100, 300, ':Object', 'Lifeline', null, null, 'uml sequence participant lifeline'),
        this.createVertexTemplateEntry('shape=umlLifeline;participant=umlActor;perimeter=lifelinePerimeter;whiteSpace=wrap;html=1;container=1;collapsible=0;recursiveResize=0;verticalAlign=top;spacingTop=36;labelBackgroundColor=#ffffff;outlineConnect=0;',
            20, 300, '', 'Actor Lifeline', null, null, 'uml sequence participant lifeline actor'),
        this.createVertexTemplateEntry('shape=umlLifeline;participant=umlBoundary;perimeter=lifelinePerimeter;whiteSpace=wrap;html=1;container=1;collapsible=0;recursiveResize=0;verticalAlign=top;spacingTop=36;labelBackgroundColor=#ffffff;outlineConnect=0;',
            50, 300, '', 'Boundary Lifeline', null, null, 'uml sequence participant lifeline boundary'),
        this.createVertexTemplateEntry('shape=umlLifeline;participant=umlEntity;perimeter=lifelinePerimeter;whiteSpace=wrap;html=1;container=1;collapsible=0;recursiveResize=0;verticalAlign=top;spacingTop=36;labelBackgroundColor=#ffffff;outlineConnect=0;',
            40, 300, '', 'Entity Lifeline', null, null, 'uml sequence participant lifeline entity'),
        this.createVertexTemplateEntry('shape=umlLifeline;participant=umlControl;perimeter=lifelinePerimeter;whiteSpace=wrap;html=1;container=1;collapsible=0;recursiveResize=0;verticalAlign=top;spacingTop=36;labelBackgroundColor=#ffffff;outlineConnect=0;',
            40, 300, '', 'Control Lifeline', null, null, 'uml sequence participant lifeline control'),
        this.createVertexTemplateEntry('shape=umlFrame;whiteSpace=wrap;html=1;', 300, 200, 'frame', 'Frame', null, null, 'uml sequence frame'),
        this.createVertexTemplateEntry('shape=umlDestroy;whiteSpace=wrap;html=1;strokeWidth=3;', 30, 30, '', 'Destruction', null, null, 'uml sequence destruction destroy'),
        this.createVertexTemplateEntry('shape=note;whiteSpace=wrap;html=1;size=14;verticalAlign=top;align=left;spacingTop=-6;', 100, 70, 'Note', 'Note', null, null, 'uml note'),
        this.addEntry('uml sequence invoke invocation call activation', function () {
            var cell = new mxCell('', new mxGeometry(0, 0, 10, 80), 'html=1;points=[];perimeter=orthogonalPerimeter;');
            cell.vertex = true;

            var edge = new mxCell('dispatch', new mxGeometry(0, 0, 0, 0), 'html=1;verticalAlign=bottom;startArrow=oval;endArrow=block;startSize=8;');
            edge.geometry.setTerminalPoint(new mxPoint(-60, 0), true);
            edge.geometry.relative = true;
            edge.edge = true;

            cell.insertEdge(edge, false);

            return sb.createVertexTemplateFromCells([cell, edge], 10, 80, 'Found Message');
        }),
        this.addEntry('uml sequence invoke call delegation synchronous invocation activation', function () {
            var cell = new mxCell('', new mxGeometry(0, 0, 10, 80), 'html=1;points=[];perimeter=orthogonalPerimeter;');
            cell.vertex = true;

            var edge1 = new mxCell('dispatch', new mxGeometry(0, 0, 0, 0), 'html=1;verticalAlign=bottom;endArrow=block;entryX=0;entryY=0;');
            edge1.geometry.setTerminalPoint(new mxPoint(-70, 0), true);
            edge1.geometry.relative = true;
            edge1.edge = true;

            cell.insertEdge(edge1, false);

            var edge2 = new mxCell('return', new mxGeometry(0, 0, 0, 0), 'html=1;verticalAlign=bottom;endArrow=open;dashed=1;endSize=8;exitX=0;exitY=0.95;');
            edge2.geometry.setTerminalPoint(new mxPoint(-70, 76), false);
            edge2.geometry.relative = true;
            edge2.edge = true;

            cell.insertEdge(edge2, true);

            return sb.createVertexTemplateFromCells([cell, edge1, edge2], 10, 80, 'Synchronous Invocation');
        }),
        this.addEntry('uml sequence self call recursion delegation activation', function () {
            var cell = new mxCell('', new mxGeometry(0, 20, 10, 40), 'html=1;points=[];perimeter=orthogonalPerimeter;');
            cell.vertex = true;

            var edge = new mxCell('self call', new mxGeometry(0, 0, 0, 0), 'edgeStyle=orthogonalEdgeStyle;html=1;align=left;spacingLeft=2;endArrow=block;rounded=0;entryX=1;entryY=0;');
            edge.geometry.setTerminalPoint(new mxPoint(5, 0), true);
            edge.geometry.points = [new mxPoint(30, 0)];
            edge.geometry.relative = true;
            edge.edge = true;

            cell.insertEdge(edge, false);

            return sb.createVertexTemplateFromCells([cell, edge], 10, 60, 'Self Call');
        }),
        this.addEntry('uml sequence invoke call delegation callback activation', function () {
            // TODO: Check if more entries should be converted to compressed XML
            return sb.createVertexTemplateFromData('xZRNT8MwDIZ/Ta6oaymD47rBTkiTuMAxW6wmIm0q19s6fj1OE3V0Y2iCA4dK8euP2I+riGxedUuUjX52CqzIHkU2R+conKpuDtaKNDFKZAuRpgl/In264J303qSRCDVdk5CGhJ20WwhKEFo62ChoqritxURkReNMTa2X80LkC68AmgoIkEWHpF3pamlXR7WIFwASdBeb7KXY4RIc5+KBQ/ZGkY4RYY5Egyl1zLqLmmyDXQ6Zx4n5EIf+HkB2BmAjrV3LzftPIPw4hgNn1pQ1a2tH5Cp2QK1miG7vNeu4iJe4pdeY2BtvbCQDGlAljMCQxBJotJ8rWCFYSWY3LvUdmZi68rvkkLiU6QnL1m1xAzHoBOdw61WEb88II9AW67/ydQ2wq1Cy1aAGvOrFfPh6997qDA3g+dxzv3nIL6MPU/8T+kMw8+m4QPgdfrEJNo8PSQj/+s58Ag==',
                10, 60, 'Callback');
        }),
        this.createVertexTemplateEntry('html=1;points=[];perimeter=orthogonalPerimeter;', 10, 80, '', 'Activation', null, null, 'uml sequence activation'),
        this.createEdgeTemplateEntry('html=1;verticalAlign=bottom;startArrow=oval;startFill=1;endArrow=block;startSize=8;', 60, 0, 'dispatch', 'Found Message 1', null, 'uml sequence message call invoke dispatch'),
        this.createEdgeTemplateEntry('html=1;verticalAlign=bottom;startArrow=circle;startFill=1;endArrow=open;startSize=6;endSize=8;', 80, 0, 'dispatch', 'Found Message 2', null, 'uml sequence message call invoke dispatch'),
        this.createEdgeTemplateEntry('html=1;verticalAlign=bottom;endArrow=block;', 80, 0, 'dispatch', 'Message', null, 'uml sequence message call invoke dispatch'),
        this.addEntry('uml sequence return message', function () {
            var edge = new mxCell('return', new mxGeometry(0, 0, 0, 0), 'html=1;verticalAlign=bottom;endArrow=open;dashed=1;endSize=8;');
            edge.geometry.setTerminalPoint(new mxPoint(80, 0), true);
            edge.geometry.setTerminalPoint(new mxPoint(0, 0), false);
            edge.geometry.relative = true;
            edge.edge = true;

            return sb.createEdgeTemplateFromCells([edge], 80, 0, 'Return');
        }),
        this.addEntry('uml relation', function () {
            var edge = new mxCell('name', new mxGeometry(0, 0, 0, 0), 'endArrow=block;endFill=1;html=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=top;');
            edge.geometry.setTerminalPoint(new mxPoint(0, 0), true);
            edge.geometry.setTerminalPoint(new mxPoint(160, 0), false);
            edge.geometry.relative = true;
            edge.geometry.x = -1;
            edge.edge = true;

            var cell = new mxCell('1', new mxGeometry(-1, 0, 0, 0), 'resizable=0;html=1;align=left;verticalAlign=bottom;labelBackgroundColor=#ffffff;fontSize=10;');
            cell.geometry.relative = true;
            cell.setConnectable(false);
            cell.vertex = true;
            edge.insert(cell);

            return sb.createEdgeTemplateFromCells([edge], 160, 0, 'Relation 1');
        }),
        this.addEntry('uml association', function () {
            var edge = new mxCell('', new mxGeometry(0, 0, 0, 0), 'endArrow=none;html=1;edgeStyle=orthogonalEdgeStyle;');
            edge.geometry.setTerminalPoint(new mxPoint(0, 0), true);
            edge.geometry.setTerminalPoint(new mxPoint(160, 0), false);
            edge.geometry.relative = true;
            edge.edge = true;

            var cell1 = new mxCell('parent', new mxGeometry(-1, 0, 0, 0), 'resizable=0;html=1;align=left;verticalAlign=bottom;labelBackgroundColor=#ffffff;fontSize=10;');
            cell1.geometry.relative = true;
            cell1.setConnectable(false);
            cell1.vertex = true;
            edge.insert(cell1);

            var cell2 = new mxCell('child', new mxGeometry(1, 0, 0, 0), 'resizable=0;html=1;align=right;verticalAlign=bottom;labelBackgroundColor=#ffffff;fontSize=10;');
            cell2.geometry.relative = true;
            cell2.setConnectable(false);
            cell2.vertex = true;
            edge.insert(cell2);

            return sb.createEdgeTemplateFromCells([edge], 160, 0, 'Association 1');
        }),
        this.addEntry('uml aggregation', function () {
            var edge = new mxCell('1', new mxGeometry(0, 0, 0, 0), 'endArrow=open;html=1;endSize=12;startArrow=diamondThin;startSize=14;startFill=0;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=bottom;');
            edge.geometry.setTerminalPoint(new mxPoint(0, 0), true);
            edge.geometry.setTerminalPoint(new mxPoint(160, 0), false);
            edge.geometry.relative = true;
            edge.geometry.x = -1;
            edge.geometry.y = 3;
            edge.edge = true;

            return sb.createEdgeTemplateFromCells([edge], 160, 0, 'Aggregation 1');
        }),
        this.addEntry('uml composition', function () {
            var edge = new mxCell('1', new mxGeometry(0, 0, 0, 0), 'endArrow=open;html=1;endSize=12;startArrow=diamondThin;startSize=14;startFill=1;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=bottom;');
            edge.geometry.setTerminalPoint(new mxPoint(0, 0), true);
            edge.geometry.setTerminalPoint(new mxPoint(160, 0), false);
            edge.geometry.relative = true;
            edge.geometry.x = -1;
            edge.geometry.y = 3;
            edge.edge = true;

            return sb.createEdgeTemplateFromCells([edge], 160, 0, 'Composition 1');
        }),
        this.addEntry('uml relation', function () {
            var edge = new mxCell('Relation', new mxGeometry(0, 0, 0, 0), 'endArrow=open;html=1;endSize=12;startArrow=diamondThin;startSize=14;startFill=0;edgeStyle=orthogonalEdgeStyle;');
            edge.geometry.setTerminalPoint(new mxPoint(0, 0), true);
            edge.geometry.setTerminalPoint(new mxPoint(160, 0), false);
            edge.geometry.relative = true;
            edge.edge = true;

            var cell1 = new mxCell('0..n', new mxGeometry(-1, 0, 0, 0), 'resizable=0;html=1;align=left;verticalAlign=top;labelBackgroundColor=#ffffff;fontSize=10;');
            cell1.geometry.relative = true;
            cell1.setConnectable(false);
            cell1.vertex = true;
            edge.insert(cell1);

            var cell2 = new mxCell('1', new mxGeometry(1, 0, 0, 0), 'resizable=0;html=1;align=right;verticalAlign=top;labelBackgroundColor=#ffffff;fontSize=10;');
            cell2.geometry.relative = true;
            cell2.setConnectable(false);
            cell2.vertex = true;
            edge.insert(cell2);

            return sb.createEdgeTemplateFromCells([edge], 160, 0, 'Relation 2');
        }),
        this.createEdgeTemplateEntry('endArrow=open;endSize=12;dashed=1;html=1;', 160, 0, 'Use', 'Dependency', null, 'uml dependency use'),
        this.createEdgeTemplateEntry('endArrow=block;endSize=16;endFill=0;html=1;', 160, 0, 'Extends', 'Generalization', null, 'uml generalization extend'),
        this.createEdgeTemplateEntry('endArrow=block;startArrow=block;endFill=1;startFill=1;html=1;', 160, 0, '', 'Association 2', null, 'uml association'),
        this.createEdgeTemplateEntry('endArrow=open;startArrow=circlePlus;endFill=0;startFill=0;endSize=8;html=1;', 160, 0, '', 'Inner Class', null, 'uml inner class'),
        this.createEdgeTemplateEntry('endArrow=open;startArrow=cross;endFill=0;startFill=0;endSize=8;startSize=10;html=1;', 160, 0, '', 'Terminate', null, 'uml terminate'),
        this.createEdgeTemplateEntry('endArrow=block;dashed=1;endFill=0;endSize=12;html=1;', 160, 0, '', 'Implementation', null, 'uml realization implementation'),
        this.createEdgeTemplateEntry('endArrow=diamondThin;endFill=0;endSize=24;html=1;', 160, 0, '', 'Aggregation 2', null, 'uml aggregation'),
        this.createEdgeTemplateEntry('endArrow=diamondThin;endFill=1;endSize=24;html=1;', 160, 0, '', 'Composition 2', null, 'uml composition'),
        this.createEdgeTemplateEntry('endArrow=open;endFill=1;endSize=12;html=1;', 160, 0, '', 'Association 3', null, 'uml association')
    ];

    this.addPaletteFunctions('uml', mxResources.get('uml'), expand || false, fns);
};

/**
 * Adds the BPMN library to the sidebar.
 */
Sidebar.prototype.addBpmnPalette = function (dir, expand) {
    // Avoids having to bind all functions to "this"
    var sb = this;

    var fns =
        [
            this.createVertexTemplateEntry('shape=ext;rounded=1;html=1;whiteSpace=wrap;', 120, 80, 'Task', 'Process', null, null, 'bpmn task process'),
            this.createVertexTemplateEntry('shape=ext;rounded=1;html=1;whiteSpace=wrap;double=1;', 120, 80, 'Transaction', 'Transaction', null, null, 'bpmn transaction'),
            this.createVertexTemplateEntry('shape=ext;rounded=1;html=1;whiteSpace=wrap;dashed=1;dashPattern=1 4;', 120, 80, 'Event\nSub-Process', 'Event Sub-Process', null, null, 'bpmn event subprocess sub process sub-process'),
            this.createVertexTemplateEntry('shape=ext;rounded=1;html=1;whiteSpace=wrap;strokeWidth=3;', 120, 80, 'Call Activity', 'Call Activity', null, null, 'bpmn call activity'),
            this.addEntry('bpmn subprocess sub process sub-process', function () {
                var cell = new mxCell('Sub-Process', new mxGeometry(0, 0, 120, 80), 'html=1;whiteSpace=wrap;rounded=1;');
                cell.vertex = true;

                var cell1 = new mxCell('', new mxGeometry(0.5, 1, 14, 14), 'html=1;shape=plus;outlineConnect=0;');
                cell1.vertex = true;
                cell1.geometry.relative = true;
                cell1.geometry.offset = new mxPoint(-7, -14);
                cell.insert(cell1);

                return sb.createVertexTemplateFromCells([cell], cell.geometry.width, cell.geometry.height, 'Sub-Process');
            }),
            this.addEntry(this.getTagsForStencil('mxgraph.bpmn', 'loop', 'subprocess sub process sub-process looped').join(' '), function () {
                var cell = new mxCell('Looped\nSub-Process', new mxGeometry(0, 0, 120, 80), 'html=1;whiteSpace=wrap;rounded=1');
                cell.vertex = true;

                var cell1 = new mxCell('', new mxGeometry(0.5, 1, 14, 14), 'html=1;shape=mxgraph.bpmn.loop;outlineConnect=0;');
                cell1.vertex = true;
                cell1.geometry.relative = true;
                cell1.geometry.offset = new mxPoint(-15, -14);
                cell.insert(cell1);

                var cell2 = new mxCell('', new mxGeometry(0.5, 1, 14, 14), 'html=1;shape=plus;');
                cell2.vertex = true;
                cell2.geometry.relative = true;
                cell2.geometry.offset = new mxPoint(1, -14);
                cell.insert(cell2);

                return sb.createVertexTemplateFromCells([cell], cell.geometry.width, cell.geometry.height, 'Looped Sub-Process');
            }),
            this.addEntry('bpmn receive task', function () {
                var cell = new mxCell('Receive', new mxGeometry(0, 0, 120, 80), 'html=1;whiteSpace=wrap;rounded=1;');
                cell.vertex = true;

                var cell1 = new mxCell('', new mxGeometry(0, 0, 20, 14), 'html=1;shape=message;outlineConnect=0;');
                cell1.vertex = true;
                cell1.geometry.relative = true;
                cell1.geometry.offset = new mxPoint(7, 7);
                cell.insert(cell1);

                return sb.createVertexTemplateFromCells([cell], cell.geometry.width, cell.geometry.height, 'Receive Task');
            }),
            this.addEntry(this.getTagsForStencil('mxgraph.bpmn', 'user_task').join(' '), function () {
                var cell = new mxCell('User', new mxGeometry(0, 0, 120, 80), 'html=1;whiteSpace=wrap;rounded=1;');
                cell.vertex = true;

                var cell1 = new mxCell('', new mxGeometry(0, 0, 14, 14), 'html=1;shape=mxgraph.bpmn.user_task;outlineConnect=0;');
                cell1.vertex = true;
                cell1.geometry.relative = true;
                cell1.geometry.offset = new mxPoint(7, 7);
                cell.insert(cell1);

                var cell2 = new mxCell('', new mxGeometry(0.5, 1, 14, 14), 'html=1;shape=plus;outlineConnect=0;');
                cell2.vertex = true;
                cell2.geometry.relative = true;
                cell2.geometry.offset = new mxPoint(-7, -14);
                cell.insert(cell2);

                return sb.createVertexTemplateFromCells([cell], cell.geometry.width, cell.geometry.height, 'User Task');
            }),
            this.addEntry(this.getTagsForStencil('mxgraph.bpmn', 'timer_start', 'attached').join(' '), function () {
                var cell = new mxCell('Process', new mxGeometry(0, 0, 120, 80), 'html=1;whiteSpace=wrap;rounded=1;');
                cell.vertex = true;

                var cell1 = new mxCell('', new mxGeometry(1, 1, 30, 30), 'shape=mxgraph.bpmn.timer_start;perimeter=ellipsePerimeter;html=1;verticalLabelPosition=bottom;labelBackgroundColor=#ffffff;verticalAlign=top;outlineConnect=0;');
                cell1.vertex = true;
                cell1.geometry.relative = true;
                cell1.geometry.offset = new mxPoint(-40, -15);
                cell.insert(cell1);

                return sb.createVertexTemplateFromCells([cell], 120, 95, 'Attached Timer Event 1');
            }),
            this.addEntry(this.getTagsForStencil('mxgraph.bpmn', 'timer_start', 'attached').join(' '), function () {
                var cell = new mxCell('Process', new mxGeometry(0, 0, 120, 80), 'html=1;whiteSpace=wrap;rounded=1;');
                cell.vertex = true;

                var cell1 = new mxCell('', new mxGeometry(1, 0, 30, 30), 'shape=mxgraph.bpmn.timer_start;perimeter=ellipsePerimeter;html=1;labelPosition=right;labelBackgroundColor=#ffffff;align=left;outlineConnect=0;');
                cell1.vertex = true;
                cell1.geometry.relative = true;
                cell1.geometry.offset = new mxPoint(-15, 10);
                cell.insert(cell1);

                return sb.createVertexTemplateFromCells([cell], 135, 80, 'Attached Timer Event 2');
            }),
            this.createVertexTemplateEntry('swimlane;html=1;horizontal=0;startSize=20;', 320, 240, 'Pool', 'Pool', null, null, 'bpmn pool'),
            this.createVertexTemplateEntry('swimlane;html=1;horizontal=0;swimlaneLine=0;', 300, 120, 'Lane', 'Lane', null, null, 'bpmn lane'),
            this.createVertexTemplateEntry('shape=hexagon;html=1;whiteSpace=wrap;perimeter=hexagonPerimeter;rounded=0;', 60, 50, '', 'Conversation', null, null, 'bpmn conversation'),
            this.createVertexTemplateEntry('shape=hexagon;html=1;whiteSpace=wrap;perimeter=hexagonPerimeter;strokeWidth=4;rounded=0;', 60, 50, '', 'Call Conversation', null, null, 'bpmn call conversation'),
            this.addEntry('bpmn subconversation sub conversation sub-conversation', function () {
                var cell = new mxCell('', new mxGeometry(0, 0, 60, 50), 'shape=hexagon;whiteSpace=wrap;html=1;perimeter=hexagonPerimeter;rounded=0;');
                cell.vertex = true;

                var cell1 = new mxCell('', new mxGeometry(0.5, 1, 14, 14), 'html=1;shape=plus;');
                cell1.vertex = true;
                cell1.geometry.relative = true;
                cell1.geometry.offset = new mxPoint(-7, -14);
                cell.insert(cell1);

                return sb.createVertexTemplateFromCells([cell], cell.geometry.width, cell.geometry.height, 'Sub-Conversation');
            }),
            this.addEntry('bpmn data object', function () {
                var cell = new mxCell('', new mxGeometry(0, 0, 40, 60), 'shape=note;whiteSpace=wrap;size=16;html=1;');
                cell.vertex = true;

                var cell1 = new mxCell('', new mxGeometry(0, 0, 14, 14), 'html=1;shape=singleArrow;arrowWidth=0.4;arrowSize=0.4;outlineConnect=0;');
                cell1.vertex = true;
                cell1.geometry.relative = true;
                cell1.geometry.offset = new mxPoint(2, 2);
                cell.insert(cell1);

                var cell2 = new mxCell('', new mxGeometry(0.5, 1, 14, 14), 'html=1;whiteSpace=wrap;shape=parallelMarker;outlineConnect=0;');
                cell2.vertex = true;
                cell2.geometry.relative = true;
                cell2.geometry.offset = new mxPoint(-7, -14);
                cell.insert(cell2);

                return sb.createVertexTemplateFromCells([cell], cell.geometry.width, cell.geometry.height, 'Data Object');
            }),
            this.createVertexTemplateEntry('shape=datastore;whiteSpace=wrap;html=1;', 60, 60, '', 'Data Store', null, null, 'bpmn data store'),
            this.createVertexTemplateEntry('shape=plus;html=1;outlineConnect=0;', 14, 14, '', 'Sub-Process Marker', null, null, 'bpmn subprocess sub process sub-process marker'),
            this.createVertexTemplateEntry('shape=mxgraph.bpmn.loop;html=1;outlineConnect=0;', 14, 14, '', 'Loop Marker', null, null, 'bpmn loop marker'),
            this.createVertexTemplateEntry('shape=parallelMarker;html=1;outlineConnect=0;', 14, 14, '', 'Parallel MI Marker', null, null, 'bpmn parallel mi marker'),
            this.createVertexTemplateEntry('shape=parallelMarker;direction=south;html=1;outlineConnect=0;', 14, 14, '', 'Sequential MI Marker', null, null, 'bpmn sequential mi marker'),
            this.createVertexTemplateEntry('shape=mxgraph.bpmn.ad_hoc;fillColor=#000000;html=1;outlineConnect=0;', 14, 14, '', 'Ad Hoc Marker', null, null, 'bpmn ad hoc marker'),
            this.createVertexTemplateEntry('shape=mxgraph.bpmn.compensation;html=1;outlineConnect=0;', 14, 14, '', 'Compensation Marker', null, null, 'bpmn compensation marker'),
            this.createVertexTemplateEntry('shape=message;whiteSpace=wrap;html=1;outlineConnect=0;fillColor=#000000;strokeColor=#ffffff;strokeWidth=2;', 40, 30, '', 'Send Task', null, null, 'bpmn send task'),
            this.createVertexTemplateEntry('shape=message;whiteSpace=wrap;html=1;outlineConnect=0;', 40, 30, '', 'Receive Task', null, null, 'bpmn receive task'),
            this.createVertexTemplateEntry('shape=mxgraph.bpmn.user_task;html=1;outlineConnect=0;', 14, 14, '', 'User Task', null, null, this.getTagsForStencil('mxgraph.bpmn', 'user_task').join(' ')),
            this.createVertexTemplateEntry('shape=mxgraph.bpmn.manual_task;html=1;outlineConnect=0;', 14, 14, '', 'Manual Task', null, null, this.getTagsForStencil('mxgraph.bpmn', 'user_task').join(' ')),
            this.createVertexTemplateEntry('shape=mxgraph.bpmn.business_rule_task;html=1;outlineConnect=0;', 14, 14, '', 'Business Rule Task', null, null, this.getTagsForStencil('mxgraph.bpmn', 'business_rule_task').join(' ')),
            this.createVertexTemplateEntry('shape=mxgraph.bpmn.service_task;html=1;outlineConnect=0;', 14, 14, '', 'Service Task', null, null, this.getTagsForStencil('mxgraph.bpmn', 'service_task').join(' ')),
            this.createVertexTemplateEntry('shape=mxgraph.bpmn.script_task;html=1;outlineConnect=0;', 14, 14, '', 'Script Task', null, null, this.getTagsForStencil('mxgraph.bpmn', 'script_task').join(' ')),
            this.createVertexTemplateEntry('html=1;shape=mxgraph.flowchart.annotation_2;align=left;labelPosition=right;', 50, 100, '', 'Annotation', null, null, this.getTagsForStencil('bpmn', 'annotation_1', 'bpmn business process model ').join(' ')),
            this.createVertexTemplateEntry('rounded=1;arcSize=10;dashed=1;strokeColor=#000000;fillColor=none;gradientColor=none;dashPattern=8 3 1 3;strokeWidth=2;',
                200, 200, '', 'Group', null, null, this.getTagsForStencil('bpmn', 'group', 'bpmn business process model ').join(' ')),
            this.createEdgeTemplateEntry('endArrow=block;endFill=1;endSize=6;html=1;', 100, 0, '', 'Sequence Flow', null, 'bpmn sequence flow'),
            this.createEdgeTemplateEntry('startArrow=dash;startSize=8;endArrow=block;endFill=1;endSize=6;html=1;', 100, 0, '', 'Default Flow', null, 'bpmn default flow'),
            this.createEdgeTemplateEntry('startArrow=diamondThin;startFill=0;startSize=14;endArrow=block;endFill=1;endSize=6;html=1;', 100, 0, '', 'Conditional Flow', null, 'bpmn conditional flow'),
            this.createEdgeTemplateEntry('startArrow=oval;startFill=0;startSize=7;endArrow=block;endFill=0;endSize=10;dashed=1;html=1;', 100, 0, '', 'Message Flow 1', null, 'bpmn message flow'),
            this.addEntry('bpmn message flow', function () {
                var edge = new mxCell('', new mxGeometry(0, 0, 0, 0), 'startArrow=oval;startFill=0;startSize=7;endArrow=block;endFill=0;endSize=10;dashed=1;html=1;');
                edge.geometry.setTerminalPoint(new mxPoint(0, 0), true);
                edge.geometry.setTerminalPoint(new mxPoint(100, 0), false);
                edge.geometry.relative = true;
                edge.edge = true;

                var cell = new mxCell('', new mxGeometry(0, 0, 20, 14), 'shape=message;html=1;outlineConnect=0;');
                cell.geometry.relative = true;
                cell.vertex = true;
                cell.geometry.offset = new mxPoint(-10, -7);
                edge.insert(cell);

                return sb.createEdgeTemplateFromCells([edge], 100, 0, 'Message Flow 2');
            }),
            this.createEdgeTemplateEntry('shape=link;html=1;', 100, 0, '', 'Link', null, 'bpmn link')
        ];

    this.addPaletteFunctions('bpmn', 'BPMN ' + mxResources.get('general'), false, fns);
};

/**
 * Creates and returns the given title element.
 */
Sidebar.prototype.createTitle = function (label) {
    var elt = document.createElement('a');
    elt.setAttribute('title', mxResources.get('sidebarTooltip'));
    elt.className = 'geTitle';
    mxUtils.write(elt, label);

    return elt;
};

/**
 * Creates a thumbnail for the given cells.
 */
Sidebar.prototype.createThumb = function (cells, width, height, parent, title, showLabel, showTitle, realWidth, realHeight) {
    this.graph.labelsVisible = (showLabel == null || showLabel);
    var fo = mxClient.NO_FO;
    mxClient.NO_FO = Editor.prototype.originalNoForeignObject;
    this.graph.view.scaleAndTranslate(1, 0, 0);
    this.graph.addCells(cells);
    var bounds = this.graph.getGraphBounds();
    var s = Math.floor(Math.min((width - 2 * this.thumbBorder) / bounds.width,
        (height - 2 * this.thumbBorder) / bounds.height) * 100) / 100;
    this.graph.view.scaleAndTranslate(s, Math.floor((width - bounds.width * s) / 2 / s - bounds.x),
        Math.floor((height - bounds.height * s) / 2 / s - bounds.y));
    var node = null;

    // For supporting HTML labels in IE9 standards mode the container is cloned instead
    if (this.graph.dialect == mxConstants.DIALECT_SVG && !mxClient.NO_FO &&
        this.graph.view.getCanvas().ownerSVGElement != null) {
        node = this.graph.view.getCanvas().ownerSVGElement.cloneNode(true);
    }
    // LATER: Check if deep clone can be used for quirks if container in DOM
    else {
        node = this.graph.container.cloneNode(false);
        node.innerHTML = this.graph.container.innerHTML;

        // Workaround for clipping in older IE versions
        if (mxClient.IS_QUIRKS || document.documentMode == 8) {
            node.firstChild.style.overflow = 'visible';
        }
    }

    this.graph.getModel().clear();
    mxClient.NO_FO = fo;

    // Catch-all event handling
    if (mxClient.IS_IE6) {
        parent.style.backgroundImage = 'url(' + this.editorUi.editor.transparentImage + ')';
    }

    node.style.position = 'relative';
    node.style.overflow = 'hidden';
    node.style.left = this.thumbBorder + 'px';
    node.style.top = this.thumbBorder + 'px';
    node.style.width = width + 'px';
    node.style.height = height + 'px';
    node.style.visibility = '';
    node.style.minWidth = '';
    node.style.minHeight = '';

    parent.appendChild(node);

    // Adds title for sidebar entries
    if (this.sidebarTitles && title != null && showTitle != false) {
        var border = (mxClient.IS_QUIRKS) ? 2 * this.thumbPadding + 2 : 0;
        parent.style.height = (this.thumbHeight + border + this.sidebarTitleSize + 8) + 'px';

        var div = document.createElement('div');
        div.style.fontSize = this.sidebarTitleSize + 'px';
        div.style.color = '#303030';
        div.style.textAlign = 'center';
        div.style.whiteSpace = 'nowrap';

        if (mxClient.IS_IE) {
            div.style.height = (this.sidebarTitleSize + 12) + 'px';
        }

        div.style.paddingTop = '4px';
        mxUtils.write(div, title);
        parent.appendChild(div);
    }

    return bounds;
};

/**
 * Creates and returns a new palette item for the given image.
 */
Sidebar.prototype.createItem = function (cells, title, showLabel, showTitle, width, height, allowCellsInserted) {
    var elt = document.createElement('a');
    elt.className = 'geItem';
    elt.style.overflow = 'hidden';
    var border = (mxClient.IS_QUIRKS) ? 8 + 2 * this.thumbPadding : 2 * this.thumbBorder;
    elt.style.width = (this.thumbWidth + border) + 'px';
    elt.style.height = (this.thumbHeight + border) + 'px';
    elt.style.padding = this.thumbPadding + 'px';

    if (mxClient.IS_IE6) {
        elt.style.border = 'none';
    }

    // Blocks default click action
    mxEvent.addListener(elt, 'click', function (evt) {
        mxEvent.consume(evt);
    });

    this.createThumb(cells, this.thumbWidth, this.thumbHeight, elt, title, showLabel, showTitle, width, height);
    var bounds = new mxRectangle(0, 0, width, height);

    if (cells.length > 1 || cells[0].vertex) {
        var ds = this.createDragSource(elt, this.createDropHandler(cells, true, allowCellsInserted,
            bounds), this.createDragPreview(width, height), cells, bounds);
        this.addClickHandler(elt, ds, cells);

        // Uses guides for vertices only if enabled in graph
        ds.isGuidesEnabled = mxUtils.bind(this, function () {
            return this.editorUi.editor.graph.graphHandler.guidesEnabled;
        });
    } else if (cells[0] != null && cells[0].edge) {
        var ds = this.createDragSource(elt, this.createDropHandler(cells, false, allowCellsInserted,
            bounds), this.createDragPreview(width, height), cells, bounds);
        this.addClickHandler(elt, ds, cells);
    }

    // Shows a tooltip with the rendered cell
    if (!mxClient.IS_IOS) {
        mxEvent.addGestureListeners(elt, null, mxUtils.bind(this, function (evt) {
            if (mxEvent.isMouseEvent(evt)) {
                this.showTooltip(elt, cells, bounds.width, bounds.height, title, showLabel);
            }
        }));
    }

    return elt;
};

/**
 * Creates a drop handler for inserting the given cells.
 */
Sidebar.prototype.updateShapes = function (source, targets) {
    var graph = this.editorUi.editor.graph;
    var sourceCellStyle = graph.getCellStyle(source);
    var result = [];

    graph.model.beginUpdate();
    try {
        var cellStyle = graph.getModel().getStyle(source);

        // Lists the styles to carry over from the existing shape
        var styles = ['shadow', 'dashed', 'dashPattern', 'fontFamily', 'fontSize', 'fontColor', 'align', 'startFill',
            'startSize', 'endFill', 'endSize', 'strokeColor', 'strokeWidth', 'fillColor', 'gradientColor',
            'html', 'part', 'noEdgeStyle', 'edgeStyle', 'elbow', 'childLayout', 'recursiveResize',
            'container', 'collapsible', 'connectable'];

        for (var i = 0; i < targets.length; i++) {
            var targetCell = targets[i];

            if ((graph.getModel().isVertex(targetCell) == graph.getModel().isVertex(source)) ||
                (graph.getModel().isEdge(targetCell) == graph.getModel().isEdge(source))) {
                var state = graph.view.getState(targetCell);
                var style = (state != null) ? state.style : graph.getCellStyle(targets[i]);
                graph.getModel().setStyle(targetCell, cellStyle);

                // Removes all children of composite cells
                if (state != null && mxUtils.getValue(state.style, 'composite', '0') == '1') {
                    var childCount = graph.model.getChildCount(targetCell);

                    for (var j = childCount; j >= 0; j--) {
                        graph.model.remove(graph.model.getChildAt(targetCell, j));
                    }
                }

                if (style != null) {
                    // Replaces the participant style in the lifeline shape with the target shape
                    if (style[mxConstants.STYLE_SHAPE] == 'umlLifeline' &&
                        sourceCellStyle[mxConstants.STYLE_SHAPE] != 'umlLifeline') {
                        graph.setCellStyles(mxConstants.STYLE_SHAPE, 'umlLifeline', [targetCell]);
                        graph.setCellStyles('participant', sourceCellStyle[mxConstants.STYLE_SHAPE], [targetCell]);
                    }

                    for (var j = 0; j < styles.length; j++) {
                        var value = style[styles[j]];

                        if (value != null) {
                            graph.setCellStyles(styles[j], value, [targetCell]);
                        }
                    }
                }

                result.push(targetCell);
            }
        }
    } finally {
        graph.model.endUpdate();
    }

    return result;
};

/**
 * Creates a drop handler for inserting the given cells.
 */
Sidebar.prototype.createDropHandler = function (cells, allowSplit, allowCellsInserted, bounds) {
    allowCellsInserted = (allowCellsInserted != null) ? allowCellsInserted : true;

    return mxUtils.bind(this, function (graph, evt, target, x, y, force) {
        var elt = (force) ? null : ((mxEvent.isTouchEvent(evt) || mxEvent.isPenEvent(evt)) ?
            document.elementFromPoint(mxEvent.getClientX(evt), mxEvent.getClientY(evt)) :
            mxEvent.getSource(evt));

        while (elt != null && elt != this.container) {
            elt = elt.parentNode;
        }

        if (elt == null && graph.isEnabled()) {
            cells = graph.getImportableCells(cells);

            if (cells.length > 0) {
                graph.stopEditing();

                // Holding alt while mouse is released ignores drop target
                var validDropTarget = (target != null && !mxEvent.isAltDown(evt)) ?
                    graph.isValidDropTarget(target, cells, evt) : false;
                var select = null;

                if (target != null && !validDropTarget) {
                    target = null;
                }

                if (!graph.isCellLocked(target || graph.getDefaultParent())) {
                    graph.model.beginUpdate();
                    try {
                        x = Math.round(x);
                        y = Math.round(y);

                        // Splits the target edge or inserts into target group
                        if (allowSplit && graph.isSplitTarget(target, cells, evt)) {
                            var clones = graph.cloneCells(cells);
                            graph.splitEdge(target, clones, null,
                                x - bounds.width / 2, y - bounds.height / 2);
                            select = clones;
                        } else if (cells.length > 0) {
                            select = graph.importCells(cells, x, y, target);
                        }

                        // Executes parent layout hooks for position/order
                        if (graph.layoutManager != null) {
                            var layout = graph.layoutManager.getLayout(target);

                            if (layout != null) {
                                var s = graph.view.scale;
                                var tr = graph.view.translate;
                                var tx = (x + tr.x) * s;
                                var ty = (y + tr.y) * s;

                                for (var i = 0; i < select.length; i++) {
                                    layout.moveCell(select[i], tx, ty);
                                }
                            }
                        }

                        if (allowCellsInserted && (evt == null || !mxEvent.isShiftDown(evt))) {
                            graph.fireEvent(new mxEventObject('cellsInserted', 'cells', select));
                        }
                    } catch (e) {
                        this.editorUi.handleError(e);
                    } finally {
                        graph.model.endUpdate();
                    }

                    if (select != null && select.length > 0) {
                        graph.scrollCellToVisible(select[0]);
                        graph.setSelectionCells(select);
                    }

                    if (graph.editAfterInsert && evt != null && mxEvent.isMouseEvent(evt) &&
                        select != null && select.length == 1) {
                        window.setTimeout(function () {
                            graph.startEditing(select[0]);
                        }, 0);
                    }
                }
            }

            mxEvent.consume(evt);
        }
    });
};

/**
 * Creates and returns a preview element for the given width and height.
 */
Sidebar.prototype.createDragPreview = function (width, height) {
    var elt = document.createElement('div');
    elt.style.border = this.dragPreviewBorder;
    elt.style.width = width + 'px';
    elt.style.height = height + 'px';

    return elt;
};

/**
 * Creates a drag source for the given element.
 */
Sidebar.prototype.dropAndConnect = function (source, targets, direction, dropCellIndex, evt) {
    var geo = this.getDropAndConnectGeometry(source, targets[dropCellIndex], direction, targets);

    // Targets without the new edge for selection
    var tmp = [];

    if (geo != null) {
        var graph = this.editorUi.editor.graph;
        var editingCell = null;

        graph.model.beginUpdate();
        try {
            var sourceGeo = graph.getCellGeometry(source);
            var geo2 = graph.getCellGeometry(targets[dropCellIndex]);

            // Handles special case where target should be ignored for stack layouts
            var targetParent = graph.model.getParent(source);
            var validLayout = true;

            // Ignores parent if it has a stack layout
            if (graph.layoutManager != null) {
                var layout = graph.layoutManager.getLayout(targetParent);

                // LATER: Use parent of parent if valid layout
                if (layout != null && layout.constructor == mxStackLayout) {
                    validLayout = false;

                    var tmp = graph.view.getState(targetParent);

                    // Offsets by parent position
                    if (tmp != null) {
                        var offset = new mxPoint((tmp.x / graph.view.scale - graph.view.translate.x),
                            (tmp.y / graph.view.scale - graph.view.translate.y));
                        geo.x += offset.x;
                        geo.y += offset.y;
                        var pt = geo.getTerminalPoint(false);

                        if (pt != null) {
                            pt.x += offset.x;
                            pt.y += offset.y;
                        }
                    }
                }
            }

            var dx = geo2.x;
            var dy = geo2.y;

            // Ignores geometry of edges
            if (graph.model.isEdge(targets[dropCellIndex])) {
                dx = 0;
                dy = 0;
            }

            var useParent = graph.model.isEdge(source) || (sourceGeo != null && !sourceGeo.relative && validLayout);
            targets = graph.importCells(targets, (geo.x - (useParent ? dx : 0)),
                (geo.y - (useParent ? dy : 0)), (useParent) ? targetParent : null);
            tmp = targets;

            if (graph.model.isEdge(source)) {
                // Adds new terminal to edge
                // LATER: Push new terminal out radially from edge start point
                graph.model.setTerminal(source, targets[dropCellIndex], direction == mxConstants.DIRECTION_NORTH);
            } else if (graph.model.isEdge(targets[dropCellIndex])) {
                // Adds new outgoing connection to vertex and clears points
                graph.model.setTerminal(targets[dropCellIndex], source, true);
                var geo3 = graph.getCellGeometry(targets[dropCellIndex]);
                geo3.points = null;

                if (geo3.getTerminalPoint(false) != null) {
                    geo3.setTerminalPoint(geo.getTerminalPoint(false), false);
                } else if (useParent && graph.model.isVertex(targetParent)) {
                    // Adds parent offset to other nodes
                    var tmpState = graph.view.getState(targetParent);
                    var offset = (tmpState.cell != graph.view.currentRoot) ?
                        new mxPoint((tmpState.x / graph.view.scale - graph.view.translate.x),
                            (tmpState.y / graph.view.scale - graph.view.translate.y)) : new mxPoint(0, 0);

                    graph.cellsMoved(targets, offset.x, offset.y, null, null, true);
                }
            } else {
                geo2 = graph.getCellGeometry(targets[dropCellIndex]);
                dx = geo.x - Math.round(geo2.x);
                dy = geo.y - Math.round(geo2.y);
                geo.x = Math.round(geo2.x);
                geo.y = Math.round(geo2.y);
                graph.model.setGeometry(targets[dropCellIndex], geo);
                graph.cellsMoved(targets, dx, dy, null, null, true);
                tmp = targets.slice();
                editingCell = (tmp.length == 1) ? tmp[0] : null;
                targets.push(graph.insertEdge(null, null, '', source, targets[dropCellIndex],
                    graph.createCurrentEdgeStyle()));
            }

            if (evt == null || !mxEvent.isShiftDown(evt)) {
                graph.fireEvent(new mxEventObject('cellsInserted', 'cells', targets));
            }
        } catch (e) {
            this.editorUi.handleError(e);
        } finally {
            graph.model.endUpdate();
        }

        if (graph.editAfterInsert && evt != null && mxEvent.isMouseEvent(evt) &&
            editingCell != null) {
            window.setTimeout(function () {
                graph.startEditing(editingCell);
            }, 0);
        }
    }

    return tmp;
};

/**
 * Creates a drag source for the given element.
 */
Sidebar.prototype.getDropAndConnectGeometry = function (source, target, direction, targets) {
    var graph = this.editorUi.editor.graph;
    var view = graph.view;
    var keepSize = targets.length > 1;
    var geo = graph.getCellGeometry(source);
    var geo2 = graph.getCellGeometry(target);

    if (geo != null && geo2 != null) {
        geo2 = geo2.clone();

        if (graph.model.isEdge(source)) {
            var state = graph.view.getState(source);
            var pts = state.absolutePoints;
            var p0 = pts[0];
            var pe = pts[pts.length - 1];

            if (direction == mxConstants.DIRECTION_NORTH) {
                geo2.x = p0.x / view.scale - view.translate.x - geo2.width / 2;
                geo2.y = p0.y / view.scale - view.translate.y - geo2.height / 2;
            } else {
                geo2.x = pe.x / view.scale - view.translate.x - geo2.width / 2;
                geo2.y = pe.y / view.scale - view.translate.y - geo2.height / 2;
            }
        } else {
            if (geo.relative) {
                var state = graph.view.getState(source);
                geo = geo.clone();
                geo.x = (state.x - view.translate.x) / view.scale;
                geo.y = (state.y - view.translate.y) / view.scale;
            }

            var length = graph.defaultEdgeLength;

            // Maintains edge length
            if (graph.model.isEdge(target) && geo2.getTerminalPoint(true) != null && geo2.getTerminalPoint(false) != null) {
                var p0 = geo2.getTerminalPoint(true);
                var pe = geo2.getTerminalPoint(false);
                var dx = pe.x - p0.x;
                var dy = pe.y - p0.y;

                length = Math.sqrt(dx * dx + dy * dy);

                geo2.x = geo.getCenterX();
                geo2.y = geo.getCenterY();
                geo2.width = 1;
                geo2.height = 1;

                if (direction == mxConstants.DIRECTION_NORTH) {
                    geo2.height = length
                    geo2.y = geo.y - length;
                    geo2.setTerminalPoint(new mxPoint(geo2.x, geo2.y), false);
                } else if (direction == mxConstants.DIRECTION_EAST) {
                    geo2.width = length
                    geo2.x = geo.x + geo.width;
                    geo2.setTerminalPoint(new mxPoint(geo2.x + geo2.width, geo2.y), false);
                } else if (direction == mxConstants.DIRECTION_SOUTH) {
                    geo2.height = length
                    geo2.y = geo.y + geo.height;
                    geo2.setTerminalPoint(new mxPoint(geo2.x, geo2.y + geo2.height), false);
                } else if (direction == mxConstants.DIRECTION_WEST) {
                    geo2.width = length
                    geo2.x = geo.x - length;
                    geo2.setTerminalPoint(new mxPoint(geo2.x, geo2.y), false);
                }
            } else {
                // Try match size or ignore if width or height < 45 which
                // is considered special enough to be ignored here
                if (!keepSize && geo2.width > 45 && geo2.height > 45 &&
                    geo.width > 45 && geo.height > 45) {
                    geo2.width = geo2.width * (geo.height / geo2.height);
                    geo2.height = geo.height;
                }

                geo2.x = geo.x + geo.width / 2 - geo2.width / 2;
                geo2.y = geo.y + geo.height / 2 - geo2.height / 2;

                if (direction == mxConstants.DIRECTION_NORTH) {
                    geo2.y = geo2.y - geo.height / 2 - geo2.height / 2 - length;
                } else if (direction == mxConstants.DIRECTION_EAST) {
                    geo2.x = geo2.x + geo.width / 2 + geo2.width / 2 + length;
                } else if (direction == mxConstants.DIRECTION_SOUTH) {
                    geo2.y = geo2.y + geo.height / 2 + geo2.height / 2 + length;
                } else if (direction == mxConstants.DIRECTION_WEST) {
                    geo2.x = geo2.x - geo.width / 2 - geo2.width / 2 - length;
                }

                // Adds offset to match cells without connecting edge
                if (graph.model.isEdge(target) && geo2.getTerminalPoint(true) != null && target.getTerminal(false) != null) {
                    var targetGeo = graph.getCellGeometry(target.getTerminal(false));

                    if (targetGeo != null) {
                        if (direction == mxConstants.DIRECTION_NORTH) {
                            geo2.x -= targetGeo.getCenterX();
                            geo2.y -= targetGeo.getCenterY() + targetGeo.height / 2;
                        } else if (direction == mxConstants.DIRECTION_EAST) {
                            geo2.x -= targetGeo.getCenterX() - targetGeo.width / 2;
                            geo2.y -= targetGeo.getCenterY();
                        } else if (direction == mxConstants.DIRECTION_SOUTH) {
                            geo2.x -= targetGeo.getCenterX();
                            geo2.y -= targetGeo.getCenterY() - targetGeo.height / 2;
                        } else if (direction == mxConstants.DIRECTION_WEST) {
                            geo2.x -= targetGeo.getCenterX() + targetGeo.width / 2;
                            geo2.y -= targetGeo.getCenterY();
                        }
                    }
                }
            }
        }
    }

    return geo2;
};

/**
 * Creates a drag source for the given element.
 */
Sidebar.prototype.createDragSource = function (elt, dropHandler, preview, cells, bounds) {
    // Checks if the cells contain any vertices
    var ui = this.editorUi;
    var graph = ui.editor.graph;
    var freeSourceEdge = null;
    var firstVertex = null;
    var sidebar = this;

    for (var i = 0; i < cells.length; i++) {
        if (firstVertex == null && this.editorUi.editor.graph.model.isVertex(cells[i])) {
            firstVertex = i;
        } else if (freeSourceEdge == null && this.editorUi.editor.graph.model.isEdge(cells[i]) &&
            this.editorUi.editor.graph.model.getTerminal(cells[i], true) == null) {
            freeSourceEdge = i;
        }

        if (firstVertex != null && freeSourceEdge != null) {
            break;
        }
    }

    var dragSource = mxUtils.makeDraggable(elt, this.editorUi.editor.graph, mxUtils.bind(this, function (graph, evt, target, x, y) {
        if (this.updateThread != null) {
            window.clearTimeout(this.updateThread);
        }

        if (cells != null && currentStyleTarget != null && activeArrow == styleTarget) {
            var tmp = graph.isCellSelected(currentStyleTarget.cell) ? graph.getSelectionCells() : [currentStyleTarget.cell];
            var updatedCells = this.updateShapes((graph.model.isEdge(currentStyleTarget.cell)) ? cells[0] : cells[firstVertex], tmp);
            graph.setSelectionCells(updatedCells);
        } else if (cells != null && activeArrow != null && currentTargetState != null && activeArrow != styleTarget) {
            var index = (graph.model.isEdge(currentTargetState.cell) || freeSourceEdge == null) ? firstVertex : freeSourceEdge;
            graph.setSelectionCells(this.dropAndConnect(currentTargetState.cell, cells, direction, index, evt));
        } else {
            dropHandler.apply(this, arguments);
        }

        if (this.editorUi.hoverIcons != null) {
            this.editorUi.hoverIcons.update(graph.view.getState(graph.getSelectionCell()));
        }
    }), preview, 0, 0, graph.autoscroll, true, true);

    // Stops dragging if cancel is pressed
    graph.addListener(mxEvent.ESCAPE, function (sender, evt) {
        if (dragSource.isActive()) {
            dragSource.reset();
        }
    });

    // Overrides mouseDown to ignore popup triggers
    var mouseDown = dragSource.mouseDown;

    dragSource.mouseDown = function (evt) {
        if (!mxEvent.isPopupTrigger(evt) && !mxEvent.isMultiTouchEvent(evt)) {
            graph.stopEditing();
            mouseDown.apply(this, arguments);
        }
    };

    // Workaround for event redirection via image tag in quirks and IE8
    function createArrow(img, tooltip) {
        var arrow = null;

        if (mxClient.IS_IE && !mxClient.IS_SVG) {
            // Workaround for PNG images in IE6
            if (mxClient.IS_IE6 && document.compatMode != 'CSS1Compat') {
                arrow = document.createElement(mxClient.VML_PREFIX + ':image');
                arrow.setAttribute('src', img.src);
                arrow.style.borderStyle = 'none';
            } else {
                arrow = document.createElement('div');
                arrow.style.backgroundImage = 'url(' + img.src + ')';
                arrow.style.backgroundPosition = 'center';
                arrow.style.backgroundRepeat = 'no-repeat';
            }

            arrow.style.width = (img.width + 4) + 'px';
            arrow.style.height = (img.height + 4) + 'px';
            arrow.style.display = (mxClient.IS_QUIRKS) ? 'inline' : 'inline-block';
        } else {
            arrow = mxUtils.createImage(img.src);
            arrow.style.width = img.width + 'px';
            arrow.style.height = img.height + 'px';
        }

        if (tooltip != null) {
            arrow.setAttribute('title', tooltip);
        }

        mxUtils.setOpacity(arrow, (img == this.refreshTarget) ? 30 : 20);
        arrow.style.position = 'absolute';
        arrow.style.cursor = 'crosshair';

        return arrow;
    };

    var currentTargetState = null;
    var currentStateHandle = null;
    var currentStyleTarget = null;
    var activeTarget = false;

    var arrowUp = createArrow(this.triangleUp, mxResources.get('connect'));
    var arrowRight = createArrow(this.triangleRight, mxResources.get('connect'));
    var arrowDown = createArrow(this.triangleDown, mxResources.get('connect'));
    var arrowLeft = createArrow(this.triangleLeft, mxResources.get('connect'));
    var styleTarget = createArrow(this.refreshTarget, mxResources.get('replace'));
    // Workaround for actual parentNode not being updated in old IE
    var styleTargetParent = null;
    var roundSource = createArrow(this.roundDrop);
    var roundTarget = createArrow(this.roundDrop);
    var direction = mxConstants.DIRECTION_NORTH;
    var activeArrow = null;

    function checkArrow(x, y, bounds, arrow) {
        if (arrow.parentNode != null) {
            if (mxUtils.contains(bounds, x, y)) {
                mxUtils.setOpacity(arrow, 100);
                activeArrow = arrow;
            } else {
                mxUtils.setOpacity(arrow, (arrow == styleTarget) ? 30 : 20);
            }
        }

        return bounds;
    };

    // Hides guides and preview if target is active
    var dsCreatePreviewElement = dragSource.createPreviewElement;

    // Stores initial size of preview element
    dragSource.createPreviewElement = function (graph) {
        var elt = dsCreatePreviewElement.apply(this, arguments);

        // Pass-through events required to tooltip on replace shape
        if (mxClient.IS_SVG) {
            elt.style.pointerEvents = 'none';
        }

        this.previewElementWidth = elt.style.width;
        this.previewElementHeight = elt.style.height;

        return elt;
    };

    // Shows/hides hover icons
    var dragEnter = dragSource.dragEnter;
    dragSource.dragEnter = function (graph, evt) {
        if (ui.hoverIcons != null) {
            ui.hoverIcons.setDisplay('none');
        }

        dragEnter.apply(this, arguments);
    };

    var dragExit = dragSource.dragExit;
    dragSource.dragExit = function (graph, evt) {
        if (ui.hoverIcons != null) {
            ui.hoverIcons.setDisplay('');
        }

        dragExit.apply(this, arguments);
    };

    dragSource.dragOver = function (graph, evt) {
        mxDragSource.prototype.dragOver.apply(this, arguments);

        if (this.currentGuide != null && activeArrow != null) {
            this.currentGuide.hide();
        }

        if (this.previewElement != null) {
            var view = graph.view;

            if (currentStyleTarget != null && activeArrow == styleTarget) {
                this.previewElement.style.display = (graph.model.isEdge(currentStyleTarget.cell)) ? 'none' : '';

                this.previewElement.style.left = currentStyleTarget.x + 'px';
                this.previewElement.style.top = currentStyleTarget.y + 'px';
                this.previewElement.style.width = currentStyleTarget.width + 'px';
                this.previewElement.style.height = currentStyleTarget.height + 'px';
            } else if (currentTargetState != null && activeArrow != null) {
                var index = (graph.model.isEdge(currentTargetState.cell) || freeSourceEdge == null) ? firstVertex : freeSourceEdge;
                var geo = sidebar.getDropAndConnectGeometry(currentTargetState.cell, cells[index], direction, cells);
                var geo2 = (!graph.model.isEdge(currentTargetState.cell)) ? graph.getCellGeometry(currentTargetState.cell) : null;
                var geo3 = graph.getCellGeometry(cells[index]);
                var parent = graph.model.getParent(currentTargetState.cell);
                var dx = view.translate.x * view.scale;
                var dy = view.translate.y * view.scale;

                if (geo2 != null && !geo2.relative && graph.model.isVertex(parent) && parent != view.currentRoot) {
                    var pState = view.getState(parent);

                    dx = pState.x;
                    dy = pState.y;
                }

                var dx2 = geo3.x;
                var dy2 = geo3.y;

                // Ignores geometry of edges
                if (graph.model.isEdge(cells[index])) {
                    dx2 = 0;
                    dy2 = 0;
                }

                // Shows preview at drop location
                this.previewElement.style.left = ((geo.x - dx2) * view.scale + dx) + 'px';
                this.previewElement.style.top = ((geo.y - dy2) * view.scale + dy) + 'px';

                if (cells.length == 1) {
                    this.previewElement.style.width = (geo.width * view.scale) + 'px';
                    this.previewElement.style.height = (geo.height * view.scale) + 'px';
                }

                this.previewElement.style.display = '';
            } else if (dragSource.currentHighlight.state != null &&
                graph.model.isEdge(dragSource.currentHighlight.state.cell)) {
                // Centers drop cells when splitting edges
                this.previewElement.style.left = Math.round(parseInt(this.previewElement.style.left) -
                    bounds.width * view.scale / 2) + 'px';
                this.previewElement.style.top = Math.round(parseInt(this.previewElement.style.top) -
                    bounds.height * view.scale / 2) + 'px';
            } else {
                this.previewElement.style.width = this.previewElementWidth;
                this.previewElement.style.height = this.previewElementHeight;
                this.previewElement.style.display = '';
            }
        }
    };

    var startTime = new Date().getTime();
    var timeOnTarget = 0;
    var prev = null;

    // Gets source cell style to compare shape below
    var sourceCellStyle = this.editorUi.editor.graph.getCellStyle(cells[0]);

    // Allows drop into cell only if target is a valid root
    dragSource.getDropTarget = mxUtils.bind(this, function (graph, x, y, evt) {
        // Alt means no targets at all
        // LATER: Show preview where result will go
        var cell = (!mxEvent.isAltDown(evt) && cells != null) ? graph.getCellAt(x, y) : null;

        // Uses connectable parent vertex if one exists
        if (cell != null && !this.graph.isCellConnectable(cell)) {
            var parent = this.graph.getModel().getParent(cell);

            if (this.graph.getModel().isVertex(parent) && this.graph.isCellConnectable(parent)) {
                cell = parent;
            }
        }

        // Ignores locked cells
        if (graph.isCellLocked(cell)) {
            cell = null;
        }

        var state = graph.view.getState(cell);
        activeArrow = null;
        var bbox = null;

        // Time on target
        if (prev != state) {
            prev = state;
            startTime = new Date().getTime();
            timeOnTarget = 0;

            if (this.updateThread != null) {
                window.clearTimeout(this.updateThread);
            }

            if (state != null) {
                this.updateThread = window.setTimeout(function () {
                    if (activeArrow == null) {
                        prev = state;
                        dragSource.getDropTarget(graph, x, y, evt);
                    }
                }, this.dropTargetDelay + 10);
            }
        } else {
            timeOnTarget = new Date().getTime() - startTime;
        }

        // Shift means disabled, delayed on cells with children, shows after this.dropTargetDelay, hides after 2500ms
        if (timeOnTarget < 2500 && state != null && !mxEvent.isShiftDown(evt) &&
            // If shape is equal or target has no stroke, fill and gradient then use longer delay except for images
            (((mxUtils.getValue(state.style, mxConstants.STYLE_SHAPE) != mxUtils.getValue(sourceCellStyle, mxConstants.STYLE_SHAPE) &&
                (mxUtils.getValue(state.style, mxConstants.STYLE_STROKECOLOR, mxConstants.NONE) != mxConstants.NONE ||
                    mxUtils.getValue(state.style, mxConstants.STYLE_FILLCOLOR, mxConstants.NONE) != mxConstants.NONE ||
                    mxUtils.getValue(state.style, mxConstants.STYLE_GRADIENTCOLOR, mxConstants.NONE) != mxConstants.NONE)) ||
                mxUtils.getValue(sourceCellStyle, mxConstants.STYLE_SHAPE) == 'image') ||
                timeOnTarget > 1500 || graph.model.isEdge(state.cell)) && (timeOnTarget > this.dropTargetDelay) &&
            ((graph.model.isVertex(state.cell) && firstVertex != null) ||
                (graph.model.isEdge(state.cell) && graph.model.isEdge(cells[0])))) {
            currentStyleTarget = state;
            var tmp = (graph.model.isEdge(state.cell)) ? graph.view.getPoint(state) :
                new mxPoint(state.getCenterX(), state.getCenterY());
            tmp = new mxRectangle(tmp.x - this.refreshTarget.width / 2, tmp.y - this.refreshTarget.height / 2,
                this.refreshTarget.width, this.refreshTarget.height);

            styleTarget.style.left = Math.floor(tmp.x) + 'px';
            styleTarget.style.top = Math.floor(tmp.y) + 'px';

            if (styleTargetParent == null) {
                graph.container.appendChild(styleTarget);
                styleTargetParent = styleTarget.parentNode;
            }

            checkArrow(x, y, tmp, styleTarget);
        }
        // Does not reset on ignored edges
        else if (currentStyleTarget == null || !mxUtils.contains(currentStyleTarget, x, y) ||
            (timeOnTarget > 1500 && !mxEvent.isShiftDown(evt))) {
            currentStyleTarget = null;

            if (styleTargetParent != null) {
                styleTarget.parentNode.removeChild(styleTarget);
                styleTargetParent = null;
            }
        } else if (currentStyleTarget != null && styleTargetParent != null) {
            // Sets active Arrow as side effect
            var tmp = (graph.model.isEdge(currentStyleTarget.cell)) ? graph.view.getPoint(currentStyleTarget) : new mxPoint(currentStyleTarget.getCenterX(), currentStyleTarget.getCenterY());
            tmp = new mxRectangle(tmp.x - this.refreshTarget.width / 2, tmp.y - this.refreshTarget.height / 2,
                this.refreshTarget.width, this.refreshTarget.height);
            checkArrow(x, y, tmp, styleTarget);
        }

        // Checks if inside bounds
        if (activeTarget && currentTargetState != null && !mxEvent.isAltDown(evt) && activeArrow == null) {
            // LATER: Use hit-detection for edges
            bbox = mxRectangle.fromRectangle(currentTargetState);

            if (graph.model.isEdge(currentTargetState.cell)) {
                var pts = currentTargetState.absolutePoints;

                if (roundSource.parentNode != null) {
                    var p0 = pts[0];
                    bbox.add(checkArrow(x, y, new mxRectangle(p0.x - this.roundDrop.width / 2,
                        p0.y - this.roundDrop.height / 2, this.roundDrop.width, this.roundDrop.height), roundSource));
                }

                if (roundTarget.parentNode != null) {
                    var pe = pts[pts.length - 1];
                    bbox.add(checkArrow(x, y, new mxRectangle(pe.x - this.roundDrop.width / 2,
                        pe.y - this.roundDrop.height / 2,
                        this.roundDrop.width, this.roundDrop.height), roundTarget));
                }
            } else {
                var bds = mxRectangle.fromRectangle(currentTargetState);

                // Uses outer bounding box to take rotation into account
                if (currentTargetState.shape != null && currentTargetState.shape.boundingBox != null) {
                    bds = mxRectangle.fromRectangle(currentTargetState.shape.boundingBox);
                }

                bds.grow(this.graph.tolerance);
                bds.grow(HoverIcons.prototype.arrowSpacing);

                var handler = this.graph.selectionCellsHandler.getHandler(currentTargetState.cell);

                if (handler != null) {
                    bds.x -= handler.horizontalOffset / 2;
                    bds.y -= handler.verticalOffset / 2;
                    bds.width += handler.horizontalOffset;
                    bds.height += handler.verticalOffset;

                    // Adds bounding box of rotation handle to avoid overlap
                    if (handler.rotationShape != null && handler.rotationShape.node != null &&
                        handler.rotationShape.node.style.visibility != 'hidden' &&
                        handler.rotationShape.node.style.display != 'none' &&
                        handler.rotationShape.boundingBox != null) {
                        bds.add(handler.rotationShape.boundingBox);
                    }
                }

                bbox.add(checkArrow(x, y, new mxRectangle(currentTargetState.getCenterX() - this.triangleUp.width / 2,
                    bds.y - this.triangleUp.height, this.triangleUp.width, this.triangleUp.height), arrowUp));
                bbox.add(checkArrow(x, y, new mxRectangle(bds.x + bds.width,
                    currentTargetState.getCenterY() - this.triangleRight.height / 2,
                    this.triangleRight.width, this.triangleRight.height), arrowRight));
                bbox.add(checkArrow(x, y, new mxRectangle(currentTargetState.getCenterX() - this.triangleDown.width / 2,
                    bds.y + bds.height, this.triangleDown.width, this.triangleDown.height), arrowDown));
                bbox.add(checkArrow(x, y, new mxRectangle(bds.x - this.triangleLeft.width,
                    currentTargetState.getCenterY() - this.triangleLeft.height / 2,
                    this.triangleLeft.width, this.triangleLeft.height), arrowLeft));
            }

            // Adds tolerance
            if (bbox != null) {
                bbox.grow(10);
            }
        }

        direction = mxConstants.DIRECTION_NORTH;

        if (activeArrow == arrowRight) {
            direction = mxConstants.DIRECTION_EAST;
        } else if (activeArrow == arrowDown || activeArrow == roundTarget) {
            direction = mxConstants.DIRECTION_SOUTH;
        } else if (activeArrow == arrowLeft) {
            direction = mxConstants.DIRECTION_WEST;
        }

        if (currentStyleTarget != null && activeArrow == styleTarget) {
            state = currentStyleTarget;
        }

        var validTarget = (firstVertex == null || graph.isCellConnectable(cells[firstVertex])) &&
            ((graph.model.isEdge(cell) && firstVertex != null) ||
                (graph.model.isVertex(cell) && graph.isCellConnectable(cell)));

        // Drop arrows shown after this.dropTargetDelay, hidden after 5 secs, switches arrows after 500ms
        if ((currentTargetState != null && timeOnTarget >= 5000) ||
            (currentTargetState != state &&
                (bbox == null || !mxUtils.contains(bbox, x, y) ||
                    (timeOnTarget > 500 && activeArrow == null && validTarget)))) {
            activeTarget = false;
            currentTargetState = ((timeOnTarget < 5000 && timeOnTarget > this.dropTargetDelay) || graph.model.isEdge(cell)) ? state : null;

            if (currentTargetState != null && validTarget) {
                var elts = [roundSource, roundTarget, arrowUp, arrowRight, arrowDown, arrowLeft];

                for (var i = 0; i < elts.length; i++) {
                    if (elts[i].parentNode != null) {
                        elts[i].parentNode.removeChild(elts[i]);
                    }
                }

                if (graph.model.isEdge(cell)) {
                    var pts = state.absolutePoints;

                    if (pts != null) {
                        var p0 = pts[0];
                        var pe = pts[pts.length - 1];
                        var tol = graph.tolerance;
                        var box = new mxRectangle(x - tol, y - tol, 2 * tol, 2 * tol);

                        roundSource.style.left = Math.floor(p0.x - this.roundDrop.width / 2) + 'px';
                        roundSource.style.top = Math.floor(p0.y - this.roundDrop.height / 2) + 'px';

                        roundTarget.style.left = Math.floor(pe.x - this.roundDrop.width / 2) + 'px';
                        roundTarget.style.top = Math.floor(pe.y - this.roundDrop.height / 2) + 'px';

                        if (graph.model.getTerminal(cell, true) == null) {
                            graph.container.appendChild(roundSource);
                        }

                        if (graph.model.getTerminal(cell, false) == null) {
                            graph.container.appendChild(roundTarget);
                        }
                    }
                } else {
                    var bds = mxRectangle.fromRectangle(state);

                    // Uses outer bounding box to take rotation into account
                    if (state.shape != null && state.shape.boundingBox != null) {
                        bds = mxRectangle.fromRectangle(state.shape.boundingBox);
                    }

                    bds.grow(this.graph.tolerance);
                    bds.grow(HoverIcons.prototype.arrowSpacing);

                    var handler = this.graph.selectionCellsHandler.getHandler(state.cell);

                    if (handler != null) {
                        bds.x -= handler.horizontalOffset / 2;
                        bds.y -= handler.verticalOffset / 2;
                        bds.width += handler.horizontalOffset;
                        bds.height += handler.verticalOffset;

                        // Adds bounding box of rotation handle to avoid overlap
                        if (handler.rotationShape != null && handler.rotationShape.node != null &&
                            handler.rotationShape.node.style.visibility != 'hidden' &&
                            handler.rotationShape.node.style.display != 'none' &&
                            handler.rotationShape.boundingBox != null) {
                            bds.add(handler.rotationShape.boundingBox);
                        }
                    }

                    arrowUp.style.left = Math.floor(state.getCenterX() - this.triangleUp.width / 2) + 'px';
                    arrowUp.style.top = Math.floor(bds.y - this.triangleUp.height) + 'px';

                    arrowRight.style.left = Math.floor(bds.x + bds.width) + 'px';
                    arrowRight.style.top = Math.floor(state.getCenterY() - this.triangleRight.height / 2) + 'px';

                    arrowDown.style.left = arrowUp.style.left
                    arrowDown.style.top = Math.floor(bds.y + bds.height) + 'px';

                    arrowLeft.style.left = Math.floor(bds.x - this.triangleLeft.width) + 'px';
                    arrowLeft.style.top = arrowRight.style.top;

                    if (state.style['portConstraint'] != 'eastwest') {
                        graph.container.appendChild(arrowUp);
                        graph.container.appendChild(arrowDown);
                    }

                    graph.container.appendChild(arrowRight);
                    graph.container.appendChild(arrowLeft);
                }

                // Hides handle for cell under mouse
                if (state != null) {
                    currentStateHandle = graph.selectionCellsHandler.getHandler(state.cell);

                    if (currentStateHandle != null && currentStateHandle.setHandlesVisible != null) {
                        currentStateHandle.setHandlesVisible(false);
                    }
                }

                activeTarget = true;
            } else {
                var elts = [roundSource, roundTarget, arrowUp, arrowRight, arrowDown, arrowLeft];

                for (var i = 0; i < elts.length; i++) {
                    if (elts[i].parentNode != null) {
                        elts[i].parentNode.removeChild(elts[i]);
                    }
                }
            }
        }

        if (!activeTarget && currentStateHandle != null) {
            currentStateHandle.setHandlesVisible(true);
        }

        // Handles drop target
        var target = ((!mxEvent.isAltDown(evt) || mxEvent.isShiftDown(evt)) &&
            !(currentStyleTarget != null && activeArrow == styleTarget)) ?
            mxDragSource.prototype.getDropTarget.apply(this, arguments) : null;
        var model = graph.getModel();

        if (target != null) {
            if (activeArrow != null || !graph.isSplitTarget(target, cells, evt)) {
                // Selects parent group as drop target
                while (target != null && !graph.isValidDropTarget(target, cells, evt) && model.isVertex(model.getParent(target))) {
                    target = model.getParent(target);
                }

                if (graph.view.currentRoot == target || (!graph.isValidRoot(target) &&
                    graph.getModel().getChildCount(target) == 0) ||
                    graph.isCellLocked(target) || model.isEdge(target)) {
                    target = null;
                }
            }
        }

        return target;
    });

    dragSource.stopDrag = function () {
        mxDragSource.prototype.stopDrag.apply(this, arguments);

        var elts = [roundSource, roundTarget, styleTarget, arrowUp, arrowRight, arrowDown, arrowLeft];

        for (var i = 0; i < elts.length; i++) {
            if (elts[i].parentNode != null) {
                elts[i].parentNode.removeChild(elts[i]);
            }
        }

        if (currentTargetState != null && currentStateHandle != null) {
            currentStateHandle.reset();
        }

        currentStateHandle = null;
        currentTargetState = null;
        currentStyleTarget = null;
        styleTargetParent = null;
        activeArrow = null;
    };

    return dragSource;
};

/**
 * Adds a handler for inserting the cell with a single click.
 */
Sidebar.prototype.itemClicked = function (cells, ds, evt, elt) {
    var graph = this.editorUi.editor.graph;
    graph.container.focus();

    // Alt+Click inserts and connects
    if (mxEvent.isAltDown(evt) && graph.getSelectionCount() == 1 && graph.model.isVertex(graph.getSelectionCell())) {
        var firstVertex = null;

        for (var i = 0; i < cells.length && firstVertex == null; i++) {
            if (graph.model.isVertex(cells[i])) {
                firstVertex = i;
            }
        }

        if (firstVertex != null) {
            graph.setSelectionCells(this.dropAndConnect(graph.getSelectionCell(), cells, (mxEvent.isMetaDown(evt) || mxEvent.isControlDown(evt)) ?
                (mxEvent.isShiftDown(evt) ? mxConstants.DIRECTION_WEST : mxConstants.DIRECTION_NORTH) :
                (mxEvent.isShiftDown(evt) ? mxConstants.DIRECTION_EAST : mxConstants.DIRECTION_SOUTH),
                firstVertex, evt));
            graph.scrollCellToVisible(graph.getSelectionCell());
        }
    }
    // Shift+Click updates shape
    else if (mxEvent.isShiftDown(evt) && !graph.isSelectionEmpty()) {
        this.updateShapes(cells[0], graph.getSelectionCells());
        graph.scrollCellToVisible(graph.getSelectionCell());
    } else {
        var pt = graph.getFreeInsertPoint();

        if (mxEvent.isAltDown(evt)) {
            var bounds = graph.getGraphBounds();
            var tr = graph.view.translate;
            var s = graph.view.scale;
            pt.x = bounds.x / s - tr.x + bounds.width / s + graph.gridSize;
            pt.y = bounds.y / s - tr.y;
        }

        ds.drop(graph, evt, null, pt.x, pt.y, true);

        if (this.editorUi.hoverIcons != null && (mxEvent.isTouchEvent(evt) || mxEvent.isPenEvent(evt))) {
            this.editorUi.hoverIcons.update(graph.view.getState(graph.getSelectionCell()));
        }
    }
};

/**
 * Adds a handler for inserting the cell with a single click.
 */
Sidebar.prototype.addClickHandler = function (elt, ds, cells) {
    var graph = this.editorUi.editor.graph;
    var oldMouseDown = ds.mouseDown;
    var oldMouseMove = ds.mouseMove;
    var oldMouseUp = ds.mouseUp;
    var tol = graph.tolerance;
    var first = null;
    var sb = this;

    ds.mouseDown = function (evt) {
        oldMouseDown.apply(this, arguments);
        first = new mxPoint(mxEvent.getClientX(evt), mxEvent.getClientY(evt));

        if (this.dragElement != null) {
            this.dragElement.style.display = 'none';
            mxUtils.setOpacity(elt, 50);
        }
    };

    ds.mouseMove = function (evt) {
        if (this.dragElement != null && this.dragElement.style.display == 'none' &&
            first != null && (Math.abs(first.x - mxEvent.getClientX(evt)) > tol ||
                Math.abs(first.y - mxEvent.getClientY(evt)) > tol)) {
            this.dragElement.style.display = '';
            mxUtils.setOpacity(elt, 100);
        }

        oldMouseMove.apply(this, arguments);
    };

    ds.mouseUp = function (evt) {
        if (!mxEvent.isPopupTrigger(evt) && this.currentGraph == null &&
            this.dragElement != null && this.dragElement.style.display == 'none') {
            sb.itemClicked(cells, ds, evt, elt);
        }

        oldMouseUp.apply(ds, arguments);
        mxUtils.setOpacity(elt, 100);
        first = null;

        // Blocks tooltips on this element after single click
        sb.currentElt = elt;
    };
};

/**
 * Creates a drop handler for inserting the given cells.
 */
Sidebar.prototype.createVertexTemplateEntry = function (style, width, height, value, title, showLabel, showTitle, tags) {
    tags = (tags != null && tags.length > 0) ? tags : title.toLowerCase();

    return this.addEntry(tags, mxUtils.bind(this, function () {
        return this.createVertexTemplate(style, width, height, value, title, showLabel, showTitle);
    }));
}

/**
 * Creates a drop handler for inserting the given cells.
 */
Sidebar.prototype.createVertexTemplate = function (style, width, height, value, title, showLabel, showTitle, allowCellsInserted) {
    var cells = [new mxCell((value != null) ? value : '', new mxGeometry(0, 0, width, height), style)];
    cells[0].vertex = true;

    return this.createVertexTemplateFromCells(cells, width, height, title, showLabel, showTitle, allowCellsInserted);
};

/**
 * Creates a drop handler for inserting the given cells.
 */
Sidebar.prototype.createVertexTemplateFromData = function (data, width, height, title, showLabel, showTitle, allowCellsInserted) {
    var doc = mxUtils.parseXml(Graph.decompress(data));
    var codec = new mxCodec(doc);

    var model = new mxGraphModel();
    codec.decode(doc.documentElement, model);

    var cells = this.graph.cloneCells(model.root.getChildAt(0).children);

    return this.createVertexTemplateFromCells(cells, width, height, title, showLabel, showTitle, allowCellsInserted);
};

/**
 * Creates a drop handler for inserting the given cells.
 */
Sidebar.prototype.createVertexTemplateFromCells = function (cells, width, height, title, showLabel, showTitle, allowCellsInserted) {
    // Use this line to convert calls to this function with lots of boilerplate code for creating cells
    //console.trace('xml', Graph.compress(mxUtils.getXml(this.graph.encodeCells(cells))), cells);
    return this.createItem(cells, title, showLabel, showTitle, width, height, allowCellsInserted);
};

/**
 *
 */
Sidebar.prototype.createEdgeTemplateEntry = function (style, width, height, value, title, showLabel, tags, allowCellsInserted) {
    tags = (tags != null && tags.length > 0) ? tags : title.toLowerCase();

    return this.addEntry(tags, mxUtils.bind(this, function () {
        return this.createEdgeTemplate(style, width, height, value, title, showLabel, allowCellsInserted);
    }));
};

/**
 * Creates a drop handler for inserting the given cells.
 */
Sidebar.prototype.createEdgeTemplate = function (style, width, height, value, title, showLabel, allowCellsInserted) {
    var cell = new mxCell((value != null) ? value : '', new mxGeometry(0, 0, width, height), style);
    cell.geometry.setTerminalPoint(new mxPoint(0, height), true);
    cell.geometry.setTerminalPoint(new mxPoint(width, 0), false);
    cell.geometry.relative = true;
    cell.edge = true;

    return this.createEdgeTemplateFromCells([cell], width, height, title, showLabel, allowCellsInserted);
};

/**
 * Creates a drop handler for inserting the given cells.
 */
Sidebar.prototype.createEdgeTemplateFromCells = function (cells, width, height, title, showLabel, allowCellsInserted) {
    return this.createItem(cells, title, showLabel, true, width, height, allowCellsInserted);
};

/**
 * Adds the given palette.
 */
Sidebar.prototype.addPaletteFunctions = function (id, title, expanded, fns) {
    this.addPalette(id, title, expanded, mxUtils.bind(this, function (content) {
        for (var i = 0; i < fns.length; i++) {
            content.appendChild(fns[i](content));
        }
    }));
};

/**
 * Adds the given palette.
 */
Sidebar.prototype.addPalette = function (id, title, expanded, onInit) {
    var elt = this.createTitle(title);
    this.container.appendChild(elt);

    var div = document.createElement('div');
    div.className = 'geSidebar';

    // Disables built-in pan and zoom in IE10 and later
    if (mxClient.IS_POINTER) {
        div.style.touchAction = 'none';
    }

    if (expanded) {
        onInit(div);
        onInit = null;
    } else {
        div.style.display = 'none';
    }

    this.addFoldingHandler(elt, div, onInit);

    var outer = document.createElement('div');
    outer.appendChild(div);
    this.container.appendChild(outer);

    // Keeps references to the DOM nodes
    if (id != null) {
        this.palettes[id] = [elt, outer];
    }

    return div;
};

/**
 * Create the given title element.
 */
Sidebar.prototype.addFoldingHandler = function (title, content, funct) {
    var initialized = false;

    // Avoids mixed content warning in IE6-8
    if (!mxClient.IS_IE || document.documentMode >= 8) {
        title.style.backgroundImage = (content.style.display == 'none') ?
            'url(\'' + this.collapsedImage + '\')' : 'url(\'' + this.expandedImage + '\')';
    }

    title.style.backgroundRepeat = 'no-repeat';
    title.style.backgroundPosition = '0% 50%';

    mxEvent.addListener(title, 'click', mxUtils.bind(this, function (evt) {
        if (content.style.display == 'none') {
            if (!initialized) {
                initialized = true;

                if (funct != null) {
                    // Wait cursor does not show up on Mac
                    title.style.cursor = 'wait';
                    var prev = title.innerHTML;
                    title.innerHTML = mxResources.get('loading') + '...';

                    window.setTimeout(function () {
                        content.style.display = 'block';
                        title.style.cursor = '';
                        title.innerHTML = prev;

                        var fo = mxClient.NO_FO;
                        mxClient.NO_FO = Editor.prototype.originalNoForeignObject;
                        funct(content, title);
                        mxClient.NO_FO = fo;
                    }, (mxClient.IS_FF) ? 20 : 0);
                } else {
                    content.style.display = 'block';
                }
            } else {
                content.style.display = 'block';
            }

            title.style.backgroundImage = 'url(\'' + this.expandedImage + '\')';
        } else {
            title.style.backgroundImage = 'url(\'' + this.collapsedImage + '\')';
            content.style.display = 'none';
        }

        mxEvent.consume(evt);
    }));

    // Prevents focus
    mxEvent.addListener(title, (mxClient.IS_POINTER) ? 'pointerdown' : 'mousedown',
        mxUtils.bind(this, function (evt) {
            evt.preventDefault();
        }));
};

/**
 * Removes the palette for the given ID.
 */
Sidebar.prototype.removePalette = function (id) {
    var elts = this.palettes[id];

    if (elts != null) {
        this.palettes[id] = null;

        for (var i = 0; i < elts.length; i++) {
            this.container.removeChild(elts[i]);
        }

        return true;
    }

    return false;
};

/**
 * Adds the given image palette.
 */
Sidebar.prototype.addImagePalette = function (id, title, prefix, postfix, items, titles, tags) {
    var showTitles = titles != null;
    var fns = [];

    for (var i = 0; i < items.length; i++) {
        (mxUtils.bind(this, function (item, title, tmpTags) {
            if (tmpTags == null) {
                var slash = item.lastIndexOf('/');
                var dot = item.lastIndexOf('.');
                tmpTags = item.substring((slash >= 0) ? slash + 1 : 0, (dot >= 0) ? dot : item.length).replace(/[-_]/g, ' ');
            }

            fns.push(this.createVertexTemplateEntry('image;html=1;labelBackgroundColor=#ffffff;image=' + prefix + item + postfix,
                this.defaultImageWidth, this.defaultImageHeight, '', title, title != null, null, this.filterTags(tmpTags)));
        }))(items[i], (titles != null) ? titles[i] : null, (tags != null) ? tags[items[i]] : null);
    }

    this.addPaletteFunctions(id, title, false, fns);
};

/**
 * Creates the array of tags for the given stencil. Duplicates are allowed and will be filtered out later.
 */
Sidebar.prototype.getTagsForStencil = function (packageName, stencilName, moreTags) {
    var tags = packageName.split('.');

    for (var i = 1; i < tags.length; i++) {
        tags[i] = tags[i].replace(/_/g, ' ')
    }

    tags.push(stencilName.replace(/_/g, ' '));

    if (moreTags != null) {
        tags.push(moreTags);
    }

    return tags.slice(1, tags.length);
};

/**
 * Adds the given stencil palette.
 */
Sidebar.prototype.addStencilPalette = function (id, title, stencilFile, style, ignore, onInit, scale, tags, customFns) {
    scale = (scale != null) ? scale : 1;

    if (this.addStencilsToIndex) {
        // LATER: Handle asynchronous loading dependency
        var fns = [];

        if (customFns != null) {
            for (var i = 0; i < customFns.length; i++) {
                fns.push(customFns[i]);
            }
        }

        mxStencilRegistry.loadStencilSet(stencilFile, mxUtils.bind(this, function (packageName, stencilName, displayName, w, h) {
            if (ignore == null || mxUtils.indexOf(ignore, stencilName) < 0) {
                var tmp = this.getTagsForStencil(packageName, stencilName);
                var tmpTags = (tags != null) ? tags[stencilName] : null;

                if (tmpTags != null) {
                    tmp.push(tmpTags);
                }

                fns.push(this.createVertexTemplateEntry('shape=' + packageName + stencilName.toLowerCase() + style,
                    Math.round(w * scale), Math.round(h * scale), '', stencilName.replace(/_/g, ' '), null, null,
                    this.filterTags(tmp.join(' '))));
            }
        }), true, true);

        this.addPaletteFunctions(id, title, false, fns);
    } else {
        this.addPalette(id, title, false, mxUtils.bind(this, function (content) {
            if (style == null) {
                style = '';
            }

            if (onInit != null) {
                onInit.call(this, content);
            }

            if (customFns != null) {
                for (var i = 0; i < customFns.length; i++) {
                    customFns[i](content);
                }
            }

            mxStencilRegistry.loadStencilSet(stencilFile, mxUtils.bind(this, function (packageName, stencilName, displayName, w, h) {
                if (ignore == null || mxUtils.indexOf(ignore, stencilName) < 0) {
                    content.appendChild(this.createVertexTemplate('shape=' + packageName + stencilName.toLowerCase() + style,
                        Math.round(w * scale), Math.round(h * scale), '', stencilName.replace(/_/g, ' '), true));
                }
            }), true);
        }));
    }
};

/**
 * Adds the given stencil palette.
 */
Sidebar.prototype.destroy = function () {
    if (this.graph != null) {
        if (this.graph.container != null && this.graph.container.parentNode != null) {
            this.graph.container.parentNode.removeChild(this.graph.container);
        }

        this.graph.destroy();
        this.graph = null;
    }

    if (this.pointerUpHandler != null) {
        mxEvent.removeListener(document, (mxClient.IS_POINTER) ? 'pointerup' : 'mouseup', this.pointerUpHandler);
        this.pointerUpHandler = null;
    }

    if (this.pointerDownHandler != null) {
        mxEvent.removeListener(document, (mxClient.IS_POINTER) ? 'pointerdown' : 'mousedown', this.pointerDownHandler);
        this.pointerDownHandler = null;
    }

    if (this.pointerMoveHandler != null) {
        mxEvent.removeListener(document, (mxClient.IS_POINTER) ? 'pointermove' : 'mousemove', this.pointerMoveHandler);
        this.pointerMoveHandler = null;
    }

    if (this.pointerOutHandler != null) {
        mxEvent.removeListener(document, (mxClient.IS_POINTER) ? 'pointerout' : 'mouseout', this.pointerOutHandler);
        this.pointerOutHandler = null;
    }
};

/**
 * Copyright (c) 2006-2012, JGraph Ltd
 */
// Workaround for allowing target="_blank" in HTML sanitizer
// see https://code.google.com/p/google-caja/issues/detail?can=2&q=&colspec=ID%20Type%20Status%20Priority%20Owner%20Summary&groupby=&sort=&id=1296
if (typeof html4 !== 'undefined') {
    html4.ATTRIBS["a::target"] = 0;
    html4.ATTRIBS["source::src"] = 0;
    html4.ATTRIBS["video::src"] = 0;
    // Would be nice for tooltips but probably a security risk...
    //html4.ATTRIBS["video::autoplay"] = 0;
    //html4.ATTRIBS["video::autobuffer"] = 0;
}

// Workaround for handling named HTML entities in mxUtils.parseXml
// LATER: How to configure DOMParser to just ignore all entities?
(function () {
    var entities = [
        ['nbsp', '160'],
        ['shy', '173']
    ];

    var parseXml = mxUtils.parseXml;

    mxUtils.parseXml = function (text) {
        for (var i = 0; i < entities.length; i++) {
            text = text.replace(new RegExp(
                '&' + entities[i][0] + ';', 'g'),
                '&#' + entities[i][1] + ';');
        }

        return parseXml(text);
    };
})();

// Shim for missing toISOString in older versions of IE
// See https://stackoverflow.com/questions/12907862
if (!Date.prototype.toISOString) {
    (function () {
        function pad(number) {
            var r = String(number);

            if (r.length === 1) {
                r = '0' + r;
            }

            return r;
        };

        Date.prototype.toISOString = function () {
            return this.getUTCFullYear()
                + '-' + pad(this.getUTCMonth() + 1)
                + '-' + pad(this.getUTCDate())
                + 'T' + pad(this.getUTCHours())
                + ':' + pad(this.getUTCMinutes())
                + ':' + pad(this.getUTCSeconds())
                + '.' + String((this.getUTCMilliseconds() / 1000).toFixed(3)).slice(2, 5)
                + 'Z';
        };
    }());
}

// Shim for Date.now()
if (!Date.now) {
    Date.now = function () {
        return new Date().getTime();
    };
}

// Changes default colors
/**
 * Measurements Units
 */
mxConstants.POINTS = 1;
mxConstants.MILLIMETERS = 2;
mxConstants.INCHES = 3;
/**
 * This ratio is with page scale 1
 */
mxConstants.PIXELS_PER_MM = 3.937;
mxConstants.PIXELS_PER_INCH = 100;

mxConstants.SHADOW_OPACITY = 0.25;
mxConstants.SHADOWCOLOR = '#000000';
mxConstants.VML_SHADOWCOLOR = '#d0d0d0';
mxGraph.prototype.pageBreakColor = '#c0c0c0';
mxGraph.prototype.pageScale = 1;

// Letter page format is default in US, Canada and Mexico
(function () {
    try {
        if (navigator != null && navigator.language != null) {
            var lang = navigator.language.toLowerCase();
            mxGraph.prototype.pageFormat = (lang === 'en-us' || lang === 'en-ca' || lang === 'es-mx') ?
                mxConstants.PAGE_FORMAT_LETTER_PORTRAIT : mxConstants.PAGE_FORMAT_A4_PORTRAIT;
        }
    } catch (e) {
        // ignore
    }
})();

// Matches label positions of mxGraph 1.x
mxText.prototype.baseSpacingTop = 5;
mxText.prototype.baseSpacingBottom = 1;

// Keeps edges between relative child cells inside parent
mxGraphModel.prototype.ignoreRelativeEdgeParent = false;

// Defines grid properties
mxGraphView.prototype.gridImage = (mxClient.IS_SVG) ? 'data:image/gif;base64,R0lGODlhCgAKAJEAAAAAAP///8zMzP///yH5BAEAAAMALAAAAAAKAAoAAAIJ1I6py+0Po2wFADs=' :
    IMAGE_PATH + '/grid.gif';
mxGraphView.prototype.gridSteps = 4;
mxGraphView.prototype.minGridSize = 4;

// UrlParams is null in embed mode
mxGraphView.prototype.gridColor = '#e0e0e0';

//Units
mxGraphView.prototype.unit = mxConstants.POINTS;

mxGraphView.prototype.setUnit = function (unit) {
    if (this.unit != unit) {
        this.unit = unit;

        this.fireEvent(new mxEventObject('unitChanged', 'unit', unit));
    }
};

// Alternative text for unsupported foreignObjects
mxSvgCanvas2D.prototype.foAltText = '[Not supported by viewer]';

// Hook for custom constraints
mxShape.prototype.getConstraints = function (style, w, h) {
    return null;
};

/**
 * Constructs a new graph instance. Note that the constructor does not take a
 * container because the graph instance is needed for creating the UI, which
 * in turn will create the container for the graph. Hence, the container is
 * assigned later in EditorUi.
 */
/**
 * Defines graph class.
 */
Graph = function (container, model, renderHint, stylesheet, themes, standalone) {
    mxGraph.call(this, container, model, renderHint, stylesheet);

    this.themes = themes || this.defaultThemes;
    this.currentEdgeStyle = mxUtils.clone(this.defaultEdgeStyle);
    this.currentVertexStyle = mxUtils.clone(this.defaultVertexStyle);
    this.standalone = (standalone != null) ? standalone : false;

    // Sets the base domain URL and domain path URL for relative links.
    var b = this.baseUrl;
    var p = b.indexOf('//');
    this.domainUrl = '';
    this.domainPathUrl = '';

    if (p > 0) {
        var d = b.indexOf('/', p + 2);

        if (d > 0) {
            this.domainUrl = b.substring(0, d);
        }

        d = b.lastIndexOf('/');

        if (d > 0) {
            this.domainPathUrl = b.substring(0, d + 1);
        }
    }

    // Adds support for HTML labels via style. Note: Currently, only the Java
    // backend supports HTML labels but CSS support is limited to the following:
    // http://docs.oracle.com/javase/6/docs/api/index.html?javax/swing/text/html/CSS.html
    // TODO: Wrap should not affect isHtmlLabel output (should be handled later)
    this.isHtmlLabel = function (cell) {
        var state = this.view.getState(cell);
        var style = (state != null) ? state.style : this.getCellStyle(cell);

        return (style != null) ? (style['html'] == '1' || style[mxConstants.STYLE_WHITE_SPACE] == 'wrap') : false;
    };

    // Implements a listener for hover and click handling on edges
    if (this.edgeMode) {
        var start = {
            point: null,
            event: null,
            state: null,
            handle: null,
            selected: false
        };

        // Uses this event to process mouseDown to check the selection state before it is changed
        this.addListener(mxEvent.FIRE_MOUSE_EVENT, mxUtils.bind(this, function (sender, evt) {
            if (evt.getProperty('eventName') == 'mouseDown' && this.isEnabled()) {
                var me = evt.getProperty('event');

                if (!mxEvent.isControlDown(me.getEvent()) && !mxEvent.isShiftDown(me.getEvent())) {
                    var state = me.getState();

                    if (state != null) {
                        // Checks if state was removed in call to stopEditing above
                        if (this.model.isEdge(state.cell)) {
                            start.point = new mxPoint(me.getGraphX(), me.getGraphY());
                            start.selected = this.isCellSelected(state.cell);
                            start.state = state;
                            start.event = me;

                            if (state.text != null && state.text.boundingBox != null &&
                                mxUtils.contains(state.text.boundingBox, me.getGraphX(), me.getGraphY())) {
                                start.handle = mxEvent.LABEL_HANDLE;
                            } else {
                                var handler = this.selectionCellsHandler.getHandler(state.cell);

                                if (handler != null && handler.bends != null && handler.bends.length > 0) {
                                    start.handle = handler.getHandleForEvent(me);
                                }
                            }
                        }
                    }
                }
            }
        }));

        var mouseDown = null;

        this.addMouseListener(
            {
                mouseDown: function (sender, me) {
                },
                mouseMove: mxUtils.bind(this, function (sender, me) {
                    // Checks if any other handler is active
                    var handlerMap = this.selectionCellsHandler.handlers.map;

                    for (var key in handlerMap) {
                        if (handlerMap[key].index != null) {
                            return;
                        }
                    }

                    if (this.isEnabled() && !this.panningHandler.isActive() && !mxEvent.isControlDown(me.getEvent()) &&
                        !mxEvent.isShiftDown(me.getEvent()) && !mxEvent.isAltDown(me.getEvent())) {
                        var tol = this.tolerance;

                        if (start.point != null && start.state != null && start.event != null) {
                            var state = start.state;

                            if (Math.abs(start.point.x - me.getGraphX()) > tol ||
                                Math.abs(start.point.y - me.getGraphY()) > tol) {
                                // Lazy selection for edges inside groups
                                if (!this.isCellSelected(state.cell)) {
                                    this.setSelectionCell(state.cell);
                                }

                                var handler = this.selectionCellsHandler.getHandler(state.cell);

                                if (handler != null && handler.bends != null && handler.bends.length > 0) {
                                    var handle = handler.getHandleForEvent(start.event);
                                    var edgeStyle = this.view.getEdgeStyle(state);
                                    var entity = edgeStyle == mxEdgeStyle.EntityRelation;

                                    // Handles special case where label was clicked on unselected edge in which
                                    // case the label will be moved regardless of the handle that is returned
                                    if (!start.selected && start.handle == mxEvent.LABEL_HANDLE) {
                                        handle = start.handle;
                                    }

                                    if (!entity || handle == 0 || handle == handler.bends.length - 1 || handle == mxEvent.LABEL_HANDLE) {
                                        // Source or target handle or connected for direct handle access or orthogonal line
                                        // with just two points where the central handle is moved regardless of mouse position
                                        if (handle == mxEvent.LABEL_HANDLE || handle == 0 || state.visibleSourceState != null ||
                                            handle == handler.bends.length - 1 || state.visibleTargetState != null) {
                                            if (!entity && handle != mxEvent.LABEL_HANDLE) {
                                                var pts = state.absolutePoints;

                                                // Default case where handles are at corner points handles
                                                // drag of corner as drag of existing point
                                                if (pts != null && ((edgeStyle == null && handle == null) ||
                                                    edgeStyle == mxEdgeStyle.OrthConnector)) {
                                                    // Does not use handles if they were not initially visible
                                                    handle = start.handle;

                                                    if (handle == null) {
                                                        var box = new mxRectangle(start.point.x, start.point.y);
                                                        box.grow(mxEdgeHandler.prototype.handleImage.width / 2);

                                                        if (mxUtils.contains(box, pts[0].x, pts[0].y)) {
                                                            // Moves source terminal handle
                                                            handle = 0;
                                                        } else if (mxUtils.contains(box, pts[pts.length - 1].x, pts[pts.length - 1].y)) {
                                                            // Moves target terminal handle
                                                            handle = handler.bends.length - 1;
                                                        } else {
                                                            // Checks if edge has no bends
                                                            var nobends = edgeStyle != null && (pts.length == 2 || (pts.length == 3 &&
                                                                ((Math.round(pts[0].x - pts[1].x) == 0 && Math.round(pts[1].x - pts[2].x) == 0) ||
                                                                    (Math.round(pts[0].y - pts[1].y) == 0 && Math.round(pts[1].y - pts[2].y) == 0))));

                                                            if (nobends) {
                                                                // Moves central handle for straight orthogonal edges
                                                                handle = 2;
                                                            } else {
                                                                // Finds and moves vertical or horizontal segment
                                                                handle = mxUtils.findNearestSegment(state, start.point.x, start.point.y);

                                                                // Converts segment to virtual handle index
                                                                if (edgeStyle == null) {
                                                                    handle = mxEvent.VIRTUAL_HANDLE - handle;
                                                                }
                                                                // Maps segment to handle
                                                                else {
                                                                    handle += 1;
                                                                }
                                                            }
                                                        }
                                                    }
                                                }

                                                // Creates a new waypoint and starts moving it
                                                if (handle == null) {
                                                    handle = mxEvent.VIRTUAL_HANDLE;
                                                }
                                            }

                                            handler.start(me.getGraphX(), me.getGraphX(), handle);
                                            start.state = null;
                                            start.event = null;
                                            start.point = null;
                                            start.handle = null;
                                            start.selected = false;
                                            me.consume();

                                            // Removes preview rectangle in graph handler
                                            this.graphHandler.reset();
                                        }
                                    } else if (entity && (state.visibleSourceState != null || state.visibleTargetState != null)) {
                                        // Disables moves on entity to make it consistent
                                        this.graphHandler.reset();
                                        me.consume();
                                    }
                                }
                            }
                        } else {
                            // Updates cursor for unselected edges under the mouse
                            var state = me.getState();

                            if (state != null) {
                                // Checks if state was removed in call to stopEditing above
                                if (this.model.isEdge(state.cell)) {
                                    var cursor = null;
                                    var pts = state.absolutePoints;

                                    if (pts != null) {
                                        var box = new mxRectangle(me.getGraphX(), me.getGraphY());
                                        box.grow(mxEdgeHandler.prototype.handleImage.width / 2);

                                        if (state.text != null && state.text.boundingBox != null &&
                                            mxUtils.contains(state.text.boundingBox, me.getGraphX(), me.getGraphY())) {
                                            cursor = 'move';
                                        } else if (mxUtils.contains(box, pts[0].x, pts[0].y) ||
                                            mxUtils.contains(box, pts[pts.length - 1].x, pts[pts.length - 1].y)) {
                                            cursor = 'pointer';
                                        } else if (state.visibleSourceState != null || state.visibleTargetState != null) {
                                            // Moving is not allowed for entity relation but still indicate hover state
                                            var tmp = this.view.getEdgeStyle(state);
                                            cursor = 'crosshair';

                                            if (tmp != mxEdgeStyle.EntityRelation && this.isOrthogonal(state)) {
                                                var idx = mxUtils.findNearestSegment(state, me.getGraphX(), me.getGraphY());

                                                if (idx < pts.length - 1 && idx >= 0) {
                                                    cursor = (Math.round(pts[idx].x - pts[idx + 1].x) == 0) ?
                                                        'col-resize' : 'row-resize';
                                                }
                                            }
                                        }
                                    }

                                    if (cursor != null) {
                                        state.setCursor(cursor);
                                    }
                                }
                            }
                        }
                    }
                }),
                mouseUp: mxUtils.bind(this, function (sender, me) {
                    start.state = null;
                    start.event = null;
                    start.point = null;
                    start.handle = null;
                })
            });
    }

    // HTML entities are displayed as plain text in wrapped plain text labels
    this.cellRenderer.getLabelValue = function (state) {
        var result = mxCellRenderer.prototype.getLabelValue.apply(this, arguments);

        if (state.view.graph.isHtmlLabel(state.cell)) {
            if (state.style['html'] != 1) {
                result = mxUtils.htmlEntities(result, false);
            } else {
                result = state.view.graph.sanitizeHtml(result);
            }
        }

        return result;
    };

    // All code below not available and not needed in embed mode
    if (typeof mxVertexHandler !== 'undefined') {
        this.setConnectable(true);
        this.setDropEnabled(true);
        this.setPanning(true);
        this.setTooltips(true);
        this.setAllowLoops(true);
        this.allowAutoPanning = true;
        this.resetEdgesOnConnect = false;
        this.constrainChildren = false;
        this.constrainRelativeChildren = true;

        // Do not scroll after moving cells
        this.graphHandler.scrollOnMove = false;
        this.graphHandler.scaleGrid = true;

        // Disables cloning of connection sources by default
        this.connectionHandler.setCreateTarget(false);
        this.connectionHandler.insertBeforeSource = true;

        // Disables built-in connection starts
        this.connectionHandler.isValidSource = function (cell, me) {
            return false;
        };

        // Sets the style to be used when an elbow edge is double clicked
        this.alternateEdgeStyle = 'vertical';

        if (stylesheet == null) {
            this.loadStylesheet();
        }

        // Adds page centers to the guides for moving cells
        var graphHandlerGetGuideStates = this.graphHandler.getGuideStates;
        this.graphHandler.getGuideStates = function () {
            var result = graphHandlerGetGuideStates.apply(this, arguments);

            // Create virtual cell state for page centers
            if (this.graph.pageVisible) {
                var guides = [];

                var pf = this.graph.pageFormat;
                var ps = this.graph.pageScale;
                var pw = pf.width * ps;
                var ph = pf.height * ps;
                var t = this.graph.view.translate;
                var s = this.graph.view.scale;

                var layout = this.graph.getPageLayout();

                for (var i = 0; i < layout.width; i++) {
                    guides.push(new mxRectangle(((layout.x + i) * pw + t.x) * s,
                        (layout.y * ph + t.y) * s, pw * s, ph * s));
                }

                for (var j = 0; j < layout.height; j++) {
                    guides.push(new mxRectangle((layout.x * pw + t.x) * s,
                        ((layout.y + j) * ph + t.y) * s, pw * s, ph * s));
                }

                // Page center guides have predence over normal guides
                result = guides.concat(result);
            }

            return result;
        };

        // Overrides zIndex for dragElement
        mxDragSource.prototype.dragElementZIndex = mxPopupMenu.prototype.zIndex;

        // Overrides color for virtual guides for page centers
        mxGuide.prototype.getGuideColor = function (state, horizontal) {
            return (state.cell == null) ? '#ffa500' /* orange */ : mxConstants.GUIDE_COLOR;
        };

        // Changes color of move preview for black backgrounds
        this.graphHandler.createPreviewShape = function (bounds) {
            this.previewColor = (this.graph.background == '#000000') ? '#ffffff' : mxGraphHandler.prototype.previewColor;

            return mxGraphHandler.prototype.createPreviewShape.apply(this, arguments);
        };

        // Handles parts of cells by checking if part=1 is in the style and returning the parent
        // if the parent is not already in the list of cells. container style is used to disable
        // step into swimlanes and dropTarget style is used to disable acting as a drop target.
        // LATER: Handle recursive parts
        this.graphHandler.getCells = function (initialCell) {
            var cells = mxGraphHandler.prototype.getCells.apply(this, arguments);
            var newCells = [];

            for (var i = 0; i < cells.length; i++) {
                var state = this.graph.view.getState(cells[i]);
                var style = (state != null) ? state.style : this.graph.getCellStyle(cells[i]);

                if (mxUtils.getValue(style, 'part', '0') == '1') {
                    var parent = this.graph.model.getParent(cells[i]);

                    if (this.graph.model.isVertex(parent) && mxUtils.indexOf(cells, parent) < 0) {
                        newCells.push(parent);
                    }
                } else {
                    newCells.push(cells[i]);
                }
            }

            return newCells;
        };

        // Handles parts of cells when cloning the source for new connections
        this.connectionHandler.createTargetVertex = function (evt, source) {
            var state = this.graph.view.getState(source);
            var style = (state != null) ? state.style : this.graph.getCellStyle(source);

            if (mxUtils.getValue(style, 'part', false)) {
                var parent = this.graph.model.getParent(source);

                if (this.graph.model.isVertex(parent)) {
                    source = parent;
                }
            }

            return mxConnectionHandler.prototype.createTargetVertex.apply(this, arguments);
        };

        var rubberband = new mxRubberband(this);

        this.getRubberband = function () {
            return rubberband;
        };

        // Timer-based activation of outline connect in connection handler
        var startTime = new Date().getTime();
        var timeOnTarget = 0;

        var connectionHandlerMouseMove = this.connectionHandler.mouseMove;

        this.connectionHandler.mouseMove = function () {
            var prev = this.currentState;
            connectionHandlerMouseMove.apply(this, arguments);

            if (prev != this.currentState) {
                startTime = new Date().getTime();
                timeOnTarget = 0;
            } else {
                timeOnTarget = new Date().getTime() - startTime;
            }
        };

        // Activates outline connect after 1500ms with touch event or if alt is pressed inside the shape
        // outlineConnect=0 is a custom style that means do not connect to strokes inside the shape,
        // or in other words, connect to the shape's perimeter if the highlight is under the mouse
        // (the name is because the highlight, including all strokes, is called outline in the code)
        var connectionHandleIsOutlineConnectEvent = this.connectionHandler.isOutlineConnectEvent;

        this.connectionHandler.isOutlineConnectEvent = function (me) {
            return (this.currentState != null && me.getState() == this.currentState && timeOnTarget > 2000) ||
                ((this.currentState == null || mxUtils.getValue(this.currentState.style, 'outlineConnect', '1') != '0') &&
                    connectionHandleIsOutlineConnectEvent.apply(this, arguments));
        };

        // Adds shift+click to toggle selection state
        var isToggleEvent = this.isToggleEvent;
        this.isToggleEvent = function (evt) {
            return isToggleEvent.apply(this, arguments) || (!mxClient.IS_CHROMEOS && mxEvent.isShiftDown(evt));
        };

        // Workaround for Firefox where first mouse down is received
        // after tap and hold if scrollbars are visible, which means
        // start rubberband immediately if no cell is under mouse.
        var isForceRubberBandEvent = rubberband.isForceRubberbandEvent;
        rubberband.isForceRubberbandEvent = function (me) {
            return isForceRubberBandEvent.apply(this, arguments) ||
                (mxClient.IS_CHROMEOS && mxEvent.isShiftDown(me.getEvent())) ||
                (mxUtils.hasScrollbars(this.graph.container) && mxClient.IS_FF &&
                    mxClient.IS_WIN && me.getState() == null && mxEvent.isTouchEvent(me.getEvent()));
        };

        // Shows hand cursor while panning
        var prevCursor = null;

        this.panningHandler.addListener(mxEvent.PAN_START, mxUtils.bind(this, function () {
            if (this.isEnabled()) {
                prevCursor = this.container.style.cursor;
                this.container.style.cursor = 'move';
            }
        }));

        this.panningHandler.addListener(mxEvent.PAN_END, mxUtils.bind(this, function () {
            if (this.isEnabled()) {
                this.container.style.cursor = prevCursor;
            }
        }));

        this.popupMenuHandler.autoExpand = true;

        this.popupMenuHandler.isSelectOnPopup = function (me) {
            return mxEvent.isMouseEvent(me.getEvent());
        };

        // Handles links if graph is read-only or cell is locked
        var click = this.click;
        this.click = function (me) {
            var locked = me.state == null && me.sourceState != null && this.isCellLocked(me.sourceState.cell);

            if ((!this.isEnabled() || locked) && !me.isConsumed()) {
                var cell = (locked) ? me.sourceState.cell : me.getCell();

                if (cell != null) {
                    var link = this.getLinkForCell(cell);

                    if (link != null) {
                        if (this.isCustomLink(link)) {
                            this.customLinkClicked(link);
                        } else {
                            this.openLink(link);
                        }
                    }
                }

                if (this.isEnabled() && locked) {
                    this.clearSelection();
                }
            } else {
                return click.apply(this, arguments);
            }
        };

        // Redirects tooltips for locked cells
        this.tooltipHandler.getStateForEvent = function (me) {
            return me.sourceState;
        };

        // Redirects cursor for locked cells
        var getCursorForMouseEvent = this.getCursorForMouseEvent;
        this.getCursorForMouseEvent = function (me) {
            var locked = me.state == null && me.sourceState != null && this.isCellLocked(me.sourceState.cell);

            return this.getCursorForCell((locked) ? me.sourceState.cell : me.getCell());
        };

        // Shows pointer cursor for clickable cells with links
        // ie. if the graph is disabled and cells cannot be selected
        var getCursorForCell = this.getCursorForCell;
        this.getCursorForCell = function (cell) {
            if (!this.isEnabled() || this.isCellLocked(cell)) {
                var link = this.getLinkForCell(cell);

                if (link != null) {
                    return 'pointer';
                } else if (this.isCellLocked(cell)) {
                    return 'default';
                }
            }

            return getCursorForCell.apply(this, arguments);
        };

        // Changes rubberband selection to be recursive
        this.selectRegion = function (rect, evt) {
            var cells = this.getAllCells(rect.x, rect.y, rect.width, rect.height);
            this.selectCellsForEvent(cells, evt);

            return cells;
        };

        // Recursive implementation for rubberband selection
        this.getAllCells = function (x, y, width, height, parent, result) {
            result = (result != null) ? result : [];

            if (width > 0 || height > 0) {
                var model = this.getModel();
                var right = x + width;
                var bottom = y + height;

                if (parent == null) {
                    parent = this.getCurrentRoot();

                    if (parent == null) {
                        parent = model.getRoot();
                    }
                }

                if (parent != null) {
                    var childCount = model.getChildCount(parent);

                    for (var i = 0; i < childCount; i++) {
                        var cell = model.getChildAt(parent, i);
                        var state = this.view.getState(cell);

                        if (state != null && this.isCellVisible(cell) && mxUtils.getValue(state.style, 'locked', '0') != '1') {
                            var deg = mxUtils.getValue(state.style, mxConstants.STYLE_ROTATION) || 0;
                            var box = state;

                            if (deg != 0) {
                                box = mxUtils.getBoundingBox(box, deg);
                            }

                            if ((model.isEdge(cell) || model.isVertex(cell)) &&
                                box.x >= x && box.y + box.height <= bottom &&
                                box.y >= y && box.x + box.width <= right) {
                                result.push(cell);
                            }

                            this.getAllCells(x, y, width, height, cell, result);
                        }
                    }
                }
            }

            return result;
        };

        // Never removes cells from parents that are being moved
        var graphHandlerShouldRemoveCellsFromParent = this.graphHandler.shouldRemoveCellsFromParent;
        this.graphHandler.shouldRemoveCellsFromParent = function (parent, cells, evt) {
            if (this.graph.isCellSelected(parent)) {
                return false;
            }

            return graphHandlerShouldRemoveCellsFromParent.apply(this, arguments);
        };

        // Unlocks all cells
        this.isCellLocked = function (cell) {
            var pState = this.view.getState(cell);

            while (pState != null) {
                if (mxUtils.getValue(pState.style, 'locked', '0') == '1') {
                    return true;
                }

                pState = this.view.getState(this.model.getParent(pState.cell));
            }

            return false;
        };

        var tapAndHoldSelection = null;

        // Uses this event to process mouseDown to check the selection state before it is changed
        this.addListener(mxEvent.FIRE_MOUSE_EVENT, mxUtils.bind(this, function (sender, evt) {
            if (evt.getProperty('eventName') == 'mouseDown') {
                var me = evt.getProperty('event');
                var state = me.getState();

                if (state != null && !this.isSelectionEmpty() && !this.isCellSelected(state.cell)) {
                    tapAndHoldSelection = this.getSelectionCells();
                } else {
                    tapAndHoldSelection = null;
                }
            }
        }));

        // Tap and hold on background starts rubberband for multiple selected
        // cells the cell associated with the event is deselected
        this.addListener(mxEvent.TAP_AND_HOLD, mxUtils.bind(this, function (sender, evt) {
            if (!mxEvent.isMultiTouchEvent(evt)) {
                var me = evt.getProperty('event');
                var cell = evt.getProperty('cell');

                if (cell == null) {
                    var pt = mxUtils.convertPoint(this.container,
                        mxEvent.getClientX(me), mxEvent.getClientY(me));
                    rubberband.start(pt.x, pt.y);
                } else if (tapAndHoldSelection != null) {
                    this.addSelectionCells(tapAndHoldSelection);
                } else if (this.getSelectionCount() > 1 && this.isCellSelected(cell)) {
                    this.removeSelectionCell(cell);
                }

                // Blocks further processing of the event
                tapAndHoldSelection = null;
                evt.consume();
            }
        }));

        // On connect the target is selected and we clone the cell of the preview edge for insert
        this.connectionHandler.selectCells = function (edge, target) {
            this.graph.setSelectionCell(target || edge);
        };

        // Shows connection points only if cell not selected
        this.connectionHandler.constraintHandler.isStateIgnored = function (state, source) {
            return source && state.view.graph.isCellSelected(state.cell);
        };

        // Updates constraint handler if the selection changes
        this.selectionModel.addListener(mxEvent.CHANGE, mxUtils.bind(this, function () {
            var ch = this.connectionHandler.constraintHandler;

            if (ch.currentFocus != null && ch.isStateIgnored(ch.currentFocus, true)) {
                ch.currentFocus = null;
                ch.constraints = null;
                ch.destroyIcons();
            }

            ch.destroyFocusHighlight();
        }));

        // Initializes touch interface
        if (Graph.touchStyle) {
            this.initTouch();
        }

        /**
         * Adds locking
         */
        var graphUpdateMouseEvent = this.updateMouseEvent;
        this.updateMouseEvent = function (me) {
            me = graphUpdateMouseEvent.apply(this, arguments);

            if (me.state != null && this.isCellLocked(me.getCell())) {
                me.state = null;
            }

            return me;
        };
    }

    //Create a unique offset object for each graph instance.
    this.currentTranslate = new mxPoint(0, 0);
};

/**
 * Specifies if the touch UI should be used (cannot detect touch in FF so always on for Windows/Linux)
 */
Graph.touchStyle = mxClient.IS_TOUCH || (mxClient.IS_FF && mxClient.IS_WIN) || navigator.maxTouchPoints > 0 ||
    navigator.msMaxTouchPoints > 0 || window.urlParams == null || urlParams['touch'] == '1';

/**
 * Shortcut for capability check.
 */
Graph.fileSupport = window.File != null && window.FileReader != null && window.FileList != null &&
    (window.urlParams == null || urlParams['filesupport'] != '0');

/**
 * Default size for line jumps.
 */
Graph.lineJumpsEnabled = true;

/**
 * Default size for line jumps.
 */
Graph.defaultJumpSize = 6;

/**
 * Helper function for creating SVG data URI.
 */
Graph.createSvgImage = function (w, h, data) {
    var tmp = unescape(encodeURIComponent(
        '<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">' +
        '<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="' + w + 'px" height="' + h + 'px" ' +
        'version="1.1">' + data + '</svg>'));

    return new mxImage('data:image/svg+xml;base64,' + ((window.btoa) ? btoa(tmp) : Base64.encode(tmp, true)), w, h)
};

/**
 * Removes all illegal control characters with ASCII code <32 except TAB, LF
 * and CR.
 */
Graph.zapGremlins = function (text) {
    var checked = [];

    for (var i = 0; i < text.length; i++) {
        var code = text.charCodeAt(i);

        // Removes all control chars except TAB, LF and CR
        if ((code >= 32 || code == 9 || code == 10 || code == 13) &&
            code != 0xFFFF && code != 0xFFFE) {
            checked.push(text.charAt(i));
        }
    }

    return checked.join('');
};

/**
 * Turns the given string into an array.
 */
Graph.stringToBytes = function (str) {
    var arr = new Array(str.length);

    for (var i = 0; i < str.length; i++) {
        arr[i] = str.charCodeAt(i);
    }

    return arr;
};

/**
 * Turns the given array into a string.
 */
Graph.bytesToString = function (arr) {
    var result = new Array(arr.length);

    for (var i = 0; i < arr.length; i++) {
        result[i] = String.fromCharCode(arr[i]);
    }

    return result.join('');
};

/**
 * Returns a base64 encoded version of the compressed outer XML of the given node.
 */
Graph.compressNode = function (node) {
    return Graph.compress(Graph.zapGremlins(mxUtils.getXml(node)));
};

/**
 * Returns a base64 encoded version of the compressed string.
 */
Graph.compress = function (data, deflate) {
    if (data == null || data.length == 0 || typeof (pako) === 'undefined') {
        return data;
    } else {
        var tmp = Graph.bytesToString((deflate) ? pako.deflate(encodeURIComponent(data)) :
            pako.deflateRaw(encodeURIComponent(data)));

        return (window.btoa) ? btoa(tmp) : Base64.encode(tmp, true);
    }
};

/**
 * Returns a decompressed version of the base64 encoded string.
 */
Graph.decompress = function (data, inflate) {
    if (data == null || data.length == 0 || typeof (pako) === 'undefined') {
        return data;
    } else {
        var tmp = (window.atob) ? atob(data) : Base64.decode(data, true);

        return Graph.zapGremlins(decodeURIComponent(
            Graph.bytesToString((inflate) ? pako.inflate(tmp) :
                pako.inflateRaw(tmp))));
    }
};

/**
 * Graph inherits from mxGraph.
 */
mxUtils.extend(Graph, mxGraph);

/**
 * Allows all values in fit.
 */
Graph.prototype.minFitScale = null;

/**
 * Allows all values in fit.
 */
Graph.prototype.maxFitScale = null;

/**
 * Sets the policy for links. Possible values are "self" to replace any framesets,
 * "blank" to load the URL in <linkTarget> and "auto" (default).
 */
Graph.prototype.linkPolicy = (urlParams['target'] == 'frame') ? 'blank' : (urlParams['target'] || 'auto');

/**
 * Target for links that open in a new window. Default is _blank.
 */
Graph.prototype.linkTarget = (urlParams['target'] == 'frame') ? '_self' : '_blank';

/**
 * Value to the rel attribute of links. Default is 'nofollow noopener noreferrer'.
 * NOTE: There are security implications when this is changed and if noopener is removed,
 * then <openLink> must be overridden to allow for the opener to be set by default.
 */
Graph.prototype.linkRelation = 'nofollow noopener noreferrer';

/**
 * Scrollbars are enabled on non-touch devices (not including Firefox because touch events
 * cannot be detected in Firefox, see above).
 */
Graph.prototype.defaultScrollbars = !mxClient.IS_IOS;

/**
 * Specifies if the page should be visible for new files. Default is true.
 */
Graph.prototype.defaultPageVisible = true;

/**
 * Specifies if the app should run in chromeless mode. Default is false.
 * This default is only used if the contructor argument is null.
 */
Graph.prototype.lightbox = false;

/**
 *
 */
Graph.prototype.defaultPageBackgroundColor = '#ffffff';

/**
 *
 */
Graph.prototype.defaultPageBorderColor = '#ffffff';

/**
 * Specifies the size of the size for "tiles" to be used for a graph with
 * scrollbars but no visible background page. A good value is large
 * enough to reduce the number of repaints that is caused for auto-
 * translation, which depends on this value, and small enough to give
 * a small empty buffer around the graph. Default is 400x400.
 */
Graph.prototype.scrollTileSize = new mxRectangle(0, 0, 400, 400);

/**
 * Overrides the background color and paints a transparent background.
 */
Graph.prototype.transparentBackground = true;

/**
 * Sets global constants.
 */
Graph.prototype.selectParentAfterDelete = false;

/**
 * Sets the default target for all links in cells.
 */
Graph.prototype.defaultEdgeLength = 80;

/**
 * Disables move of bends/segments without selecting.
 */
Graph.prototype.edgeMode = false;

/**
 * Allows all values in fit.
 */
Graph.prototype.connectionArrowsEnabled = true;

/**
 * Specifies the regular expression for matching placeholders.
 */
Graph.prototype.placeholderPattern = new RegExp('%(date\{.*\}|[^%^\{^\}]+)%', 'g');

/**
 * Specifies the regular expression for matching placeholders.
 */
Graph.prototype.absoluteUrlPattern = new RegExp('^(?:[a-z]+:)?//', 'i');

/**
 * Specifies the default name for the theme. Default is 'default'.
 */
Graph.prototype.defaultThemeName = 'default';

/**
 * Specifies the default name for the theme. Default is 'default'.
 */
Graph.prototype.defaultThemes = {};

/**
 * Base URL for relative links.
 */
Graph.prototype.baseUrl = (urlParams['base'] != null) ?
    decodeURIComponent(urlParams['base']) :
    (((window != window.top) ? document.referrer :
        document.location.toString()).split('#')[0]);

/**
 * Specifies if the label should be edited after an insert.
 */
Graph.prototype.editAfterInsert = false;

/**
 * Defines the built-in properties to be ignored in tooltips.
 */
Graph.prototype.builtInProperties = ['label', 'tooltip', 'placeholders', 'placeholder'];

/**
 * Defines if the graph is part of an EditorUi. If this is false the graph can
 * be used in an EditorUi instance but will not have a UI added, functions
 * overridden or event handlers added.
 */
Graph.prototype.standalone = false;

/**
 * Installs child layout styles.
 */
Graph.prototype.init = function (container) {
    mxGraph.prototype.init.apply(this, arguments);

    // Intercepts links with no target attribute and opens in new window
    this.cellRenderer.initializeLabel = function (state, shape) {
        mxCellRenderer.prototype.initializeLabel.apply(this, arguments);

        // Checks tolerance for clicks on links
        var tol = state.view.graph.tolerance;
        var handleClick = true;
        var first = null;

        var down = mxUtils.bind(this, function (evt) {
            handleClick = true;
            first = new mxPoint(mxEvent.getClientX(evt), mxEvent.getClientY(evt));
        });

        var move = mxUtils.bind(this, function (evt) {
            handleClick = handleClick && first != null &&
                Math.abs(first.x - mxEvent.getClientX(evt)) < tol &&
                Math.abs(first.y - mxEvent.getClientY(evt)) < tol;
        });

        var up = mxUtils.bind(this, function (evt) {
            if (handleClick) {
                var elt = mxEvent.getSource(evt)

                while (elt != null && elt != shape.node) {
                    if (elt.nodeName.toLowerCase() == 'a') {
                        state.view.graph.labelLinkClicked(state, elt, evt);
                        break;
                    }

                    elt = elt.parentNode;
                }
            }
        });

        mxEvent.addGestureListeners(shape.node, down, move, up);
        mxEvent.addListener(shape.node, 'click', function (evt) {
            mxEvent.consume(evt);
        });
    };

    this.initLayoutManager();
};

/**
 * Implements zoom and offset via CSS transforms. This is currently only used
 * in read-only as there are fewer issues with the mxCellState not being scaled
 * and translated.
 *
 * KNOWN ISSUES TO FIX:
 * - Apply CSS transforms to HTML labels in IE11
 */
(function () {
    /**
     * Uses CSS transforms for scale and translate.
     */
    Graph.prototype.useCssTransforms = false;

    /**
     * Contains the scale.
     */
    Graph.prototype.currentScale = 1;

    /**
     * Contains the offset.
     */
    Graph.prototype.currentTranslate = new mxPoint(0, 0);

    /**
     * Only foreignObject supported for now (no IE11).
     */
    Graph.prototype.isCssTransformsSupported = function () {
        return this.dialect == mxConstants.DIALECT_SVG && !mxClient.NO_FO;
    };

    /**
     * Function: getCellAt
     *
     * Needs to modify original method for recursive call.
     */
    Graph.prototype.getCellAt = function (x, y, parent, vertices, edges, ignoreFn) {
        if (this.useCssTransforms) {
            x = x / this.currentScale - this.currentTranslate.x;
            y = y / this.currentScale - this.currentTranslate.y;
        }

        return this.getScaledCellAt.apply(this, arguments);
    };

    /**
     * Function: getScaledCellAt
     *
     * Overridden for recursion.
     */
    Graph.prototype.getScaledCellAt = function (x, y, parent, vertices, edges, ignoreFn) {
        vertices = (vertices != null) ? vertices : true;
        edges = (edges != null) ? edges : true;

        if (parent == null) {
            parent = this.getCurrentRoot();

            if (parent == null) {
                parent = this.getModel().getRoot();
            }
        }

        if (parent != null) {
            var childCount = this.model.getChildCount(parent);

            for (var i = childCount - 1; i >= 0; i--) {
                var cell = this.model.getChildAt(parent, i);
                var result = this.getScaledCellAt(x, y, cell, vertices, edges, ignoreFn);

                if (result != null) {
                    return result;
                } else if (this.isCellVisible(cell) && (edges && this.model.isEdge(cell) ||
                    vertices && this.model.isVertex(cell))) {
                    var state = this.view.getState(cell);

                    if (state != null && (ignoreFn == null || !ignoreFn(state, x, y)) &&
                        this.intersects(state, x, y)) {
                        return cell;
                    }
                }
            }
        }

        return null;
    };


    /**
     * Function: repaint
     *
     * Updates the highlight after a change of the model or view.
     */
    mxCellHighlight.prototype.getStrokeWidth = function (state) {
        var s = this.strokeWidth;

        if (this.graph.useCssTransforms) {
            s /= this.graph.currentScale;
        }

        return s;
    };

    /**
     * Function: getGraphBounds
     *
     * Overrides getGraphBounds to use bounding box from SVG.
     */
    mxGraphView.prototype.getGraphBounds = function () {
        var b = this.graphBounds;

        if (this.graph.useCssTransforms) {
            var t = this.graph.currentTranslate;
            var s = this.graph.currentScale;

            b = new mxRectangle(
                (b.x + t.x) * s, (b.y + t.y) * s,
                b.width * s, b.height * s);
        }

        return b;
    };

    /**
     * Function: viewStateChanged
     *
     * Overrides to bypass full cell tree validation.
     * TODO: Check if this improves performance
     */
    mxGraphView.prototype.viewStateChanged = function () {
        if (this.graph.useCssTransforms) {
            this.validate();
            this.graph.sizeDidChange();
        } else {
            this.revalidate();
            this.graph.sizeDidChange();
        }
    };

    /**
     * Function: validate
     *
     * Overrides validate to normalize validation view state and pass
     * current state to CSS transform.
     */
    var graphViewValidate = mxGraphView.prototype.validate;

    mxGraphView.prototype.validate = function (cell) {
        if (this.graph.useCssTransforms) {
            this.graph.currentScale = this.scale;
            this.graph.currentTranslate.x = this.translate.x;
            this.graph.currentTranslate.y = this.translate.y;

            this.scale = 1;
            this.translate.x = 0;
            this.translate.y = 0;
        }

        graphViewValidate.apply(this, arguments);

        if (this.graph.useCssTransforms) {
            this.graph.updateCssTransform();

            this.scale = this.graph.currentScale;
            this.translate.x = this.graph.currentTranslate.x;
            this.translate.y = this.graph.currentTranslate.y;
        }
    };

    /**
     * Function: updateCssTransform
     *
     * Zooms out of the graph by <zoomFactor>.
     */
    Graph.prototype.updateCssTransform = function () {
        var temp = this.view.getDrawPane();

        if (temp != null) {
            var g = temp.parentNode;

            if (!this.useCssTransforms) {
                g.removeAttribute('transformOrigin');
                g.removeAttribute('transform');
            } else {
                var prev = g.getAttribute('transform');
                g.setAttribute('transformOrigin', '0 0');
                g.setAttribute('transform', 'scale(' + this.currentScale + ',' + this.currentScale + ')' +
                    'translate(' + this.currentTranslate.x + ',' + this.currentTranslate.y + ')');

                // Applies workarounds only if translate has changed
                if (prev != g.getAttribute('transform')) {
                    try {
                        // Applies transform to labels outside of the SVG DOM
                        // Excluded via isCssTransformsSupported
                        //					if (mxClient.NO_FO)
                        //					{
                        //						var transform = 'scale(' + this.currentScale + ')' + 'translate(' +
                        //							this.currentTranslate.x + 'px,' + this.currentTranslate.y + 'px)';
                        //
                        //						this.view.states.visit(mxUtils.bind(this, function(cell, state)
                        //						{
                        //							if (state.text != null && state.text.node != null)
                        //							{
                        //								// Stores initial CSS transform that is used for the label alignment
                        //								if (state.text.originalTransform == null)
                        //								{
                        //									state.text.originalTransform = state.text.node.style.transform;
                        //								}
                        //
                        //								state.text.node.style.transform = transform + state.text.originalTransform;
                        //							}
                        //						}));
                        //					}
                        // Workaround for https://developer.microsoft.com/en-us/microsoft-edge/platform/issues/4320441/
                        if (mxClient.IS_EDGE) {
                            // Recommended workaround is to do this on all
                            // foreignObjects, but this seems to be faster
                            var val = g.style.display;
                            g.style.display = 'none';
                            g.getBBox();
                            g.style.display = val;
                        }
                    } catch (e) {
                        // ignore
                    }
                }
            }
        }
    };

    var graphViewValidateBackgroundPage = mxGraphView.prototype.validateBackgroundPage;

    mxGraphView.prototype.validateBackgroundPage = function () {
        var useCssTranforms = this.graph.useCssTransforms, scale = this.scale,
            translate = this.translate;

        if (useCssTranforms) {
            this.scale = this.graph.currentScale;
            this.translate = this.graph.currentTranslate;
        }

        graphViewValidateBackgroundPage.apply(this, arguments);

        if (useCssTranforms) {
            this.scale = scale;
            this.translate = translate;
        }
    };

    var graphUpdatePageBreaks = mxGraph.prototype.updatePageBreaks;

    mxGraph.prototype.updatePageBreaks = function (visible, width, height) {
        var useCssTranforms = this.useCssTransforms, scale = this.view.scale,
            translate = this.view.translate;

        if (useCssTranforms) {
            this.view.scale = 1;
            this.view.translate = new mxPoint(0, 0);
            this.useCssTransforms = false;
        }

        graphUpdatePageBreaks.apply(this, arguments);

        if (useCssTranforms) {
            this.view.scale = scale;
            this.view.translate = translate;
            this.useCssTransforms = true;
        }
    };

})();

/**
 * Sets the XML node for the current diagram.
 */
Graph.prototype.isLightboxView = function () {
    return this.lightbox;
};

/**
 * Sets the XML node for the current diagram.
 */
Graph.prototype.isViewer = function () {
    return false;
};

/**
 * Installs automatic layout via styles
 */
Graph.prototype.labelLinkClicked = function (state, elt, evt) {
    var href = elt.getAttribute('href');

    if (href != null && !this.isCustomLink(href) && (mxEvent.isLeftMouseButton(evt) &&
        !mxEvent.isPopupTrigger(evt)) || mxEvent.isTouchEvent(evt)) {
        if (!this.isEnabled() || this.isCellLocked(state.cell)) {
            var target = this.isBlankLink(href) ? this.linkTarget : '_top';
            this.openLink(this.getAbsoluteUrl(href), target);
        }

        mxEvent.consume(evt);
    }
};

/**
 * Returns the size of the page format scaled with the page size.
 */
Graph.prototype.openLink = function (href, target, allowOpener) {
    var result = window;

    try {
        // Workaround for blocking in same iframe
        if (target == '_self' && window != window.top) {
            window.location.href = href;
        } else {
            // Avoids page reload for anchors (workaround for IE but used everywhere)
            if (href.substring(0, this.baseUrl.length) == this.baseUrl &&
                href.charAt(this.baseUrl.length) == '#' &&
                target == '_top' && window == window.top) {
                var hash = href.split('#')[1];

                // Forces navigation if on same hash
                if (window.location.hash == '#' + hash) {
                    window.location.hash = '';
                }

                window.location.hash = hash;
            } else {
                result = window.open(href, target);

                if (result != null && !allowOpener) {
                    result.opener = null;
                }
            }
        }
    } catch (e) {
        // ignores permission denied
    }

    return result;
};

/**
 * Adds support for page links.
 */
Graph.prototype.getLinkTitle = function (href) {
    return href.substring(href.lastIndexOf('/') + 1);
};

/**
 * Adds support for page links.
 */
Graph.prototype.isCustomLink = function (href) {
    return href.substring(0, 5) == 'data:';
};

/**
 * Adds support for page links.
 */
Graph.prototype.customLinkClicked = function (link) {
    return false;
};

/**
 * Returns true if the fiven href references an external protocol that
 * should never open in a new window. Default returns true for mailto.
 */
Graph.prototype.isExternalProtocol = function (href) {
    return href.substring(0, 7) === 'mailto:';
};

/**
 * Hook for links to open in same window. Default returns true for anchors,
 * links to same domain or if target == 'self' in the config.
 */
Graph.prototype.isBlankLink = function (href) {
    return !this.isExternalProtocol(href) &&
        (this.linkPolicy === 'blank' ||
            (this.linkPolicy !== 'self' &&
                !this.isRelativeUrl(href) &&
                href.substring(0, this.domainUrl.length) !== this.domainUrl));
};

/**
 *
 */
Graph.prototype.isRelativeUrl = function (url) {
    return url != null && !this.absoluteUrlPattern.test(url) &&
        url.substring(0, 5) !== 'data:' &&
        !this.isExternalProtocol(url);
};

/**
 *
 */
Graph.prototype.getAbsoluteUrl = function (url) {
    if (url != null && this.isRelativeUrl(url)) {
        if (url.charAt(0) == '#') {
            url = this.baseUrl + url;
        } else if (url.charAt(0) == '/') {
            url = this.domainUrl + url;
        } else {
            url = this.domainPathUrl + url;
        }
    }

    return url;
};

/**
 * Installs automatic layout via styles
 */
Graph.prototype.initLayoutManager = function () {
    this.layoutManager = new mxLayoutManager(this);

    this.layoutManager.getLayout = function (cell) {
        // Workaround for possible invalid style after change and before view validation
        var style = this.graph.getCellStyle(cell);

        if (style != null) {
            if (style['childLayout'] == 'stackLayout') {
                var stackLayout = new mxStackLayout(this.graph, true);
                stackLayout.resizeParentMax = mxUtils.getValue(style, 'resizeParentMax', '1') == '1';
                stackLayout.horizontal = mxUtils.getValue(style, 'horizontalStack', '1') == '1';
                stackLayout.resizeParent = mxUtils.getValue(style, 'resizeParent', '1') == '1';
                stackLayout.resizeLast = mxUtils.getValue(style, 'resizeLast', '0') == '1';
                stackLayout.spacing = style['stackSpacing'] || stackLayout.spacing;
                stackLayout.border = style['stackBorder'] || stackLayout.border;
                stackLayout.marginLeft = style['marginLeft'] || 0;
                stackLayout.marginRight = style['marginRight'] || 0;
                stackLayout.marginTop = style['marginTop'] || 0;
                stackLayout.marginBottom = style['marginBottom'] || 0;
                stackLayout.fill = true;

                return stackLayout;
            } else if (style['childLayout'] == 'treeLayout') {
                var treeLayout = new mxCompactTreeLayout(this.graph);
                treeLayout.horizontal = mxUtils.getValue(style, 'horizontalTree', '1') == '1';
                treeLayout.resizeParent = mxUtils.getValue(style, 'resizeParent', '1') == '1';
                treeLayout.groupPadding = mxUtils.getValue(style, 'parentPadding', 20);
                treeLayout.levelDistance = mxUtils.getValue(style, 'treeLevelDistance', 30);
                treeLayout.maintainParentLocation = true;
                treeLayout.edgeRouting = false;
                treeLayout.resetEdges = false;

                return treeLayout;
            } else if (style['childLayout'] == 'flowLayout') {
                var flowLayout = new mxHierarchicalLayout(this.graph, mxUtils.getValue(style,
                    'flowOrientation', mxConstants.DIRECTION_EAST));
                flowLayout.resizeParent = mxUtils.getValue(style, 'resizeParent', '1') == '1';
                flowLayout.parentBorder = mxUtils.getValue(style, 'parentPadding', 20);
                flowLayout.maintainParentLocation = true;

                // Special undocumented styles for changing the hierarchical
                flowLayout.intraCellSpacing = mxUtils.getValue(style, 'intraCellSpacing', mxHierarchicalLayout.prototype.intraCellSpacing);
                flowLayout.interRankCellSpacing = mxUtils.getValue(style, 'interRankCellSpacing', mxHierarchicalLayout.prototype.interRankCellSpacing);
                flowLayout.interHierarchySpacing = mxUtils.getValue(style, 'interHierarchySpacing', mxHierarchicalLayout.prototype.interHierarchySpacing);
                flowLayout.parallelEdgeSpacing = mxUtils.getValue(style, 'parallelEdgeSpacing', mxHierarchicalLayout.prototype.parallelEdgeSpacing);

                return flowLayout;
            }
        }

        return null;
    };
};

/**
 * Returns the size of the page format scaled with the page size.
 */
Graph.prototype.getPageSize = function () {
    return (this.pageVisible) ? new mxRectangle(0, 0, this.pageFormat.width * this.pageScale,
        this.pageFormat.height * this.pageScale) : this.scrollTileSize;
};

/**
 * Returns a rectangle describing the position and count of the
 * background pages, where x and y are the position of the top,
 * left page and width and height are the vertical and horizontal
 * page count.
 */
Graph.prototype.getPageLayout = function () {
    var size = this.getPageSize();
    var bounds = this.getGraphBounds();

    if (bounds.width == 0 || bounds.height == 0) {
        return new mxRectangle(0, 0, 1, 1);
    } else {
        // Computes untransformed graph bounds
        var x = Math.ceil(bounds.x / this.view.scale - this.view.translate.x);
        var y = Math.ceil(bounds.y / this.view.scale - this.view.translate.y);
        var w = Math.floor(bounds.width / this.view.scale);
        var h = Math.floor(bounds.height / this.view.scale);

        var x0 = Math.floor(x / size.width);
        var y0 = Math.floor(y / size.height);
        var w0 = Math.ceil((x + w) / size.width) - x0;
        var h0 = Math.ceil((y + h) / size.height) - y0;

        return new mxRectangle(x0, y0, w0, h0);
    }
};

/**
 * Sanitizes the given HTML markup.
 */
Graph.prototype.sanitizeHtml = function (value, editing) {
    // Uses https://code.google.com/p/google-caja/wiki/JsHtmlSanitizer
    // NOTE: Original minimized sanitizer was modified to support
    // data URIs for images, mailto and special data:-links.
    // LATER: Add MathML to whitelisted tags
    function urlX(link) {
        if (link != null && link.toString().toLowerCase().substring(0, 11) !== 'javascript:') {
            return link;
        }

        return null;
    };

    function idX(id) {
        return id
    };

    return html_sanitize(value, urlX, idX);
};

/**
 * Revalidates all cells with placeholders in the current graph model.
 */
Graph.prototype.updatePlaceholders = function () {
    var model = this.model;
    var validate = false;

    for (var key in this.model.cells) {
        var cell = this.model.cells[key];

        if (this.isReplacePlaceholders(cell)) {
            this.view.invalidate(cell, false, false);
            validate = true;
        }
    }

    if (validate) {
        this.view.validate();
    }
};

/**
 * Adds support for placeholders in labels.
 */
Graph.prototype.isReplacePlaceholders = function (cell) {
    return cell.value != null && typeof (cell.value) == 'object' &&
        cell.value.getAttribute('placeholders') == '1';
};

/**
 * Returns true if the given mouse wheel event should be used for zooming. This
 * is invoked if no dialogs are showing and returns true with Alt or Control
 * (except macOS) is pressed.
 */
Graph.prototype.isZoomWheelEvent = function (evt) {
    return mxEvent.isAltDown(evt) || (mxEvent.isMetaDown(evt) && mxClient.IS_MAC) ||
        (mxEvent.isControlDown(evt) && !mxClient.IS_MAC);
};

/**
 * Adds Alt+click to select cells behind cells (Shift+Click on Chrome OS).
 */
Graph.prototype.isTransparentClickEvent = function (evt) {
    return mxEvent.isAltDown(evt) || (mxClient.IS_CHROMEOS && mxEvent.isShiftDown(evt));
};

/**
 * Adds ctrl+shift+connect to disable connections.
 */
Graph.prototype.isIgnoreTerminalEvent = function (evt) {
    return mxEvent.isShiftDown(evt) && mxEvent.isControlDown(evt);
};

/**
 * Adds support for placeholders in labels.
 */
Graph.prototype.isSplitTarget = function (target, cells, evt) {
    return !this.model.isEdge(cells[0]) &&
        !mxEvent.isAltDown(evt) && !mxEvent.isShiftDown(evt) &&
        mxGraph.prototype.isSplitTarget.apply(this, arguments);
};

/**
 * Adds support for placeholders in labels.
 */
Graph.prototype.getLabel = function (cell) {
    var result = mxGraph.prototype.getLabel.apply(this, arguments);

    if (result != null && this.isReplacePlaceholders(cell) && cell.getAttribute('placeholder') == null) {
        result = this.replacePlaceholders(cell, result);
    }

    return result;
};

/**
 * Adds labelMovable style.
 */
Graph.prototype.isLabelMovable = function (cell) {
    var state = this.view.getState(cell);
    var style = (state != null) ? state.style : this.getCellStyle(cell);

    return !this.isCellLocked(cell) &&
        ((this.model.isEdge(cell) && this.edgeLabelsMovable) ||
            (this.model.isVertex(cell) && (this.vertexLabelsMovable ||
                mxUtils.getValue(style, 'labelMovable', '0') == '1')));
};

/**
 * Adds event if grid size is changed.
 */
Graph.prototype.setGridSize = function (value) {
    this.gridSize = value;
    this.fireEvent(new mxEventObject('gridSizeChanged'));
};

/**
 * Private helper method.
 */
Graph.prototype.getGlobalVariable = function (name) {
    var val = null;

    if (name == 'date') {
        val = new Date().toLocaleDateString();
    } else if (name == 'time') {
        val = new Date().toLocaleTimeString();
    } else if (name == 'timestamp') {
        val = new Date().toLocaleString();
    } else if (name.substring(0, 5) == 'date{') {
        var fmt = name.substring(5, name.length - 1);
        val = this.formatDate(new Date(), fmt);
    }

    return val;
};

/**
 * Formats a date, see http://blog.stevenlevithan.com/archives/date-time-format
 */
Graph.prototype.formatDate = function (date, mask, utc) {
    // LATER: Cache regexs
    if (this.dateFormatCache == null) {
        this.dateFormatCache = {
            i18n: {
                dayNames: [
                    "Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat",
                    "Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"
                ],
                monthNames: [
                    "Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec",
                    "January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"
                ]
            },

            masks: {
                "default": "ddd mmm dd yyyy HH:MM:ss",
                shortDate: "m/d/yy",
                mediumDate: "mmm d, yyyy",
                longDate: "mmmm d, yyyy",
                fullDate: "dddd, mmmm d, yyyy",
                shortTime: "h:MM TT",
                mediumTime: "h:MM:ss TT",
                longTime: "h:MM:ss TT Z",
                isoDate: "yyyy-mm-dd",
                isoTime: "HH:MM:ss",
                isoDateTime: "yyyy-mm-dd'T'HH:MM:ss",
                isoUtcDateTime: "UTC:yyyy-mm-dd'T'HH:MM:ss'Z'"
            }
        };
    }

    var dF = this.dateFormatCache;
    var token = /d{1,4}|m{1,4}|yy(?:yy)?|([HhMsTt])\1?|[LloSZ]|"[^"]*"|'[^']*'/g,
        timezone = /\b(?:[PMCEA][SDP]T|(?:Pacific|Mountain|Central|Eastern|Atlantic) (?:Standard|Daylight|Prevailing) Time|(?:GMT|UTC)(?:[-+]\d{4})?)\b/g,
        timezoneClip = /[^-+\dA-Z]/g,
        pad = function (val, len) {
            val = String(val);
            len = len || 2;
            while (val.length < len) val = "0" + val;
            return val;
        };

    // You can't provide utc if you skip other args (use the "UTC:" mask prefix)
    if (arguments.length == 1 && Object.prototype.toString.call(date) == "[object String]" && !/\d/.test(date)) {
        mask = date;
        date = undefined;
    }

    // Passing date through Date applies Date.parse, if necessary
    date = date ? new Date(date) : new Date;
    if (isNaN(date)) throw SyntaxError("invalid date");

    mask = String(dF.masks[mask] || mask || dF.masks["default"]);

    // Allow setting the utc argument via the mask
    if (mask.slice(0, 4) == "UTC:") {
        mask = mask.slice(4);
        utc = true;
    }

    var _ = utc ? "getUTC" : "get",
        d = date[_ + "Date"](),
        D = date[_ + "Day"](),
        m = date[_ + "Month"](),
        y = date[_ + "FullYear"](),
        H = date[_ + "Hours"](),
        M = date[_ + "Minutes"](),
        s = date[_ + "Seconds"](),
        L = date[_ + "Milliseconds"](),
        o = utc ? 0 : date.getTimezoneOffset(),
        flags = {
            d: d,
            dd: pad(d),
            ddd: dF.i18n.dayNames[D],
            dddd: dF.i18n.dayNames[D + 7],
            m: m + 1,
            mm: pad(m + 1),
            mmm: dF.i18n.monthNames[m],
            mmmm: dF.i18n.monthNames[m + 12],
            yy: String(y).slice(2),
            yyyy: y,
            h: H % 12 || 12,
            hh: pad(H % 12 || 12),
            H: H,
            HH: pad(H),
            M: M,
            MM: pad(M),
            s: s,
            ss: pad(s),
            l: pad(L, 3),
            L: pad(L > 99 ? Math.round(L / 10) : L),
            t: H < 12 ? "a" : "p",
            tt: H < 12 ? "am" : "pm",
            T: H < 12 ? "A" : "P",
            TT: H < 12 ? "AM" : "PM",
            Z: utc ? "UTC" : (String(date).match(timezone) || [""]).pop().replace(timezoneClip, ""),
            o: (o > 0 ? "-" : "+") + pad(Math.floor(Math.abs(o) / 60) * 100 + Math.abs(o) % 60, 4),
            S: ["th", "st", "nd", "rd"][d % 10 > 3 ? 0 : (d % 100 - d % 10 != 10) * d % 10]
        };

    return mask.replace(token, function ($0) {
        return $0 in flags ? flags[$0] : $0.slice(1, $0.length - 1);
    });
};

/**
 *
 */
Graph.prototype.createLayersDialog = function () {
    var div = document.createElement('div');
    div.style.position = 'absolute';

    var model = this.getModel();
    var childCount = model.getChildCount(model.root);

    for (var i = 0; i < childCount; i++) {
        (mxUtils.bind(this, function (layer) {
            var span = document.createElement('div');
            span.style.overflow = 'hidden';
            span.style.textOverflow = 'ellipsis';
            span.style.padding = '2px';
            span.style.whiteSpace = 'nowrap';

            var cb = document.createElement('input');
            cb.style.display = 'inline-block';
            cb.setAttribute('type', 'checkbox');

            if (model.isVisible(layer)) {
                cb.setAttribute('checked', 'checked');
                cb.defaultChecked = true;
            }

            span.appendChild(cb);

            var title = this.convertValueToString(layer) || (mxResources.get('background') || 'Background');
            span.setAttribute('title', title);
            mxUtils.write(span, title);
            div.appendChild(span);

            mxEvent.addListener(cb, 'click', function () {
                if (cb.getAttribute('checked') != null) {
                    cb.removeAttribute('checked');
                } else {
                    cb.setAttribute('checked', 'checked');
                }

                model.setVisible(layer, cb.checked);
            });
        })(model.getChildAt(model.root, i)));
    }

    return div;
};

/**
 * Private helper method.
 */
Graph.prototype.replacePlaceholders = function (cell, str) {
    var result = [];

    if (str != null) {
        var last = 0;

        while (match = this.placeholderPattern.exec(str)) {
            var val = match[0];

            if (val.length > 2 && val != '%label%' && val != '%tooltip%') {
                var tmp = null;

                if (match.index > last && str.charAt(match.index - 1) == '%') {
                    tmp = val.substring(1);
                } else {
                    var name = val.substring(1, val.length - 1);

                    // Workaround for invalid char for getting attribute in older versions of IE
                    if (name.indexOf('{') < 0) {
                        var current = cell;

                        while (tmp == null && current != null) {
                            if (current.value != null && typeof (current.value) == 'object') {
                                tmp = (current.hasAttribute(name)) ? ((current.getAttribute(name) != null) ?
                                    current.getAttribute(name) : '') : null;
                            }

                            current = this.model.getParent(current);
                        }
                    }

                    if (tmp == null) {
                        tmp = this.getGlobalVariable(name);
                    }
                }

                result.push(str.substring(last, match.index) + ((tmp != null) ? tmp : val));
                last = match.index + val.length;
            }
        }

        result.push(str.substring(last));
    }

    return result.join('');
};

/**
 * Resolves the given cells in the model and selects them.
 */
Graph.prototype.restoreSelection = function (cells) {
    if (cells != null && cells.length > 0) {
        var temp = [];

        for (var i = 0; i < cells.length; i++) {
            var newCell = this.model.getCell(cells[i].id);

            if (newCell != null) {
                temp.push(newCell);
            }
        }

        this.setSelectionCells(temp);
    } else {
        this.clearSelection();
    }
};

/**
 * Selects cells for connect vertex return value.
 */
Graph.prototype.selectCellsForConnectVertex = function (cells, evt, hoverIcons) {
    // Selects only target vertex if one exists
    if (cells.length == 2 && this.model.isVertex(cells[1])) {
        this.setSelectionCell(cells[1]);

        if (hoverIcons != null) {
            // Adds hover icons to new target vertex for touch devices
            if (mxEvent.isTouchEvent(evt)) {
                hoverIcons.update(hoverIcons.getState(this.view.getState(cells[1])));
            } else {
                // Hides hover icons after click with mouse
                hoverIcons.reset();
            }
        }

        this.scrollCellToVisible(cells[1]);
    } else {
        this.setSelectionCells(cells);
    }
};

/**
 * Adds a connection to the given vertex.
 */
Graph.prototype.connectVertex = function (source, direction, length, evt, forceClone, ignoreCellAt) {
    // Ignores relative edge labels
    if (source.geometry.relative && this.model.isEdge(source.parent)) {
        return [];
    }

    ignoreCellAt = (ignoreCellAt) ? ignoreCellAt : false;

    var pt = (source.geometry.relative && source.parent.geometry != null) ?
        new mxPoint(source.parent.geometry.width * source.geometry.x, source.parent.geometry.height * source.geometry.y) :
        new mxPoint(source.geometry.x, source.geometry.y);

    if (direction == mxConstants.DIRECTION_NORTH) {
        pt.x += source.geometry.width / 2;
        pt.y -= length;
    } else if (direction == mxConstants.DIRECTION_SOUTH) {
        pt.x += source.geometry.width / 2;
        pt.y += source.geometry.height + length;
    } else if (direction == mxConstants.DIRECTION_WEST) {
        pt.x -= length;
        pt.y += source.geometry.height / 2;
    } else {
        pt.x += source.geometry.width + length;
        pt.y += source.geometry.height / 2;
    }

    var parentState = this.view.getState(this.model.getParent(source));
    var s = this.view.scale;
    var t = this.view.translate;
    var dx = t.x * s;
    var dy = t.y * s;

    if (parentState != null && this.model.isVertex(parentState.cell)) {
        dx = parentState.x;
        dy = parentState.y;
    }

    // Workaround for relative child cells
    if (this.model.isVertex(source.parent) && source.geometry.relative) {
        pt.x += source.parent.geometry.x;
        pt.y += source.parent.geometry.y;
    }

    // Checks actual end point of edge for target cell
    var target = (ignoreCellAt || (mxEvent.isControlDown(evt) && !forceClone)) ?
        null : this.getCellAt(dx + pt.x * s, dy + pt.y * s);

    if (this.model.isAncestor(target, source)) {
        target = null;
    }

    // Checks if target or ancestor is locked
    var temp = target;

    while (temp != null) {
        if (this.isCellLocked(temp)) {
            target = null;
            break;
        }

        temp = this.model.getParent(temp);
    }

    // Checks if source and target intersect
    if (target != null) {
        var sourceState = this.view.getState(source);
        var targetState = this.view.getState(target);

        if (sourceState != null && targetState != null && mxUtils.intersects(sourceState, targetState)) {
            target = null;
        }
    }

    var duplicate = !mxEvent.isShiftDown(evt) || forceClone;

    if (duplicate) {
        if (direction == mxConstants.DIRECTION_NORTH) {
            pt.y -= source.geometry.height / 2;
        } else if (direction == mxConstants.DIRECTION_SOUTH) {
            pt.y += source.geometry.height / 2;
        } else if (direction == mxConstants.DIRECTION_WEST) {
            pt.x -= source.geometry.width / 2;
        } else {
            pt.x += source.geometry.width / 2;
        }
    }

    // Uses connectable parent vertex if one exists
    if (target != null && !this.isCellConnectable(target)) {
        var parent = this.getModel().getParent(target);

        if (this.getModel().isVertex(parent) && this.isCellConnectable(parent)) {
            target = parent;
        }
    }

    if (target == source || this.model.isEdge(target) || !this.isCellConnectable(target)) {
        target = null;
    }

    var result = [];

    this.model.beginUpdate();
    try {
        var realTarget = target;

        if (realTarget == null && duplicate) {
            // Handles relative children
            var cellToClone = source;
            var geo = this.getCellGeometry(source);

            while (geo != null && geo.relative) {
                cellToClone = this.getModel().getParent(cellToClone);
                geo = this.getCellGeometry(cellToClone);
            }

            // Handle consistuents for cloning
            var state = this.view.getState(cellToClone);
            var style = (state != null) ? state.style : this.getCellStyle(cellToClone);

            if (mxUtils.getValue(style, 'part', false)) {
                var tmpParent = this.model.getParent(cellToClone);

                if (this.model.isVertex(tmpParent)) {
                    cellToClone = tmpParent;
                }
            }

            realTarget = this.duplicateCells([cellToClone], false)[0];

            var geo = this.getCellGeometry(realTarget);

            if (geo != null) {
                geo.x = pt.x - geo.width / 2;
                geo.y = pt.y - geo.height / 2;
            }
        }

        // Never connects children in stack layouts
        var layout = null;

        if (this.layoutManager != null) {
            layout = this.layoutManager.getLayout(this.model.getParent(source));
        }

        var edge = ((mxEvent.isControlDown(evt) && duplicate) || (target == null && layout != null && layout.constructor == mxStackLayout)) ? null :
            this.insertEdge(this.model.getParent(source), null, '', source, realTarget, this.createCurrentEdgeStyle());

        // Inserts edge before source
        if (edge != null && this.connectionHandler.insertBeforeSource) {
            var index = null;
            var tmp = source;

            while (tmp.parent != null && tmp.geometry != null &&
            tmp.geometry.relative && tmp.parent != edge.parent) {
                tmp = this.model.getParent(tmp);
            }

            if (tmp != null && tmp.parent != null && tmp.parent == edge.parent) {
                var index = tmp.parent.getIndex(tmp);
                this.model.add(tmp.parent, edge, index);
            }
        }

        // Special case: Click on west icon puts clone before cell
        if (target == null && realTarget != null && layout != null && source.parent != null &&
            layout.constructor == mxStackLayout && direction == mxConstants.DIRECTION_WEST) {
            var index = source.parent.getIndex(source);
            this.model.add(source.parent, realTarget, index);
        }

        if (edge != null) {
            result.push(edge);
        }

        if (target == null && realTarget != null) {
            result.push(realTarget);
        }

        if (realTarget == null && edge != null) {
            edge.geometry.setTerminalPoint(pt, false);
        }

        if (edge != null) {
            this.fireEvent(new mxEventObject('cellsInserted', 'cells', [edge]));
        }
    } finally {
        this.model.endUpdate();
    }

    return result;
};

/**
 * Returns all labels in the diagram as a string.
 */
Graph.prototype.getIndexableText = function () {
    var tmp = document.createElement('div');
    var labels = [];
    var label = '';

    for (var key in this.model.cells) {
        var cell = this.model.cells[key];

        if (this.model.isVertex(cell) || this.model.isEdge(cell)) {
            if (this.isHtmlLabel(cell)) {
                tmp.innerHTML = this.getLabel(cell);
                label = mxUtils.extractTextWithWhitespace([tmp]);
            } else {
                label = this.getLabel(cell);
            }

            label = mxUtils.trim(label.replace(/[\x00-\x1F\x7F-\x9F]|\s+/g, ' '));

            if (label.length > 0) {
                labels.push(label);
            }
        }
    }

    return labels.join(' ');
};

/**
 * Returns the label for the given cell.
 */
Graph.prototype.convertValueToString = function (cell) {
    if (cell.value != null && typeof (cell.value) == 'object') {
        if (this.isReplacePlaceholders(cell) && cell.getAttribute('placeholder') != null) {
            var name = cell.getAttribute('placeholder');
            var current = cell;
            var result = null;

            while (result == null && current != null) {
                if (current.value != null && typeof (current.value) == 'object') {
                    result = (current.hasAttribute(name)) ? ((current.getAttribute(name) != null) ?
                        current.getAttribute(name) : '') : null;
                }

                current = this.model.getParent(current);
            }

            return result || '';
        } else {
            return cell.value.getAttribute('label') || '';
        }
    }

    return mxGraph.prototype.convertValueToString.apply(this, arguments);
};

/**
 * Returns the link for the given cell.
 */
Graph.prototype.getLinksForState = function (state) {
    if (state != null && state.text != null && state.text.node != null) {
        return state.text.node.getElementsByTagName('a');
    }

    return null;
};

/**
 * Returns the link for the given cell.
 */
Graph.prototype.getLinkForCell = function (cell) {
    if (cell.value != null && typeof (cell.value) == 'object') {
        var link = cell.value.getAttribute('link');

        // Removes links with leading javascript: protocol
        // TODO: Check more possible attack vectors
        if (link != null && link.toLowerCase().substring(0, 11) === 'javascript:') {
            link = link.substring(11);
        }

        return link;
    }

    return null;
};

/**
 * Overrides label orientation for collapsed swimlanes inside stack.
 */
Graph.prototype.getCellStyle = function (cell) {
    var style = mxGraph.prototype.getCellStyle.apply(this, arguments);

    if (cell != null && this.layoutManager != null) {
        var parent = this.model.getParent(cell);

        if (this.model.isVertex(parent) && this.isCellCollapsed(cell)) {
            var layout = this.layoutManager.getLayout(parent);

            if (layout != null && layout.constructor == mxStackLayout) {
                style[mxConstants.STYLE_HORIZONTAL] = !layout.horizontal;
            }
        }
    }

    return style;
};

/**
 * Disables alternate width persistence for stack layout parents
 */
Graph.prototype.updateAlternateBounds = function (cell, geo, willCollapse) {
    if (cell != null && geo != null && this.layoutManager != null && geo.alternateBounds != null) {
        var layout = this.layoutManager.getLayout(this.model.getParent(cell));

        if (layout != null && layout.constructor == mxStackLayout) {
            if (layout.horizontal) {
                geo.alternateBounds.height = 0;
            } else {
                geo.alternateBounds.width = 0;
            }
        }
    }

    mxGraph.prototype.updateAlternateBounds.apply(this, arguments);
};

/**
 * Adds Shift+collapse/expand and size management for folding inside stack
 */
Graph.prototype.isMoveCellsEvent = function (evt) {
    return mxEvent.isShiftDown(evt);
};

/**
 * Adds Shift+collapse/expand and size management for folding inside stack
 */
Graph.prototype.foldCells = function (collapse, recurse, cells, checkFoldable, evt) {
    recurse = (recurse != null) ? recurse : false;

    if (cells == null) {
        cells = this.getFoldableCells(this.getSelectionCells(), collapse);
    }

    if (cells != null) {
        this.model.beginUpdate();

        try {
            mxGraph.prototype.foldCells.apply(this, arguments);

            // Resizes all parent stacks if alt is not pressed
            if (this.layoutManager != null) {
                for (var i = 0; i < cells.length; i++) {
                    var state = this.view.getState(cells[i]);
                    var geo = this.getCellGeometry(cells[i]);

                    if (state != null && geo != null) {
                        var dx = Math.round(geo.width - state.width / this.view.scale);
                        var dy = Math.round(geo.height - state.height / this.view.scale);

                        if (dy != 0 || dx != 0) {
                            var parent = this.model.getParent(cells[i]);
                            var layout = this.layoutManager.getLayout(parent);

                            if (layout == null) {
                                // Moves cells to the right and down after collapse/expand
                                if (evt != null && this.isMoveCellsEvent(evt)) {
                                    this.moveSiblings(state, parent, dx, dy);
                                }
                            } else if ((evt == null || !mxEvent.isAltDown(evt)) && layout.constructor == mxStackLayout && !layout.resizeLast) {
                                this.resizeParentStacks(parent, layout, dx, dy);
                            }
                        }
                    }
                }
            }
        } finally {
            this.model.endUpdate();
        }

        // Selects cells after folding
        if (this.isEnabled()) {
            this.setSelectionCells(cells);
        }
    }
};

/**
 * Overrides label orientation for collapsed swimlanes inside stack.
 */
Graph.prototype.moveSiblings = function (state, parent, dx, dy) {
    this.model.beginUpdate();
    try {
        var cells = this.getCellsBeyond(state.x, state.y, parent, true, true);

        for (var i = 0; i < cells.length; i++) {
            if (cells[i] != state.cell) {
                var tmp = this.view.getState(cells[i]);
                var geo = this.getCellGeometry(cells[i]);

                if (tmp != null && geo != null) {
                    geo = geo.clone();
                    geo.translate(Math.round(dx * Math.max(0, Math.min(1, (tmp.x - state.x) / state.width))),
                        Math.round(dy * Math.max(0, Math.min(1, (tmp.y - state.y) / state.height))));
                    this.model.setGeometry(cells[i], geo);
                }
            }
        }
    } finally {
        this.model.endUpdate();
    }
};

/**
 * Overrides label orientation for collapsed swimlanes inside stack.
 */
Graph.prototype.resizeParentStacks = function (parent, layout, dx, dy) {
    if (this.layoutManager != null && layout != null && layout.constructor == mxStackLayout && !layout.resizeLast) {
        this.model.beginUpdate();
        try {
            var dir = layout.horizontal;

            // Bubble resize up for all parent stack layouts with same orientation
            while (parent != null && layout != null && layout.constructor == mxStackLayout &&
            layout.horizontal == dir && !layout.resizeLast) {
                var pgeo = this.getCellGeometry(parent);
                var pstate = this.view.getState(parent);

                if (pstate != null && pgeo != null) {
                    pgeo = pgeo.clone();

                    if (layout.horizontal) {
                        pgeo.width += dx + Math.min(0, pstate.width / this.view.scale - pgeo.width);
                    } else {
                        pgeo.height += dy + Math.min(0, pstate.height / this.view.scale - pgeo.height);
                    }

                    this.model.setGeometry(parent, pgeo);
                }

                parent = this.model.getParent(parent);
                layout = this.layoutManager.getLayout(parent);
            }
        } finally {
            this.model.endUpdate();
        }
    }
};

/**
 * Disables drill-down for non-swimlanes.
 */
Graph.prototype.isContainer = function (cell) {
    var state = this.view.getState(cell);
    var style = (state != null) ? state.style : this.getCellStyle(cell);

    if (this.isSwimlane(cell)) {
        return style['container'] != '0';
    } else {
        return style['container'] == '1';
    }
};

/**
 * Adds a connectable style.
 */
Graph.prototype.isCellConnectable = function (cell) {
    var state = this.view.getState(cell);
    var style = (state != null) ? state.style : this.getCellStyle(cell);

    return (style != null && style['connectable'] != null) ? style['connectable'] != '0' :
        mxGraph.prototype.isCellConnectable.apply(this, arguments);
};

/**
 * Function: selectAll
 *
 * Selects all children of the given parent cell or the children of the
 * default parent if no parent is specified. To select leaf vertices and/or
 * edges use <selectCells>.
 *
 * Parameters:
 *
 * parent - Optional <mxCell> whose children should be selected.
 * Default is <defaultParent>.
 */
Graph.prototype.selectAll = function (parent) {
    parent = parent || this.getDefaultParent();

    if (!this.isCellLocked(parent)) {
        mxGraph.prototype.selectAll.apply(this, arguments);
    }
};

/**
 * Function: selectCells
 *
 * Selects all vertices and/or edges depending on the given boolean
 * arguments recursively, starting at the given parent or the default
 * parent if no parent is specified. Use <selectAll> to select all cells.
 * For vertices, only cells with no children are selected.
 *
 * Parameters:
 *
 * vertices - Boolean indicating if vertices should be selected.
 * edges - Boolean indicating if edges should be selected.
 * parent - Optional <mxCell> that acts as the root of the recursion.
 * Default is <defaultParent>.
 */
Graph.prototype.selectCells = function (vertices, edges, parent) {
    parent = parent || this.getDefaultParent();

    if (!this.isCellLocked(parent)) {
        mxGraph.prototype.selectCells.apply(this, arguments);
    }
};

/**
 * Function: getSwimlaneAt
 *
 * Returns the bottom-most swimlane that intersects the given point (x, y)
 * in the cell hierarchy that starts at the given parent.
 *
 * Parameters:
 *
 * x - X-coordinate of the location to be checked.
 * y - Y-coordinate of the location to be checked.
 * parent - <mxCell> that should be used as the root of the recursion.
 * Default is <defaultParent>.
 */
Graph.prototype.getSwimlaneAt = function (x, y, parent) {
    parent = parent || this.getDefaultParent();

    if (!this.isCellLocked(parent)) {
        return mxGraph.prototype.getSwimlaneAt.apply(this, arguments);
    }

    return null;
};

/**
 * Disables folding for non-swimlanes.
 */
Graph.prototype.isCellFoldable = function (cell) {
    var state = this.view.getState(cell);
    var style = (state != null) ? state.style : this.getCellStyle(cell);

    return this.foldingEnabled && (style['treeFolding'] == '1' ||
        (!this.isCellLocked(cell) &&
            ((this.isContainer(cell) && style['collapsible'] != '0') ||
                (!this.isContainer(cell) && style['collapsible'] == '1'))));
};

/**
 * Stops all interactions and clears the selection.
 */
Graph.prototype.reset = function () {
    if (this.isEditing()) {
        this.stopEditing(true);
    }

    this.escape();

    if (!this.isSelectionEmpty()) {
        this.clearSelection();
    }
};

/**
 * Overridden to limit zoom to 1% - 16.000%.
 */
Graph.prototype.zoom = function (factor, center) {
    factor = Math.max(0.01, Math.min(this.view.scale * factor, 160)) / this.view.scale;

    mxGraph.prototype.zoom.apply(this, arguments);
};

/**
 * Function: zoomIn
 *
 * Zooms into the graph by <zoomFactor>.
 */
Graph.prototype.zoomIn = function () {
    // Switches to 1% zoom steps below 15%
    if (this.view.scale < 0.15) {
        this.zoom((this.view.scale + 0.01) / this.view.scale);
    } else {
        // Uses to 5% zoom steps for better grid rendering in webkit
        // and to avoid rounding errors for zoom steps
        this.zoom((Math.round(this.view.scale * this.zoomFactor * 20) / 20) / this.view.scale);
    }
};

/**
 * Function: zoomOut
 *
 * Zooms out of the graph by <zoomFactor>.
 */
Graph.prototype.zoomOut = function () {
    // Switches to 1% zoom steps below 15%
    if (this.view.scale <= 0.15) {
        this.zoom((this.view.scale - 0.01) / this.view.scale);
    } else {
        // Uses to 5% zoom steps for better grid rendering in webkit
        // and to avoid rounding errors for zoom steps
        this.zoom((Math.round(this.view.scale * (1 / this.zoomFactor) * 20) / 20) / this.view.scale);
    }
};

/**
 * Overrides tooltips to show custom tooltip or metadata.
 */
Graph.prototype.getTooltipForCell = function (cell) {
    var tip = '';

    if (mxUtils.isNode(cell.value)) {
        var tmp = cell.value.getAttribute('tooltip');

        if (tmp != null) {
            if (tmp != null && this.isReplacePlaceholders(cell)) {
                tmp = this.replacePlaceholders(cell, tmp);
            }

            tip = this.sanitizeHtml(tmp);
        } else {
            var ignored = this.builtInProperties;
            var attrs = cell.value.attributes;
            var temp = [];

            // Hides links in edit mode
            if (this.isEnabled()) {
                ignored.push('link');
            }

            for (var i = 0; i < attrs.length; i++) {
                if (mxUtils.indexOf(ignored, attrs[i].nodeName) < 0 && attrs[i].nodeValue.length > 0) {
                    temp.push({name: attrs[i].nodeName, value: attrs[i].nodeValue});
                }
            }

            // Sorts by name
            temp.sort(function (a, b) {
                if (a.name < b.name) {
                    return -1;
                } else if (a.name > b.name) {
                    return 1;
                } else {
                    return 0;
                }
            });

            for (var i = 0; i < temp.length; i++) {
                if (temp[i].name != 'link' || !this.isCustomLink(temp[i].value)) {
                    tip += ((temp[i].name != 'link') ? '<b>' + temp[i].name + ':</b> ' : '') +
                        mxUtils.htmlEntities(temp[i].value) + '\n';
                }
            }

            if (tip.length > 0) {
                tip = tip.substring(0, tip.length - 1);

                if (mxClient.IS_SVG) {
                    tip = '<div style="max-width:360px;">' + tip + '</div>';
                }
            }
        }
    }

    return tip;
};

/**
 * Turns the given string into an array.
 */
Graph.prototype.stringToBytes = function (str) {
    return Graph.stringToBytes(str);
};

/**
 * Turns the given array into a string.
 */
Graph.prototype.bytesToString = function (arr) {
    return Graph.bytesToString(arr);
};

/**
 * Returns a base64 encoded version of the compressed outer XML of the given node.
 */
Graph.prototype.compressNode = function (node) {
    return Graph.compressNode(node);
};

/**
 * Returns a base64 encoded version of the compressed string.
 */
Graph.prototype.compress = function (data, deflate) {
    return Graph.compress(data, deflate);
};

/**
 * Returns a decompressed version of the base64 encoded string.
 */
Graph.prototype.decompress = function (data, inflate) {
    return Graph.decompress(data, inflate);
};

/**
 * Redirects to Graph.zapGremlins.
 */
Graph.prototype.zapGremlins = function (text) {
    return Graph.zapGremlins(text);
};

/**
 * Hover icons are used for hover, vertex handler and drag from sidebar.
 */
HoverIcons = function (graph) {
    this.graph = graph;
    this.init();
};

/**
 * Up arrow.
 */
HoverIcons.prototype.arrowSpacing = 2;

/**
 * Delay to switch to another state for overlapping bbox. Default is 500ms.
 */
HoverIcons.prototype.updateDelay = 500;

/**
 * Delay to switch between states. Default is 140ms.
 */
HoverIcons.prototype.activationDelay = 140;

/**
 * Up arrow.
 */
HoverIcons.prototype.currentState = null;

/**
 * Up arrow.
 */
HoverIcons.prototype.activeArrow = null;

/**
 * Up arrow.
 */
HoverIcons.prototype.inactiveOpacity = 15;

/**
 * Up arrow.
 */
HoverIcons.prototype.cssCursor = 'copy';

/**
 * Whether to hide arrows that collide with vertices.
 * LATER: Add keyboard override, touch support.
 */
HoverIcons.prototype.checkCollisions = true;

/**
 * Up arrow.
 */
HoverIcons.prototype.arrowFill = '#29b6f2';

/**
 * Up arrow.
 */
HoverIcons.prototype.triangleUp = (!mxClient.IS_SVG) ? new mxImage(IMAGE_PATH + '/triangle-up.png', 26, 14) :
    Graph.createSvgImage(18, 28, '<path d="m 6 26 L 12 26 L 12 12 L 18 12 L 9 1 L 1 12 L 6 12 z" ' +
        'stroke="#fff" fill="' + HoverIcons.prototype.arrowFill + '"/>');

/**
 * Right arrow.
 */
HoverIcons.prototype.triangleRight = (!mxClient.IS_SVG) ? new mxImage(IMAGE_PATH + '/triangle-right.png', 14, 26) :
    Graph.createSvgImage(26, 18, '<path d="m 1 6 L 14 6 L 14 1 L 26 9 L 14 18 L 14 12 L 1 12 z" ' +
        'stroke="#fff" fill="' + HoverIcons.prototype.arrowFill + '"/>');

/**
 * Down arrow.
 */
HoverIcons.prototype.triangleDown = (!mxClient.IS_SVG) ? new mxImage(IMAGE_PATH + '/triangle-down.png', 26, 14) :
    Graph.createSvgImage(18, 26, '<path d="m 6 1 L 6 14 L 1 14 L 9 26 L 18 14 L 12 14 L 12 1 z" ' +
        'stroke="#fff" fill="' + HoverIcons.prototype.arrowFill + '"/>');

/**
 * Left arrow.
 */
HoverIcons.prototype.triangleLeft = (!mxClient.IS_SVG) ? new mxImage(IMAGE_PATH + '/triangle-left.png', 14, 26) :
    Graph.createSvgImage(28, 18, '<path d="m 1 9 L 12 1 L 12 6 L 26 6 L 26 12 L 12 12 L 12 18 z" ' +
        'stroke="#fff" fill="' + HoverIcons.prototype.arrowFill + '"/>');

/**
 * Round target.
 */
HoverIcons.prototype.roundDrop = (!mxClient.IS_SVG) ? new mxImage(IMAGE_PATH + '/round-drop.png', 26, 26) :
    Graph.createSvgImage(26, 26, '<circle cx="13" cy="13" r="12" ' +
        'stroke="#fff" fill="' + HoverIcons.prototype.arrowFill + '"/>');

/**
 * Refresh target.
 */
HoverIcons.prototype.refreshTarget = new mxImage((mxClient.IS_SVG) ? 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACYAAAAmCAYAAACoPemuAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyJpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBNYWNpbnRvc2giIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6NDQxNERDRTU1QjY1MTFFNDkzNTRFQTVEMTdGMTdBQjciIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6NDQxNERDRTY1QjY1MTFFNDkzNTRFQTVEMTdGMTdBQjciPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDo0NDE0RENFMzVCNjUxMUU0OTM1NEVBNUQxN0YxN0FCNyIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDo0NDE0RENFNDVCNjUxMUU0OTM1NEVBNUQxN0YxN0FCNyIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PsvuX50AAANaSURBVHja7FjRZ1tRGD9ZJ1NCyIQSwrivI4Q8hCpjlFDyFEoYfSp9Ko1QWnmo0If+BSXkIfo0QirTMUpeGo2EPfWllFYjZMLKLDJn53d3biU337m5J223bPbxk5t7v+/c3/2+73znO8fDOWezKM/YjMpz68Lj8ejY+QTeCCwLxOS9qPxtyN+6wAeBTwJ31CCO0cJDjXBGBN4LfIepSwykTUT1bgpuib0SONIgo8KRHOtRiCFcvUcgZeGrHPNBxLIyFPyRgTGz0xLbegJCdmzpElue5KlAIMDX19d5uVzm5+fnfDAYmMA17uEZdOx2Yvb/sHlu2S0xwymn5ufneTab5b1ej08S6EAXNrDd2dnhiUTim21MvMtwQ6yiIrWwsMDPzs64rsBmf3/fvM7n89TYlUnEllSkQqEQv7q64g+Vk5MTVXosORErU0Zer5f0FEIlw2N6MxwO82QyaXql2+2SxDqdjopYWUUsqEp45IldqtWq6UWVh/1+P7+8vCTJ4QMUJSRIEXuneoH96w8PDyeWAnhSJfCqwm6NIlaklFdXV0cGhRcQ2mlJQXK5nMq2YPEZbnteU1U2lUqN/D84OGD9fl+5fgnSrFarsUwmw0qlEru4uBjTicViTk3Cr27HSnxR+Doyz0ZE1CAWiUTusbu7y9rttlZv5fP5WDQavYfIMba4uEipfhF8XtqJoZXx/uH+sC/4vPg7OljZZQbsCmLtYzc3N6zRaJhotVrmfx0xDINtbm6athYUeXpHdbBNaqZUKpWxWXV7e2vex+xaWVnhc3NzjrPUXgexyCt0m67LBV7uJMITjqRE4o8tZeg8FPpFitgapYxiOC0poFgsji1jKNo6BZZckrAGUtJsNk1vqAihCBcKhTE7hNWhqw2qFnGy5UFOUYJVIJ1OjzSE+BCEilon0URavRmBqnbbQ00AXbm+vnZc9O1tj72OnQoc2+cwygRkb2+P1et17ZoEm3g87lRmjgWZ00kbXkNuse6/Bu2wlegIxfb2tuvWGroO4bO2c4bbzUh60mxDXm1sbJhhxkQYnhS4h2fUZoRAWnf7lv8N27f8P7Xhnekjgpk+VKGOoQbsiY+hhhtF3YO7twIJ+ULvUGv+GQ2fQEvWxI/THNx5/p/BaspPAQYAqStgiSQwCDoAAAAASUVORK5CYII=' :
    IMAGE_PATH + '/refresh.png', 38, 38);

/**
 * Tolerance for hover icon clicks.
 */
HoverIcons.prototype.tolerance = (mxClient.IS_TOUCH) ? 6 : 0;

/**
 *
 */
HoverIcons.prototype.init = function () {
    this.arrowUp = this.createArrow(this.triangleUp, mxResources.get('plusTooltip'));
    this.arrowRight = this.createArrow(this.triangleRight, mxResources.get('plusTooltip'));
    this.arrowDown = this.createArrow(this.triangleDown, mxResources.get('plusTooltip'));
    this.arrowLeft = this.createArrow(this.triangleLeft, mxResources.get('plusTooltip'));

    this.elts = [this.arrowUp, this.arrowRight, this.arrowDown, this.arrowLeft];

    this.repaintHandler = mxUtils.bind(this, function () {
        this.repaint();
    });

    this.graph.selectionModel.addListener(mxEvent.CHANGE, this.repaintHandler);
    this.graph.model.addListener(mxEvent.CHANGE, this.repaintHandler);
    this.graph.view.addListener(mxEvent.SCALE_AND_TRANSLATE, this.repaintHandler);
    this.graph.view.addListener(mxEvent.TRANSLATE, this.repaintHandler);
    this.graph.view.addListener(mxEvent.SCALE, this.repaintHandler);
    this.graph.view.addListener(mxEvent.DOWN, this.repaintHandler);
    this.graph.view.addListener(mxEvent.UP, this.repaintHandler);
    this.graph.addListener(mxEvent.ROOT, this.repaintHandler);

    // Resets the mouse point on escape
    this.graph.addListener(mxEvent.ESCAPE, mxUtils.bind(this, function () {
        this.mouseDownPoint = null;
    }));

    // Removes hover icons if mouse leaves the container
    mxEvent.addListener(this.graph.container, 'mouseleave', mxUtils.bind(this, function (evt) {
        // Workaround for IE11 firing mouseleave for touch in diagram
        if (evt.relatedTarget != null && mxEvent.getSource(evt) == this.graph.container) {
            this.setDisplay('none');
        }
    }));

    // Resets current state when in-place editor starts
    this.graph.addListener(mxEvent.START_EDITING, mxUtils.bind(this, function (evt) {
        this.reset();
    }));

    // Resets current state after update of selection state for touch events
    var graphClick = this.graph.click;
    this.graph.click = mxUtils.bind(this, function (me) {
        graphClick.apply(this.graph, arguments);

        if (this.currentState != null && !this.graph.isCellSelected(this.currentState.cell) &&
            mxEvent.isTouchEvent(me.getEvent()) && !this.graph.model.isVertex(me.getCell())) {
            this.reset();
        }
    });

    // Checks if connection handler was active in mouse move
    // as workaround for possible double connection inserted
    var connectionHandlerActive = false;

    // Implements a listener for hover and click handling
    this.graph.addMouseListener(
        {
            mouseDown: mxUtils.bind(this, function (sender, me) {
                connectionHandlerActive = false;
                var evt = me.getEvent();

                if (this.isResetEvent(evt)) {
                    this.reset();
                } else if (!this.isActive()) {
                    var state = this.getState(me.getState());

                    if (state != null || !mxEvent.isTouchEvent(evt)) {
                        this.update(state);
                    }
                }

                this.setDisplay('none');
            }),
            mouseMove: mxUtils.bind(this, function (sender, me) {
                var evt = me.getEvent();

                if (this.isResetEvent(evt)) {
                    this.reset();
                } else if (!this.graph.isMouseDown && !mxEvent.isTouchEvent(evt)) {
                    this.update(this.getState(me.getState()),
                        me.getGraphX(), me.getGraphY());
                }

                if (this.graph.connectionHandler != null &&
                    this.graph.connectionHandler.shape != null) {
                    connectionHandlerActive = true;
                }
            }),
            mouseUp: mxUtils.bind(this, function (sender, me) {
                var evt = me.getEvent();
                var pt = mxUtils.convertPoint(this.graph.container,
                    mxEvent.getClientX(evt), mxEvent.getClientY(evt))

                if (this.isResetEvent(evt)) {
                    this.reset();
                } else if (this.isActive() && !connectionHandlerActive &&
                    this.mouseDownPoint != null) {
                    this.click(this.currentState, this.getDirection(), me);
                } else if (this.isActive()) {
                    // Selects target vertex after drag and clone if not only new edge was inserted
                    if (this.graph.getSelectionCount() != 1 || !this.graph.model.isEdge(
                        this.graph.getSelectionCell())) {
                        this.update(this.getState(this.graph.view.getState(
                            this.graph.getCellAt(me.getGraphX(), me.getGraphY()))));
                    } else {
                        this.reset();
                    }
                } else if (mxEvent.isTouchEvent(evt) || (this.bbox != null &&
                    mxUtils.contains(this.bbox, me.getGraphX(), me.getGraphY()))) {
                    // Shows existing hover icons if inside bounding box
                    this.setDisplay('');
                    this.repaint();
                } else if (!mxEvent.isTouchEvent(evt)) {
                    this.reset();
                }

                connectionHandlerActive = false;
                this.resetActiveArrow();
            })
        });
};

/**
 *
 */
HoverIcons.prototype.isResetEvent = function (evt, allowShift) {
    return mxEvent.isAltDown(evt) || (this.activeArrow == null && mxEvent.isShiftDown(evt)) ||
        mxEvent.isMetaDown(evt) || (mxEvent.isPopupTrigger(evt) && !mxEvent.isControlDown(evt));
};

/**
 *
 */
HoverIcons.prototype.createArrow = function (img, tooltip) {
    var arrow = null;

    if (mxClient.IS_IE && !mxClient.IS_SVG) {
        // Workaround for PNG images in IE6
        if (mxClient.IS_IE6 && document.compatMode != 'CSS1Compat') {
            arrow = document.createElement(mxClient.VML_PREFIX + ':image');
            arrow.setAttribute('src', img.src);
            arrow.style.borderStyle = 'none';
        } else {
            arrow = document.createElement('div');
            arrow.style.backgroundImage = 'url(' + img.src + ')';
            arrow.style.backgroundPosition = 'center';
            arrow.style.backgroundRepeat = 'no-repeat';
        }

        arrow.style.width = (img.width + 4) + 'px';
        arrow.style.height = (img.height + 4) + 'px';
        arrow.style.display = (mxClient.IS_QUIRKS) ? 'inline' : 'inline-block';
    } else {
        arrow = mxUtils.createImage(img.src);
        arrow.style.width = img.width + 'px';
        arrow.style.height = img.height + 'px';
        arrow.style.padding = this.tolerance + 'px';
    }

    if (tooltip != null) {
        arrow.setAttribute('title', tooltip);
    }

    arrow.style.position = 'absolute';
    arrow.style.cursor = this.cssCursor;

    mxEvent.addGestureListeners(arrow, mxUtils.bind(this, function (evt) {
        if (this.currentState != null && !this.isResetEvent(evt)) {
            this.mouseDownPoint = mxUtils.convertPoint(this.graph.container,
                mxEvent.getClientX(evt), mxEvent.getClientY(evt));
            this.drag(evt, this.mouseDownPoint.x, this.mouseDownPoint.y);
            this.activeArrow = arrow;
            this.setDisplay('none');
            mxEvent.consume(evt);
        }
    }));

    // Captures mouse events as events on graph
    mxEvent.redirectMouseEvents(arrow, this.graph, this.currentState);

    mxEvent.addListener(arrow, 'mouseenter', mxUtils.bind(this, function (evt) {
        // Workaround for Firefox firing mouseenter on touchend
        if (mxEvent.isMouseEvent(evt)) {
            if (this.activeArrow != null && this.activeArrow != arrow) {
                mxUtils.setOpacity(this.activeArrow, this.inactiveOpacity);
            }

            this.graph.connectionHandler.constraintHandler.reset();
            mxUtils.setOpacity(arrow, 100);
            this.activeArrow = arrow;
        }
    }));

    mxEvent.addListener(arrow, 'mouseleave', mxUtils.bind(this, function (evt) {
        // Workaround for IE11 firing this event on touch
        if (!this.graph.isMouseDown) {
            this.resetActiveArrow();
        }
    }));

    return arrow;
};

/**
 *
 */
HoverIcons.prototype.resetActiveArrow = function () {
    if (this.activeArrow != null) {
        mxUtils.setOpacity(this.activeArrow, this.inactiveOpacity);
        this.activeArrow = null;
    }
};

/**
 *
 */
HoverIcons.prototype.getDirection = function () {
    var dir = mxConstants.DIRECTION_EAST;

    if (this.activeArrow == this.arrowUp) {
        dir = mxConstants.DIRECTION_NORTH;
    } else if (this.activeArrow == this.arrowDown) {
        dir = mxConstants.DIRECTION_SOUTH;
    } else if (this.activeArrow == this.arrowLeft) {
        dir = mxConstants.DIRECTION_WEST;
    }

    return dir;
};

/**
 *
 */
HoverIcons.prototype.visitNodes = function (visitor) {
    for (var i = 0; i < this.elts.length; i++) {
        if (this.elts[i] != null) {
            visitor(this.elts[i]);
        }
    }
};

/**
 *
 */
HoverIcons.prototype.removeNodes = function () {
    this.visitNodes(function (elt) {
        if (elt.parentNode != null) {
            elt.parentNode.removeChild(elt);
        }
    });
};

/**
 *
 */
HoverIcons.prototype.setDisplay = function (display) {
    this.visitNodes(function (elt) {
        elt.style.display = display;
    });
};

/**
 *
 */
HoverIcons.prototype.isActive = function () {
    return this.activeArrow != null && this.currentState != null;
};

/**
 *
 */
HoverIcons.prototype.drag = function (evt, x, y) {
    this.graph.popupMenuHandler.hideMenu();
    this.graph.stopEditing(false);

    // Checks if state was removed in call to stopEditing above
    if (this.currentState != null) {
        this.graph.connectionHandler.start(this.currentState, x, y);
        this.graph.isMouseTrigger = mxEvent.isMouseEvent(evt);
        this.graph.isMouseDown = true;

        // Hides handles for selection cell
        var handler = this.graph.selectionCellsHandler.getHandler(this.currentState.cell);

        if (handler != null) {
            handler.setHandlesVisible(false);
        }

        // Ctrl+shift drag sets source constraint
        var es = this.graph.connectionHandler.edgeState;

        if (evt != null && mxEvent.isShiftDown(evt) && mxEvent.isControlDown(evt) && es != null &&
            mxUtils.getValue(es.style, mxConstants.STYLE_EDGE, null) === 'orthogonalEdgeStyle') {
            var direction = this.getDirection();
            es.cell.style = mxUtils.setStyle(es.cell.style, 'sourcePortConstraint', direction);
            es.style['sourcePortConstraint'] = direction;
        }
    }
};

/**
 *
 */
HoverIcons.prototype.getStateAt = function (state, x, y) {
    return this.graph.view.getState(this.graph.getCellAt(x, y));
};

/**
 *
 */
HoverIcons.prototype.click = function (state, dir, me) {
    var evt = me.getEvent();
    var x = me.getGraphX();
    var y = me.getGraphY();

    var tmp = this.getStateAt(state, x, y);

    if (tmp != null && this.graph.model.isEdge(tmp.cell) && !mxEvent.isControlDown(evt) &&
        (tmp.getVisibleTerminalState(true) == state || tmp.getVisibleTerminalState(false) == state)) {
        this.graph.setSelectionCell(tmp.cell);
        this.reset();
    } else if (state != null) {
        var cells = this.graph.connectVertex(state.cell, dir, this.graph.defaultEdgeLength, evt);
        this.graph.selectCellsForConnectVertex(cells, evt, this);

        // Selects only target vertex if one exists
        if (cells.length == 2 && this.graph.model.isVertex(cells[1])) {
            this.graph.setSelectionCell(cells[1]);

            // Adds hover icons to new target vertex for touch devices
            if (mxEvent.isTouchEvent(evt)) {
                this.update(this.getState(this.graph.view.getState(cells[1])));
            } else {
                // Hides hover icons after click with mouse
                this.reset();
            }

            this.graph.scrollCellToVisible(cells[1]);
        } else {
            this.graph.setSelectionCells(cells);
        }
    }

    me.consume();
};

/**
 *
 */
HoverIcons.prototype.reset = function (clearTimeout) {
    clearTimeout = (clearTimeout == null) ? true : clearTimeout;

    if (clearTimeout && this.updateThread != null) {
        window.clearTimeout(this.updateThread);
    }

    this.mouseDownPoint = null;
    this.currentState = null;
    this.activeArrow = null;
    this.removeNodes();
    this.bbox = null;
};

/**
 *
 */
HoverIcons.prototype.repaint = function () {
    this.bbox = null;

    if (this.currentState != null) {
        // Checks if cell was deleted
        this.currentState = this.getState(this.currentState);

        // Cell was deleted
        if (this.currentState != null &&
            this.graph.model.isVertex(this.currentState.cell) &&
            this.graph.isCellConnectable(this.currentState.cell)) {
            var bds = mxRectangle.fromRectangle(this.currentState);

            // Uses outer bounding box to take rotation into account
            if (this.currentState.shape != null && this.currentState.shape.boundingBox != null) {
                bds = mxRectangle.fromRectangle(this.currentState.shape.boundingBox);
            }

            bds.grow(this.graph.tolerance);
            bds.grow(this.arrowSpacing);

            var handler = this.graph.selectionCellsHandler.getHandler(this.currentState.cell);

            if (handler != null) {
                bds.x -= handler.horizontalOffset / 2;
                bds.y -= handler.verticalOffset / 2;
                bds.width += handler.horizontalOffset;
                bds.height += handler.verticalOffset;

                // Adds bounding box of rotation handle to avoid overlap
                if (handler.rotationShape != null && handler.rotationShape.node != null &&
                    handler.rotationShape.node.style.visibility != 'hidden' &&
                    handler.rotationShape.node.style.display != 'none' &&
                    handler.rotationShape.boundingBox != null) {
                    bds.add(handler.rotationShape.boundingBox);
                }
            }

            this.arrowUp.style.left = Math.round(this.currentState.getCenterX() - this.triangleUp.width / 2 - this.tolerance) + 'px';
            this.arrowUp.style.top = Math.round(bds.y - this.triangleUp.height - this.tolerance) + 'px';
            mxUtils.setOpacity(this.arrowUp, this.inactiveOpacity);

            this.arrowRight.style.left = Math.round(bds.x + bds.width - this.tolerance) + 'px';
            this.arrowRight.style.top = Math.round(this.currentState.getCenterY() - this.triangleRight.height / 2 - this.tolerance) + 'px';
            mxUtils.setOpacity(this.arrowRight, this.inactiveOpacity);

            this.arrowDown.style.left = this.arrowUp.style.left;
            this.arrowDown.style.top = Math.round(bds.y + bds.height - this.tolerance) + 'px';
            mxUtils.setOpacity(this.arrowDown, this.inactiveOpacity);

            this.arrowLeft.style.left = Math.round(bds.x - this.triangleLeft.width - this.tolerance) + 'px';
            this.arrowLeft.style.top = this.arrowRight.style.top;
            mxUtils.setOpacity(this.arrowLeft, this.inactiveOpacity);

            if (this.checkCollisions) {
                var right = this.graph.getCellAt(bds.x + bds.width +
                    this.triangleRight.width / 2, this.currentState.getCenterY());
                var left = this.graph.getCellAt(bds.x - this.triangleLeft.width / 2, this.currentState.getCenterY());
                var top = this.graph.getCellAt(this.currentState.getCenterX(), bds.y - this.triangleUp.height / 2);
                var bottom = this.graph.getCellAt(this.currentState.getCenterX(), bds.y + bds.height + this.triangleDown.height / 2);

                // Shows hover icons large cell is behind all directions of current cell
                if (right != null && right == left && left == top && top == bottom) {
                    right = null;
                    left = null;
                    top = null;
                    bottom = null;
                }

                var currentGeo = this.graph.getCellGeometry(this.currentState.cell);

                var checkCollision = mxUtils.bind(this, function (cell, arrow) {
                    var geo = this.graph.model.isVertex(cell) && this.graph.getCellGeometry(cell);

                    // Ignores collision if vertex is more than 3 times the size of this vertex
                    if (cell != null && !this.graph.model.isAncestor(cell, this.currentState.cell) &&
                        (geo == null || currentGeo == null || (geo.height < 6 * currentGeo.height &&
                            geo.width < 6 * currentGeo.width))) {
                        arrow.style.visibility = 'hidden';
                    } else {
                        arrow.style.visibility = 'visible';
                    }
                });

                checkCollision(right, this.arrowRight);
                checkCollision(left, this.arrowLeft);
                checkCollision(top, this.arrowUp);
                checkCollision(bottom, this.arrowDown);
            } else {
                this.arrowLeft.style.visibility = 'visible';
                this.arrowRight.style.visibility = 'visible';
                this.arrowUp.style.visibility = 'visible';
                this.arrowDown.style.visibility = 'visible';
            }

            if (this.graph.tooltipHandler.isEnabled()) {
                this.arrowLeft.setAttribute('title', mxResources.get('plusTooltip'));
                this.arrowRight.setAttribute('title', mxResources.get('plusTooltip'));
                this.arrowUp.setAttribute('title', mxResources.get('plusTooltip'));
                this.arrowDown.setAttribute('title', mxResources.get('plusTooltip'));
            } else {
                this.arrowLeft.removeAttribute('title');
                this.arrowRight.removeAttribute('title');
                this.arrowUp.removeAttribute('title');
                this.arrowDown.removeAttribute('title');
            }
        } else {
            this.reset();
        }

        // Updates bounding box
        if (this.currentState != null) {
            this.bbox = this.computeBoundingBox();

            // Adds tolerance for hover
            if (this.bbox != null) {
                this.bbox.grow(10);
            }
        }
    }
};

/**
 *
 */
HoverIcons.prototype.computeBoundingBox = function () {
    var bbox = (!this.graph.model.isEdge(this.currentState.cell)) ? mxRectangle.fromRectangle(this.currentState) : null;

    this.visitNodes(function (elt) {
        if (elt.parentNode != null) {
            var tmp = new mxRectangle(elt.offsetLeft, elt.offsetTop, elt.offsetWidth, elt.offsetHeight);

            if (bbox == null) {
                bbox = tmp;
            } else {
                bbox.add(tmp);
            }
        }
    });

    return bbox;
};

/**
 *
 */
HoverIcons.prototype.getState = function (state) {
    if (state != null) {
        var cell = state.cell;

        if (!this.graph.getModel().contains(cell)) {
            state = null;
        } else {
            // Uses connectable parent vertex if child is not connectable
            if (this.graph.getModel().isVertex(cell) && !this.graph.isCellConnectable(cell)) {
                var parent = this.graph.getModel().getParent(cell);

                if (this.graph.getModel().isVertex(parent) && this.graph.isCellConnectable(parent)) {
                    cell = parent;
                }
            }

            // Ignores locked cells and edges
            if (this.graph.isCellLocked(cell) || this.graph.model.isEdge(cell)) {
                cell = null;
            }

            state = this.graph.view.getState(cell);

            if (state != null && state.style == null) {
                state = null;
            }
        }
    }

    return state;
};

/**
 *
 */
HoverIcons.prototype.update = function (state, x, y) {
    if (!this.graph.connectionArrowsEnabled || (state != null &&
        mxUtils.getValue(state.style, 'allowArrows', '1') == '0')) {
        this.reset();
    } else {
        if (state != null && state.cell.geometry != null && state.cell.geometry.relative &&
            this.graph.model.isEdge(state.cell.parent)) {
            state = null;
        }

        var timeOnTarget = null;

        // Time on target
        if (this.prev != state || this.isActive()) {
            this.startTime = new Date().getTime();
            this.prev = state;
            timeOnTarget = 0;

            if (this.updateThread != null) {
                window.clearTimeout(this.updateThread);
            }

            if (state != null) {
                // Starts timer to update current state with no mouse events
                this.updateThread = window.setTimeout(mxUtils.bind(this, function () {
                    if (!this.isActive() && !this.graph.isMouseDown &&
                        !this.graph.panningHandler.isActive()) {
                        this.prev = state;
                        this.update(state, x, y);
                    }
                }), this.updateDelay + 10);
            }
        } else if (this.startTime != null) {
            timeOnTarget = new Date().getTime() - this.startTime;
        }

        this.setDisplay('');

        if (this.currentState != null && this.currentState != state && timeOnTarget < this.activationDelay &&
            this.bbox != null && !mxUtils.contains(this.bbox, x, y)) {
            this.reset(false);
        } else if (this.currentState != null || timeOnTarget > this.activationDelay) {
            if (this.currentState != state && ((timeOnTarget > this.updateDelay && state != null) ||
                this.bbox == null || x == null || y == null || !mxUtils.contains(this.bbox, x, y))) {
                if (state != null && this.graph.isEnabled()) {
                    this.removeNodes();
                    this.setCurrentState(state);
                    this.repaint();

                    // Resets connection points on other focused cells
                    if (this.graph.connectionHandler.constraintHandler.currentFocus != state) {
                        this.graph.connectionHandler.constraintHandler.reset();
                    }
                } else {
                    this.reset();
                }
            }
        }
    }
};

/**
 *
 */
HoverIcons.prototype.setCurrentState = function (state) {
    if (state.style['portConstraint'] != 'eastwest') {
        this.graph.container.appendChild(this.arrowUp);
        this.graph.container.appendChild(this.arrowDown);
    }

    this.graph.container.appendChild(this.arrowRight);
    this.graph.container.appendChild(this.arrowLeft);
    this.currentState = state;
};

(function () {
    /**
     * Reset the list of processed edges.
     */
    var mxGraphViewResetValidationState = mxGraphView.prototype.resetValidationState;

    mxGraphView.prototype.resetValidationState = function () {
        mxGraphViewResetValidationState.apply(this, arguments);

        this.validEdges = [];
    };

    /**
     * Updates jumps for valid edges and repaints if needed.
     */
    var mxGraphViewValidateCellState = mxGraphView.prototype.validateCellState;

    mxGraphView.prototype.validateCellState = function (cell, recurse) {
        recurse = (recurse != null) ? recurse : true;
        var state = this.getState(cell);

        // Forces repaint if jumps change on a valid edge
        if (state != null && recurse && this.graph.model.isEdge(state.cell) &&
            state.style != null && state.style[mxConstants.STYLE_CURVED] != 1 &&
            !state.invalid && this.updateLineJumps(state)) {
            this.graph.cellRenderer.redraw(state, false, this.isRendering());
        }

        state = mxGraphViewValidateCellState.apply(this, arguments);

        // Adds to the list of edges that may intersect with later edges
        if (state != null && recurse && this.graph.model.isEdge(state.cell) &&
            state.style != null && state.style[mxConstants.STYLE_CURVED] != 1) {
            // LATER: Reuse jumps for valid edges
            this.validEdges.push(state);
        }

        return state;
    };

    /**
     * Forces repaint if routed points have changed.
     */
    var mxCellRendererIsShapeInvalid = mxCellRenderer.prototype.isShapeInvalid;

    mxCellRenderer.prototype.isShapeInvalid = function (state, shape) {
        return mxCellRendererIsShapeInvalid.apply(this, arguments) ||
            (state.routedPoints != null && shape.routedPoints != null &&
                !mxUtils.equalPoints(shape.routedPoints, state.routedPoints))
    };


    /**
     * Updates jumps for invalid edges.
     */
    var mxGraphViewUpdateCellState = mxGraphView.prototype.updateCellState;

    mxGraphView.prototype.updateCellState = function (state) {
        mxGraphViewUpdateCellState.apply(this, arguments);

        // Updates jumps on invalid edge before repaint
        if (this.graph.model.isEdge(state.cell) &&
            state.style[mxConstants.STYLE_CURVED] != 1) {
            this.updateLineJumps(state);
        }
    };

    /**
     * Updates the jumps between given state and processed edges.
     */
    mxGraphView.prototype.updateLineJumps = function (state) {
        var pts = state.absolutePoints;

        if (Graph.lineJumpsEnabled) {
            var changed = state.routedPoints != null;
            var actual = null;

            if (pts != null && this.validEdges != null &&
                mxUtils.getValue(state.style, 'jumpStyle', 'none') !== 'none') {
                var thresh = 0.5 * this.scale;
                changed = false;
                actual = [];

                // Type 0 means normal waypoint, 1 means jump
                function addPoint(type, x, y) {
                    var rpt = new mxPoint(x, y);
                    rpt.type = type;

                    actual.push(rpt);
                    var curr = (state.routedPoints != null) ? state.routedPoints[actual.length - 1] : null;

                    return curr == null || curr.type != type || curr.x != x || curr.y != y;
                };

                for (var i = 0; i < pts.length - 1; i++) {
                    var p1 = pts[i + 1];
                    var p0 = pts[i];
                    var list = [];

                    // Ignores waypoints on straight segments
                    var pn = pts[i + 2];

                    while (i < pts.length - 2 &&
                    mxUtils.ptSegDistSq(p0.x, p0.y, pn.x, pn.y,
                        p1.x, p1.y) < 1 * this.scale * this.scale) {
                        p1 = pn;
                        i++;
                        pn = pts[i + 2];
                    }

                    changed = addPoint(0, p0.x, p0.y) || changed;

                    // Processes all previous edges
                    for (var e = 0; e < this.validEdges.length; e++) {
                        var state2 = this.validEdges[e];
                        var pts2 = state2.absolutePoints;

                        if (pts2 != null && mxUtils.intersects(state, state2) && state2.style['noJump'] != '1') {
                            // Compares each segment of the edge with the current segment
                            for (var j = 0; j < pts2.length - 1; j++) {
                                var p3 = pts2[j + 1];
                                var p2 = pts2[j];

                                // Ignores waypoints on straight segments
                                pn = pts2[j + 2];

                                while (j < pts2.length - 2 &&
                                mxUtils.ptSegDistSq(p2.x, p2.y, pn.x, pn.y,
                                    p3.x, p3.y) < 1 * this.scale * this.scale) {
                                    p3 = pn;
                                    j++;
                                    pn = pts2[j + 2];
                                }

                                var pt = mxUtils.intersection(p0.x, p0.y, p1.x, p1.y, p2.x, p2.y, p3.x, p3.y);

                                // Handles intersection between two segments
                                if (pt != null && (Math.abs(pt.x - p0.x) > thresh ||
                                    Math.abs(pt.y - p0.y) > thresh) &&
                                    (Math.abs(pt.x - p1.x) > thresh ||
                                        Math.abs(pt.y - p1.y) > thresh) &&
                                    (Math.abs(pt.x - p2.x) > thresh ||
                                        Math.abs(pt.y - p2.y) > thresh) &&
                                    (Math.abs(pt.x - p3.x) > thresh ||
                                        Math.abs(pt.y - p3.y) > thresh)) {
                                    var dx = pt.x - p0.x;
                                    var dy = pt.y - p0.y;
                                    var temp = {distSq: dx * dx + dy * dy, x: pt.x, y: pt.y};

                                    // Intersections must be ordered by distance from start of segment
                                    for (var t = 0; t < list.length; t++) {
                                        if (list[t].distSq > temp.distSq) {
                                            list.splice(t, 0, temp);
                                            temp = null;

                                            break;
                                        }
                                    }

                                    // Ignores multiple intersections at segment joint
                                    if (temp != null && (list.length == 0 ||
                                        list[list.length - 1].x !== temp.x ||
                                        list[list.length - 1].y !== temp.y)) {
                                        list.push(temp);
                                    }
                                }
                            }
                        }
                    }

                    // Adds ordered intersections to routed points
                    for (var j = 0; j < list.length; j++) {
                        changed = addPoint(1, list[j].x, list[j].y) || changed;
                    }
                }

                var pt = pts[pts.length - 1];
                changed = addPoint(0, pt.x, pt.y) || changed;
            }

            state.routedPoints = actual;

            return changed;
        } else {
            return false;
        }
    };

    /**
     * Overrides painting the actual shape for taking into account jump style.
     */
    var mxConnectorPaintLine = mxConnector.prototype.paintLine;

    mxConnector.prototype.paintLine = function (c, absPts, rounded) {
        // Required for checking dirty state
        this.routedPoints = (this.state != null) ? this.state.routedPoints : null;

        if (this.outline || this.state == null || this.style == null ||
            this.state.routedPoints == null || this.state.routedPoints.length == 0) {
            mxConnectorPaintLine.apply(this, arguments);
        } else {
            var arcSize = mxUtils.getValue(this.style, mxConstants.STYLE_ARCSIZE,
                mxConstants.LINE_ARCSIZE) / 2;
            var size = (parseInt(mxUtils.getValue(this.style, 'jumpSize',
                Graph.defaultJumpSize)) - 2) / 2 + this.strokewidth;
            var style = mxUtils.getValue(this.style, 'jumpStyle', 'none');
            var f = Editor.jumpSizeRatio;
            var moveTo = true;
            var last = null;
            var len = null;
            var pts = [];
            var n = null;
            c.begin();

            for (var i = 0; i < this.state.routedPoints.length; i++) {
                var rpt = this.state.routedPoints[i];
                var pt = new mxPoint(rpt.x / this.scale, rpt.y / this.scale);

                // Takes first and last point from passed-in array
                if (i == 0) {
                    pt = absPts[0];
                } else if (i == this.state.routedPoints.length - 1) {
                    pt = absPts[absPts.length - 1];
                }

                var done = false;

                // Type 1 is an intersection
                if (last != null && rpt.type == 1) {
                    // Checks if next/previous points are too close
                    var next = this.state.routedPoints[i + 1];
                    var dx = next.x / this.scale - pt.x;
                    var dy = next.y / this.scale - pt.y;
                    var dist = dx * dx + dy * dy;

                    if (n == null) {
                        n = new mxPoint(pt.x - last.x, pt.y - last.y);
                        len = Math.sqrt(n.x * n.x + n.y * n.y);

                        if (len > 0) {
                            n.x = n.x * size / len;
                            n.y = n.y * size / len;
                        } else {
                            n = null;
                        }
                    }

                    if (dist > size * size && len > 0) {
                        var dx = last.x - pt.x;
                        var dy = last.y - pt.y;
                        var dist = dx * dx + dy * dy;

                        if (dist > size * size) {
                            var p0 = new mxPoint(pt.x - n.x, pt.y - n.y);
                            var p1 = new mxPoint(pt.x + n.x, pt.y + n.y);
                            pts.push(p0);

                            this.addPoints(c, pts, rounded, arcSize, false, null, moveTo);

                            var f = (Math.round(n.x) < 0 || (Math.round(n.x) == 0
                                && Math.round(n.y) <= 0)) ? 1 : -1;
                            moveTo = false;

                            if (style == 'sharp') {
                                c.lineTo(p0.x - n.y * f, p0.y + n.x * f);
                                c.lineTo(p1.x - n.y * f, p1.y + n.x * f);
                                c.lineTo(p1.x, p1.y);
                            } else if (style == 'arc') {
                                f *= 1.3;
                                c.curveTo(p0.x - n.y * f, p0.y + n.x * f,
                                    p1.x - n.y * f, p1.y + n.x * f,
                                    p1.x, p1.y);
                            } else {
                                c.moveTo(p1.x, p1.y);
                                moveTo = true;
                            }

                            pts = [p1];
                            done = true;
                        }
                    }
                } else {
                    n = null;
                }

                if (!done) {
                    pts.push(pt);
                    last = pt;
                }
            }

            this.addPoints(c, pts, rounded, arcSize, false, null, moveTo);
            c.stroke();
        }
    };

    /**
     * Adds support for snapToPoint style.
     */
    var mxGraphViewUpdateFloatingTerminalPoint = mxGraphView.prototype.updateFloatingTerminalPoint;

    mxGraphView.prototype.updateFloatingTerminalPoint = function (edge, start, end, source) {
        if (start != null && edge != null &&
            (start.style['snapToPoint'] == '1' ||
                edge.style['snapToPoint'] == '1')) {
            start = this.getTerminalPort(edge, start, source);
            var next = this.getNextPoint(edge, end, source);

            var orth = this.graph.isOrthogonal(edge);
            var alpha = mxUtils.toRadians(Number(start.style[mxConstants.STYLE_ROTATION] || '0'));
            var center = new mxPoint(start.getCenterX(), start.getCenterY());

            if (alpha != 0) {
                var cos = Math.cos(-alpha);
                var sin = Math.sin(-alpha);
                next = mxUtils.getRotatedPoint(next, cos, sin, center);
            }

            var border = parseFloat(edge.style[mxConstants.STYLE_PERIMETER_SPACING] || 0);
            border += parseFloat(edge.style[(source) ?
                mxConstants.STYLE_SOURCE_PERIMETER_SPACING :
                mxConstants.STYLE_TARGET_PERIMETER_SPACING] || 0);
            var pt = this.getPerimeterPoint(start, next, alpha == 0 && orth, border);

            if (alpha != 0) {
                var cos = Math.cos(alpha);
                var sin = Math.sin(alpha);
                pt = mxUtils.getRotatedPoint(pt, cos, sin, center);
            }

            edge.setAbsoluteTerminalPoint(this.snapToAnchorPoint(edge, start, end, source, pt), source);
        } else {
            mxGraphViewUpdateFloatingTerminalPoint.apply(this, arguments);
        }
    };

    mxGraphView.prototype.snapToAnchorPoint = function (edge, start, end, source, pt) {
        if (start != null && edge != null) {
            var constraints = this.graph.getAllConnectionConstraints(start)
            var nearest = null;
            var dist = null;

            if (constraints != null) {
                for (var i = 0; i < constraints.length; i++) {
                    var cp = this.graph.getConnectionPoint(start, constraints[i]);

                    if (cp != null) {
                        var tmp = (cp.x - pt.x) * (cp.x - pt.x) + (cp.y - pt.y) * (cp.y - pt.y);

                        if (dist == null || tmp < dist) {
                            nearest = cp;
                            dist = tmp;
                        }
                    }
                }
            }

            if (nearest != null) {
                pt = nearest;
            }
        }

        return pt;
    };

    /**
     * Adds support for placeholders in text elements of shapes.
     */
    var mxStencilEvaluateTextAttribute = mxStencil.prototype.evaluateTextAttribute;

    mxStencil.prototype.evaluateTextAttribute = function (node, attribute, shape) {
        var result = mxStencilEvaluateTextAttribute.apply(this, arguments);
        var placeholders = node.getAttribute('placeholders');

        if (placeholders == '1' && shape.state != null) {
            result = shape.state.view.graph.replacePlaceholders(shape.state.cell, result);
        }

        return result;
    };

    /**
     * Adds custom stencils defined via shape=stencil(value) style. The value is a base64 encoded, compressed and
     * URL encoded XML definition of the shape according to the stencil definition language of mxGraph.
     *
     * Needs to be in this file to make sure its part of the embed client code. Also the check for ZLib is
     * different than for the Editor code.
     */
    var mxCellRendererCreateShape = mxCellRenderer.prototype.createShape;
    mxCellRenderer.prototype.createShape = function (state) {
        if (state.style != null && typeof (pako) !== 'undefined') {
            var shape = mxUtils.getValue(state.style, mxConstants.STYLE_SHAPE, null);

            // Extracts and decodes stencil XML if shape has the form shape=stencil(value)
            if (shape != null && typeof shape === 'string' && shape.substring(0, 8) == 'stencil(') {
                try {
                    var stencil = shape.substring(8, shape.length - 1);
                    var doc = mxUtils.parseXml(Graph.decompress(stencil));

                    return new mxShape(new mxStencil(doc.documentElement));
                } catch (e) {
                    if (window.console != null) {
                        console.log('Error in shape: ' + e);
                    }
                }
            }
        }

        return mxCellRendererCreateShape.apply(this, arguments);
    };
})();

/**
 * Overrides stencil registry for dynamic loading of stencils.
 */
/**
 * Maps from library names to an array of Javascript filenames,
 * which are synchronously loaded. Currently only stencil files
 * (.xml) and JS files (.js) are supported.
 * IMPORTANT: For embedded diagrams to work entries must also
 * be added in EmbedServlet.java.
 */
mxStencilRegistry.libraries = {};

/**
 * Global switch to disable dynamic loading.
 */
mxStencilRegistry.dynamicLoading = true;

/**
 * Global switch to disable eval for JS (preload all JS instead).
 */
mxStencilRegistry.allowEval = true;

/**
 * Stores all package names that have been dynamically loaded.
 * Each package is only loaded once.
 */
mxStencilRegistry.packages = [];

// Extends the default stencil registry to add dynamic loading
mxStencilRegistry.getStencil = function (name) {
    var result = mxStencilRegistry.stencils[name];

    if (result == null && mxCellRenderer.defaultShapes[name] == null && mxStencilRegistry.dynamicLoading) {
        var basename = mxStencilRegistry.getBasenameForStencil(name);

        // Loads stencil files and tries again
        if (basename != null) {
            var libs = mxStencilRegistry.libraries[basename];

            if (libs != null) {
                if (mxStencilRegistry.packages[basename] == null) {
                    for (var i = 0; i < libs.length; i++) {
                        var fname = libs[i];

                        if (fname.toLowerCase().substring(fname.length - 4, fname.length) == '.xml') {
                            mxStencilRegistry.loadStencilSet(fname, null);
                        } else if (fname.toLowerCase().substring(fname.length - 3, fname.length) == '.js') {
                            try {
                                if (mxStencilRegistry.allowEval) {
                                    var req = mxUtils.load(fname);

                                    if (req != null && req.getStatus() >= 200 && req.getStatus() <= 299) {
                                        eval.call(window, req.getText());
                                    }
                                }
                            } catch (e) {
                                if (window.console != null) {
                                    console.log('error in getStencil:', fname, e);
                                }
                            }
                        } else {
                            // FIXME: This does not yet work as the loading is triggered after
                            // the shape was used in the graph, at which point the keys have
                            // typically been translated in the calling method.
                            //mxResources.add(fname);
                        }
                    }

                    mxStencilRegistry.packages[basename] = 1;
                }
            } else {
                // Replaces '_-_' with '_'
                basename = basename.replace('_-_', '_');
                mxStencilRegistry.loadStencilSet(STENCIL_PATH + '/' + basename + '.xml', null);
            }

            result = mxStencilRegistry.stencils[name];
        }
    }

    return result;
};

// Returns the basename for the given stencil or null if no file must be
// loaded to render the given stencil.
mxStencilRegistry.getBasenameForStencil = function (name) {
    var tmp = null;

    if (name != null && typeof name === 'string') {
        var parts = name.split('.');

        if (parts.length > 0 && parts[0] == 'mxgraph') {
            tmp = parts[1];

            for (var i = 2; i < parts.length - 1; i++) {
                tmp += '/' + parts[i];
            }
        }
    }

    return tmp;
};

// Loads the given stencil set
mxStencilRegistry.loadStencilSet = function (stencilFile, postStencilLoad, force, async) {
    force = (force != null) ? force : false;

    // Uses additional cache for detecting previous load attempts
    var xmlDoc = mxStencilRegistry.packages[stencilFile];

    if (force || xmlDoc == null) {
        var install = false;

        if (xmlDoc == null) {
            try {
                if (async) {
                    mxStencilRegistry.loadStencil(stencilFile, mxUtils.bind(this, function (xmlDoc2) {
                        if (xmlDoc2 != null && xmlDoc2.documentElement != null) {
                            mxStencilRegistry.packages[stencilFile] = xmlDoc2;
                            install = true;
                            mxStencilRegistry.parseStencilSet(xmlDoc2.documentElement, postStencilLoad, install);
                        }
                    }));

                    return;
                } else {
                    xmlDoc = mxStencilRegistry.loadStencil(stencilFile);
                    mxStencilRegistry.packages[stencilFile] = xmlDoc;
                    install = true;
                }
            } catch (e) {
                if (window.console != null) {
                    console.log('error in loadStencilSet:', stencilFile, e);
                }
            }
        }

        if (xmlDoc != null && xmlDoc.documentElement != null) {
            mxStencilRegistry.parseStencilSet(xmlDoc.documentElement, postStencilLoad, install);
        }
    }
};

// Loads the given stencil XML file.
mxStencilRegistry.loadStencil = function (filename, fn) {
    if (fn != null) {
        var req = mxUtils.get(filename, mxUtils.bind(this, function (req) {
            fn((req.getStatus() >= 200 && req.getStatus() <= 299) ? req.getXml() : null);
        }));
    } else {
        return mxUtils.load(filename).getXml();
    }
};

// Takes array of strings
mxStencilRegistry.parseStencilSets = function (stencils) {
    for (var i = 0; i < stencils.length; i++) {
        mxStencilRegistry.parseStencilSet(mxUtils.parseXml(stencils[i]).documentElement);
    }
};

// Parses the given stencil set
mxStencilRegistry.parseStencilSet = function (root, postStencilLoad, install) {
    if (root.nodeName == 'stencils') {
        var shapes = root.firstChild;

        while (shapes != null) {
            if (shapes.nodeName == 'shapes') {
                mxStencilRegistry.parseStencilSet(shapes, postStencilLoad, install);
            }

            shapes = shapes.nextSibling;
        }
    } else {
        install = (install != null) ? install : true;
        var shape = root.firstChild;
        var packageName = '';
        var name = root.getAttribute('name');

        if (name != null) {
            packageName = name + '.';
        }

        while (shape != null) {
            if (shape.nodeType == mxConstants.NODETYPE_ELEMENT) {
                name = shape.getAttribute('name');

                if (name != null) {
                    packageName = packageName.toLowerCase();
                    var stencilName = name.replace(/ /g, "_");

                    if (install) {
                        mxStencilRegistry.addStencil(packageName + stencilName.toLowerCase(), new mxStencil(shape));
                    }

                    if (postStencilLoad != null) {
                        var w = shape.getAttribute('w');
                        var h = shape.getAttribute('h');

                        w = (w == null) ? 80 : parseInt(w, 10);
                        h = (h == null) ? 80 : parseInt(h, 10);

                        postStencilLoad(packageName, stencilName, name, w, h);
                    }
                }
            }

            shape = shape.nextSibling;
        }
    }
};

/**
 * These overrides are only added if mxVertexHandler is defined (ie. not in embedded graph)
 */
if (typeof mxVertexHandler != 'undefined') {
    (function () {
        // Sets colors for handles
        mxConstants.HANDLE_FILLCOLOR = '#29b6f2';
        mxConstants.HANDLE_STROKECOLOR = '#0088cf';
        mxConstants.VERTEX_SELECTION_COLOR = '#00a8ff';
        mxConstants.OUTLINE_COLOR = '#00a8ff';
        mxConstants.OUTLINE_HANDLE_FILLCOLOR = '#99ccff';
        mxConstants.OUTLINE_HANDLE_STROKECOLOR = '#00a8ff';
        mxConstants.CONNECT_HANDLE_FILLCOLOR = '#cee7ff';
        mxConstants.EDGE_SELECTION_COLOR = '#00a8ff';
        mxConstants.DEFAULT_VALID_COLOR = '#00a8ff';
        mxConstants.LABEL_HANDLE_FILLCOLOR = '#cee7ff';
        mxConstants.GUIDE_COLOR = '#0088cf';
        mxConstants.HIGHLIGHT_OPACITY = 30;
        mxConstants.HIGHLIGHT_SIZE = 5;

        // Enables snapping to off-grid terminals for edge waypoints
        mxEdgeHandler.prototype.snapToTerminals = true;

        // Enables guides
        mxGraphHandler.prototype.guidesEnabled = true;

        // Removes parents where all child cells are moved out
        mxGraphHandler.prototype.removeEmptyParents = true;

        // Enables fading of rubberband
        mxRubberband.prototype.fadeOut = true;

        // Alt-move disables guides
        mxGuide.prototype.isEnabledForEvent = function (evt) {
            return !mxEvent.isAltDown(evt);
        };

        // Extends connection handler to enable ctrl+drag for cloning source cell
        // since copyOnConnect is now disabled by default
        var mxConnectionHandlerCreateTarget = mxConnectionHandler.prototype.isCreateTarget;
        mxConnectionHandler.prototype.isCreateTarget = function (evt) {
            return mxEvent.isControlDown(evt) || mxConnectionHandlerCreateTarget.apply(this, arguments);
        };

        // Overrides highlight shape for connection points
        mxConstraintHandler.prototype.createHighlightShape = function () {
            var hl = new mxEllipse(null, this.highlightColor, this.highlightColor, 0);
            hl.opacity = mxConstants.HIGHLIGHT_OPACITY;

            return hl;
        };

        // Overrides edge preview to use current edge shape and default style
        mxConnectionHandler.prototype.livePreview = true;
        mxConnectionHandler.prototype.cursor = 'crosshair';

        // Uses current edge style for connect preview
        mxConnectionHandler.prototype.createEdgeState = function (me) {
            var style = this.graph.createCurrentEdgeStyle();
            var edge = this.graph.createEdge(null, null, null, null, null, style);
            var state = new mxCellState(this.graph.view, edge, this.graph.getCellStyle(edge));

            for (var key in this.graph.currentEdgeStyle) {
                state.style[key] = this.graph.currentEdgeStyle[key];
            }

            return state;
        };

        // Overrides dashed state with current edge style
        var connectionHandlerCreateShape = mxConnectionHandler.prototype.createShape;
        mxConnectionHandler.prototype.createShape = function () {
            var shape = connectionHandlerCreateShape.apply(this, arguments);

            shape.isDashed = this.graph.currentEdgeStyle[mxConstants.STYLE_DASHED] == '1';

            return shape;
        }

        // Overrides live preview to keep current style
        mxConnectionHandler.prototype.updatePreview = function (valid) {
            // do not change color of preview
        };

        // Overrides connection handler to ignore edges instead of not allowing connections
        var mxConnectionHandlerCreateMarker = mxConnectionHandler.prototype.createMarker;
        mxConnectionHandler.prototype.createMarker = function () {
            var marker = mxConnectionHandlerCreateMarker.apply(this, arguments);

            var markerGetCell = marker.getCell;
            marker.getCell = mxUtils.bind(this, function (me) {
                var result = markerGetCell.apply(this, arguments);

                this.error = null;

                return result;
            });

            return marker;
        };

        /**
         * Function: isCellLocked
         *
         * Returns true if the given cell does not allow new connections to be created.
         * This implementation returns false.
         */
        mxConnectionHandler.prototype.isCellEnabled = function (cell) {
            return !this.graph.isCellLocked(cell);
        };

        /**
         *
         */
        Graph.prototype.defaultVertexStyle = {};

        /**
         * Contains the default style for edges.
         */
        Graph.prototype.defaultEdgeStyle = {
            'edgeStyle': 'orthogonalEdgeStyle', 'rounded': '0',
            'jettySize': 'auto', 'orthogonalLoop': '1'
        };

        /**
         * Returns the current edge style as a string.
         */
        Graph.prototype.createCurrentEdgeStyle = function () {
            var style = 'edgeStyle=' + (this.currentEdgeStyle['edgeStyle'] || 'none') + ';';

            if (this.currentEdgeStyle['shape'] != null) {
                style += 'shape=' + this.currentEdgeStyle['shape'] + ';';
            }

            if (this.currentEdgeStyle['curved'] != null) {
                style += 'curved=' + this.currentEdgeStyle['curved'] + ';';
            }

            if (this.currentEdgeStyle['rounded'] != null) {
                style += 'rounded=' + this.currentEdgeStyle['rounded'] + ';';
            }

            if (this.currentEdgeStyle['comic'] != null) {
                style += 'comic=' + this.currentEdgeStyle['comic'] + ';';
            }

            if (this.currentEdgeStyle['jumpStyle'] != null) {
                style += 'jumpStyle=' + this.currentEdgeStyle['jumpStyle'] + ';';
            }

            if (this.currentEdgeStyle['jumpSize'] != null) {
                style += 'jumpSize=' + this.currentEdgeStyle['jumpSize'] + ';';
            }

            // Overrides the global default to match the default edge style
            if (this.currentEdgeStyle['orthogonalLoop'] != null) {
                style += 'orthogonalLoop=' + this.currentEdgeStyle['orthogonalLoop'] + ';';
            } else if (Graph.prototype.defaultEdgeStyle['orthogonalLoop'] != null) {
                style += 'orthogonalLoop=' + Graph.prototype.defaultEdgeStyle['orthogonalLoop'] + ';';
            }

            // Overrides the global default to match the default edge style
            if (this.currentEdgeStyle['jettySize'] != null) {
                style += 'jettySize=' + this.currentEdgeStyle['jettySize'] + ';';
            } else if (Graph.prototype.defaultEdgeStyle['jettySize'] != null) {
                style += 'jettySize=' + Graph.prototype.defaultEdgeStyle['jettySize'] + ';';
            }

            // Special logic for custom property of elbowEdgeStyle
            if (this.currentEdgeStyle['edgeStyle'] == 'elbowEdgeStyle' && this.currentEdgeStyle['elbow'] != null) {
                style += 'elbow=' + this.currentEdgeStyle['elbow'] + ';';
            }

            if (this.currentEdgeStyle['html'] != null) {
                style += 'html=' + this.currentEdgeStyle['html'] + ';';
            } else {
                style += 'html=1;';
            }

            return style;
        };

        /**
         * Hook for subclassers.
         */
        Graph.prototype.getPagePadding = function () {
            return new mxPoint(0, 0);
        };

        /**
         * Loads the stylesheet for this graph.
         */
        Graph.prototype.loadStylesheet = function () {
            var node = (this.themes != null) ? this.themes[this.defaultThemeName] :
                (!mxStyleRegistry.dynamicLoading) ? null :
                    mxUtils.load(STYLE_PATH + '/default.xml').getDocumentElement();

            if (node != null) {
                var dec = new mxCodec(node.ownerDocument);
                dec.decode(node, this.getStylesheet());
            }
        };

        /**
         * Creates lookup from object IDs to cell IDs.
         */
        Graph.prototype.createCellLookup = function (cells, lookup) {
            lookup = (lookup != null) ? lookup : new Object();

            for (var i = 0; i < cells.length; i++) {
                var cell = cells[i];
                lookup[mxObjectIdentity.get(cell)] = cell.getId();
                var childCount = this.model.getChildCount(cell);

                for (var j = 0; j < childCount; j++) {
                    this.createCellLookup([this.model.getChildAt(cell, j)], lookup);
                }
            }

            return lookup;
        };

        /**
         * Creates lookup from original to cloned cell IDs where mapping is
         * the mapping used in cloneCells and lookup is a mapping from
         * object IDs to cell IDs.
         */
        Graph.prototype.createCellMapping = function (mapping, lookup, cellMapping) {
            cellMapping = (cellMapping != null) ? cellMapping : new Object();

            for (var objectId in mapping) {
                var cellId = lookup[objectId];

                if (cellMapping[cellId] == null) {
                    // Uses empty string if clone ID was null which means
                    // the cell was cloned but not inserted into the model.
                    cellMapping[cellId] = mapping[objectId].getId() || '';
                }
            }

            return cellMapping;
        };

        /**
         *
         */
        Graph.prototype.importGraphModel = function (node, dx, dy, crop) {
            dx = (dx != null) ? dx : 0;
            dy = (dy != null) ? dy : 0;

            var codec = new mxCodec(node.ownerDocument);
            var tempModel = new mxGraphModel();
            codec.decode(node, tempModel);
            var cells = []

            // Clones cells to remove invalid edges
            var cloneMap = new Object();
            var cellMapping = new Object();
            var layers = tempModel.getChildren(this.cloneCell(tempModel.root,
                this.isCloneInvalidEdges(), cloneMap));

            if (layers != null) {
                // Creates lookup from object IDs to cell IDs
                var lookup = this.createCellLookup([tempModel.root]);

                // Uses copy as layers are removed from array inside loop
                layers = layers.slice();

                this.model.beginUpdate();
                try {
                    // Merges into unlocked current layer if one layer is pasted
                    if (layers.length == 1 && !this.isCellLocked(this.getDefaultParent())) {
                        cells = this.moveCells(tempModel.getChildren(layers[0]),
                            dx, dy, false, this.getDefaultParent());

                        // Imported default default parent maps to local default parent
                        cellMapping[tempModel.getChildAt(tempModel.root, 0).getId()] =
                            this.getDefaultParent().getId();
                    } else {
                        for (var i = 0; i < layers.length; i++) {
                            cells = cells.concat(this.model.getChildren(this.moveCells(
                                [layers[i]], dx, dy, false, this.model.getRoot())[0]));
                        }
                    }

                    // Adds mapping for all cloned entries from imported to local cell ID
                    this.createCellMapping(cloneMap, lookup, cellMapping);
                    this.updateCustomLinks(cellMapping, cells);

                    if (crop) {
                        if (this.isGridEnabled()) {
                            dx = this.snap(dx);
                            dy = this.snap(dy);
                        }

                        var bounds = this.getBoundingBoxFromGeometry(cells, true);

                        if (bounds != null) {
                            this.moveCells(cells, dx - bounds.x, dy - bounds.y);
                        }
                    }
                } finally {
                    this.model.endUpdate();
                }
            }

            return cells;
        };

        /**
         * Translates this point by the given vector.
         *
         * @param {number} dx X-coordinate of the translation.
         * @param {number} dy Y-coordinate of the translation.
         */
        Graph.prototype.encodeCells = function (cells) {
            var cloneMap = new Object();
            var clones = this.cloneCells(cells, null, cloneMap);

            // Creates a dictionary for fast lookups
            var dict = new mxDictionary();

            for (var i = 0; i < cells.length; i++) {
                dict.put(cells[i], true);
            }

            // Checks for orphaned relative children and makes absolute
            for (var i = 0; i < clones.length; i++) {
                var state = this.view.getState(cells[i]);

                if (state != null) {
                    var geo = this.getCellGeometry(clones[i]);

                    if (geo != null && geo.relative && !this.model.isEdge(cells[i]) &&
                        !dict.get(this.model.getParent(cells[i]))) {
                        geo.relative = false;
                        geo.x = state.x / state.view.scale - state.view.translate.x;
                        geo.y = state.y / state.view.scale - state.view.translate.y;
                    }
                }
            }

            var codec = new mxCodec();
            var model = new mxGraphModel();
            var parent = model.getChildAt(model.getRoot(), 0);

            for (var i = 0; i < clones.length; i++) {
                model.add(parent, clones[i]);
            }

            this.updateCustomLinks(this.createCellMapping(cloneMap,
                this.createCellLookup(cells)), clones);

            return codec.encode(model);
        };

        /**
         * Overrides cloning cells in moveCells.
         */
        var graphMoveCells = Graph.prototype.moveCells;

        Graph.prototype.moveCells = function (cells, dx, dy, clone, target, evt, mapping) {
            mapping = (mapping != null) ? mapping : new Object();
            var result = graphMoveCells.apply(this, arguments);

            if (clone) {
                this.updateCustomLinks(this.createCellMapping(mapping,
                    this.createCellLookup(cells)), result);
            }

            return result;
        };

        /**
         * Updates cells IDs for custom links in the given cells.
         */
        Graph.prototype.updateCustomLinks = function (mapping, cells) {
            for (var i = 0; i < cells.length; i++) {
                if (cells[i] != null) {
                    this.updateCustomLinksForCell(mapping, cells[i]);
                }
            }
        };

        /**
         * Updates cell IDs in custom links on the given cell and its label.
         */
        Graph.prototype.updateCustomLinksForCell = function (mapping, cell) {
            // Hook for subclassers
        };

        /**
         * Overrides method to provide connection constraints for shapes.
         */
        Graph.prototype.getAllConnectionConstraints = function (terminal, source) {
            if (terminal != null) {
                var constraints = mxUtils.getValue(terminal.style, 'points', null);

                if (constraints != null) {
                    // Requires an array of arrays with x, y (0..1), an optional
                    // [perimeter (0 or 1), dx, and dy] eg. points=[[0,0,1,-10,10],[0,1,0],[1,1]]
                    var result = [];

                    try {
                        var c = JSON.parse(constraints);

                        for (var i = 0; i < c.length; i++) {
                            var tmp = c[i];
                            result.push(new mxConnectionConstraint(new mxPoint(tmp[0], tmp[1]), (tmp.length > 2) ? tmp[2] != '0' : true,
                                null, (tmp.length > 3) ? tmp[3] : 0, (tmp.length > 4) ? tmp[4] : 0));
                        }
                    } catch (e) {
                        // ignore
                    }

                    return result;
                } else if (terminal.shape != null && terminal.shape.bounds != null) {
                    var dir = terminal.shape.direction;
                    var bounds = terminal.shape.bounds;
                    var scale = terminal.shape.scale;
                    var w = bounds.width / scale;
                    var h = bounds.height / scale;

                    if (dir == mxConstants.DIRECTION_NORTH || dir == mxConstants.DIRECTION_SOUTH) {
                        var tmp = w;
                        w = h;
                        h = tmp;
                    }

                    constraints = terminal.shape.getConstraints(terminal.style, w, h);

                    if (constraints != null) {
                        return constraints;
                    } else if (terminal.shape.stencil != null && terminal.shape.stencil.constraints != null) {
                        return terminal.shape.stencil.constraints;
                    } else if (terminal.shape.constraints != null) {
                        return terminal.shape.constraints;
                    }
                }
            }

            return null;
        };

        /**
         * Inverts the elbow edge style without removing existing styles.
         */
        Graph.prototype.flipEdge = function (edge) {
            if (edge != null) {
                var state = this.view.getState(edge);
                var style = (state != null) ? state.style : this.getCellStyle(edge);

                if (style != null) {
                    var elbow = mxUtils.getValue(style, mxConstants.STYLE_ELBOW,
                        mxConstants.ELBOW_HORIZONTAL);
                    var value = (elbow == mxConstants.ELBOW_HORIZONTAL) ?
                        mxConstants.ELBOW_VERTICAL : mxConstants.ELBOW_HORIZONTAL;
                    this.setCellStyles(mxConstants.STYLE_ELBOW, value, [edge]);
                }
            }
        };

        /**
         * Disables drill-down for non-swimlanes.
         */
        Graph.prototype.isValidRoot = function (cell) {
            // Counts non-relative children
            var childCount = this.model.getChildCount(cell);
            var realChildCount = 0;

            for (var i = 0; i < childCount; i++) {
                var child = this.model.getChildAt(cell, i);

                if (this.model.isVertex(child)) {
                    var geometry = this.getCellGeometry(child);

                    if (geometry != null && !geometry.relative) {
                        realChildCount++;
                    }
                }
            }

            return realChildCount > 0 || this.isContainer(cell);
        };

        /**
         * Disables drill-down for non-swimlanes.
         */
        Graph.prototype.isValidDropTarget = function (cell) {
            var state = this.view.getState(cell);
            var style = (state != null) ? state.style : this.getCellStyle(cell);

            return mxUtils.getValue(style, 'part', '0') != '1' && (this.isContainer(cell) ||
                (mxGraph.prototype.isValidDropTarget.apply(this, arguments) &&
                    mxUtils.getValue(style, 'dropTarget', '1') != '0'));
        };

        /**
         * Overrides createGroupCell to set the group style for new groups to 'group'.
         */
        Graph.prototype.createGroupCell = function () {
            var group = mxGraph.prototype.createGroupCell.apply(this, arguments);
            group.setStyle('group');

            return group;
        };

        /**
         * Disables extending parents with stack layouts on add
         */
        Graph.prototype.isExtendParentsOnAdd = function (cell) {
            var result = mxGraph.prototype.isExtendParentsOnAdd.apply(this, arguments);

            if (result && cell != null && this.layoutManager != null) {
                var parent = this.model.getParent(cell);

                if (parent != null) {
                    var layout = this.layoutManager.getLayout(parent);

                    if (layout != null && layout.constructor == mxStackLayout) {
                        result = false;
                    }
                }
            }

            return result;
        };

        /**
         * Overrides autosize to add a border.
         */
        Graph.prototype.getPreferredSizeForCell = function (cell) {
            var result = mxGraph.prototype.getPreferredSizeForCell.apply(this, arguments);

            // Adds buffer
            if (result != null) {
                result.width += 10;
                result.height += 4;

                if (this.gridEnabled) {
                    result.width = this.snap(result.width);
                    result.height = this.snap(result.height);
                }
            }

            return result;
        }

        /**
         * Turns the given cells and returns the changed cells.
         */
        Graph.prototype.turnShapes = function (cells) {
            var model = this.getModel();
            var select = [];

            model.beginUpdate();
            try {
                for (var i = 0; i < cells.length; i++) {
                    var cell = cells[i];

                    if (model.isEdge(cell)) {
                        var src = model.getTerminal(cell, true);
                        var trg = model.getTerminal(cell, false);

                        model.setTerminal(cell, trg, true);
                        model.setTerminal(cell, src, false);

                        var geo = model.getGeometry(cell);

                        if (geo != null) {
                            geo = geo.clone();

                            if (geo.points != null) {
                                geo.points.reverse();
                            }

                            var sp = geo.getTerminalPoint(true);
                            var tp = geo.getTerminalPoint(false)

                            geo.setTerminalPoint(sp, false);
                            geo.setTerminalPoint(tp, true);
                            model.setGeometry(cell, geo);

                            // Inverts constraints
                            var edgeState = this.view.getState(cell);
                            var sourceState = this.view.getState(src);
                            var targetState = this.view.getState(trg);

                            if (edgeState != null) {
                                var sc = (sourceState != null) ? this.getConnectionConstraint(edgeState, sourceState, true) : null;
                                var tc = (targetState != null) ? this.getConnectionConstraint(edgeState, targetState, false) : null;

                                this.setConnectionConstraint(cell, src, true, tc);
                                this.setConnectionConstraint(cell, trg, false, sc);
                            }

                            select.push(cell);
                        }
                    } else if (model.isVertex(cell)) {
                        var geo = this.getCellGeometry(cell);

                        if (geo != null) {
                            // Rotates the size and position in the geometry
                            geo = geo.clone();
                            geo.x += geo.width / 2 - geo.height / 2;
                            geo.y += geo.height / 2 - geo.width / 2;
                            var tmp = geo.width;
                            geo.width = geo.height;
                            geo.height = tmp;
                            model.setGeometry(cell, geo);

                            // Reads the current direction and advances by 90 degrees
                            var state = this.view.getState(cell);

                            if (state != null) {
                                var dir = state.style[mxConstants.STYLE_DIRECTION] || 'east'/*default*/;

                                if (dir == 'east') {
                                    dir = 'south';
                                } else if (dir == 'south') {
                                    dir = 'west';
                                } else if (dir == 'west') {
                                    dir = 'north';
                                } else if (dir == 'north') {
                                    dir = 'east';
                                }

                                this.setCellStyles(mxConstants.STYLE_DIRECTION, dir, [cell]);
                            }

                            select.push(cell);
                        }
                    }
                }
            } finally {
                model.endUpdate();
            }

            return select;
        };

        /**
         * Returns true if the given stencil contains any placeholder text.
         */
        Graph.prototype.stencilHasPlaceholders = function (stencil) {
            if (stencil != null && stencil.fgNode != null) {
                var node = stencil.fgNode.firstChild;

                while (node != null) {
                    if (node.nodeName == 'text' && node.getAttribute('placeholders') == '1') {
                        return true;
                    }

                    node = node.nextSibling;
                }
            }

            return false;
        };

        /**
         * Updates the child cells with placeholders if metadata of a cell has changed.
         */
        Graph.prototype.processChange = function (change) {
            mxGraph.prototype.processChange.apply(this, arguments);

            if (change instanceof mxValueChange && change.cell != null &&
                change.cell.value != null && typeof (change.cell.value) == 'object') {
                // Invalidates all descendants with placeholders
                var desc = this.model.getDescendants(change.cell);

                // LATER: Check if only label or tooltip have changed
                if (desc.length > 0) {
                    for (var i = 0; i < desc.length; i++) {
                        var state = this.view.getState(desc[i]);

                        if (state != null && state.shape != null && state.shape.stencil != null &&
                            this.stencilHasPlaceholders(state.shape.stencil)) {
                            this.removeStateForCell(desc[i]);
                        } else if (this.isReplacePlaceholders(desc[i])) {
                            this.view.invalidate(desc[i], false, false);
                        }
                    }
                }
            }
        };

        /**
         * Replaces the given element with a span.
         */
        Graph.prototype.replaceElement = function (elt, tagName) {
            var span = elt.ownerDocument.createElement((tagName != null) ? tagName : 'span');
            var attributes = Array.prototype.slice.call(elt.attributes);

            while (attr = attributes.pop()) {
                span.setAttribute(attr.nodeName, attr.nodeValue);
            }

            span.innerHTML = elt.innerHTML;
            elt.parentNode.replaceChild(span, elt);
        };

        /**
         *
         */
        Graph.prototype.processElements = function (elt, fn) {
            var elts = elt.getElementsByTagName('*');

            for (var i = 0; i < elts.length; i++) {
                fn(elts[i]);
            }
        };

        /**
         * Handles label changes for XML user objects.
         */
        Graph.prototype.updateLabelElements = function (cells, fn, tagName) {
            cells = (cells != null) ? cells : this.getSelectionCells();
            var div = document.createElement('div');

            for (var i = 0; i < cells.length; i++) {
                // Changes font tags inside HTML labels
                if (this.isHtmlLabel(cells[i])) {
                    var label = this.convertValueToString(cells[i]);

                    if (label != null && label.length > 0) {
                        div.innerHTML = label;
                        var elts = div.getElementsByTagName((tagName != null) ? tagName : '*');

                        for (var j = 0; j < elts.length; j++) {
                            fn(elts[j]);
                        }

                        if (div.innerHTML != label) {
                            this.cellLabelChanged(cells[i], div.innerHTML);
                        }
                    }
                }
            }
        };

        /**
         * Handles label changes for XML user objects.
         */
        Graph.prototype.cellLabelChanged = function (cell, value, autoSize) {
            // Removes all illegal control characters in user input
            value = Graph.zapGremlins(value);

            this.model.beginUpdate();
            try {
                if (cell.value != null && typeof cell.value == 'object') {
                    if (this.isReplacePlaceholders(cell) &&
                        cell.getAttribute('placeholder') != null) {
                        // LATER: Handle delete, name change
                        var name = cell.getAttribute('placeholder');
                        var current = cell;

                        while (current != null) {
                            if (current == this.model.getRoot() || (current.value != null &&
                                typeof (current.value) == 'object' && current.hasAttribute(name))) {
                                this.setAttributeForCell(current, name, value);

                                break;
                            }

                            current = this.model.getParent(current);
                        }
                    }

                    var tmp = cell.value.cloneNode(true);
                    tmp.setAttribute('label', value);
                    value = tmp;
                }

                mxGraph.prototype.cellLabelChanged.apply(this, arguments);
            } finally {
                this.model.endUpdate();
            }
        };

        /**
         * Removes transparent empty groups if all children are removed.
         */
        Graph.prototype.cellsRemoved = function (cells) {
            if (cells != null) {
                var dict = new mxDictionary();

                for (var i = 0; i < cells.length; i++) {
                    dict.put(cells[i], true);
                }

                // LATER: Recurse up the cell hierarchy
                var parents = [];

                for (var i = 0; i < cells.length; i++) {
                    var parent = this.model.getParent(cells[i]);

                    if (parent != null && !dict.get(parent)) {
                        dict.put(parent, true);
                        parents.push(parent);
                    }
                }

                for (var i = 0; i < parents.length; i++) {
                    var state = this.view.getState(parents[i]);

                    if (state != null && (this.model.isEdge(state.cell) || this.model.isVertex(state.cell)) && this.isCellDeletable(state.cell)) {
                        var stroke = mxUtils.getValue(state.style, mxConstants.STYLE_STROKECOLOR, mxConstants.NONE);
                        var fill = mxUtils.getValue(state.style, mxConstants.STYLE_FILLCOLOR, mxConstants.NONE);

                        if (stroke == mxConstants.NONE && fill == mxConstants.NONE) {
                            var allChildren = true;

                            for (var j = 0; j < this.model.getChildCount(state.cell) && allChildren; j++) {
                                if (!dict.get(this.model.getChildAt(state.cell, j))) {
                                    allChildren = false;
                                }
                            }

                            if (allChildren) {
                                cells.push(state.cell);
                            }
                        }
                    }
                }
            }

            mxGraph.prototype.cellsRemoved.apply(this, arguments);
        };

        /**
         * Overrides ungroup to check if group should be removed.
         */
        Graph.prototype.removeCellsAfterUngroup = function (cells) {
            var cellsToRemove = [];

            for (var i = 0; i < cells.length; i++) {
                if (this.isCellDeletable(cells[i])) {
                    var state = this.view.getState(cells[i]);

                    if (state != null) {
                        var stroke = mxUtils.getValue(state.style, mxConstants.STYLE_STROKECOLOR, mxConstants.NONE);
                        var fill = mxUtils.getValue(state.style, mxConstants.STYLE_FILLCOLOR, mxConstants.NONE);

                        if (stroke == mxConstants.NONE && fill == mxConstants.NONE) {
                            cellsToRemove.push(cells[i]);
                        }
                    }
                }
            }

            cells = cellsToRemove;

            mxGraph.prototype.removeCellsAfterUngroup.apply(this, arguments);
        };

        /**
         * Sets the link for the given cell.
         */
        Graph.prototype.setLinkForCell = function (cell, link) {
            this.setAttributeForCell(cell, 'link', link);
        };

        /**
         * Sets the link for the given cell.
         */
        Graph.prototype.setTooltipForCell = function (cell, link) {
            this.setAttributeForCell(cell, 'tooltip', link);
        };

        /**
         * Returns the cells in the model (or given array) that have all of the
         * given tags in their tags property.
         */
        Graph.prototype.getAttributeForCell = function (cell, attributeName, defaultValue) {
            return (cell.value != null && typeof cell.value === 'object') ?
                (cell.value.getAttribute(attributeName) || defaultValue) :
                defaultValue;
        };

        /**
         * Sets the link for the given cell.
         */
        Graph.prototype.setAttributeForCell = function (cell, attributeName, attributeValue) {
            var value = null;

            if (cell.value != null && typeof (cell.value) == 'object') {
                value = cell.value.cloneNode(true);
            } else {
                var doc = mxUtils.createXmlDocument();

                value = doc.createElement('UserObject');
                value.setAttribute('label', cell.value || '');
            }

            if (attributeValue != null) {
                value.setAttribute(attributeName, attributeValue);
            } else {
                value.removeAttribute(attributeName);
            }

            this.model.setValue(cell, value);
        };

        /**
         * Overridden to stop moving edge labels between cells.
         */
        Graph.prototype.getDropTarget = function (cells, evt, cell, clone) {
            var model = this.getModel();

            // Disables drop into group if alt is pressed
            if (mxEvent.isAltDown(evt)) {
                return null;
            }

            // Disables dragging edge labels out of edges
            for (var i = 0; i < cells.length; i++) {
                if (this.model.isEdge(this.model.getParent(cells[i]))) {
                    return null;
                }
            }

            return mxGraph.prototype.getDropTarget.apply(this, arguments);
        };

        /**
         * Overrides double click handling to avoid accidental inserts of new labels in dblClick below.
         */
        Graph.prototype.click = function (me) {
            mxGraph.prototype.click.call(this, me);

            // Stores state and source for checking in dblClick
            this.firstClickState = me.getState();
            this.firstClickSource = me.getSource();
        };

        /**
         * Overrides double click handling to add the tolerance and inserting text.
         */
        Graph.prototype.dblClick = function (evt, cell) {
            if (this.isEnabled()) {
                var pt = mxUtils.convertPoint(this.container, mxEvent.getClientX(evt), mxEvent.getClientY(evt));

                // Automatically adds new child cells to edges on double click
                if (evt != null && !this.model.isVertex(cell)) {
                    var state = (this.model.isEdge(cell)) ? this.view.getState(cell) : null;
                    var src = mxEvent.getSource(evt);

                    if ((this.firstClickState == state && this.firstClickSource == src) &&
                        (state == null || (state.text == null || state.text.node == null ||
                            state.text.boundingBox == null || (!mxUtils.contains(state.text.boundingBox,
                                pt.x, pt.y) && !mxUtils.isAncestorNode(state.text.node, mxEvent.getSource(evt))))) &&
                        ((state == null && !this.isCellLocked(this.getDefaultParent())) ||
                            (state != null && !this.isCellLocked(state.cell))) &&
                        (state != null || (mxClient.IS_VML && src == this.view.getCanvas()) ||
                            (mxClient.IS_SVG && src == this.view.getCanvas().ownerSVGElement))) {
                        cell = this.addText(pt.x, pt.y, state);
                    }
                }

                mxGraph.prototype.dblClick.call(this, evt, cell);
            }
        };

        /**
         * Returns a point that specifies the location for inserting cells.
         */
        Graph.prototype.getInsertPoint = function () {
            var gs = this.getGridSize();
            var dx = this.container.scrollLeft / this.view.scale - this.view.translate.x;
            var dy = this.container.scrollTop / this.view.scale - this.view.translate.y;

            if (this.pageVisible) {
                var layout = this.getPageLayout();
                var page = this.getPageSize();
                dx = Math.max(dx, layout.x * page.width);
                dy = Math.max(dy, layout.y * page.height);
            }

            return new mxPoint(this.snap(dx + gs), this.snap(dy + gs));
        };

        /**
         *
         */
        Graph.prototype.getFreeInsertPoint = function () {
            var view = this.view;
            var bds = this.getGraphBounds();
            var pt = this.getInsertPoint();

            // Places at same x-coord and 2 grid sizes below existing graph
            var x = this.snap(Math.round(Math.max(pt.x, bds.x / view.scale - view.translate.x +
                ((bds.width == 0) ? 2 * this.gridSize : 0))));
            var y = this.snap(Math.round(Math.max(pt.y, (bds.y + bds.height) / view.scale - view.translate.y +
                2 * this.gridSize)));

            return new mxPoint(x, y);
        };

        /**
         * Hook for subclassers to return true if the current insert point was defined
         * using a mouse hover event.
         */
        Graph.prototype.isMouseInsertPoint = function () {
            return false;
        };

        /**
         * Adds a new label at the given position and returns the new cell. State is
         * an optional edge state to be used as the parent for the label. Vertices
         * are not allowed currently as states.
         */
        Graph.prototype.addText = function (x, y, state) {
            // Creates a new edge label with a predefined text
            var label = new mxCell();
            label.value = 'Text';
            label.style = 'text;html=1;resizable=0;points=[];'
            label.geometry = new mxGeometry(0, 0, 0, 0);
            label.vertex = true;

            if (state != null) {
                label.style += 'align=center;verticalAlign=middle;labelBackgroundColor=#ffffff;'
                label.geometry.relative = true;
                label.connectable = false;

                // Resets the relative location stored inside the geometry
                var pt2 = this.view.getRelativePoint(state, x, y);
                label.geometry.x = Math.round(pt2.x * 10000) / 10000;
                label.geometry.y = Math.round(pt2.y);

                // Resets the offset inside the geometry to find the offset from the resulting point
                label.geometry.offset = new mxPoint(0, 0);
                pt2 = this.view.getPoint(state, label.geometry);

                var scale = this.view.scale;
                label.geometry.offset = new mxPoint(Math.round((x - pt2.x) / scale), Math.round((y - pt2.y) / scale));
            } else {
                label.style += 'autosize=1;align=left;verticalAlign=top;spacingTop=-4;'

                var tr = this.view.translate;
                label.geometry.width = 40;
                label.geometry.height = 20;
                label.geometry.x = Math.round(x / this.view.scale) - tr.x;
                label.geometry.y = Math.round(y / this.view.scale) - tr.y;
            }

            this.getModel().beginUpdate();
            try {
                this.addCells([label], (state != null) ? state.cell : null);
                this.fireEvent(new mxEventObject('textInserted', 'cells', [label]));
                // Updates size of text after possible change of style via event
                this.autoSizeCell(label);
            } finally {
                this.getModel().endUpdate();
            }

            return label;
        };

        /**
         * Adds a handler for clicking on shapes with links. This replaces all links in labels.
         */
        Graph.prototype.addClickHandler = function (highlight, beforeClick, onClick) {
            // Replaces links in labels for consistent right-clicks
            var checkLinks = mxUtils.bind(this, function () {
                var links = this.container.getElementsByTagName('a');

                if (links != null) {
                    for (var i = 0; i < links.length; i++) {
                        var href = this.getAbsoluteUrl(links[i].getAttribute('href'));

                        if (href != null) {
                            links[i].setAttribute('rel', this.linkRelation);
                            links[i].setAttribute('href', href);

                            if (beforeClick != null) {
                                mxEvent.addGestureListeners(links[i], null, null, beforeClick);
                            }
                        }
                    }
                }
            });

            this.model.addListener(mxEvent.CHANGE, checkLinks);
            checkLinks();

            var cursor = this.container.style.cursor;
            var tol = this.getTolerance();
            var graph = this;

            var mouseListener =
                {
                    currentState: null,
                    currentLink: null,
                    highlight: (highlight != null && highlight != '' && highlight != mxConstants.NONE) ?
                        new mxCellHighlight(graph, highlight, 4) : null,
                    startX: 0,
                    startY: 0,
                    scrollLeft: 0,
                    scrollTop: 0,
                    updateCurrentState: function (me) {
                        var tmp = me.sourceState;

                        // Gets topmost intersecting cell with link
                        if (tmp == null || graph.getLinkForCell(tmp.cell) == null) {
                            var cell = graph.getCellAt(me.getGraphX(), me.getGraphY(), null, null, null, function (state, x, y) {
                                return graph.getLinkForCell(state.cell) == null;
                            });

                            tmp = graph.view.getState(cell);
                        }

                        if (tmp != this.currentState) {
                            if (this.currentState != null) {
                                this.clear();
                            }

                            this.currentState = tmp;

                            if (this.currentState != null) {
                                this.activate(this.currentState);
                            }
                        }
                    },
                    mouseDown: function (sender, me) {
                        this.startX = me.getGraphX();
                        this.startY = me.getGraphY();
                        this.scrollLeft = graph.container.scrollLeft;
                        this.scrollTop = graph.container.scrollTop;

                        if (this.currentLink == null && graph.container.style.overflow == 'auto') {
                            graph.container.style.cursor = 'move';
                        }

                        this.updateCurrentState(me);
                    },
                    mouseMove: function (sender, me) {
                        if (graph.isMouseDown) {
                            if (this.currentLink != null) {
                                var dx = Math.abs(this.startX - me.getGraphX());
                                var dy = Math.abs(this.startY - me.getGraphY());

                                if (dx > tol || dy > tol) {
                                    this.clear();
                                }
                            }
                        } else {
                            // Checks for parent link
                            var linkNode = me.getSource();

                            while (linkNode != null && linkNode.nodeName.toLowerCase() != 'a') {
                                linkNode = linkNode.parentNode;
                            }

                            if (linkNode != null) {
                                this.clear();
                            } else {
                                if (graph.tooltipHandler != null && this.currentLink != null && this.currentState != null) {
                                    graph.tooltipHandler.reset(me, true, this.currentState);
                                }

                                if (this.currentState != null && (me.getState() == this.currentState || me.sourceState == null) &&
                                    graph.intersects(this.currentState, me.getGraphX(), me.getGraphY())) {
                                    return;
                                }

                                this.updateCurrentState(me);
                            }
                        }
                    },
                    mouseUp: function (sender, me) {
                        var source = me.getSource();
                        var evt = me.getEvent();

                        // Checks for parent link
                        var linkNode = source;

                        while (linkNode != null && linkNode.nodeName.toLowerCase() != 'a') {
                            linkNode = linkNode.parentNode;
                        }

                        // Ignores clicks on links and collapse/expand icon
                        if (linkNode == null &&
                            (((Math.abs(this.scrollLeft - graph.container.scrollLeft) < tol &&
                                Math.abs(this.scrollTop - graph.container.scrollTop) < tol) &&
                                (me.sourceState == null || !me.isSource(me.sourceState.control))) &&
                                (((mxEvent.isLeftMouseButton(evt) || mxEvent.isMiddleMouseButton(evt)) &&
                                    !mxEvent.isPopupTrigger(evt)) || mxEvent.isTouchEvent(evt)))) {
                            if (this.currentLink != null) {
                                var blank = graph.isBlankLink(this.currentLink);

                                if ((this.currentLink.substring(0, 5) === 'data:' ||
                                    !blank) && beforeClick != null) {
                                    beforeClick(evt, this.currentLink);
                                }

                                if (!mxEvent.isConsumed(evt)) {
                                    var target = (mxEvent.isMiddleMouseButton(evt)) ? '_blank' :
                                        ((blank) ? graph.linkTarget : '_top');
                                    graph.openLink(this.currentLink, target);
                                    me.consume();
                                }
                            } else if (onClick != null && !me.isConsumed() &&
                                (Math.abs(this.scrollLeft - graph.container.scrollLeft) < tol &&
                                    Math.abs(this.scrollTop - graph.container.scrollTop) < tol) &&
                                (Math.abs(this.startX - me.getGraphX()) < tol &&
                                    Math.abs(this.startY - me.getGraphY()) < tol)) {
                                onClick(me.getEvent());
                            }
                        }

                        this.clear();
                    },
                    activate: function (state) {
                        this.currentLink = graph.getAbsoluteUrl(graph.getLinkForCell(state.cell));

                        if (this.currentLink != null) {
                            graph.container.style.cursor = 'pointer';

                            if (this.highlight != null) {
                                this.highlight.highlight(state);
                            }
                        }
                    },
                    clear: function () {
                        if (graph.container != null) {
                            graph.container.style.cursor = cursor;
                        }

                        this.currentState = null;
                        this.currentLink = null;

                        if (this.highlight != null) {
                            this.highlight.hide();
                        }

                        if (graph.tooltipHandler != null) {
                            graph.tooltipHandler.hide();
                        }
                    }
                };

            // Ignores built-in click handling
            graph.click = function (me) {
            };
            graph.addMouseListener(mouseListener);

            mxEvent.addListener(document, 'mouseleave', function (evt) {
                mouseListener.clear();
            });
        };

        /**
         * Duplicates the given cells and returns the duplicates.
         */
        Graph.prototype.duplicateCells = function (cells, append) {
            cells = (cells != null) ? cells : this.getSelectionCells();
            append = (append != null) ? append : true;

            cells = this.model.getTopmostCells(cells);

            var model = this.getModel();
            var s = this.gridSize;
            var select = [];

            model.beginUpdate();
            try {
                var clones = this.cloneCells(cells, false, null, true);

                for (var i = 0; i < cells.length; i++) {
                    var parent = model.getParent(cells[i]);
                    var child = this.moveCells([clones[i]], s, s, false)[0];
                    select.push(child);

                    if (append) {
                        model.add(parent, clones[i]);
                    } else {
                        // Maintains child index by inserting after clone in parent
                        var index = parent.getIndex(cells[i]);
                        model.add(parent, clones[i], index + 1);
                    }
                }
            } finally {
                model.endUpdate();
            }

            return select;
        };

        /**
         * Inserts the given image at the cursor in a content editable text box using
         * the insertimage command on the document instance.
         */
        Graph.prototype.insertImage = function (newValue, w, h) {
            // To find the new image, we create a list of all existing links first
            if (newValue != null && this.cellEditor.textarea != null) {
                var tmp = this.cellEditor.textarea.getElementsByTagName('img');
                var oldImages = [];

                for (var i = 0; i < tmp.length; i++) {
                    oldImages.push(tmp[i]);
                }

                // LATER: Fix inserting link/image in IE8/quirks after focus lost
                document.execCommand('insertimage', false, newValue);

                // Sets size of new image
                var newImages = this.cellEditor.textarea.getElementsByTagName('img');

                if (newImages.length == oldImages.length + 1) {
                    // Inverse order in favor of appended images
                    for (var i = newImages.length - 1; i >= 0; i--) {
                        if (i == 0 || newImages[i] != oldImages[i - 1]) {
                            // Workaround for lost styles during undo and redo is using attributes
                            newImages[i].setAttribute('width', w);
                            newImages[i].setAttribute('height', h);

                            break;
                        }
                    }
                }
            }
        };

        /**
         * Inserts the given image at the cursor in a content editable text box using
         * the insertimage command on the document instance.
         */
        Graph.prototype.insertLink = function (value) {
            if (this.cellEditor.textarea != null) {
                if (value.length == 0) {
                    document.execCommand('unlink', false);
                } else if (mxClient.IS_FF) {
                    // Workaround for Firefox that adds a new link and removes
                    // the href from the inner link if its parent is a span is
                    // to remove all inner links inside the new outer link
                    var tmp = this.cellEditor.textarea.getElementsByTagName('a');
                    var oldLinks = [];

                    for (var i = 0; i < tmp.length; i++) {
                        oldLinks.push(tmp[i]);
                    }

                    document.execCommand('createlink', false, mxUtils.trim(value));

                    // Finds the new link element
                    var newLinks = this.cellEditor.textarea.getElementsByTagName('a');

                    if (newLinks.length == oldLinks.length + 1) {
                        // Inverse order in favor of appended links
                        for (var i = newLinks.length - 1; i >= 0; i--) {
                            if (newLinks[i] != oldLinks[i - 1]) {
                                // Removes all inner links from the new link and
                                // moves the children to the inner link parent
                                var tmp = newLinks[i].getElementsByTagName('a');

                                while (tmp.length > 0) {
                                    var parent = tmp[0].parentNode;

                                    while (tmp[0].firstChild != null) {
                                        parent.insertBefore(tmp[0].firstChild, tmp[0]);
                                    }

                                    parent.removeChild(tmp[0]);
                                }

                                break;
                            }
                        }
                    }
                } else {
                    // LATER: Fix inserting link/image in IE8/quirks after focus lost
                    document.execCommand('createlink', false, mxUtils.trim(value));
                }
            }
        };

        /**
         *
         * @param cell
         * @returns {Boolean}
         */
        Graph.prototype.isCellResizable = function (cell) {
            var result = mxGraph.prototype.isCellResizable.apply(this, arguments);

            var state = this.view.getState(cell);
            var style = (state != null) ? state.style : this.getCellStyle(cell);

            return result || (mxUtils.getValue(style, mxConstants.STYLE_RESIZABLE, '1') != '0' &&
                style[mxConstants.STYLE_WHITE_SPACE] == 'wrap');
        };

        /**
         * Function: distributeCells
         *
         * Distribuets the centers of the given cells equally along the available
         * horizontal or vertical space.
         *
         * Parameters:
         *
         * horizontal - Boolean that specifies the direction of the distribution.
         * cells - Optional array of <mxCells> to be distributed. Edges are ignored.
         */
        Graph.prototype.distributeCells = function (horizontal, cells) {
            if (cells == null) {
                cells = this.getSelectionCells();
            }

            if (cells != null && cells.length > 1) {
                var vertices = [];
                var max = null;
                var min = null;

                for (var i = 0; i < cells.length; i++) {
                    if (this.getModel().isVertex(cells[i])) {
                        var state = this.view.getState(cells[i]);

                        if (state != null) {
                            var tmp = (horizontal) ? state.getCenterX() : state.getCenterY();
                            max = (max != null) ? Math.max(max, tmp) : tmp;
                            min = (min != null) ? Math.min(min, tmp) : tmp;

                            vertices.push(state);
                        }
                    }
                }

                if (vertices.length > 2) {
                    vertices.sort(function (a, b) {
                        return (horizontal) ? a.x - b.x : a.y - b.y;
                    });

                    var t = this.view.translate;
                    var s = this.view.scale;

                    min = min / s - ((horizontal) ? t.x : t.y);
                    max = max / s - ((horizontal) ? t.x : t.y);

                    this.getModel().beginUpdate();
                    try {
                        var dt = (max - min) / (vertices.length - 1);
                        var t0 = min;

                        for (var i = 1; i < vertices.length - 1; i++) {
                            var pstate = this.view.getState(this.model.getParent(vertices[i].cell));
                            var geo = this.getCellGeometry(vertices[i].cell);
                            t0 += dt;

                            if (geo != null && pstate != null) {
                                geo = geo.clone();

                                if (horizontal) {
                                    geo.x = Math.round(t0 - geo.width / 2) - pstate.origin.x;
                                } else {
                                    geo.y = Math.round(t0 - geo.height / 2) - pstate.origin.y;
                                }

                                this.getModel().setGeometry(vertices[i].cell, geo);
                            }
                        }
                    } finally {
                        this.getModel().endUpdate();
                    }
                }
            }

            return cells;
        };

        /**
         * Adds meta-drag an Mac.
         * @param evt
         * @returns
         */
        Graph.prototype.isCloneEvent = function (evt) {
            return (mxClient.IS_MAC && mxEvent.isMetaDown(evt)) || mxEvent.isControlDown(evt);
        };

        /**
         * Translates this point by the given vector.
         *
         * @param {number} dx X-coordinate of the translation.
         * @param {number} dy Y-coordinate of the translation.
         */
        Graph.prototype.createSvgImageExport = function () {
            var exp = new mxImageExport();

            // Adds hyperlinks (experimental)
            exp.getLinkForCellState = mxUtils.bind(this, function (state, canvas) {
                return this.getLinkForCell(state.cell);
            });

            return exp;
        };

        /**
         * Translates this point by the given vector.
         *
         * @param {number} dx X-coordinate of the translation.
         * @param {number} dy Y-coordinate of the translation.
         */
        Graph.prototype.getSvg = function (background, scale, border, nocrop, crisp,
                                           ignoreSelection, showText, imgExport, linkTarget, hasShadow) {
            //Disable Css Transforms if it is used
            var origUseCssTrans = this.useCssTransforms;

            if (origUseCssTrans) {
                this.useCssTransforms = false;
                this.view.revalidate();
                this.sizeDidChange();
            }

            try {
                scale = (scale != null) ? scale : 1;
                border = (border != null) ? border : 0;
                crisp = (crisp != null) ? crisp : true;
                ignoreSelection = (ignoreSelection != null) ? ignoreSelection : true;
                showText = (showText != null) ? showText : true;

                var bounds = (ignoreSelection || nocrop) ?
                    this.getGraphBounds() : this.getBoundingBox(this.getSelectionCells());

                if (bounds == null) {
                    throw Error(mxResources.get('drawingEmpty'));
                }

                var vs = this.view.scale;

                // Prepares SVG document that holds the output
                var svgDoc = mxUtils.createXmlDocument();
                var root = (svgDoc.createElementNS != null) ?
                    svgDoc.createElementNS(mxConstants.NS_SVG, 'svg') : svgDoc.createElement('svg');

                if (background != null) {
                    if (root.style != null) {
                        root.style.backgroundColor = background;
                    } else {
                        root.setAttribute('style', 'background-color:' + background);
                    }
                }

                if (svgDoc.createElementNS == null) {
                    root.setAttribute('xmlns', mxConstants.NS_SVG);
                    root.setAttribute('xmlns:xlink', mxConstants.NS_XLINK);
                } else {
                    // KNOWN: Ignored in IE9-11, adds namespace for each image element instead. No workaround.
                    root.setAttributeNS('http://www.w3.org/2000/xmlns/', 'xmlns:xlink', mxConstants.NS_XLINK);
                }

                var s = scale / vs;
                var w = Math.max(1, Math.ceil(bounds.width * s) + 2 * border) + ((hasShadow) ? 5 : 0);
                var h = Math.max(1, Math.ceil(bounds.height * s) + 2 * border) + ((hasShadow) ? 5 : 0);

                root.setAttribute('version', '1.1');
                root.setAttribute('width', w + 'px');
                root.setAttribute('height', h + 'px');
                root.setAttribute('viewBox', ((crisp) ? '-0.5 -0.5' : '0 0') + ' ' + w + ' ' + h);
                svgDoc.appendChild(root);

                // Renders graph. Offset will be multiplied with state's scale when painting state.
                // TextOffset only seems to affect FF output but used everywhere for consistency.
                var group = (svgDoc.createElementNS != null) ?
                    svgDoc.createElementNS(mxConstants.NS_SVG, 'g') : svgDoc.createElement('g');
                root.appendChild(group);

                var svgCanvas = this.createSvgCanvas(group);
                svgCanvas.foOffset = (crisp) ? -0.5 : 0;
                svgCanvas.textOffset = (crisp) ? -0.5 : 0;
                svgCanvas.imageOffset = (crisp) ? -0.5 : 0;
                svgCanvas.translate(Math.floor((border / scale - bounds.x) / vs),
                    Math.floor((border / scale - bounds.y) / vs));

                // Convert HTML entities
                var htmlConverter = document.createElement('textarea');

                // Adds simple text fallback for viewers with no support for foreignObjects
                var createAlternateContent = svgCanvas.createAlternateContent;
                svgCanvas.createAlternateContent = function (fo, x, y, w, h, str, align, valign, wrap, format, overflow, clip, rotation) {
                    var s = this.state;

                    // Assumes a max character width of 0.2em
                    if (this.foAltText != null && (w == 0 || (s.fontSize != 0 && str.length < (w * 5) / s.fontSize))) {
                        var alt = this.createElement('text');
                        alt.setAttribute('x', Math.round(w / 2));
                        alt.setAttribute('y', Math.round((h + s.fontSize) / 2));
                        alt.setAttribute('fill', s.fontColor || 'black');
                        alt.setAttribute('text-anchor', 'middle');
                        alt.setAttribute('font-size', Math.round(s.fontSize) + 'px');
                        alt.setAttribute('font-family', s.fontFamily);

                        if ((s.fontStyle & mxConstants.FONT_BOLD) == mxConstants.FONT_BOLD) {
                            alt.setAttribute('font-weight', 'bold');
                        }

                        if ((s.fontStyle & mxConstants.FONT_ITALIC) == mxConstants.FONT_ITALIC) {
                            alt.setAttribute('font-style', 'italic');
                        }

                        if ((s.fontStyle & mxConstants.FONT_UNDERLINE) == mxConstants.FONT_UNDERLINE) {
                            alt.setAttribute('text-decoration', 'underline');
                        }

                        try {
                            htmlConverter.innerHTML = str;
                            alt.textContent = htmlConverter.value;

                            return alt;
                        } catch (e) {
                            return createAlternateContent.apply(this, arguments);
                        }
                    } else {
                        return createAlternateContent.apply(this, arguments);
                    }
                };

                // Paints background image
                var bgImg = this.backgroundImage;

                if (bgImg != null) {
                    var s2 = vs / scale;
                    var tr = this.view.translate;
                    var tmp = new mxRectangle(tr.x * s2, tr.y * s2, bgImg.width * s2, bgImg.height * s2);

                    // Checks if visible
                    if (mxUtils.intersects(bounds, tmp)) {
                        svgCanvas.image(tr.x, tr.y, bgImg.width, bgImg.height, bgImg.src, true);
                    }
                }

                svgCanvas.scale(s);
                svgCanvas.textEnabled = showText;

                imgExport = (imgExport != null) ? imgExport : this.createSvgImageExport();
                var imgExportDrawCellState = imgExport.drawCellState;

                // Ignores custom links
                var imgExportGetLinkForCellState = imgExport.getLinkForCellState;

                imgExport.getLinkForCellState = function (state, canvas) {
                    var result = imgExportGetLinkForCellState.apply(this, arguments);

                    return (result != null && !state.view.graph.isCustomLink(result)) ? result : null;
                };

                // Implements ignoreSelection flag
                imgExport.drawCellState = function (state, canvas) {
                    var graph = state.view.graph;
                    var selected = graph.isCellSelected(state.cell);
                    var parent = graph.model.getParent(state.cell);

                    // Checks if parent cell is selected
                    while (!ignoreSelection && !selected && parent != null) {
                        selected = graph.isCellSelected(parent);
                        parent = graph.model.getParent(parent);
                    }

                    if (ignoreSelection || selected) {
                        imgExportDrawCellState.apply(this, arguments);
                    }
                };

                imgExport.drawState(this.getView().getState(this.model.root), svgCanvas);
                this.updateSvgLinks(root, linkTarget, true);

                return root;
            } finally {
                if (origUseCssTrans) {
                    this.useCssTransforms = true;
                    this.view.revalidate();
                    this.sizeDidChange();
                }
            }
        };

        /**
         * Hook for creating the canvas used in getSvg.
         */
        Graph.prototype.updateSvgLinks = function (node, target, removeCustom) {
            var links = node.getElementsByTagName('a');

            for (var i = 0; i < links.length; i++) {
                var href = links[i].getAttribute('href');

                if (href == null) {
                    href = links[i].getAttribute('xlink:href');
                }

                if (href != null) {
                    if (target != null && /^https?:\/\//.test(href)) {
                        links[i].setAttribute('target', target);
                    } else if (removeCustom && this.isCustomLink(href)) {
                        links[i].setAttribute('href', 'javascript:void(0);');
                    }
                }
            }
        };

        /**
         * Hook for creating the canvas used in getSvg.
         */
        Graph.prototype.createSvgCanvas = function (node) {
            return new mxSvgCanvas2D(node);
        };

        /**
         * Returns the first ancestor of the current selection with the given name.
         */
        Graph.prototype.getSelectedElement = function () {
            var node = null;

            if (window.getSelection) {
                var sel = window.getSelection();

                if (sel.getRangeAt && sel.rangeCount) {
                    var range = sel.getRangeAt(0);
                    node = range.commonAncestorContainer;
                }
            } else if (document.selection) {
                node = document.selection.createRange().parentElement();
            }

            return node;
        };

        /**
         * Returns the first ancestor of the current selection with the given name.
         */
        Graph.prototype.getParentByName = function (node, name, stopAt) {
            while (node != null) {
                if (node.nodeName == name) {
                    return node;
                }

                if (node == stopAt) {
                    return null;
                }

                node = node.parentNode;
            }

            return node;
        };

        /**
         * Returns the first ancestor of the current selection with the given name.
         */
        Graph.prototype.getParentByNames = function (node, names, stopAt) {
            while (node != null) {
                if (mxUtils.indexOf(names, node.nodeName) >= 0) {
                    return node;
                }

                if (node == stopAt) {
                    return null;
                }

                node = node.parentNode;
            }

            return node;
        };

        /**
         * Selects the given node.
         */
        Graph.prototype.selectNode = function (node) {
            var sel = null;

            // IE9 and non-IE
            if (window.getSelection) {
                sel = window.getSelection();

                if (sel.getRangeAt && sel.rangeCount) {
                    var range = document.createRange();
                    range.selectNode(node);
                    sel.removeAllRanges();
                    sel.addRange(range);
                }
            }
            // IE < 9
            else if ((sel = document.selection) && sel.type != 'Control') {
                var originalRange = sel.createRange();
                originalRange.collapse(true);
                var range = sel.createRange();
                range.setEndPoint('StartToStart', originalRange);
                range.select();
            }
        };

        /**
         * Inserts a new row into the given table.
         */
        Graph.prototype.insertRow = function (table, index) {
            var bd = table.tBodies[0];
            var cells = bd.rows[0].cells;
            var cols = 0;

            // Counts columns including colspans
            for (var i = 0; i < cells.length; i++) {
                var colspan = cells[i].getAttribute('colspan');
                cols += (colspan != null) ? parseInt(colspan) : 1;
            }

            var row = bd.insertRow(index);

            for (var i = 0; i < cols; i++) {
                mxUtils.br(row.insertCell(-1));
            }

            return row.cells[0];
        };

        /**
         * Deletes the given column.
         */
        Graph.prototype.deleteRow = function (table, index) {
            table.tBodies[0].deleteRow(index);
        };

        /**
         * Deletes the given column.
         */
        Graph.prototype.insertColumn = function (table, index) {
            var hd = table.tHead;

            if (hd != null) {
                // TODO: use colIndex
                for (var h = 0; h < hd.rows.length; h++) {
                    var th = document.createElement('th');
                    hd.rows[h].appendChild(th);
                    mxUtils.br(th);
                }
            }

            var bd = table.tBodies[0];

            for (var i = 0; i < bd.rows.length; i++) {
                var cell = bd.rows[i].insertCell(index);
                mxUtils.br(cell);
            }

            return bd.rows[0].cells[(index >= 0) ? index : bd.rows[0].cells.length - 1];
        };

        /**
         * Deletes the given column.
         */
        Graph.prototype.deleteColumn = function (table, index) {
            if (index >= 0) {
                var bd = table.tBodies[0];
                var rows = bd.rows;

                for (var i = 0; i < rows.length; i++) {
                    if (rows[i].cells.length > index) {
                        rows[i].deleteCell(index);
                    }
                }
            }
        };

        /**
         * Inserts the given HTML at the caret position (no undo).
         */
        Graph.prototype.pasteHtmlAtCaret = function (html) {
            var sel, range;

            // IE9 and non-IE
            if (window.getSelection) {
                sel = window.getSelection();

                if (sel.getRangeAt && sel.rangeCount) {
                    range = sel.getRangeAt(0);
                    range.deleteContents();

                    // Range.createContextualFragment() would be useful here but is
                    // only relatively recently standardized and is not supported in
                    // some browsers (IE9, for one)
                    var el = document.createElement("div");
                    el.innerHTML = html;
                    var frag = document.createDocumentFragment(), node;

                    while ((node = el.firstChild)) {
                        lastNode = frag.appendChild(node);
                    }

                    range.insertNode(frag);
                }
            }
            // IE < 9
            else if ((sel = document.selection) && sel.type != "Control") {
                // FIXME: Does not work if selection is empty
                sel.createRange().pasteHTML(html);
            }
        };

        /**
         * Creates an anchor elements for handling the given link in the
         * hint that is shown when the cell is selected.
         */
        Graph.prototype.createLinkForHint = function (link, label) {
            link = (link != null) ? link : 'javascript:void(0);';

            if (label == null || label.length == 0) {
                if (this.isCustomLink(link)) {
                    label = this.getLinkTitle(link);
                } else {
                    label = link;
                }
            }

            // Helper function to shorten strings
            function short(str, max) {
                if (str.length > max) {
                    str = str.substring(0, Math.round(max / 2)) + '...' +
                        str.substring(str.length - Math.round(max / 4));
                }

                return str;
            };

            var a = document.createElement('a');
            a.setAttribute('rel', this.linkRelation);
            a.setAttribute('href', this.getAbsoluteUrl(link));
            a.setAttribute('title', short((this.isCustomLink(link)) ?
                this.getLinkTitle(link) : link, 80));

            if (this.linkTarget != null) {
                a.setAttribute('target', this.linkTarget);
            }

            // Adds shortened label to link
            mxUtils.write(a, short(label, 40));

            // Handles custom links
            if (this.isCustomLink(link)) {
                mxEvent.addListener(a, 'click', mxUtils.bind(this, function (evt) {
                    this.customLinkClicked(link);
                    mxEvent.consume(evt);
                }));
            }

            return a;
        };

        /**
         * Customized graph for touch devices.
         */
        Graph.prototype.initTouch = function () {
            // Disables new connections via "hotspot"
            this.connectionHandler.marker.isEnabled = function () {
                return this.graph.connectionHandler.first != null;
            };

            // Hides menu when editing starts
            this.addListener(mxEvent.START_EDITING, function (sender, evt) {
                this.popupMenuHandler.hideMenu();
            });

            // Adds custom hit detection if native hit detection found no cell
            var graphUpdateMouseEvent = this.updateMouseEvent;
            this.updateMouseEvent = function (me) {
                me = graphUpdateMouseEvent.apply(this, arguments);

                if (mxEvent.isTouchEvent(me.getEvent()) && me.getState() == null) {
                    var cell = this.getCellAt(me.graphX, me.graphY);

                    if (cell != null && this.isSwimlane(cell) && this.hitsSwimlaneContent(cell, me.graphX, me.graphY)) {
                        cell = null;
                    } else {
                        me.state = this.view.getState(cell);

                        if (me.state != null && me.state.shape != null) {
                            this.container.style.cursor = me.state.shape.node.style.cursor;
                        }
                    }
                }

                if (me.getState() == null && this.isEnabled()) {
                    this.container.style.cursor = 'default';
                }

                return me;
            };

            // Context menu trigger implementation depending on current selection state
            // combined with support for normal popup trigger.
            var cellSelected = false;
            var selectionEmpty = false;
            var menuShowing = false;

            var oldFireMouseEvent = this.fireMouseEvent;

            this.fireMouseEvent = function (evtName, me, sender) {
                if (evtName == mxEvent.MOUSE_DOWN) {
                    // For hit detection on edges
                    me = this.updateMouseEvent(me);

                    cellSelected = this.isCellSelected(me.getCell());
                    selectionEmpty = this.isSelectionEmpty();
                    menuShowing = this.popupMenuHandler.isMenuShowing();
                }

                oldFireMouseEvent.apply(this, arguments);
            };

            // Shows popup menu if cell was selected or selection was empty and background was clicked
            // FIXME: Conflicts with mxPopupMenuHandler.prototype.getCellForPopupEvent in Editor.js by
            // selecting parent for selected children in groups before this check can be made.
            this.popupMenuHandler.mouseUp = mxUtils.bind(this, function (sender, me) {
                this.popupMenuHandler.popupTrigger = !this.isEditing() && this.isEnabled() &&
                    (me.getState() == null || !me.isSource(me.getState().control)) &&
                    (this.popupMenuHandler.popupTrigger || (!menuShowing && !mxEvent.isMouseEvent(me.getEvent()) &&
                        ((selectionEmpty && me.getCell() == null && this.isSelectionEmpty()) ||
                            (cellSelected && this.isCellSelected(me.getCell())))));
                mxPopupMenuHandler.prototype.mouseUp.apply(this.popupMenuHandler, arguments);
            });
        };

        /**
         * HTML in-place editor
         */
        mxCellEditor.prototype.isContentEditing = function () {
            var state = this.graph.view.getState(this.editingCell);

            return state != null && state.style['html'] == 1;
        };

        /**
         * Returns true if all selected text is inside a table element.
         */
        mxCellEditor.prototype.isTableSelected = function () {
            return this.graph.getParentByName(
                this.graph.getSelectedElement(),
                'TABLE', this.textarea) != null;
        };

        /**
         * Sets the alignment of the current selected cell. This sets the
         * alignment in the cell style, removes all alignment within the
         * text and invokes the built-in alignment function.
         *
         * Only the built-in function is invoked if shift is pressed or
         * if table cells are selected and shift is not pressed.
         */
        mxCellEditor.prototype.alignText = function (align, evt) {
            if (!this.isTableSelected() == (evt == null || !mxEvent.isShiftDown(evt))) {
                this.graph.cellEditor.setAlign(align);

                this.graph.processElements(this.textarea, function (elt) {
                    elt.removeAttribute('align');
                    elt.style.textAlign = null;
                });
            }

            document.execCommand('justify' + align.toLowerCase(), false, null);
        };

        /**
         * Creates the keyboard event handler for the current graph and history.
         */
        mxCellEditor.prototype.saveSelection = function () {
            if (window.getSelection) {
                var sel = window.getSelection();

                if (sel.getRangeAt && sel.rangeCount) {
                    var ranges = [];

                    for (var i = 0, len = sel.rangeCount; i < len; ++i) {
                        ranges.push(sel.getRangeAt(i));
                    }

                    return ranges;
                }
            } else if (document.selection && document.selection.createRange) {
                return document.selection.createRange();
            }

            return null;
        };

        /**
         * Creates the keyboard event handler for the current graph and history.
         */
        mxCellEditor.prototype.restoreSelection = function (savedSel) {
            try {
                if (savedSel) {
                    if (window.getSelection) {
                        sel = window.getSelection();
                        sel.removeAllRanges();

                        for (var i = 0, len = savedSel.length; i < len; ++i) {
                            sel.addRange(savedSel[i]);
                        }
                    } else if (document.selection && savedSel.select) {
                        savedSel.select();
                    }
                }
            } catch (e) {
                // ignore
            }
        };

        /**
         * Handling of special nl2Br style for not converting newlines to breaks in HTML labels.
         * NOTE: Since it's easier to set this when the label is created we assume that it does
         * not change during the lifetime of the mxText instance.
         */
        var mxCellRendererInitializeLabel = mxCellRenderer.prototype.initializeLabel;
        mxCellRenderer.prototype.initializeLabel = function (state) {
            if (state.text != null) {
                state.text.replaceLinefeeds = mxUtils.getValue(state.style, 'nl2Br', '1') != '0';
            }

            mxCellRendererInitializeLabel.apply(this, arguments);
        };

        var mxConstraintHandlerUpdate = mxConstraintHandler.prototype.update;
        mxConstraintHandler.prototype.update = function (me, source) {
            if (this.isKeepFocusEvent(me) || !mxEvent.isAltDown(me.getEvent())) {
                mxConstraintHandlerUpdate.apply(this, arguments);
            } else {
                this.reset();
            }
        };

        /**
         * No dashed shapes.
         */
        mxGuide.prototype.createGuideShape = function (horizontal) {
            var guide = new mxPolyline([], mxConstants.GUIDE_COLOR, mxConstants.GUIDE_STROKEWIDTH);

            return guide;
        };

        /**
         * HTML in-place editor
         */
        mxCellEditor.prototype.escapeCancelsEditing = false;

        var mxCellEditorStartEditing = mxCellEditor.prototype.startEditing;
        mxCellEditor.prototype.startEditing = function (cell, trigger) {
            mxCellEditorStartEditing.apply(this, arguments);

            // Overrides class in case of HTML content to add
            // dashed borders for divs and table cells
            var state = this.graph.view.getState(cell);

            if (state != null && state.style['html'] == 1) {
                this.textarea.className = 'mxCellEditor geContentEditable';
            } else {
                this.textarea.className = 'mxCellEditor mxPlainTextEditor';
            }

            // Toggles markup vs wysiwyg mode
            this.codeViewMode = false;

            // Stores current selection range when switching between markup and code
            this.switchSelectionState = null;

            // Selects editing cell
            this.graph.setSelectionCell(cell);

            // Enables focus outline for edges and edge labels
            var parent = this.graph.getModel().getParent(cell);
            var geo = this.graph.getCellGeometry(cell);

            if ((this.graph.getModel().isEdge(parent) && geo != null && geo.relative) ||
                this.graph.getModel().isEdge(cell)) {
                // Quirks does not support outline at all so use border instead
                if (mxClient.IS_QUIRKS) {
                    this.textarea.style.border = 'gray dotted 1px';
                }
                // IE>8 and FF on Windows uses outline default of none
                else if (mxClient.IS_IE || mxClient.IS_IE11 || (mxClient.IS_FF && mxClient.IS_WIN)) {
                    this.textarea.style.outline = 'gray dotted 1px';
                } else {
                    this.textarea.style.outline = '';
                }
            } else if (mxClient.IS_QUIRKS) {
                this.textarea.style.outline = 'none';
                this.textarea.style.border = '';
            }
        }

        /**
         * HTML in-place editor
         */
        var cellEditorInstallListeners = mxCellEditor.prototype.installListeners;
        mxCellEditor.prototype.installListeners = function (elt) {
            cellEditorInstallListeners.apply(this, arguments);

            // Adds a reference from the clone to the original node, recursively
            function reference(node, clone) {
                clone.originalNode = node;

                node = node.firstChild;
                var child = clone.firstChild;

                while (node != null && child != null) {
                    reference(node, child);
                    node = node.nextSibling;
                    child = child.nextSibling;
                }

                return clone;
            };

            // Checks the given node for new nodes, recursively
            function checkNode(node, clone) {
                if (node != null) {
                    if (clone.originalNode != node) {
                        cleanNode(node);
                    } else {
                        node = node.firstChild;
                        clone = clone.firstChild;

                        while (node != null) {
                            var nextNode = node.nextSibling;

                            if (clone == null) {
                                cleanNode(node);
                            } else {
                                checkNode(node, clone);
                                clone = clone.nextSibling;
                            }

                            node = nextNode;
                        }
                    }
                }
            };

            // Removes unused DOM nodes and attributes, recursively
            function cleanNode(node) {
                var child = node.firstChild;

                while (child != null) {
                    var next = child.nextSibling;
                    cleanNode(child);
                    child = next;
                }

                if ((node.nodeType != 1 || (node.nodeName !== 'BR' && node.firstChild == null)) &&
                    (node.nodeType != 3 || mxUtils.trim(mxUtils.getTextContent(node)).length == 0)) {
                    node.parentNode.removeChild(node);
                } else {
                    // Removes linefeeds
                    if (node.nodeType == 3) {
                        mxUtils.setTextContent(node, mxUtils.getTextContent(node).replace(/\n|\r/g, ''));
                    }

                    // Removes CSS classes and styles (for Word and Excel)
                    if (node.nodeType == 1) {
                        node.removeAttribute('style');
                        node.removeAttribute('class');
                        node.removeAttribute('width');
                        node.removeAttribute('cellpadding');
                        node.removeAttribute('cellspacing');
                        node.removeAttribute('border');
                    }
                }
            };

            // Handles paste from Word, Excel etc by removing styles, classnames and unused nodes
            // LATER: Fix undo/redo for paste
            if (!mxClient.IS_QUIRKS && document.documentMode !== 7 && document.documentMode !== 8) {
                mxEvent.addListener(this.textarea, 'paste', mxUtils.bind(this, function (evt) {
                    var clone = reference(this.textarea, this.textarea.cloneNode(true));

                    window.setTimeout(mxUtils.bind(this, function () {
                        // Paste from Word or Excel
                        if (this.textarea != null &&
                            (this.textarea.innerHTML.indexOf('<o:OfficeDocumentSettings>') >= 0 ||
                                this.textarea.innerHTML.indexOf('<!--[if !mso]>') >= 0)) {
                            checkNode(this.textarea, clone);
                        }
                    }), 0);
                }));
            }
        };

        mxCellEditor.prototype.toggleViewMode = function () {
            var state = this.graph.view.getState(this.editingCell);

            if (state != null) {
                var nl2Br = state != null && mxUtils.getValue(state.style, 'nl2Br', '1') != '0';
                var tmp = this.saveSelection();

                if (!this.codeViewMode) {
                    // Clears the initial empty label on the first keystroke
                    if (this.clearOnChange && this.textarea.innerHTML == this.getEmptyLabelText()) {
                        this.clearOnChange = false;
                        this.textarea.innerHTML = '';
                    }

                    // Removes newlines from HTML and converts breaks to newlines
                    // to match the HTML output in plain text
                    var content = mxUtils.htmlEntities(this.textarea.innerHTML);

                    // Workaround for trailing line breaks being ignored in the editor
                    if (!mxClient.IS_QUIRKS && document.documentMode != 8) {
                        content = mxUtils.replaceTrailingNewlines(content, '<div><br></div>');
                    }

                    content = this.graph.sanitizeHtml((nl2Br) ? content.replace(/\n/g, '').replace(/&lt;br\s*.?&gt;/g, '<br>') : content, true);
                    this.textarea.className = 'mxCellEditor mxPlainTextEditor';

                    var size = mxConstants.DEFAULT_FONTSIZE;

                    this.textarea.style.lineHeight = (mxConstants.ABSOLUTE_LINE_HEIGHT) ? Math.round(size * mxConstants.LINE_HEIGHT) + 'px' : mxConstants.LINE_HEIGHT;
                    this.textarea.style.fontSize = Math.round(size) + 'px';
                    this.textarea.style.textDecoration = '';
                    this.textarea.style.fontWeight = 'normal';
                    this.textarea.style.fontStyle = '';
                    this.textarea.style.fontFamily = mxConstants.DEFAULT_FONTFAMILY;
                    this.textarea.style.textAlign = 'left';

                    // Adds padding to make cursor visible with borders
                    this.textarea.style.padding = '2px';

                    if (this.textarea.innerHTML != content) {
                        this.textarea.innerHTML = content;
                    }

                    this.codeViewMode = true;
                } else {
                    var content = mxUtils.extractTextWithWhitespace(this.textarea.childNodes);

                    // Strips trailing line break
                    if (content.length > 0 && content.charAt(content.length - 1) == '\n') {
                        content = content.substring(0, content.length - 1);
                    }

                    content = this.graph.sanitizeHtml((nl2Br) ? content.replace(/\n/g, '<br/>') : content, true)
                    this.textarea.className = 'mxCellEditor geContentEditable';

                    var size = mxUtils.getValue(state.style, mxConstants.STYLE_FONTSIZE, mxConstants.DEFAULT_FONTSIZE);
                    var family = mxUtils.getValue(state.style, mxConstants.STYLE_FONTFAMILY, mxConstants.DEFAULT_FONTFAMILY);
                    var align = mxUtils.getValue(state.style, mxConstants.STYLE_ALIGN, mxConstants.ALIGN_LEFT);
                    var bold = (mxUtils.getValue(state.style, mxConstants.STYLE_FONTSTYLE, 0) &
                        mxConstants.FONT_BOLD) == mxConstants.FONT_BOLD;
                    var italic = (mxUtils.getValue(state.style, mxConstants.STYLE_FONTSTYLE, 0) &
                        mxConstants.FONT_ITALIC) == mxConstants.FONT_ITALIC;
                    var uline = (mxUtils.getValue(state.style, mxConstants.STYLE_FONTSTYLE, 0) &
                        mxConstants.FONT_UNDERLINE) == mxConstants.FONT_UNDERLINE;

                    this.textarea.style.lineHeight = (mxConstants.ABSOLUTE_LINE_HEIGHT) ? Math.round(size * mxConstants.LINE_HEIGHT) + 'px' : mxConstants.LINE_HEIGHT;
                    this.textarea.style.fontSize = Math.round(size) + 'px';
                    this.textarea.style.textDecoration = (uline) ? 'underline' : '';
                    this.textarea.style.fontWeight = (bold) ? 'bold' : 'normal';
                    this.textarea.style.fontStyle = (italic) ? 'italic' : '';
                    this.textarea.style.fontFamily = family;
                    this.textarea.style.textAlign = align;
                    this.textarea.style.padding = '0px';

                    if (this.textarea.innerHTML != content) {
                        this.textarea.innerHTML = content;

                        if (this.textarea.innerHTML.length == 0) {
                            this.textarea.innerHTML = this.getEmptyLabelText();
                            this.clearOnChange = this.textarea.innerHTML.length > 0;
                        }
                    }

                    this.codeViewMode = false;
                }

                this.textarea.focus();

                if (this.switchSelectionState != null) {
                    this.restoreSelection(this.switchSelectionState);
                }

                this.switchSelectionState = tmp;
                this.resize();
            }
        };

        var mxCellEditorResize = mxCellEditor.prototype.resize;
        mxCellEditor.prototype.resize = function (state, trigger) {
            if (this.textarea != null) {
                var state = this.graph.getView().getState(this.editingCell);

                if (this.codeViewMode && state != null) {
                    var scale = state.view.scale;
                    this.bounds = mxRectangle.fromRectangle(state);

                    // General placement of code editor if cell has no size
                    // LATER: Fix HTML editor bounds for edge labels
                    if (this.bounds.width == 0 && this.bounds.height == 0) {
                        this.bounds.width = 160 * scale;
                        this.bounds.height = 60 * scale;

                        var m = (state.text != null) ? state.text.margin : null;

                        if (m == null) {
                            m = mxUtils.getAlignmentAsPoint(mxUtils.getValue(state.style, mxConstants.STYLE_ALIGN, mxConstants.ALIGN_CENTER),
                                mxUtils.getValue(state.style, mxConstants.STYLE_VERTICAL_ALIGN, mxConstants.ALIGN_MIDDLE));
                        }

                        this.bounds.x += m.x * this.bounds.width;
                        this.bounds.y += m.y * this.bounds.height;
                    }

                    this.textarea.style.width = Math.round((this.bounds.width - 4) / scale) + 'px';
                    this.textarea.style.height = Math.round((this.bounds.height - 4) / scale) + 'px';
                    this.textarea.style.overflow = 'auto';

                    // Adds scrollbar offset if visible
                    if (this.textarea.clientHeight < this.textarea.offsetHeight) {
                        this.textarea.style.height = Math.round((this.bounds.height / scale)) + (this.textarea.offsetHeight - this.textarea.clientHeight) + 'px';
                        this.bounds.height = parseInt(this.textarea.style.height) * scale;
                    }

                    if (this.textarea.clientWidth < this.textarea.offsetWidth) {
                        this.textarea.style.width = Math.round((this.bounds.width / scale)) + (this.textarea.offsetWidth - this.textarea.clientWidth) + 'px';
                        this.bounds.width = parseInt(this.textarea.style.width) * scale;
                    }

                    this.textarea.style.left = Math.round(this.bounds.x) + 'px';
                    this.textarea.style.top = Math.round(this.bounds.y) + 'px';

                    if (mxClient.IS_VML) {
                        this.textarea.style.zoom = scale;
                    } else {
                        mxUtils.setPrefixedStyle(this.textarea.style, 'transform', 'scale(' + scale + ',' + scale + ')');
                    }
                } else {
                    this.textarea.style.height = '';
                    this.textarea.style.overflow = '';
                    mxCellEditorResize.apply(this, arguments);
                }
            }
        };

        mxCellEditorGetInitialValue = mxCellEditor.prototype.getInitialValue;
        mxCellEditor.prototype.getInitialValue = function (state, trigger) {
            if (mxUtils.getValue(state.style, 'html', '0') == '0') {
                return mxCellEditorGetInitialValue.apply(this, arguments);
            } else {
                var result = this.graph.getEditingValue(state.cell, trigger)

                if (mxUtils.getValue(state.style, 'nl2Br', '1') == '1') {
                    result = result.replace(/\n/g, '<br/>');
                }

                result = this.graph.sanitizeHtml(result, true);

                return result;
            }
        };

        mxCellEditorGetCurrentValue = mxCellEditor.prototype.getCurrentValue;
        mxCellEditor.prototype.getCurrentValue = function (state) {
            if (mxUtils.getValue(state.style, 'html', '0') == '0') {
                return mxCellEditorGetCurrentValue.apply(this, arguments);
            } else {
                var result = this.graph.sanitizeHtml(this.textarea.innerHTML, true);

                if (mxUtils.getValue(state.style, 'nl2Br', '1') == '1') {
                    result = result.replace(/\r\n/g, '<br/>').replace(/\n/g, '<br/>');
                } else {
                    result = result.replace(/\r\n/g, '').replace(/\n/g, '');
                }

                return result;
            }
        };

        var mxCellEditorStopEditing = mxCellEditor.prototype.stopEditing;
        mxCellEditor.prototype.stopEditing = function (cancel) {
            // Restores default view mode before applying value
            if (this.codeViewMode) {
                this.toggleViewMode();
            }

            mxCellEditorStopEditing.apply(this, arguments);

            // Tries to move focus back to container after editing if possible
            this.focusContainer();
        };

        mxCellEditor.prototype.focusContainer = function () {
            try {
                this.graph.container.focus();
            } catch (e) {
                // ignore
            }
        };

        var mxCellEditorApplyValue = mxCellEditor.prototype.applyValue;
        mxCellEditor.prototype.applyValue = function (state, value) {
            // Removes empty relative child labels in edges
            this.graph.getModel().beginUpdate();

            try {
                mxCellEditorApplyValue.apply(this, arguments);

                if (this.graph.isCellDeletable(state.cell) && this.graph.model.getChildCount(state.cell) == 0) {
                    var stroke = mxUtils.getValue(state.style, mxConstants.STYLE_STROKECOLOR, mxConstants.NONE);
                    var fill = mxUtils.getValue(state.style, mxConstants.STYLE_FILLCOLOR, mxConstants.NONE);

                    if (value == '' && stroke == mxConstants.NONE && fill == mxConstants.NONE) {
                        this.graph.removeCells([state.cell], false);
                    }
                }
            } finally {
                this.graph.getModel().endUpdate();
            }
        };

        /**
         * Returns the background color to be used for the editing box. This returns
         * the label background for edge labels and null for all other cases.
         */
        mxCellEditor.prototype.getBackgroundColor = function (state) {
            var color = mxUtils.getValue(state.style, mxConstants.STYLE_LABEL_BACKGROUNDCOLOR, null);

            if ((color == null || color == mxConstants.NONE) &&
                (state.cell.geometry != null && state.cell.geometry.width > 0) &&
                (mxUtils.getValue(state.style, mxConstants.STYLE_ROTATION, 0) != 0 ||
                    mxUtils.getValue(state.style, mxConstants.STYLE_HORIZONTAL, 1) == 0)) {
                color = mxUtils.getValue(state.style, mxConstants.STYLE_FILLCOLOR, null);
            }

            if (color == mxConstants.NONE) {
                color = null;
            }

            return color;
        };

        mxCellEditor.prototype.getMinimumSize = function (state) {
            var scale = this.graph.getView().scale;

            return new mxRectangle(0, 0, (state.text == null) ? 30 : state.text.size * scale + 20, 30);
        };

        // Hold alt to ignore drop target
        var mxGraphHandlerMoveCells = mxGraphHandler.prototype.moveCells;

        mxGraphHandler.prototype.moveCells = function (cells, dx, dy, clone, target, evt) {
            if (mxEvent.isAltDown(evt)) {
                target = null;
            }

            mxGraphHandlerMoveCells.apply(this, arguments);
        };

        /**
         * Hints on handlers
         */
        function createHint() {
            var hint = document.createElement('div');
            hint.className = 'geHint';
            hint.style.whiteSpace = 'nowrap';
            hint.style.position = 'absolute';

            return hint;
        };

        /**
         * Format pixels in the given unit
         */
        function formatHintText(pixels, unit) {
            switch (unit) {
                case mxConstants.POINTS:
                    return pixels;
                case mxConstants.MILLIMETERS:
                    return (pixels / mxConstants.PIXELS_PER_MM).toFixed(1);
                case mxConstants.INCHES:
                    return (pixels / mxConstants.PIXELS_PER_INCH).toFixed(2);
            }
        };


        mxGraphView.prototype.formatUnitText = function (pixels) {
            return pixels ? formatHintText(pixels, this.unit) : pixels;
        };

        /**
         * Updates the hint for the current operation.
         */
        mxGraphHandler.prototype.updateHint = function (me) {
            if (this.shape != null) {
                if (this.hint == null) {
                    this.hint = createHint();
                    this.graph.container.appendChild(this.hint);
                }

                var t = this.graph.view.translate;
                var s = this.graph.view.scale;
                var x = this.roundLength((this.bounds.x + this.currentDx) / s - t.x);
                var y = this.roundLength((this.bounds.y + this.currentDy) / s - t.y);
                var unit = this.graph.view.unit;

                this.hint.innerHTML = formatHintText(x, unit) + ', ' + formatHintText(y, unit);

                this.hint.style.left = (this.shape.bounds.x + Math.round((this.shape.bounds.width - this.hint.clientWidth) / 2)) + 'px';
                this.hint.style.top = (this.shape.bounds.y + this.shape.bounds.height + 12) + 'px';
            }
        };

        /**
         * Updates the hint for the current operation.
         */
        mxGraphHandler.prototype.removeHint = function () {
            if (this.hint != null) {
                this.hint.parentNode.removeChild(this.hint);
                this.hint = null;
            }
        };

        /**
         * Enables recursive resize for groups.
         */
        mxVertexHandler.prototype.isRecursiveResize = function (state, me) {
            return !this.graph.isSwimlane(state.cell) && this.graph.model.getChildCount(state.cell) > 0 &&
                !mxEvent.isControlDown(me.getEvent()) && !this.graph.isCellCollapsed(state.cell) &&
                mxUtils.getValue(state.style, 'recursiveResize', '1') == '1' &&
                mxUtils.getValue(state.style, 'childLayout', null) == null;
        };

        /**
         * Enables centered resize events.
         */
        mxVertexHandler.prototype.isCenteredEvent = function (state, me) {
            return (!(!this.graph.isSwimlane(state.cell) && this.graph.model.getChildCount(state.cell) > 0 &&
                !this.graph.isCellCollapsed(state.cell) &&
                mxUtils.getValue(state.style, 'recursiveResize', '1') == '1' &&
                mxUtils.getValue(state.style, 'childLayout', null) == null) &&
                mxEvent.isControlDown(me.getEvent())) ||
                mxEvent.isMetaDown(me.getEvent());
        };

        var vertexHandlerGetHandlePadding = mxVertexHandler.prototype.getHandlePadding;
        mxVertexHandler.prototype.getHandlePadding = function () {
            var result = new mxPoint(0, 0);
            var tol = this.tolerance;

            if (this.graph.cellEditor.getEditingCell() == this.state.cell &&
                this.sizers != null && this.sizers.length > 0 && this.sizers[0] != null) {
                tol /= 2;

                result.x = this.sizers[0].bounds.width + tol;
                result.y = this.sizers[0].bounds.height + tol;
            } else {
                result = vertexHandlerGetHandlePadding.apply(this, arguments);
            }

            return result;
        };

        /**
         * Updates the hint for the current operation.
         */
        mxVertexHandler.prototype.updateHint = function (me) {
            if (this.index != mxEvent.LABEL_HANDLE) {
                if (this.hint == null) {
                    this.hint = createHint();
                    this.state.view.graph.container.appendChild(this.hint);
                }

                if (this.index == mxEvent.ROTATION_HANDLE) {
                    this.hint.innerHTML = this.currentAlpha + '&deg;';
                } else {
                    var s = this.state.view.scale;
                    var unit = this.state.view.unit;
                    this.hint.innerHTML = formatHintText(this.roundLength(this.bounds.width / s), unit) + ' x ' +
                        formatHintText(this.roundLength(this.bounds.height / s), unit);
                }

                var rot = (this.currentAlpha != null) ? this.currentAlpha : this.state.style[mxConstants.STYLE_ROTATION] || '0';
                var bb = mxUtils.getBoundingBox(this.bounds, rot);

                if (bb == null) {
                    bb = this.bounds;
                }

                this.hint.style.left = bb.x + Math.round((bb.width - this.hint.clientWidth) / 2) + 'px';
                this.hint.style.top = (bb.y + bb.height + 12) + 'px';

                if (this.linkHint != null) {
                    this.linkHint.style.display = 'none';
                }
            }
        };

        /**
         * Updates the hint for the current operation.
         */
        mxVertexHandler.prototype.removeHint = function () {
            mxGraphHandler.prototype.removeHint.apply(this, arguments);

            if (this.linkHint != null) {
                this.linkHint.style.display = '';
            }
        };

        /**
         * Hides link hint while moving cells.
         */
        var edgeHandlerMouseMove = mxEdgeHandler.prototype.mouseMove;

        mxEdgeHandler.prototype.mouseMove = function (sender, me) {
            edgeHandlerMouseMove.apply(this, arguments);

            if (this.graph.graphHandler != null && this.graph.graphHandler.first != null &&
                this.linkHint != null && this.linkHint.style.display != 'none') {
                this.linkHint.style.display = 'none';
            }
        }

        /**
         * Hides link hint while moving cells.
         */
        var edgeHandlerMouseUp = mxEdgeHandler.prototype.mouseUp;

        mxEdgeHandler.prototype.mouseUp = function (sender, me) {
            edgeHandlerMouseUp.apply(this, arguments);

            if (this.linkHint != null && this.linkHint.style.display == 'none') {
                this.linkHint.style.display = '';
            }
        }

        /**
         * Updates the hint for the current operation.
         */
        mxEdgeHandler.prototype.updateHint = function (me, point) {
            if (this.hint == null) {
                this.hint = createHint();
                this.state.view.graph.container.appendChild(this.hint);
            }

            var t = this.graph.view.translate;
            var s = this.graph.view.scale;
            var x = this.roundLength(point.x / s - t.x);
            var y = this.roundLength(point.y / s - t.y);
            var unit = this.graph.view.unit;

            this.hint.innerHTML = formatHintText(x, unit) + ', ' + formatHintText(y, unit);
            this.hint.style.visibility = 'visible';

            if (this.isSource || this.isTarget) {
                if (this.constraintHandler.currentConstraint != null &&
                    this.constraintHandler.currentFocus != null) {
                    var pt = this.constraintHandler.currentConstraint.point;
                    this.hint.innerHTML = '[' + Math.round(pt.x * 100) + '%, ' + Math.round(pt.y * 100) + '%]';
                } else if (this.marker.hasValidState()) {
                    this.hint.style.visibility = 'hidden';
                }
            }

            this.hint.style.left = Math.round(me.getGraphX() - this.hint.clientWidth / 2) + 'px';
            this.hint.style.top = (Math.max(me.getGraphY(), point.y) + this.state.view.graph.gridSize) + 'px';

            if (this.linkHint != null) {
                this.linkHint.style.display = 'none';
            }
        };

        /**
         * Updates the hint for the current operation.
         */
        mxEdgeHandler.prototype.removeHint = mxVertexHandler.prototype.removeHint;

        /**
         * Defines the handles for the UI. Uses data-URIs to speed-up loading time where supported.
         */
        // TODO: Increase handle padding
        HoverIcons.prototype.mainHandle = (!mxClient.IS_SVG) ? new mxImage(IMAGE_PATH + '/handle-main.png', 17, 17) :
            Graph.createSvgImage(18, 18, '<circle cx="9" cy="9" r="5" stroke="#fff" fill="' + HoverIcons.prototype.arrowFill + '" stroke-width="1"/>');
        HoverIcons.prototype.secondaryHandle = (!mxClient.IS_SVG) ? new mxImage(IMAGE_PATH + '/handle-secondary.png', 17, 17) :
            Graph.createSvgImage(16, 16, '<path d="m 8 3 L 13 8 L 8 13 L 3 8 z" stroke="#fff" fill="#fca000"/>');
        HoverIcons.prototype.fixedHandle = (!mxClient.IS_SVG) ? new mxImage(IMAGE_PATH + '/handle-fixed.png', 17, 17) :
            Graph.createSvgImage(18, 18, '<circle cx="9" cy="9" r="5" stroke="#fff" fill="' + HoverIcons.prototype.arrowFill + '" stroke-width="1"/><path d="m 7 7 L 11 11 M 7 11 L 11 7" stroke="#fff"/>');
        HoverIcons.prototype.terminalHandle = (!mxClient.IS_SVG) ? new mxImage(IMAGE_PATH + '/handle-terminal.png', 17, 17) :
            Graph.createSvgImage(18, 18, '<circle cx="9" cy="9" r="5" stroke="#fff" fill="' + HoverIcons.prototype.arrowFill + '" stroke-width="1"/><circle cx="9" cy="9" r="2" stroke="#fff" fill="transparent"/>');
        HoverIcons.prototype.rotationHandle = new mxImage((mxClient.IS_SVG) ? 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABMAAAAVCAYAAACkCdXRAAAACXBIWXMAAAsTAAALEwEAmpwYAAAKT2lDQ1BQaG90b3Nob3AgSUNDIHByb2ZpbGUAAHjanVNnVFPpFj333vRCS4iAlEtvUhUIIFJCi4AUkSYqIQkQSoghodkVUcERRUUEG8igiAOOjoCMFVEsDIoK2AfkIaKOg6OIisr74Xuja9a89+bN/rXXPues852zzwfACAyWSDNRNYAMqUIeEeCDx8TG4eQuQIEKJHAAEAizZCFz/SMBAPh+PDwrIsAHvgABeNMLCADATZvAMByH/w/qQplcAYCEAcB0kThLCIAUAEB6jkKmAEBGAYCdmCZTAKAEAGDLY2LjAFAtAGAnf+bTAICd+Jl7AQBblCEVAaCRACATZYhEAGg7AKzPVopFAFgwABRmS8Q5ANgtADBJV2ZIALC3AMDOEAuyAAgMADBRiIUpAAR7AGDIIyN4AISZABRG8lc88SuuEOcqAAB4mbI8uSQ5RYFbCC1xB1dXLh4ozkkXKxQ2YQJhmkAuwnmZGTKBNA/g88wAAKCRFRHgg/P9eM4Ors7ONo62Dl8t6r8G/yJiYuP+5c+rcEAAAOF0ftH+LC+zGoA7BoBt/qIl7gRoXgugdfeLZrIPQLUAoOnaV/Nw+H48PEWhkLnZ2eXk5NhKxEJbYcpXff5nwl/AV/1s+X48/Pf14L7iJIEyXYFHBPjgwsz0TKUcz5IJhGLc5o9H/LcL//wd0yLESWK5WCoU41EScY5EmozzMqUiiUKSKcUl0v9k4t8s+wM+3zUAsGo+AXuRLahdYwP2SycQWHTA4vcAAPK7b8HUKAgDgGiD4c93/+8//UegJQCAZkmScQAAXkQkLlTKsz/HCAAARKCBKrBBG/TBGCzABhzBBdzBC/xgNoRCJMTCQhBCCmSAHHJgKayCQiiGzbAdKmAv1EAdNMBRaIaTcA4uwlW4Dj1wD/phCJ7BKLyBCQRByAgTYSHaiAFiilgjjggXmYX4IcFIBBKLJCDJiBRRIkuRNUgxUopUIFVIHfI9cgI5h1xGupE7yAAygvyGvEcxlIGyUT3UDLVDuag3GoRGogvQZHQxmo8WoJvQcrQaPYw2oefQq2gP2o8+Q8cwwOgYBzPEbDAuxsNCsTgsCZNjy7EirAyrxhqwVqwDu4n1Y8+xdwQSgUXACTYEd0IgYR5BSFhMWE7YSKggHCQ0EdoJNwkDhFHCJyKTqEu0JroR+cQYYjIxh1hILCPWEo8TLxB7iEPENyQSiUMyJ7mQAkmxpFTSEtJG0m5SI+ksqZs0SBojk8naZGuyBzmULCAryIXkneTD5DPkG+Qh8lsKnWJAcaT4U+IoUspqShnlEOU05QZlmDJBVaOaUt2ooVQRNY9aQq2htlKvUYeoEzR1mjnNgxZJS6WtopXTGmgXaPdpr+h0uhHdlR5Ol9BX0svpR+iX6AP0dwwNhhWDx4hnKBmbGAcYZxl3GK+YTKYZ04sZx1QwNzHrmOeZD5lvVVgqtip8FZHKCpVKlSaVGyovVKmqpqreqgtV81XLVI+pXlN9rkZVM1PjqQnUlqtVqp1Q61MbU2epO6iHqmeob1Q/pH5Z/YkGWcNMw09DpFGgsV/jvMYgC2MZs3gsIWsNq4Z1gTXEJrHN2Xx2KruY/R27iz2qqaE5QzNKM1ezUvOUZj8H45hx+Jx0TgnnKKeX836K3hTvKeIpG6Y0TLkxZVxrqpaXllirSKtRq0frvTau7aedpr1Fu1n7gQ5Bx0onXCdHZ4/OBZ3nU9lT3acKpxZNPTr1ri6qa6UbobtEd79up+6Ynr5egJ5Mb6feeb3n+hx9L/1U/W36p/VHDFgGswwkBtsMzhg8xTVxbzwdL8fb8VFDXcNAQ6VhlWGX4YSRudE8o9VGjUYPjGnGXOMk423GbcajJgYmISZLTepN7ppSTbmmKaY7TDtMx83MzaLN1pk1mz0x1zLnm+eb15vft2BaeFostqi2uGVJsuRaplnutrxuhVo5WaVYVVpds0atna0l1rutu6cRp7lOk06rntZnw7Dxtsm2qbcZsOXYBtuutm22fWFnYhdnt8Wuw+6TvZN9un2N/T0HDYfZDqsdWh1+c7RyFDpWOt6azpzuP33F9JbpL2dYzxDP2DPjthPLKcRpnVOb00dnF2e5c4PziIuJS4LLLpc+Lpsbxt3IveRKdPVxXeF60vWdm7Obwu2o26/uNu5p7ofcn8w0nymeWTNz0MPIQ+BR5dE/C5+VMGvfrH5PQ0+BZ7XnIy9jL5FXrdewt6V3qvdh7xc+9j5yn+M+4zw33jLeWV/MN8C3yLfLT8Nvnl+F30N/I/9k/3r/0QCngCUBZwOJgUGBWwL7+Hp8Ib+OPzrbZfay2e1BjKC5QRVBj4KtguXBrSFoyOyQrSH355jOkc5pDoVQfujW0Adh5mGLw34MJ4WHhVeGP45wiFga0TGXNXfR3ENz30T6RJZE3ptnMU85ry1KNSo+qi5qPNo3ujS6P8YuZlnM1VidWElsSxw5LiquNm5svt/87fOH4p3iC+N7F5gvyF1weaHOwvSFpxapLhIsOpZATIhOOJTwQRAqqBaMJfITdyWOCnnCHcJnIi/RNtGI2ENcKh5O8kgqTXqS7JG8NXkkxTOlLOW5hCepkLxMDUzdmzqeFpp2IG0yPTq9MYOSkZBxQqohTZO2Z+pn5mZ2y6xlhbL+xW6Lty8elQfJa7OQrAVZLQq2QqboVFoo1yoHsmdlV2a/zYnKOZarnivN7cyzytuQN5zvn//tEsIS4ZK2pYZLVy0dWOa9rGo5sjxxedsK4xUFK4ZWBqw8uIq2Km3VT6vtV5eufr0mek1rgV7ByoLBtQFr6wtVCuWFfevc1+1dT1gvWd+1YfqGnRs+FYmKrhTbF5cVf9go3HjlG4dvyr+Z3JS0qavEuWTPZtJm6ebeLZ5bDpaql+aXDm4N2dq0Dd9WtO319kXbL5fNKNu7g7ZDuaO/PLi8ZafJzs07P1SkVPRU+lQ27tLdtWHX+G7R7ht7vPY07NXbW7z3/T7JvttVAVVN1WbVZftJ+7P3P66Jqun4lvttXa1ObXHtxwPSA/0HIw6217nU1R3SPVRSj9Yr60cOxx++/p3vdy0NNg1VjZzG4iNwRHnk6fcJ3/ceDTradox7rOEH0x92HWcdL2pCmvKaRptTmvtbYlu6T8w+0dbq3nr8R9sfD5w0PFl5SvNUyWna6YLTk2fyz4ydlZ19fi753GDborZ752PO32oPb++6EHTh0kX/i+c7vDvOXPK4dPKy2+UTV7hXmq86X23qdOo8/pPTT8e7nLuarrlca7nuer21e2b36RueN87d9L158Rb/1tWeOT3dvfN6b/fF9/XfFt1+cif9zsu72Xcn7q28T7xf9EDtQdlD3YfVP1v+3Njv3H9qwHeg89HcR/cGhYPP/pH1jw9DBY+Zj8uGDYbrnjg+OTniP3L96fynQ89kzyaeF/6i/suuFxYvfvjV69fO0ZjRoZfyl5O/bXyl/erA6xmv28bCxh6+yXgzMV70VvvtwXfcdx3vo98PT+R8IH8o/2j5sfVT0Kf7kxmTk/8EA5jz/GMzLdsAAAAgY0hSTQAAeiUAAICDAAD5/wAAgOkAAHUwAADqYAAAOpgAABdvkl/FRgAAA6ZJREFUeNqM001IY1cUB/D/fYmm2sbR2lC1zYlgoRG6MpEyBlpxM9iFIGKFIm3s0lCKjOByhCLZCFqLBF1YFVJdSRbdFHRhBbULtRuFVBTzYRpJgo2mY5OX5N9Fo2TG+eiFA/dd3vvd8+65ByTxshARTdf1JySp6/oTEdFe9T5eg5lIcnBwkCSZyWS+exX40oyur68/KxaLf5Okw+H4X+A9JBaLfUySZ2dnnJqaosPhIAACeC34DJRKpb7IZrMcHx+nwWCgUopGo/EOKwf9fn/1CzERUevr6+9ls1mOjIwQAH0+H4PBIKPR6D2ofAQCgToRUeVYJUkuLy8TANfW1kiS8/PzCy84Mw4MDBAAZ2dnmc/nub+/X0MSEBF1cHDwMJVKsaGhgV6vl+l0mqOjo1+KyKfl1dze3l4NBoM/PZ+diFSLiIKIGBOJxA9bW1sEwNXVVSaTyQMRaRaRxrOzs+9J8ujoaE5EPhQRq67rcZ/PRwD0+/3Udf03EdEgIqZisZibnJykwWDg4eEhd3Z2xkXELCJvPpdBrYjUiEhL+Xo4HH4sIhUaAKNSqiIcDsNkMqG+vh6RSOQQQM7tdhsAQCkFAHC73UUATxcWFqypVApmsxnDw8OwWq2TADQNgAYAFosF+XweyWQSdru9BUBxcXFRB/4rEgDcPouIIx6P4+bmBi0tLSCpAzBqAIqnp6c/dnZ2IpfLYXNzE62traMADACKNputpr+/v8lms9UAKAAwiMjXe3t7KBQKqKurQy6Xi6K0i2l6evpROp1mbW0t29vbGY/Hb8/IVIqq2zlJXl1dsaOjg2azmefn5wwEAl+JSBVExCgi75PkzMwMlVJsbGxkIpFgPp8PX15ePopEIs3JZPITXdf/iEajbGpqolKKExMT1HWdHo/nIxGpgIgoEXnQ3d39kCTHxsYIgC6Xi3NzcwyHw8xkMozFYlxaWmJbWxuVUuzt7WUul6PX6/1cRN4WEe2uA0SkaWVl5XGpRVhdXU0A1DSNlZWVdz3qdDrZ09PDWCzG4+Pjn0XEWvp9KJKw2WwKwBsA3gHQHAqFfr24uMDGxgZ2d3cRiUQAAHa7HU6nE319fTg5Ofmlq6vrGwB/AngaCoWK6rbsNptNA1AJoA7Aux6Pp3NoaMhjsVg+QNmIRqO/u1yubwFEASRKUAEA7rASqABUAKgC8KAUb5XWCOAfAFcA/gJwDSB7C93DylCtdM8qABhLc5TumV6KQigUeubjfwcAHkQJ94ndWeYAAAAASUVORK5CYII=' :
            IMAGE_PATH + '/handle-rotate.png', 19, 21);

        if (mxClient.IS_SVG) {
            mxConstraintHandler.prototype.pointImage = Graph.createSvgImage(5, 5, '<path d="m 0 0 L 5 5 M 0 5 L 5 0" stroke="' + HoverIcons.prototype.arrowFill + '"/>');
        }

        mxVertexHandler.prototype.handleImage = HoverIcons.prototype.mainHandle;
        mxVertexHandler.prototype.secondaryHandleImage = HoverIcons.prototype.secondaryHandle;
        mxEdgeHandler.prototype.handleImage = HoverIcons.prototype.mainHandle;
        mxEdgeHandler.prototype.terminalHandleImage = HoverIcons.prototype.terminalHandle;
        mxEdgeHandler.prototype.fixedHandleImage = HoverIcons.prototype.fixedHandle;
        mxEdgeHandler.prototype.labelHandleImage = HoverIcons.prototype.secondaryHandle;
        mxOutline.prototype.sizerImage = HoverIcons.prototype.mainHandle;

        if (window.Sidebar != null) {
            Sidebar.prototype.triangleUp = HoverIcons.prototype.triangleUp;
            Sidebar.prototype.triangleRight = HoverIcons.prototype.triangleRight;
            Sidebar.prototype.triangleDown = HoverIcons.prototype.triangleDown;
            Sidebar.prototype.triangleLeft = HoverIcons.prototype.triangleLeft;
            Sidebar.prototype.refreshTarget = HoverIcons.prototype.refreshTarget;
            Sidebar.prototype.roundDrop = HoverIcons.prototype.roundDrop;
        }

        // Pre-fetches images (only needed for non data-uris)
        if (!mxClient.IS_SVG) {
            new Image().src = HoverIcons.prototype.mainHandle.src;
            new Image().src = HoverIcons.prototype.fixedHandle.src;
            new Image().src = HoverIcons.prototype.terminalHandle.src;
            new Image().src = HoverIcons.prototype.secondaryHandle.src;
            new Image().src = HoverIcons.prototype.rotationHandle.src;

            new Image().src = HoverIcons.prototype.triangleUp.src;
            new Image().src = HoverIcons.prototype.triangleRight.src;
            new Image().src = HoverIcons.prototype.triangleDown.src;
            new Image().src = HoverIcons.prototype.triangleLeft.src;
            new Image().src = HoverIcons.prototype.refreshTarget.src;
            new Image().src = HoverIcons.prototype.roundDrop.src;
        }

        // Adds rotation handle and live preview
        mxVertexHandler.prototype.rotationEnabled = true;
        mxVertexHandler.prototype.manageSizers = true;
        mxVertexHandler.prototype.livePreview = true;

        // Increases default rubberband opacity (default is 20)
        mxRubberband.prototype.defaultOpacity = 30;

        // Enables connections along the outline, virtual waypoints, parent highlight etc
        mxConnectionHandler.prototype.outlineConnect = true;
        mxCellHighlight.prototype.keepOnTop = true;
        mxVertexHandler.prototype.parentHighlightEnabled = true;
        mxVertexHandler.prototype.rotationHandleVSpacing = -20;

        mxEdgeHandler.prototype.parentHighlightEnabled = true;
        mxEdgeHandler.prototype.dblClickRemoveEnabled = true;
        mxEdgeHandler.prototype.straightRemoveEnabled = true;
        mxEdgeHandler.prototype.virtualBendsEnabled = true;
        mxEdgeHandler.prototype.mergeRemoveEnabled = true;
        mxEdgeHandler.prototype.manageLabelHandle = true;
        mxEdgeHandler.prototype.outlineConnect = true;

        // Disables adding waypoints if shift is pressed
        mxEdgeHandler.prototype.isAddVirtualBendEvent = function (me) {
            return !mxEvent.isShiftDown(me.getEvent());
        };

        // Disables custom handles if shift is pressed
        mxEdgeHandler.prototype.isCustomHandleEvent = function (me) {
            return !mxEvent.isShiftDown(me.getEvent());
        };

        /**
         * Implements touch style
         */
        if (Graph.touchStyle) {
            // Larger tolerance for real touch devices
            if (mxClient.IS_TOUCH || navigator.maxTouchPoints > 0 || navigator.msMaxTouchPoints > 0) {
                mxShape.prototype.svgStrokeTolerance = 18;
                mxVertexHandler.prototype.tolerance = 12;
                mxEdgeHandler.prototype.tolerance = 12;
                Graph.prototype.tolerance = 12;

                mxVertexHandler.prototype.rotationHandleVSpacing = -24;

                // Implements a smaller tolerance for mouse events and a larger tolerance for touch
                // events on touch devices. The default tolerance (4px) is used for mouse events.
                mxConstraintHandler.prototype.getTolerance = function (me) {
                    return (mxEvent.isMouseEvent(me.getEvent())) ? 4 : this.graph.getTolerance();
                };
            }

            // One finger pans (no rubberband selection) must start regardless of mouse button
            mxPanningHandler.prototype.isPanningTrigger = function (me) {
                var evt = me.getEvent();

                return (me.getState() == null && !mxEvent.isMouseEvent(evt)) ||
                    (mxEvent.isPopupTrigger(evt) && (me.getState() == null ||
                        mxEvent.isControlDown(evt) || mxEvent.isShiftDown(evt)));
            };

            // Don't clear selection if multiple cells selected
            var graphHandlerMouseDown = mxGraphHandler.prototype.mouseDown;
            mxGraphHandler.prototype.mouseDown = function (sender, me) {
                graphHandlerMouseDown.apply(this, arguments);

                if (mxEvent.isTouchEvent(me.getEvent()) && this.graph.isCellSelected(me.getCell()) &&
                    this.graph.getSelectionCount() > 1) {
                    this.delayedSelection = false;
                }
            };
        } else {
            // Removes ctrl+shift as panning trigger for space splitting
            mxPanningHandler.prototype.isPanningTrigger = function (me) {
                var evt = me.getEvent();

                return (mxEvent.isLeftMouseButton(evt) && ((this.useLeftButtonForPanning &&
                    me.getState() == null) || (mxEvent.isControlDown(evt) &&
                    !mxEvent.isShiftDown(evt)))) || (this.usePopupTrigger &&
                    mxEvent.isPopupTrigger(evt));
            };
        }

        // Overrides/extends rubberband for space handling with Ctrl+Shift(+Alt) drag ("scissors tool")
        mxRubberband.prototype.isSpaceEvent = function (me) {
            return this.graph.isEnabled() && !this.graph.isCellLocked(this.graph.getDefaultParent()) &&
                mxEvent.isControlDown(me.getEvent()) && mxEvent.isShiftDown(me.getEvent());
        };

        // Handles moving of cells in both half panes
        mxRubberband.prototype.mouseUp = function (sender, me) {
            var execute = this.div != null && this.div.style.display != 'none';

            var x0 = null;
            var y0 = null;
            var dx = null;
            var dy = null;

            if (this.first != null && this.currentX != null && this.currentY != null) {
                x0 = this.first.x;
                y0 = this.first.y;
                dx = (this.currentX - x0) / this.graph.view.scale;
                dy = (this.currentY - y0) / this.graph.view.scale;

                if (!mxEvent.isAltDown(me.getEvent())) {
                    dx = this.graph.snap(dx);
                    dy = this.graph.snap(dy);

                    if (!this.graph.isGridEnabled()) {
                        if (Math.abs(dx) < this.graph.tolerance) {
                            dx = 0;
                        }

                        if (Math.abs(dy) < this.graph.tolerance) {
                            dy = 0;
                        }
                    }
                }
            }

            this.reset();

            if (execute) {
                if (mxEvent.isAltDown(me.getEvent()) && this.graph.isToggleEvent(me.getEvent())) {
                    var rect = new mxRectangle(this.x, this.y, this.width, this.height);
                    var cells = this.graph.getCells(rect.x, rect.y, rect.width, rect.height);

                    this.graph.removeSelectionCells(cells);
                } else if (this.isSpaceEvent(me)) {
                    this.graph.model.beginUpdate();
                    try {
                        var cells = this.graph.getCellsBeyond(x0, y0, this.graph.getDefaultParent(), true, true);

                        for (var i = 0; i < cells.length; i++) {
                            if (this.graph.isCellMovable(cells[i])) {
                                var tmp = this.graph.view.getState(cells[i]);
                                var geo = this.graph.getCellGeometry(cells[i]);

                                if (tmp != null && geo != null) {
                                    geo = geo.clone();
                                    geo.translate(dx, dy);
                                    this.graph.model.setGeometry(cells[i], geo);
                                }
                            }
                        }
                    } finally {
                        this.graph.model.endUpdate();
                    }
                } else {
                    var rect = new mxRectangle(this.x, this.y, this.width, this.height);
                    this.graph.selectRegion(rect, me.getEvent());
                }

                me.consume();
            }
        };

        // Handles preview for creating/removing space in diagram
        mxRubberband.prototype.mouseMove = function (sender, me) {
            if (!me.isConsumed() && this.first != null) {
                var origin = mxUtils.getScrollOrigin(this.graph.container);
                var offset = mxUtils.getOffset(this.graph.container);
                origin.x -= offset.x;
                origin.y -= offset.y;
                var x = me.getX() + origin.x;
                var y = me.getY() + origin.y;
                var dx = this.first.x - x;
                var dy = this.first.y - y;
                var tol = this.graph.tolerance;

                if (this.div != null || Math.abs(dx) > tol || Math.abs(dy) > tol) {
                    if (this.div == null) {
                        this.div = this.createShape();
                    }

                    // Clears selection while rubberbanding. This is required because
                    // the event is not consumed in mouseDown.
                    mxUtils.clearSelection();
                    this.update(x, y);

                    if (this.isSpaceEvent(me)) {
                        var right = this.x + this.width;
                        var bottom = this.y + this.height;
                        var scale = this.graph.view.scale;

                        if (!mxEvent.isAltDown(me.getEvent())) {
                            this.width = this.graph.snap(this.width / scale) * scale;
                            this.height = this.graph.snap(this.height / scale) * scale;

                            if (!this.graph.isGridEnabled()) {
                                if (this.width < this.graph.tolerance) {
                                    this.width = 0;
                                }

                                if (this.height < this.graph.tolerance) {
                                    this.height = 0;
                                }
                            }

                            if (this.x < this.first.x) {
                                this.x = right - this.width;
                            }

                            if (this.y < this.first.y) {
                                this.y = bottom - this.height;
                            }
                        }

                        this.div.style.borderStyle = 'dashed';
                        this.div.style.backgroundColor = 'white';
                        this.div.style.left = this.x + 'px';
                        this.div.style.top = this.y + 'px';
                        this.div.style.width = Math.max(0, this.width) + 'px';
                        this.div.style.height = this.graph.container.clientHeight + 'px';
                        this.div.style.borderWidth = (this.width <= 0) ? '0px 1px 0px 0px' : '0px 1px 0px 1px';

                        if (this.secondDiv == null) {
                            this.secondDiv = this.div.cloneNode(true);
                            this.div.parentNode.appendChild(this.secondDiv);
                        }

                        this.secondDiv.style.left = this.x + 'px';
                        this.secondDiv.style.top = this.y + 'px';
                        this.secondDiv.style.width = this.graph.container.clientWidth + 'px';
                        this.secondDiv.style.height = Math.max(0, this.height) + 'px';
                        this.secondDiv.style.borderWidth = (this.height <= 0) ? '1px 0px 0px 0px' : '1px 0px 1px 0px';
                    } else {
                        // Hides second div and restores style
                        this.div.style.backgroundColor = '';
                        this.div.style.borderWidth = '';
                        this.div.style.borderStyle = '';

                        if (this.secondDiv != null) {
                            this.secondDiv.parentNode.removeChild(this.secondDiv);
                            this.secondDiv = null;
                        }
                    }

                    me.consume();
                }
            }
        };

        // Removes preview
        var mxRubberbandReset = mxRubberband.prototype.reset;
        mxRubberband.prototype.reset = function () {
            if (this.secondDiv != null) {
                this.secondDiv.parentNode.removeChild(this.secondDiv);
                this.secondDiv = null;
            }

            mxRubberbandReset.apply(this, arguments);
        };

        // Timer-based activation of outline connect in connection handler
        var startTime = new Date().getTime();
        var timeOnTarget = 0;

        var mxEdgeHandlerUpdatePreviewState = mxEdgeHandler.prototype.updatePreviewState;

        mxEdgeHandler.prototype.updatePreviewState = function (edge, point, terminalState, me) {
            mxEdgeHandlerUpdatePreviewState.apply(this, arguments);

            if (terminalState != this.currentTerminalState) {
                startTime = new Date().getTime();
                timeOnTarget = 0;
            } else {
                timeOnTarget = new Date().getTime() - startTime;
            }

            this.currentTerminalState = terminalState;
        };

        // Timer-based outline connect
        var mxEdgeHandlerIsOutlineConnectEvent = mxEdgeHandler.prototype.isOutlineConnectEvent;

        mxEdgeHandler.prototype.isOutlineConnectEvent = function (me) {
            return (this.currentTerminalState != null && me.getState() == this.currentTerminalState && timeOnTarget > 2000) ||
                ((this.currentTerminalState == null || mxUtils.getValue(this.currentTerminalState.style, 'outlineConnect', '1') != '0') &&
                    mxEdgeHandlerIsOutlineConnectEvent.apply(this, arguments));
        };

        // Disables custom handles if shift is pressed
        mxVertexHandler.prototype.isCustomHandleEvent = function (me) {
            return !mxEvent.isShiftDown(me.getEvent());
        };

        // Shows secondary handle for fixed connection points
        mxEdgeHandler.prototype.createHandleShape = function (index, virtual) {
            var source = index != null && index == 0;
            var terminalState = this.state.getVisibleTerminalState(source);
            var c = (index != null && (index == 0 || index >= this.state.absolutePoints.length - 1 ||
                (this.constructor == mxElbowEdgeHandler && index == 2))) ?
                this.graph.getConnectionConstraint(this.state, terminalState, source) : null;
            var pt = (c != null) ? this.graph.getConnectionPoint(this.state.getVisibleTerminalState(source), c) : null;
            var img = (pt != null) ? this.fixedHandleImage : ((c != null && terminalState != null) ?
                this.terminalHandleImage : this.handleImage);

            if (img != null) {
                var shape = new mxImageShape(new mxRectangle(0, 0, img.width, img.height), img.src);

                // Allows HTML rendering of the images
                shape.preserveImageAspect = false;

                return shape;
            } else {
                var s = mxConstants.HANDLE_SIZE;

                if (this.preferHtml) {
                    s -= 1;
                }

                return new mxRectangleShape(new mxRectangle(0, 0, s, s), mxConstants.HANDLE_FILLCOLOR, mxConstants.HANDLE_STROKECOLOR);
            }
        };

        var vertexHandlerCreateSizerShape = mxVertexHandler.prototype.createSizerShape;
        mxVertexHandler.prototype.createSizerShape = function (bounds, index, fillColor) {
            this.handleImage = (index == mxEvent.ROTATION_HANDLE) ? HoverIcons.prototype.rotationHandle : (index == mxEvent.LABEL_HANDLE) ? this.secondaryHandleImage : this.handleImage;

            return vertexHandlerCreateSizerShape.apply(this, arguments);
        };

        // Special case for single edge label handle moving in which case the text bounding box is used
        var mxGraphHandlerGetBoundingBox = mxGraphHandler.prototype.getBoundingBox;
        mxGraphHandler.prototype.getBoundingBox = function (cells) {
            if (cells != null && cells.length == 1) {
                var model = this.graph.getModel();
                var parent = model.getParent(cells[0]);
                var geo = this.graph.getCellGeometry(cells[0]);

                if (model.isEdge(parent) && geo != null && geo.relative) {
                    var state = this.graph.view.getState(cells[0]);

                    if (state != null && state.width < 2 && state.height < 2 && state.text != null && state.text.boundingBox != null) {
                        return mxRectangle.fromRectangle(state.text.boundingBox);
                    }
                }
            }

            return mxGraphHandlerGetBoundingBox.apply(this, arguments);
        };

        // Uses text bounding box for edge labels
        var mxVertexHandlerGetSelectionBounds = mxVertexHandler.prototype.getSelectionBounds;
        mxVertexHandler.prototype.getSelectionBounds = function (state) {
            var model = this.graph.getModel();
            var parent = model.getParent(state.cell);
            var geo = this.graph.getCellGeometry(state.cell);

            if (model.isEdge(parent) && geo != null && geo.relative && state.width < 2 && state.height < 2 && state.text != null && state.text.boundingBox != null) {
                var bbox = state.text.unrotatedBoundingBox || state.text.boundingBox;

                return new mxRectangle(Math.round(bbox.x), Math.round(bbox.y), Math.round(bbox.width), Math.round(bbox.height));
            } else {
                return mxVertexHandlerGetSelectionBounds.apply(this, arguments);
            }
        };

        // Redirects moving of edge labels to mxGraphHandler by not starting here.
        // This will use the move preview of mxGraphHandler (see above).
        var mxVertexHandlerMouseDown = mxVertexHandler.prototype.mouseDown;
        mxVertexHandler.prototype.mouseDown = function (sender, me) {
            var model = this.graph.getModel();
            var parent = model.getParent(this.state.cell);
            var geo = this.graph.getCellGeometry(this.state.cell);

            // Lets rotation events through
            var handle = this.getHandleForEvent(me);

            if (handle == mxEvent.ROTATION_HANDLE || !model.isEdge(parent) || geo == null || !geo.relative ||
                this.state == null || this.state.width >= 2 || this.state.height >= 2) {
                mxVertexHandlerMouseDown.apply(this, arguments);
            }
        };

        // Shows rotation handle for edge labels.
        mxVertexHandler.prototype.isRotationHandleVisible = function () {
            return this.graph.isEnabled() && this.rotationEnabled && this.graph.isCellRotatable(this.state.cell) &&
                (mxGraphHandler.prototype.maxCells <= 0 || this.graph.getSelectionCount() < mxGraphHandler.prototype.maxCells);
        };

        // Invokes turn on single click on rotation handle
        mxVertexHandler.prototype.rotateClick = function () {
            this.state.view.graph.turnShapes([this.state.cell]);
        };

        var vertexHandlerMouseMove = mxVertexHandler.prototype.mouseMove;

        // Workaround for "isConsumed not defined" in MS Edge is to use arguments
        mxVertexHandler.prototype.mouseMove = function (sender, me) {
            vertexHandlerMouseMove.apply(this, arguments);

            if (this.graph.graphHandler.first != null) {
                if (this.rotationShape != null && this.rotationShape.node != null) {
                    this.rotationShape.node.style.display = 'none';
                }

                if (this.linkHint != null && this.linkHint.style.display != 'none') {
                    this.linkHint.style.display = 'none';
                }
            }
        };

        var vertexHandlerMouseUp = mxVertexHandler.prototype.mouseUp;

        mxVertexHandler.prototype.mouseUp = function (sender, me) {
            vertexHandlerMouseUp.apply(this, arguments);

            // Shows rotation handle only if one vertex is selected
            if (this.rotationShape != null && this.rotationShape.node != null) {
                this.rotationShape.node.style.display = (this.graph.getSelectionCount() == 1) ? '' : 'none';
            }

            if (this.linkHint != null && this.linkHint.style.display == 'none') {
                this.linkHint.style.display = '';
            }
        };

        var vertexHandlerInit = mxVertexHandler.prototype.init;
        mxVertexHandler.prototype.init = function () {
            vertexHandlerInit.apply(this, arguments);
            var redraw = false;

            if (this.rotationShape != null) {
                this.rotationShape.node.setAttribute('title', mxResources.get('rotateTooltip'));
            }

            var update = mxUtils.bind(this, function () {
                // Shows rotation handle only if one vertex is selected
                if (this.rotationShape != null && this.rotationShape.node != null) {
                    this.rotationShape.node.style.display = (this.graph.getSelectionCount() == 1) ? '' : 'none';
                }

                if (this.specialHandle != null) {
                    this.specialHandle.node.style.display = (this.graph.isEnabled() && this.graph.getSelectionCount() < this.graph.graphHandler.maxCells) ? '' : 'none';
                }

                this.redrawHandles();
            });

            this.changeHandler = mxUtils.bind(this, function (sender, evt) {
                this.updateLinkHint(this.graph.getLinkForCell(this.state.cell),
                    this.graph.getLinksForState(this.state));
                update();
            });

            this.graph.getSelectionModel().addListener(mxEvent.CHANGE, this.changeHandler);
            this.graph.getModel().addListener(mxEvent.CHANGE, this.changeHandler);

            // Repaint needed when editing stops and no change event is fired
            this.editingHandler = mxUtils.bind(this, function (sender, evt) {
                this.redrawHandles();
            });

            this.graph.addListener(mxEvent.EDITING_STOPPED, this.editingHandler);

            var link = this.graph.getLinkForCell(this.state.cell);
            var links = this.graph.getLinksForState(this.state);
            this.updateLinkHint(link, links);

            if (link != null || (links != null && links.length > 0)) {
                redraw = true;
            }

            if (redraw) {
                this.redrawHandles();
            }
        };

        mxVertexHandler.prototype.updateLinkHint = function (link, links) {
            if ((link == null && (links == null || links.length == 0)) ||
                this.graph.getSelectionCount() > 1) {
                if (this.linkHint != null) {
                    this.linkHint.parentNode.removeChild(this.linkHint);
                    this.linkHint = null;
                }
            } else if (link != null || (links != null && links.length > 0)) {
                if (this.linkHint == null) {
                    this.linkHint = createHint();
                    this.linkHint.style.padding = '6px 8px 6px 8px';
                    this.linkHint.style.opacity = '1';
                    this.linkHint.style.filter = '';

                    this.graph.container.appendChild(this.linkHint);
                }

                this.linkHint.innerHTML = '';

                if (link != null) {
                    this.linkHint.appendChild(this.graph.createLinkForHint(link));

                    if (this.graph.isEnabled() && typeof this.graph.editLink === 'function') {
                        var changeLink = document.createElement('img');
                        changeLink.setAttribute('src', Editor.editImage);
                        changeLink.setAttribute('title', mxResources.get('editLink'));
                        changeLink.setAttribute('width', '11');
                        changeLink.setAttribute('height', '11');
                        changeLink.style.marginLeft = '10px';
                        changeLink.style.marginBottom = '-1px';
                        changeLink.style.cursor = 'pointer';
                        this.linkHint.appendChild(changeLink);

                        mxEvent.addListener(changeLink, 'click', mxUtils.bind(this, function (evt) {
                            this.graph.setSelectionCell(this.state.cell);
                            this.graph.editLink();
                            mxEvent.consume(evt);
                        }));

                        var removeLink = document.createElement('img');
                        removeLink.setAttribute('src', Dialog.prototype.clearImage);
                        removeLink.setAttribute('title', mxResources.get('removeIt', [mxResources.get('link')]));
                        removeLink.setAttribute('width', '13');
                        removeLink.setAttribute('height', '10');
                        removeLink.style.marginLeft = '4px';
                        removeLink.style.marginBottom = '-1px';
                        removeLink.style.cursor = 'pointer';
                        this.linkHint.appendChild(removeLink);

                        mxEvent.addListener(removeLink, 'click', mxUtils.bind(this, function (evt) {
                            this.graph.setLinkForCell(this.state.cell, null);
                            mxEvent.consume(evt);
                        }));
                    }
                }

                if (links != null) {
                    for (var i = 0; i < links.length; i++) {
                        var div = document.createElement('div');
                        div.style.marginTop = (link != null || i > 0) ? '6px' : '0px';
                        div.appendChild(this.graph.createLinkForHint(
                            links[i].getAttribute('href'),
                            mxUtils.getTextContent(links[i])));

                        this.linkHint.appendChild(div);
                    }
                }
            }
        };

        mxEdgeHandler.prototype.updateLinkHint = mxVertexHandler.prototype.updateLinkHint;

        var edgeHandlerInit = mxEdgeHandler.prototype.init;
        mxEdgeHandler.prototype.init = function () {
            edgeHandlerInit.apply(this, arguments);

            // Disables connection points
            this.constraintHandler.isEnabled = mxUtils.bind(this, function () {
                return this.state.view.graph.connectionHandler.isEnabled();
            });

            var update = mxUtils.bind(this, function () {
                if (this.linkHint != null) {
                    this.linkHint.style.display = (this.graph.getSelectionCount() == 1) ? '' : 'none';
                }

                if (this.labelShape != null) {
                    this.labelShape.node.style.display = (this.graph.isEnabled() && this.graph.getSelectionCount() < this.graph.graphHandler.maxCells) ? '' : 'none';
                }
            });

            this.changeHandler = mxUtils.bind(this, function (sender, evt) {
                this.updateLinkHint(this.graph.getLinkForCell(this.state.cell),
                    this.graph.getLinksForState(this.state));
                update();
                this.redrawHandles();
            });

            this.graph.getSelectionModel().addListener(mxEvent.CHANGE, this.changeHandler);
            this.graph.getModel().addListener(mxEvent.CHANGE, this.changeHandler);

            var link = this.graph.getLinkForCell(this.state.cell);
            var links = this.graph.getLinksForState(this.state);

            if (link != null || (links != null && links.length > 0)) {
                this.updateLinkHint(link, links);
                this.redrawHandles();
            }
        };

        // Disables connection points
        var connectionHandlerInit = mxConnectionHandler.prototype.init;

        mxConnectionHandler.prototype.init = function () {
            connectionHandlerInit.apply(this, arguments);

            this.constraintHandler.isEnabled = mxUtils.bind(this, function () {
                return this.graph.connectionHandler.isEnabled();
            });
        };

        var vertexHandlerRedrawHandles = mxVertexHandler.prototype.redrawHandles;
        mxVertexHandler.prototype.redrawHandles = function () {
            vertexHandlerRedrawHandles.apply(this);

            if (this.state != null && this.linkHint != null) {
                var c = new mxPoint(this.state.getCenterX(), this.state.getCenterY());
                var tmp = new mxRectangle(this.state.x, this.state.y - 22, this.state.width + 24, this.state.height + 22);
                var bb = mxUtils.getBoundingBox(tmp, this.state.style[mxConstants.STYLE_ROTATION] || '0', c);
                var rs = (bb != null) ? mxUtils.getBoundingBox(this.state,
                    this.state.style[mxConstants.STYLE_ROTATION] || '0') : this.state;
                var tb = (this.state.text != null) ? this.state.text.boundingBox : null;

                if (bb == null) {
                    bb = this.state;
                }

                var b = bb.y + bb.height;

                if (tb != null) {
                    b = Math.max(b, tb.y + tb.height);
                }

                this.linkHint.style.left = Math.max(0, Math.round(rs.x + (rs.width - this.linkHint.clientWidth) / 2)) + 'px';
                this.linkHint.style.top = Math.round(b + this.verticalOffset / 2 + 6 +
                    this.state.view.graph.tolerance) + 'px';
            }
        };


        var vertexHandlerReset = mxVertexHandler.prototype.reset;
        mxVertexHandler.prototype.reset = function () {
            vertexHandlerReset.apply(this, arguments);

            // Shows rotation handle only if one vertex is selected
            if (this.rotationShape != null && this.rotationShape.node != null) {
                this.rotationShape.node.style.display = (this.graph.getSelectionCount() == 1) ? '' : 'none';
            }
        };

        var vertexHandlerDestroy = mxVertexHandler.prototype.destroy;
        mxVertexHandler.prototype.destroy = function () {
            vertexHandlerDestroy.apply(this, arguments);

            if (this.linkHint != null) {
                this.linkHint.parentNode.removeChild(this.linkHint);
                this.linkHint = null;
            }

            if (this.changeHandler != null) {
                this.graph.getSelectionModel().removeListener(this.changeHandler);
                this.graph.getModel().removeListener(this.changeHandler);
                this.changeHandler = null;
            }

            if (this.editingHandler != null) {
                this.graph.removeListener(this.editingHandler);
                this.editingHandler = null;
            }
        };

        var edgeHandlerRedrawHandles = mxEdgeHandler.prototype.redrawHandles;
        mxEdgeHandler.prototype.redrawHandles = function () {
            // Workaround for special case where handler
            // is reset before this which leads to a NPE
            if (this.marker != null) {
                edgeHandlerRedrawHandles.apply(this);

                if (this.state != null && this.linkHint != null) {
                    var b = this.state;

                    if (this.state.text != null && this.state.text.bounds != null) {
                        b = new mxRectangle(b.x, b.y, b.width, b.height);
                        b.add(this.state.text.bounds);
                    }

                    this.linkHint.style.left = Math.max(0, Math.round(b.x + (b.width - this.linkHint.clientWidth) / 2)) + 'px';
                    this.linkHint.style.top = Math.round(b.y + b.height + 6 + this.state.view.graph.tolerance) + 'px';
                }
            }
        };

        var edgeHandlerReset = mxEdgeHandler.prototype.reset;
        mxEdgeHandler.prototype.reset = function () {
            edgeHandlerReset.apply(this, arguments);

            if (this.linkHint != null) {
                this.linkHint.style.visibility = '';
            }
        };

        var edgeHandlerDestroy = mxEdgeHandler.prototype.destroy;
        mxEdgeHandler.prototype.destroy = function () {
            edgeHandlerDestroy.apply(this, arguments);

            if (this.linkHint != null) {
                this.linkHint.parentNode.removeChild(this.linkHint);
                this.linkHint = null;
            }

            if (this.changeHandler != null) {
                this.graph.getModel().removeListener(this.changeHandler);
                this.graph.getSelectionModel().removeListener(this.changeHandler);
                this.changeHandler = null;
            }
        };
    })();
}

/**
 * Copyright (c) 2006-2012, JGraph Ltd
 */
Format = function (editorUi, container) {
    this.editorUi = editorUi;
    this.container = container;
};

/**
 * Returns information about the current selection.
 */
Format.prototype.labelIndex = 0;

/**
 * Returns information about the current selection.
 */
Format.prototype.currentIndex = 0;

/**
 * Returns information about the current selection.
 */
Format.prototype.showCloseButton = true;

/**
 * Background color for inactive tabs.
 */
Format.prototype.inactiveTabBackgroundColor = '#f1f3f4';

/**
 * Background color for inactive tabs.
 */
Format.prototype.roundableShapes = ['label', 'rectangle', 'internalStorage', 'corner',
    'parallelogram', 'swimlane', 'triangle', 'trapezoid',
    'ext', 'step', 'tee', 'process', 'link',
    'rhombus', 'offPageConnector', 'loopLimit', 'hexagon',
    'manualInput', 'curlyBracket', 'singleArrow', 'callout',
    'doubleArrow', 'flexArrow', 'card', 'umlLifeline'];

/**
 * Adds the label menu items to the given menu and parent.
 */
Format.prototype.init = function () {
    var ui = this.editorUi;
    var editor = ui.editor;
    var graph = editor.graph;

    this.update = mxUtils.bind(this, function (sender, evt) {
        this.clearSelectionState();
        this.refresh();
    });

    graph.getSelectionModel().addListener(mxEvent.CHANGE, this.update);
    graph.addListener(mxEvent.EDITING_STARTED, this.update);
    graph.addListener(mxEvent.EDITING_STOPPED, this.update);
    graph.getModel().addListener(mxEvent.CHANGE, this.update);
    graph.addListener(mxEvent.ROOT, mxUtils.bind(this, function () {
        this.refresh();
    }));

    editor.addListener('autosaveChanged', mxUtils.bind(this, function () {
        this.refresh();
    }));

    this.refresh();
};

/**
 * Returns information about the current selection.
 */
Format.prototype.clearSelectionState = function () {
    this.selectionState = null;
};

/**
 * Returns information about the current selection.
 */
Format.prototype.getSelectionState = function () {
    if (this.selectionState == null) {
        this.selectionState = this.createSelectionState();
    }

    return this.selectionState;
};

/**
 * Returns information about the current selection.
 */
Format.prototype.createSelectionState = function () {
    var cells = this.editorUi.editor.graph.getSelectionCells();
    var result = this.initSelectionState();

    for (var i = 0; i < cells.length; i++) {
        this.updateSelectionStateForCell(result, cells[i], cells);
    }

    return result;
};

/**
 * Returns information about the current selection.
 */
Format.prototype.initSelectionState = function () {
    return {
        vertices: [], edges: [], x: null, y: null, width: null, height: null, style: {},
        containsImage: false, containsLabel: false, fill: true, glass: true, rounded: true,
        comic: true, autoSize: false, image: true, shadow: true, lineJumps: true
    };
};

/**
 * Returns information about the current selection.
 */
Format.prototype.updateSelectionStateForCell = function (result, cell, cells) {
    var graph = this.editorUi.editor.graph;

    if (graph.getModel().isVertex(cell)) {
        result.vertices.push(cell);
        var geo = graph.getCellGeometry(cell);

        if (geo != null) {
            if (geo.width > 0) {
                if (result.width == null) {
                    result.width = geo.width;
                } else if (result.width != geo.width) {
                    result.width = '';
                }
            } else {
                result.containsLabel = true;
            }

            if (geo.height > 0) {
                if (result.height == null) {
                    result.height = geo.height;
                } else if (result.height != geo.height) {
                    result.height = '';
                }
            } else {
                result.containsLabel = true;
            }

            if (!geo.relative || geo.offset != null) {
                var x = (geo.relative) ? geo.offset.x : geo.x;
                var y = (geo.relative) ? geo.offset.y : geo.y;

                if (result.x == null) {
                    result.x = x;
                } else if (result.x != x) {
                    result.x = '';
                }

                if (result.y == null) {
                    result.y = y;
                } else if (result.y != y) {
                    result.y = '';
                }
            }
        }
    } else if (graph.getModel().isEdge(cell)) {
        result.edges.push(cell);
    }

    var state = graph.view.getState(cell);

    if (state != null) {
        result.autoSize = result.autoSize || this.isAutoSizeState(state);
        result.glass = result.glass && this.isGlassState(state);
        result.rounded = result.rounded && this.isRoundedState(state);
        result.lineJumps = result.lineJumps && this.isLineJumpState(state);
        result.comic = result.comic && this.isComicState(state);
        result.image = result.image && this.isImageState(state);
        result.shadow = result.shadow && this.isShadowState(state);
        result.fill = result.fill && this.isFillState(state);

        var shape = mxUtils.getValue(state.style, mxConstants.STYLE_SHAPE, null);
        result.containsImage = result.containsImage || shape == 'image';

        for (var key in state.style) {
            var value = state.style[key];

            if (value != null) {
                if (result.style[key] == null) {
                    result.style[key] = value;
                } else if (result.style[key] != value) {
                    result.style[key] = '';
                }
            }
        }
    }
};

/**
 * Returns information about the current selection.
 */
Format.prototype.isFillState = function (state) {
    return state.view.graph.model.isVertex(state.cell) ||
        mxUtils.getValue(state.style, mxConstants.STYLE_SHAPE, null) == 'arrow' ||
        mxUtils.getValue(state.style, mxConstants.STYLE_SHAPE, null) == 'filledEdge' ||
        mxUtils.getValue(state.style, mxConstants.STYLE_SHAPE, null) == 'flexArrow';
};

/**
 * Returns information about the current selection.
 */
Format.prototype.isGlassState = function (state) {
    var shape = mxUtils.getValue(state.style, mxConstants.STYLE_SHAPE, null);

    return (shape == 'label' || shape == 'rectangle' || shape == 'internalStorage' ||
        shape == 'ext' || shape == 'umlLifeline' || shape == 'swimlane' ||
        shape == 'process');
};

/**
 * Returns information about the current selection.
 */
Format.prototype.isRoundedState = function (state) {
    return (state.shape != null) ? state.shape.isRoundable() :
        mxUtils.indexOf(this.roundableShapes, mxUtils.getValue(state.style,
            mxConstants.STYLE_SHAPE, null)) >= 0;
};

/**
 * Returns information about the current selection.
 */
Format.prototype.isLineJumpState = function (state) {
    var shape = mxUtils.getValue(state.style, mxConstants.STYLE_SHAPE, null);
    var curved = mxUtils.getValue(state.style, mxConstants.STYLE_CURVED, false);

    return !curved && (shape == 'connector' || shape == 'filledEdge');
};

/**
 * Returns information about the current selection.
 */
Format.prototype.isComicState = function (state) {
    var shape = mxUtils.getValue(state.style, mxConstants.STYLE_SHAPE, null);

    return mxUtils.indexOf(['label', 'rectangle', 'internalStorage', 'corner', 'parallelogram', 'note', 'collate',
        'swimlane', 'triangle', 'trapezoid', 'ext', 'step', 'tee', 'process', 'link', 'rhombus',
        'offPageConnector', 'loopLimit', 'hexagon', 'manualInput', 'singleArrow', 'doubleArrow',
        'flexArrow', 'filledEdge', 'card', 'umlLifeline', 'connector', 'folder', 'component', 'sortShape',
        'cross', 'umlFrame', 'cube', 'isoCube', 'isoRectangle', 'partialRectangle'], shape) >= 0;
};

/**
 * Returns information about the current selection.
 */
Format.prototype.isAutoSizeState = function (state) {
    return mxUtils.getValue(state.style, mxConstants.STYLE_AUTOSIZE, null) == '1';
};

/**
 * Returns information about the current selection.
 */
Format.prototype.isImageState = function (state) {
    var shape = mxUtils.getValue(state.style, mxConstants.STYLE_SHAPE, null);

    return (shape == 'label' || shape == 'image');
};

/**
 * Returns information about the current selection.
 */
Format.prototype.isShadowState = function (state) {
    var shape = mxUtils.getValue(state.style, mxConstants.STYLE_SHAPE, null);

    return (shape != 'image');
};

/**
 * Adds the label menu items to the given menu and parent.
 */
Format.prototype.clear = function () {
    this.container.innerHTML = '';

    // Destroy existing panels
    if (this.panels != null) {
        for (var i = 0; i < this.panels.length; i++) {
            this.panels[i].destroy();
        }
    }

    this.panels = [];
};

/**
 * Adds the label menu items to the given menu and parent.
 */
Format.prototype.refresh = function () {
    // Performance tweak: No refresh needed if not visible
    if (this.container.style.width == '0px') {
        return;
    }

    this.clear();
    var ui = this.editorUi;
    var graph = ui.editor.graph;

    var div = document.createElement('div');
    div.style.whiteSpace = 'nowrap';
    div.style.color = 'rgb(112, 112, 112)';
    div.style.textAlign = 'left';
    div.style.cursor = 'default';

    var label = document.createElement('div');
    label.className = 'geFormatSection';
    label.style.textAlign = 'center';
    label.style.fontWeight = 'bold';
    label.style.paddingTop = '8px';
    label.style.fontSize = '13px';
    label.style.borderWidth = '0px 0px 1px 1px';
    label.style.borderStyle = 'solid';
    label.style.display = (mxClient.IS_QUIRKS) ? 'inline' : 'inline-block';
    label.style.height = (mxClient.IS_QUIRKS) ? '34px' : '25px';
    label.style.overflow = 'hidden';
    label.style.width = '100%';
    this.container.appendChild(div);

    // Prevents text selection
    mxEvent.addListener(label, (mxClient.IS_POINTER) ? 'pointerdown' : 'mousedown',
        mxUtils.bind(this, function (evt) {
            evt.preventDefault();
        }));

    if (graph.isSelectionEmpty()) {
        mxUtils.write(label, mxResources.get('diagram'));
        label.style.borderLeftWidth = '0px';

        // Adds button to hide the format panel since
        // people don't seem to find the toolbar button
        // and the menu item in the format menu
        if (this.showCloseButton) {
            var img = document.createElement('img');
            img.setAttribute('border', '0');
            img.setAttribute('src', Dialog.prototype.closeImage);
            img.setAttribute('title', mxResources.get('hide'));
            img.style.position = 'absolute';
            img.style.display = 'block';
            img.style.right = '0px';
            img.style.top = '8px';
            img.style.cursor = 'pointer';
            img.style.marginTop = '1px';
            img.style.marginRight = '17px';
            img.style.border = '1px solid transparent';
            img.style.padding = '1px';
            img.style.opacity = 0.5;
            label.appendChild(img)

            mxEvent.addListener(img, 'click', function () {
                ui.actions.get('formatPanel').funct();
            });
        }

        div.appendChild(label);
        this.panels.push(new DiagramFormatPanel(this, ui, div));
    } else if (graph.isEditing()) {
        mxUtils.write(label, mxResources.get('text'));
        div.appendChild(label);
        this.panels.push(new TextFormatPanel(this, ui, div));
    } else {
        var state = this.getSelectionState();
        var selectCells = graph.getSelectionCells();

        var containsLabel = this.getSelectionState().containsLabel;
        var currentLabel = null;
        var currentPanel = null;

        var addClickHandler = mxUtils.bind(this, function (elt, panel, index) {
            var clickHandler = mxUtils.bind(this, function (evt) {
                if (currentLabel != elt) {
                    if (containsLabel) {
                        this.labelIndex = index;
                    } else {
                        this.currentIndex = index;
                    }

                    if (currentLabel != null) {
                        currentLabel.style.backgroundColor = this.inactiveTabBackgroundColor;
                        currentLabel.style.borderBottomWidth = '1px';
                    }

                    currentLabel = elt;
                    currentLabel.style.backgroundColor = '';
                    currentLabel.style.borderBottomWidth = '0px';

                    if (currentPanel != panel) {
                        if (currentPanel != null) {
                            currentPanel.style.display = 'none';
                        }

                        currentPanel = panel;
                        currentPanel.style.display = '';
                    }
                }
            });

            mxEvent.addListener(elt, 'click', clickHandler);

            // Prevents text selection
            mxEvent.addListener(elt, (mxClient.IS_POINTER) ? 'pointerdown' : 'mousedown',
                mxUtils.bind(this, function (evt) {
                    evt.preventDefault();
                }));

            if (index == ((containsLabel) ? this.labelIndex : this.currentIndex)) {
                // Invokes handler directly as a workaround for no click on DIV in KHTML.
                clickHandler();
            }
        });

        var idx = 0;

        label.style.backgroundColor = this.inactiveTabBackgroundColor;
        label.style.borderLeftWidth = '1px';
        label.style.cursor = 'pointer';
        if (selectCells.length == 1) {
            label.style.width = (containsLabel) ? '33.3%' : '25.0%';
        } else {
            label.style.width = '33.3%';
        }
        var label2 = label.cloneNode(false);
        var label3 = label2.cloneNode(false);

        // Workaround for ignored background in IE
        label2.style.backgroundColor = this.inactiveTabBackgroundColor;
        label3.style.backgroundColor = this.inactiveTabBackgroundColor;

        // Style
        if (containsLabel) {
            label2.style.borderLeftWidth = '0px';
        } else {
            label.style.borderLeftWidth = '0px';
            mxUtils.write(label, mxResources.get('style'));
            div.appendChild(label);

            var stylePanel = div.cloneNode(false);
            stylePanel.style.display = 'none';
            this.panels.push(new StyleFormatPanel(this, ui, stylePanel));
            this.container.appendChild(stylePanel);

            addClickHandler(label, stylePanel, idx++);
        }

        // Text
        mxUtils.write(label2, mxResources.get('text'));
        div.appendChild(label2);

        var textPanel = div.cloneNode(false);
        textPanel.style.display = 'none';
        this.panels.push(new TextFormatPanel(this, ui, textPanel));
        this.container.appendChild(textPanel);

        // Arrange
        mxUtils.write(label3, mxResources.get('arrange'));
        div.appendChild(label3);

        var arrangePanel = div.cloneNode(false);
        arrangePanel.style.display = 'none';
        this.panels.push(new ArrangePanel(this, ui, arrangePanel));
        this.container.appendChild(arrangePanel);

        //Aric.chen. data panel
        /*label4*/ // cell多选时,隐藏数据panel
        if (selectCells.length == 1) {
            var label4 = label2.cloneNode(false);
            mxUtils.write(label4, '数据');
            label4.style.backgroundColor = this.inactiveTabBackgroundColor;
            div.appendChild(label4);
            var dataPanel = div.cloneNode(false);
            dataPanel.style.display = 'none';
            this.panels.push(new DataPanel(this, ui, dataPanel));
            this.container.appendChild(dataPanel);
            addClickHandler(label4, dataPanel, idx++);
        }
        addClickHandler(label2, textPanel, idx++);
        addClickHandler(label3, arrangePanel, idx++);
    }
};

/**
 * Base class for format panels.
 */
BaseFormatPanel = function (format, editorUi, container) {
    this.format = format;
    this.editorUi = editorUi;
    this.container = container;
    this.listeners = [];
};

/**
 *
 */
BaseFormatPanel.prototype.buttonBackgroundColor = 'white';

/**
 * Adds the given color option.
 */
BaseFormatPanel.prototype.getSelectionState = function () {
    var graph = this.editorUi.editor.graph;
    var cells = graph.getSelectionCells();
    var shape = null;

    for (var i = 0; i < cells.length; i++) {
        var state = graph.view.getState(cells[i]);

        if (state != null) {
            var tmp = mxUtils.getValue(state.style, mxConstants.STYLE_SHAPE, null);

            if (tmp != null) {
                if (shape == null) {
                    shape = tmp;
                } else if (shape != tmp) {
                    return null;
                }
            }

        }
    }

    return shape;
};

/**
 * Install input handler.
 */
BaseFormatPanel.prototype.installInputHandler = function (input, key, defaultValue, min, max, unit, textEditFallback, isFloat) {
    unit = (unit != null) ? unit : '';
    isFloat = (isFloat != null) ? isFloat : false;

    var ui = this.editorUi;
    var graph = ui.editor.graph;

    min = (min != null) ? min : 1;
    max = (max != null) ? max : 999;

    var selState = null;
    var updating = false;

    var update = mxUtils.bind(this, function (evt) {
        var value = (isFloat) ? parseFloat(input.value) : parseInt(input.value);

        // Special case: angle mod 360
        if (!isNaN(value) && key == mxConstants.STYLE_ROTATION) {
            // Workaround for decimal rounding errors in floats is to
            // use integer and round all numbers to two decimal point
            value = mxUtils.mod(Math.round(value * 100), 36000) / 100;
        }

        value = Math.min(max, Math.max(min, (isNaN(value)) ? defaultValue : value));
        if (graph.cellEditor.isContentEditing() && textEditFallback) {
            if (!updating) {
                updating = true;

                if (selState != null) {
                    graph.cellEditor.restoreSelection(selState);
                    selState = null;
                }

                textEditFallback(value);
                input.value = value + unit;

                // Restore focus and selection in input
                updating = false;
            }
        } else if (value != mxUtils.getValue(this.format.getSelectionState().style, key, defaultValue)) {
            if (graph.isEditing()) {
                graph.stopEditing(true);
            }
            graph.getModel().beginUpdate();
            try {
                var state = this.format.getSelectionState();
                var tag2 = mxUtils.getValue(state.style, 'tag2');
                // 如果不是array里面的组件则重新渲染
                var array = ["timeline", "dashboard", "linechart",];
                if (_.indexOf(array, tag2) === -1) {
                    graph.setCellStyles(key, value, graph.getSelectionCells());
                    // Handles special case for fontSize where HTML labels are parsed and updated
                    if (key == mxConstants.STYLE_FONTSIZE) {
                        graph.updateLabelElements(graph.getSelectionCells(), function (elt) {
                            elt.style.fontSize = value + 'px';
                            elt.removeAttribute('size');
                        });
                    }
                    ui.fireEvent(new mxEventObject('styleChanged', 'keys', [key],
                        'values', [value], 'cells', graph.getSelectionCells()));
                    neptuneHandler.fontSize(_.first(graph.getSelectionCells()), value);
                }
            } finally {
                graph.getModel().endUpdate();
            }
        }

        input.value = value + unit;
        mxEvent.consume(evt);
    });

    if (textEditFallback && graph.cellEditor.isContentEditing()) {
        // KNOWN: Arrow up/down clear selection text in quirks/IE 8
        // Text size via arrow button limits to 16 in IE11. Why?
        mxEvent.addListener(input, 'mousedown', function () {
            if (document.activeElement == graph.cellEditor.textarea) {
                selState = graph.cellEditor.saveSelection();
            }
        });

        mxEvent.addListener(input, 'touchstart', function () {
            if (document.activeElement == graph.cellEditor.textarea) {
                selState = graph.cellEditor.saveSelection();
            }
        });
    }

    mxEvent.addListener(input, 'change', update);
    mxEvent.addListener(input, 'blur', update);

    return update;
};

/**
 * Adds the given option.
 */
BaseFormatPanel.prototype.createPanel = function () {
    var div = document.createElement('div');
    div.className = 'geFormatSection';
    div.style.padding = '12px 0px 12px 18px';

    return div;
};

/**
 * Adds the given option.
 */
BaseFormatPanel.prototype.createTitle = function (title) {
    var div = document.createElement('div');
    div.style.padding = '0px 0px 6px 0px';
    div.style.whiteSpace = 'nowrap';
    div.style.overflow = 'hidden';
    div.style.width = '200px';
    div.style.fontWeight = 'bold';
    mxUtils.write(div, title);

    return div;
};

/**
 *
 */
BaseFormatPanel.prototype.createStepper = function (input, update, step, height, disableFocus, defaultValue, isFloat) {
    var graph = this.editorUi.editor.graph;
    var state = this.format.getSelectionState();

    var selectCells = graph.getSelectionCells();
    var selectCell = _.first(selectCells);

    step = (step != null) ? step : 1;
    height = (height != null) ? height : 8;

    if (mxClient.IS_QUIRKS) {
        height = height - 2;
    } else if (mxClient.IS_MT || document.documentMode >= 8) {
        height = height + 1;
    }

    var stepper = document.createElement('div');
    mxUtils.setPrefixedStyle(stepper.style, 'borderRadius', '3px');
    stepper.style.border = '1px solid rgb(192, 192, 192)';
    stepper.style.position = 'absolute';

    var up = document.createElement('div');
    up.style.borderBottom = '1px solid rgb(192, 192, 192)';
    up.style.position = 'relative';
    up.style.height = height + 'px';
    up.style.width = '10px';
    up.className = 'geBtnUp';
    stepper.appendChild(up);

    var down = up.cloneNode(false);
    down.style.border = 'none';
    down.style.height = height + 'px';
    down.className = 'geBtnDown';
    stepper.appendChild(down);

    mxEvent.addListener(down, 'click', function (evt) {
        if (input.value == '') {
            input.value = defaultValue || '2';
        }

        var val = isFloat ? parseFloat(input.value) : parseInt(input.value);

        if (!isNaN(val)) {
            input.value = val - step;

            if (update != null) {
                update(evt);
            }
        }

        mxEvent.consume(evt);
    });

    mxEvent.addListener(up, 'click', function (evt) {
        if (input.value == '') {
            input.value = defaultValue || '0';
        }

        var val = isFloat ? parseFloat(input.value) : parseInt(input.value);

        if (!isNaN(val)) {
            input.value = val + step;

            if (update != null) {
                update(evt);
            }
        }

        mxEvent.consume(evt);
    });

    // Disables transfer of focus to DIV but also :active CSS
    // so it's only used for fontSize where the focus should
    // stay on the selected text, but not for any other input.
    if (disableFocus) {
        var currentSelection = null;

        mxEvent.addGestureListeners(stepper,
            function (evt) {
                // Workaround for lost current selection in page because of focus in IE
                if (mxClient.IS_QUIRKS || document.documentMode == 8) {
                    currentSelection = document.selection.createRange();
                }

                mxEvent.consume(evt);
            },
            null,
            function (evt) {
                // Workaround for lost current selection in page because of focus in IE
                if (currentSelection != null) {
                    try {
                        currentSelection.select();
                    } catch (e) {
                        // ignore
                    }

                    currentSelection = null;
                    mxEvent.consume(evt);
                }
            }
        );
    }

    return stepper;
};

/**
 * Adds the given option.
 */
BaseFormatPanel.prototype.createOption = function (label, isCheckedFn, setCheckedFn, listener) {
    var div = document.createElement('div');
    div.style.padding = '6px 0px 1px 0px';
    div.style.whiteSpace = 'nowrap';
    div.style.overflow = 'hidden';
    div.style.width = '200px';
    div.style.height = (mxClient.IS_QUIRKS) ? '27px' : '18px';

    var cb = document.createElement('input');
    cb.setAttribute('type', 'checkbox');
    cb.style.margin = '0px 6px 0px 0px';
    div.appendChild(cb);

    var span = document.createElement('span');
    mxUtils.write(span, label);
    div.appendChild(span);

    var applying = false;
    var value = isCheckedFn();

    var apply = function (newValue) {
        if (!applying) {
            applying = true;

            if (newValue) {
                cb.setAttribute('checked', 'checked');
                cb.defaultChecked = true;
                cb.checked = true;
            } else {
                cb.removeAttribute('checked');
                cb.defaultChecked = false;
                cb.checked = false;
            }

            if (value != newValue) {
                value = newValue;

                // Checks if the color value needs to be updated in the model
                if (isCheckedFn() != value) {
                    setCheckedFn(value);
                }
            }

            applying = false;
        }
    };

    mxEvent.addListener(div, 'click', function (evt) {
        if (cb.getAttribute('disabled') != 'disabled') {
            // Toggles checkbox state for click on label
            var source = mxEvent.getSource(evt);

            if (source == div || source == span) {
                cb.checked = !cb.checked;
            }

            apply(cb.checked);
        }
    });

    apply(value);

    if (listener != null) {
        listener.install(apply);
        this.listeners.push(listener);
    }

    return div;
};

/**
 * The string 'null' means use null in values.
 */
BaseFormatPanel.prototype.createCellOption = function (label, key, defaultValue, enabledValue, disabledValue, fn, action, stopEditing) {
    enabledValue = (enabledValue != null) ? ((enabledValue == 'null') ? null : enabledValue) : '1';
    disabledValue = (disabledValue != null) ? ((disabledValue == 'null') ? null : disabledValue) : '0';

    var ui = this.editorUi;
    var editor = ui.editor;
    var graph = editor.graph;

    return this.createOption(label, function () {
            // Seems to be null sometimes, not sure why...
            var state = graph.view.getState(graph.getSelectionCell());

            if (state != null) {
                return mxUtils.getValue(state.style, key, defaultValue) != disabledValue;
            }

            return null;
        }, function (checked) {
            if (stopEditing) {
                graph.stopEditing();
            }

            if (action != null) {
                action.funct();
            } else {
                graph.getModel().beginUpdate();
                try {
                    var value = (checked) ? enabledValue : disabledValue;
                    graph.setCellStyles(key, value, graph.getSelectionCells());

                    if (fn != null) {
                        fn(graph.getSelectionCells(), value);
                    }

                    ui.fireEvent(new mxEventObject('styleChanged', 'keys', [key],
                        'values', [value], 'cells', graph.getSelectionCells()));
                } finally {
                    graph.getModel().endUpdate();
                }
            }
        },
        {
            install: function (apply) {
                this.listener = function () {
                    // Seems to be null sometimes, not sure why...
                    var state = graph.view.getState(graph.getSelectionCell());

                    if (state != null) {
                        apply(mxUtils.getValue(state.style, key, defaultValue) != disabledValue);
                    }
                };

                graph.getModel().addListener(mxEvent.CHANGE, this.listener);
            },
            destroy: function () {
                graph.getModel().removeListener(this.listener);
            }
        });
};

/**
 * Adds the given color option.
 */
BaseFormatPanel.prototype.createColorOption = function (label, getColorFn, setColorFn, defaultColor, listener, callbackFn, hideCheckbox) {
    var div = document.createElement('div');
    div.style.padding = '6px 0px 1px 0px';
    div.style.whiteSpace = 'nowrap';
    div.style.overflow = 'hidden';
    div.style.width = '200px';
    div.style.height = (mxClient.IS_QUIRKS) ? '27px' : '18px';

    var cb = document.createElement('input');
    cb.setAttribute('type', 'checkbox');
    cb.style.margin = '0px 6px 0px 0px';

    if (!hideCheckbox) {
        div.appendChild(cb);
    }

    var span = document.createElement('span');
    mxUtils.write(span, label);
    div.appendChild(span);

    var value = getColorFn();
    var applying = false;
    var btn = null;

    var apply = function (color, disableUpdate, forceUpdate) {
        if (!applying) {
            applying = true;
            color = (/(^#?[a-zA-Z0-9]*$)/.test(color)) ? color : defaultColor;
            btn.innerHTML = '<div style="width:' + ((mxClient.IS_QUIRKS) ? '30' : '36') +
                'px;height:12px;margin:3px;border:1px solid black;background-color:' +
                mxUtils.htmlEntities((color != null && color != mxConstants.NONE) ?
                    color : defaultColor) + ';"></div>';

            // Fine-tuning in Firefox, quirks mode and IE8 standards
            if (mxClient.IS_QUIRKS || document.documentMode == 8) {
                btn.firstChild.style.margin = '0px';
            }

            if (color != null && color != mxConstants.NONE) {
                cb.setAttribute('checked', 'checked');
                cb.defaultChecked = true;
                cb.checked = true;
            } else {
                cb.removeAttribute('checked');
                cb.defaultChecked = false;
                cb.checked = false;
            }

            btn.style.display = (cb.checked || hideCheckbox) ? '' : 'none';

            if (callbackFn != null) {
                callbackFn(color);
            }

            if (!disableUpdate) {
                value = color;

                // Checks if the color value needs to be updated in the model
                if (forceUpdate || hideCheckbox || getColorFn() != value) {
                    setColorFn(value);
                }
            }

            applying = false;
        }
    };

    btn = mxUtils.button('', mxUtils.bind(this, function (evt) {
        this.editorUi.pickColor(value, function (color) {
            apply(color, null, true);
        });
        mxEvent.consume(evt);
    }));

    btn.style.position = 'absolute';
    btn.style.marginTop = '-4px';
    btn.style.right = (mxClient.IS_QUIRKS) ? '0px' : '20px';
    btn.style.height = '22px';
    btn.className = 'geColorBtn';
    btn.style.display = (cb.checked || hideCheckbox) ? '' : 'none';
    div.appendChild(btn);

    mxEvent.addListener(div, 'click', function (evt) {
        var source = mxEvent.getSource(evt);

        if (source == cb || source.nodeName != 'INPUT') {
            // Toggles checkbox state for click on label
            if (source != cb) {
                cb.checked = !cb.checked;
            }

            // Overrides default value with current value to make it easier
            // to restore previous value if the checkbox is clicked twice
            if (!cb.checked && value != null && value != mxConstants.NONE &&
                defaultColor != mxConstants.NONE) {
                defaultColor = value;
            }

            apply((cb.checked) ? defaultColor : mxConstants.NONE);
        }
    });

    apply(value, true);

    if (listener != null) {
        listener.install(apply);
        this.listeners.push(listener);
    }

    return div;
};

/**
 *
 */
BaseFormatPanel.prototype.createCellColorOption = function (label, colorKey, defaultColor, callbackFn, setStyleFn) {
    var ui = this.editorUi;
    var editor = ui.editor;
    var graph = editor.graph;

    return this.createColorOption(label, function () {
            // Seems to be null sometimes, not sure why...
            var state = graph.view.getState(graph.getSelectionCell());

            if (state != null) {
                return mxUtils.getValue(state.style, colorKey, null);
            }

            return null;
        }, function (color) {
            graph.getModel().beginUpdate();
            try {
                if (setStyleFn != null) {
                    setStyleFn(color);
                }

                graph.setCellStyles(colorKey, color, graph.getSelectionCells());
                ui.fireEvent(new mxEventObject('styleChanged', 'keys', [colorKey],
                    'values', [color], 'cells', graph.getSelectionCells()));
            } finally {
                graph.getModel().endUpdate();
            }
        }, defaultColor || mxConstants.NONE,
        {
            install: function (apply) {
                this.listener = function () {
                    // Seems to be null sometimes, not sure why...
                    var state = graph.view.getState(graph.getSelectionCell());

                    if (state != null) {
                        apply(mxUtils.getValue(state.style, colorKey, null));
                    }
                };

                graph.getModel().addListener(mxEvent.CHANGE, this.listener);
            },
            destroy: function () {
                graph.getModel().removeListener(this.listener);
            }
        }, callbackFn);
};

/**
 *
 */
BaseFormatPanel.prototype.addArrow = function (elt, height) {
    height = (height != null) ? height : 10;

    var arrow = document.createElement('div');
    arrow.style.display = (mxClient.IS_QUIRKS) ? 'inline' : 'inline-block';
    arrow.style.padding = '6px';
    arrow.style.paddingRight = '4px';

    var m = (10 - height);

    if (m == 2) {
        arrow.style.paddingTop = 6 + 'px';
    } else if (m > 0) {
        arrow.style.paddingTop = (6 - m) + 'px';
    } else {
        arrow.style.marginTop = '-2px';
    }

    arrow.style.height = height + 'px';
    arrow.style.borderLeft = '1px solid #a0a0a0';
    arrow.innerHTML = '<img border="0" src="' + ((mxClient.IS_SVG) ? 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAYAAACNMs+9AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAHBJREFUeNpidHB2ZyAGsACxDRBPIKCuA6TwCBB/h2rABu4A8SYmKCcXiP/iUFgAxL9gCi8A8SwsirZCMQMTkmANEH9E4v+CmsaArvAdyNFI/FlQ92EoBIE+qCRIUz168DBgsU4OqhinQpgHMABAgAEALY4XLIsJ20oAAAAASUVORK5CYII=' :
        IMAGE_PATH + '/dropdown.png') + '" style="margin-bottom:4px;">';
    mxUtils.setOpacity(arrow, 70);

    var symbol = elt.getElementsByTagName('div')[0];

    if (symbol != null) {
        symbol.style.paddingRight = '6px';
        symbol.style.marginLeft = '4px';
        symbol.style.marginTop = '-1px';
        symbol.style.display = (mxClient.IS_QUIRKS) ? 'inline' : 'inline-block';
        mxUtils.setOpacity(symbol, 60);
    }

    mxUtils.setOpacity(elt, 100);
    elt.style.border = '1px solid #a0a0a0';
    elt.style.backgroundColor = this.buttonBackgroundColor;
    elt.style.backgroundImage = 'none';
    elt.style.width = 'auto';
    elt.className += ' geColorBtn';
    mxUtils.setPrefixedStyle(elt.style, 'borderRadius', '3px');

    elt.appendChild(arrow);

    return symbol;
};

/**
 *
 */
BaseFormatPanel.prototype.addUnitInput = function (container, unit, right, width, update, step, marginTop, disableFocus, isFloat) {
    marginTop = (marginTop != null) ? marginTop : 0;

    var input = document.createElement('input');
    input.style.position = 'absolute';
    input.style.textAlign = 'right';
    input.style.marginTop = '-2px';
    input.style.right = (right + 12) + 'px';
    input.style.width = width + 'px';
    container.appendChild(input);

    var stepper = this.createStepper(input, update, step, null, disableFocus, null, isFloat);
    stepper.style.marginTop = (marginTop - 2) + 'px';
    stepper.style.right = right + 'px';
    container.appendChild(stepper);

    return input;
};

/**
 *
 */
BaseFormatPanel.prototype.createRelativeOption = function (label, key, width, handler, init) {
    width = (width != null) ? width : 44;

    var graph = this.editorUi.editor.graph;
    var div = this.createPanel();
    div.style.paddingTop = '10px';
    div.style.paddingBottom = '10px';
    mxUtils.write(div, label);
    div.style.fontWeight = 'bold';

    var update = mxUtils.bind(this, function (evt) {
        if (handler != null) {
            handler(input);
        } else {
            var value = parseInt(input.value);
            value = Math.min(100, Math.max(0, (isNaN(value)) ? 100 : value));
            var state = graph.view.getState(graph.getSelectionCell());

            if (state != null && value != mxUtils.getValue(state.style, key, 100)) {
                // Removes entry in style (assumes 100 is default for relative values)
                if (value == 100) {
                    value = null;
                }

                graph.setCellStyles(key, value, graph.getSelectionCells());
                this.editorUi.fireEvent(new mxEventObject('styleChanged', 'keys', [key],
                    'values', [value], 'cells', graph.getSelectionCells()));
            }

            input.value = ((value != null) ? value : '100') + ' %';
        }

        mxEvent.consume(evt);
    });

    var input = this.addUnitInput(div, '%', 20, width, update, 10, -15, handler != null);

    if (key != null) {
        var listener = mxUtils.bind(this, function (sender, evt, force) {
            if (force || input != document.activeElement) {
                var ss = this.format.getSelectionState();
                var tmp = parseInt(mxUtils.getValue(ss.style, key, 100));
                input.value = (isNaN(tmp)) ? '' : tmp + ' %';
            }
        });

        mxEvent.addListener(input, 'keydown', function (e) {
            if (e.keyCode == 13) {
                graph.container.focus();
                mxEvent.consume(e);
            } else if (e.keyCode == 27) {
                listener(null, null, true);
                graph.container.focus();
                mxEvent.consume(e);
            }
        });

        graph.getModel().addListener(mxEvent.CHANGE, listener);
        this.listeners.push({
            destroy: function () {
                graph.getModel().removeListener(listener);
            }
        });
        listener();
    }

    mxEvent.addListener(input, 'blur', update);
    mxEvent.addListener(input, 'change', update);

    if (init != null) {
        init(input);
    }

    return div;
};

/**
 *
 */
BaseFormatPanel.prototype.addLabel = function (div, title, right, width) {
    width = (width != null) ? width : 61;

    var label = document.createElement('div');
    mxUtils.write(label, title);
    label.style.position = 'absolute';
    label.style.right = right + 'px';
    label.style.width = width + 'px';
    label.style.marginTop = '6px';
    label.style.textAlign = 'center';
    div.appendChild(label);
};

/**
 *
 */
BaseFormatPanel.prototype.addKeyHandler = function (input, listener) {
    mxEvent.addListener(input, 'keydown', mxUtils.bind(this, function (e) {
        if (e.keyCode == 13) {
            this.editorUi.editor.graph.container.focus();
            mxEvent.consume(e);
        } else if (e.keyCode == 27) {
            if (listener != null) {
                listener(null, null, true);
            }

            this.editorUi.editor.graph.container.focus();
            mxEvent.consume(e);
        }
    }));
};

/**
 *
 */
BaseFormatPanel.prototype.styleButtons = function (elts) {
    for (var i = 0; i < elts.length; i++) {
        mxUtils.setPrefixedStyle(elts[i].style, 'borderRadius', '3px');
        mxUtils.setOpacity(elts[i], 100);
        elts[i].style.border = '1px solid #a0a0a0';
        elts[i].style.padding = '4px';
        elts[i].style.paddingTop = '3px';
        elts[i].style.paddingRight = '1px';
        elts[i].style.margin = '1px';
        elts[i].style.width = '24px';
        elts[i].style.height = '20px';
        elts[i].className += ' geColorBtn';
    }
};

/**
 * Adds the label menu items to the given menu and parent.
 */
BaseFormatPanel.prototype.destroy = function () {
    if (this.listeners != null) {
        for (var i = 0; i < this.listeners.length; i++) {
            this.listeners[i].destroy();
        }

        this.listeners = null;
    }
};

/**
 * Adds the label menu items to the given menu and parent.
 */
ArrangePanel = function (format, editorUi, container) {
    BaseFormatPanel.call(this, format, editorUi, container);
    this.init();
};

mxUtils.extend(ArrangePanel, BaseFormatPanel);

/**
 * Adds the label menu items to the given menu and parent.
 */
ArrangePanel.prototype.init = function () {
    var graph = this.editorUi.editor.graph;
    var ss = this.format.getSelectionState();

    // Special case that adds two panels
    this.addGeometry(this.container);
    this.addEdgeGeometry(this.container);

    if (!ss.containsLabel || ss.edges.length == 0) {
        this.container.appendChild(this.addAngle(this.createPanel()));
    }

    if (!ss.containsLabel && ss.edges.length == 0) {
        this.container.appendChild(this.addFlip(this.createPanel()));
    }

    if (ss.vertices.length > 1) {
        this.container.appendChild(this.addAlign(this.createPanel()));
        this.container.appendChild(this.addDistribute(this.createPanel()));
    }

    this.container.appendChild(this.addGroupOps(this.createPanel()));

    if (ss.containsLabel) {
        // Adds functions from hidden style format panel
        var span = document.createElement('div');
        span.style.width = '100%';
        span.style.marginTop = '0px';
        span.style.fontWeight = 'bold';
        span.style.padding = '10px 0 0 18px';
        mxUtils.write(span, mxResources.get('style'));
        this.container.appendChild(span);

        new StyleFormatPanel(this.format, this.editorUi, this.container);
    }
};
/**
 *
 */
ArrangePanel.prototype.addGroupOps = function (div) {
    var ui = this.editorUi;
    var graph = ui.editor.graph;
    var cell = graph.getSelectionCell();
    var ss = this.format.getSelectionState();
    var count = 0;
    var btn = null;

    div.style.paddingTop = '8px';
    div.style.paddingBottom = '6px';

    if (graph.getSelectionCount() > 1) {
        btn = mxUtils.button(mxResources.get('group'), function (evt) {
            ui.actions.get('group').funct();
        })

        btn.setAttribute('title', mxResources.get('group') + ' (' + this.editorUi.actions.get('group').shortcut + ')');
        btn.style.width = '202px';
        btn.style.marginBottom = '2px';
        div.appendChild(btn);
        count++;
    } else if (graph.getSelectionCount() == 1 && !graph.getModel().isEdge(cell) && !graph.isSwimlane(cell) &&
        graph.getModel().getChildCount(cell) > 0) {
        btn = mxUtils.button(mxResources.get('ungroup'), function (evt) {
            ui.actions.get('ungroup').funct();
        })

        btn.setAttribute('title', mxResources.get('ungroup') + ' (' +
            this.editorUi.actions.get('ungroup').shortcut + ')');
        btn.style.width = '202px';
        btn.style.marginBottom = '2px';
        div.appendChild(btn);
        count++;
    }

    if (ss.vertices.length > 0) {
        if (count > 0) {
            mxUtils.br(div);
            count = 0;
        }

        var btn = mxUtils.button(mxResources.get('copySize'), function (evt) {
            ui.actions.get('copySize').funct();
        });

        btn.setAttribute('title', mxResources.get('copySize') + ' (' +
            this.editorUi.actions.get('copySize').shortcut + ')');
        btn.style.width = '202px';
        btn.style.marginBottom = '2px';

        div.appendChild(btn);
        count++;

        if (ui.copiedSize != null) {
            var btn2 = mxUtils.button(mxResources.get('pasteSize'), function (evt) {
                ui.actions.get('pasteSize').funct();
            });

            btn2.setAttribute('title', mxResources.get('pasteSize') + ' (' +
                this.editorUi.actions.get('pasteSize').shortcut + ')');

            div.appendChild(btn2);
            count++;

            btn.style.width = '100px';
            btn.style.marginBottom = '2px';
            btn2.style.width = '100px';
            btn2.style.marginBottom = '2px';
        }
    }

    if (graph.getSelectionCount() == 1 && graph.getModel().isVertex(cell) &&
        graph.getModel().isVertex(graph.getModel().getParent(cell))) {
        if (count > 0) {
            mxUtils.br(div);
        }

        btn = mxUtils.button(mxResources.get('removeFromGroup'), function (evt) {
            ui.actions.get('removeFromGroup').funct();
        })

        btn.setAttribute('title', mxResources.get('removeFromGroup'));
        btn.style.width = '202px';
        btn.style.marginBottom = '2px';
        div.appendChild(btn);
        count++;
    } else if (graph.getSelectionCount() > 0) {

    }

    if (graph.getSelectionCount() == 1) {
        if (count > 0) {
            mxUtils.br(div);
        }

        btn = mxUtils.button(mxResources.get('editData'), mxUtils.bind(this, function (evt) {
            this.editorUi.actions.get('editData').funct();
        }));

        btn.setAttribute('title', mxResources.get('editData') + ' (' + this.editorUi.actions.get('editData').shortcut + ')');
        btn.style.width = '100px';
        btn.style.marginBottom = '2px';
        div.appendChild(btn);
        count++;

        btn = mxUtils.button(mxResources.get('editLink'), mxUtils.bind(this, function (evt) {
            this.editorUi.actions.get('editLink').funct();
        }));

        btn.setAttribute('title', mxResources.get('editLink'));
        btn.style.width = '100px';
        btn.style.marginLeft = '2px';
        btn.style.marginBottom = '2px';
        div.appendChild(btn);
        count++;
    }

    if (count == 0) {
        div.style.display = 'none';
    }

    return div;
};

/**
 *
 */
ArrangePanel.prototype.addAlign = function (div) {
    var graph = this.editorUi.editor.graph;
    div.style.paddingTop = '6px';
    div.style.paddingBottom = '12px';
    div.appendChild(this.createTitle(mxResources.get('align')));

    var stylePanel = document.createElement('div');
    stylePanel.style.position = 'relative';
    stylePanel.style.paddingLeft = '0px';
    stylePanel.style.borderWidth = '0px';
    stylePanel.className = 'geToolbarContainer';

    if (mxClient.IS_QUIRKS) {
        div.style.height = '60px';
    }

    var left = this.editorUi.toolbar.addButton('geSprite-alignleft', mxResources.get('left'),
        function () {
            graph.alignCells(mxConstants.ALIGN_LEFT);
        }, stylePanel);
    var center = this.editorUi.toolbar.addButton('geSprite-aligncenter', mxResources.get('center'),
        function () {
            graph.alignCells(mxConstants.ALIGN_CENTER);
        }, stylePanel);
    var right = this.editorUi.toolbar.addButton('geSprite-alignright', mxResources.get('right'),
        function () {
            graph.alignCells(mxConstants.ALIGN_RIGHT);
        }, stylePanel);

    var top = this.editorUi.toolbar.addButton('geSprite-aligntop', mxResources.get('top'),
        function () {
            graph.alignCells(mxConstants.ALIGN_TOP);
        }, stylePanel);
    var middle = this.editorUi.toolbar.addButton('geSprite-alignmiddle', mxResources.get('middle'),
        function () {
            graph.alignCells(mxConstants.ALIGN_MIDDLE);
        }, stylePanel);
    var bottom = this.editorUi.toolbar.addButton('geSprite-alignbottom', mxResources.get('bottom'),
        function () {
            graph.alignCells(mxConstants.ALIGN_BOTTOM);
        }, stylePanel);

    this.styleButtons([left, center, right, top, middle, bottom]);
    right.style.marginRight = '6px';
    div.appendChild(stylePanel);

    return div;
};

/**
 *
 */
ArrangePanel.prototype.addFlip = function (div) {
    var ui = this.editorUi;
    var editor = ui.editor;
    var graph = editor.graph;
    div.style.paddingTop = '6px';
    div.style.paddingBottom = '10px';

    var span = document.createElement('div');
    span.style.marginTop = '2px';
    span.style.marginBottom = '8px';
    span.style.fontWeight = 'bold';
    mxUtils.write(span, mxResources.get('flip'));
    div.appendChild(span);

    var btn = mxUtils.button(mxResources.get('horizontal'), function (evt) {
        graph.toggleCellStyles(mxConstants.STYLE_FLIPH, false);
    })

    btn.setAttribute('title', mxResources.get('horizontal'));
    btn.style.width = '100px';
    btn.style.marginRight = '2px';
    div.appendChild(btn);

    var btn = mxUtils.button(mxResources.get('vertical'), function (evt) {
        graph.toggleCellStyles(mxConstants.STYLE_FLIPV, false);
    })

    btn.setAttribute('title', mxResources.get('vertical'));
    btn.style.width = '100px';
    div.appendChild(btn);

    return div;
};

/**
 *
 */
ArrangePanel.prototype.addDistribute = function (div) {
    var ui = this.editorUi;
    var editor = ui.editor;
    var graph = editor.graph;
    div.style.paddingTop = '6px';
    div.style.paddingBottom = '12px';

    div.appendChild(this.createTitle(mxResources.get('distribute')));

    var btn = mxUtils.button(mxResources.get('horizontal'), function (evt) {
        graph.distributeCells(true);
    })

    btn.setAttribute('title', mxResources.get('horizontal'));
    btn.style.width = '100px';
    btn.style.marginRight = '2px';
    div.appendChild(btn);

    var btn = mxUtils.button(mxResources.get('vertical'), function (evt) {
        graph.distributeCells(false);
    })

    btn.setAttribute('title', mxResources.get('vertical'));
    btn.style.width = '100px';
    div.appendChild(btn);

    return div;
};

/**
 *
 */
ArrangePanel.prototype.addAngle = function (div) {
    var ui = this.editorUi;
    var editor = ui.editor;
    var graph = editor.graph;
    var ss = this.format.getSelectionState();

    div.style.paddingBottom = '8px';

    var span = document.createElement('div');
    span.style.position = 'absolute';
    span.style.width = '70px';
    span.style.marginTop = '0px';
    span.style.fontWeight = 'bold';

    var input = null;
    var update = null;
    var btn = null;

    if (ss.edges.length == 0) {
        mxUtils.write(span, mxResources.get('angle'));
        div.appendChild(span);

        input = this.addUnitInput(div, '°', 20, 44, function () {
            update.apply(this, arguments);
        });

        mxUtils.br(div);
        div.style.paddingTop = '10px';
    } else {
        div.style.paddingTop = '8px';
    }

    if (!ss.containsLabel) {
        var label = mxResources.get('reverse');

        if (ss.vertices.length > 0 && ss.edges.length > 0) {
            label = mxResources.get('turn') + ' / ' + label;
        } else if (ss.vertices.length > 0) {
            label = mxResources.get('turn');
        }

        btn = mxUtils.button(label, function (evt) {
            ui.actions.get('turn').funct();
        })

        btn.setAttribute('title', label + ' (' + this.editorUi.actions.get('turn').shortcut + ')');
        btn.style.width = '202px';
        div.appendChild(btn);

        if (input != null) {
            btn.style.marginTop = '8px';
        }
    }

    if (input != null) {
        var listener = mxUtils.bind(this, function (sender, evt, force) {
            if (force || document.activeElement != input) {
                ss = this.format.getSelectionState();
                var tmp = parseFloat(mxUtils.getValue(ss.style, mxConstants.STYLE_ROTATION, 0));
                input.value = (isNaN(tmp)) ? '' : tmp + '°';
            }
        });

        update = this.installInputHandler(input, mxConstants.STYLE_ROTATION, 0, 0, 360, '°', null, true);
        this.addKeyHandler(input, listener);

        graph.getModel().addListener(mxEvent.CHANGE, listener);
        this.listeners.push({
            destroy: function () {
                graph.getModel().removeListener(listener);
            }
        });
        listener();
    }

    return div;
};

BaseFormatPanel.prototype.getUnit = function () {
    var unit = this.editorUi.editor.graph.view.unit;

    switch (unit) {
        case mxConstants.POINTS:
            return 'pt';
        case mxConstants.INCHES:
            return '"';
        case mxConstants.MILLIMETERS:
            return 'mm';
    }
};

BaseFormatPanel.prototype.inUnit = function (pixels) {
    return this.editorUi.editor.graph.view.formatUnitText(pixels);
};

BaseFormatPanel.prototype.fromUnit = function (value) {
    var unit = this.editorUi.editor.graph.view.unit;

    switch (unit) {
        case mxConstants.POINTS:
            return value;
        case mxConstants.INCHES:
            return value * mxConstants.PIXELS_PER_INCH;
        case mxConstants.MILLIMETERS:
            return value * mxConstants.PIXELS_PER_MM;
    }
};

BaseFormatPanel.prototype.isFloatUnit = function () {
    return this.editorUi.editor.graph.view.unit != mxConstants.POINTS;
};

BaseFormatPanel.prototype.getUnitStep = function () {
    var unit = this.editorUi.editor.graph.view.unit;

    switch (unit) {
        case mxConstants.POINTS:
            return 1;
        case mxConstants.INCHES:
            return 0.1;
        case mxConstants.MILLIMETERS:
            return 0.5;
    }
};

/**
 *
 */
ArrangePanel.prototype.addGeometry = function (container) {
    var panel = this;
    var ui = this.editorUi;
    var graph = ui.editor.graph;
    var rect = this.format.getSelectionState();

    var selectCells = graph.getSelectionCells();
    var selectCell = _.first(selectCells);

    var div = this.createPanel();
    div.style.paddingBottom = '8px';

    var span = document.createElement('div');
    span.style.position = 'absolute';
    span.style.width = '50px';
    span.style.marginTop = '0px';
    span.style.fontWeight = 'bold';
    mxUtils.write(span, mxResources.get('size'));
    div.appendChild(span);

    var widthUpdate, heightUpdate, leftUpdate, topUpdate;
    var width = this.addUnitInput(div, this.getUnit(), 84, 44, function () {
        widthUpdate.apply(this, arguments);
    }, this.getUnitStep(), null, null, this.isFloatUnit());
    var height = this.addUnitInput(div, this.getUnit(), 20, 44, function () {
        heightUpdate.apply(this, arguments);
    }, this.getUnitStep(), null, null, this.isFloatUnit());

    var autosizeBtn = document.createElement('div');
    autosizeBtn.className = 'geSprite geSprite-fit';
    autosizeBtn.setAttribute('title', mxResources.get('autosize') + ' (' + this.editorUi.actions.get('autosize').shortcut + ')');
    autosizeBtn.style.position = 'relative';
    autosizeBtn.style.cursor = 'pointer';
    autosizeBtn.style.marginTop = '-3px';
    autosizeBtn.style.border = '0px';
    autosizeBtn.style.left = '52px';
    mxUtils.setOpacity(autosizeBtn, 50);

    mxEvent.addListener(autosizeBtn, 'mouseenter', function () {
        mxUtils.setOpacity(autosizeBtn, 100);
    });

    mxEvent.addListener(autosizeBtn, 'mouseleave', function () {
        mxUtils.setOpacity(autosizeBtn, 50);
    });

    mxEvent.addListener(autosizeBtn, 'click', function () {
        ui.actions.get('autosize').funct();
    });

    div.appendChild(autosizeBtn);
    this.addLabel(div, mxResources.get('width'), 84);
    this.addLabel(div, mxResources.get('height'), 20);
    mxUtils.br(div);

    var wrapper = document.createElement('div');
    wrapper.style.paddingTop = '8px';
    wrapper.style.paddingRight = '20px';
    wrapper.style.whiteSpace = 'nowrap';
    wrapper.style.textAlign = 'right';
    var opt = this.createCellOption(mxResources.get('constrainProportions'),
        mxConstants.STYLE_ASPECT, null, 'fixed', 'null');
    opt.style.width = '100%';
    wrapper.appendChild(opt);
    div.appendChild(wrapper);

    var constrainCheckbox = opt.getElementsByTagName('input')[0];
    this.addKeyHandler(width, listener);
    this.addKeyHandler(height, listener);

    widthUpdate = this.addGeometryHandler(width, function (geo, value) {
        if (geo.width > 0) {
            var value = Math.max(1, panel.fromUnit(value));

            if (constrainCheckbox.checked) {
                geo.height = Math.round((geo.height * value * 100) / geo.width) / 100;
            }
            geo.width = value;

            _.defer(function () {
                neptuneHandler.renderMxCell(selectCell);
            }, 200);
        }
    });

    heightUpdate = this.addGeometryHandler(height, function (geo, value) {
        if (geo.height > 0) {
            var value = Math.max(1, panel.fromUnit(value));

            if (constrainCheckbox.checked) {
                geo.width = Math.round((geo.width * value * 100) / geo.height) / 100;
            }

            geo.height = value;

            _.defer(function () {
                neptuneHandler.renderMxCell(selectCell);
            }, 200);
        }
    });

    container.appendChild(div);

    var div2 = this.createPanel();
    div2.style.paddingBottom = '30px';

    var span = document.createElement('div');
    span.style.position = 'absolute';
    span.style.width = '70px';
    span.style.marginTop = '0px';
    span.style.fontWeight = 'bold';
    mxUtils.write(span, mxResources.get('position'));
    div2.appendChild(span);

    var left = this.addUnitInput(div2, this.getUnit(), 84, 44, function () {
        leftUpdate.apply(this, arguments);
    }, this.getUnitStep(), null, null, this.isFloatUnit());
    var top = this.addUnitInput(div2, this.getUnit(), 20, 44, function () {
        topUpdate.apply(this, arguments);
    }, this.getUnitStep(), null, null, this.isFloatUnit());

    mxUtils.br(div2);
    this.addLabel(div2, mxResources.get('left'), 84);
    this.addLabel(div2, mxResources.get('top'), 20);

    var listener = mxUtils.bind(this, function (sender, evt, force) {
        rect = this.format.getSelectionState();

        if (!rect.containsLabel && rect.vertices.length == graph.getSelectionCount() &&
            rect.width != null && rect.height != null) {
            div.style.display = '';

            if (force || document.activeElement != width) {
                width.value = this.inUnit(rect.width) + ((rect.width == '') ? '' : ' ' + this.getUnit());
            }

            if (force || document.activeElement != height) {
                height.value = this.inUnit(rect.height) + ((rect.height == '') ? '' : ' ' + this.getUnit());
            }
        } else {
            div.style.display = 'none';
        }

        if (rect.vertices.length == graph.getSelectionCount() &&
            rect.x != null && rect.y != null) {
            div2.style.display = '';

            if (force || document.activeElement != left) {
                left.value = this.inUnit(rect.x) + ((rect.x == '') ? '' : ' ' + this.getUnit());
            }

            if (force || document.activeElement != top) {
                top.value = this.inUnit(rect.y) + ((rect.y == '') ? '' : ' ' + this.getUnit());
            }
        } else {
            div2.style.display = 'none';
        }
    });

    this.addKeyHandler(left, listener);
    this.addKeyHandler(top, listener);

    graph.getModel().addListener(mxEvent.CHANGE, listener);
    this.listeners.push({
        destroy: function () {
            graph.getModel().removeListener(listener);
        }
    });
    listener();

    leftUpdate = this.addGeometryHandler(left, function (geo, value) {
        value = panel.fromUnit(value);

        if (geo.relative) {
            geo.offset.x = value;
        } else {
            geo.x = value;
        }
    });
    topUpdate = this.addGeometryHandler(top, function (geo, value) {
        value = panel.fromUnit(value);

        if (geo.relative) {
            geo.offset.y = value;
        } else {
            geo.y = value;
        }
    });

    container.appendChild(div2);
};

/**
 *
 */
ArrangePanel.prototype.addGeometryHandler = function (input, fn) {
    var ui = this.editorUi;
    var graph = ui.editor.graph;
    var initialValue = null;
    var panel = this;

    function update(evt) {
        if (input.value != '') {
            var value = parseFloat(input.value);

            if (isNaN(value)) {
                input.value = initialValue + ' ' + panel.getUnit();
            } else if (value != initialValue) {
                graph.getModel().beginUpdate();
                try {
                    var cells = graph.getSelectionCells();

                    for (var i = 0; i < cells.length; i++) {
                        if (graph.getModel().isVertex(cells[i])) {
                            var geo = graph.getCellGeometry(cells[i]);

                            if (geo != null) {
                                geo = geo.clone();
                                fn(geo, value);

                                graph.getModel().setGeometry(cells[i], geo);
                            }
                        }
                    }
                } finally {
                    graph.getModel().endUpdate();
                }

                initialValue = value;
                input.value = value + ' ' + panel.getUnit();
            }
        }

        mxEvent.consume(evt);
    };

    mxEvent.addListener(input, 'blur', update);
    mxEvent.addListener(input, 'change', update);
    mxEvent.addListener(input, 'focus', function () {
        initialValue = input.value;
    });

    return update;
};

ArrangePanel.prototype.addEdgeGeometryHandler = function (input, fn) {
    var ui = this.editorUi;
    var graph = ui.editor.graph;
    var initialValue = null;

    function update(evt) {
        if (input.value != '') {
            var value = parseFloat(input.value);

            if (isNaN(value)) {
                input.value = initialValue + ' pt';
            } else if (value != initialValue) {
                graph.getModel().beginUpdate();
                try {
                    var cells = graph.getSelectionCells();

                    for (var i = 0; i < cells.length; i++) {
                        if (graph.getModel().isEdge(cells[i])) {
                            var geo = graph.getCellGeometry(cells[i]);

                            if (geo != null) {
                                geo = geo.clone();
                                fn(geo, value);

                                graph.getModel().setGeometry(cells[i], geo);
                            }
                        }
                    }
                } finally {
                    graph.getModel().endUpdate();
                }

                initialValue = value;
                input.value = value + ' pt';
            }
        }

        mxEvent.consume(evt);
    };

    mxEvent.addListener(input, 'blur', update);
    mxEvent.addListener(input, 'change', update);
    mxEvent.addListener(input, 'focus', function () {
        initialValue = input.value;
    });

    return update;
};

/**
 *
 */
ArrangePanel.prototype.addEdgeGeometry = function (container) {
    var ui = this.editorUi;
    var graph = ui.editor.graph;
    var rect = this.format.getSelectionState();

    var div = this.createPanel();

    var span = document.createElement('div');
    span.style.position = 'absolute';
    span.style.width = '70px';
    span.style.marginTop = '0px';
    span.style.fontWeight = 'bold';
    mxUtils.write(span, mxResources.get('width'));
    div.appendChild(span);

    var widthUpdate, xtUpdate, ytUpdate, xsUpdate, ysUpdate;
    var width = this.addUnitInput(div, 'pt', 20, 44, function () {
        widthUpdate.apply(this, arguments);
    });

    mxUtils.br(div);
    this.addKeyHandler(width, listener);

    function widthUpdate(evt) {
        // Maximum stroke width is 999
        var value = parseInt(width.value);
        value = Math.min(999, Math.max(1, (isNaN(value)) ? 1 : value));

        if (value != mxUtils.getValue(rect.style, 'width', mxCellRenderer.defaultShapes['flexArrow'].prototype.defaultWidth)) {
            graph.setCellStyles('width', value, graph.getSelectionCells());
            ui.fireEvent(new mxEventObject('styleChanged', 'keys', ['width'],
                'values', [value], 'cells', graph.getSelectionCells()));
        }

        width.value = value + ' pt';
        mxEvent.consume(evt);
    };

    mxEvent.addListener(width, 'blur', widthUpdate);
    mxEvent.addListener(width, 'change', widthUpdate);

    container.appendChild(div);

    var divs = this.createPanel();
    divs.style.paddingBottom = '30px';

    var span = document.createElement('div');
    span.style.position = 'absolute';
    span.style.width = '70px';
    span.style.marginTop = '0px';
    span.style.fontWeight = 'bold';
    mxUtils.write(span, 'Start');
    divs.appendChild(span);

    var xs = this.addUnitInput(divs, 'pt', 84, 44, function () {
        xsUpdate.apply(this, arguments);
    });
    var ys = this.addUnitInput(divs, 'pt', 20, 44, function () {
        ysUpdate.apply(this, arguments);
    });

    mxUtils.br(divs);
    this.addLabel(divs, mxResources.get('left'), 84);
    this.addLabel(divs, mxResources.get('top'), 20);
    container.appendChild(divs);
    this.addKeyHandler(xs, listener);
    this.addKeyHandler(ys, listener);

    var divt = this.createPanel();
    divt.style.paddingBottom = '30px';

    var span = document.createElement('div');
    span.style.position = 'absolute';
    span.style.width = '70px';
    span.style.marginTop = '0px';
    span.style.fontWeight = 'bold';
    mxUtils.write(span, 'End');
    divt.appendChild(span);

    var xt = this.addUnitInput(divt, 'pt', 84, 44, function () {
        xtUpdate.apply(this, arguments);
    });
    var yt = this.addUnitInput(divt, 'pt', 20, 44, function () {
        ytUpdate.apply(this, arguments);
    });

    mxUtils.br(divt);
    this.addLabel(divt, mxResources.get('left'), 84);
    this.addLabel(divt, mxResources.get('top'), 20);
    container.appendChild(divt);
    this.addKeyHandler(xt, listener);
    this.addKeyHandler(yt, listener);

    var listener = mxUtils.bind(this, function (sender, evt, force) {
        rect = this.format.getSelectionState();
        var cell = graph.getSelectionCell();

        if (rect.style.shape == 'link' || rect.style.shape == 'flexArrow') {
            div.style.display = '';

            if (force || document.activeElement != width) {
                var value = mxUtils.getValue(rect.style, 'width',
                    mxCellRenderer.defaultShapes['flexArrow'].prototype.defaultWidth);
                width.value = value + ' pt';
            }
        } else {
            div.style.display = 'none';
        }

        if (graph.getSelectionCount() == 1 && graph.model.isEdge(cell)) {
            var geo = graph.model.getGeometry(cell);

            if (geo.sourcePoint != null && graph.model.getTerminal(cell, true) == null) {
                xs.value = geo.sourcePoint.x;
                ys.value = geo.sourcePoint.y;
            } else {
                divs.style.display = 'none';
            }

            if (geo.targetPoint != null && graph.model.getTerminal(cell, false) == null) {
                xt.value = geo.targetPoint.x;
                yt.value = geo.targetPoint.y;
            } else {
                divt.style.display = 'none';
            }
        } else {
            divs.style.display = 'none';
            divt.style.display = 'none';
        }
    });

    xsUpdate = this.addEdgeGeometryHandler(xs, function (geo, value) {
        geo.sourcePoint.x = value;
    });

    ysUpdate = this.addEdgeGeometryHandler(ys, function (geo, value) {
        geo.sourcePoint.y = value;
    });

    xtUpdate = this.addEdgeGeometryHandler(xt, function (geo, value) {
        geo.targetPoint.x = value;
    });

    ytUpdate = this.addEdgeGeometryHandler(yt, function (geo, value) {
        geo.targetPoint.y = value;
    });

    graph.getModel().addListener(mxEvent.CHANGE, listener);
    this.listeners.push({
        destroy: function () {
            graph.getModel().removeListener(listener);
        }
    });
    listener();
};

/**
 * Adds the label menu items to the given menu and parent.
 */
TextFormatPanel = function (format, editorUi, container) {
    BaseFormatPanel.call(this, format, editorUi, container);
    this.init();
};

mxUtils.extend(TextFormatPanel, BaseFormatPanel);

/**
 * Adds the label menu items to the given menu and parent.
 */
TextFormatPanel.prototype.init = function () {
    this.container.style.borderBottom = 'none';
    this.addFont(this.container);
};

/**
 * Adds the label menu items to the given menu and parent.
 */
TextFormatPanel.prototype.addFont = function (container) {
    var ui = this.editorUi;
    var editor = ui.editor;
    var graph = editor.graph;
    var ss = this.format.getSelectionState();

    var title = this.createTitle(mxResources.get('font'));
    title.style.paddingLeft = '18px';
    title.style.paddingTop = '10px';
    title.style.paddingBottom = '6px';
    container.appendChild(title);

    var stylePanel = this.createPanel();
    stylePanel.style.paddingTop = '2px';
    stylePanel.style.paddingBottom = '2px';
    stylePanel.style.position = 'relative';
    stylePanel.style.marginLeft = '-2px';
    stylePanel.style.borderWidth = '0px';
    stylePanel.className = 'geToolbarContainer';

    if (mxClient.IS_QUIRKS) {
        stylePanel.style.display = 'block';
    }

    if (graph.cellEditor.isContentEditing()) {
        var cssPanel = stylePanel.cloneNode();

        var cssMenu = this.editorUi.toolbar.addMenu(mxResources.get('style'),
            mxResources.get('style'), true, 'formatBlock', cssPanel, null, true);
        cssMenu.style.color = 'rgb(112, 112, 112)';
        cssMenu.style.whiteSpace = 'nowrap';
        cssMenu.style.overflow = 'hidden';
        cssMenu.style.margin = '0px';
        this.addArrow(cssMenu);
        cssMenu.style.width = '192px';
        cssMenu.style.height = '15px';

        var arrow = cssMenu.getElementsByTagName('div')[0];
        arrow.style.cssFloat = 'right';
        container.appendChild(cssPanel);
    }

    container.appendChild(stylePanel);

    var colorPanel = this.createPanel();
    colorPanel.style.marginTop = '8px';
    colorPanel.style.borderTop = '1px solid #c0c0c0';
    colorPanel.style.paddingTop = '6px';
    colorPanel.style.paddingBottom = '6px';

    var fontMenu = this.editorUi.toolbar.addMenu('Helvetica', mxResources.get('fontFamily'),
        true, 'fontFamily', stylePanel, null, true);
    fontMenu.style.color = 'rgb(112, 112, 112)';
    fontMenu.style.whiteSpace = 'nowrap';
    fontMenu.style.overflow = 'hidden';
    fontMenu.style.margin = '0px';

    this.addArrow(fontMenu);
    fontMenu.style.width = '192px';
    fontMenu.style.height = '15px';

    var stylePanel2 = stylePanel.cloneNode(false);
    stylePanel2.style.marginLeft = '-3px';
    var fontStyleItems = this.editorUi.toolbar.addItems(['bold', 'italic', 'underline'], stylePanel2, true);
    fontStyleItems[0].setAttribute('title', mxResources.get('bold') + ' (' + this.editorUi.actions.get('bold').shortcut + ')');
    fontStyleItems[1].setAttribute('title', mxResources.get('italic') + ' (' + this.editorUi.actions.get('italic').shortcut + ')');
    fontStyleItems[2].setAttribute('title', mxResources.get('underline') + ' (' + this.editorUi.actions.get('underline').shortcut + ')');

    var verticalItem = this.editorUi.toolbar.addItems(['vertical'], stylePanel2, true)[0];

    if (mxClient.IS_QUIRKS) {
        mxUtils.br(container);
    }

    container.appendChild(stylePanel2);

    this.styleButtons(fontStyleItems);
    this.styleButtons([verticalItem]);

    var stylePanel3 = stylePanel.cloneNode(false);
    stylePanel3.style.marginLeft = '-3px';
    stylePanel3.style.paddingBottom = '0px';

    // Helper function to return a wrapper function does not pass any arguments
    var callFn = function (fn) {
        return function () {
            return fn();
        };
    };

    var left = this.editorUi.toolbar.addButton('geSprite-left', mxResources.get('left'),
        (graph.cellEditor.isContentEditing()) ?
            function (evt) {
                graph.cellEditor.alignText(mxConstants.ALIGN_LEFT, evt);
            } : callFn(this.editorUi.menus.createStyleChangeFunction([mxConstants.STYLE_ALIGN], [mxConstants.ALIGN_LEFT])), stylePanel3);
    var center = this.editorUi.toolbar.addButton('geSprite-center', mxResources.get('center'),
        (graph.cellEditor.isContentEditing()) ?
            function (evt) {
                graph.cellEditor.alignText(mxConstants.ALIGN_CENTER, evt);
            } : callFn(this.editorUi.menus.createStyleChangeFunction([mxConstants.STYLE_ALIGN], [mxConstants.ALIGN_CENTER])), stylePanel3);
    var right = this.editorUi.toolbar.addButton('geSprite-right', mxResources.get('right'),
        (graph.cellEditor.isContentEditing()) ?
            function (evt) {
                graph.cellEditor.alignText(mxConstants.ALIGN_RIGHT, evt);
            } : callFn(this.editorUi.menus.createStyleChangeFunction([mxConstants.STYLE_ALIGN], [mxConstants.ALIGN_RIGHT])), stylePanel3);

    this.styleButtons([left, center, right]);

    // Quick hack for strikethrough
    // TODO: Add translations and toggle state
    if (graph.cellEditor.isContentEditing()) {
        var strike = this.editorUi.toolbar.addButton('geSprite-removeformat', mxResources.get('strikethrough'),
            function () {
                document.execCommand('strikeThrough', false, null);
            }, stylePanel2);
        this.styleButtons([strike]);

        strike.firstChild.style.background = 'url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCI+PGRlZnM+PHBhdGggaWQ9ImEiIGQ9Ik0wIDBoMjR2MjRIMFYweiIvPjwvZGVmcz48Y2xpcFBhdGggaWQ9ImIiPjx1c2UgeGxpbms6aHJlZj0iI2EiIG92ZXJmbG93PSJ2aXNpYmxlIi8+PC9jbGlwUGF0aD48cGF0aCBjbGlwLXBhdGg9InVybCgjYikiIGZpbGw9IiMwMTAxMDEiIGQ9Ik03LjI0IDguNzVjLS4yNi0uNDgtLjM5LTEuMDMtLjM5LTEuNjcgMC0uNjEuMTMtMS4xNi40LTEuNjcuMjYtLjUuNjMtLjkzIDEuMTEtMS4yOS40OC0uMzUgMS4wNS0uNjMgMS43LS44My42Ni0uMTkgMS4zOS0uMjkgMi4xOC0uMjkuODEgMCAxLjU0LjExIDIuMjEuMzQuNjYuMjIgMS4yMy41NCAxLjY5Ljk0LjQ3LjQuODMuODggMS4wOCAxLjQzLjI1LjU1LjM4IDEuMTUuMzggMS44MWgtMy4wMWMwLS4zMS0uMDUtLjU5LS4xNS0uODUtLjA5LS4yNy0uMjQtLjQ5LS40NC0uNjgtLjItLjE5LS40NS0uMzMtLjc1LS40NC0uMy0uMS0uNjYtLjE2LTEuMDYtLjE2LS4zOSAwLS43NC4wNC0xLjAzLjEzLS4yOS4wOS0uNTMuMjEtLjcyLjM2LS4xOS4xNi0uMzQuMzQtLjQ0LjU1LS4xLjIxLS4xNS40My0uMTUuNjYgMCAuNDguMjUuODguNzQgMS4yMS4zOC4yNS43Ny40OCAxLjQxLjdINy4zOWMtLjA1LS4wOC0uMTEtLjE3LS4xNS0uMjV6TTIxIDEydi0ySDN2Mmg5LjYyYy4xOC4wNy40LjE0LjU1LjIuMzcuMTcuNjYuMzQuODcuNTEuMjEuMTcuMzUuMzYuNDMuNTcuMDcuMi4xMS40My4xMS42OSAwIC4yMy0uMDUuNDUtLjE0LjY2LS4wOS4yLS4yMy4zOC0uNDIuNTMtLjE5LjE1LS40Mi4yNi0uNzEuMzUtLjI5LjA4LS42My4xMy0xLjAxLjEzLS40MyAwLS44My0uMDQtMS4xOC0uMTNzLS42Ni0uMjMtLjkxLS40MmMtLjI1LS4xOS0uNDUtLjQ0LS41OS0uNzUtLjE0LS4zMS0uMjUtLjc2LS4yNS0xLjIxSDYuNGMwIC41NS4wOCAxLjEzLjI0IDEuNTguMTYuNDUuMzcuODUuNjUgMS4yMS4yOC4zNS42LjY2Ljk4LjkyLjM3LjI2Ljc4LjQ4IDEuMjIuNjUuNDQuMTcuOS4zIDEuMzguMzkuNDguMDguOTYuMTMgMS40NC4xMy44IDAgMS41My0uMDkgMi4xOC0uMjhzMS4yMS0uNDUgMS42Ny0uNzljLjQ2LS4zNC44Mi0uNzcgMS4wNy0xLjI3cy4zOC0xLjA3LjM4LTEuNzFjMC0uNi0uMS0xLjE0LS4zMS0xLjYxLS4wNS0uMTEtLjExLS4yMy0uMTctLjMzSDIxeiIvPjwvc3ZnPg==)';
        strike.firstChild.style.backgroundPosition = '2px 2px';
        strike.firstChild.style.backgroundSize = '18px 18px';

        this.styleButtons([strike]);
    }

    var top = this.editorUi.toolbar.addButton('geSprite-top', mxResources.get('top'),
        callFn(this.editorUi.menus.createStyleChangeFunction([mxConstants.STYLE_VERTICAL_ALIGN], [mxConstants.ALIGN_TOP])), stylePanel3);
    var middle = this.editorUi.toolbar.addButton('geSprite-middle', mxResources.get('middle'),
        callFn(this.editorUi.menus.createStyleChangeFunction([mxConstants.STYLE_VERTICAL_ALIGN], [mxConstants.ALIGN_MIDDLE])), stylePanel3);
    var bottom = this.editorUi.toolbar.addButton('geSprite-bottom', mxResources.get('bottom'),
        callFn(this.editorUi.menus.createStyleChangeFunction([mxConstants.STYLE_VERTICAL_ALIGN], [mxConstants.ALIGN_BOTTOM])), stylePanel3);

    this.styleButtons([top, middle, bottom]);

    if (mxClient.IS_QUIRKS) {
        mxUtils.br(container);
    }

    container.appendChild(stylePanel3);

    // Hack for updating UI state below based on current text selection
    // currentTable is the current selected DOM table updated below
    var sub, sup, full, tableWrapper, currentTable, tableCell, tableRow;

    if (graph.cellEditor.isContentEditing()) {
        top.style.display = 'none';
        middle.style.display = 'none';
        bottom.style.display = 'none';
        verticalItem.style.display = 'none';

        full = this.editorUi.toolbar.addButton('geSprite-justifyfull', mxResources.get('block'),
            function () {
                if (full.style.opacity == 1) {
                    document.execCommand('justifyfull', false, null);
                }
            }, stylePanel3);
        full.style.marginRight = '9px';
        full.style.opacity = 1;

        this.styleButtons([full,
            sub = this.editorUi.toolbar.addButton('geSprite-subscript',
                mxResources.get('subscript') + ' (' + Editor.ctrlKey + '+,)',
                function () {
                    document.execCommand('subscript', false, null);
                }, stylePanel3), sup = this.editorUi.toolbar.addButton('geSprite-superscript',
                mxResources.get('superscript') + ' (' + Editor.ctrlKey + '+.)',
                function () {
                    document.execCommand('superscript', false, null);
                }, stylePanel3)]);
        sub.style.marginLeft = '9px';

        var tmp = stylePanel3.cloneNode(false);
        tmp.style.paddingTop = '4px';
        var btns = [this.editorUi.toolbar.addButton('geSprite-orderedlist', mxResources.get('numberedList'),
            function () {
                document.execCommand('insertorderedlist', false, null);
            }, tmp),
            this.editorUi.toolbar.addButton('geSprite-unorderedlist', mxResources.get('bulletedList'),
                function () {
                    document.execCommand('insertunorderedlist', false, null);
                }, tmp),
            this.editorUi.toolbar.addButton('geSprite-outdent', mxResources.get('decreaseIndent'),
                function () {
                    document.execCommand('outdent', false, null);
                }, tmp),
            this.editorUi.toolbar.addButton('geSprite-indent', mxResources.get('increaseIndent'),
                function () {
                    document.execCommand('indent', false, null);
                }, tmp),
            this.editorUi.toolbar.addButton('geSprite-removeformat', mxResources.get('removeFormat'),
                function () {
                    document.execCommand('removeformat', false, null);
                }, tmp),
            this.editorUi.toolbar.addButton('geSprite-code', mxResources.get('html'),
                function () {
                    graph.cellEditor.toggleViewMode();
                }, tmp)];
        this.styleButtons(btns);
        btns[btns.length - 2].style.marginLeft = '9px';

        if (mxClient.IS_QUIRKS) {
            mxUtils.br(container);
            tmp.style.height = '40';
        }

        container.appendChild(tmp);
    } else {
        fontStyleItems[2].style.marginRight = '9px';
        right.style.marginRight = '9px';
    }

    // Label position
    var stylePanel4 = stylePanel.cloneNode(false);
    stylePanel4.style.marginLeft = '0px';
    stylePanel4.style.paddingTop = '8px';
    stylePanel4.style.paddingBottom = '4px';
    stylePanel4.style.fontWeight = 'normal';

    mxUtils.write(stylePanel4, mxResources.get('position'));

    // Adds label position options
    var positionSelect = document.createElement('select');
    positionSelect.style.position = 'absolute';
    positionSelect.style.right = '20px';
    positionSelect.style.width = '97px';
    positionSelect.style.marginTop = '-2px';

    var directions = ['topLeft', 'top', 'topRight', 'left', 'center', 'right', 'bottomLeft', 'bottom', 'bottomRight'];
    var lset = {
        'topLeft': [mxConstants.ALIGN_LEFT, mxConstants.ALIGN_TOP, mxConstants.ALIGN_RIGHT, mxConstants.ALIGN_BOTTOM],
        'top': [mxConstants.ALIGN_CENTER, mxConstants.ALIGN_TOP, mxConstants.ALIGN_CENTER, mxConstants.ALIGN_BOTTOM],
        'topRight': [mxConstants.ALIGN_RIGHT, mxConstants.ALIGN_TOP, mxConstants.ALIGN_LEFT, mxConstants.ALIGN_BOTTOM],
        'left': [mxConstants.ALIGN_LEFT, mxConstants.ALIGN_MIDDLE, mxConstants.ALIGN_RIGHT, mxConstants.ALIGN_MIDDLE],
        'center': [mxConstants.ALIGN_CENTER, mxConstants.ALIGN_MIDDLE, mxConstants.ALIGN_CENTER, mxConstants.ALIGN_MIDDLE],
        'right': [mxConstants.ALIGN_RIGHT, mxConstants.ALIGN_MIDDLE, mxConstants.ALIGN_LEFT, mxConstants.ALIGN_MIDDLE],
        'bottomLeft': [mxConstants.ALIGN_LEFT, mxConstants.ALIGN_BOTTOM, mxConstants.ALIGN_RIGHT, mxConstants.ALIGN_TOP],
        'bottom': [mxConstants.ALIGN_CENTER, mxConstants.ALIGN_BOTTOM, mxConstants.ALIGN_CENTER, mxConstants.ALIGN_TOP],
        'bottomRight': [mxConstants.ALIGN_RIGHT, mxConstants.ALIGN_BOTTOM, mxConstants.ALIGN_LEFT, mxConstants.ALIGN_TOP]
    };

    for (var i = 0; i < directions.length; i++) {
        var positionOption = document.createElement('option');
        positionOption.setAttribute('value', directions[i]);
        mxUtils.write(positionOption, mxResources.get(directions[i]));
        positionSelect.appendChild(positionOption);
    }

    stylePanel4.appendChild(positionSelect);

    // Writing direction
    var stylePanel5 = stylePanel.cloneNode(false);
    stylePanel5.style.marginLeft = '0px';
    stylePanel5.style.paddingTop = '4px';
    stylePanel5.style.paddingBottom = '4px';
    stylePanel5.style.fontWeight = 'normal';

    mxUtils.write(stylePanel5, mxResources.get('writingDirection'));

    // Adds writing direction options
    // LATER: Handle reselect of same option in all selects (change event
    // is not fired for same option so have opened state on click) and
    // handle multiple different styles for current selection
    var dirSelect = document.createElement('select');
    dirSelect.style.position = 'absolute';
    dirSelect.style.right = '20px';
    dirSelect.style.width = '97px';
    dirSelect.style.marginTop = '-2px';

    // NOTE: For automatic we use the value null since automatic
    // requires the text to be non formatted and non-wrapped
    var dirs = ['automatic', 'leftToRight', 'rightToLeft'];
    var dirSet = {
        'automatic': null,
        'leftToRight': mxConstants.TEXT_DIRECTION_LTR,
        'rightToLeft': mxConstants.TEXT_DIRECTION_RTL
    };

    for (var i = 0; i < dirs.length; i++) {
        var dirOption = document.createElement('option');
        dirOption.setAttribute('value', dirs[i]);
        mxUtils.write(dirOption, mxResources.get(dirs[i]));
        dirSelect.appendChild(dirOption);
    }

    stylePanel5.appendChild(dirSelect);

    if (!graph.isEditing()) {
        container.appendChild(stylePanel4);

        mxEvent.addListener(positionSelect, 'change', function (evt) {
            graph.getModel().beginUpdate();
            try {
                var vals = lset[positionSelect.value];

                if (vals != null) {
                    graph.setCellStyles(mxConstants.STYLE_LABEL_POSITION, vals[0], graph.getSelectionCells());
                    graph.setCellStyles(mxConstants.STYLE_VERTICAL_LABEL_POSITION, vals[1], graph.getSelectionCells());
                    graph.setCellStyles(mxConstants.STYLE_ALIGN, vals[2], graph.getSelectionCells());
                    graph.setCellStyles(mxConstants.STYLE_VERTICAL_ALIGN, vals[3], graph.getSelectionCells());
                }
            } finally {
                graph.getModel().endUpdate();
            }

            mxEvent.consume(evt);
        });

        // LATER: Update dir in text editor while editing and update style with label
        // NOTE: The tricky part is handling and passing on the auto value
        container.appendChild(stylePanel5);

        mxEvent.addListener(dirSelect, 'change', function (evt) {
            graph.setCellStyles(mxConstants.STYLE_TEXT_DIRECTION, dirSet[dirSelect.value], graph.getSelectionCells());
            mxEvent.consume(evt);
        });
    }

    // Font size
    var input = document.createElement('input');
    input.style.textAlign = 'right';
    input.style.marginTop = '4px';

    if (!mxClient.IS_QUIRKS) {
        input.style.position = 'absolute';
        input.style.right = '32px';
    }

    input.style.width = '46px';
    input.style.height = (mxClient.IS_QUIRKS) ? '21px' : '17px';
    stylePanel2.appendChild(input);

    // Workaround for font size 4 if no text is selected is update font size below
    // after first character was entered (as the font element is lazy created)
    var pendingFontSize = null;

    var inputUpdate = this.installInputHandler(input, mxConstants.STYLE_FONTSIZE, Menus.prototype.defaultFontSize, 1, 999, ' pt',
        function (fontSize) {
            // IE does not support containsNode
            // KNOWN: Fixes font size issues but bypasses undo
            if (window.getSelection && !mxClient.IS_IE && !mxClient.IS_IE11) {
                var selection = window.getSelection();
                var container = (selection.rangeCount > 0) ? selection.getRangeAt(0).commonAncestorContainer :
                    graph.cellEditor.textarea;

                function updateSize(elt, ignoreContains) {
                    if (graph.cellEditor.textarea != null && elt != graph.cellEditor.textarea &&
                        graph.cellEditor.textarea.contains(elt) &&
                        (ignoreContains || selection.containsNode(elt, true))) {
                        if (elt.nodeName == 'FONT') {
                            elt.removeAttribute('size');
                            elt.style.fontSize = fontSize + 'px';
                        } else {
                            var css = mxUtils.getCurrentStyle(elt);

                            if (css.fontSize != fontSize + 'px') {
                                if (mxUtils.getCurrentStyle(elt.parentNode).fontSize != fontSize + 'px') {
                                    elt.style.fontSize = fontSize + 'px';
                                } else {
                                    elt.style.fontSize = '';
                                }
                            }
                        }
                    }
                };

                // Wraps text node or mixed selection with leading text in a font element
                if (container == graph.cellEditor.textarea ||
                    container.nodeType != mxConstants.NODETYPE_ELEMENT) {
                    document.execCommand('fontSize', false, '1');
                }

                if (container != graph.cellEditor.textarea) {
                    container = container.parentNode;
                }

                if (container != null && container.nodeType == mxConstants.NODETYPE_ELEMENT) {
                    var elts = container.getElementsByTagName('*');
                    updateSize(container);

                    for (var i = 0; i < elts.length; i++) {
                        updateSize(elts[i]);
                    }
                }

                input.value = fontSize + ' pt';
            } else if (window.getSelection || document.selection) {
                // Checks selection
                var par = null;

                if (document.selection) {
                    par = document.selection.createRange().parentElement();
                } else {
                    var selection = window.getSelection();

                    if (selection.rangeCount > 0) {
                        par = selection.getRangeAt(0).commonAncestorContainer;
                    }
                }

                // Node.contains does not work for text nodes in IE11
                function isOrContains(container, node) {
                    while (node != null) {
                        if (node === container) {
                            return true;
                        }

                        node = node.parentNode;
                    }

                    return false;
                };

                if (par != null && isOrContains(graph.cellEditor.textarea, par)) {
                    pendingFontSize = fontSize;

                    // Workaround for can't set font size in px is to change font size afterwards
                    document.execCommand('fontSize', false, '4');
                    var elts = graph.cellEditor.textarea.getElementsByTagName('font');

                    for (var i = 0; i < elts.length; i++) {
                        if (elts[i].getAttribute('size') == '4') {
                            elts[i].removeAttribute('size');
                            elts[i].style.fontSize = pendingFontSize + 'px';

                            // Overrides fontSize in input with the one just assigned as a workaround
                            // for potential fontSize values of parent elements that don't match
                            window.setTimeout(function () {
                                input.value = pendingFontSize + ' pt';
                                pendingFontSize = null;
                            }, 0);

                            break;
                        }
                    }
                }
            }
        }, true);

    var stepper = this.createStepper(input, inputUpdate, 1, 10, true, Menus.prototype.defaultFontSize);
    stepper.style.display = input.style.display;
    stepper.style.marginTop = '4px';

    if (!mxClient.IS_QUIRKS) {
        stepper.style.right = '20px';
    }

    stylePanel2.appendChild(stepper);

    var arrow = fontMenu.getElementsByTagName('div')[0];
    arrow.style.cssFloat = 'right';

    var bgColorApply = null;
    var currentBgColor = '#ffffff';

    var fontColorApply = null;
    var currentFontColor = '#000000';

    var bgPanel = (graph.cellEditor.isContentEditing()) ? this.createColorOption(mxResources.get('backgroundColor'), function () {
            return currentBgColor;
        }, function (color) {
            document.execCommand('backcolor', false, (color != mxConstants.NONE) ? color : 'transparent');
        }, '#ffffff',
        {
            install: function (apply) {
                bgColorApply = apply;
            },
            destroy: function () {
                bgColorApply = null;
            }
        }, null, true) : this.createCellColorOption(mxResources.get('backgroundColor'), mxConstants.STYLE_LABEL_BACKGROUNDCOLOR, '#ffffff', null, function (color) {
        graph.updateLabelElements(graph.getSelectionCells(), function (elt) {
            elt.style.backgroundColor = null;
        });
    });
    bgPanel.style.fontWeight = 'bold';

    var borderPanel = this.createCellColorOption(mxResources.get('borderColor'), mxConstants.STYLE_LABEL_BORDERCOLOR, '#000000');
    borderPanel.style.fontWeight = 'bold';

    var panel = (graph.cellEditor.isContentEditing()) ? this.createColorOption(mxResources.get('fontColor'), function () {
            return currentFontColor;
        }, function (color) {
            if (mxClient.IS_FF) {
                // Workaround for Firefox that adds the font element around
                // anchor elements which ignore inherited colors is to move
                // the font element inside anchor elements
                var tmp = graph.cellEditor.textarea.getElementsByTagName('font');
                var oldFonts = [];

                for (var i = 0; i < tmp.length; i++) {
                    oldFonts.push(
                        {
                            node: tmp[i],
                            color: tmp[i].getAttribute('color')
                        });
                }

                document.execCommand('forecolor', false, (color != mxConstants.NONE) ?
                    color : 'transparent');

                // Finds the new or changed font element
                var newFonts = graph.cellEditor.textarea.getElementsByTagName('font');

                for (var i = 0; i < newFonts.length; i++) {
                    if (i >= oldFonts.length || newFonts[i] != oldFonts[i].node ||
                        (newFonts[i] == oldFonts[i].node &&
                            newFonts[i].getAttribute('color') != oldFonts[i].color)) {
                        var child = newFonts[i].firstChild;

                        // Moves the font element to inside the anchor element and adopts all children
                        if (child != null && child.nodeName == 'A' && child.nextSibling ==
                            null &&
                            child.firstChild != null) {
                            var parent = newFonts[i].parentNode;
                            parent.insertBefore(child, newFonts[i]);
                            var tmp = child.firstChild;

                            while (tmp != null) {
                                var next = tmp.nextSibling;
                                newFonts[i].appendChild(tmp);
                                tmp = next;
                            }

                            child.appendChild(newFonts[i]);
                        }

                        break;
                    }
                }
            } else {
                document.execCommand('forecolor', false, (color != mxConstants.NONE) ?
                    color : 'transparent');
            }
        }, '#000000',
        {
            install: function (apply) {
                fontColorApply = apply;
            },
            destroy: function () {
                fontColorApply = null;
            }
        }, null, true) : this.createCellColorOption(mxResources.get('fontColor'), mxConstants.STYLE_FONTCOLOR, '#000000', function (color) {
        if (color == null || color == mxConstants.NONE) {
            bgPanel.style.display = 'none';
        } else {
            bgPanel.style.display = '';
        }

        borderPanel.style.display = bgPanel.style.display;
    }, function (color) {
        if (color == null || color == mxConstants.NONE) {
            graph.setCellStyles(mxConstants.STYLE_NOLABEL, '1', graph.getSelectionCells());
        } else {
            graph.setCellStyles(mxConstants.STYLE_NOLABEL, null, graph.getSelectionCells());
        }

        graph.updateLabelElements(graph.getSelectionCells(), function (elt) {
            elt.removeAttribute('color');
            elt.style.color = null;
        });
    });
    panel.style.fontWeight = 'bold';

    colorPanel.appendChild(panel);
    colorPanel.appendChild(bgPanel);

    if (!graph.cellEditor.isContentEditing()) {
        colorPanel.appendChild(borderPanel);
    }

    container.appendChild(colorPanel);

    var extraPanel = this.createPanel();
    extraPanel.style.paddingTop = '2px';
    extraPanel.style.paddingBottom = '4px';

    // LATER: Fix toggle using '' instead of 'null'
    var wwOpt = this.createCellOption(mxResources.get('wordWrap'), mxConstants.STYLE_WHITE_SPACE, null, 'wrap', 'null', null, null, true);
    wwOpt.style.fontWeight = 'bold';

    // Word wrap in edge labels only supported via labelWidth style
    if (!ss.containsLabel && !ss.autoSize && ss.edges.length == 0) {
        extraPanel.appendChild(wwOpt);
    }

    // Delegates switch of style to formattedText action as it also convertes newlines
    var htmlOpt = this.createCellOption(mxResources.get('formattedText'), 'html', '0',
        null, null, null, ui.actions.get('formattedText'));
    htmlOpt.style.fontWeight = 'bold';
    extraPanel.appendChild(htmlOpt);

    var spacingPanel = this.createPanel();
    spacingPanel.style.paddingTop = '10px';
    spacingPanel.style.paddingBottom = '28px';
    spacingPanel.style.fontWeight = 'normal';

    var span = document.createElement('div');
    span.style.position = 'absolute';
    span.style.width = '70px';
    span.style.marginTop = '0px';
    span.style.fontWeight = 'bold';
    mxUtils.write(span, mxResources.get('spacing'));
    spacingPanel.appendChild(span);

    var topUpdate, globalUpdate, leftUpdate, bottomUpdate, rightUpdate;
    var topSpacing = this.addUnitInput(spacingPanel, 'pt', 91, 44, function () {
        topUpdate.apply(this, arguments);
    });
    var globalSpacing = this.addUnitInput(spacingPanel, 'pt', 20, 44, function () {
        globalUpdate.apply(this, arguments);
    });

    mxUtils.br(spacingPanel);
    this.addLabel(spacingPanel, mxResources.get('top'), 91);
    this.addLabel(spacingPanel, mxResources.get('global'), 20);
    mxUtils.br(spacingPanel);
    mxUtils.br(spacingPanel);

    var leftSpacing = this.addUnitInput(spacingPanel, 'pt', 162, 44, function () {
        leftUpdate.apply(this, arguments);
    });
    var bottomSpacing = this.addUnitInput(spacingPanel, 'pt', 91, 44, function () {
        bottomUpdate.apply(this, arguments);
    });
    var rightSpacing = this.addUnitInput(spacingPanel, 'pt', 20, 44, function () {
        rightUpdate.apply(this, arguments);
    });

    mxUtils.br(spacingPanel);
    this.addLabel(spacingPanel, mxResources.get('left'), 162);
    this.addLabel(spacingPanel, mxResources.get('bottom'), 91);
    this.addLabel(spacingPanel, mxResources.get('right'), 20);

    if (!graph.cellEditor.isContentEditing()) {
        container.appendChild(extraPanel);
        container.appendChild(this.createRelativeOption(mxResources.get('opacity'), mxConstants.STYLE_TEXT_OPACITY));
        container.appendChild(spacingPanel);
    } else {
        var selState = null;
        var lineHeightInput = null;

        container.appendChild(this.createRelativeOption(mxResources.get('lineheight'), null, null, function (input) {
            var value = (input.value == '') ? 120 : parseInt(input.value);
            value = Math.max(0, (isNaN(value)) ? 120 : value);

            if (selState != null) {
                graph.cellEditor.restoreSelection(selState);
                selState = null;
            }

            var selectedElement = graph.getSelectedElement();
            var node = selectedElement;

            while (node != null && node.nodeType != mxConstants.NODETYPE_ELEMENT) {
                node = node.parentNode;
            }

            if (node != null && node == graph.cellEditor.textarea && graph.cellEditor.textarea.firstChild != null) {
                if (graph.cellEditor.textarea.firstChild.nodeName != 'P') {
                    graph.cellEditor.textarea.innerHTML = '<p>' + graph.cellEditor.textarea.innerHTML + '</p>';
                }

                node = graph.cellEditor.textarea.firstChild;
            }

            if (node != null && graph.cellEditor.textarea != null && node != graph.cellEditor.textarea &&
                graph.cellEditor.textarea.contains(node)) {
                node.style.lineHeight = value + '%';
            }

            input.value = value + ' %';
        }, function (input) {
            // Used in CSS handler to update current value
            lineHeightInput = input;

            // KNOWN: Arrow up/down clear selection text in quirks/IE 8
            // Text size via arrow button limits to 16 in IE11. Why?
            mxEvent.addListener(input, 'mousedown', function () {
                if (document.activeElement == graph.cellEditor.textarea) {
                    selState = graph.cellEditor.saveSelection();
                }
            });

            mxEvent.addListener(input, 'touchstart', function () {
                if (document.activeElement == graph.cellEditor.textarea) {
                    selState = graph.cellEditor.saveSelection();
                }
            });

            input.value = '120 %';
        }));

        var insertPanel = stylePanel.cloneNode(false);
        insertPanel.style.paddingLeft = '0px';
        var insertBtns = this.editorUi.toolbar.addItems(['link', 'image'], insertPanel, true);

        var btns = [
            this.editorUi.toolbar.addButton('geSprite-horizontalrule', mxResources.get('insertHorizontalRule'),
                function () {
                    document.execCommand('inserthorizontalrule', false);
                }, insertPanel),
            this.editorUi.toolbar.addMenuFunctionInContainer(insertPanel, 'geSprite-table', mxResources.get('table'), false, mxUtils.bind(this, function (menu) {
                this.editorUi.menus.addInsertTableItem(menu);
            }))];
        this.styleButtons(insertBtns);
        this.styleButtons(btns);

        var wrapper2 = this.createPanel();
        wrapper2.style.paddingTop = '10px';
        wrapper2.style.paddingBottom = '10px';
        wrapper2.appendChild(this.createTitle(mxResources.get('insert')));
        wrapper2.appendChild(insertPanel);
        container.appendChild(wrapper2);

        if (mxClient.IS_QUIRKS) {
            wrapper2.style.height = '70';
        }

        var tablePanel = stylePanel.cloneNode(false);
        tablePanel.style.paddingLeft = '0px';

        var btns = [
            this.editorUi.toolbar.addButton('geSprite-insertcolumnbefore', mxResources.get('insertColumnBefore'),
                mxUtils.bind(this, function () {
                    try {
                        if (currentTable != null) {
                            graph.insertColumn(currentTable, (tableCell != null) ? tableCell.cellIndex : 0);
                        }
                    } catch (e) {
                        this.editorUi.handleError(e);
                    }
                }), tablePanel),
            this.editorUi.toolbar.addButton('geSprite-insertcolumnafter', mxResources.get('insertColumnAfter'),
                mxUtils.bind(this, function () {
                    try {
                        if (currentTable != null) {
                            graph.insertColumn(currentTable, (tableCell != null) ? tableCell.cellIndex + 1 : -1);
                        }
                    } catch (e) {
                        this.editorUi.handleError(e);
                    }
                }), tablePanel),
            this.editorUi.toolbar.addButton('geSprite-deletecolumn', mxResources.get('deleteColumn'),
                mxUtils.bind(this, function () {
                    try {
                        if (currentTable != null && tableCell != null) {
                            graph.deleteColumn(currentTable, tableCell.cellIndex);
                        }
                    } catch (e) {
                        this.editorUi.handleError(e);
                    }
                }), tablePanel),
            this.editorUi.toolbar.addButton('geSprite-insertrowbefore', mxResources.get('insertRowBefore'),
                mxUtils.bind(this, function () {
                    try {
                        if (currentTable != null && tableRow != null) {
                            graph.insertRow(currentTable, tableRow.sectionRowIndex);
                        }
                    } catch (e) {
                        this.editorUi.handleError(e);
                    }
                }), tablePanel),
            this.editorUi.toolbar.addButton('geSprite-insertrowafter', mxResources.get('insertRowAfter'),
                mxUtils.bind(this, function () {
                    try {
                        if (currentTable != null && tableRow != null) {
                            graph.insertRow(currentTable, tableRow.sectionRowIndex + 1);
                        }
                    } catch (e) {
                        this.editorUi.handleError(e);
                    }
                }), tablePanel),
            this.editorUi.toolbar.addButton('geSprite-deleterow', mxResources.get('deleteRow'),
                mxUtils.bind(this, function () {
                    try {
                        if (currentTable != null && tableRow != null) {
                            graph.deleteRow(currentTable, tableRow.sectionRowIndex);
                        }
                    } catch (e) {
                        this.editorUi.handleError(e);
                    }
                }), tablePanel)];
        this.styleButtons(btns);
        btns[2].style.marginRight = '9px';

        var wrapper3 = this.createPanel();
        wrapper3.style.paddingTop = '10px';
        wrapper3.style.paddingBottom = '10px';
        wrapper3.appendChild(this.createTitle(mxResources.get('table')));
        wrapper3.appendChild(tablePanel);

        if (mxClient.IS_QUIRKS) {
            mxUtils.br(container);
            wrapper3.style.height = '70';
        }

        var tablePanel2 = stylePanel.cloneNode(false);
        tablePanel2.style.paddingLeft = '0px';

        var btns = [
            this.editorUi.toolbar.addButton('geSprite-strokecolor', mxResources.get('borderColor'),
                mxUtils.bind(this, function (evt) {
                    if (currentTable != null) {
                        // Converts rgb(r,g,b) values
                        var color = currentTable.style.borderColor.replace(
                            /\brgb\s*\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\)/g,
                            function ($0, $1, $2, $3) {
                                return "#" + ("0" + Number($1).toString(16)).substr(-2) + ("0" + Number($2).toString(16)).substr(-2) + ("0" + Number($3).toString(16)).substr(-2);
                            });
                        this.editorUi.pickColor(color, function (newColor) {
                            var targetElt = (tableCell != null && (evt == null || !mxEvent.isShiftDown(evt))) ? tableCell : currentTable;

                            graph.processElements(targetElt, function (elt) {
                                elt.style.border = null;
                            });

                            if (newColor == null || newColor == mxConstants.NONE) {
                                targetElt.removeAttribute('border');
                                targetElt.style.border = '';
                                targetElt.style.borderCollapse = '';
                            } else {
                                targetElt.setAttribute('border', '1');
                                targetElt.style.border = '1px solid ' + newColor;
                                targetElt.style.borderCollapse = 'collapse';
                            }
                        });
                    }
                }), tablePanel2),
            this.editorUi.toolbar.addButton('geSprite-fillcolor', mxResources.get('backgroundColor'),
                mxUtils.bind(this, function (evt) {
                    // Converts rgb(r,g,b) values
                    if (currentTable != null) {
                        var color = currentTable.style.backgroundColor.replace(
                            /\brgb\s*\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\)/g,
                            function ($0, $1, $2, $3) {
                                return "#" + ("0" + Number($1).toString(16)).substr(-2) + ("0" + Number($2).toString(16)).substr(-2) + ("0" + Number($3).toString(16)).substr(-2);
                            });
                        this.editorUi.pickColor(color, function (newColor) {
                            var targetElt = (tableCell != null && (evt == null || !mxEvent.isShiftDown(evt))) ? tableCell : currentTable;

                            graph.processElements(targetElt, function (elt) {
                                elt.style.backgroundColor = null;
                            });

                            if (newColor == null || newColor == mxConstants.NONE) {
                                targetElt.style.backgroundColor = '';
                            } else {
                                targetElt.style.backgroundColor = newColor;
                            }
                        });
                    }
                }), tablePanel2),
            this.editorUi.toolbar.addButton('geSprite-fit', mxResources.get('spacing'),
                function () {
                    if (currentTable != null) {
                        var value = currentTable.getAttribute('cellPadding') || 0;

                        var dlg = new FilenameDialog(ui, value, mxResources.get('apply'), mxUtils.bind(this, function (newValue) {
                            if (newValue != null && newValue.length > 0) {
                                currentTable.setAttribute('cellPadding', newValue);
                            } else {
                                currentTable.removeAttribute('cellPadding');
                            }
                        }), mxResources.get('spacing'));
                        ui.showDialog(dlg.container, 300, 130, true, true);
                        dlg.init();
                    }
                }, tablePanel2),
            this.editorUi.toolbar.addButton('geSprite-left', mxResources.get('left'),
                function () {
                    if (currentTable != null) {
                        currentTable.setAttribute('align', 'left');
                    }
                }, tablePanel2),
            this.editorUi.toolbar.addButton('geSprite-center', mxResources.get('center'),
                function () {
                    if (currentTable != null) {
                        currentTable.setAttribute('align', 'center');
                    }
                }, tablePanel2),
            this.editorUi.toolbar.addButton('geSprite-right', mxResources.get('right'),
                function () {
                    if (currentTable != null) {
                        currentTable.setAttribute('align', 'right');
                    }
                }, tablePanel2)];
        this.styleButtons(btns);
        btns[2].style.marginRight = '9px';

        if (mxClient.IS_QUIRKS) {
            mxUtils.br(wrapper3);
            mxUtils.br(wrapper3);
        }

        wrapper3.appendChild(tablePanel2);
        container.appendChild(wrapper3);

        tableWrapper = wrapper3;
    }

    function setSelected(elt, selected) {
        if (mxClient.IS_IE && (mxClient.IS_QUIRKS || document.documentMode < 10)) {
            elt.style.filter = (selected) ? 'progid:DXImageTransform.Microsoft.Gradient(' +
                'StartColorStr=\'#c5ecff\', EndColorStr=\'#87d4fb\', GradientType=0)' : '';
        } else {
            elt.style.backgroundImage = (selected) ? 'linear-gradient(#c5ecff 0px,#87d4fb 100%)' : '';
        }
    };

    var listener = mxUtils.bind(this, function (sender, evt, force) {
        ss = this.format.getSelectionState();
        var fontStyle = mxUtils.getValue(ss.style, mxConstants.STYLE_FONTSTYLE, 0);
        setSelected(fontStyleItems[0], (fontStyle & mxConstants.FONT_BOLD) == mxConstants.FONT_BOLD);
        setSelected(fontStyleItems[1], (fontStyle & mxConstants.FONT_ITALIC) == mxConstants.FONT_ITALIC);
        setSelected(fontStyleItems[2], (fontStyle & mxConstants.FONT_UNDERLINE) == mxConstants.FONT_UNDERLINE);
        fontMenu.firstChild.nodeValue = mxUtils.getValue(ss.style, mxConstants.STYLE_FONTFAMILY, Menus.prototype.defaultFont);

        setSelected(verticalItem, mxUtils.getValue(ss.style, mxConstants.STYLE_HORIZONTAL, '1') == '0');

        if (force || document.activeElement != input) {
            var tmp = parseFloat(mxUtils.getValue(ss.style, mxConstants.STYLE_FONTSIZE, Menus.prototype.defaultFontSize));
            input.value = (isNaN(tmp)) ? '' : tmp + ' pt';
        }

        var align = mxUtils.getValue(ss.style, mxConstants.STYLE_ALIGN, mxConstants.ALIGN_CENTER);
        setSelected(left, align == mxConstants.ALIGN_LEFT);
        setSelected(center, align == mxConstants.ALIGN_CENTER);
        setSelected(right, align == mxConstants.ALIGN_RIGHT);

        var valign = mxUtils.getValue(ss.style, mxConstants.STYLE_VERTICAL_ALIGN, mxConstants.ALIGN_MIDDLE);
        setSelected(top, valign == mxConstants.ALIGN_TOP);
        setSelected(middle, valign == mxConstants.ALIGN_MIDDLE);
        setSelected(bottom, valign == mxConstants.ALIGN_BOTTOM);

        var pos = mxUtils.getValue(ss.style, mxConstants.STYLE_LABEL_POSITION, mxConstants.ALIGN_CENTER);
        var vpos = mxUtils.getValue(ss.style, mxConstants.STYLE_VERTICAL_LABEL_POSITION, mxConstants.ALIGN_MIDDLE);

        if (pos == mxConstants.ALIGN_LEFT && vpos == mxConstants.ALIGN_TOP) {
            positionSelect.value = 'topLeft';
        } else if (pos == mxConstants.ALIGN_CENTER && vpos == mxConstants.ALIGN_TOP) {
            positionSelect.value = 'top';
        } else if (pos == mxConstants.ALIGN_RIGHT && vpos == mxConstants.ALIGN_TOP) {
            positionSelect.value = 'topRight';
        } else if (pos == mxConstants.ALIGN_LEFT && vpos == mxConstants.ALIGN_BOTTOM) {
            positionSelect.value = 'bottomLeft';
        } else if (pos == mxConstants.ALIGN_CENTER && vpos == mxConstants.ALIGN_BOTTOM) {
            positionSelect.value = 'bottom';
        } else if (pos == mxConstants.ALIGN_RIGHT && vpos == mxConstants.ALIGN_BOTTOM) {
            positionSelect.value = 'bottomRight';
        } else if (pos == mxConstants.ALIGN_LEFT) {
            positionSelect.value = 'left';
        } else if (pos == mxConstants.ALIGN_RIGHT) {
            positionSelect.value = 'right';
        } else {
            positionSelect.value = 'center';
        }

        var dir = mxUtils.getValue(ss.style, mxConstants.STYLE_TEXT_DIRECTION, mxConstants.DEFAULT_TEXT_DIRECTION);

        if (dir == mxConstants.TEXT_DIRECTION_RTL) {
            dirSelect.value = 'rightToLeft';
        } else if (dir == mxConstants.TEXT_DIRECTION_LTR) {
            dirSelect.value = 'leftToRight';
        } else if (dir == mxConstants.TEXT_DIRECTION_AUTO) {
            dirSelect.value = 'automatic';
        }

        if (force || document.activeElement != globalSpacing) {
            var tmp = parseFloat(mxUtils.getValue(ss.style, mxConstants.STYLE_SPACING, 2));
            globalSpacing.value = (isNaN(tmp)) ? '' : tmp + ' pt';
        }

        if (force || document.activeElement != topSpacing) {
            var tmp = parseFloat(mxUtils.getValue(ss.style, mxConstants.STYLE_SPACING_TOP, 0));
            topSpacing.value = (isNaN(tmp)) ? '' : tmp + ' pt';
        }

        if (force || document.activeElement != rightSpacing) {
            var tmp = parseFloat(mxUtils.getValue(ss.style, mxConstants.STYLE_SPACING_RIGHT, 0));
            rightSpacing.value = (isNaN(tmp)) ? '' : tmp + ' pt';
        }

        if (force || document.activeElement != bottomSpacing) {
            var tmp = parseFloat(mxUtils.getValue(ss.style, mxConstants.STYLE_SPACING_BOTTOM, 0));
            bottomSpacing.value = (isNaN(tmp)) ? '' : tmp + ' pt';
        }

        if (force || document.activeElement != leftSpacing) {
            var tmp = parseFloat(mxUtils.getValue(ss.style, mxConstants.STYLE_SPACING_LEFT, 0));
            leftSpacing.value = (isNaN(tmp)) ? '' : tmp + ' pt';
        }
    });

    globalUpdate = this.installInputHandler(globalSpacing, mxConstants.STYLE_SPACING, 2, -999, 999, ' pt');
    topUpdate = this.installInputHandler(topSpacing, mxConstants.STYLE_SPACING_TOP, 0, -999, 999, ' pt');
    rightUpdate = this.installInputHandler(rightSpacing, mxConstants.STYLE_SPACING_RIGHT, 0, -999, 999, ' pt');
    bottomUpdate = this.installInputHandler(bottomSpacing, mxConstants.STYLE_SPACING_BOTTOM, 0, -999, 999, ' pt');
    leftUpdate = this.installInputHandler(leftSpacing, mxConstants.STYLE_SPACING_LEFT, 0, -999, 999, ' pt');

    this.addKeyHandler(input, listener);
    this.addKeyHandler(globalSpacing, listener);
    this.addKeyHandler(topSpacing, listener);
    this.addKeyHandler(rightSpacing, listener);
    this.addKeyHandler(bottomSpacing, listener);
    this.addKeyHandler(leftSpacing, listener);

    graph.getModel().addListener(mxEvent.CHANGE, listener);
    this.listeners.push({
        destroy: function () {
            graph.getModel().removeListener(listener);
        }
    });
    listener();

    if (graph.cellEditor.isContentEditing()) {
        var updating = false;

        var updateCssHandler = function () {
            if (!updating) {
                updating = true;

                window.setTimeout(function () {
                    var selectedElement = graph.getSelectedElement();
                    var node = selectedElement;

                    while (node != null && node.nodeType != mxConstants.NODETYPE_ELEMENT) {
                        node = node.parentNode;
                    }

                    if (node != null) {
                        // Workaround for commonAncestor on range in IE11 returning parent of common ancestor
                        if (node == graph.cellEditor.textarea && graph.cellEditor.textarea.children.length == 1 &&
                            graph.cellEditor.textarea.firstChild.nodeType == mxConstants.NODETYPE_ELEMENT) {
                            node = graph.cellEditor.textarea.firstChild;
                        }

                        function getRelativeLineHeight(fontSize, css, elt) {
                            if (elt.style != null && css != null) {
                                var lineHeight = css.lineHeight

                                if (elt.style.lineHeight != null && elt.style.lineHeight.substring(elt.style.lineHeight.length - 1) == '%') {
                                    return parseInt(elt.style.lineHeight) / 100;
                                } else {
                                    return (lineHeight.substring(lineHeight.length - 2) == 'px') ?
                                        parseFloat(lineHeight) / fontSize : parseInt(lineHeight);
                                }
                            } else {
                                return '';
                            }
                        };

                        function getAbsoluteFontSize(css) {
                            var fontSize = (css != null) ? css.fontSize : null;

                            if (fontSize != null && fontSize.substring(fontSize.length - 2) == 'px') {
                                return parseFloat(fontSize);
                            } else {
                                return mxConstants.DEFAULT_FONTSIZE;
                            }
                        };

                        var css = mxUtils.getCurrentStyle(node);
                        var fontSize = getAbsoluteFontSize(css);
                        var lineHeight = getRelativeLineHeight(fontSize, css, node);

                        // Finds common font size
                        var elts = node.getElementsByTagName('*');

                        // IE does not support containsNode
                        if (elts.length > 0 && window.getSelection && !mxClient.IS_IE && !mxClient.IS_IE11) {
                            var selection = window.getSelection();

                            for (var i = 0; i < elts.length; i++) {
                                if (selection.containsNode(elts[i], true)) {
                                    temp = mxUtils.getCurrentStyle(elts[i]);
                                    fontSize = Math.max(getAbsoluteFontSize(temp), fontSize);
                                    var lh = getRelativeLineHeight(fontSize, temp, elts[i]);

                                    if (lh != lineHeight || isNaN(lh)) {
                                        lineHeight = '';
                                    }
                                }
                            }
                        }

                        function hasParentOrOnlyChild(name) {
                            if (graph.getParentByName(node, name, graph.cellEditor.textarea) != null) {
                                return true;
                            } else {
                                var child = node;

                                while (child != null && child.childNodes.length == 1) {
                                    child = child.childNodes[0];

                                    if (child.nodeName == name) {
                                        return true;
                                    }
                                }
                            }

                            return false;
                        };

                        function isEqualOrPrefixed(str, value) {
                            if (str != null && value != null) {
                                if (str == value) {
                                    return true;
                                } else if (str.length > value.length + 1) {
                                    return str.substring(str.length - value.length - 1, str.length) == '-' + value;
                                }
                            }

                            return false;
                        };

                        if (css != null) {
                            setSelected(fontStyleItems[0], css.fontWeight == 'bold' ||
                                css.fontWeight > 400 || hasParentOrOnlyChild('B') ||
                                hasParentOrOnlyChild('STRONG'));
                            setSelected(fontStyleItems[1], css.fontStyle == 'italic' ||
                                hasParentOrOnlyChild('I') || hasParentOrOnlyChild('EM'));
                            setSelected(fontStyleItems[2], hasParentOrOnlyChild('U'));
                            setSelected(sup, hasParentOrOnlyChild('SUP'));
                            setSelected(sub, hasParentOrOnlyChild('SUB'));

                            if (!graph.cellEditor.isTableSelected()) {
                                var align = graph.cellEditor.align || mxUtils.getValue(ss.style, mxConstants.STYLE_ALIGN, mxConstants.ALIGN_CENTER);

                                if (isEqualOrPrefixed(css.textAlign, 'justify')) {
                                    setSelected(full, isEqualOrPrefixed(css.textAlign, 'justify'));
                                    setSelected(left, false);
                                    setSelected(center, false);
                                    setSelected(right, false);
                                } else {
                                    setSelected(full, false);
                                    setSelected(left, align == mxConstants.ALIGN_LEFT);
                                    setSelected(center, align == mxConstants.ALIGN_CENTER);
                                    setSelected(right, align == mxConstants.ALIGN_RIGHT);
                                }
                            } else {
                                setSelected(full, isEqualOrPrefixed(css.textAlign, 'justify'));
                                setSelected(left, isEqualOrPrefixed(css.textAlign, 'left'));
                                setSelected(center, isEqualOrPrefixed(css.textAlign, 'center'));
                                setSelected(right, isEqualOrPrefixed(css.textAlign, 'right'));
                            }

                            currentTable = graph.getParentByName(node, 'TABLE', graph.cellEditor.textarea);
                            tableRow = (currentTable == null) ? null : graph.getParentByName(node, 'TR', currentTable);
                            tableCell = (currentTable == null) ? null : graph.getParentByNames(node, ['TD', 'TH'], currentTable);
                            tableWrapper.style.display = (currentTable != null) ? '' : 'none';

                            if (document.activeElement != input) {
                                if (node.nodeName == 'FONT' && node.getAttribute('size') == '4' &&
                                    pendingFontSize != null) {
                                    node.removeAttribute('size');
                                    node.style.fontSize = pendingFontSize + ' pt';
                                    pendingFontSize = null;
                                } else {
                                    input.value = (isNaN(fontSize)) ? '' : fontSize + ' pt';
                                }

                                var lh = parseFloat(lineHeight);

                                if (!isNaN(lh)) {
                                    lineHeightInput.value = Math.round(lh * 100) + ' %';
                                } else {
                                    lineHeightInput.value = '100 %';
                                }
                            }

                            // Converts rgb(r,g,b) values
                            var color = css.color.replace(
                                /\brgb\s*\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\)/g,
                                function ($0, $1, $2, $3) {
                                    return "#" + ("0" + Number($1).toString(16)).substr(-2) + ("0" + Number($2).toString(16)).substr(-2) + ("0" + Number($3).toString(16)).substr(-2);
                                });
                            var color2 = css.backgroundColor.replace(
                                /\brgb\s*\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\)/g,
                                function ($0, $1, $2, $3) {
                                    return "#" + ("0" + Number($1).toString(16)).substr(-2) + ("0" + Number($2).toString(16)).substr(-2) + ("0" + Number($3).toString(16)).substr(-2);
                                });

                            // Updates the color picker for the current font
                            if (fontColorApply != null) {
                                if (color.charAt(0) == '#') {
                                    currentFontColor = color;
                                } else {
                                    currentFontColor = '#000000';
                                }

                                fontColorApply(currentFontColor, true);
                            }

                            if (bgColorApply != null) {
                                if (color2.charAt(0) == '#') {
                                    currentBgColor = color2;
                                } else {
                                    currentBgColor = null;
                                }

                                bgColorApply(currentBgColor, true);
                            }

                            // Workaround for firstChild is null or not an object
                            // in the log which seems to be IE8- only / 29.01.15
                            if (fontMenu.firstChild != null) {
                                // Strips leading and trailing quotes
                                var ff = css.fontFamily;

                                if (ff.charAt(0) == '\'') {
                                    ff = ff.substring(1);
                                }

                                if (ff.charAt(ff.length - 1) == '\'') {
                                    ff = ff.substring(0, ff.length - 1);
                                }

                                if (ff.charAt(0) == '"') {
                                    ff = ff.substring(1);
                                }

                                if (ff.charAt(ff.length - 1) == '"') {
                                    ff = ff.substring(0, ff.length - 1);
                                }

                                fontMenu.firstChild.nodeValue = ff;
                            }
                        }
                    }

                    updating = false;
                }, 0);
            }
        };

        if (mxClient.IS_FF || mxClient.IS_EDGE || mxClient.IS_IE || mxClient.IS_IE11) {
            mxEvent.addListener(graph.cellEditor.textarea, 'DOMSubtreeModified', updateCssHandler);
        }

        mxEvent.addListener(graph.cellEditor.textarea, 'input', updateCssHandler);
        mxEvent.addListener(graph.cellEditor.textarea, 'touchend', updateCssHandler);
        mxEvent.addListener(graph.cellEditor.textarea, 'mouseup', updateCssHandler);
        mxEvent.addListener(graph.cellEditor.textarea, 'keyup', updateCssHandler);
        this.listeners.push({
            destroy: function () {
                // No need to remove listener since textarea is destroyed after edit
            }
        });
        updateCssHandler();
    }

    return container;
};

/**
 * Adds the label menu items to the given menu and parent.
 */
StyleFormatPanel = function (format, editorUi, container) {
    BaseFormatPanel.call(this, format, editorUi, container);
    this.init();
};

mxUtils.extend(StyleFormatPanel, BaseFormatPanel);

/**
 *
 */
StyleFormatPanel.prototype.defaultStrokeColor = 'black';

/**
 * Adds the label menu items to the given menu and parent.
 */
StyleFormatPanel.prototype.init = function () {
    var ui = this.editorUi;
    var editor = ui.editor;
    var graph = editor.graph;
    var ss = this.format.getSelectionState();

    if (!ss.containsLabel) {
        if (ss.containsImage && ss.vertices.length == 1 && ss.style.shape == 'image' &&
            ss.style.image != null && ss.style.image.substring(0, 19) == 'data:image/svg+xml;') {
            this.container.appendChild(this.addSvgStyles(this.createPanel()));
        }

        if (!ss.containsImage || ss.style.shape == 'image') {
            this.container.appendChild(this.addFill(this.createPanel()));
        }

        this.container.appendChild(this.addStroke(this.createPanel()));
        this.container.appendChild(this.addLineJumps(this.createPanel()));
        var opacityPanel = this.createRelativeOption(mxResources.get('opacity'), mxConstants.STYLE_OPACITY, 41);
        opacityPanel.style.paddingTop = '8px';
        opacityPanel.style.paddingBottom = '8px';
        this.container.appendChild(opacityPanel);
        this.container.appendChild(this.addEffects(this.createPanel()));
    }

    var opsPanel = this.addEditOps(this.createPanel());

    if (opsPanel.firstChild != null) {
        mxUtils.br(opsPanel);
    }

    this.container.appendChild(this.addStyleOps(opsPanel));
};

/**
 * Use browser for parsing CSS.
 */
StyleFormatPanel.prototype.getCssRules = function (css) {
    var doc = document.implementation.createHTMLDocument('');
    var styleElement = document.createElement('style');

    mxUtils.setTextContent(styleElement, css);
    doc.body.appendChild(styleElement);

    return styleElement.sheet.cssRules;
};

/**
 * Adds the label menu items to the given menu and parent.
 */
StyleFormatPanel.prototype.addSvgStyles = function (container) {
    var ui = this.editorUi;
    var graph = ui.editor.graph;
    var ss = this.format.getSelectionState();
    container.style.paddingTop = '6px';
    container.style.paddingBottom = '6px';
    container.style.fontWeight = 'bold';
    container.style.display = 'none';

    try {
        var exp = ss.style.editableCssRules;

        if (exp != null) {
            var regex = new RegExp(exp);

            var data = ss.style.image.substring(ss.style.image.indexOf(',') + 1);
            var xml = (window.atob) ? atob(data) : Base64.decode(data, true);
            var svg = mxUtils.parseXml(xml);

            if (svg != null) {
                var styles = svg.getElementsByTagName('style');

                for (var i = 0; i < styles.length; i++) {
                    var rules = this.getCssRules(mxUtils.getTextContent(styles[i]));

                    for (var j = 0; j < rules.length; j++) {
                        this.addSvgRule(container, rules[j], svg, styles[i], rules, j, regex);
                    }
                }
            }
        }
    } catch (e) {
        // ignore
    }

    return container;
};

/**
 * Adds the label menu items to the given menu and parent.
 */
StyleFormatPanel.prototype.addSvgRule = function (container, rule, svg, styleElem, rules, ruleIndex, regex) {
    var ui = this.editorUi;
    var graph = ui.editor.graph;

    if (regex.test(rule.selectorText)) {
        function rgb2hex(rgb) {
            rgb = rgb.match(/^rgba?[\s+]?\([\s+]?(\d+)[\s+]?,[\s+]?(\d+)[\s+]?,[\s+]?(\d+)[\s+]?/i);

            return (rgb && rgb.length === 4) ? "#" +
                ("0" + parseInt(rgb[1], 10).toString(16)).slice(-2) +
                ("0" + parseInt(rgb[2], 10).toString(16)).slice(-2) +
                ("0" + parseInt(rgb[3], 10).toString(16)).slice(-2) : '';
        };

        var addStyleRule = mxUtils.bind(this, function (rule, key, label) {
            if (rule.style[key] != '') {
                var option = this.createColorOption(label + ' ' + rule.selectorText, function () {
                        return rgb2hex(rule.style[key]);
                    }, function (color) {
                        rules[ruleIndex].style[key] = color;
                        var cssTxt = '';

                        for (var i = 0; i < rules.length; i++) {
                            cssTxt += rules[i].cssText + ' ';
                        }

                        styleElem.textContent = cssTxt;
                        var xml = mxUtils.getXml(svg.documentElement);

                        graph.setCellStyles(mxConstants.STYLE_IMAGE, 'data:image/svg+xml,' +
                            ((window.btoa) ? btoa(xml) : Base64.encode(xml, true)),
                            graph.getSelectionCells());
                    }, '#ffffff',
                    {
                        install: function (apply) {
                            // ignore
                        },
                        destroy: function () {
                            // ignore
                        }
                    });

                container.appendChild(option);

                // Shows container if rules are added
                container.style.display = '';
            }
        });

        addStyleRule(rule, 'fill', mxResources.get('fill'));
        addStyleRule(rule, 'stroke', mxResources.get('line'));
    }
};

/**
 * Adds the label menu items to the given menu and parent.
 */
StyleFormatPanel.prototype.addEditOps = function (div) {
    var ss = this.format.getSelectionState();

    if (ss.image) {
        var btn2 = mxUtils.button(mxResources.get('editImage'), mxUtils.bind(this, function (evt) {
            this.editorUi.actions.get('image').funct();
        }));

        btn2.setAttribute('title', mxResources.get('editImage'));
        btn2.style.marginBottom = '2px';

        btn2.style.width = '202px';

        div.appendChild(btn2);
    }

    return div;
};

/**
 * Adds the label menu items to the given menu and parent.
 */
StyleFormatPanel.prototype.addFill = function (container) {
    var ui = this.editorUi;
    var graph = ui.editor.graph;
    var ss = this.format.getSelectionState();
    container.style.paddingTop = '6px';
    container.style.paddingBottom = '6px';

    // Adds gradient direction option
    var gradientSelect = document.createElement('select');
    gradientSelect.style.position = 'absolute';
    gradientSelect.style.marginTop = '-2px';
    gradientSelect.style.right = (mxClient.IS_QUIRKS) ? '52px' : '72px';
    gradientSelect.style.width = '70px';

    // Stops events from bubbling to color option event handler
    mxEvent.addListener(gradientSelect, 'click', function (evt) {
        mxEvent.consume(evt);
    });

    var gradientPanel = this.createCellColorOption(mxResources.get('gradient'), mxConstants.STYLE_GRADIENTCOLOR, '#ffffff', function (color) {
        if (color == null || color == mxConstants.NONE) {
            gradientSelect.style.display = 'none';
        } else {
            gradientSelect.style.display = '';
        }
    });

    var fillKey = (ss.style.shape == 'image') ? mxConstants.STYLE_IMAGE_BACKGROUND : mxConstants.STYLE_FILLCOLOR;
    var label = (ss.style.shape == 'image') ? mxResources.get('background') : mxResources.get('fill');

    var fillPanel = this.createCellColorOption(label, fillKey, '#ffffff');
    fillPanel.style.fontWeight = 'bold';

    var tmpColor = mxUtils.getValue(ss.style, fillKey, null);
    gradientPanel.style.display = (tmpColor != null && tmpColor != mxConstants.NONE &&
        ss.fill && ss.style.shape != 'image') ? '' : 'none';

    var directions = [mxConstants.DIRECTION_NORTH, mxConstants.DIRECTION_EAST,
        mxConstants.DIRECTION_SOUTH, mxConstants.DIRECTION_WEST];

    for (var i = 0; i < directions.length; i++) {
        var gradientOption = document.createElement('option');
        gradientOption.setAttribute('value', directions[i]);
        mxUtils.write(gradientOption, mxResources.get(directions[i]));
        gradientSelect.appendChild(gradientOption);
    }

    gradientPanel.appendChild(gradientSelect);

    var listener = mxUtils.bind(this, function () {
        ss = this.format.getSelectionState();
        var value = mxUtils.getValue(ss.style, mxConstants.STYLE_GRADIENT_DIRECTION, mxConstants.DIRECTION_SOUTH);

        // Handles empty string which is not allowed as a value
        if (value == '') {
            value = mxConstants.DIRECTION_SOUTH;
        }

        gradientSelect.value = value;
        container.style.display = (ss.fill) ? '' : 'none';

        var fillColor = mxUtils.getValue(ss.style, mxConstants.STYLE_FILLCOLOR, null);

        if (!ss.fill || ss.containsImage || fillColor == null || fillColor == mxConstants.NONE || ss.style.shape == 'filledEdge') {
            gradientPanel.style.display = 'none';
        } else {
            gradientPanel.style.display = '';
        }
    });

    graph.getModel().addListener(mxEvent.CHANGE, listener);
    this.listeners.push({
        destroy: function () {
            graph.getModel().removeListener(listener);
        }
    });
    listener();

    mxEvent.addListener(gradientSelect, 'change', function (evt) {
        graph.setCellStyles(mxConstants.STYLE_GRADIENT_DIRECTION, gradientSelect.value, graph.getSelectionCells());
        mxEvent.consume(evt);
    });

    container.appendChild(fillPanel);
    container.appendChild(gradientPanel);

    // Adds custom colors
    var custom = this.getCustomColors();

    for (var i = 0; i < custom.length; i++) {
        container.appendChild(this.createCellColorOption(custom[i].title, custom[i].key, custom[i].defaultValue));
    }

    return container;
};

/**
 * Adds the label menu items to the given menu and parent.
 */
StyleFormatPanel.prototype.getCustomColors = function () {
    var ss = this.format.getSelectionState();
    var result = [];

    if (ss.style.shape == 'swimlane') {
        result.push({title: mxResources.get('laneColor'), key: 'swimlaneFillColor', defaultValue: '#ffffff'});
    }

    return result;
};

/**
 * Adds the label menu items to the given menu and parent.
 */
StyleFormatPanel.prototype.addStroke = function (container) {
    var ui = this.editorUi;
    var graph = ui.editor.graph;
    var ss = this.format.getSelectionState();

    container.style.paddingTop = '4px';
    container.style.paddingBottom = '4px';
    container.style.whiteSpace = 'normal';

    var colorPanel = document.createElement('div');
    colorPanel.style.fontWeight = 'bold';

    // Adds gradient direction option
    var styleSelect = document.createElement('select');
    styleSelect.style.position = 'absolute';
    styleSelect.style.marginTop = '-2px';
    styleSelect.style.right = '72px';
    styleSelect.style.width = '80px';

    var styles = ['sharp', 'rounded', 'curved'];

    for (var i = 0; i < styles.length; i++) {
        var styleOption = document.createElement('option');
        styleOption.setAttribute('value', styles[i]);
        mxUtils.write(styleOption, mxResources.get(styles[i]));
        styleSelect.appendChild(styleOption);
    }

    mxEvent.addListener(styleSelect, 'change', function (evt) {
        graph.getModel().beginUpdate();
        try {
            var keys = [mxConstants.STYLE_ROUNDED, mxConstants.STYLE_CURVED];
            // Default for rounded is 1
            var values = ['0', null];

            if (styleSelect.value == 'rounded') {
                values = ['1', null];
            } else if (styleSelect.value == 'curved') {
                values = [null, '1'];
            }

            for (var i = 0; i < keys.length; i++) {
                graph.setCellStyles(keys[i], values[i], graph.getSelectionCells());
            }

            ui.fireEvent(new mxEventObject('styleChanged', 'keys', keys,
                'values', values, 'cells', graph.getSelectionCells()));
        } finally {
            graph.getModel().endUpdate();
        }

        mxEvent.consume(evt);
    });

    // Stops events from bubbling to color option event handler
    mxEvent.addListener(styleSelect, 'click', function (evt) {
        mxEvent.consume(evt);
    });

    var strokeKey = (ss.style.shape == 'image') ? mxConstants.STYLE_IMAGE_BORDER : mxConstants.STYLE_STROKECOLOR;
    var label = (ss.style.shape == 'image') ? mxResources.get('border') : mxResources.get('line');

    var lineColor = this.createCellColorOption(label, strokeKey, '#000000');
    lineColor.appendChild(styleSelect);
    colorPanel.appendChild(lineColor);

    // Used if only edges selected
    var stylePanel = colorPanel.cloneNode(false);
    stylePanel.style.fontWeight = 'normal';
    stylePanel.style.whiteSpace = 'nowrap';
    stylePanel.style.position = 'relative';
    stylePanel.style.paddingLeft = '16px'
    stylePanel.style.marginBottom = '2px';
    stylePanel.style.marginTop = '2px';
    stylePanel.className = 'geToolbarContainer';

    var addItem = mxUtils.bind(this, function (menu, width, cssName, keys, values) {
        var item = this.editorUi.menus.styleChange(menu, '', keys, values, 'geIcon', null);

        var pat = document.createElement('div');
        pat.style.width = width + 'px';
        pat.style.height = '1px';
        pat.style.borderBottom = '1px ' + cssName + ' ' + this.defaultStrokeColor;
        pat.style.paddingTop = '6px';

        item.firstChild.firstChild.style.padding = '0px 4px 0px 4px';
        item.firstChild.firstChild.style.width = width + 'px';
        item.firstChild.firstChild.appendChild(pat);

        return item;
    });

    var pattern = this.editorUi.toolbar.addMenuFunctionInContainer(stylePanel, 'geSprite-orthogonal', mxResources.get('pattern'), false, mxUtils.bind(this, function (menu) {
        addItem(menu, 75, 'solid', [mxConstants.STYLE_DASHED, mxConstants.STYLE_DASH_PATTERN], [null, null]).setAttribute('title', mxResources.get('solid'));
        addItem(menu, 75, 'dashed', [mxConstants.STYLE_DASHED, mxConstants.STYLE_DASH_PATTERN], ['1', null]).setAttribute('title', mxResources.get('dashed'));
        addItem(menu, 75, 'dotted', [mxConstants.STYLE_DASHED, mxConstants.STYLE_DASH_PATTERN], ['1', '1 1']).setAttribute('title', mxResources.get('dotted') + ' (1)');
        addItem(menu, 75, 'dotted', [mxConstants.STYLE_DASHED, mxConstants.STYLE_DASH_PATTERN], ['1', '1 2']).setAttribute('title', mxResources.get('dotted') + ' (2)');
        addItem(menu, 75, 'dotted', [mxConstants.STYLE_DASHED, mxConstants.STYLE_DASH_PATTERN], ['1', '1 4']).setAttribute('title', mxResources.get('dotted') + ' (3)');
    }));

    // Used for mixed selection (vertices and edges)
    var altStylePanel = stylePanel.cloneNode(false);

    var edgeShape = this.editorUi.toolbar.addMenuFunctionInContainer(altStylePanel, 'geSprite-connection', mxResources.get('connection'), false, mxUtils.bind(this, function (menu) {
        this.editorUi.menus.styleChange(menu, '', [mxConstants.STYLE_SHAPE, mxConstants.STYLE_STARTSIZE, mxConstants.STYLE_ENDSIZE, 'width'], [null, null, null, null], 'geIcon geSprite geSprite-connection', null, true).setAttribute('title', mxResources.get('line'));
        this.editorUi.menus.styleChange(menu, '', [mxConstants.STYLE_SHAPE, mxConstants.STYLE_STARTSIZE, mxConstants.STYLE_ENDSIZE, 'width'], ['link', null, null, null], 'geIcon geSprite geSprite-linkedge', null, true).setAttribute('title', mxResources.get('link'));
        this.editorUi.menus.styleChange(menu, '', [mxConstants.STYLE_SHAPE, mxConstants.STYLE_STARTSIZE, mxConstants.STYLE_ENDSIZE, 'width'], ['flexArrow', null, null, null], 'geIcon geSprite geSprite-arrow', null, true).setAttribute('title', mxResources.get('arrow'));
        this.editorUi.menus.styleChange(menu, '', [mxConstants.STYLE_SHAPE, mxConstants.STYLE_STARTSIZE, mxConstants.STYLE_ENDSIZE, 'width'], ['arrow', null, null, null], 'geIcon geSprite geSprite-simplearrow', null, true).setAttribute('title', mxResources.get('simpleArrow'));
    }));

    var altPattern = this.editorUi.toolbar.addMenuFunctionInContainer(altStylePanel, 'geSprite-orthogonal', mxResources.get('pattern'), false, mxUtils.bind(this, function (menu) {
        addItem(menu, 33, 'solid', [mxConstants.STYLE_DASHED, mxConstants.STYLE_DASH_PATTERN], [null, null]).setAttribute('title', mxResources.get('solid'));
        addItem(menu, 33, 'dashed', [mxConstants.STYLE_DASHED, mxConstants.STYLE_DASH_PATTERN], ['1', null]).setAttribute('title', mxResources.get('dashed'));
        addItem(menu, 33, 'dotted', [mxConstants.STYLE_DASHED, mxConstants.STYLE_DASH_PATTERN], ['1', '1 1']).setAttribute('title', mxResources.get('dotted') + ' (1)');
        addItem(menu, 33, 'dotted', [mxConstants.STYLE_DASHED, mxConstants.STYLE_DASH_PATTERN], ['1', '1 2']).setAttribute('title', mxResources.get('dotted') + ' (2)');
        addItem(menu, 33, 'dotted', [mxConstants.STYLE_DASHED, mxConstants.STYLE_DASH_PATTERN], ['1', '1 4']).setAttribute('title', mxResources.get('dotted') + ' (3)');
    }));

    var stylePanel2 = stylePanel.cloneNode(false);

    // Stroke width
    var input = document.createElement('input');
    input.style.textAlign = 'right';
    input.style.marginTop = '2px';
    input.style.width = '41px';
    input.setAttribute('title', mxResources.get('linewidth'));

    stylePanel.appendChild(input);

    var altInput = input.cloneNode(true);
    altStylePanel.appendChild(altInput);

    function update(evt) {
        // Maximum stroke width is 999
        var value = parseInt(input.value);
        value = Math.min(999, Math.max(1, (isNaN(value)) ? 1 : value));

        if (value != mxUtils.getValue(ss.style, mxConstants.STYLE_STROKEWIDTH, 1)) {
            graph.setCellStyles(mxConstants.STYLE_STROKEWIDTH, value, graph.getSelectionCells());
            ui.fireEvent(new mxEventObject('styleChanged', 'keys', [mxConstants.STYLE_STROKEWIDTH],
                'values', [value], 'cells', graph.getSelectionCells()));
        }

        input.value = value + ' pt';
        mxEvent.consume(evt);
    };

    function altUpdate(evt) {
        // Maximum stroke width is 999
        var value = parseInt(altInput.value);
        value = Math.min(999, Math.max(1, (isNaN(value)) ? 1 : value));

        if (value != mxUtils.getValue(ss.style, mxConstants.STYLE_STROKEWIDTH, 1)) {
            graph.setCellStyles(mxConstants.STYLE_STROKEWIDTH, value, graph.getSelectionCells());
            ui.fireEvent(new mxEventObject('styleChanged', 'keys', [mxConstants.STYLE_STROKEWIDTH],
                'values', [value], 'cells', graph.getSelectionCells()));
        }

        altInput.value = value + ' pt';
        mxEvent.consume(evt);
    };

    var stepper = this.createStepper(input, update, 1, 9);
    stepper.style.display = input.style.display;
    stepper.style.marginTop = '2px';
    stylePanel.appendChild(stepper);

    var altStepper = this.createStepper(altInput, altUpdate, 1, 9);
    altStepper.style.display = altInput.style.display;
    altStepper.style.marginTop = '2px';
    altStylePanel.appendChild(altStepper);

    if (!mxClient.IS_QUIRKS) {
        input.style.position = 'absolute';
        input.style.right = '32px';
        input.style.height = '15px';
        stepper.style.right = '20px';

        altInput.style.position = 'absolute';
        altInput.style.right = '32px';
        altInput.style.height = '15px';
        altStepper.style.right = '20px';
    } else {
        input.style.height = '17px';
        altInput.style.height = '17px';
    }

    mxEvent.addListener(input, 'blur', update);
    mxEvent.addListener(input, 'change', update);

    mxEvent.addListener(altInput, 'blur', altUpdate);
    mxEvent.addListener(altInput, 'change', altUpdate);

    if (mxClient.IS_QUIRKS) {
        mxUtils.br(stylePanel2);
        mxUtils.br(stylePanel2);
    }

    var edgeStyle = this.editorUi.toolbar.addMenuFunctionInContainer(stylePanel2, 'geSprite-orthogonal', mxResources.get('waypoints'), false, mxUtils.bind(this, function (menu) {
        if (ss.style.shape != 'arrow') {
            this.editorUi.menus.edgeStyleChange(menu, '', [mxConstants.STYLE_EDGE, mxConstants.STYLE_CURVED, mxConstants.STYLE_NOEDGESTYLE], [null, null, null], 'geIcon geSprite geSprite-straight', null, true).setAttribute('title', mxResources.get('straight'));
            this.editorUi.menus.edgeStyleChange(menu, '', [mxConstants.STYLE_EDGE, mxConstants.STYLE_CURVED, mxConstants.STYLE_NOEDGESTYLE], ['orthogonalEdgeStyle', null, null], 'geIcon geSprite geSprite-orthogonal', null, true).setAttribute('title', mxResources.get('orthogonal'));
            this.editorUi.menus.edgeStyleChange(menu, '', [mxConstants.STYLE_EDGE, mxConstants.STYLE_ELBOW, mxConstants.STYLE_CURVED, mxConstants.STYLE_NOEDGESTYLE], ['elbowEdgeStyle', null, null, null], 'geIcon geSprite geSprite-horizontalelbow', null, true).setAttribute('title', mxResources.get('simple'));
            this.editorUi.menus.edgeStyleChange(menu, '', [mxConstants.STYLE_EDGE, mxConstants.STYLE_ELBOW, mxConstants.STYLE_CURVED, mxConstants.STYLE_NOEDGESTYLE], ['elbowEdgeStyle', 'vertical', null, null], 'geIcon geSprite geSprite-verticalelbow', null, true).setAttribute('title', mxResources.get('simple'));
            this.editorUi.menus.edgeStyleChange(menu, '', [mxConstants.STYLE_EDGE, mxConstants.STYLE_ELBOW, mxConstants.STYLE_CURVED, mxConstants.STYLE_NOEDGESTYLE], ['isometricEdgeStyle', null, null, null], 'geIcon geSprite geSprite-horizontalisometric', null, true).setAttribute('title', mxResources.get('isometric'));
            this.editorUi.menus.edgeStyleChange(menu, '', [mxConstants.STYLE_EDGE, mxConstants.STYLE_ELBOW, mxConstants.STYLE_CURVED, mxConstants.STYLE_NOEDGESTYLE], ['isometricEdgeStyle', 'vertical', null, null], 'geIcon geSprite geSprite-verticalisometric', null, true).setAttribute('title', mxResources.get('isometric'));

            if (ss.style.shape == 'connector') {
                this.editorUi.menus.edgeStyleChange(menu, '', [mxConstants.STYLE_EDGE, mxConstants.STYLE_CURVED, mxConstants.STYLE_NOEDGESTYLE], ['orthogonalEdgeStyle', '1', null], 'geIcon geSprite geSprite-curved', null, true).setAttribute('title', mxResources.get('curved'));
            }

            this.editorUi.menus.edgeStyleChange(menu, '', [mxConstants.STYLE_EDGE, mxConstants.STYLE_CURVED, mxConstants.STYLE_NOEDGESTYLE], ['entityRelationEdgeStyle', null, null], 'geIcon geSprite geSprite-entity', null, true).setAttribute('title', mxResources.get('entityRelation'));
        }
    }));

    var lineStart = this.editorUi.toolbar.addMenuFunctionInContainer(stylePanel2, 'geSprite-startclassic', mxResources.get('linestart'), false, mxUtils.bind(this, function (menu) {
        if (ss.style.shape == 'connector' || ss.style.shape == 'flexArrow' || ss.style.shape == 'filledEdge') {
            var item = this.editorUi.menus.edgeStyleChange(menu, '', [mxConstants.STYLE_STARTARROW, 'startFill'], [mxConstants.NONE, 0], 'geIcon', null, false);
            item.setAttribute('title', mxResources.get('none'));
            item.firstChild.firstChild.innerHTML = '<font style="font-size:10px;">' + mxUtils.htmlEntities(mxResources.get('none')) + '</font>';

            if (ss.style.shape == 'connector' || ss.style.shape == 'filledEdge') {
                this.editorUi.menus.edgeStyleChange(menu, '', [mxConstants.STYLE_STARTARROW, 'startFill'], [mxConstants.ARROW_CLASSIC, 1], 'geIcon geSprite geSprite-startclassic', null, false).setAttribute('title', mxResources.get('classic'));
                this.editorUi.menus.edgeStyleChange(menu, '', [mxConstants.STYLE_STARTARROW, 'startFill'], [mxConstants.ARROW_CLASSIC_THIN, 1], 'geIcon geSprite geSprite-startclassicthin', null, false);
                this.editorUi.menus.edgeStyleChange(menu, '', [mxConstants.STYLE_STARTARROW, 'startFill'], [mxConstants.ARROW_OPEN, 0], 'geIcon geSprite geSprite-startopen', null, false).setAttribute('title', mxResources.get('openArrow'));
                this.editorUi.menus.edgeStyleChange(menu, '', [mxConstants.STYLE_STARTARROW, 'startFill'], [mxConstants.ARROW_OPEN_THIN, 0], 'geIcon geSprite geSprite-startopenthin', null, false);
                this.editorUi.menus.edgeStyleChange(menu, '', [mxConstants.STYLE_STARTARROW, 'startFill'], ['openAsync', 0], 'geIcon geSprite geSprite-startopenasync', null, false);
                this.editorUi.menus.edgeStyleChange(menu, '', [mxConstants.STYLE_STARTARROW, 'startFill'], [mxConstants.ARROW_BLOCK, 1], 'geIcon geSprite geSprite-startblock', null, false).setAttribute('title', mxResources.get('block'));
                this.editorUi.menus.edgeStyleChange(menu, '', [mxConstants.STYLE_STARTARROW, 'startFill'], [mxConstants.ARROW_BLOCK_THIN, 1], 'geIcon geSprite geSprite-startblockthin', null, false);
                this.editorUi.menus.edgeStyleChange(menu, '', [mxConstants.STYLE_STARTARROW, 'startFill'], ['async', 1], 'geIcon geSprite geSprite-startasync', null, false);
                this.editorUi.menus.edgeStyleChange(menu, '', [mxConstants.STYLE_STARTARROW, 'startFill'], [mxConstants.ARROW_OVAL, 1], 'geIcon geSprite geSprite-startoval', null, false).setAttribute('title', mxResources.get('oval'));
                this.editorUi.menus.edgeStyleChange(menu, '', [mxConstants.STYLE_STARTARROW, 'startFill'], [mxConstants.ARROW_DIAMOND, 1], 'geIcon geSprite geSprite-startdiamond', null, false).setAttribute('title', mxResources.get('diamond'));
                this.editorUi.menus.edgeStyleChange(menu, '', [mxConstants.STYLE_STARTARROW, 'startFill'], [mxConstants.ARROW_DIAMOND_THIN, 1], 'geIcon geSprite geSprite-startthindiamond', null, false).setAttribute('title', mxResources.get('diamondThin'));
                this.editorUi.menus.edgeStyleChange(menu, '', [mxConstants.STYLE_STARTARROW, 'startFill'], [mxConstants.ARROW_CLASSIC, 0], 'geIcon geSprite geSprite-startclassictrans', null, false).setAttribute('title', mxResources.get('classic'));
                this.editorUi.menus.edgeStyleChange(menu, '', [mxConstants.STYLE_STARTARROW, 'startFill'], [mxConstants.ARROW_CLASSIC_THIN, 0], 'geIcon geSprite geSprite-startclassicthintrans', null, false);
                this.editorUi.menus.edgeStyleChange(menu, '', [mxConstants.STYLE_STARTARROW, 'startFill'], [mxConstants.ARROW_BLOCK, 0], 'geIcon geSprite geSprite-startblocktrans', null, false).setAttribute('title', mxResources.get('block'));
                this.editorUi.menus.edgeStyleChange(menu, '', [mxConstants.STYLE_STARTARROW, 'startFill'], [mxConstants.ARROW_BLOCK_THIN, 0], 'geIcon geSprite geSprite-startblockthintrans', null, false);
                this.editorUi.menus.edgeStyleChange(menu, '', [mxConstants.STYLE_STARTARROW, 'startFill'], ['async', 0], 'geIcon geSprite geSprite-startasynctrans', null, false);
                this.editorUi.menus.edgeStyleChange(menu, '', [mxConstants.STYLE_STARTARROW, 'startFill'], [mxConstants.ARROW_OVAL, 0], 'geIcon geSprite geSprite-startovaltrans', null, false).setAttribute('title', mxResources.get('oval'));
                this.editorUi.menus.edgeStyleChange(menu, '', [mxConstants.STYLE_STARTARROW, 'startFill'], [mxConstants.ARROW_DIAMOND, 0], 'geIcon geSprite geSprite-startdiamondtrans', null, false).setAttribute('title', mxResources.get('diamond'));
                this.editorUi.menus.edgeStyleChange(menu, '', [mxConstants.STYLE_STARTARROW, 'startFill'], [mxConstants.ARROW_DIAMOND_THIN, 0], 'geIcon geSprite geSprite-startthindiamondtrans', null, false).setAttribute('title', mxResources.get('diamondThin'));

                this.editorUi.menus.edgeStyleChange(menu, '', [mxConstants.STYLE_STARTARROW, 'startFill'], ['dash', 0], 'geIcon geSprite geSprite-startdash', null, false);
                this.editorUi.menus.edgeStyleChange(menu, '', [mxConstants.STYLE_STARTARROW, 'startFill'], ['cross', 0], 'geIcon geSprite geSprite-startcross', null, false);
                this.editorUi.menus.edgeStyleChange(menu, '', [mxConstants.STYLE_STARTARROW, 'startFill'], ['circlePlus', 0], 'geIcon geSprite geSprite-startcircleplus', null, false);
                this.editorUi.menus.edgeStyleChange(menu, '', [mxConstants.STYLE_STARTARROW, 'startFill'], ['circle', 1], 'geIcon geSprite geSprite-startcircle', null, false);
                this.editorUi.menus.edgeStyleChange(menu, '', [mxConstants.STYLE_STARTARROW, 'startFill'], ['ERone', 0], 'geIcon geSprite geSprite-starterone', null, false);
                this.editorUi.menus.edgeStyleChange(menu, '', [mxConstants.STYLE_STARTARROW, 'startFill'], ['ERmandOne', 0], 'geIcon geSprite geSprite-starteronetoone', null, false);
                this.editorUi.menus.edgeStyleChange(menu, '', [mxConstants.STYLE_STARTARROW, 'startFill'], ['ERmany', 0], 'geIcon geSprite geSprite-startermany', null, false);
                this.editorUi.menus.edgeStyleChange(menu, '', [mxConstants.STYLE_STARTARROW, 'startFill'], ['ERoneToMany', 0], 'geIcon geSprite geSprite-starteronetomany', null, false);
                this.editorUi.menus.edgeStyleChange(menu, '', [mxConstants.STYLE_STARTARROW, 'startFill'], ['ERzeroToOne', 1], 'geIcon geSprite geSprite-starteroneopt', null, false);
                this.editorUi.menus.edgeStyleChange(menu, '', [mxConstants.STYLE_STARTARROW, 'startFill'], ['ERzeroToMany', 1], 'geIcon geSprite geSprite-startermanyopt', null, false);
            } else {
                this.editorUi.menus.edgeStyleChange(menu, '', [mxConstants.STYLE_STARTARROW], [mxConstants.ARROW_BLOCK], 'geIcon geSprite geSprite-startblocktrans', null, false).setAttribute('title', mxResources.get('block'));
            }
        }
    }));

    var lineEnd = this.editorUi.toolbar.addMenuFunctionInContainer(stylePanel2, 'geSprite-endclassic', mxResources.get('lineend'), false, mxUtils.bind(this, function (menu) {
        if (ss.style.shape == 'connector' || ss.style.shape == 'flexArrow' || ss.style.shape == 'filledEdge') {
            var item = this.editorUi.menus.edgeStyleChange(menu, '', [mxConstants.STYLE_ENDARROW, 'endFill'], [mxConstants.NONE, 0], 'geIcon', null, false);
            item.setAttribute('title', mxResources.get('none'));
            item.firstChild.firstChild.innerHTML = '<font style="font-size:10px;">' + mxUtils.htmlEntities(mxResources.get('none')) + '</font>';

            if (ss.style.shape == 'connector' || ss.style.shape == 'filledEdge') {
                this.editorUi.menus.edgeStyleChange(menu, '', [mxConstants.STYLE_ENDARROW, 'endFill'], [mxConstants.ARROW_CLASSIC, 1], 'geIcon geSprite geSprite-endclassic', null, false).setAttribute('title', mxResources.get('classic'));
                this.editorUi.menus.edgeStyleChange(menu, '', [mxConstants.STYLE_ENDARROW, 'endFill'], [mxConstants.ARROW_CLASSIC_THIN, 1], 'geIcon geSprite geSprite-endclassicthin', null, false);
                this.editorUi.menus.edgeStyleChange(menu, '', [mxConstants.STYLE_ENDARROW, 'endFill'], [mxConstants.ARROW_OPEN, 0], 'geIcon geSprite geSprite-endopen', null, false).setAttribute('title', mxResources.get('openArrow'));
                this.editorUi.menus.edgeStyleChange(menu, '', [mxConstants.STYLE_ENDARROW, 'endFill'], [mxConstants.ARROW_OPEN_THIN, 0], 'geIcon geSprite geSprite-endopenthin', null, false);
                this.editorUi.menus.edgeStyleChange(menu, '', [mxConstants.STYLE_ENDARROW, 'endFill'], ['openAsync', 0], 'geIcon geSprite geSprite-endopenasync', null, false);
                this.editorUi.menus.edgeStyleChange(menu, '', [mxConstants.STYLE_ENDARROW, 'endFill'], [mxConstants.ARROW_BLOCK, 1], 'geIcon geSprite geSprite-endblock', null, false).setAttribute('title', mxResources.get('block'));
                this.editorUi.menus.edgeStyleChange(menu, '', [mxConstants.STYLE_ENDARROW, 'endFill'], [mxConstants.ARROW_BLOCK_THIN, 1], 'geIcon geSprite geSprite-endblockthin', null, false);
                this.editorUi.menus.edgeStyleChange(menu, '', [mxConstants.STYLE_ENDARROW, 'endFill'], ['async', 1], 'geIcon geSprite geSprite-endasync', null, false);
                this.editorUi.menus.edgeStyleChange(menu, '', [mxConstants.STYLE_ENDARROW, 'endFill'], [mxConstants.ARROW_OVAL, 1], 'geIcon geSprite geSprite-endoval', null, false).setAttribute('title', mxResources.get('oval'));
                this.editorUi.menus.edgeStyleChange(menu, '', [mxConstants.STYLE_ENDARROW, 'endFill'], [mxConstants.ARROW_DIAMOND, 1], 'geIcon geSprite geSprite-enddiamond', null, false).setAttribute('title', mxResources.get('diamond'));
                this.editorUi.menus.edgeStyleChange(menu, '', [mxConstants.STYLE_ENDARROW, 'endFill'], [mxConstants.ARROW_DIAMOND_THIN, 1], 'geIcon geSprite geSprite-endthindiamond', null, false).setAttribute('title', mxResources.get('diamondThin'));
                this.editorUi.menus.edgeStyleChange(menu, '', [mxConstants.STYLE_ENDARROW, 'endFill'], [mxConstants.ARROW_CLASSIC, 0], 'geIcon geSprite geSprite-endclassictrans', null, false).setAttribute('title', mxResources.get('classic'));
                this.editorUi.menus.edgeStyleChange(menu, '', [mxConstants.STYLE_ENDARROW, 'endFill'], [mxConstants.ARROW_CLASSIC_THIN, 0], 'geIcon geSprite geSprite-endclassicthintrans', null, false);
                this.editorUi.menus.edgeStyleChange(menu, '', [mxConstants.STYLE_ENDARROW, 'endFill'], [mxConstants.ARROW_BLOCK, 0], 'geIcon geSprite geSprite-endblocktrans', null, false).setAttribute('title', mxResources.get('block'));
                this.editorUi.menus.edgeStyleChange(menu, '', [mxConstants.STYLE_ENDARROW, 'endFill'], [mxConstants.ARROW_BLOCK_THIN, 0], 'geIcon geSprite geSprite-endblockthintrans', null, false);
                this.editorUi.menus.edgeStyleChange(menu, '', [mxConstants.STYLE_ENDARROW, 'endFill'], ['async', 0], 'geIcon geSprite geSprite-endasynctrans', null, false);
                this.editorUi.menus.edgeStyleChange(menu, '', [mxConstants.STYLE_ENDARROW, 'endFill'], [mxConstants.ARROW_OVAL, 0], 'geIcon geSprite geSprite-endovaltrans', null, false).setAttribute('title', mxResources.get('oval'));
                this.editorUi.menus.edgeStyleChange(menu, '', [mxConstants.STYLE_ENDARROW, 'endFill'], [mxConstants.ARROW_DIAMOND, 0], 'geIcon geSprite geSprite-enddiamondtrans', null, false).setAttribute('title', mxResources.get('diamond'));
                this.editorUi.menus.edgeStyleChange(menu, '', [mxConstants.STYLE_ENDARROW, 'endFill'], [mxConstants.ARROW_DIAMOND_THIN, 0], 'geIcon geSprite geSprite-endthindiamondtrans', null, false).setAttribute('title', mxResources.get('diamondThin'));

                this.editorUi.menus.edgeStyleChange(menu, '', [mxConstants.STYLE_ENDARROW, 'endFill'], ['dash', 0], 'geIcon geSprite geSprite-enddash', null, false);
                this.editorUi.menus.edgeStyleChange(menu, '', [mxConstants.STYLE_ENDARROW, 'endFill'], ['cross', 0], 'geIcon geSprite geSprite-endcross', null, false);
                this.editorUi.menus.edgeStyleChange(menu, '', [mxConstants.STYLE_ENDARROW, 'endFill'], ['circlePlus', 0], 'geIcon geSprite geSprite-endcircleplus', null, false);
                this.editorUi.menus.edgeStyleChange(menu, '', [mxConstants.STYLE_ENDARROW, 'endFill'], ['circle', 1], 'geIcon geSprite geSprite-endcircle', null, false);
                this.editorUi.menus.edgeStyleChange(menu, '', [mxConstants.STYLE_ENDARROW, 'endFill'], ['ERone', 0], 'geIcon geSprite geSprite-enderone', null, false);
                this.editorUi.menus.edgeStyleChange(menu, '', [mxConstants.STYLE_ENDARROW, 'endFill'], ['ERmandOne', 0], 'geIcon geSprite geSprite-enderonetoone', null, false);
                this.editorUi.menus.edgeStyleChange(menu, '', [mxConstants.STYLE_ENDARROW, 'endFill'], ['ERmany', 0], 'geIcon geSprite geSprite-endermany', null, false);
                this.editorUi.menus.edgeStyleChange(menu, '', [mxConstants.STYLE_ENDARROW, 'endFill'], ['ERoneToMany', 0], 'geIcon geSprite geSprite-enderonetomany', null, false);
                this.editorUi.menus.edgeStyleChange(menu, '', [mxConstants.STYLE_ENDARROW, 'endFill'], ['ERzeroToOne', 1], 'geIcon geSprite geSprite-enderoneopt', null, false);
                this.editorUi.menus.edgeStyleChange(menu, '', [mxConstants.STYLE_ENDARROW, 'endFill'], ['ERzeroToMany', 1], 'geIcon geSprite geSprite-endermanyopt', null, false);
            } else {
                this.editorUi.menus.edgeStyleChange(menu, '', [mxConstants.STYLE_ENDARROW], [mxConstants.ARROW_BLOCK], 'geIcon geSprite geSprite-endblocktrans', null, false).setAttribute('title', mxResources.get('block'));
            }
        }
    }));

    this.addArrow(edgeShape, 8);
    this.addArrow(edgeStyle);
    this.addArrow(lineStart);
    this.addArrow(lineEnd);

    var symbol = this.addArrow(pattern, 9);
    symbol.className = 'geIcon';
    symbol.style.width = '84px';

    var altSymbol = this.addArrow(altPattern, 9);
    altSymbol.className = 'geIcon';
    altSymbol.style.width = '22px';

    var solid = document.createElement('div');
    solid.style.width = '85px';
    solid.style.height = '1px';
    solid.style.borderBottom = '1px solid ' + this.defaultStrokeColor;
    solid.style.marginBottom = '9px';
    symbol.appendChild(solid);

    var altSolid = document.createElement('div');
    altSolid.style.width = '23px';
    altSolid.style.height = '1px';
    altSolid.style.borderBottom = '1px solid ' + this.defaultStrokeColor;
    altSolid.style.marginBottom = '9px';
    altSymbol.appendChild(altSolid);

    pattern.style.height = '15px';
    altPattern.style.height = '15px';
    edgeShape.style.height = '15px';
    edgeStyle.style.height = '17px';
    lineStart.style.marginLeft = '3px';
    lineStart.style.height = '17px';
    lineEnd.style.marginLeft = '3px';
    lineEnd.style.height = '17px';

    container.appendChild(colorPanel);
    container.appendChild(altStylePanel);
    container.appendChild(stylePanel);

    var arrowPanel = stylePanel.cloneNode(false);
    arrowPanel.style.paddingBottom = '6px';
    arrowPanel.style.paddingTop = '4px';
    arrowPanel.style.fontWeight = 'normal';

    var span = document.createElement('div');
    span.style.position = 'absolute';
    span.style.marginLeft = '3px';
    span.style.marginBottom = '12px';
    span.style.marginTop = '2px';
    span.style.fontWeight = 'normal';
    span.style.width = '76px';

    mxUtils.write(span, mxResources.get('lineend'));
    arrowPanel.appendChild(span);

    var endSpacingUpdate, endSizeUpdate;
    var endSpacing = this.addUnitInput(arrowPanel, 'pt', 74, 33, function () {
        endSpacingUpdate.apply(this, arguments);
    });
    var endSize = this.addUnitInput(arrowPanel, 'pt', 20, 33, function () {
        endSizeUpdate.apply(this, arguments);
    });

    mxUtils.br(arrowPanel);

    var spacer = document.createElement('div');
    spacer.style.height = '8px';
    arrowPanel.appendChild(spacer);

    span = span.cloneNode(false);
    mxUtils.write(span, mxResources.get('linestart'));
    arrowPanel.appendChild(span);

    var startSpacingUpdate, startSizeUpdate;
    var startSpacing = this.addUnitInput(arrowPanel, 'pt', 74, 33, function () {
        startSpacingUpdate.apply(this, arguments);
    });
    var startSize = this.addUnitInput(arrowPanel, 'pt', 20, 33, function () {
        startSizeUpdate.apply(this, arguments);
    });

    mxUtils.br(arrowPanel);
    this.addLabel(arrowPanel, mxResources.get('spacing'), 74, 50);
    this.addLabel(arrowPanel, mxResources.get('size'), 20, 50);
    mxUtils.br(arrowPanel);

    var perimeterPanel = colorPanel.cloneNode(false);
    perimeterPanel.style.fontWeight = 'normal';
    perimeterPanel.style.position = 'relative';
    perimeterPanel.style.paddingLeft = '16px'
    perimeterPanel.style.marginBottom = '2px';
    perimeterPanel.style.marginTop = '6px';
    perimeterPanel.style.borderWidth = '0px';
    perimeterPanel.style.paddingBottom = '18px';

    var span = document.createElement('div');
    span.style.position = 'absolute';
    span.style.marginLeft = '3px';
    span.style.marginBottom = '12px';
    span.style.marginTop = '1px';
    span.style.fontWeight = 'normal';
    span.style.width = '120px';
    mxUtils.write(span, mxResources.get('perimeter'));
    perimeterPanel.appendChild(span);

    var perimeterUpdate;
    var perimeterSpacing = this.addUnitInput(perimeterPanel, 'pt', 20, 41, function () {
        perimeterUpdate.apply(this, arguments);
    });

    if (ss.edges.length == graph.getSelectionCount()) {
        container.appendChild(stylePanel2);

        if (mxClient.IS_QUIRKS) {
            mxUtils.br(container);
            mxUtils.br(container);
        }

        container.appendChild(arrowPanel);
    } else if (ss.vertices.length == graph.getSelectionCount()) {
        if (mxClient.IS_QUIRKS) {
            mxUtils.br(container);
        }

        container.appendChild(perimeterPanel);
    }

    var listener = mxUtils.bind(this, function (sender, evt, force) {
        ss = this.format.getSelectionState();
        var color = mxUtils.getValue(ss.style, strokeKey, null);

        if (force || document.activeElement != input) {
            var tmp = parseInt(mxUtils.getValue(ss.style, mxConstants.STYLE_STROKEWIDTH, 1));
            input.value = (isNaN(tmp)) ? '' : tmp + ' pt';
        }

        if (force || document.activeElement != altInput) {
            var tmp = parseInt(mxUtils.getValue(ss.style, mxConstants.STYLE_STROKEWIDTH, 1));
            altInput.value = (isNaN(tmp)) ? '' : tmp + ' pt';
        }

        styleSelect.style.visibility = (ss.style.shape == 'connector' || ss.style.shape == 'filledEdge') ? '' : 'hidden';

        if (mxUtils.getValue(ss.style, mxConstants.STYLE_CURVED, null) == '1') {
            styleSelect.value = 'curved';
        } else if (mxUtils.getValue(ss.style, mxConstants.STYLE_ROUNDED, null) == '1') {
            styleSelect.value = 'rounded';
        }

        if (mxUtils.getValue(ss.style, mxConstants.STYLE_DASHED, null) == '1') {
            if (mxUtils.getValue(ss.style, mxConstants.STYLE_DASH_PATTERN, null) == null) {
                solid.style.borderBottom = '1px dashed ' + this.defaultStrokeColor;
            } else {
                solid.style.borderBottom = '1px dotted ' + this.defaultStrokeColor;
            }
        } else {
            solid.style.borderBottom = '1px solid ' + this.defaultStrokeColor;
        }

        altSolid.style.borderBottom = solid.style.borderBottom;

        // Updates toolbar icon for edge style
        var edgeStyleDiv = edgeStyle.getElementsByTagName('div')[0];
        var es = mxUtils.getValue(ss.style, mxConstants.STYLE_EDGE, null);

        if (mxUtils.getValue(ss.style, mxConstants.STYLE_NOEDGESTYLE, null) == '1') {
            es = null;
        }

        if (es == 'orthogonalEdgeStyle' && mxUtils.getValue(ss.style, mxConstants.STYLE_CURVED, null) == '1') {
            edgeStyleDiv.className = 'geSprite geSprite-curved';
        } else if (es == 'straight' || es == 'none' || es == null) {
            edgeStyleDiv.className = 'geSprite geSprite-straight';
        } else if (es == 'entityRelationEdgeStyle') {
            edgeStyleDiv.className = 'geSprite geSprite-entity';
        } else if (es == 'elbowEdgeStyle') {
            edgeStyleDiv.className = 'geSprite ' + ((mxUtils.getValue(ss.style,
                mxConstants.STYLE_ELBOW, null) == 'vertical') ?
                'geSprite-verticalelbow' : 'geSprite-horizontalelbow');
        } else if (es == 'isometricEdgeStyle') {
            edgeStyleDiv.className = 'geSprite ' + ((mxUtils.getValue(ss.style,
                mxConstants.STYLE_ELBOW, null) == 'vertical') ?
                'geSprite-verticalisometric' : 'geSprite-horizontalisometric');
        } else {
            edgeStyleDiv.className = 'geSprite geSprite-orthogonal';
        }

        // Updates icon for edge shape
        var edgeShapeDiv = edgeShape.getElementsByTagName('div')[0];

        if (ss.style.shape == 'link') {
            edgeShapeDiv.className = 'geSprite geSprite-linkedge';
        } else if (ss.style.shape == 'flexArrow') {
            edgeShapeDiv.className = 'geSprite geSprite-arrow';
        } else if (ss.style.shape == 'arrow') {
            edgeShapeDiv.className = 'geSprite geSprite-simplearrow';
        } else {
            edgeShapeDiv.className = 'geSprite geSprite-connection';
        }

        if (ss.edges.length == graph.getSelectionCount()) {
            altStylePanel.style.display = '';
            stylePanel.style.display = 'none';
        } else {
            altStylePanel.style.display = 'none';
            stylePanel.style.display = '';
        }

        function updateArrow(marker, fill, elt, prefix) {
            var markerDiv = elt.getElementsByTagName('div')[0];

            markerDiv.className = ui.getCssClassForMarker(prefix, ss.style.shape, marker, fill);

            if (markerDiv.className == 'geSprite geSprite-noarrow') {
                markerDiv.innerHTML = mxUtils.htmlEntities(mxResources.get('none'));
                markerDiv.style.backgroundImage = 'none';
                markerDiv.style.verticalAlign = 'top';
                markerDiv.style.marginTop = '5px';
                markerDiv.style.fontSize = '10px';
                markerDiv.style.filter = 'none';
                markerDiv.style.color = this.defaultStrokeColor;
                markerDiv.nextSibling.style.marginTop = '0px';
            }

            return markerDiv;
        };

        var sourceDiv = updateArrow(mxUtils.getValue(ss.style, mxConstants.STYLE_STARTARROW, null),
            mxUtils.getValue(ss.style, 'startFill', '1'), lineStart, 'start');
        var targetDiv = updateArrow(mxUtils.getValue(ss.style, mxConstants.STYLE_ENDARROW, null),
            mxUtils.getValue(ss.style, 'endFill', '1'), lineEnd, 'end');

        // Special cases for markers
        if (ss.style.shape == 'arrow') {
            sourceDiv.className = 'geSprite geSprite-noarrow';
            targetDiv.className = 'geSprite geSprite-endblocktrans';
        } else if (ss.style.shape == 'link') {
            sourceDiv.className = 'geSprite geSprite-noarrow';
            targetDiv.className = 'geSprite geSprite-noarrow';
        }

        mxUtils.setOpacity(edgeStyle, (ss.style.shape == 'arrow') ? 30 : 100);

        if (ss.style.shape != 'connector' && ss.style.shape != 'flexArrow' && ss.style.shape != 'filledEdge') {
            mxUtils.setOpacity(lineStart, 30);
            mxUtils.setOpacity(lineEnd, 30);
        } else {
            mxUtils.setOpacity(lineStart, 100);
            mxUtils.setOpacity(lineEnd, 100);
        }

        if (force || document.activeElement != startSize) {
            var tmp = parseInt(mxUtils.getValue(ss.style, mxConstants.STYLE_STARTSIZE, mxConstants.DEFAULT_MARKERSIZE));
            startSize.value = (isNaN(tmp)) ? '' : tmp + ' pt';
        }

        if (force || document.activeElement != startSpacing) {
            var tmp = parseInt(mxUtils.getValue(ss.style, mxConstants.STYLE_SOURCE_PERIMETER_SPACING, 0));
            startSpacing.value = (isNaN(tmp)) ? '' : tmp + ' pt';
        }

        if (force || document.activeElement != endSize) {
            var tmp = parseInt(mxUtils.getValue(ss.style, mxConstants.STYLE_ENDSIZE, mxConstants.DEFAULT_MARKERSIZE));
            endSize.value = (isNaN(tmp)) ? '' : tmp + ' pt';
        }

        if (force || document.activeElement != startSpacing) {
            var tmp = parseInt(mxUtils.getValue(ss.style, mxConstants.STYLE_TARGET_PERIMETER_SPACING, 0));
            endSpacing.value = (isNaN(tmp)) ? '' : tmp + ' pt';
        }

        if (force || document.activeElement != perimeterSpacing) {
            var tmp = parseInt(mxUtils.getValue(ss.style, mxConstants.STYLE_PERIMETER_SPACING, 0));
            perimeterSpacing.value = (isNaN(tmp)) ? '' : tmp + ' pt';
        }
    });

    startSizeUpdate = this.installInputHandler(startSize, mxConstants.STYLE_STARTSIZE, mxConstants.DEFAULT_MARKERSIZE, 0, 999, ' pt');
    startSpacingUpdate = this.installInputHandler(startSpacing, mxConstants.STYLE_SOURCE_PERIMETER_SPACING, 0, -999, 999, ' pt');
    endSizeUpdate = this.installInputHandler(endSize, mxConstants.STYLE_ENDSIZE, mxConstants.DEFAULT_MARKERSIZE, 0, 999, ' pt');
    endSpacingUpdate = this.installInputHandler(endSpacing, mxConstants.STYLE_TARGET_PERIMETER_SPACING, 0, -999, 999, ' pt');
    perimeterUpdate = this.installInputHandler(perimeterSpacing, mxConstants.STYLE_PERIMETER_SPACING, 0, 0, 999, ' pt');

    this.addKeyHandler(input, listener);
    this.addKeyHandler(startSize, listener);
    this.addKeyHandler(startSpacing, listener);
    this.addKeyHandler(endSize, listener);
    this.addKeyHandler(endSpacing, listener);
    this.addKeyHandler(perimeterSpacing, listener);

    graph.getModel().addListener(mxEvent.CHANGE, listener);
    this.listeners.push({
        destroy: function () {
            graph.getModel().removeListener(listener);
        }
    });
    listener();

    return container;
};

/**
 * Adds UI for configuring line jumps.
 */
StyleFormatPanel.prototype.addLineJumps = function (container) {
    var ss = this.format.getSelectionState();

    if (Graph.lineJumpsEnabled && ss.edges.length > 0 &&
        ss.vertices.length == 0 && ss.lineJumps) {
        container.style.padding = '8px 0px 24px 18px';

        var ui = this.editorUi;
        var editor = ui.editor;
        var graph = editor.graph;

        var span = document.createElement('div');
        span.style.position = 'absolute';
        span.style.fontWeight = 'bold';
        span.style.width = '80px';

        mxUtils.write(span, mxResources.get('lineJumps'));
        container.appendChild(span);

        var styleSelect = document.createElement('select');
        styleSelect.style.position = 'absolute';
        styleSelect.style.marginTop = '-2px';
        styleSelect.style.right = '76px';
        styleSelect.style.width = '62px';

        var styles = ['none', 'arc', 'gap', 'sharp'];

        for (var i = 0; i < styles.length; i++) {
            var styleOption = document.createElement('option');
            styleOption.setAttribute('value', styles[i]);
            mxUtils.write(styleOption, mxResources.get(styles[i]));
            styleSelect.appendChild(styleOption);
        }

        mxEvent.addListener(styleSelect, 'change', function (evt) {
            graph.getModel().beginUpdate();
            try {
                graph.setCellStyles('jumpStyle', styleSelect.value, graph.getSelectionCells());
                ui.fireEvent(new mxEventObject('styleChanged', 'keys', ['jumpStyle'],
                    'values', [styleSelect.value], 'cells', graph.getSelectionCells()));
            } finally {
                graph.getModel().endUpdate();
            }

            mxEvent.consume(evt);
        });

        // Stops events from bubbling to color option event handler
        mxEvent.addListener(styleSelect, 'click', function (evt) {
            mxEvent.consume(evt);
        });

        container.appendChild(styleSelect);

        var jumpSizeUpdate;

        var jumpSize = this.addUnitInput(container, 'pt', 22, 33, function () {
            jumpSizeUpdate.apply(this, arguments);
        });

        jumpSizeUpdate = this.installInputHandler(jumpSize, 'jumpSize',
            Graph.defaultJumpSize, 0, 999, ' pt');

        var listener = mxUtils.bind(this, function (sender, evt, force) {
            ss = this.format.getSelectionState();
            styleSelect.value = mxUtils.getValue(ss.style, 'jumpStyle', 'none');

            if (force || document.activeElement != jumpSize) {
                var tmp = parseInt(mxUtils.getValue(ss.style, 'jumpSize', Graph.defaultJumpSize));
                jumpSize.value = (isNaN(tmp)) ? '' : tmp + ' pt';
            }
        });

        this.addKeyHandler(jumpSize, listener);

        graph.getModel().addListener(mxEvent.CHANGE, listener);
        this.listeners.push({
            destroy: function () {
                graph.getModel().removeListener(listener);
            }
        });
        listener();
    } else {
        container.style.display = 'none';
    }

    return container;
};

/**
 * Adds the label menu items to the given menu and parent.
 */
StyleFormatPanel.prototype.addEffects = function (div) {
    var ui = this.editorUi;
    var editor = ui.editor;
    var graph = editor.graph;
    var ss = this.format.getSelectionState();

    div.style.paddingTop = '0px';
    div.style.paddingBottom = '2px';

    var table = document.createElement('table');

    if (mxClient.IS_QUIRKS) {
        table.style.fontSize = '1em';
    }

    table.style.width = '100%';
    table.style.fontWeight = 'bold';
    table.style.paddingRight = '20px';
    var tbody = document.createElement('tbody');
    var row = document.createElement('tr');
    row.style.padding = '0px';
    var left = document.createElement('td');
    left.style.padding = '0px';
    left.style.width = '50%';
    left.setAttribute('valign', 'top');

    var right = left.cloneNode(true);
    right.style.paddingLeft = '8px';
    row.appendChild(left);
    row.appendChild(right);
    tbody.appendChild(row);
    table.appendChild(tbody);
    div.appendChild(table);

    var current = left;
    var count = 0;

    var addOption = mxUtils.bind(this, function (label, key, defaultValue) {
        var opt = this.createCellOption(label, key, defaultValue);
        opt.style.width = '100%';
        current.appendChild(opt);
        current = (current == left) ? right : left;
        count++;
    });

    var listener = mxUtils.bind(this, function (sender, evt, force) {
        ss = this.format.getSelectionState();

        left.innerHTML = '';
        right.innerHTML = '';
        current = left;

        if (ss.rounded) {
            addOption(mxResources.get('rounded'), mxConstants.STYLE_ROUNDED, 0);
        }

        if (ss.style.shape == 'swimlane') {
            addOption(mxResources.get('divider'), 'swimlaneLine', 1);
        }

        if (!ss.containsImage) {
            addOption(mxResources.get('shadow'), mxConstants.STYLE_SHADOW, 0);
        }

        if (ss.glass) {
            addOption(mxResources.get('glass'), mxConstants.STYLE_GLASS, 0);
        }

        if (ss.comic) {
            addOption(mxResources.get('comic'), 'comic', 0);
        }

        if (count == 0) {
            div.style.display = 'none';
        }
    });

    graph.getModel().addListener(mxEvent.CHANGE, listener);
    this.listeners.push({
        destroy: function () {
            graph.getModel().removeListener(listener);
        }
    });
    listener();

    return div;
}

/**
 * Adds the label menu items to the given menu and parent.
 */
StyleFormatPanel.prototype.addStyleOps = function (div) {
    div.style.paddingTop = '10px';
    div.style.paddingBottom = '10px';

    var btn = mxUtils.button(mxResources.get('setAsDefaultStyle'), mxUtils.bind(this, function (evt) {
        this.editorUi.actions.get('setAsDefaultStyle').funct();
    }));

    btn.setAttribute('title', mxResources.get('setAsDefaultStyle') + ' (' + this.editorUi.actions.get('setAsDefaultStyle').shortcut + ')');
    btn.style.width = '202px';
    div.appendChild(btn);

    return div;
};

/**
 * Adds the label menu items to the given menu and parent.
 */
DiagramFormatPanel = function (format, editorUi, container) {
    BaseFormatPanel.call(this, format, editorUi, container);
    this.init();
};

mxUtils.extend(DiagramFormatPanel, BaseFormatPanel);

/**
 * Specifies if the background image option should be shown. Default is true.
 */
DiagramFormatPanel.prototype.showBackgroundImageOption = true;

/**
 * Adds the label menu items to the given menu and parent.
 */
DiagramFormatPanel.prototype.init = function () {
    var ui = this.editorUi;
    var editor = ui.editor;
    var graph = editor.graph;

    this.container.appendChild(this.addView(this.createPanel()));

    if (graph.isEnabled()) {
        this.container.appendChild(this.addPaperSize(this.createPanel()));
    }
};

/**
 * Adds the label menu items to the given menu and parent.
 */
DiagramFormatPanel.prototype.addView = function (div) {
    var ui = this.editorUi;
    var editor = ui.editor;
    var graph = editor.graph;

    div.appendChild(this.createTitle(mxResources.get('view')));

    // Grid
    this.addGridOption(div);

    if (graph.isEnabled()) {
        // Background
        var bg = this.createColorOption(mxResources.get('background'), function () {
                return graph.background;
            }, function (color) {
                var change = new ChangePageSetup(ui, color);
                change.ignoreImage = true;

                graph.model.execute(change);
            }, '#ffffff',
            {
                install: function (apply) {
                    this.listener = function () {
                        apply(graph.background);
                    };

                    ui.addListener('backgroundColorChanged', this.listener);
                },
                destroy: function () {
                    ui.removeListener(this.listener);
                }
            });

        if (this.showBackgroundImageOption) {
            var btn = mxUtils.button(mxResources.get('image'), function (evt) {
                ui.showBackgroundImageDialog();
                mxEvent.consume(evt);
            })

            btn.style.position = 'absolute';
            btn.className = 'geColorBtn';
            btn.style.marginTop = '-4px';
            btn.style.paddingBottom = (document.documentMode == 11 || mxClient.IS_MT) ? '0px' : '2px';
            btn.style.height = '22px';
            btn.style.right = (mxClient.IS_QUIRKS) ? '52px' : '72px';
            btn.style.width = '56px';

            bg.appendChild(btn);
        }

        div.appendChild(bg);
    }

    return div;
};

/**
 * Adds the label menu items to the given menu and parent.
 */
DiagramFormatPanel.prototype.addOptions = function (div) {
    var ui = this.editorUi;
    var editor = ui.editor;
    var graph = editor.graph;

    return div;
};

/**
 *
 */
DiagramFormatPanel.prototype.addGridOption = function (container) {
    var fPanel = this;
    var ui = this.editorUi;
    var graph = ui.editor.graph;

    var input = document.createElement('input');
    input.style.position = 'absolute';
    input.style.textAlign = 'right';
    input.style.width = '38px';
    input.value = this.inUnit(graph.getGridSize()) + ' ' + this.getUnit();

    var stepper = this.createStepper(input, update, this.getUnitStep(), null, null, null, this.isFloatUnit());
    input.style.display = (graph.isGridEnabled()) ? '' : 'none';
    stepper.style.display = input.style.display;

    mxEvent.addListener(input, 'keydown', function (e) {
        if (e.keyCode == 13) {
            graph.container.focus();
            mxEvent.consume(e);
        } else if (e.keyCode == 27) {
            input.value = graph.getGridSize();
            graph.container.focus();
            mxEvent.consume(e);
        }
    });

    function update(evt) {
        var value = fPanel.isFloatUnit() ? parseFloat(input.value) : parseInt(input.value);
        value = fPanel.fromUnit(Math.max(fPanel.inUnit(1), (isNaN(value)) ? fPanel.inUnit(10) : value));

        if (value != graph.getGridSize()) {
            graph.setGridSize(value)
        }

        input.value = fPanel.inUnit(value) + ' ' + fPanel.getUnit();
        mxEvent.consume(evt);
    };

    mxEvent.addListener(input, 'blur', update);
    mxEvent.addListener(input, 'change', update);

    var unitChangeListener = function (sender, evt) {
        input.value = fPanel.inUnit(graph.getGridSize()) + ' ' + fPanel.getUnit();
        fPanel.format.refresh();
    };

    graph.view.addListener('unitChanged', unitChangeListener);
    this.listeners.push({
        destroy: function () {
            graph.view.removeListener(unitChangeListener);
        }
    });

    if (mxClient.IS_SVG) {
        input.style.marginTop = '-2px';
        input.style.right = '84px';
        stepper.style.marginTop = '-16px';
        stepper.style.right = '72px';

        var panel = this.createColorOption(mxResources.get('grid'), function () {
                var color = graph.view.gridColor;

                return (graph.isGridEnabled()) ? color : null;
            }, function (color) {
                if (color == mxConstants.NONE) {
                    graph.setGridEnabled(false);
                } else {
                    graph.setGridEnabled(true);
                    ui.setGridColor(color);
                }

                input.style.display = (graph.isGridEnabled()) ? '' : 'none';
                stepper.style.display = input.style.display;
                ui.fireEvent(new mxEventObject('gridEnabledChanged'));
            }, '#e0e0e0',
            {
                install: function (apply) {
                    this.listener = function () {
                        apply((graph.isGridEnabled()) ? graph.view.gridColor : null);
                    };

                    ui.addListener('gridColorChanged', this.listener);
                    ui.addListener('gridEnabledChanged', this.listener);
                },
                destroy: function () {
                    ui.removeListener(this.listener);
                }
            });

        panel.appendChild(input);
        panel.appendChild(stepper);
        container.appendChild(panel);
    } else {
        input.style.marginTop = '2px';
        input.style.right = '32px';
        stepper.style.marginTop = '2px';
        stepper.style.right = '20px';

        container.appendChild(input);
        container.appendChild(stepper);

        container.appendChild(this.createOption(mxResources.get('grid'), function () {
                return graph.isGridEnabled();
            }, function (checked) {
                graph.setGridEnabled(checked);

                if (graph.isGridEnabled()) {
                    graph.view.gridColor = '#e0e0e0';
                }

                ui.fireEvent(new mxEventObject('gridEnabledChanged'));
            },
            {
                install: function (apply) {
                    this.listener = function () {
                        input.style.display = (graph.isGridEnabled()) ? '' : 'none';
                        stepper.style.display = input.style.display;

                        apply(graph.isGridEnabled());
                    };

                    ui.addListener('gridEnabledChanged', this.listener);
                },
                destroy: function () {
                    ui.removeListener(this.listener);
                }
            }));
    }
};

/**
 * Adds the label menu items to the given menu and parent.
 */
DiagramFormatPanel.prototype.addDocumentProperties = function (div) {
    // Hook for subclassers
    var ui = this.editorUi;
    var editor = ui.editor;
    var graph = editor.graph;

    div.appendChild(this.createTitle(mxResources.get('options')));

    return div;
};

/**
 * Adds the label menu items to the given menu and parent.
 */
DiagramFormatPanel.prototype.addPaperSize = function (div) {
    var ui = this.editorUi;
    var editor = ui.editor;
    var graph = editor.graph;

    div.appendChild(this.createTitle(mxResources.get('paperSize')));

    var accessor = PageSetupDialog.addPageFormatPanel(div, 'formatpanel', graph.pageFormat, function (pageFormat) {
        if (graph.pageFormat == null || graph.pageFormat.width != pageFormat.width ||
            graph.pageFormat.height != pageFormat.height) {
            var change = new ChangePageSetup(ui, null, null, pageFormat);
            change.ignoreColor = true;
            change.ignoreImage = true;

            graph.model.execute(change);
        }
    });

    this.addKeyHandler(accessor.widthInput, function () {
        accessor.set(graph.pageFormat);
    });
    this.addKeyHandler(accessor.heightInput, function () {
        accessor.set(graph.pageFormat);
    });

    var listener = function () {
        accessor.set(graph.pageFormat);
    };

    ui.addListener('pageFormatChanged', listener);
    this.listeners.push({
        destroy: function () {
            ui.removeListener(listener);
        }
    });

    graph.getModel().addListener(mxEvent.CHANGE, listener);
    this.listeners.push({
        destroy: function () {
            graph.getModel().removeListener(listener);
        }
    });

    return div;
};

/**
 * Adds the label menu items to the given menu and parent.
 */
DiagramFormatPanel.prototype.addStyleOps = function (div) {
    var btn = mxUtils.button(mxResources.get('editData'), mxUtils.bind(this, function (evt) {
        this.editorUi.actions.get('editData').funct();
    }));

    btn.setAttribute('title', mxResources.get('editData') + ' (' + this.editorUi.actions.get('editData').shortcut + ')');
    btn.style.width = '202px';
    btn.style.marginBottom = '2px';
    div.appendChild(btn);

    mxUtils.br(div);

    btn = mxUtils.button(mxResources.get('clearDefaultStyle'), mxUtils.bind(this, function (evt) {
        this.editorUi.actions.get('clearDefaultStyle').funct();
    }));

    btn.setAttribute('title', mxResources.get('clearDefaultStyle') + ' (' + this.editorUi.actions.get('clearDefaultStyle').shortcut + ')');
    btn.style.width = '202px';
    div.appendChild(btn);

    return div;
};

/**
 * Adds the label menu items to the given menu and parent.
 */
DiagramFormatPanel.prototype.destroy = function () {
    BaseFormatPanel.prototype.destroy.apply(this, arguments);

    if (this.gridEnabledListener) {
        this.editorUi.removeListener(this.gridEnabledListener);
        this.gridEnabledListener = null;
    }
};

/*aric.chen::: Data Panel*/
DataPanel = function (format, editorUi, container) {
    BaseFormatPanel.call(this, format, editorUi, container);
    this.init();
};

mxUtils.extend(DataPanel, BaseFormatPanel);

DataPanel.prototype.init = function () {
    var graph = this.editorUi.editor.graph;

    var state = this.format.getSelectionState();
    var tag1 = mxUtils.getValue(state.style, 'tag1');
    var tag2 = mxUtils.getValue(state.style, 'tag2');

    var selectCells = graph.getSelectionCells();
    var selectCell = _.first(selectCells);

    if (tag1 === 'neptune') {
        if (tag2 === 'control') {
            /*增加数据下发方式的选择...*/
            this.container.appendChild(this.addDeviceCmdChangePanel(this.createPanel()));
            var control_cmd_type = graph.getAttributeForCell(selectCell, 'control_cmd_type');// 得到数据下发方式.
            if (control_cmd_type) {
                this.container.appendChild(this.addDevicePanel(this.createPanel()));// 设备选择框.
                if (control_cmd_type === 'multipleDeviceExpression') { // 数据下发方式为多设备表达式时,显示
                    this.container.appendChild(this.addDeviceCmdExpressionPanel(this.createPanel()));
                } else {
                    this.container.appendChild(this.addDeviceFieldPanel(this.createPanel()));
                }
            }
        } else if (tag2 === 'camera') {
            /*camera url setting*/
            this.container.appendChild(this.addCameraSetting(this.createPanel()));
        } else if (tag2 === "timeline") {
            var self = this;
            //this.container.appendChild(this.addDevicePanel(this.createPanel()));
            //this.container.appendChild(this.addTimelineRangPanel(this.createPanel()));
            //this.container.appendChild(this.addConponentAnimatePanel(this.createPanel()));
            setTimeout(function () {
                self.container.appendChild(self.addDevicePanel(self.createPanel()));
                self.container.appendChild(self.addTimelineRangPanel(self.createPanel()));
                self.container.appendChild(self.addConponentAnimatePanel(self.createPanel()));
            }, 1);
            return;
        } else if (tag2 === "flowbar") {
            let self = this;
            self.container.appendChild(self.addFlowBarPanel(self.createPanel()));
            self.container.appendChild(self.addVisiblePanel(self.createPanel()));
            return;
        } else if (tag2 === "progressbar") {
            let self = this;
            self.container.appendChild(self.addProgressbarPanel(self.createPanel()));
            self.container.appendChild(self.addVisiblePanel(self.createPanel()));
            return;
        } else if (tag2 === 'map') {
            let self = this;
            self.container.appendChild(self.addMapPanel(self.createPanel()));
            self.container.appendChild(self.addVisiblePanel(self.createPanel()));
            return;
        } else {
            /*增加设备的选择*/
            var expressionCheckedValue = graph.getAttributeForCell(selectCell, 'device_field_expression_value');
            if (tag2 === 'field' && expressionCheckedValue === 'true') {
                // 当组件类型为数据栏位且选择使用高级表达式时,隐藏设备选择panel
            } else {
                this.container.appendChild(this.addDevicePanel(this.createPanel()));
            }
            /*增加数据栏位的选择*/
            if (tag2 === 'historychart') {
                /*添加图表设置的选择*/
                this.container.appendChild(this.addHistoryDataChartSite(this.createPanel()));
            } else {
                this.container.appendChild(this.addDeviceFieldPanel(this.createPanel()));
            }
        }

        if (tag2 === 'dashboard') {
            /*Min Max 设置*/
            this.container.appendChild(this.addDashboardSetting(this.createPanel()));
            this.container.appendChild(this.addDashboardThemeSetting(this.createPanel()));
        }
    }

    if (tag2 === 'camera') {
        /*camera的时候,不显示隐藏和背景色*/
        return;
    }
    /*设置动态显示隐藏*/
    this.container.appendChild(this.addVisiblePanel(this.createPanel()));

    /*设置动态背景色*/
    this.container.appendChild(this.addDynamicBgColor(this.createPanel()));

    /*动画设置面板*/
    this.container.appendChild(this.addConponentAnimatePanel(this.createPanel()));

};

DataPanel.prototype.reRenderField = function (mxCell) {
    if (neptuneHandler) {
        neptuneHandler.renderMxCell(mxCell);
    }
};

DataPanel.prototype.addCameraSetting = function (div) {
    var self = this;
    var graph = this.editorUi.editor.graph;
    var selectCells = graph.getSelectionCells();
    var selectCell = _.first(selectCells);

    var html = `<div class="mxgraph-camera-setting">
                    <div class="mxgraph-camera-url">
                        <input name="input-camera-url" class="input-camera-url" type="text" 
                         placeholder="请输入摄像头地址"></input>
                    </div>
                    <div class="mxgraph-camera-options">
                          <label>
                            <span>自动播放</span>
                            <input type="checkbox" />
                            </label>
                    </div>
                </div>`;
    $(div).append(html);

    var camera_url = graph.getAttributeForCell(selectCell, 'camera_url');
    $(div).find('input:text').val(camera_url || '');

    var auto_play = graph.getAttributeForCell(selectCell, 'auto_play');
    if (auto_play === 'true') {
        $(div).find('input:checkbox').prop('checked', true);
    }

    $(div).find('input:text').change(function (event) {
        var input = $(this);
        graph.getModel().beginUpdate();
        try {
            var checked = input.prop('checked');
            graph.setAttributeForCell(selectCell, 'auto_play', checked);
        } finally {
            graph.getModel().endUpdate();
        }
    });

    $(div).find('input:text').mousedown(function () {
        $(div).find('input:text').focus();
    }).change(function (event) {
        var input = $(this);
        graph.getModel().beginUpdate();
        try {
            graph.setAttributeForCell(selectCell, 'camera_url', input.val());
        } finally {
            graph.getModel().endUpdate();
        }
    });

    var textarea = $(div).find('input:text')[0];
    mxEvent.addListener(textarea, 'keydown', function (e) {
        if (e.keyCode == 13) {
            graph.container.focus();
            mxEvent.consume(e);
        } else if (e.keyCode == 27) {
            graph.container.focus();
            mxEvent.consume(e);
        }
    });
    return div;
};

DataPanel.prototype.addDashboardSetting = function (div) {
    var self = this;
    var graph = this.editorUi.editor.graph;

    var selectCells = graph.getSelectionCells();
    var selectCell = _.first(selectCells);

    var html = `<div class="mxgraph-dashboard-setting">
                    <div class="mxgraph-setting-row">
                        <div class="mxgraph-setting-label">最小值</div>
                        <div class="mxgraph-setting-value"><input type="text" data-key="min" style="width:80px;"/></div>
                    </div>
                    <div class="mxgraph-setting-row">
                        <div class="mxgraph-setting-label">最大值</div>
                        <div class="mxgraph-setting-value"><input type="text" data-key="max" style="width:80px;"/></div>
                    </div>
                    <div class="mxgraph-setting-row">
                        <div class="mxgraph-setting-label">单位</div>
                        <div class="mxgraph-setting-value"><input type="text" data-key="units" style="width:80px;"/></div>
                    </div>
                    <div class="mxgraph-setting-row">
                        <div class="mxgraph-setting-label">警报值</div>
                        <div class="mxgraph-setting-value"><input type="text" data-key="threshold" style="width:80px;"/></div>
                    </div>
                </div>`;
    $(div).append(html);

    var min = graph.getAttributeForCell(selectCell, 'dashboard_min');
    var max = graph.getAttributeForCell(selectCell, 'dashboard_max');
    var units = graph.getAttributeForCell(selectCell, 'dashboard_units');
    var threshold = graph.getAttributeForCell(selectCell, "dashboard_threshold");

    $(div).find('input').eq(0).val(min || '0');
    $(div).find('input').eq(1).val(max || '100');
    $(div).find('input').eq(2).val(units || "");
    $(div).find("input").eq(3).val(threshold || "");

    $(div).find('input').change(function (event) {
        var input = $(this);
        var keyType = input.data('key');
        var key = `dashboard_${keyType}`;

        graph.getModel().beginUpdate();
        try {
            graph.setAttributeForCell(selectCell, key, input.val());
        } finally {
            graph.getModel().endUpdate();
            self.reRenderField(selectCell);
        }

    });
    return div;
};
DataPanel.prototype.addDashboardThemeSetting = function (div) {
    var self = this;
    var graph = this.editorUi.editor.graph;

    var selectCells = graph.getSelectionCells();
    var selectCell = _.first(selectCells);

    var html = `<div class="mxgraph-dashboard-setting">
                    <div class="mxgraph-setting-row">主题</div>
                    <div class="mxgraph-setting-row">
                        <img style="width:40px;height: 40px;cursor: pointer;" data-key="radial" src="${cynovan.r_path}prototype/monitor/img/lib/neptune/dashboard1.png"/>
                        <img style="width:40px;height: 40px;cursor: pointer;" data-key="half-radial" src="${cynovan.r_path}prototype/monitor/img/lib/neptune/dashboard2.png"/>
                        <img style="width:40px;height: 40px;cursor: pointer;" data-key="linear" src="${cynovan.r_path}prototype/monitor/img/lib/neptune/dashboard3.png"/>
                    </div>
                </div>`;
    $(div).append(html);

    $(div).find('.mxgraph-setting-row img').click(function () {
        var img = $(this);
        var keyType = img.data('key');
        graph.getModel().beginUpdate();
        try {
            graph.setAttributeForCell(selectCell, 'dashboard_type', keyType);
        } finally {
            graph.getModel().endUpdate();
            self.reRenderField(selectCell);
        }
    });

    return div;
};

DataPanel.prototype.addHistoryDataChartSite = function (div) {
    var self = this;
    var graph = this.editorUi.editor.graph;
    var selectCells = graph.getSelectionCells();
    var selectCell = _.first(selectCells);
    var button = $(`<button style="width: 195px;margin-bottom: 2px" title="图表设置" type="button"><i class="fa fa-cog"></i>图表设置</button>`)[0];
    div.append(button);

    let device_uuid = graph.getAttributeForCell(selectCell, 'device_uuid'); // 虚拟设备uuid
    let virtualDevice = _.find(NeptuneUtils.placeholderList, {"name": device_uuid});
    let virtualDeviceCls = _.get(virtualDevice, "clsCode", "");
    if (_.isEmpty(NeptuneUtils.placeholderList)) {
        var id = NeptuneUtils.findGetParameter('id');
        NeptuneUtils.getPlaceholderList(id).done(function (list) {
            virtualDevice = _.find(NeptuneUtils.placeholderList, {"name": device_uuid});
            virtualDeviceCls = _.get(virtualDevice, "clsCode", "");
        });
    }

    var chartType = graph.getAttributeForCell(selectCell, 'chart_type') || 'line-chart1';
    var useOrigin = graph.getAttributeForCell(selectCell, 'useOrigin') || false;
    var rangeType = graph.getAttributeForCell(selectCell, 'historyData_rangeType');
    var startDate = graph.getAttributeForCell(selectCell, 'historyData_startDate');
    var endDate = graph.getAttributeForCell(selectCell, 'historyData_endDate');
    var groups = graph.getAttributeForCell(selectCell, 'groups');
    var fields = graph.getAttributeForCell(selectCell, 'fields');

    mxEvent.addListener(button, 'click', function (evt) {
        NeptuneUtils.showHistoryDataChartDialog({
            virtualDeviceCls: virtualDeviceCls || '',
            chartType: chartType || '',
            useOrigin: useOrigin || false,
            rangeType: rangeType || '',
            startDate: startDate || '',
            endDate: endDate || '',
            groups: groups || {},
            fields: fields || []
        }).done(function (param) {
            graph.getModel().beginUpdate();
            try {
                graph.setAttributeForCell(selectCell, 'updateTime', param.updateTime || '');
                graph.setAttributeForCell(selectCell, 'useOrigin', param.useOrigin || '');
                graph.setAttributeForCell(selectCell, 'chart_type', param.chartType || '');
                graph.setAttributeForCell(selectCell, 'historyData_rangeType', param.rangeType || '');
                graph.setAttributeForCell(selectCell, 'historyData_startDate', param.startDate || '');
                graph.setAttributeForCell(selectCell, 'historyData_endDate', param.endDate || '');
                graph.setAttributeForCell(selectCell, 'groups', param.groups);
                graph.setAttributeForCell(selectCell, 'fields', param.fields);
            } catch (e) {
            } finally {
                graph.getModel().endUpdate();
                self.reRenderField(selectCell);
            }
        });

        mxEvent.consume(evt);
    });
    return div;
};

DataPanel.prototype.addDynamicBgColor = function (div) {
    var ui = this.editorUi;
    var graph = this.editorUi.editor.graph;

    var selectCells = graph.getSelectionCells();
    var selectCell = _.first(selectCells);

    var html = `<div class="mxgraph-dynamic-bgcolor-box">
                <button class="mxgraph-dynamic-color-expression-btn" type="button"><i class="fa fa-code"></i>动态背景色表达式</button>
                <div class="mxgraph-dynamic-bgcolor-box-header">
                    <span>颜色列表</span>
                    <button type="button" class="add_color_btn"><i class="fa fa-plus"></i>添加</button>
                </div>
                <div class="mxgraph-dynamic-bgcolor-rows"></div></div>`;
    var bgColorBox = $(html)[0];
    div.append(bgColorBox);
    bgColorBox = $(bgColorBox);

    var dynamicBgColors = graph.getAttributeForCell(selectCell, 'dynamic_bgcolors');
    if (!dynamicBgColors) {
        dynamicBgColors = [{}];
    } else {
        dynamicBgColors = JSON.parse(dynamicBgColors);
    }

    bgColorBox.find('.add_color_btn').click(function () {
        dynamicBgColors.push({});
        renderDynamicColorRows();
    });

    var bgcolor_code_expression = graph.getAttributeForCell(selectCell, 'bgcolor_code_expression');
    var bgcolor_testdata_expression = graph.getAttributeForCell(selectCell, 'bgcolor_testdata_expression');
    var bgcolor_outputdata_expression = graph.getAttributeForCell(selectCell, 'bgcolor_outputdata_expression');

    var button = bgColorBox.find('.mxgraph-dynamic-color-expression-btn');
    if (bgcolor_code_expression || bgcolor_testdata_expression || bgcolor_outputdata_expression) {
        var span = $(`<span style="color: red;padding-left: 5px;">※</span>`)[0];
        button.append(span);
    }

    button.click(function () {
        NeptuneUtils.showExpressionDialog({
            value: {
                code: bgcolor_code_expression || '',
                testdata: bgcolor_testdata_expression || '',
                outputdata: bgcolor_outputdata_expression || ''
            }
        }).done(function (param) {
            graph.getModel().beginUpdate();
            try {
                graph.setAttributeForCell(selectCell, 'bgcolor_code_expression', param.value.code || '');
                graph.setAttributeForCell(selectCell, 'bgcolor_testdata_expression', param.value.testdata || '');
                graph.setAttributeForCell(selectCell, 'bgcolor_outputdata_expression', param.value.outputdata || '');
            } catch (e) {
            } finally {
                graph.getModel().endUpdate();
            }
        });
    });

    function saveValues() {
        graph.getModel().beginUpdate();
        try {
            var idx = 0;
            bgColorBox.find('input').each(function () {
                var input = $(this);
                var row = dynamicBgColors[idx];
                _.set(row, 'value', input.val());
                idx++;
            });
            var values = JSON.stringify(dynamicBgColors);
            graph.setAttributeForCell(selectCell, 'dynamic_bgcolors', values);
        } finally {
            graph.getModel().endUpdate();
        }
    }

    function renderDynamicColorRows() {
        var rowHtml = [];
        _.each(dynamicBgColors, function (item, idx) {
            rowHtml.push(`<div class="mxgraph-dynamic-bgcolor-row" data-index="${idx}">`);
            rowHtml.push(`<input type="text" style="margin-right: 5px;" value="${item.value || ''}" placeholder="数据值"/>`);
            rowHtml.push(`<div class="mxgraph-dynamic-bgcolor-picker-box"><div class="mxgraph-dynamic-bgcolor-picker" style="background:${item.color || ''}"></div></div>`);
            rowHtml.push(`<i class="fa fa-trash-o" title="删除"></i>`);
            rowHtml.push('</div>');
        });

        var rowsElement = bgColorBox.find('.mxgraph-dynamic-bgcolor-rows');
        rowsElement.html(rowHtml.join(''));

        rowsElement.find('.mxgraph-dynamic-bgcolor-picker').click(function (event) {
            var rowEle = $(event.target).closest('.mxgraph-dynamic-bgcolor-row');
            var idx = rowEle.data('index');
            idx = _.parseInt(idx);
            var row = dynamicBgColors[idx];
            var color = _.get(row, 'color', '');
            ui.pickColor(color, function (selColor) {
                row.color = selColor;
                rowEle.find('.mxgraph-dynamic-bgcolor-picker').css('background', selColor);
                saveValues();
            });
        });

        rowsElement.find('.fa-trash-o').click(function (event) {
            var row = $(event.target).closest('.mxgraph-dynamic-bgcolor-row');
            var idx = _.parseInt(row.data('index'));
            row.remove();
            dynamicBgColors.splice(idx, 1);
            saveValues();
        });

        rowsElement.find('input').change(function () {
            saveValues();
        });
    }

    renderDynamicColorRows();

    return div;
};

DataPanel.prototype.addVisiblePanel = function (div) {
    var graph = this.editorUi.editor.graph;

    var button = $(`<button style="width:195px;margin-bottom: 2px;" type="button" title="显示/隐藏表达式">显示/隐藏表达式</button>`)[0];
    div.append(button);

    var selectCells = graph.getSelectionCells();
    var selectCell = _.first(selectCells);

    var visible_code_expression = graph.getAttributeForCell(selectCell, 'visible_code_expression');
    var visible_testdata_expression = graph.getAttributeForCell(selectCell, 'visible_testdata_expression');
    var visible_outputdata_expression = graph.getAttributeForCell(selectCell, 'visible_outputdata_expression');
    if (visible_code_expression || visible_testdata_expression || visible_outputdata_expression) {
        var span = $(`<span style="color: red;padding-left: 5px;">※</span>`)[0];
        button.append(span);
    }

    mxEvent.addListener(button, 'click', function (evt) {
        NeptuneUtils.showExpressionDialog({
            value: {
                code: visible_code_expression || '',
                testdata: visible_testdata_expression || '',
                outputdata: visible_outputdata_expression || ''
            }
        }).done(function (param) {
            graph.getModel().beginUpdate();
            try {
                graph.setAttributeForCell(selectCell, 'visible_code_expression', param.value.code || '');
                graph.setAttributeForCell(selectCell, 'visible_testdata_expression', param.value.testdata || '');
                graph.setAttributeForCell(selectCell, 'visible_outputdata_expression', param.value.outputdata || '');
            } catch (e) {
            } finally {
                graph.getModel().endUpdate();
            }
        });

        mxEvent.consume(evt);
    });
    return div;
};

DataPanel.prototype.setAttribute = function (cell, key, value) {
    var graph = this.editorUi.editor.graph;
    graph.getModel().beginUpdate();
    try {
        graph.setAttributeForCell(cell, key, value);
    } finally {
        graph.getModel().endUpdate();
    }
};


DataPanel.prototype.addDeviceFieldPanel = function (div) {
    var self = this;
    var graph = this.editorUi.editor.graph;
    var selectCells = graph.getSelectionCells();
    var selectCell = _.first(selectCells);

    var state = this.format.getSelectionState();
    var tag2 = mxUtils.getValue(state.style, 'tag2');// 得到当前组件类型
    var control_cmd_type = graph.getAttributeForCell(selectCell, 'control_cmd_type'); // 控制器的下发方式
    var device_uuid = graph.getAttributeForCell(selectCell, 'device_uuid'); // 虚拟设备uuid
    var multi_device_uuid = graph.getAttributeForCell(selectCell, 'multi_device_uuid'); // 虚拟设备uuid集合

    var html = `<div class="mxgraph-device-field-box"><div class="mxgraph-device-field-rows"></div></div>`;

    var deviceFieldBox = $(html)[0];
    div.append(deviceFieldBox);
    deviceFieldBox = $(deviceFieldBox);
    let device_fields = graph.getAttributeForCell(selectCell, 'device_fields');

    if (!device_fields) {
        device_fields = [{}];
    } else {
        device_fields = JSON.parse(device_fields);
    }

    renderFieldRows();
    deviceFieldBox.append(`<div class="device_cls_field_dialog_show_btn">
                                <button class="" style="width:80px;margin-top: 10px;" type="button" title="栏位设置"><i class="fa fa-cog"></i>栏位设置</button>
                            </div>`);
    /*** 数据栏位组件 begin,*/
    // 当组件类型为数据栏位时,增加布尔类型&表达式checkbox.
    if (tag2 === 'field') {
        var switchHtml = $(`<div>                                 
                                 <div style="display: flex;justify-content: space-between;margin-right: 25px">
                                    <span style="text-align: left;padding-top: 12px;">栏位值是否为布尔类型</span>
                                    <input type="checkbox" class="device_field_boolean_status" style="margin-top: 12px;" />
                                </div>                           
                                 <div style="display: flex;justify-content: space-between;margin-right: 25px">
                                    <span style="text-align: left;padding-top: 12px;">栏位值是否滚动显示</span>
                                    <input type="checkbox" class="device_field_scroll_status" style="margin-top: 12px;" />
                                </div>
                                <div style="display: flex;justify-content: space-between;margin-right: 25px">
                                    <span style="text-align: left;padding-top: 12px;">使用高级表达式</span>
                                    <input type="checkbox" class="device_field_expression_value" style="margin-top: 12px;" />
                                </div>
                                <button class="device_field_expression_btn" style="width:195px;margin-top: 5px;" type="button" title="编辑高级表达式">编辑高级表达式</button>
                            </div>`)[0];
        deviceFieldBox.append(switchHtml);
    }

    // 数据定义栏位选择dialog
    var clsFieldDialogShowBtn = deviceFieldBox.find(".device_cls_field_dialog_show_btn");
    clsFieldDialogShowBtn.click(function () {
        let device_uuid = graph.getAttributeForCell(selectCell, 'device_uuid'); // 虚拟设备uuid
        let virtualDevice = _.find(NeptuneUtils.placeholderList, {"name": device_uuid});
        let placeholder_clsCode = _.get(virtualDevice, "clsCode", "");
        let isMultiple = false;
        if (tag2 === 'linechart') {
            isMultiple = true;
        } else if (tag2 === "control") {
            var control_cmd_type = graph.getAttributeForCell(selectCell, 'control_cmd_type');
            if (control_cmd_type === 'multipleDeviceValue') {
                isMultiple = true;
                placeholder_clsCode = graph.getAttributeForCell(selectCell, 'multi_device_clsCode');
            }
        }
        console.log(device_fields);
        let options = {
            control_cmd_type: control_cmd_type,
            tag2: tag2,
            placeholder_clsCode: placeholder_clsCode,
            device_fields: device_fields,
            isMultiple: isMultiple
        };
        NeptuneUtils.showClsDataStruDialog(options).done(function (ddCollection) {
            device_fields = ddCollection;
            renderFieldRows();
            setFieldsValue();
        });
    });

    // 是否选择该类型下的数据栏位
    var deviceClsFieldCheckBox = deviceFieldBox.find('.device_cls_field');
    var deviceClsFieldValue = graph.getAttributeForCell(selectCell, 'device_cls_field');
    deviceClsFieldCheckBox.prop('checked', deviceClsFieldValue === 'true');
    deviceClsFieldCheckBox.change(function () {
        showClsFieldSelect();
    });

    // 数据栏位值是否为布尔类型状态记录,
    var statusCheckbox = deviceFieldBox.find('.device_field_boolean_status');
    var statusCheckedValue = graph.getAttributeForCell(selectCell, 'device_field_boolean_status');
    statusCheckbox.prop('checked', statusCheckedValue === 'true');
    statusCheckbox.change(function () {
        setFieldBooleanStatus();
    });

    // 数据栏位值是否滚动显示
    var scrollCheckbox = deviceFieldBox.find('.device_field_scroll_status');
    var scrollCheckedValue = graph.getAttributeForCell(selectCell, 'device_field_scroll_status');
    scrollCheckbox.prop('checked', scrollCheckedValue === 'true');
    scrollCheckbox.change(function () {
        var value = scrollCheckbox.prop('checked');
        self.setAttribute(selectCell, 'device_field_scroll_status', value);
        self.reRenderField(selectCell);
    });

    // 是否使用高级表达式状态记录.
    var expressionCheckbox = deviceFieldBox.find('.device_field_expression_value');
    var expressionCheckedValue = graph.getAttributeForCell(selectCell, 'device_field_expression_value');
    expressionCheckbox.prop('checked', expressionCheckedValue === 'true');
    expressionCheckbox.change(function () {
        setExpressionCheckedValue();
    });

    // 当使用高级表达式时,编辑表达式按钮显示.&& 隐藏设备选择框&数据栏位框
    var editExpressions = deviceFieldBox.find('.device_field_expression_btn');
    if (expressionCheckedValue === 'true') {
        editExpressions.show();
        deviceFieldBox.find('.mxgraph-device-field-rows').hide();// 隐藏数据栏位框
        deviceFieldBox.find('.device_cls_field_dialog_show_btn').hide();// 隐藏数据定义checkbox
    } else {
        editExpressions.hide();
    }

    // 判断编辑表达式dialog中有无内容.
    var device_field_code_expression = graph.getAttributeForCell(selectCell, 'device_field_code_expression');
    var device_field_testdata_expression = graph.getAttributeForCell(selectCell, 'device_field_testdata_expression');
    var device_field_outputdata_expression = graph.getAttributeForCell(selectCell, 'device_field_outputdata_expression');
    if (device_field_code_expression || device_field_testdata_expression || device_field_outputdata_expression) {
        var span = $(`<span style="color: red;padding-left: 5px;">※</span>`)[0];
        editExpressions[0].append(span);
    }
    editExpressions.click(function () {
        showExpressionDialog();
    });
    /*** 数据栏位组件 end,*/

    // 当组件类型为数据控制时,
    if (tag2 === 'control') {
        //var control_cmd_type = graph.getAttributeForCell(selectCell, 'control_cmd_type');
        if (control_cmd_type === 'multipleDeviceValue') { // 多设备多值.
            addFieldRows();

            var cmdBtnNameInput = deviceFieldBox.find(".control-cmd-btn-name");
            var inputName = graph.getAttributeForCell(selectCell, "control_cmd_btn_name");
            $(cmdBtnNameInput).val(inputName);
            cmdBtnNameInput.change(function (event) {
                var input = $(this);
                self.setAttribute(selectCell, "control_cmd_btn_name", input.val());
                graph.getModel().beginUpdate();
                self.reRenderField(selectCell);
            });
            if (!inputName) {
                inputName = '下发';
                $(cmdBtnNameInput).val(inputName).trigger('change');
            }

        }/* else {
            $(div).find('.fa-trash-o').hide(); // 单值时,不可删除唯一的数据栏位框.
            var switchHtml = $(`<div style="display: flex;justify-content: space-between;margin-right: 25px">
                                    <span style="text-align: left;padding-top: 12px;">栏位值是否为布尔类型</span>
                                    <input type="checkbox" class="device_control_boolean_status" style="margin-top: 12px;" />
                                </div>`)[0];
            deviceFieldBox.append(switchHtml);

            // 数据栏位值是否为布尔类型状态记录,
            var statusCheckbox = deviceFieldBox.find('.device_control_boolean_status');
            var statusCheckedValue = graph.getAttributeForCell(selectCell, 'device_control_boolean_status');
            statusCheckbox.prop('checked', statusCheckedValue === 'true');
            statusCheckbox.change(function () {
                setControlBooleanStatus();
            });
        }*/
    }

    // 当组件类型为折线图时,数据栏位可添加多个.
    if (tag2 === 'linechart') {
        addFieldRows();
    }

    function addFieldRows() {
        var button;
        var inputEle;
        if (graph.getAttributeForCell(selectCell, 'control_cmd_type') === 'multipleDeviceValue') { // 组件为数据控制&下发方式为多设备多值时,按钮作特殊处理
            button = $(`<button style="margin-bottom: 2px;margin-top:5px;" type="button" title="增加下发数据"><i class="fa fa-plus"></i>增加下发数据</button>`);
            inputEle = $(`<div class="control-cmd-btn-name-box"><span>下发按钮名称</span><input type="text" class="control-cmd-btn-name" style="width:120px;"/></div>`);
        }
        deviceFieldBox.append(inputEle);
    }

    function showClsFieldSelect() {
        var value = deviceClsFieldCheckBox.prop('checked');
        self.setAttribute(selectCell, 'device_cls_field', value);
        self.reRenderField(selectCell);
    }

    function setFieldBooleanStatus() {
        var value = statusCheckbox.prop('checked');
        self.setAttribute(selectCell, 'device_field_boolean_status', value);
        self.reRenderField(selectCell);
    }

    function setControlBooleanStatus() {
        var value = statusCheckbox.prop('checked');
        self.setAttribute(selectCell, 'device_control_boolean_status', value);
        self.reRenderField(selectCell);
    }

    function setExpressionCheckedValue() {
        var value = expressionCheckbox.prop('checked');
        self.setAttribute(selectCell, 'device_field_expression_value', value);
        self.reRenderField(selectCell);
    }

    function showExpressionDialog() {
        NeptuneUtils.showExpressionDialog({
            value: {
                code: device_field_code_expression || '',
                testdata: device_field_testdata_expression || '',
                outputdata: device_field_outputdata_expression || ''
            }
        }).done(function (param) {
            graph.getModel().beginUpdate();
            try {
                graph.setAttributeForCell(selectCell, 'device_field_code_expression', param.value.code || '');
                graph.setAttributeForCell(selectCell, 'device_field_testdata_expression', param.value.testdata || '');
                graph.setAttributeForCell(selectCell, 'device_field_outputdata_expression', param.value.outputdata || '');
            } catch (e) {
            } finally {
                graph.getModel().endUpdate();
            }
        });
    }

    function setFieldsValue() {
        graph.getModel().beginUpdate();
        try {
            var fields = [];
            let tag2 = mxUtils.getValue(state.style, 'tag2');
            let virtual_uuid = graph.getAttributeForCell(selectCell, 'device_uuid'); // 虚拟设备uuid
            let multi_device_uuid = graph.getAttributeForCell(selectCell, 'multi_device_uuid'); // 虚拟设备uuid集合
            var control_cmd_type = graph.getAttributeForCell(selectCell, 'control_cmd_type');

            fields = JSON.stringify(NeptuneUtils.clsDDCollection);
            graph.setAttributeForCell(selectCell, 'device_fields', fields);
        } finally {
            graph.getModel().endUpdate();
            self.reRenderField(selectCell);
        }
    }

    function addRow(item, idx) {
        let tag2 = mxUtils.getValue(state.style, 'tag2');
        let control_cmd_type = graph.getAttributeForCell(selectCell, 'control_cmd_type');
        let rows = [];
        rows.push(`<tr>`);
        rows.push(`<td>${item.key || ''}</td>`);
        if (tag2 === "control") {
            if (control_cmd_type === 'multipleDeviceValue') {
                rows.push(`<td>${item.value || ''}</td>`);
            }
        } else {
            rows.push(`<td>${item.name || ''}</td>`);
        }
        rows.push(`</tr>`);
        rows.push('</div>');
        return rows.join('');
    }

    function renderFieldRows() {
        let rows = [];
        let tag2 = mxUtils.getValue(state.style, 'tag2');
        let control_cmd_type = graph.getAttributeForCell(selectCell, 'control_cmd_type');
        rows.push(`<div style="padding-right: 15px">`);
        rows.push(`<table class="table table-condensed table-bordered" style="margin-bottom: 0">`);
        if (tag2 === 'control') {
            if (control_cmd_type === "multipleDeviceValue") {
                rows.push(`<thead><tr><th>数据栏位</th><th>下发值</th></tr></thead>`);
            } else {
                rows.push(`<thead><tr><th>数据栏位</th></tr></thead>`);
                rows = `<div><span style="font-weight: bold;margin-right: 20px">数据栏位:</span><span>${device_fields[0].key || ''}</span></div>`;
                let rowElement = deviceFieldBox.find('.mxgraph-device-field-rows');
                rowElement.html(rows);
                return
            }
        } else {
            rows.push(`<thead><tr><th>数据栏位</th><th>数据名称</th></tr></thead>`);
        }
        _.each(device_fields, function (item, idx) {
            rows.push(addRow(item, idx));
        });
        rows.push(`</table>`);
        rows.push(`</div>`);
        let rowElement = deviceFieldBox.find('.mxgraph-device-field-rows');
        rowElement.html(rows.join(''));
    }

    // 如果没有选择设备,则隐藏数据栏位
    if (tag2 === 'control') {
        if (control_cmd_type === 'singleDeviceValue') {
            if (!device_uuid) {
                $(deviceFieldBox).closest(".geFormatSection").hide();
            }
        } else if (control_cmd_type === 'multipleDeviceValue' || control_cmd_type === 'multipleDeviceExpression') {
            if (!multi_device_uuid) {
                $(deviceFieldBox).closest(".geFormatSection").hide();
            }
        }
    } else {
        if (!device_uuid) {
            $(deviceFieldBox).closest(".geFormatSection").hide();
        }
    }
    return div;
};

DataPanel.prototype.addDeviceCmdExpressionPanel = function (div) {
    var graph = this.editorUi.editor.graph;

    var button = $(`<button style="width:195px;margin-bottom: 2px;" type="button" title="数据下发表达式">数据下发表达式</button>`)[0];
    div.append(button);

    var selectCells = graph.getSelectionCells();
    var selectCell = _.first(selectCells);

    var device_cmd_code_expression = graph.getAttributeForCell(selectCell, 'device_cmd_code_expression');
    var device_cmd_testdata_expression = graph.getAttributeForCell(selectCell, 'device_cmd_testdata_expression');
    var device_cmd_outputdata_expression = graph.getAttributeForCell(selectCell, 'device_cmd_outputdata_expression');
    if (device_cmd_code_expression || device_cmd_testdata_expression || device_cmd_outputdata_expression) {
        var span = $(`<span style="color: red;padding-left: 5px;">※</span>`)[0];
        button.append(span);
    }

    mxEvent.addListener(button, 'click', function (evt) {
        NeptuneUtils.showExpressionDialog({
            value: {
                code: device_cmd_code_expression || '',
                testdata: device_cmd_testdata_expression || '',
                outputdata: device_cmd_outputdata_expression || ''
            }
        }).done(function (param) {
            graph.getModel().beginUpdate();
            try {
                graph.setAttributeForCell(selectCell, 'device_cmd_code_expression', param.value.code || '');
                graph.setAttributeForCell(selectCell, 'device_cmd_testdata_expression', param.value.testdata || '');
                graph.setAttributeForCell(selectCell, 'device_cmd_outputdata_expression', param.value.outputdata || '');
            } catch (e) {
            } finally {
                graph.getModel().endUpdate();
            }
        });

        mxEvent.consume(evt);
    });
    return div;
};


DataPanel.prototype.addDevicePanel = function (div) {
    let self = this;
    var graph = this.editorUi.editor.graph;

    var selectCells = graph.getSelectionCells();
    var selectCell = _.first(selectCells);

    var select = $('<div class="single-device"><select class="format-input chosen-select"><option value="">请选择添加...</option></select></div>')[0];
    div.append(select);

    var state = this.format.getSelectionState();
    var tag2 = mxUtils.getValue(state.style, 'tag2');
    var control_cmd_type = graph.getAttributeForCell(selectCell, 'control_cmd_type');

    var multipleSelect = $('<div class="multiple-device"><select class="format-input chosen-select" multiple><option value="" disabled>请选择设备关联...</option></select></div>')[0];
    div.append(multipleSelect);

    var device_uuid = graph.getAttributeForCell(selectCell, 'device_uuid');
    var multi_device_uuid = graph.getAttributeForCell(selectCell, 'multi_device_uuid');

    var id = NeptuneUtils.findGetParameter('id');
    NeptuneUtils.getPlaceholderList(id).done(function (list) {
        var selectOpHtml = [];
        _.each(list, function (placeholder) {
            if (tag2 === 'control' && control_cmd_type === 'multipleDeviceValue') {
                let cell_clsCode = graph.getAttributeForCell(selectCell, 'multi_device_clsCode');
                if (placeholder.clsCode === cell_clsCode) {
                    selectOpHtml.push(`<option value="${placeholder.name}">${placeholder.name}</option>`);
                } else if (_.isEmpty(cell_clsCode)) {
                    selectOpHtml.push(`<option value="${placeholder.name}">${placeholder.name}</option>`);
                }
            } else {
                selectOpHtml.push(`<option value="${placeholder.name}">${placeholder.name}</option>`);
            }
        });
        // single device select.
        var singleSelectEle = $(div).find('.single-device .chosen-select');
        singleSelectEle.append(selectOpHtml.join(''));
        if (device_uuid) {
            singleSelectEle.val(device_uuid)
        }
        singleSelectEle.chosen({
            search_contains: true,
            allow_single_deselect: true,
            no_results_text: "没有匹配结果"
        }).change(function (event, item) {
            graph.getModel().beginUpdate();
            try {
                var uuid = _.get(item, 'selected', '');
                graph.setAttributeForCell(selectCell, 'device_uuid', uuid);
                graph.setAttributeForCell(selectCell, 'device_fields', []);
            } finally {
                graph.getModel().endUpdate();
            }
            mxEvent.consume(event);
        });

        // multiple device select.
        var multiSelectEle = $(div).find('.multiple-device .chosen-select');
        multiSelectEle.append(selectOpHtml.join(''));
        if (multi_device_uuid) {
            multiSelectEle.val(multi_device_uuid.split(","))
        }
        multiSelectEle.chosen({
            search_contains: true,
            allow_single_deselect: true,
            no_results_text: "没有匹配结果",
            placeholder_text_multiple: "请选择设备关联..."
        }).change(function (event, item) {
            graph.getModel().beginUpdate();
            try {
                // 设置cell的uuid集合,cell
                graph.setAttributeForCell(selectCell, 'multi_device_uuid', _.toString(multiSelectEle.val()));
                let firstVirtualDeviceUUid = _.get(multiSelectEle.val(), [0], "");
                if (_.isEmpty(firstVirtualDeviceUUid)) {
                    graph.setAttributeForCell(selectCell, 'multi_device_clsCode', '');
                } else {
                    let virtualDevice = _.find(NeptuneUtils.placeholderList, ['name', firstVirtualDeviceUUid]);
                    graph.setAttributeForCell(selectCell, 'multi_device_clsCode', _.get(virtualDevice, 'clsCode', ''));
                }
            } finally {
                graph.getModel().endUpdate();
            }
            mxEvent.consume(event);
        });
    });


    // 组件类型为数据控制时,需判断显示单设备选择框还是多设备选择框.
    if (tag2 === 'control') {
        if (control_cmd_type === 'singleDeviceValue') {
            $(div).find('.multiple-device').hide();
        } else if (control_cmd_type === 'multipleDeviceValue' || control_cmd_type === 'multipleDeviceExpression') {
            $(div).find('.single-device').hide();
        }
    } else {
        $(div).find('.multiple-device').hide();
    }
    return div;
};

DataPanel.prototype.addTimelineRangPanel = function (div) {
    var self = this;
    var graph = this.editorUi.editor.graph;

    var selectCells = graph.getSelectionCells();
    var selectCell = _.first(selectCells);

    var rangeSelect = $(`<select class="format-input" style="display: block;margin-bottom: 10px">
                                <option value="">请选择时间轴范围...</option>
                                <option value="today">今天</option>
                                <option value="yesterday">昨天</option>
                                <option value="seven">近七天</option>
                             </select>`)[0];
    div.append(rangeSelect);

    var timeline_range = graph.getAttributeForCell(selectCell, 'timeline_range');
    if (timeline_range) {
        rangeSelect.value = timeline_range;
    } else {
        rangeSelect.value = 'today';
        graph.setAttributeForCell(selectCell, 'timeline_range', 'today');
    }
    // 下发类型 下发框 事件
    mxEvent.addListener(rangeSelect, 'change', function (evt) {
        graph.getModel().beginUpdate();
        try {
            var value = rangeSelect.value;
            graph.setAttributeForCell(selectCell, 'timeline_range', value);
        } finally {
            graph.getModel().endUpdate();
            self.reRenderField(selectCell);
        }
        mxEvent.consume(evt);
    });
    return div;
};

DataPanel.prototype.addDeviceCmdChangePanel = function (div) {
    var self = this;
    var graph = this.editorUi.editor.graph;

    var selectCells = graph.getSelectionCells();
    var selectCell = _.first(selectCells);

    var controlSelect = $(`<select class="format-input" style="display: block;margin-bottom: 10px">
                                <option value="">请选择数据下发方式...</option>
                                <option value="singleDeviceValue">单设备-单值下发</option>
                                <option value="multipleDeviceValue">多设备-多值下发</option>
                             </select>`)[0];
    div.append(controlSelect);

    var cmdType = graph.getAttributeForCell(selectCell, 'control_cmd_type');
    if (cmdType) {
        controlSelect.value = cmdType;
    }
    // 下发类型 下发框 事件
    mxEvent.addListener(controlSelect, 'change', function (evt) {
        graph.getModel().beginUpdate();
        try {
            var value = controlSelect.value;
            graph.setAttributeForCell(selectCell, 'control_cmd_type', value);
            graph.setAttributeForCell(selectCell, 'device_fields', []);
        } finally {
            graph.getModel().endUpdate();
            self.reRenderField(selectCell);
        }
        mxEvent.consume(evt);
    });

    return div;
};

DataPanel.prototype.addConponentAnimatePanel = function (div) {
    var self = this;
    var graph = this.editorUi.editor.graph;
    var selectCells = graph.getSelectionCells();
    var selectCell = _.first(selectCells);

    var span = $(`<span style="position: absolute">动画</span>`)[0];
    var animateShow = $(`<div class="show-animate">动画展示</div>`)[0];
    var animateStyle = $(`<select class="format-input" >
                                    <option value="">无</option>
                                    <option value="rotateRight">旋转(顺时针)</option>
                                    <option value="rotateLeft">旋转(逆时针)</option>
                                    <option value="flash">闪烁</option>
                                    <option value="shake">抖动</option>                                                                                                         
                                 </select>`)[0];
    var animate_type = graph.getAttributeForCell(selectCell, 'animate_type');
    if (!_.isEmpty(animate_type)) {
        animateStyle.value = animate_type;
        setTimeout(function () {
            var show_animate_div = $(".show-animate");
            show_animate_div.addClass("animated infinite slower " + animate_type);
        }, 300);
    }
    mxEvent.addListener(animateStyle, 'change', function (evt) {
        graph.getModel().beginUpdate();
        try {
            var value = animateStyle.value;
            setTimeout(function () {
                var show_animate_div = $(".show-animate");
                show_animate_div.addClass("animated infinite slower " + value);
            }, 1000);
            graph.setAttributeForCell(selectCell, 'animate_type', value);
        } finally {
            graph.getModel().endUpdate();
        }
        mxEvent.consume(evt);
    });

    div.append(span);
    div.append(animateShow);
    div.append(animateStyle);

    var switchHtml = $(`<div style="margin-bottom: 10px">                                                               
                            <div style="display: flex;justify-content: space-between;margin-right: 25px">
                                <span style="text-align: left;padding-top: 12px;">表达式为真时启用动画</span>
                                <input type="checkbox" class="animation_switch" style="margin-top: 12px;" />
                            </div>                           
                        </div>`)[0];
    div.append(switchHtml);

    // 是否使用表达式 选项
    var animation_switch = $(switchHtml).find('.animation_switch');
    var is_use_animation_expression = graph.getAttributeForCell(selectCell, 'is_use_animation_expression');
    animation_switch.prop('checked', is_use_animation_expression === 'true');
    animation_switch.change(function () {
        setExpressionCheckedValue();
    });

    function setExpressionCheckedValue() {
        var value = animation_switch.prop('checked');
        self.setAttribute(selectCell, 'is_use_animation_expression', value);
        self.reRenderField(selectCell);
    }

    // 动画表达式按钮
    var button = $(`<button style="width:195px;margin-bottom: 2px;" type="button" title="动画表达式">动画表达式</button>`)[0];
    if (is_use_animation_expression === 'true') {
        div.append(button);
    }
    var animate_code_expression = graph.getAttributeForCell(selectCell, 'animate_code_expression');
    var animate_testdata_expression = graph.getAttributeForCell(selectCell, 'animate_testdata_expression');
    var animate_outputdata_expression = graph.getAttributeForCell(selectCell, 'animate_outputdata_expression');
    if (animate_code_expression || animate_testdata_expression || animate_outputdata_expression) {
        var span = $(`<span style="color: red;padding-left: 5px;">※</span>`)[0];
        button.append(span);
    }

    mxEvent.addListener(button, 'click', function (evt) {
        NeptuneUtils.showExpressionDialog({
            value: {
                code: animate_code_expression || '',
                testdata: animate_testdata_expression || '',
                outputdata: animate_outputdata_expression || ''
            }
        }).done(function (param) {
            graph.getModel().beginUpdate();
            try {
                graph.setAttributeForCell(selectCell, 'animate_code_expression', param.value.code || '');
                graph.setAttributeForCell(selectCell, 'animate_testdata_expression', param.value.testdata || '');
                graph.setAttributeForCell(selectCell, 'animate_outputdata_expression', param.value.outputdata || '');
            } catch (e) {
            } finally {
                graph.getModel().endUpdate();
            }
        });
        mxEvent.consume(evt);
    });

    return div;
};

DataPanel.prototype.addFlowBarPanel = function (div) {
    var self = this;
    var ui = this.editorUi;
    var graph = this.editorUi.editor.graph;
    var selectCells = graph.getSelectionCells();
    var selectCell = _.first(selectCells);

    var flow_direction = graph.getAttributeForCell(selectCell, 'flow_direction') || 'normal';

    function saveAtt(key, value) {
        self.setAttribute(selectCell, key, value);
        self.reRenderField(selectCell);
    }

    var directionHtml = $(`<span class="flow_bar style_item"> 
                                <label class="style_item_label">流动方向</label>
                                 <select class="flow_direction_select">
                                     <option label="正方向" value="normal" ${flow_direction === 'normal' ? "selected='selected'" : ''}>正方向</option>
                                     <option label="反方向" value="reverse" ${flow_direction === 'reverse' ? "selected='selected'" : ''}>反方向</option>
                                 </select> 
                            </span>`)[0];
    div.append(directionHtml);
    /*方向选择*/
    $(directionHtml).find('select.flow_direction_select').change(function () {
        saveAtt('flow_direction', $(this).val());
    });

    var speed = graph.getAttributeForCell(selectCell, 'flow_speed') || '3';
    var speedHtml = $(`<span class="flow_bar style_item">
                        <label class="style_item_label">流动速度</label> 
                        <select class="flow_speed_select">
                            <option label="快" value="1" ${speed == '1' ? "selected='selected'" : ''}>快</option>
                            <option label="中" value="3" ${speed == '3' ? "selected='selected'" : ''}>中</option>
                            <option label="慢" value="5" ${speed == '5' ? "selected='selected'" : ''}>慢</option>
                        </select> 
                   </span>`)[0];
    div.append(speedHtml);
    /*流动速度选择*/
    $(speedHtml).find('select.flow_speed_select').change(function () {
        saveAtt('flow_speed', $(this).val());
    });

    /*流动条颜色*/
    var flow_color = graph.getAttributeForCell(selectCell, 'flow_color') || '#3895ff';
    var colorHtml = $(`<div class="mxgraph-dynamic-bgcolor-row" style="justify-content: space-between;margin-right: 12px"><span style="width: 70px">流动条颜色</span><div class="mxgraph-dynamic-bgcolor-picker-box"><div class="mxgraph-dynamic-bgcolor-picker" style="background:${flow_color}"></div></div></div>`)[0];
    div.append(colorHtml);
    $(colorHtml).find('.mxgraph-dynamic-bgcolor-picker').click(function () {
        ui.pickColor(flow_color, function (selectColor) {
            $(colorHtml).find('.mxgraph-dynamic-bgcolor-picker').css('background', selectColor);
            saveAtt('flow_color', selectColor);
        });
    });


    /*流动条背景颜色*/
    var flow_background = graph.getAttributeForCell(selectCell, 'flow_background') || '#ffffff';
    var backgroundHtml = $(`<div class="mxgraph-dynamic-bgcolor-row" style="justify-content: space-between;margin-right: 12px"><span style="width: 70px">背景色</span><div class="mxgraph-dynamic-bgcolor-picker-box"><div class="mxgraph-dynamic-bgcolor-picker" style="background:${flow_background}"></div></div></div>`)[0];
    div.append(backgroundHtml);
    $(backgroundHtml).find('.mxgraph-dynamic-bgcolor-picker').click(function () {
        ui.pickColor(flow_background, function (selectColor) {
            $(backgroundHtml).find('.mxgraph-dynamic-bgcolor-picker').css('background', selectColor);
            saveAtt('flow_background', selectColor);
        });
    });

    // 是否使用表达式 选项
    var switchHtml = $(`<div style="margin-bottom: 10px">                                                               
                        <div style="display: flex;justify-content: space-between;margin-right: 15px">
                            <span style="text-align: left;padding-top: 12px;">表达式为真时流动</span>
                            <input type="checkbox" class="flowbar_switch" style="margin-top: 12px;" />
                        </div>                           
                    </div>`)[0];
    div.append(switchHtml);
    var flowbar_switch = $(switchHtml).find('.flowbar_switch');
    var is_use_flowbar_expression = graph.getAttributeForCell(selectCell, 'is_use_flowbar_expression');
    flowbar_switch.prop('checked', is_use_flowbar_expression === 'true');
    flowbar_switch.change(function () {
        setExpressionCheckedValue();
    });

    function setExpressionCheckedValue() {
        var value = flowbar_switch.prop('checked');
        saveAtt('is_use_flowbar_expression', value);
    }

    // 流动表达式按钮
    var button = $(`<button style="width:195px;margin-bottom: 2px;" type="button" title="流动表达式">流动表达式</button>`)[0];
    if (is_use_flowbar_expression === 'true') {
        div.append(button);
    }
    var flow_code_expression = graph.getAttributeForCell(selectCell, 'flow_code_expression');
    var flow_testdata_expression = graph.getAttributeForCell(selectCell, 'flow_testdata_expression');
    var flow_outputdata_expression = graph.getAttributeForCell(selectCell, 'flow_outputdata_expression');
    if (flow_code_expression || flow_testdata_expression || flow_outputdata_expression) {
        var span = $(`<span style="color: red;padding-left: 5px;">※</span>`)[0];
        button.append(span);
    }

    /*表达式按钮事件*/
    mxEvent.addListener(button, 'click', function (evt) {
        NeptuneUtils.showExpressionDialog({
            value: {
                code: flow_code_expression || '',
                testdata: flow_testdata_expression || '',
                outputdata: flow_outputdata_expression || ''
            }
        }).done(function (param) {
            graph.getModel().beginUpdate();
            try {
                graph.setAttributeForCell(selectCell, 'flow_code_expression', param.value.code || '');
                graph.setAttributeForCell(selectCell, 'flow_testdata_expression', param.value.testdata || '');
                graph.setAttributeForCell(selectCell, 'flow_outputdata_expression', param.value.outputdata || '');
            } catch (e) {
            } finally {
                graph.getModel().endUpdate();
            }
        });
        mxEvent.consume(evt);
    });

    return div;
};

DataPanel.prototype.addProgressbarPanel = function (div) {
    var self = this;
    var ui = this.editorUi;
    var graph = this.editorUi.editor.graph;
    var selectCells = graph.getSelectionCells();
    var selectCell = _.first(selectCells);

    var progress_percent = graph.getAttributeForCell(selectCell, 'progress_percent') || '40';
    var progress_percent_label_show = graph.getAttributeForCell(selectCell, 'progress_percent_label_show') || "true";
    var progress_font_color = graph.getAttributeForCell(selectCell, 'progress_font_color') || '#ffffff';
    var progress_color = graph.getAttributeForCell(selectCell, 'progress_color') || '#3895ff';
    var progress_background = graph.getAttributeForCell(selectCell, 'progress_background') || '#98ceff';

    function saveAtt(key, value) {
        self.setAttribute(selectCell, key, value);
        self.reRenderField(selectCell);
    }

    var settingHtml = $(`<div class="mxgraph-progressbar-setting">
                        <div class="mxgraph-setting-row">
                            <div class="mxgraph-setting-label">进度值</div>
                            <div class="mxgraph-setting-value">
                                <div class="input-group">
                                  <input type="number" style="width:50px;height:14px" class="form-control progress-percent" value="${_.trimEnd(progress_percent, '%')}">
                                  <span class="input-group-addon">%</span>
                                </div>
                            </div>
                        </div>
                        <div class="mxgraph-dynamic-bgcolor-row maxgraph-row-flex">
                            <span style="width: 70px">进度条颜色</span>
                            <div class="mxgraph-dynamic-bgcolor-picker-box" style="margin-right: 0;">
                                <div class="mxgraph-dynamic-bgcolor-picker progress-bar-color" style="background:${progress_color}"></div>
                            </div>
                        </div>
                        <div class="mxgraph-dynamic-bgcolor-row maxgraph-row-flex">
                            <span style="width: 70px">进度条背景色</span>
                            <div class="mxgraph-dynamic-bgcolor-picker-box" style="margin-right: 0;">
                                <div class="mxgraph-dynamic-bgcolor-picker progress-bar-bgcolor" style="background:${progress_background}"></div>
                            </div>
                        </div>
                        <div style="margin-bottom: 10px">                                                               
                            <div class="maxgraph-row-flex">
                                <span style="text-align: left">显示进度条数值</span>
                                <input type="checkbox" class="progressbar_label_switch" style="margin-top: 0"/>
                            </div>                           
                        </div>
                    </div>`)[0];
    div.append(settingHtml);
    /*设置进度条百分比*/
    $(settingHtml).find('input.progress-percent').click(function (event) {
        event.stopPropagation();
    });
    $(settingHtml).click(function () {
        $(settingHtml).find('input.progress-percent').blur();
    });
    $(settingHtml).find('input.progress-percent').change(function () {
        saveAtt('progress_percent', $(this).val());
    });

    /*是否显示进度条数字*/
    let showFont = progress_percent_label_show === 'true';
    var progressbar_label_switch = $($(settingHtml)[0]).find('.progressbar_label_switch');
    progressbar_label_switch.prop('checked', showFont);
    progressbar_label_switch.change(function () {
        var value = progressbar_label_switch.prop('checked');
        saveAtt('progress_percent_label_show', value);
    });

    if (showFont) {
        /*设置字体颜色*/
        let fontColorHtml = $(`<div class="mxgraph-dynamic-bgcolor-row maxgraph-row-flex">
                            <span style="width: 70px">数值颜色</span>
                            <div class="mxgraph-dynamic-bgcolor-picker-box" style="margin-right: 0;">
                                <div class="mxgraph-dynamic-bgcolor-picker progress-bar-fontcolor" style="background:${progress_font_color}"></div>
                            </div>
                        </div>`)[0];
        div.append(fontColorHtml);
        $(fontColorHtml).find('.progress-bar-fontcolor').click(function () {
            ui.pickColor(progress_font_color, function (selectColor) {
                $(settingHtml).find('.progress-bar-fontcolor').css('background', selectColor);
                saveAtt('progress_font_color', selectColor);
            });
        });
    }

    /*进度条颜色*/
    $(settingHtml).find('.progress-bar-color').click(function () {
        ui.pickColor(progress_color, function (selectColor) {
            $($(settingHtml)[0]).find('.progress-bar-color').css('background', selectColor);
            saveAtt('progress_color', selectColor);
        });
    });

    /*流动条背景颜色*/
    $(settingHtml).find('.progress-bar-bgcolor').click(function () {
        ui.pickColor(progress_background, function (selectColor) {
            $(settingHtml).find('.progress-bar-bgcolor').css('background', selectColor);
            saveAtt('progress_background', selectColor);
        });
    });

    // 是否使用表达式 选项
    var switchHtml = $(`<div style="margin-bottom: 10px">                                                               
                        <div class="maxgraph-row-flex">
                            <span style="text-align: left;">是否使用表达式设置进度值</span>
                            <input type="checkbox" class="progressbar_switch" style="margin-top: 0" />
                        </div>                           
                    </div>`)[0];
    div.append(switchHtml);
    var progressbar_switch = $(switchHtml).find('.progressbar_switch');
    var is_use_progressbar_expression = graph.getAttributeForCell(selectCell, 'is_use_progressbar_expression');
    progressbar_switch.prop('checked', is_use_progressbar_expression === 'true');
    progressbar_switch.change(function () {
        var value = progressbar_switch.prop('checked');
        if (value) {
            /*使用表达式的时候自动调整为0*/
            self.setAttribute(selectCell, 'progress_percent', 0);
        }
        saveAtt('is_use_progressbar_expression', value);
    });

    // 动态进度表达式按钮
    var button = $(`<button style="width:195px;margin-bottom: 2px;" type="button" title="动态进度表达式">动态进度表达式</button>`)[0];
    if (is_use_progressbar_expression === 'true') {
        div.append(button);
    }
    var progressbar_code_expression = graph.getAttributeForCell(selectCell, 'progressbar_code_expression');
    var progress_testdata_expression = graph.getAttributeForCell(selectCell, 'progress_testdata_expression');
    var progress_outputdata_expression = graph.getAttributeForCell(selectCell, 'progress_outputdata_expression');
    if (progressbar_code_expression || progress_testdata_expression || progress_outputdata_expression) {
        var span = $(`<span style="color: red;padding-left: 5px;">※</span>`)[0];
        button.append(span);
    }

    /*表达式按钮事件*/
    mxEvent.addListener(button, 'click', function (evt) {
        NeptuneUtils.showExpressionDialog({
            value: {
                code: progressbar_code_expression || '',
                testdata: progress_testdata_expression || '',
                outputdata: progress_outputdata_expression || ''
            }
        }).done(function (param) {
            graph.getModel().beginUpdate();
            try {
                graph.setAttributeForCell(selectCell, 'progressbar_code_expression', param.value.code || '');
                graph.setAttributeForCell(selectCell, 'progress_testdata_expression', param.value.testdata || '');
                graph.setAttributeForCell(selectCell, 'progress_outputdata_expression', param.value.outputdata || '');
            } catch (e) {
            } finally {
                graph.getModel().endUpdate();
            }
        });
        mxEvent.consume(evt);
    });

    return div;
};

DataPanel.prototype.addMapPanel = function (div) {
    var self = this;
    var graph = this.editorUi.editor.graph;
    var selectCells = graph.getSelectionCells();
    var selectCell = _.first(selectCells);

    var map_url_type = graph.getAttributeForCell(selectCell, 'map_url_type') || 'user_add';
    var poi = graph.getAttributeForCell(selectCell, 'poi') || {};
    if (!_.isEmpty(poi)) {
        poi = JSON.parse(poi);
    }
    var show_device_range = graph.getAttributeForCell(selectCell, 'show_device_range') || 'link_device';

    function saveAtt(key, value) {
        self.setAttribute(selectCell, key, value);
        self.reRenderField(selectCell);
    }

    var urlSelectHtml = $(`<div class="config_item"> 
                            <span class="style_item device_scope_box">
                             <label class="style_item_label">地址来源</label> 
                             <select class="map_url_select">
                                 <option value="user_add" ${map_url_type === 'user_add' ? "selected='selected'" : ""}>手动选择地图点</option>
                                 <option value="bind_device" ${map_url_type === 'bind_device' ? "selected='selected'" : ""}>绑定设备地图点</option>
                             </select>
                             </span> 
                            </div>`)[0];
    div.append(urlSelectHtml);

    var selectType = $(urlSelectHtml).find('.map_url_select');
    selectType.change(function () {
        saveAtt("map_url_type", selectType.val());
    });

    if (map_url_type === 'user_add') {
        var userAddHtml = $(`<div class="config_item picker-div">
                                <input class="form-control" id="pickerInput" style="width: 180px;height:15px" autocomplete="off" placeholder="请输入搜索地址">
                            </div>`)[0];
        div.append(userAddHtml);
        var userAddInput = $(userAddHtml).find('#pickerInput');
        let inputName = _.get(poi, 'name', '');
        if (inputName) {
            userAddInput.val(inputName);
        }
        AMapUI.loadUI(['misc/PoiPicker'], function (PoiPicker) {

            var pickerInput = $('#pickerInput');
            if (pickerInput.length) {
                var poiPicker = new PoiPicker({
                    input: userAddInput[0]
                });

                poiPicker.on('poiPicked', function (poiResult) {
                    var poi = poiResult.item;
                    saveAtt('poi', JSON.stringify(poi));
                });
            }
        });
    } else if (map_url_type === 'bind_device') {
        var selectDeviceRangeHtml = $(`<div class="config_item"> 
                            <span class="style_item device_scope_box">
                             <label class="style_item_label">设备范围</label> 
                             <select class="device_range_select" id="device_range_select">
                                 <option value="link_device" ${show_device_range === 'link_device' ? "selected='selected'" : ""}>所有关联设备</option>
                                 <option value="assign_device" ${show_device_range === 'assign_device' ? "selected='selected'" : ""}>指定关联设备</option>
                             </select>
                             </span> 
                            </div>`)[0];
        div.append(selectDeviceRangeHtml);
        var deviceRange = $(selectDeviceRangeHtml).find('#device_range_select');
        deviceRange.change(function (event) {
            saveAtt('show_device_range', deviceRange.val());
            mxEvent.consume(event);
        });

        function selectAllDevice(list) {
            var all_device_uuid = [];
            _.each(list, function (placeholder) {
                all_device_uuid.push(placeholder.name);
            });
            graph.getModel().beginUpdate();
            try {
                graph.setAttributeForCell(selectCell, 'multi_device_uuid', _.toString(all_device_uuid));
            } finally {
                graph.getModel().endUpdate();
            }
        }

        /*if (show_device_range === 'link_device') {
            let id = NeptuneUtils.findGetParameter('id');
            if (_.isEmpty(NeptuneUtils.placeholderList)) {
                NeptuneUtils.getPlaceholderList(id).done(function (list) {
                    selectAllDevice(list);
                });
            } else {
                selectAllDevice(NeptuneUtils.placeholderList);
            }
        }*/

        function initSelectDevice(list) {
            var selectOpHtml = [];
            _.each(list, function (placeholder) {
                let cell_clsCode = graph.getAttributeForCell(selectCell, 'multi_device_clsCode');
                if (placeholder.clsCode === cell_clsCode) {
                    selectOpHtml.push(`<option value="${placeholder.name}" selected="selected">${placeholder.name}</option>`);
                } else {
                    selectOpHtml.push(`<option value="${placeholder.name}">${placeholder.name}</option>`);
                }
            });
            // multiple device select.
            var multiSelectEle = $(div).find('.multiple-device .chosen-select');
            multiSelectEle.append(selectOpHtml.join(''));
            if (multi_device_uuid) {
                multiSelectEle.val(multi_device_uuid.split(","))
            }
            multiSelectEle.chosen({
                search_contains: true,
                allow_single_deselect: true,
                no_results_text: "没有匹配结果",
                placeholder_text_multiple: "请选择设备关联..."
            }).change(function (event, item) {
                graph.getModel().beginUpdate();
                try {
                    // 设置cell的uuid集合,cell
                    graph.setAttributeForCell(selectCell, 'multi_device_uuid', _.toString(multiSelectEle.val()));
                    let firstVirtualDeviceUUid = _.get(multiSelectEle.val(), [0], "");
                    if (_.isEmpty(firstVirtualDeviceUUid)) {
                        graph.setAttributeForCell(selectCell, 'multi_device_clsCode', '');
                    } else {
                        let virtualDevice = _.find(NeptuneUtils.placeholderList, ['name', firstVirtualDeviceUUid]);
                        graph.setAttributeForCell(selectCell, 'multi_device_clsCode', _.get(virtualDevice, 'clsCode', ''));
                    }
                } finally {
                    graph.getModel().endUpdate();
                }
                mxEvent.consume(event);
            });
        }

        if (show_device_range === 'assign_device') {
            var multipleSelect = $('<div class="multiple-device"><select class="format-input chosen-select" multiple><option value="" disabled>请选择设备关联...</option></select></div>')[0];
            div.append(multipleSelect);

            var multi_device_uuid = graph.getAttributeForCell(selectCell, 'multi_device_uuid');
            var id = NeptuneUtils.findGetParameter('id');
            if (_.isEmpty(NeptuneUtils.placeholderList)) {
                NeptuneUtils.getPlaceholderList(id).done(function (list) {
                    initSelectDevice(list);
                });
            } else {
                initSelectDevice(NeptuneUtils.placeholderList);
            }

        }
    }

    return div;
};
/**
 * Copyright (c) 2006-2015, JGraph Ltd
 */

/**
 * Registers shapes.
 */
(function () {
    // Cube Shape, supports size style
    function CubeShape() {
        mxCylinder.call(this);
    };
    mxUtils.extend(CubeShape, mxCylinder);
    CubeShape.prototype.size = 20;
    CubeShape.prototype.darkOpacity = 0;
    CubeShape.prototype.darkOpacity2 = 0;

    CubeShape.prototype.paintVertexShape = function (c, x, y, w, h) {
        var s = Math.max(0, Math.min(w, Math.min(h, parseFloat(mxUtils.getValue(this.style, 'size', this.size)))));
        var op = Math.max(-1, Math.min(1, parseFloat(mxUtils.getValue(this.style, 'darkOpacity', this.darkOpacity))));
        var op2 = Math.max(-1, Math.min(1, parseFloat(mxUtils.getValue(this.style, 'darkOpacity2', this.darkOpacity2))));
        c.translate(x, y);

        c.begin();
        c.moveTo(0, 0);
        c.lineTo(w - s, 0);
        c.lineTo(w, s);
        c.lineTo(w, h);
        c.lineTo(s, h);
        c.lineTo(0, h - s);
        c.lineTo(0, 0);
        c.close();
        c.end();
        c.fillAndStroke();

        if (!this.outline) {
            c.setShadow(false);

            if (op != 0) {
                c.setFillAlpha(Math.abs(op));
                c.setFillColor((op < 0) ? '#FFFFFF' : '#000000');
                c.begin();
                c.moveTo(0, 0);
                c.lineTo(w - s, 0);
                c.lineTo(w, s);
                c.lineTo(s, s);
                c.close();
                c.fill();
            }

            if (op2 != 0) {
                c.setFillAlpha(Math.abs(op2));
                c.setFillColor((op2 < 0) ? '#FFFFFF' : '#000000');
                c.begin();
                c.moveTo(0, 0);
                c.lineTo(s, s);
                c.lineTo(s, h);
                c.lineTo(0, h - s);
                c.close();
                c.fill();
            }

            c.begin();
            c.moveTo(s, h);
            c.lineTo(s, s);
            c.lineTo(0, 0);
            c.moveTo(s, s);
            c.lineTo(w, s);
            c.end();
            c.stroke();
        }
    };
    CubeShape.prototype.getLabelMargins = function (rect) {
        if (mxUtils.getValue(this.style, 'boundedLbl', false)) {
            var s = parseFloat(mxUtils.getValue(this.style, 'size', this.size)) * this.scale;

            return new mxRectangle(s, s, 0, 0);
        }

        return null;
    };

    mxCellRenderer.registerShape('cube', CubeShape);

    var tan30 = Math.tan(mxUtils.toRadians(30));
    var tan30Dx = (0.5 - tan30) / 2;

    // Cube Shape, supports size style
    function IsoRectangleShape() {
        mxActor.call(this);
    };
    mxUtils.extend(IsoRectangleShape, mxActor);
    IsoRectangleShape.prototype.size = 20;
    IsoRectangleShape.prototype.redrawPath = function (path, x, y, w, h) {
        var m = Math.min(w, h / tan30);

        path.translate((w - m) / 2, (h - m) / 2 + m / 4);
        path.moveTo(0, 0.25 * m);
        path.lineTo(0.5 * m, m * tan30Dx);
        path.lineTo(m, 0.25 * m);
        path.lineTo(0.5 * m, (0.5 - tan30Dx) * m);
        path.lineTo(0, 0.25 * m);
        path.close();
        path.end();
    };

    mxCellRenderer.registerShape('isoRectangle', IsoRectangleShape);

    // Cube Shape, supports size style
    function IsoCubeShape() {
        mxCylinder.call(this);
    };
    mxUtils.extend(IsoCubeShape, mxCylinder);
    IsoCubeShape.prototype.size = 20;
    IsoCubeShape.prototype.redrawPath = function (path, x, y, w, h, isForeground) {
        var m = Math.min(w, h / (0.5 + tan30));

        if (isForeground) {
            path.moveTo(0, 0.25 * m);
            path.lineTo(0.5 * m, (0.5 - tan30Dx) * m);
            path.lineTo(m, 0.25 * m);
            path.moveTo(0.5 * m, (0.5 - tan30Dx) * m);
            path.lineTo(0.5 * m, (1 - tan30Dx) * m);
            path.end();
        } else {
            path.translate((w - m) / 2, (h - m) / 2);
            path.moveTo(0, 0.25 * m);
            path.lineTo(0.5 * m, m * tan30Dx);
            path.lineTo(m, 0.25 * m);
            path.lineTo(m, 0.75 * m);
            path.lineTo(0.5 * m, (1 - tan30Dx) * m);
            path.lineTo(0, 0.75 * m);
            path.close();
            path.end();
        }
    };

    mxCellRenderer.registerShape('isoCube', IsoCubeShape);

    // DataStore Shape, supports size style
    function DataStoreShape() {
        mxCylinder.call(this);
    };
    mxUtils.extend(DataStoreShape, mxCylinder);

    DataStoreShape.prototype.redrawPath = function (c, x, y, w, h, isForeground) {
        var dy = Math.min(h / 2, Math.round(h / 8) + this.strokewidth - 1);

        if ((isForeground && this.fill != null) || (!isForeground && this.fill == null)) {
            c.moveTo(0, dy);
            c.curveTo(0, 2 * dy, w, 2 * dy, w, dy);

            // Needs separate shapes for correct hit-detection
            if (!isForeground) {
                c.stroke();
                c.begin();
            }

            c.translate(0, dy / 2);
            c.moveTo(0, dy);
            c.curveTo(0, 2 * dy, w, 2 * dy, w, dy);

            // Needs separate shapes for correct hit-detection
            if (!isForeground) {
                c.stroke();
                c.begin();
            }

            c.translate(0, dy / 2);
            c.moveTo(0, dy);
            c.curveTo(0, 2 * dy, w, 2 * dy, w, dy);

            // Needs separate shapes for correct hit-detection
            if (!isForeground) {
                c.stroke();
                c.begin();
            }

            c.translate(0, -dy);
        }

        if (!isForeground) {
            c.moveTo(0, dy);
            c.curveTo(0, -dy / 3, w, -dy / 3, w, dy);
            c.lineTo(w, h - dy);
            c.curveTo(w, h + dy / 3, 0, h + dy / 3, 0, h - dy);
            c.close();
        }
    };
    DataStoreShape.prototype.getLabelMargins = function (rect) {
        return new mxRectangle(0, 2.5 * Math.min(rect.height / 2,
            Math.round(rect.height / 8) + this.strokewidth - 1), 0, 0);
    }

    mxCellRenderer.registerShape('datastore', DataStoreShape);

    // Note Shape, supports size style
    function NoteShape() {
        mxCylinder.call(this);
    };
    mxUtils.extend(NoteShape, mxCylinder);
    NoteShape.prototype.size = 30;
    NoteShape.prototype.darkOpacity = 0;

    NoteShape.prototype.paintVertexShape = function (c, x, y, w, h) {
        var s = Math.max(0, Math.min(w, Math.min(h, parseFloat(mxUtils.getValue(this.style, 'size', this.size)))));
        var op = Math.max(-1, Math.min(1, parseFloat(mxUtils.getValue(this.style, 'darkOpacity', this.darkOpacity))));
        c.translate(x, y);

        c.begin();
        c.moveTo(0, 0);
        c.lineTo(w - s, 0);
        c.lineTo(w, s);
        c.lineTo(w, h);
        c.lineTo(0, h);
        c.lineTo(0, 0);
        c.close();
        c.end();
        c.fillAndStroke();

        if (!this.outline) {
            c.setShadow(false);

            if (op != 0) {
                c.setFillAlpha(Math.abs(op));
                c.setFillColor((op < 0) ? '#FFFFFF' : '#000000');
                c.begin();
                c.moveTo(w - s, 0);
                c.lineTo(w - s, s);
                c.lineTo(w, s);
                c.close();
                c.fill();
            }

            c.begin();
            c.moveTo(w - s, 0);
            c.lineTo(w - s, s);
            c.lineTo(w, s);
            c.end();
            c.stroke();
        }
    };

    mxCellRenderer.registerShape('note', NoteShape);

    // Note Shape, supports size style
    function SwitchShape() {
        mxActor.call(this);
    };
    mxUtils.extend(SwitchShape, mxActor);
    SwitchShape.prototype.redrawPath = function (c, x, y, w, h) {
        var curve = 0.5;
        c.moveTo(0, 0);
        c.quadTo(w / 2, h * curve, w, 0);
        c.quadTo(w * (1 - curve), h / 2, w, h);
        c.quadTo(w / 2, h * (1 - curve), 0, h);
        c.quadTo(w * curve, h / 2, 0, 0);
        c.end();
    };

    mxCellRenderer.registerShape('switch', SwitchShape);

    // Folder Shape, supports tabWidth, tabHeight styles
    function FolderShape() {
        mxCylinder.call(this);
    };
    mxUtils.extend(FolderShape, mxCylinder);
    FolderShape.prototype.tabWidth = 60;
    FolderShape.prototype.tabHeight = 20;
    FolderShape.prototype.tabPosition = 'right';
    FolderShape.prototype.redrawPath = function (path, x, y, w, h, isForeground) {
        var dx = Math.max(0, Math.min(w, parseFloat(mxUtils.getValue(this.style, 'tabWidth', this.tabWidth))));
        var dy = Math.max(0, Math.min(h, parseFloat(mxUtils.getValue(this.style, 'tabHeight', this.tabHeight))));
        var tp = mxUtils.getValue(this.style, 'tabPosition', this.tabPosition);

        if (isForeground) {
            if (tp == 'left') {
                path.moveTo(0, dy);
                path.lineTo(dx, dy);
            }
            // Right is default
            else {
                path.moveTo(w - dx, dy);
                path.lineTo(w, dy);
            }

            path.end();
        } else {
            if (tp == 'left') {
                path.moveTo(0, 0);
                path.lineTo(dx, 0);
                path.lineTo(dx, dy);
                path.lineTo(w, dy);
            }
            // Right is default
            else {
                path.moveTo(0, dy);
                path.lineTo(w - dx, dy);
                path.lineTo(w - dx, 0);
                path.lineTo(w, 0);
            }

            path.lineTo(w, h);
            path.lineTo(0, h);
            path.lineTo(0, dy);
            path.close();
            path.end();
        }
    };

    mxCellRenderer.registerShape('folder', FolderShape);

    // Card shape
    function CardShape() {
        mxActor.call(this);
    };
    mxUtils.extend(CardShape, mxActor);
    CardShape.prototype.size = 30;
    CardShape.prototype.isRoundable = function () {
        return true;
    };
    CardShape.prototype.redrawPath = function (c, x, y, w, h) {
        var s = Math.max(0, Math.min(w, Math.min(h, parseFloat(mxUtils.getValue(this.style, 'size', this.size)))));
        var arcSize = mxUtils.getValue(this.style, mxConstants.STYLE_ARCSIZE, mxConstants.LINE_ARCSIZE) / 2;
        this.addPoints(c, [new mxPoint(s, 0), new mxPoint(w, 0), new mxPoint(w, h), new mxPoint(0, h), new mxPoint(0, s)],
            this.isRounded, arcSize, true);
        c.end();
    };

    mxCellRenderer.registerShape('card', CardShape);

    // Tape shape
    function TapeShape() {
        mxActor.call(this);
    };
    mxUtils.extend(TapeShape, mxActor);
    TapeShape.prototype.size = 0.4;
    TapeShape.prototype.redrawPath = function (c, x, y, w, h) {
        var dy = h * Math.max(0, Math.min(1, parseFloat(mxUtils.getValue(this.style, 'size', this.size))));
        var fy = 1.4;

        c.moveTo(0, dy / 2);
        c.quadTo(w / 4, dy * fy, w / 2, dy / 2);
        c.quadTo(w * 3 / 4, dy * (1 - fy), w, dy / 2);
        c.lineTo(w, h - dy / 2);
        c.quadTo(w * 3 / 4, h - dy * fy, w / 2, h - dy / 2);
        c.quadTo(w / 4, h - dy * (1 - fy), 0, h - dy / 2);
        c.lineTo(0, dy / 2);
        c.close();
        c.end();
    };

    TapeShape.prototype.getLabelBounds = function (rect) {
        if (mxUtils.getValue(this.style, 'boundedLbl', false)) {
            var size = mxUtils.getValue(this.style, 'size', this.size);
            var w = rect.width;
            var h = rect.height;

            if (this.direction == null ||
                this.direction == mxConstants.DIRECTION_EAST ||
                this.direction == mxConstants.DIRECTION_WEST) {
                var dy = h * size;

                return new mxRectangle(rect.x, rect.y + dy, w, h - 2 * dy);
            } else {
                var dx = w * size;

                return new mxRectangle(rect.x + dx, rect.y, w - 2 * dx, h);
            }
        }

        return rect;
    };

    mxCellRenderer.registerShape('tape', TapeShape);

    // Document shape
    function DocumentShape() {
        mxActor.call(this);
    };
    mxUtils.extend(DocumentShape, mxActor);
    DocumentShape.prototype.size = 0.3;
    DocumentShape.prototype.getLabelMargins = function (rect) {
        if (mxUtils.getValue(this.style, 'boundedLbl', false)) {
            return new mxRectangle(0, 0, 0, parseFloat(mxUtils.getValue(
                this.style, 'size', this.size)) * rect.height);
        }

        return null;
    };
    DocumentShape.prototype.redrawPath = function (c, x, y, w, h) {
        var dy = h * Math.max(0, Math.min(1, parseFloat(mxUtils.getValue(this.style, 'size', this.size))));
        var fy = 1.4;

        c.moveTo(0, 0);
        c.lineTo(w, 0);
        c.lineTo(w, h - dy / 2);
        c.quadTo(w * 3 / 4, h - dy * fy, w / 2, h - dy / 2);
        c.quadTo(w / 4, h - dy * (1 - fy), 0, h - dy / 2);
        c.lineTo(0, dy / 2);
        c.close();
        c.end();
    };

    mxCellRenderer.registerShape('document', DocumentShape);

    var cylinderGetCylinderSize = mxCylinder.prototype.getCylinderSize;

    mxCylinder.prototype.getCylinderSize = function (x, y, w, h) {
        var size = mxUtils.getValue(this.style, 'size');

        if (size != null) {
            return h * Math.max(0, Math.min(1, size));
        } else {
            return cylinderGetCylinderSize.apply(this, arguments);
        }
    };

    mxCylinder.prototype.getLabelMargins = function (rect) {
        if (mxUtils.getValue(this.style, 'boundedLbl', false)) {
            var size = mxUtils.getValue(this.style, 'size', 0.15) * 2;

            return new mxRectangle(0, Math.min(this.maxHeight * this.scale, rect.height * size), 0, 0);
        }

        return null;
    };

    // Parallelogram shape
    function ParallelogramShape() {
        mxActor.call(this);
    };
    mxUtils.extend(ParallelogramShape, mxActor);
    ParallelogramShape.prototype.size = 0.2;
    ParallelogramShape.prototype.isRoundable = function () {
        return true;
    };
    ParallelogramShape.prototype.redrawPath = function (c, x, y, w, h) {
        var dx = w * Math.max(0, Math.min(1, parseFloat(mxUtils.getValue(this.style, 'size', this.size))));
        var arcSize = mxUtils.getValue(this.style, mxConstants.STYLE_ARCSIZE, mxConstants.LINE_ARCSIZE) / 2;
        this.addPoints(c, [new mxPoint(0, h), new mxPoint(dx, 0), new mxPoint(w, 0), new mxPoint(w - dx, h)],
            this.isRounded, arcSize, true);
        c.end();
    };

    mxCellRenderer.registerShape('parallelogram', ParallelogramShape);

    // Trapezoid shape
    function TrapezoidShape() {
        mxActor.call(this);
    };
    mxUtils.extend(TrapezoidShape, mxActor);
    TrapezoidShape.prototype.size = 0.2;
    TrapezoidShape.prototype.isRoundable = function () {
        return true;
    };
    TrapezoidShape.prototype.redrawPath = function (c, x, y, w, h) {
        var dx = w * Math.max(0, Math.min(0.5, parseFloat(mxUtils.getValue(this.style, 'size', this.size))));
        var arcSize = mxUtils.getValue(this.style, mxConstants.STYLE_ARCSIZE, mxConstants.LINE_ARCSIZE) / 2;
        this.addPoints(c, [new mxPoint(0, h), new mxPoint(dx, 0), new mxPoint(w - dx, 0), new mxPoint(w, h)],
            this.isRounded, arcSize, true);
    };

    mxCellRenderer.registerShape('trapezoid', TrapezoidShape);

    // Curly Bracket shape
    function CurlyBracketShape() {
        mxActor.call(this);
    };
    mxUtils.extend(CurlyBracketShape, mxActor);
    CurlyBracketShape.prototype.size = 0.5;
    CurlyBracketShape.prototype.redrawPath = function (c, x, y, w, h) {
        c.setFillColor(null);
        var s = w * Math.max(0, Math.min(1, parseFloat(mxUtils.getValue(this.style, 'size', this.size))));
        var arcSize = mxUtils.getValue(this.style, mxConstants.STYLE_ARCSIZE, mxConstants.LINE_ARCSIZE) / 2;
        this.addPoints(c, [new mxPoint(w, 0), new mxPoint(s, 0), new mxPoint(s, h / 2),
            new mxPoint(0, h / 2), new mxPoint(s, h / 2), new mxPoint(s, h),
            new mxPoint(w, h)], this.isRounded, arcSize, false);
        c.end();
    };

    mxCellRenderer.registerShape('curlyBracket', CurlyBracketShape);

    // Parallel marker shape
    function ParallelMarkerShape() {
        mxActor.call(this);
    };
    mxUtils.extend(ParallelMarkerShape, mxActor);
    ParallelMarkerShape.prototype.redrawPath = function (c, x, y, w, h) {
        c.setStrokeWidth(1);
        c.setFillColor(this.stroke);
        var w2 = w / 5;
        c.rect(0, 0, w2, h);
        c.fillAndStroke();
        c.rect(2 * w2, 0, w2, h);
        c.fillAndStroke();
        c.rect(4 * w2, 0, w2, h);
        c.fillAndStroke();
    };

    mxCellRenderer.registerShape('parallelMarker', ParallelMarkerShape);

    /**
     * Adds handJiggle style (jiggle=n sets jiggle)
     */
    function HandJiggle(canvas, defaultVariation) {
        this.canvas = canvas;

        // Avoids "spikes" in the output
        this.canvas.setLineJoin('round');
        this.canvas.setLineCap('round');

        this.defaultVariation = defaultVariation;

        this.originalLineTo = this.canvas.lineTo;
        this.canvas.lineTo = mxUtils.bind(this, HandJiggle.prototype.lineTo);

        this.originalMoveTo = this.canvas.moveTo;
        this.canvas.moveTo = mxUtils.bind(this, HandJiggle.prototype.moveTo);

        this.originalClose = this.canvas.close;
        this.canvas.close = mxUtils.bind(this, HandJiggle.prototype.close);

        this.originalQuadTo = this.canvas.quadTo;
        this.canvas.quadTo = mxUtils.bind(this, HandJiggle.prototype.quadTo);

        this.originalCurveTo = this.canvas.curveTo;
        this.canvas.curveTo = mxUtils.bind(this, HandJiggle.prototype.curveTo);

        this.originalArcTo = this.canvas.arcTo;
        this.canvas.arcTo = mxUtils.bind(this, HandJiggle.prototype.arcTo);
    };

    HandJiggle.prototype.moveTo = function (endX, endY) {
        this.originalMoveTo.apply(this.canvas, arguments);
        this.lastX = endX;
        this.lastY = endY;
        this.firstX = endX;
        this.firstY = endY;
    };

    HandJiggle.prototype.close = function () {
        if (this.firstX != null && this.firstY != null) {
            this.lineTo(this.firstX, this.firstY);
            this.originalClose.apply(this.canvas, arguments);
        }

        this.originalClose.apply(this.canvas, arguments);
    };

    HandJiggle.prototype.quadTo = function (x1, y1, x2, y2) {
        this.originalQuadTo.apply(this.canvas, arguments);
        this.lastX = x2;
        this.lastY = y2;
    };

    HandJiggle.prototype.curveTo = function (x1, y1, x2, y2, x3, y3) {
        this.originalCurveTo.apply(this.canvas, arguments);
        this.lastX = x3;
        this.lastY = y3;
    };

    HandJiggle.prototype.arcTo = function (rx, ry, angle, largeArcFlag, sweepFlag, x, y) {
        this.originalArcTo.apply(this.canvas, arguments);
        this.lastX = x;
        this.lastY = y;
    };

    HandJiggle.prototype.lineTo = function (endX, endY) {
        // LATER: Check why this.canvas.lastX cannot be used
        if (this.lastX != null && this.lastY != null) {
            var dx = Math.abs(endX - this.lastX);
            var dy = Math.abs(endY - this.lastY);
            var dist = Math.sqrt(dx * dx + dy * dy);

            if (dist < 2) {
                this.originalLineTo.apply(this.canvas, arguments);
                this.lastX = endX;
                this.lastY = endY;

                return;
            }

            var segs = Math.round(dist / 10);
            var variation = this.defaultVariation;

            if (segs < 5) {
                segs = 5;
                variation /= 3;
            }

            function sign(x) {
                return typeof x === 'number' ? x ? x < 0 ? -1 : 1 : x === x ? 0 : NaN : NaN;
            }

            var stepX = sign(endX - this.lastX) * dx / segs;
            var stepY = sign(endY - this.lastY) * dy / segs;

            var fx = dx / dist;
            var fy = dy / dist;

            for (var s = 0; s < segs; s++) {
                var x = stepX * s + this.lastX;
                var y = stepY * s + this.lastY;

                var offset = (Math.random() - 0.5) * variation;
                this.originalLineTo.call(this.canvas, x - offset * fy, y - offset * fx);
            }

            this.originalLineTo.call(this.canvas, endX, endY);
            this.lastX = endX;
            this.lastY = endY;
        } else {
            this.originalLineTo.apply(this.canvas, arguments);
            this.lastX = endX;
            this.lastY = endY;
        }
    };

    HandJiggle.prototype.destroy = function () {
        this.canvas.lineTo = this.originalLineTo;
        this.canvas.moveTo = this.originalMoveTo;
        this.canvas.close = this.originalClose;
        this.canvas.quadTo = this.originalQuadTo;
        this.canvas.curveTo = this.originalCurveTo;
        this.canvas.arcTo = this.originalArcTo;
    };

    // Installs hand jiggle in all shapes
    var mxShapePaint0 = mxShape.prototype.paint;
    mxShape.prototype.defaultJiggle = 1.5;
    mxShape.prototype.paint = function (c) {
        // NOTE: getValue does not return a boolean value so !('0') would return true here and below
        if (this.style != null && mxUtils.getValue(this.style, 'comic', '0') != '0' && c.handHiggle == null) {
            c.handJiggle = new HandJiggle(c, mxUtils.getValue(this.style, 'jiggle', this.defaultJiggle));
        }

        mxShapePaint0.apply(this, arguments);

        if (c.handJiggle) {
            if (c.handJiggle.destroy) {
                c.handJiggle.destroy();
            }
            delete c.handJiggle;
        }
    };

    // Sets default jiggle for diamond
    mxRhombus.prototype.defaultJiggle = 2;

    /**
     * Overrides to avoid call to rect
     */
    var mxRectangleShapeIsHtmlAllowed0 = mxRectangleShape.prototype.isHtmlAllowed;
    mxRectangleShape.prototype.isHtmlAllowed = function () {
        return (this.style == null || mxUtils.getValue(this.style, 'comic', '0') == '0') &&
            mxRectangleShapeIsHtmlAllowed0.apply(this, arguments);
    };

    var mxRectangleShapePaintBackground0 = mxRectangleShape.prototype.paintBackground;
    mxRectangleShape.prototype.paintBackground = function (c, x, y, w, h) {
        if (c.handJiggle == null) {
            mxRectangleShapePaintBackground0.apply(this, arguments);
        } else {
            var events = true;

            if (this.style != null) {
                events = mxUtils.getValue(this.style, mxConstants.STYLE_POINTER_EVENTS, '1') == '1';
            }

            if (events || (this.fill != null && this.fill != mxConstants.NONE) ||
                (this.stroke != null && this.stroke != mxConstants.NONE)) {
                if (!events && (this.fill == null || this.fill == mxConstants.NONE)) {
                    c.pointerEvents = false;
                }

                c.begin();

                if (this.isRounded) {
                    var r = 0;

                    if (mxUtils.getValue(this.style, mxConstants.STYLE_ABSOLUTE_ARCSIZE, 0) == '1') {
                        r = Math.min(w / 2, Math.min(h / 2, mxUtils.getValue(this.style,
                            mxConstants.STYLE_ARCSIZE, mxConstants.LINE_ARCSIZE) / 2));
                    } else {
                        var f = mxUtils.getValue(this.style, mxConstants.STYLE_ARCSIZE,
                            mxConstants.RECTANGLE_ROUNDING_FACTOR * 100) / 100;
                        r = Math.min(w * f, h * f);
                    }

                    c.moveTo(x + r, y);
                    c.lineTo(x + w - r, y);
                    c.quadTo(x + w, y, x + w, y + r);
                    c.lineTo(x + w, y + h - r);
                    c.quadTo(x + w, y + h, x + w - r, y + h);
                    c.lineTo(x + r, y + h);
                    c.quadTo(x, y + h, x, y + h - r);
                    c.lineTo(x, y + r);
                    c.quadTo(x, y, x + r, y);
                } else {

                    c.moveTo(x, y);
                    c.lineTo(x + w, y);
                    c.lineTo(x + w, y + h);
                    c.lineTo(x, y + h);
                    c.lineTo(x, y);
                }

                // LATER: Check if close is needed here
                c.close();
                c.end();

                c.fillAndStroke();
            }
        }
    };

    /**
     * Disables glass effect with hand jiggle.
     */
    var mxRectangleShapePaintForeground0 = mxRectangleShape.prototype.paintForeground;
    mxRectangleShape.prototype.paintForeground = function (c, x, y, w, h) {
        if (c.handJiggle == null) {
            mxRectangleShapePaintForeground0.apply(this, arguments);
        }
    };

    // End of hand jiggle integration

    // Process Shape
    function ProcessShape() {
        mxRectangleShape.call(this);
    };
    mxUtils.extend(ProcessShape, mxRectangleShape);
    ProcessShape.prototype.size = 0.1;
    ProcessShape.prototype.isHtmlAllowed = function () {
        return false;
    };
    ProcessShape.prototype.getLabelBounds = function (rect) {
        if (mxUtils.getValue(this.state.style, mxConstants.STYLE_HORIZONTAL, true) ==
            (this.direction == null ||
                this.direction == mxConstants.DIRECTION_EAST ||
                this.direction == mxConstants.DIRECTION_WEST)) {
            var w = rect.width;
            var h = rect.height;
            var r = new mxRectangle(rect.x, rect.y, w, h);

            var inset = w * Math.max(0, Math.min(1, parseFloat(mxUtils.getValue(this.style, 'size', this.size))));

            if (this.isRounded) {
                var f = mxUtils.getValue(this.style, mxConstants.STYLE_ARCSIZE,
                    mxConstants.RECTANGLE_ROUNDING_FACTOR * 100) / 100;
                inset = Math.max(inset, Math.min(w * f, h * f));
            }

            r.x += Math.round(inset);
            r.width -= Math.round(2 * inset);

            return r;
        }

        return rect;
    };
    ProcessShape.prototype.paintForeground = function (c, x, y, w, h) {
        var inset = w * Math.max(0, Math.min(1, parseFloat(mxUtils.getValue(this.style, 'size', this.size))));

        if (this.isRounded) {
            var f = mxUtils.getValue(this.style, mxConstants.STYLE_ARCSIZE,
                mxConstants.RECTANGLE_ROUNDING_FACTOR * 100) / 100;
            inset = Math.max(inset, Math.min(w * f, h * f));
        }

        // Crisp rendering of inner lines
        inset = Math.round(inset);

        c.begin();
        c.moveTo(x + inset, y);
        c.lineTo(x + inset, y + h);
        c.moveTo(x + w - inset, y);
        c.lineTo(x + w - inset, y + h);
        c.end();
        c.stroke();
        mxRectangleShape.prototype.paintForeground.apply(this, arguments);
    };

    mxCellRenderer.registerShape('process', ProcessShape);

    // Transparent Shape
    function TransparentShape() {
        mxRectangleShape.call(this);
    };
    mxUtils.extend(TransparentShape, mxRectangleShape);
    TransparentShape.prototype.paintBackground = function (c, x, y, w, h) {
        c.setFillColor(mxConstants.NONE);
        c.rect(x, y, w, h);
        c.fill();
    };
    TransparentShape.prototype.paintForeground = function (c, x, y, w, h) {
    };

    mxCellRenderer.registerShape('transparent', TransparentShape);

    // Callout shape
    function CalloutShape() {
        mxActor.call(this);
    };
    mxUtils.extend(CalloutShape, mxHexagon);
    CalloutShape.prototype.size = 30;
    CalloutShape.prototype.position = 0.5;
    CalloutShape.prototype.position2 = 0.5;
    CalloutShape.prototype.base = 20;
    CalloutShape.prototype.getLabelMargins = function () {
        return new mxRectangle(0, 0, 0, parseFloat(mxUtils.getValue(
            this.style, 'size', this.size)) * this.scale);
    };
    CalloutShape.prototype.isRoundable = function () {
        return true;
    };
    CalloutShape.prototype.redrawPath = function (c, x, y, w, h) {
        var arcSize = mxUtils.getValue(this.style, mxConstants.STYLE_ARCSIZE, mxConstants.LINE_ARCSIZE) / 2;
        var s = Math.max(0, Math.min(h, parseFloat(mxUtils.getValue(this.style, 'size', this.size))));
        var dx = w * Math.max(0, Math.min(1, parseFloat(mxUtils.getValue(this.style, 'position', this.position))));
        var dx2 = w * Math.max(0, Math.min(1, parseFloat(mxUtils.getValue(this.style, 'position2', this.position2))));
        var base = Math.max(0, Math.min(w, parseFloat(mxUtils.getValue(this.style, 'base', this.base))));

        this.addPoints(c, [new mxPoint(0, 0), new mxPoint(w, 0), new mxPoint(w, h - s),
                new mxPoint(Math.min(w, dx + base), h - s), new mxPoint(dx2, h),
                new mxPoint(Math.max(0, dx), h - s), new mxPoint(0, h - s)],
            this.isRounded, arcSize, true, [4]);
    };

    mxCellRenderer.registerShape('callout', CalloutShape);

    // Step shape
    function StepShape() {
        mxActor.call(this);
    };
    mxUtils.extend(StepShape, mxActor);
    StepShape.prototype.size = 0.2;
    StepShape.prototype.fixedSize = 20;
    StepShape.prototype.isRoundable = function () {
        return true;
    };
    StepShape.prototype.redrawPath = function (c, x, y, w, h) {
        var fixed = mxUtils.getValue(this.style, 'fixedSize', '0') != '0';
        var s = (fixed) ? Math.max(0, Math.min(w, parseFloat(mxUtils.getValue(this.style, 'size', this.fixedSize)))) :
            w * Math.max(0, Math.min(1, parseFloat(mxUtils.getValue(this.style, 'size', this.size))));
        var arcSize = mxUtils.getValue(this.style, mxConstants.STYLE_ARCSIZE, mxConstants.LINE_ARCSIZE) / 2;
        this.addPoints(c, [new mxPoint(0, 0), new mxPoint(w - s, 0), new mxPoint(w, h / 2), new mxPoint(w - s, h),
            new mxPoint(0, h), new mxPoint(s, h / 2)], this.isRounded, arcSize, true);
        c.end();
    };

    mxCellRenderer.registerShape('step', StepShape);

    // Hexagon shape
    function HexagonShape() {
        mxActor.call(this);
    };
    mxUtils.extend(HexagonShape, mxHexagon);
    HexagonShape.prototype.size = 0.25;
    HexagonShape.prototype.isRoundable = function () {
        return true;
    };
    HexagonShape.prototype.redrawPath = function (c, x, y, w, h) {
        var s = w * Math.max(0, Math.min(1, parseFloat(mxUtils.getValue(this.style, 'size', this.size))));
        var arcSize = mxUtils.getValue(this.style, mxConstants.STYLE_ARCSIZE, mxConstants.LINE_ARCSIZE) / 2;
        this.addPoints(c, [new mxPoint(s, 0), new mxPoint(w - s, 0), new mxPoint(w, 0.5 * h), new mxPoint(w - s, h),
            new mxPoint(s, h), new mxPoint(0, 0.5 * h)], this.isRounded, arcSize, true);
    };

    mxCellRenderer.registerShape('hexagon', HexagonShape);

    // Plus Shape
    function PlusShape() {
        mxRectangleShape.call(this);
    };
    mxUtils.extend(PlusShape, mxRectangleShape);
    PlusShape.prototype.isHtmlAllowed = function () {
        return false;
    };
    PlusShape.prototype.paintForeground = function (c, x, y, w, h) {
        var border = Math.min(w / 5, h / 5) + 1;

        c.begin();
        c.moveTo(x + w / 2, y + border);
        c.lineTo(x + w / 2, y + h - border);
        c.moveTo(x + border, y + h / 2);
        c.lineTo(x + w - border, y + h / 2);
        c.end();
        c.stroke();
        mxRectangleShape.prototype.paintForeground.apply(this, arguments);
    };

    mxCellRenderer.registerShape('plus', PlusShape);

    // Overrides painting of rhombus shape to allow for double style
    var mxRhombusPaintVertexShape = mxRhombus.prototype.paintVertexShape;
    mxRhombus.prototype.getLabelBounds = function (rect) {
        if (this.style['double'] == 1) {
            var margin = (Math.max(2, this.strokewidth + 1) * 2 + parseFloat(
                this.style[mxConstants.STYLE_MARGIN] || 0)) * this.scale;

            return new mxRectangle(rect.x + margin, rect.y + margin,
                rect.width - 2 * margin, rect.height - 2 * margin);
        }

        return rect;
    };
    mxRhombus.prototype.paintVertexShape = function (c, x, y, w, h) {
        mxRhombusPaintVertexShape.apply(this, arguments);

        if (!this.outline && this.style['double'] == 1) {
            var margin = Math.max(2, this.strokewidth + 1) * 2 +
                parseFloat(this.style[mxConstants.STYLE_MARGIN] || 0);
            x += margin;
            y += margin;
            w -= 2 * margin;
            h -= 2 * margin;

            if (w > 0 && h > 0) {
                c.setShadow(false);

                // Workaround for closure compiler bug where the lines with x and y above
                // are removed if arguments is used as second argument in call below.
                mxRhombusPaintVertexShape.apply(this, [c, x, y, w, h]);
            }
        }
    };

    // CompositeShape
    function ExtendedShape() {
        mxRectangleShape.call(this);
    };
    mxUtils.extend(ExtendedShape, mxRectangleShape);
    ExtendedShape.prototype.isHtmlAllowed = function () {
        return false;
    };
    ExtendedShape.prototype.getLabelBounds = function (rect) {
        if (this.style['double'] == 1) {
            var margin = (Math.max(2, this.strokewidth + 1) + parseFloat(
                this.style[mxConstants.STYLE_MARGIN] || 0)) * this.scale;

            return new mxRectangle(rect.x + margin, rect.y + margin,
                rect.width - 2 * margin, rect.height - 2 * margin);
        }

        return rect;
    };

    ExtendedShape.prototype.paintForeground = function (c, x, y, w, h) {
        if (this.style != null) {
            if (!this.outline && this.style['double'] == 1) {
                var margin = Math.max(2, this.strokewidth + 1) + parseFloat(this.style[mxConstants.STYLE_MARGIN] || 0);
                x += margin;
                y += margin;
                w -= 2 * margin;
                h -= 2 * margin;

                if (w > 0 && h > 0) {
                    mxRectangleShape.prototype.paintBackground.apply(this, arguments);
                }
            }

            c.setDashed(false);

            // Draws the symbols defined in the style. The symbols are
            // numbered from 1...n. Possible postfixes are align,
            // verticalAlign, spacing, arcSpacing, width, height
            var counter = 0;
            var shape = null;

            do {
                shape = mxCellRenderer.defaultShapes[this.style['symbol' + counter]];

                if (shape != null) {
                    var align = this.style['symbol' + counter + 'Align'];
                    var valign = this.style['symbol' + counter + 'VerticalAlign'];
                    var width = this.style['symbol' + counter + 'Width'];
                    var height = this.style['symbol' + counter + 'Height'];
                    var spacing = this.style['symbol' + counter + 'Spacing'] || 0;
                    var vspacing = this.style['symbol' + counter + 'VSpacing'] || spacing;
                    var arcspacing = this.style['symbol' + counter + 'ArcSpacing'];

                    if (arcspacing != null) {
                        var arcSize = this.getArcSize(w + this.strokewidth, h + this.strokewidth) * arcspacing;
                        spacing += arcSize;
                        vspacing += arcSize;
                    }

                    var x2 = x;
                    var y2 = y;

                    if (align == mxConstants.ALIGN_CENTER) {
                        x2 += (w - width) / 2;
                    } else if (align == mxConstants.ALIGN_RIGHT) {
                        x2 += w - width - spacing;
                    } else {
                        x2 += spacing;
                    }

                    if (valign == mxConstants.ALIGN_MIDDLE) {
                        y2 += (h - height) / 2;
                    } else if (valign == mxConstants.ALIGN_BOTTOM) {
                        y2 += h - height - vspacing;
                    } else {
                        y2 += vspacing;
                    }

                    c.save();

                    // Small hack to pass style along into subshape
                    var tmp = new shape();
                    // TODO: Clone style and override settings (eg. strokewidth)
                    tmp.style = this.style;
                    shape.prototype.paintVertexShape.call(tmp, c, x2, y2, width, height);
                    c.restore();
                }

                counter++;
            }
            while (shape != null);
        }

        // Paints glass effect
        mxRectangleShape.prototype.paintForeground.apply(this, arguments);
    };

    mxCellRenderer.registerShape('ext', ExtendedShape);

    // Tape Shape, supports size style
    function MessageShape() {
        mxCylinder.call(this);
    };
    mxUtils.extend(MessageShape, mxCylinder);
    MessageShape.prototype.redrawPath = function (path, x, y, w, h, isForeground) {
        if (isForeground) {
            path.moveTo(0, 0);
            path.lineTo(w / 2, h / 2);
            path.lineTo(w, 0);
            path.end();
        } else {
            path.moveTo(0, 0);
            path.lineTo(w, 0);
            path.lineTo(w, h);
            path.lineTo(0, h);
            path.close();
        }
    };

    mxCellRenderer.registerShape('message', MessageShape);

    // UML Actor Shape
    function UmlActorShape() {
        mxShape.call(this);
    };
    mxUtils.extend(UmlActorShape, mxShape);
    UmlActorShape.prototype.paintBackground = function (c, x, y, w, h) {
        c.translate(x, y);

        // Head
        c.ellipse(w / 4, 0, w / 2, h / 4);
        c.fillAndStroke();

        c.begin();
        c.moveTo(w / 2, h / 4);
        c.lineTo(w / 2, 2 * h / 3);

        // Arms
        c.moveTo(w / 2, h / 3);
        c.lineTo(0, h / 3);
        c.moveTo(w / 2, h / 3);
        c.lineTo(w, h / 3);

        // Legs
        c.moveTo(w / 2, 2 * h / 3);
        c.lineTo(0, h);
        c.moveTo(w / 2, 2 * h / 3);
        c.lineTo(w, h);
        c.end();

        c.stroke();
    };

    // Replaces existing actor shape
    mxCellRenderer.registerShape('umlActor', UmlActorShape);

    // UML Boundary Shape
    function UmlBoundaryShape() {
        mxShape.call(this);
    };
    mxUtils.extend(UmlBoundaryShape, mxShape);
    UmlBoundaryShape.prototype.getLabelMargins = function (rect) {
        return new mxRectangle(rect.width / 6, 0, 0, 0);
    };
    UmlBoundaryShape.prototype.paintBackground = function (c, x, y, w, h) {
        c.translate(x, y);

        // Base line
        c.begin();
        c.moveTo(0, h / 4);
        c.lineTo(0, h * 3 / 4);
        c.end();
        c.stroke();

        // Horizontal line
        c.begin();
        c.moveTo(0, h / 2);
        c.lineTo(w / 6, h / 2);
        c.end();
        c.stroke();

        // Circle
        c.ellipse(w / 6, 0, w * 5 / 6, h);
        c.fillAndStroke();
    };

    // Replaces existing actor shape
    mxCellRenderer.registerShape('umlBoundary', UmlBoundaryShape);

    // UML Entity Shape
    function UmlEntityShape() {
        mxEllipse.call(this);
    };
    mxUtils.extend(UmlEntityShape, mxEllipse);
    UmlEntityShape.prototype.paintVertexShape = function (c, x, y, w, h) {
        mxEllipse.prototype.paintVertexShape.apply(this, arguments);

        c.begin();
        c.moveTo(x + w / 8, y + h);
        c.lineTo(x + w * 7 / 8, y + h);
        c.end();
        c.stroke();
    };

    mxCellRenderer.registerShape('umlEntity', UmlEntityShape);

    // UML Destroy Shape
    function UmlDestroyShape() {
        mxShape.call(this);
    };
    mxUtils.extend(UmlDestroyShape, mxShape);
    UmlDestroyShape.prototype.paintVertexShape = function (c, x, y, w, h) {
        c.translate(x, y);

        c.begin();
        c.moveTo(w, 0);
        c.lineTo(0, h);
        c.moveTo(0, 0);
        c.lineTo(w, h);
        c.end();
        c.stroke();
    };

    mxCellRenderer.registerShape('umlDestroy', UmlDestroyShape);

    // UML Control Shape
    function UmlControlShape() {
        mxShape.call(this);
    };
    mxUtils.extend(UmlControlShape, mxShape);
    UmlControlShape.prototype.getLabelBounds = function (rect) {
        return new mxRectangle(rect.x, rect.y + rect.height / 8, rect.width, rect.height * 7 / 8);
    };
    UmlControlShape.prototype.paintBackground = function (c, x, y, w, h) {
        c.translate(x, y);

        // Upper line
        c.begin();
        c.moveTo(w * 3 / 8, h / 8 * 1.1);
        c.lineTo(w * 5 / 8, 0);
        c.end();
        c.stroke();

        // Circle
        c.ellipse(0, h / 8, w, h * 7 / 8);
        c.fillAndStroke();
    };
    UmlControlShape.prototype.paintForeground = function (c, x, y, w, h) {
        // Lower line
        c.begin();
        c.moveTo(w * 3 / 8, h / 8 * 1.1);
        c.lineTo(w * 5 / 8, h / 4);
        c.end();
        c.stroke();
    };

    // Replaces existing actor shape
    mxCellRenderer.registerShape('umlControl', UmlControlShape);

    // UML Lifeline Shape
    function UmlLifeline() {
        mxRectangleShape.call(this);
    };
    mxUtils.extend(UmlLifeline, mxRectangleShape);
    UmlLifeline.prototype.size = 40;
    UmlLifeline.prototype.isHtmlAllowed = function () {
        return false;
    };
    UmlLifeline.prototype.getLabelBounds = function (rect) {
        var size = Math.max(0, Math.min(rect.height, parseFloat(
            mxUtils.getValue(this.style, 'size', this.size)) * this.scale));

        return new mxRectangle(rect.x, rect.y, rect.width, size);
    };
    UmlLifeline.prototype.paintBackground = function (c, x, y, w, h) {
        var size = Math.max(0, Math.min(h, parseFloat(mxUtils.getValue(this.style, 'size', this.size))));
        var participant = mxUtils.getValue(this.style, 'participant');

        if (participant == null || this.state == null) {
            mxRectangleShape.prototype.paintBackground.call(this, c, x, y, w, size);
        } else {
            var ctor = this.state.view.graph.cellRenderer.getShape(participant);

            if (ctor != null && ctor != UmlLifeline) {
                var shape = new ctor();
                shape.apply(this.state);
                c.save();
                shape.paintVertexShape(c, x, y, w, size);
                c.restore();
            }
        }

        if (size < h) {
            c.setDashed(true);
            c.begin();
            c.moveTo(x + w / 2, y + size);
            c.lineTo(x + w / 2, y + h);
            c.end();
            c.stroke();
        }
    };
    UmlLifeline.prototype.paintForeground = function (c, x, y, w, h) {
        var size = Math.max(0, Math.min(h, parseFloat(mxUtils.getValue(this.style, 'size', this.size))));
        mxRectangleShape.prototype.paintForeground.call(this, c, x, y, w, Math.min(h, size));
    };

    mxCellRenderer.registerShape('umlLifeline', UmlLifeline);

    // UML Frame Shape
    function UmlFrame() {
        mxShape.call(this);
    };
    mxUtils.extend(UmlFrame, mxShape);
    UmlFrame.prototype.width = 60;
    UmlFrame.prototype.height = 30;
    UmlFrame.prototype.corner = 10;
    UmlFrame.prototype.getLabelMargins = function (rect) {
        return new mxRectangle(0, 0,
            rect.width - (parseFloat(mxUtils.getValue(this.style, 'width', this.width) * this.scale)),
            rect.height - (parseFloat(mxUtils.getValue(this.style, 'height', this.height) * this.scale)));
    };
    UmlFrame.prototype.paintBackground = function (c, x, y, w, h) {
        var co = this.corner;
        var w0 = Math.min(w, Math.max(co, parseFloat(mxUtils.getValue(this.style, 'width', this.width))));
        var h0 = Math.min(h, Math.max(co * 1.5, parseFloat(mxUtils.getValue(this.style, 'height', this.height))));
        var bg = mxUtils.getValue(this.style, mxConstants.STYLE_SWIMLANE_FILLCOLOR, mxConstants.NONE);

        if (bg != mxConstants.NONE) {
            c.setFillColor(bg);
            c.rect(x, y, w, h);
            c.fill();
        }

        if (this.fill != null && this.fill != mxConstants.NONE && this.gradient && this.gradient != mxConstants.NONE) {
            var b = this.getGradientBounds(c, x, y, w, h);
            c.setGradient(this.fill, this.gradient, x, y, w, h, this.gradientDirection);
        } else {
            c.setFillColor(this.fill);
        }

        c.begin();
        c.moveTo(x, y);
        c.lineTo(x + w0, y);
        c.lineTo(x + w0, y + Math.max(0, h0 - co * 1.5));
        c.lineTo(x + Math.max(0, w0 - co), y + h0);
        c.lineTo(x, y + h0);
        c.close();
        c.fillAndStroke();

        c.begin();
        c.moveTo(x + w0, y);
        c.lineTo(x + w, y);
        c.lineTo(x + w, y + h);
        c.lineTo(x, y + h);
        c.lineTo(x, y + h0);
        c.stroke();
    };

    mxCellRenderer.registerShape('umlFrame', UmlFrame);

    mxPerimeter.LifelinePerimeter = function (bounds, vertex, next, orthogonal) {
        var size = UmlLifeline.prototype.size;

        if (vertex != null) {
            size = mxUtils.getValue(vertex.style, 'size', size) * vertex.view.scale;
        }

        var sw = (parseFloat(vertex.style[mxConstants.STYLE_STROKEWIDTH] || 1) * vertex.view.scale / 2) - 1;

        if (next.x < bounds.getCenterX()) {
            sw += 1;
            sw *= -1;
        }

        return new mxPoint(bounds.getCenterX() + sw, Math.min(bounds.y + bounds.height,
            Math.max(bounds.y + size, next.y)));
    };

    mxStyleRegistry.putValue('lifelinePerimeter', mxPerimeter.LifelinePerimeter);

    mxPerimeter.OrthogonalPerimeter = function (bounds, vertex, next, orthogonal) {
        orthogonal = true;

        return mxPerimeter.RectanglePerimeter.apply(this, arguments);
    };

    mxStyleRegistry.putValue('orthogonalPerimeter', mxPerimeter.OrthogonalPerimeter);

    mxPerimeter.BackbonePerimeter = function (bounds, vertex, next, orthogonal) {
        var sw = (parseFloat(vertex.style[mxConstants.STYLE_STROKEWIDTH] || 1) * vertex.view.scale / 2) - 1;

        if (vertex.style['backboneSize'] != null) {
            sw += (parseFloat(vertex.style['backboneSize']) * vertex.view.scale / 2) - 1;
        }

        if (vertex.style[mxConstants.STYLE_DIRECTION] == 'south' ||
            vertex.style[mxConstants.STYLE_DIRECTION] == 'north') {
            if (next.x < bounds.getCenterX()) {
                sw += 1;
                sw *= -1;
            }

            return new mxPoint(bounds.getCenterX() + sw, Math.min(bounds.y + bounds.height,
                Math.max(bounds.y, next.y)));
        } else {
            if (next.y < bounds.getCenterY()) {
                sw += 1;
                sw *= -1;
            }

            return new mxPoint(Math.min(bounds.x + bounds.width, Math.max(bounds.x, next.x)),
                bounds.getCenterY() + sw);
        }
    };

    mxStyleRegistry.putValue('backbonePerimeter', mxPerimeter.BackbonePerimeter);

    // Callout Perimeter
    mxPerimeter.CalloutPerimeter = function (bounds, vertex, next, orthogonal) {
        return mxPerimeter.RectanglePerimeter(mxUtils.getDirectedBounds(bounds, new mxRectangle(0, 0, 0,
            Math.max(0, Math.min(bounds.height, parseFloat(mxUtils.getValue(vertex.style, 'size',
                CalloutShape.prototype.size)) * vertex.view.scale))),
            vertex.style), vertex, next, orthogonal);
    };

    mxStyleRegistry.putValue('calloutPerimeter', mxPerimeter.CalloutPerimeter);

    // Parallelogram Perimeter
    mxPerimeter.ParallelogramPerimeter = function (bounds, vertex, next, orthogonal) {
        var size = ParallelogramShape.prototype.size;

        if (vertex != null) {
            size = mxUtils.getValue(vertex.style, 'size', size);
        }

        var x = bounds.x;
        var y = bounds.y;
        var w = bounds.width;
        var h = bounds.height;

        var direction = (vertex != null) ? mxUtils.getValue(
            vertex.style, mxConstants.STYLE_DIRECTION,
            mxConstants.DIRECTION_EAST) : mxConstants.DIRECTION_EAST;
        var vertical = direction == mxConstants.DIRECTION_NORTH ||
            direction == mxConstants.DIRECTION_SOUTH;
        var points;

        if (vertical) {
            var dy = h * Math.max(0, Math.min(1, size));
            points = [new mxPoint(x, y), new mxPoint(x + w, y + dy),
                new mxPoint(x + w, y + h), new mxPoint(x, y + h - dy), new mxPoint(x, y)];
        } else {
            var dx = w * Math.max(0, Math.min(1, size));
            points = [new mxPoint(x + dx, y), new mxPoint(x + w, y),
                new mxPoint(x + w - dx, y + h), new mxPoint(x, y + h), new mxPoint(x + dx, y)];
        }

        var cx = bounds.getCenterX();
        var cy = bounds.getCenterY();

        var p1 = new mxPoint(cx, cy);

        if (orthogonal) {
            if (next.x < x || next.x > x + w) {
                p1.y = next.y;
            } else {
                p1.x = next.x;
            }
        }

        return mxUtils.getPerimeterPoint(points, p1, next);
    };

    mxStyleRegistry.putValue('parallelogramPerimeter', mxPerimeter.ParallelogramPerimeter);

    // Trapezoid Perimeter
    mxPerimeter.TrapezoidPerimeter = function (bounds, vertex, next, orthogonal) {
        var size = TrapezoidShape.prototype.size;

        if (vertex != null) {
            size = mxUtils.getValue(vertex.style, 'size', size);
        }

        var x = bounds.x;
        var y = bounds.y;
        var w = bounds.width;
        var h = bounds.height;

        var direction = (vertex != null) ? mxUtils.getValue(
            vertex.style, mxConstants.STYLE_DIRECTION,
            mxConstants.DIRECTION_EAST) : mxConstants.DIRECTION_EAST;
        var points;

        if (direction == mxConstants.DIRECTION_EAST) {
            var dx = w * Math.max(0, Math.min(1, size));
            points = [new mxPoint(x + dx, y), new mxPoint(x + w - dx, y),
                new mxPoint(x + w, y + h), new mxPoint(x, y + h), new mxPoint(x + dx, y)];
        } else if (direction == mxConstants.DIRECTION_WEST) {
            var dx = w * Math.max(0, Math.min(1, size));
            points = [new mxPoint(x, y), new mxPoint(x + w, y),
                new mxPoint(x + w - dx, y + h), new mxPoint(x + dx, y + h), new mxPoint(x, y)];
        } else if (direction == mxConstants.DIRECTION_NORTH) {
            var dy = h * Math.max(0, Math.min(1, size));
            points = [new mxPoint(x, y + dy), new mxPoint(x + w, y),
                new mxPoint(x + w, y + h), new mxPoint(x, y + h - dy), new mxPoint(x, y + dy)];
        } else {
            var dy = h * Math.max(0, Math.min(1, size));
            points = [new mxPoint(x, y), new mxPoint(x + w, y + dy),
                new mxPoint(x + w, y + h - dy), new mxPoint(x, y + h), new mxPoint(x, y)];
        }

        var cx = bounds.getCenterX();
        var cy = bounds.getCenterY();

        var p1 = new mxPoint(cx, cy);

        if (orthogonal) {
            if (next.x < x || next.x > x + w) {
                p1.y = next.y;
            } else {
                p1.x = next.x;
            }
        }

        return mxUtils.getPerimeterPoint(points, p1, next);
    };

    mxStyleRegistry.putValue('trapezoidPerimeter', mxPerimeter.TrapezoidPerimeter);

    // Step Perimeter
    mxPerimeter.StepPerimeter = function (bounds, vertex, next, orthogonal) {
        var fixed = mxUtils.getValue(vertex.style, 'fixedSize', '0') != '0';
        var size = (fixed) ? StepShape.prototype.fixedSize : StepShape.prototype.size;

        if (vertex != null) {
            size = mxUtils.getValue(vertex.style, 'size', size);
        }

        var x = bounds.x;
        var y = bounds.y;
        var w = bounds.width;
        var h = bounds.height;

        var cx = bounds.getCenterX();
        var cy = bounds.getCenterY();

        var direction = (vertex != null) ? mxUtils.getValue(
            vertex.style, mxConstants.STYLE_DIRECTION,
            mxConstants.DIRECTION_EAST) : mxConstants.DIRECTION_EAST;
        var points;

        if (direction == mxConstants.DIRECTION_EAST) {
            var dx = (fixed) ? Math.max(0, Math.min(w, size)) : w * Math.max(0, Math.min(1, size));
            points = [new mxPoint(x, y), new mxPoint(x + w - dx, y), new mxPoint(x + w, cy),
                new mxPoint(x + w - dx, y + h), new mxPoint(x, y + h),
                new mxPoint(x + dx, cy), new mxPoint(x, y)];
        } else if (direction == mxConstants.DIRECTION_WEST) {
            var dx = (fixed) ? Math.max(0, Math.min(w, size)) : w * Math.max(0, Math.min(1, size));
            points = [new mxPoint(x + dx, y), new mxPoint(x + w, y), new mxPoint(x + w - dx, cy),
                new mxPoint(x + w, y + h), new mxPoint(x + dx, y + h),
                new mxPoint(x, cy), new mxPoint(x + dx, y)];
        } else if (direction == mxConstants.DIRECTION_NORTH) {
            var dy = (fixed) ? Math.max(0, Math.min(h, size)) : h * Math.max(0, Math.min(1, size));
            points = [new mxPoint(x, y + dy), new mxPoint(cx, y), new mxPoint(x + w, y + dy),
                new mxPoint(x + w, y + h), new mxPoint(cx, y + h - dy),
                new mxPoint(x, y + h), new mxPoint(x, y + dy)];
        } else {
            var dy = (fixed) ? Math.max(0, Math.min(h, size)) : h * Math.max(0, Math.min(1, size));
            points = [new mxPoint(x, y), new mxPoint(cx, y + dy), new mxPoint(x + w, y),
                new mxPoint(x + w, y + h - dy), new mxPoint(cx, y + h),
                new mxPoint(x, y + h - dy), new mxPoint(x, y)];
        }

        var p1 = new mxPoint(cx, cy);

        if (orthogonal) {
            if (next.x < x || next.x > x + w) {
                p1.y = next.y;
            } else {
                p1.x = next.x;
            }
        }

        return mxUtils.getPerimeterPoint(points, p1, next);
    };

    mxStyleRegistry.putValue('stepPerimeter', mxPerimeter.StepPerimeter);

    // Hexagon Perimeter 2 (keep existing one)
    mxPerimeter.HexagonPerimeter2 = function (bounds, vertex, next, orthogonal) {
        var size = HexagonShape.prototype.size;

        if (vertex != null) {
            size = mxUtils.getValue(vertex.style, 'size', size);
        }

        var x = bounds.x;
        var y = bounds.y;
        var w = bounds.width;
        var h = bounds.height;

        var cx = bounds.getCenterX();
        var cy = bounds.getCenterY();

        var direction = (vertex != null) ? mxUtils.getValue(
            vertex.style, mxConstants.STYLE_DIRECTION,
            mxConstants.DIRECTION_EAST) : mxConstants.DIRECTION_EAST;
        var vertical = direction == mxConstants.DIRECTION_NORTH ||
            direction == mxConstants.DIRECTION_SOUTH;
        var points;

        if (vertical) {
            var dy = h * Math.max(0, Math.min(1, size));
            points = [new mxPoint(cx, y), new mxPoint(x + w, y + dy), new mxPoint(x + w, y + h - dy),
                new mxPoint(cx, y + h), new mxPoint(x, y + h - dy),
                new mxPoint(x, y + dy), new mxPoint(cx, y)];
        } else {
            var dx = w * Math.max(0, Math.min(1, size));
            points = [new mxPoint(x + dx, y), new mxPoint(x + w - dx, y), new mxPoint(x + w, cy),
                new mxPoint(x + w - dx, y + h), new mxPoint(x + dx, y + h),
                new mxPoint(x, cy), new mxPoint(x + dx, y)];
        }

        var p1 = new mxPoint(cx, cy);

        if (orthogonal) {
            if (next.x < x || next.x > x + w) {
                p1.y = next.y;
            } else {
                p1.x = next.x;
            }
        }

        return mxUtils.getPerimeterPoint(points, p1, next);
    };

    mxStyleRegistry.putValue('hexagonPerimeter2', mxPerimeter.HexagonPerimeter2);

    // Provided Interface Shape (aka Lollipop)
    function LollipopShape() {
        mxShape.call(this);
    };
    mxUtils.extend(LollipopShape, mxShape);
    LollipopShape.prototype.size = 10;
    LollipopShape.prototype.paintBackground = function (c, x, y, w, h) {
        var sz = parseFloat(mxUtils.getValue(this.style, 'size', this.size));
        c.translate(x, y);

        c.ellipse((w - sz) / 2, 0, sz, sz);
        c.fillAndStroke();

        c.begin();
        c.moveTo(w / 2, sz);
        c.lineTo(w / 2, h);
        c.end();
        c.stroke();
    };

    mxCellRenderer.registerShape('lollipop', LollipopShape);

    // Required Interface Shape
    function RequiresShape() {
        mxShape.call(this);
    };
    mxUtils.extend(RequiresShape, mxShape);
    RequiresShape.prototype.size = 10;
    RequiresShape.prototype.inset = 2;
    RequiresShape.prototype.paintBackground = function (c, x, y, w, h) {
        var sz = parseFloat(mxUtils.getValue(this.style, 'size', this.size));
        var inset = parseFloat(mxUtils.getValue(this.style, 'inset', this.inset)) + this.strokewidth;
        c.translate(x, y);

        c.begin();
        c.moveTo(w / 2, sz + inset);
        c.lineTo(w / 2, h);
        c.end();
        c.stroke();

        c.begin();
        c.moveTo((w - sz) / 2 - inset, sz / 2);
        c.quadTo((w - sz) / 2 - inset, sz + inset, w / 2, sz + inset);
        c.quadTo((w + sz) / 2 + inset, sz + inset, (w + sz) / 2 + inset, sz / 2);
        c.end();
        c.stroke();
    };

    mxCellRenderer.registerShape('requires', RequiresShape);

    // Required Interface Shape
    function RequiredInterfaceShape() {
        mxShape.call(this);
    };
    mxUtils.extend(RequiredInterfaceShape, mxShape);

    RequiredInterfaceShape.prototype.paintBackground = function (c, x, y, w, h) {
        c.translate(x, y);

        c.begin();
        c.moveTo(0, 0);
        c.quadTo(w, 0, w, h / 2);
        c.quadTo(w, h, 0, h);
        c.end();
        c.stroke();
    };

    mxCellRenderer.registerShape('requiredInterface', RequiredInterfaceShape);

    // Provided and Required Interface Shape
    function ProvidedRequiredInterfaceShape() {
        mxShape.call(this);
    };
    mxUtils.extend(ProvidedRequiredInterfaceShape, mxShape);
    ProvidedRequiredInterfaceShape.prototype.inset = 2;
    ProvidedRequiredInterfaceShape.prototype.paintBackground = function (c, x, y, w, h) {
        var inset = parseFloat(mxUtils.getValue(this.style, 'inset', this.inset)) + this.strokewidth;
        c.translate(x, y);

        c.ellipse(0, inset, w - 2 * inset, h - 2 * inset);
        c.fillAndStroke();

        c.begin();
        c.moveTo(w / 2, 0);
        c.quadTo(w, 0, w, h / 2);
        c.quadTo(w, h, w / 2, h);
        c.end();
        c.stroke();
    };

    mxCellRenderer.registerShape('providedRequiredInterface', ProvidedRequiredInterfaceShape);

    // Component shape
    function ComponentShape() {
        mxCylinder.call(this);
    };
    mxUtils.extend(ComponentShape, mxCylinder);
    ComponentShape.prototype.jettyWidth = 32;
    ComponentShape.prototype.jettyHeight = 12;
    ComponentShape.prototype.redrawPath = function (path, x, y, w, h, isForeground) {
        var dx = parseFloat(mxUtils.getValue(this.style, 'jettyWidth', this.jettyWidth));
        var dy = parseFloat(mxUtils.getValue(this.style, 'jettyHeight', this.jettyHeight));
        var x0 = dx / 2;
        var x1 = x0 + dx / 2;
        var y0 = 0.3 * h - dy / 2;
        var y1 = 0.7 * h - dy / 2;

        if (isForeground) {
            path.moveTo(x0, y0);
            path.lineTo(x1, y0);
            path.lineTo(x1, y0 + dy);
            path.lineTo(x0, y0 + dy);
            path.moveTo(x0, y1);
            path.lineTo(x1, y1);
            path.lineTo(x1, y1 + dy);
            path.lineTo(x0, y1 + dy);
            path.end();
        } else {
            path.moveTo(x0, 0);
            path.lineTo(w, 0);
            path.lineTo(w, h);
            path.lineTo(x0, h);
            path.lineTo(x0, y1 + dy);
            path.lineTo(0, y1 + dy);
            path.lineTo(0, y1);
            path.lineTo(x0, y1);
            path.lineTo(x0, y0 + dy);
            path.lineTo(0, y0 + dy);
            path.lineTo(0, y0);
            path.lineTo(x0, y0);
            path.close();
            path.end();
        }
    };

    mxCellRenderer.registerShape('component', ComponentShape);

    // State Shapes derives from double ellipse
    function StateShape() {
        mxDoubleEllipse.call(this);
    };
    mxUtils.extend(StateShape, mxDoubleEllipse);
    StateShape.prototype.outerStroke = true;
    StateShape.prototype.paintVertexShape = function (c, x, y, w, h) {
        var inset = Math.min(4, Math.min(w / 5, h / 5));

        if (w > 0 && h > 0) {
            c.ellipse(x + inset, y + inset, w - 2 * inset, h - 2 * inset);
            c.fillAndStroke();
        }

        c.setShadow(false);

        if (this.outerStroke) {
            c.ellipse(x, y, w, h);
            c.stroke();
        }
    };

    mxCellRenderer.registerShape('endState', StateShape);

    function StartStateShape() {
        StateShape.call(this);
    };
    mxUtils.extend(StartStateShape, StateShape);
    StartStateShape.prototype.outerStroke = false;

    mxCellRenderer.registerShape('startState', StartStateShape);

    // Link shape
    function LinkShape() {
        mxArrowConnector.call(this);
        this.spacing = 0;
    };
    mxUtils.extend(LinkShape, mxArrowConnector);
    LinkShape.prototype.defaultWidth = 4;

    LinkShape.prototype.isOpenEnded = function () {
        return true;
    };

    LinkShape.prototype.getEdgeWidth = function () {
        return mxUtils.getNumber(this.style, 'width', this.defaultWidth) + Math.max(0, this.strokewidth - 1);
    };

    LinkShape.prototype.isArrowRounded = function () {
        return this.isRounded;
    };

    // Registers the link shape
    mxCellRenderer.registerShape('link', LinkShape);

    // Generic arrow
    function FlexArrowShape() {
        mxArrowConnector.call(this);
        this.spacing = 0;
    };
    mxUtils.extend(FlexArrowShape, mxArrowConnector);
    FlexArrowShape.prototype.defaultWidth = 10;
    FlexArrowShape.prototype.defaultArrowWidth = 20;

    FlexArrowShape.prototype.getStartArrowWidth = function () {
        return this.getEdgeWidth() + mxUtils.getNumber(this.style, 'startWidth', this.defaultArrowWidth);
    };

    FlexArrowShape.prototype.getEndArrowWidth = function () {
        return this.getEdgeWidth() + mxUtils.getNumber(this.style, 'endWidth', this.defaultArrowWidth);
        ;
    };

    FlexArrowShape.prototype.getEdgeWidth = function () {
        return mxUtils.getNumber(this.style, 'width', this.defaultWidth) + Math.max(0, this.strokewidth - 1);
    };

    // Registers the link shape
    mxCellRenderer.registerShape('flexArrow', FlexArrowShape);

    // Manual Input shape
    function ManualInputShape() {
        mxActor.call(this);
    };
    mxUtils.extend(ManualInputShape, mxActor);
    ManualInputShape.prototype.size = 30;
    ManualInputShape.prototype.isRoundable = function () {
        return true;
    };
    ManualInputShape.prototype.redrawPath = function (c, x, y, w, h) {
        var s = Math.min(h, parseFloat(mxUtils.getValue(this.style, 'size', this.size)));
        var arcSize = mxUtils.getValue(this.style, mxConstants.STYLE_ARCSIZE, mxConstants.LINE_ARCSIZE) / 2;
        this.addPoints(c, [new mxPoint(0, h), new mxPoint(0, s), new mxPoint(w, 0), new mxPoint(w, h)],
            this.isRounded, arcSize, true);
        c.end();
    };

    mxCellRenderer.registerShape('manualInput', ManualInputShape);

    // Internal storage
    function InternalStorageShape() {
        mxRectangleShape.call(this);
    };
    mxUtils.extend(InternalStorageShape, mxRectangleShape);
    InternalStorageShape.prototype.dx = 20;
    InternalStorageShape.prototype.dy = 20;
    InternalStorageShape.prototype.isHtmlAllowed = function () {
        return false;
    };
    InternalStorageShape.prototype.paintForeground = function (c, x, y, w, h) {
        mxRectangleShape.prototype.paintForeground.apply(this, arguments);
        var inset = 0;

        if (this.isRounded) {
            var f = mxUtils.getValue(this.style, mxConstants.STYLE_ARCSIZE,
                mxConstants.RECTANGLE_ROUNDING_FACTOR * 100) / 100;
            inset = Math.max(inset, Math.min(w * f, h * f));
        }

        var dx = Math.max(inset, Math.min(w, parseFloat(mxUtils.getValue(this.style, 'dx', this.dx))));
        var dy = Math.max(inset, Math.min(h, parseFloat(mxUtils.getValue(this.style, 'dy', this.dy))));

        c.begin();
        c.moveTo(x, y + dy);
        c.lineTo(x + w, y + dy);
        c.end();
        c.stroke();

        c.begin();
        c.moveTo(x + dx, y);
        c.lineTo(x + dx, y + h);
        c.end();
        c.stroke();
    };

    mxCellRenderer.registerShape('internalStorage', InternalStorageShape);

    // Internal storage
    function CornerShape() {
        mxActor.call(this);
    };
    mxUtils.extend(CornerShape, mxActor);
    CornerShape.prototype.dx = 20;
    CornerShape.prototype.dy = 20;

    // Corner
    CornerShape.prototype.redrawPath = function (c, x, y, w, h) {
        var dx = Math.max(0, Math.min(w, parseFloat(mxUtils.getValue(this.style, 'dx', this.dx))));
        var dy = Math.max(0, Math.min(h, parseFloat(mxUtils.getValue(this.style, 'dy', this.dy))));

        var s = Math.min(w / 2, Math.min(h, parseFloat(mxUtils.getValue(this.style, 'size', this.size))));
        var arcSize = mxUtils.getValue(this.style, mxConstants.STYLE_ARCSIZE, mxConstants.LINE_ARCSIZE) / 2;
        this.addPoints(c, [new mxPoint(0, 0), new mxPoint(w, 0), new mxPoint(w, dy), new mxPoint(dx, dy),
            new mxPoint(dx, h), new mxPoint(0, h)], this.isRounded, arcSize, true);
        c.end();
    };

    mxCellRenderer.registerShape('corner', CornerShape);

    // Crossbar shape
    function CrossbarShape() {
        mxActor.call(this);
    };
    mxUtils.extend(CrossbarShape, mxActor);

    CrossbarShape.prototype.redrawPath = function (c, x, y, w, h) {
        c.moveTo(0, 0);
        c.lineTo(0, h);
        c.end();

        c.moveTo(w, 0);
        c.lineTo(w, h);
        c.end();

        c.moveTo(0, h / 2);
        c.lineTo(w, h / 2);
        c.end();
    };

    mxCellRenderer.registerShape('crossbar', CrossbarShape);

    // Internal storage
    function TeeShape() {
        mxActor.call(this);
    };
    mxUtils.extend(TeeShape, mxActor);
    TeeShape.prototype.dx = 20;
    TeeShape.prototype.dy = 20;

    // Corner
    TeeShape.prototype.redrawPath = function (c, x, y, w, h) {
        var dx = Math.max(0, Math.min(w, parseFloat(mxUtils.getValue(this.style, 'dx', this.dx))));
        var dy = Math.max(0, Math.min(h, parseFloat(mxUtils.getValue(this.style, 'dy', this.dy))));
        var w2 = Math.abs(w - dx) / 2;

        var s = Math.min(w / 2, Math.min(h, parseFloat(mxUtils.getValue(this.style, 'size', this.size))));
        var arcSize = mxUtils.getValue(this.style, mxConstants.STYLE_ARCSIZE, mxConstants.LINE_ARCSIZE) / 2;
        this.addPoints(c, [new mxPoint(0, 0), new mxPoint(w, 0), new mxPoint(w, dy), new mxPoint((w + dx) / 2, dy),
            new mxPoint((w + dx) / 2, h), new mxPoint((w - dx) / 2, h), new mxPoint((w - dx) / 2, dy),
            new mxPoint(0, dy)], this.isRounded, arcSize, true);
        c.end();
    };

    mxCellRenderer.registerShape('tee', TeeShape);

    // Arrow
    function SingleArrowShape() {
        mxActor.call(this);
    };
    mxUtils.extend(SingleArrowShape, mxActor);
    SingleArrowShape.prototype.arrowWidth = 0.3;
    SingleArrowShape.prototype.arrowSize = 0.2;
    SingleArrowShape.prototype.redrawPath = function (c, x, y, w, h) {
        var aw = h * Math.max(0, Math.min(1, parseFloat(mxUtils.getValue(this.style, 'arrowWidth', this.arrowWidth))));
        var as = w * Math.max(0, Math.min(1, parseFloat(mxUtils.getValue(this.style, 'arrowSize', this.arrowSize))));
        var at = (h - aw) / 2;
        var ab = at + aw;

        var arcSize = mxUtils.getValue(this.style, mxConstants.STYLE_ARCSIZE, mxConstants.LINE_ARCSIZE) / 2;
        this.addPoints(c, [new mxPoint(0, at), new mxPoint(w - as, at), new mxPoint(w - as, 0), new mxPoint(w, h / 2),
                new mxPoint(w - as, h), new mxPoint(w - as, ab), new mxPoint(0, ab)],
            this.isRounded, arcSize, true);
        c.end();
    };

    mxCellRenderer.registerShape('singleArrow', SingleArrowShape);

    // Arrow
    function DoubleArrowShape() {
        mxActor.call(this);
    };
    mxUtils.extend(DoubleArrowShape, mxActor);
    DoubleArrowShape.prototype.redrawPath = function (c, x, y, w, h) {
        var aw = h * Math.max(0, Math.min(1, parseFloat(mxUtils.getValue(this.style, 'arrowWidth', SingleArrowShape.prototype.arrowWidth))));
        var as = w * Math.max(0, Math.min(1, parseFloat(mxUtils.getValue(this.style, 'arrowSize', SingleArrowShape.prototype.arrowSize))));
        var at = (h - aw) / 2;
        var ab = at + aw;

        var arcSize = mxUtils.getValue(this.style, mxConstants.STYLE_ARCSIZE, mxConstants.LINE_ARCSIZE) / 2;
        this.addPoints(c, [new mxPoint(0, h / 2), new mxPoint(as, 0), new mxPoint(as, at), new mxPoint(w - as, at),
                new mxPoint(w - as, 0), new mxPoint(w, h / 2), new mxPoint(w - as, h),
                new mxPoint(w - as, ab), new mxPoint(as, ab), new mxPoint(as, h)],
            this.isRounded, arcSize, true);
        c.end();
    };

    mxCellRenderer.registerShape('doubleArrow', DoubleArrowShape);

    // Data storage
    function DataStorageShape() {
        mxActor.call(this);
    };
    mxUtils.extend(DataStorageShape, mxActor);
    DataStorageShape.prototype.size = 0.1;
    DataStorageShape.prototype.redrawPath = function (c, x, y, w, h) {
        var s = w * Math.max(0, Math.min(1, parseFloat(mxUtils.getValue(this.style, 'size', this.size))));

        c.moveTo(s, 0);
        c.lineTo(w, 0);
        c.quadTo(w - s * 2, h / 2, w, h);
        c.lineTo(s, h);
        c.quadTo(s - s * 2, h / 2, s, 0);
        c.close();
        c.end();
    };

    mxCellRenderer.registerShape('dataStorage', DataStorageShape);

    // Or
    function OrShape() {
        mxActor.call(this);
    };
    mxUtils.extend(OrShape, mxActor);
    OrShape.prototype.redrawPath = function (c, x, y, w, h) {
        c.moveTo(0, 0);
        c.quadTo(w, 0, w, h / 2);
        c.quadTo(w, h, 0, h);
        c.close();
        c.end();
    };

    mxCellRenderer.registerShape('or', OrShape);

    // Xor
    function XorShape() {
        mxActor.call(this);
    };
    mxUtils.extend(XorShape, mxActor);
    XorShape.prototype.redrawPath = function (c, x, y, w, h) {
        c.moveTo(0, 0);
        c.quadTo(w, 0, w, h / 2);
        c.quadTo(w, h, 0, h);
        c.quadTo(w / 2, h / 2, 0, 0);
        c.close();
        c.end();
    };

    mxCellRenderer.registerShape('xor', XorShape);

    // Loop limit
    function LoopLimitShape() {
        mxActor.call(this);
    };
    mxUtils.extend(LoopLimitShape, mxActor);
    LoopLimitShape.prototype.size = 20;
    LoopLimitShape.prototype.isRoundable = function () {
        return true;
    };
    LoopLimitShape.prototype.redrawPath = function (c, x, y, w, h) {
        var s = Math.min(w / 2, Math.min(h, parseFloat(mxUtils.getValue(this.style, 'size', this.size))));
        var arcSize = mxUtils.getValue(this.style, mxConstants.STYLE_ARCSIZE, mxConstants.LINE_ARCSIZE) / 2;
        this.addPoints(c, [new mxPoint(s, 0), new mxPoint(w - s, 0), new mxPoint(w, s * 0.8), new mxPoint(w, h),
            new mxPoint(0, h), new mxPoint(0, s * 0.8)], this.isRounded, arcSize, true);
        c.end();
    };

    mxCellRenderer.registerShape('loopLimit', LoopLimitShape);

    // Off page connector
    function OffPageConnectorShape() {
        mxActor.call(this);
    };
    mxUtils.extend(OffPageConnectorShape, mxActor);
    OffPageConnectorShape.prototype.size = 3 / 8;
    OffPageConnectorShape.prototype.isRoundable = function () {
        return true;
    };
    OffPageConnectorShape.prototype.redrawPath = function (c, x, y, w, h) {
        var s = h * Math.max(0, Math.min(1, parseFloat(mxUtils.getValue(this.style, 'size', this.size))));
        var arcSize = mxUtils.getValue(this.style, mxConstants.STYLE_ARCSIZE, mxConstants.LINE_ARCSIZE) / 2;
        this.addPoints(c, [new mxPoint(0, 0), new mxPoint(w, 0), new mxPoint(w, h - s), new mxPoint(w / 2, h),
            new mxPoint(0, h - s)], this.isRounded, arcSize, true);
        c.end();
    };

    mxCellRenderer.registerShape('offPageConnector', OffPageConnectorShape);

    // Internal storage
    function TapeDataShape() {
        mxEllipse.call(this);
    };
    mxUtils.extend(TapeDataShape, mxEllipse);
    TapeDataShape.prototype.paintVertexShape = function (c, x, y, w, h) {
        mxEllipse.prototype.paintVertexShape.apply(this, arguments);

        c.begin();
        c.moveTo(x + w / 2, y + h);
        c.lineTo(x + w, y + h);
        c.end();
        c.stroke();
    };

    mxCellRenderer.registerShape('tapeData', TapeDataShape);

    // OrEllipseShape
    function OrEllipseShape() {
        mxEllipse.call(this);
    };
    mxUtils.extend(OrEllipseShape, mxEllipse);
    OrEllipseShape.prototype.paintVertexShape = function (c, x, y, w, h) {
        mxEllipse.prototype.paintVertexShape.apply(this, arguments);

        c.setShadow(false);
        c.begin();
        c.moveTo(x, y + h / 2);
        c.lineTo(x + w, y + h / 2);
        c.end();
        c.stroke();

        c.begin();
        c.moveTo(x + w / 2, y);
        c.lineTo(x + w / 2, y + h);
        c.end();
        c.stroke();
    };

    mxCellRenderer.registerShape('orEllipse', OrEllipseShape);

    // SumEllipseShape
    function SumEllipseShape() {
        mxEllipse.call(this);
    };
    mxUtils.extend(SumEllipseShape, mxEllipse);
    SumEllipseShape.prototype.paintVertexShape = function (c, x, y, w, h) {
        mxEllipse.prototype.paintVertexShape.apply(this, arguments);
        var s2 = 0.145;

        c.setShadow(false);
        c.begin();
        c.moveTo(x + w * s2, y + h * s2);
        c.lineTo(x + w * (1 - s2), y + h * (1 - s2));
        c.end();
        c.stroke();

        c.begin();
        c.moveTo(x + w * (1 - s2), y + h * s2);
        c.lineTo(x + w * s2, y + h * (1 - s2));
        c.end();
        c.stroke();
    };

    mxCellRenderer.registerShape('sumEllipse', SumEllipseShape);

    // SortShape
    function SortShape() {
        mxRhombus.call(this);
    };
    mxUtils.extend(SortShape, mxRhombus);
    SortShape.prototype.paintVertexShape = function (c, x, y, w, h) {
        mxRhombus.prototype.paintVertexShape.apply(this, arguments);

        c.setShadow(false);
        c.begin();
        c.moveTo(x, y + h / 2);
        c.lineTo(x + w, y + h / 2);
        c.end();
        c.stroke();
    };

    mxCellRenderer.registerShape('sortShape', SortShape);

    // CollateShape
    function CollateShape() {
        mxEllipse.call(this);
    };
    mxUtils.extend(CollateShape, mxEllipse);
    CollateShape.prototype.paintVertexShape = function (c, x, y, w, h) {
        c.begin();
        c.moveTo(x, y);
        c.lineTo(x + w, y);
        c.lineTo(x + w / 2, y + h / 2);
        c.close();
        c.fillAndStroke();

        c.begin();
        c.moveTo(x, y + h);
        c.lineTo(x + w, y + h);
        c.lineTo(x + w / 2, y + h / 2);
        c.close();
        c.fillAndStroke();
    };

    mxCellRenderer.registerShape('collate', CollateShape);

    // DimensionShape
    function DimensionShape() {
        mxEllipse.call(this);
    };
    mxUtils.extend(DimensionShape, mxEllipse);
    DimensionShape.prototype.paintVertexShape = function (c, x, y, w, h) {
        // Arrow size
        var al = 10;
        var cy = y + h - al / 2;

        c.begin();
        c.moveTo(x, y);
        c.lineTo(x, y + h);
        c.moveTo(x, cy);
        c.lineTo(x + al, cy - al / 2);
        c.moveTo(x, cy);
        c.lineTo(x + al, cy + al / 2);
        c.moveTo(x, cy);
        c.lineTo(x + w, cy);

        // Opposite side
        c.moveTo(x + w, y);
        c.lineTo(x + w, y + h);
        c.moveTo(x + w, cy);
        c.lineTo(x + w - al, cy - al / 2);
        c.moveTo(x + w, cy);
        c.lineTo(x + w - al, cy + al / 2);
        c.end();
        c.stroke();
    };

    mxCellRenderer.registerShape('dimension', DimensionShape);

    // PartialRectangleShape
    function PartialRectangleShape() {
        mxEllipse.call(this);
    };
    mxUtils.extend(PartialRectangleShape, mxEllipse);
    PartialRectangleShape.prototype.paintVertexShape = function (c, x, y, w, h) {
        if (!this.outline) {
            c.setStrokeColor(null);
        }

        mxRectangleShape.prototype.paintBackground.apply(this, arguments);

        if (this.style != null) {
            c.setStrokeColor(this.stroke);
            c.rect(x, y, w, h);
            c.fill();

            c.begin();
            c.moveTo(x, y);

            if (mxUtils.getValue(this.style, 'top', '1') == '1') {
                c.lineTo(x + w, y);
            } else {
                c.moveTo(x + w, y);
            }

            if (mxUtils.getValue(this.style, 'right', '1') == '1') {
                c.lineTo(x + w, y + h);
            } else {
                c.moveTo(x + w, y + h);
            }

            if (mxUtils.getValue(this.style, 'bottom', '1') == '1') {
                c.lineTo(x, y + h);
            } else {
                c.moveTo(x, y + h);
            }

            if (mxUtils.getValue(this.style, 'left', '1') == '1') {
                c.lineTo(x, y - this.strokewidth / 2);
            }

            c.end();
            c.stroke();
        }
    };

    mxCellRenderer.registerShape('partialRectangle', PartialRectangleShape);

    // LineEllipseShape
    function LineEllipseShape() {
        mxEllipse.call(this);
    };
    mxUtils.extend(LineEllipseShape, mxEllipse);
    LineEllipseShape.prototype.paintVertexShape = function (c, x, y, w, h) {
        mxEllipse.prototype.paintVertexShape.apply(this, arguments);

        c.setShadow(false);
        c.begin();

        if (mxUtils.getValue(this.style, 'line') == 'vertical') {
            c.moveTo(x + w / 2, y);
            c.lineTo(x + w / 2, y + h);
        } else {
            c.moveTo(x, y + h / 2);
            c.lineTo(x + w, y + h / 2);
        }

        c.end();
        c.stroke();
    };

    mxCellRenderer.registerShape('lineEllipse', LineEllipseShape);

    // Delay
    function DelayShape() {
        mxActor.call(this);
    };
    mxUtils.extend(DelayShape, mxActor);
    DelayShape.prototype.redrawPath = function (c, x, y, w, h) {
        var dx = Math.min(w, h / 2);
        c.moveTo(0, 0);
        c.lineTo(w - dx, 0);
        c.quadTo(w, 0, w, h / 2);
        c.quadTo(w, h, w - dx, h);
        c.lineTo(0, h);
        c.close();
        c.end();
    };

    mxCellRenderer.registerShape('delay', DelayShape);

    // Cross Shape
    function CrossShape() {
        mxActor.call(this);
    };
    mxUtils.extend(CrossShape, mxActor);
    CrossShape.prototype.size = 0.2;
    CrossShape.prototype.redrawPath = function (c, x, y, w, h) {
        var m = Math.min(h, w);
        var size = Math.max(0, Math.min(m, m * parseFloat(mxUtils.getValue(this.style, 'size', this.size))));
        var t = (h - size) / 2;
        var b = t + size;
        var l = (w - size) / 2;
        var r = l + size;

        c.moveTo(0, t);
        c.lineTo(l, t);
        c.lineTo(l, 0);
        c.lineTo(r, 0);
        c.lineTo(r, t);
        c.lineTo(w, t);
        c.lineTo(w, b);
        c.lineTo(r, b);
        c.lineTo(r, h);
        c.lineTo(l, h);
        c.lineTo(l, b);
        c.lineTo(0, b);
        c.close();
        c.end();
    };

    mxCellRenderer.registerShape('cross', CrossShape);

    // Display
    function DisplayShape() {
        mxActor.call(this);
    };
    mxUtils.extend(DisplayShape, mxActor);
    DisplayShape.prototype.size = 0.25;
    DisplayShape.prototype.redrawPath = function (c, x, y, w, h) {
        var dx = Math.min(w, h / 2);
        var s = Math.min(w - dx, Math.max(0, parseFloat(mxUtils.getValue(this.style, 'size', this.size))) * w);

        c.moveTo(0, h / 2);
        c.lineTo(s, 0);
        c.lineTo(w - dx, 0);
        c.quadTo(w, 0, w, h / 2);
        c.quadTo(w, h, w - dx, h);
        c.lineTo(s, h);
        c.close();
        c.end();
    };

    mxCellRenderer.registerShape('display', DisplayShape);

    // FilledEdge shape
    function FilledEdge() {
        mxConnector.call(this);
    };
    mxUtils.extend(FilledEdge, mxConnector);

    FilledEdge.prototype.origPaintEdgeShape = FilledEdge.prototype.paintEdgeShape;
    FilledEdge.prototype.paintEdgeShape = function (c, pts, rounded) {
        // Markers modify incoming points array
        var temp = [];

        for (var i = 0; i < pts.length; i++) {
            temp.push(mxUtils.clone(pts[i]));
        }

        // paintEdgeShape resets dashed to false
        var dashed = c.state.dashed;
        var fixDash = c.state.fixDash;
        FilledEdge.prototype.origPaintEdgeShape.apply(this, [c, temp, rounded]);

        if (c.state.strokeWidth >= 3) {
            var fillClr = mxUtils.getValue(this.style, 'fillColor', null);

            if (fillClr != null) {
                c.setStrokeColor(fillClr);
                c.setStrokeWidth(c.state.strokeWidth - 2);
                c.setDashed(dashed, fixDash);

                FilledEdge.prototype.origPaintEdgeShape.apply(this, [c, pts, rounded]);
            }
        }
    };

    // Registers the link shape
    mxCellRenderer.registerShape('filledEdge', FilledEdge);

    // Implements custom colors for shapes
    if (typeof StyleFormatPanel !== 'undefined') {
        (function () {
            var styleFormatPanelGetCustomColors = StyleFormatPanel.prototype.getCustomColors;

            StyleFormatPanel.prototype.getCustomColors = function () {
                var ss = this.format.getSelectionState();
                var result = styleFormatPanelGetCustomColors.apply(this, arguments);

                if (ss.style.shape == 'umlFrame') {
                    result.push({
                        title: mxResources.get('laneColor'),
                        key: 'swimlaneFillColor',
                        defaultValue: '#ffffff'
                    });
                }

                return result;
            };
        })();
    }

    // Registers and defines the custom marker
    mxMarker.addMarker('dash', function (c, shape, type, pe, unitX, unitY, size, source, sw, filled) {
        var nx = unitX * (size + sw + 1);
        var ny = unitY * (size + sw + 1);

        return function () {
            c.begin();
            c.moveTo(pe.x - nx / 2 - ny / 2, pe.y - ny / 2 + nx / 2);
            c.lineTo(pe.x + ny / 2 - 3 * nx / 2, pe.y - 3 * ny / 2 - nx / 2);
            c.stroke();
        };
    });

    // Registers and defines the custom marker
    mxMarker.addMarker('cross', function (c, shape, type, pe, unitX, unitY, size, source, sw, filled) {
        var nx = unitX * (size + sw + 1);
        var ny = unitY * (size + sw + 1);

        return function () {
            c.begin();
            c.moveTo(pe.x - nx / 2 - ny / 2, pe.y - ny / 2 + nx / 2);
            c.lineTo(pe.x + ny / 2 - 3 * nx / 2, pe.y - 3 * ny / 2 - nx / 2);
            c.moveTo(pe.x - nx / 2 + ny / 2, pe.y - ny / 2 - nx / 2);
            c.lineTo(pe.x - ny / 2 - 3 * nx / 2, pe.y - 3 * ny / 2 + nx / 2);
            c.stroke();
        };
    });

    function circleMarker(c, shape, type, pe, unitX, unitY, size, source, sw, filled) {
        var a = size / 2;
        var size = size + sw;

        var pt = pe.clone();

        pe.x -= unitX * (2 * size + sw);
        pe.y -= unitY * (2 * size + sw);

        unitX = unitX * (size + sw);
        unitY = unitY * (size + sw);

        return function () {
            c.ellipse(pt.x - unitX - size, pt.y - unitY - size, 2 * size, 2 * size);

            if (filled) {
                c.fillAndStroke();
            } else {
                c.stroke();
            }
        };
    };

    mxMarker.addMarker('circle', circleMarker);
    mxMarker.addMarker('circlePlus', function (c, shape, type, pe, unitX, unitY, size, source, sw, filled) {
        var pt = pe.clone();
        var fn = circleMarker.apply(this, arguments);
        var nx = unitX * (size + 2 * sw); // (size + sw + 1);
        var ny = unitY * (size + 2 * sw); //(size + sw + 1);

        return function () {
            fn.apply(this, arguments);

            c.begin();
            c.moveTo(pt.x - unitX * (sw), pt.y - unitY * (sw));
            c.lineTo(pt.x - 2 * nx + unitX * (sw), pt.y - 2 * ny + unitY * (sw));
            c.moveTo(pt.x - nx - ny + unitY * sw, pt.y - ny + nx - unitX * sw);
            c.lineTo(pt.x + ny - nx - unitY * sw, pt.y - ny - nx + unitX * sw);
            c.stroke();
        };
    });

    // Registers and defines the custom marker
    mxMarker.addMarker('halfCircle', function (c, shape, type, pe, unitX, unitY, size, source, sw, filled) {
        var nx = unitX * (size + sw + 1);
        var ny = unitY * (size + sw + 1);
        var pt = pe.clone();

        pe.x -= nx;
        pe.y -= ny;

        return function () {
            c.begin();
            c.moveTo(pt.x - ny, pt.y + nx);
            c.quadTo(pe.x - ny, pe.y + nx, pe.x, pe.y);
            c.quadTo(pe.x + ny, pe.y - nx, pt.x + ny, pt.y - nx);
            c.stroke();
        };
    });

    mxMarker.addMarker('async', function (c, shape, type, pe, unitX, unitY, size, source, sw, filled) {
        // The angle of the forward facing arrow sides against the x axis is
        // 26.565 degrees, 1/sin(26.565) = 2.236 / 2 = 1.118 ( / 2 allows for
        // only half the strokewidth is processed ).
        var endOffsetX = unitX * sw * 1.118;
        var endOffsetY = unitY * sw * 1.118;

        unitX = unitX * (size + sw);
        unitY = unitY * (size + sw);

        var pt = pe.clone();
        pt.x -= endOffsetX;
        pt.y -= endOffsetY;

        var f = 1;
        pe.x += -unitX * f - endOffsetX;
        pe.y += -unitY * f - endOffsetY;

        return function () {
            c.begin();
            c.moveTo(pt.x, pt.y);

            if (source) {
                c.lineTo(pt.x - unitX - unitY / 2, pt.y - unitY + unitX / 2);
            } else {
                c.lineTo(pt.x + unitY / 2 - unitX, pt.y - unitY - unitX / 2);
            }

            c.lineTo(pt.x - unitX, pt.y - unitY);
            c.close();

            if (filled) {
                c.fillAndStroke();
            } else {
                c.stroke();
            }
        };
    });

    function createOpenAsyncArrow(widthFactor) {
        widthFactor = (widthFactor != null) ? widthFactor : 2;

        return function (c, shape, type, pe, unitX, unitY, size, source, sw, filled) {
            unitX = unitX * (size + sw);
            unitY = unitY * (size + sw);

            var pt = pe.clone();

            return function () {
                c.begin();
                c.moveTo(pt.x, pt.y);

                if (source) {
                    c.lineTo(pt.x - unitX - unitY / widthFactor, pt.y - unitY + unitX / widthFactor);
                } else {
                    c.lineTo(pt.x + unitY / widthFactor - unitX, pt.y - unitY - unitX / widthFactor);
                }

                c.stroke();
            };
        }
    };

    mxMarker.addMarker('openAsync', createOpenAsyncArrow(2));

    function arrow(canvas, shape, type, pe, unitX, unitY, size, source, sw, filled) {
        // The angle of the forward facing arrow sides against the x axis is
        // 26.565 degrees, 1/sin(26.565) = 2.236 / 2 = 1.118 ( / 2 allows for
        // only half the strokewidth is processed ).
        var endOffsetX = unitX * sw * 1.118;
        var endOffsetY = unitY * sw * 1.118;

        unitX = unitX * (size + sw);
        unitY = unitY * (size + sw);

        var pt = pe.clone();
        pt.x -= endOffsetX;
        pt.y -= endOffsetY;

        var f = (type != mxConstants.ARROW_CLASSIC && type != mxConstants.ARROW_CLASSIC_THIN) ? 1 : 3 / 4;
        pe.x += -unitX * f - endOffsetX;
        pe.y += -unitY * f - endOffsetY;

        return function () {
            canvas.begin();
            canvas.moveTo(pt.x, pt.y);
            canvas.lineTo(pt.x - unitX - unitY / widthFactor, pt.y - unitY + unitX / widthFactor);

            if (type == mxConstants.ARROW_CLASSIC || type == mxConstants.ARROW_CLASSIC_THIN) {
                canvas.lineTo(pt.x - unitX * 3 / 4, pt.y - unitY * 3 / 4);
            }

            canvas.lineTo(pt.x + unitY / widthFactor - unitX, pt.y - unitY - unitX / widthFactor);
            canvas.close();

            if (filled) {
                canvas.fillAndStroke();
            } else {
                canvas.stroke();
            }
        };
    }

    // Handlers are only added if mxVertexHandler is defined (ie. not in embedded graph)
    if (typeof mxVertexHandler !== 'undefined') {
        function createHandle(state, keys, getPositionFn, setPositionFn, ignoreGrid, redrawEdges) {
            var handle = new mxHandle(state, null, mxVertexHandler.prototype.secondaryHandleImage);

            handle.execute = function () {
                for (var i = 0; i < keys.length; i++) {
                    this.copyStyle(keys[i]);
                }
            };

            handle.getPosition = getPositionFn;
            handle.setPosition = setPositionFn;
            handle.ignoreGrid = (ignoreGrid != null) ? ignoreGrid : true;

            // Overridden to update connected edges
            if (redrawEdges) {
                var positionChanged = handle.positionChanged;

                handle.positionChanged = function () {
                    positionChanged.apply(this, arguments);

                    // Redraws connected edges TODO: Include child edges
                    state.view.invalidate(this.state.cell);
                    state.view.validate();
                };
            }

            return handle;
        };

        function createArcHandle(state, yOffset) {
            return createHandle(state, [mxConstants.STYLE_ARCSIZE], function (bounds) {
                var tmp = (yOffset != null) ? yOffset : bounds.height / 8;

                if (mxUtils.getValue(state.style, mxConstants.STYLE_ABSOLUTE_ARCSIZE, 0) == '1') {
                    var arcSize = mxUtils.getValue(state.style, mxConstants.STYLE_ARCSIZE, mxConstants.LINE_ARCSIZE) / 2;

                    return new mxPoint(bounds.x + bounds.width - Math.min(bounds.width / 2, arcSize), bounds.y + tmp);
                } else {
                    var arcSize = Math.max(0, parseFloat(mxUtils.getValue(state.style,
                        mxConstants.STYLE_ARCSIZE, mxConstants.RECTANGLE_ROUNDING_FACTOR * 100))) / 100;

                    return new mxPoint(bounds.x + bounds.width - Math.min(Math.max(bounds.width / 2, bounds.height / 2),
                        Math.min(bounds.width, bounds.height) * arcSize), bounds.y + tmp);
                }
            }, function (bounds, pt, me) {
                if (mxUtils.getValue(state.style, mxConstants.STYLE_ABSOLUTE_ARCSIZE, 0) == '1') {
                    this.state.style[mxConstants.STYLE_ARCSIZE] = Math.round(Math.max(0, Math.min(bounds.width,
                        (bounds.x + bounds.width - pt.x) * 2)));
                } else {
                    var f = Math.min(50, Math.max(0, (bounds.width - pt.x + bounds.x) * 100 /
                        Math.min(bounds.width, bounds.height)));
                    this.state.style[mxConstants.STYLE_ARCSIZE] = Math.round(f);
                }
            });
        }

        function createArcHandleFunction() {
            return function (state) {
                var handles = [];

                if (mxUtils.getValue(state.style, mxConstants.STYLE_ROUNDED, false)) {
                    handles.push(createArcHandle(state));
                }

                return handles;
            };
        };

        function createTrapezoidHandleFunction(max) {
            return function (state) {
                var handles = [createHandle(state, ['size'], function (bounds) {
                    var size = Math.max(0, Math.min(max, parseFloat(mxUtils.getValue(this.state.style, 'size', TrapezoidShape.prototype.size))));

                    return new mxPoint(bounds.x + size * bounds.width * 0.75, bounds.y + bounds.height / 4);
                }, function (bounds, pt) {
                    this.state.style['size'] = Math.max(0, Math.min(max, (pt.x - bounds.x) / (bounds.width * 0.75)));
                }, null, true)];

                if (mxUtils.getValue(state.style, mxConstants.STYLE_ROUNDED, false)) {
                    handles.push(createArcHandle(state));
                }

                return handles;
            };
        };

        function createDisplayHandleFunction(defaultValue, allowArcHandle, max, redrawEdges, fixedDefaultValue) {
            max = (max != null) ? max : 1;

            return function (state) {
                var handles = [createHandle(state, ['size'], function (bounds) {
                    var fixed = (fixedDefaultValue != null) ? mxUtils.getValue(this.state.style, 'fixedSize', '0') != '0' : null;
                    var size = parseFloat(mxUtils.getValue(this.state.style, 'size', (fixed) ? fixedDefaultValue : defaultValue));

                    return new mxPoint(bounds.x + Math.max(0, Math.min(bounds.width, size * ((fixed) ? 1 : bounds.width))), bounds.getCenterY());
                }, function (bounds, pt, me) {
                    var fixed = (fixedDefaultValue != null) ? mxUtils.getValue(this.state.style, 'fixedSize', '0') != '0' : null;
                    var size = (fixed) ? (pt.x - bounds.x) : Math.max(0, Math.min(max, (pt.x - bounds.x) / bounds.width));

                    if (fixed && !mxEvent.isAltDown(me.getEvent())) {
                        size = state.view.graph.snap(size);
                    }

                    this.state.style['size'] = size;
                }, null, redrawEdges)];

                if (allowArcHandle && mxUtils.getValue(state.style, mxConstants.STYLE_ROUNDED, false)) {
                    handles.push(createArcHandle(state));
                }

                return handles;
            };
        };

        function createCubeHandleFunction(factor, defaultValue, allowArcHandle) {
            return function (state) {
                var handles = [createHandle(state, ['size'], function (bounds) {
                    var size = Math.max(0, Math.min(bounds.width, Math.min(bounds.height, parseFloat(
                        mxUtils.getValue(this.state.style, 'size', defaultValue))))) * factor;

                    return new mxPoint(bounds.x + size, bounds.y + size);
                }, function (bounds, pt) {
                    this.state.style['size'] = Math.round(Math.max(0, Math.min(Math.min(bounds.width, pt.x - bounds.x),
                        Math.min(bounds.height, pt.y - bounds.y))) / factor);
                })];

                if (allowArcHandle && mxUtils.getValue(state.style, mxConstants.STYLE_ROUNDED, false)) {
                    handles.push(createArcHandle(state));
                }

                return handles;
            };
        };

        function createArrowHandleFunction(maxSize) {
            return function (state) {
                return [createHandle(state, ['arrowWidth', 'arrowSize'], function (bounds) {
                    var aw = Math.max(0, Math.min(1, mxUtils.getValue(this.state.style, 'arrowWidth', SingleArrowShape.prototype.arrowWidth)));
                    var as = Math.max(0, Math.min(maxSize, mxUtils.getValue(this.state.style, 'arrowSize', SingleArrowShape.prototype.arrowSize)));

                    return new mxPoint(bounds.x + (1 - as) * bounds.width, bounds.y + (1 - aw) * bounds.height / 2);
                }, function (bounds, pt) {
                    this.state.style['arrowWidth'] = Math.max(0, Math.min(1, Math.abs(bounds.y + bounds.height / 2 - pt.y) / bounds.height * 2));
                    this.state.style['arrowSize'] = Math.max(0, Math.min(maxSize, (bounds.x + bounds.width - pt.x) / (bounds.width)));
                })];
            };
        };

        function createEdgeHandle(state, keys, start, getPosition, setPosition) {
            return createHandle(state, keys, function (bounds) {
                var pts = state.absolutePoints;
                var n = pts.length - 1;

                var tr = state.view.translate;
                var s = state.view.scale;

                var p0 = (start) ? pts[0] : pts[n];
                var p1 = (start) ? pts[1] : pts[n - 1];
                var dx = (start) ? p1.x - p0.x : p1.x - p0.x;
                var dy = (start) ? p1.y - p0.y : p1.y - p0.y;

                var dist = Math.sqrt(dx * dx + dy * dy);

                var pt = getPosition.call(this, dist, dx / dist, dy / dist, p0, p1);

                return new mxPoint(pt.x / s - tr.x, pt.y / s - tr.y);
            }, function (bounds, pt, me) {
                var pts = state.absolutePoints;
                var n = pts.length - 1;

                var tr = state.view.translate;
                var s = state.view.scale;

                var p0 = (start) ? pts[0] : pts[n];
                var p1 = (start) ? pts[1] : pts[n - 1];
                var dx = (start) ? p1.x - p0.x : p1.x - p0.x;
                var dy = (start) ? p1.y - p0.y : p1.y - p0.y;

                var dist = Math.sqrt(dx * dx + dy * dy);
                pt.x = (pt.x + tr.x) * s;
                pt.y = (pt.y + tr.y) * s;

                setPosition.call(this, dist, dx / dist, dy / dist, p0, p1, pt, me);
            });
        };

        function createEdgeWidthHandle(state, start, spacing) {
            return createEdgeHandle(state, ['width'], start, function (dist, nx, ny, p0, p1) {
                var w = state.shape.getEdgeWidth() * state.view.scale + spacing;

                return new mxPoint(p0.x + nx * dist / 4 + ny * w / 2, p0.y + ny * dist / 4 - nx * w / 2);
            }, function (dist, nx, ny, p0, p1, pt) {
                var w = Math.sqrt(mxUtils.ptSegDistSq(p0.x, p0.y, p1.x, p1.y, pt.x, pt.y));
                state.style['width'] = Math.round(w * 2) / state.view.scale - spacing;
            });
        };

        function ptLineDistance(x1, y1, x2, y2, x0, y0) {
            return Math.abs((y2 - y1) * x0 - (x2 - x1) * y0 + x2 * y1 - y2 * x1) / Math.sqrt((y2 - y1) * (y2 - y1) + (x2 - x1) * (x2 - x1));
        }

        var handleFactory = {
            'link': function (state) {
                var spacing = 10;

                return [createEdgeWidthHandle(state, true, spacing), createEdgeWidthHandle(state, false, spacing)];
            },
            'flexArrow': function (state) {
                // Do not use state.shape.startSize/endSize since it is cached
                var tol = state.view.graph.gridSize / state.view.scale;
                var handles = [];

                if (mxUtils.getValue(state.style, mxConstants.STYLE_STARTARROW, mxConstants.NONE) != mxConstants.NONE) {
                    handles.push(createEdgeHandle(state, ['width', mxConstants.STYLE_STARTSIZE, mxConstants.STYLE_ENDSIZE], true, function (dist, nx, ny, p0, p1) {
                        var w = (state.shape.getEdgeWidth() - state.shape.strokewidth) * state.view.scale;
                        var l = mxUtils.getNumber(state.style, mxConstants.STYLE_STARTSIZE, mxConstants.ARROW_SIZE / 5) * 3 * state.view.scale;

                        return new mxPoint(p0.x + nx * (l + state.shape.strokewidth * state.view.scale) + ny * w / 2,
                            p0.y + ny * (l + state.shape.strokewidth * state.view.scale) - nx * w / 2);
                    }, function (dist, nx, ny, p0, p1, pt, me) {
                        var w = Math.sqrt(mxUtils.ptSegDistSq(p0.x, p0.y, p1.x, p1.y, pt.x, pt.y));
                        var l = mxUtils.ptLineDist(p0.x, p0.y, p0.x + ny, p0.y - nx, pt.x, pt.y);

                        state.style[mxConstants.STYLE_STARTSIZE] = Math.round((l - state.shape.strokewidth) * 100 / 3) / 100 / state.view.scale;
                        state.style['width'] = Math.round(w * 2) / state.view.scale;

                        // Applies to opposite side
                        if (mxEvent.isControlDown(me.getEvent())) {
                            state.style[mxConstants.STYLE_ENDSIZE] = state.style[mxConstants.STYLE_STARTSIZE];
                        }

                        // Snaps to end geometry
                        if (!mxEvent.isAltDown(me.getEvent())) {
                            if (Math.abs(parseFloat(state.style[mxConstants.STYLE_STARTSIZE]) - parseFloat(state.style[mxConstants.STYLE_ENDSIZE])) < tol / 6) {
                                state.style[mxConstants.STYLE_STARTSIZE] = state.style[mxConstants.STYLE_ENDSIZE];
                            }
                        }
                    }));

                    handles.push(createEdgeHandle(state, ['startWidth', 'endWidth', mxConstants.STYLE_STARTSIZE, mxConstants.STYLE_ENDSIZE], true, function (dist, nx, ny, p0, p1) {
                        var w = (state.shape.getStartArrowWidth() - state.shape.strokewidth) * state.view.scale;
                        var l = mxUtils.getNumber(state.style, mxConstants.STYLE_STARTSIZE, mxConstants.ARROW_SIZE / 5) * 3 * state.view.scale;

                        return new mxPoint(p0.x + nx * (l + state.shape.strokewidth * state.view.scale) + ny * w / 2,
                            p0.y + ny * (l + state.shape.strokewidth * state.view.scale) - nx * w / 2);
                    }, function (dist, nx, ny, p0, p1, pt, me) {
                        var w = Math.sqrt(mxUtils.ptSegDistSq(p0.x, p0.y, p1.x, p1.y, pt.x, pt.y));
                        var l = mxUtils.ptLineDist(p0.x, p0.y, p0.x + ny, p0.y - nx, pt.x, pt.y);

                        state.style[mxConstants.STYLE_STARTSIZE] = Math.round((l - state.shape.strokewidth) * 100 / 3) / 100 / state.view.scale;
                        state.style['startWidth'] = Math.max(0, Math.round(w * 2) - state.shape.getEdgeWidth()) / state.view.scale;

                        // Applies to opposite side
                        if (mxEvent.isControlDown(me.getEvent())) {
                            state.style[mxConstants.STYLE_ENDSIZE] = state.style[mxConstants.STYLE_STARTSIZE];
                            state.style['endWidth'] = state.style['startWidth'];
                        }

                        // Snaps to endWidth
                        if (!mxEvent.isAltDown(me.getEvent())) {
                            if (Math.abs(parseFloat(state.style[mxConstants.STYLE_STARTSIZE]) - parseFloat(state.style[mxConstants.STYLE_ENDSIZE])) < tol / 6) {
                                state.style[mxConstants.STYLE_STARTSIZE] = state.style[mxConstants.STYLE_ENDSIZE];
                            }

                            if (Math.abs(parseFloat(state.style['startWidth']) - parseFloat(state.style['endWidth'])) < tol) {
                                state.style['startWidth'] = state.style['endWidth'];
                            }
                        }
                    }));
                }

                if (mxUtils.getValue(state.style, mxConstants.STYLE_ENDARROW, mxConstants.NONE) != mxConstants.NONE) {
                    handles.push(createEdgeHandle(state, ['width', mxConstants.STYLE_STARTSIZE, mxConstants.STYLE_ENDSIZE], false, function (dist, nx, ny, p0, p1) {
                        var w = (state.shape.getEdgeWidth() - state.shape.strokewidth) * state.view.scale;
                        var l = mxUtils.getNumber(state.style, mxConstants.STYLE_ENDSIZE, mxConstants.ARROW_SIZE / 5) * 3 * state.view.scale;

                        return new mxPoint(p0.x + nx * (l + state.shape.strokewidth * state.view.scale) - ny * w / 2,
                            p0.y + ny * (l + state.shape.strokewidth * state.view.scale) + nx * w / 2);
                    }, function (dist, nx, ny, p0, p1, pt, me) {
                        var w = Math.sqrt(mxUtils.ptSegDistSq(p0.x, p0.y, p1.x, p1.y, pt.x, pt.y));
                        var l = mxUtils.ptLineDist(p0.x, p0.y, p0.x + ny, p0.y - nx, pt.x, pt.y);

                        state.style[mxConstants.STYLE_ENDSIZE] = Math.round((l - state.shape.strokewidth) * 100 / 3) / 100 / state.view.scale;
                        state.style['width'] = Math.round(w * 2) / state.view.scale;

                        // Applies to opposite side
                        if (mxEvent.isControlDown(me.getEvent())) {
                            state.style[mxConstants.STYLE_STARTSIZE] = state.style[mxConstants.STYLE_ENDSIZE];
                        }

                        // Snaps to start geometry
                        if (!mxEvent.isAltDown(me.getEvent())) {
                            if (Math.abs(parseFloat(state.style[mxConstants.STYLE_ENDSIZE]) - parseFloat(state.style[mxConstants.STYLE_STARTSIZE])) < tol / 6) {
                                state.style[mxConstants.STYLE_ENDSIZE] = state.style[mxConstants.STYLE_STARTSIZE];
                            }
                        }
                    }));

                    handles.push(createEdgeHandle(state, ['startWidth', 'endWidth', mxConstants.STYLE_STARTSIZE, mxConstants.STYLE_ENDSIZE], false, function (dist, nx, ny, p0, p1) {
                        var w = (state.shape.getEndArrowWidth() - state.shape.strokewidth) * state.view.scale;
                        var l = mxUtils.getNumber(state.style, mxConstants.STYLE_ENDSIZE, mxConstants.ARROW_SIZE / 5) * 3 * state.view.scale;

                        return new mxPoint(p0.x + nx * (l + state.shape.strokewidth * state.view.scale) - ny * w / 2,
                            p0.y + ny * (l + state.shape.strokewidth * state.view.scale) + nx * w / 2);
                    }, function (dist, nx, ny, p0, p1, pt, me) {
                        var w = Math.sqrt(mxUtils.ptSegDistSq(p0.x, p0.y, p1.x, p1.y, pt.x, pt.y));
                        var l = mxUtils.ptLineDist(p0.x, p0.y, p0.x + ny, p0.y - nx, pt.x, pt.y);

                        state.style[mxConstants.STYLE_ENDSIZE] = Math.round((l - state.shape.strokewidth) * 100 / 3) / 100 / state.view.scale;
                        state.style['endWidth'] = Math.max(0, Math.round(w * 2) - state.shape.getEdgeWidth()) / state.view.scale;

                        // Applies to opposite side
                        if (mxEvent.isControlDown(me.getEvent())) {
                            state.style[mxConstants.STYLE_STARTSIZE] = state.style[mxConstants.STYLE_ENDSIZE];
                            state.style['startWidth'] = state.style['endWidth'];
                        }

                        // Snaps to start geometry
                        if (!mxEvent.isAltDown(me.getEvent())) {
                            if (Math.abs(parseFloat(state.style[mxConstants.STYLE_ENDSIZE]) - parseFloat(state.style[mxConstants.STYLE_STARTSIZE])) < tol / 6) {
                                state.style[mxConstants.STYLE_ENDSIZE] = state.style[mxConstants.STYLE_STARTSIZE];
                            }

                            if (Math.abs(parseFloat(state.style['endWidth']) - parseFloat(state.style['startWidth'])) < tol) {
                                state.style['endWidth'] = state.style['startWidth'];
                            }
                        }
                    }));
                }

                return handles;
            },
            'swimlane': function (state) {
                var handles = [createHandle(state, [mxConstants.STYLE_STARTSIZE], function (bounds) {
                    var size = parseFloat(mxUtils.getValue(state.style, mxConstants.STYLE_STARTSIZE, mxConstants.DEFAULT_STARTSIZE));

                    if (mxUtils.getValue(state.style, mxConstants.STYLE_HORIZONTAL, 1) == 1) {
                        return new mxPoint(bounds.getCenterX(), bounds.y + Math.max(0, Math.min(bounds.height, size)));
                    } else {
                        return new mxPoint(bounds.x + Math.max(0, Math.min(bounds.width, size)), bounds.getCenterY());
                    }
                }, function (bounds, pt) {
                    state.style[mxConstants.STYLE_STARTSIZE] =
                        (mxUtils.getValue(this.state.style, mxConstants.STYLE_HORIZONTAL, 1) == 1) ?
                            Math.round(Math.max(0, Math.min(bounds.height, pt.y - bounds.y))) :
                            Math.round(Math.max(0, Math.min(bounds.width, pt.x - bounds.x)));
                })];

                if (mxUtils.getValue(state.style, mxConstants.STYLE_ROUNDED)) {
                    var size = parseFloat(mxUtils.getValue(state.style, mxConstants.STYLE_STARTSIZE, mxConstants.DEFAULT_STARTSIZE));
                    handles.push(createArcHandle(state, size / 2));
                }

                return handles;
            },
            'label': createArcHandleFunction(),
            'ext': createArcHandleFunction(),
            'rectangle': createArcHandleFunction(),
            'triangle': createArcHandleFunction(),
            'rhombus': createArcHandleFunction(),
            'umlLifeline': function (state) {
                return [createHandle(state, ['size'], function (bounds) {
                    var size = Math.max(0, Math.min(bounds.height, parseFloat(mxUtils.getValue(this.state.style, 'size', UmlLifeline.prototype.size))));

                    return new mxPoint(bounds.getCenterX(), bounds.y + size);
                }, function (bounds, pt) {
                    this.state.style['size'] = Math.round(Math.max(0, Math.min(bounds.height, pt.y - bounds.y)));
                }, false)];
            },
            'umlFrame': function (state) {
                var handles = [createHandle(state, ['width', 'height'], function (bounds) {
                    var w0 = Math.max(UmlFrame.prototype.corner, Math.min(bounds.width, mxUtils.getValue(this.state.style, 'width', UmlFrame.prototype.width)));
                    var h0 = Math.max(UmlFrame.prototype.corner * 1.5, Math.min(bounds.height, mxUtils.getValue(this.state.style, 'height', UmlFrame.prototype.height)));

                    return new mxPoint(bounds.x + w0, bounds.y + h0);
                }, function (bounds, pt) {
                    this.state.style['width'] = Math.round(Math.max(UmlFrame.prototype.corner, Math.min(bounds.width, pt.x - bounds.x)));
                    this.state.style['height'] = Math.round(Math.max(UmlFrame.prototype.corner * 1.5, Math.min(bounds.height, pt.y - bounds.y)));
                }, false)];

                return handles;
            },
            'process': function (state) {
                var handles = [createHandle(state, ['size'], function (bounds) {
                    var size = Math.max(0, Math.min(0.5, parseFloat(mxUtils.getValue(this.state.style, 'size', ProcessShape.prototype.size))));

                    return new mxPoint(bounds.x + bounds.width * size, bounds.y + bounds.height / 4);
                }, function (bounds, pt) {
                    this.state.style['size'] = Math.max(0, Math.min(0.5, (pt.x - bounds.x) / bounds.width));
                })];

                if (mxUtils.getValue(state.style, mxConstants.STYLE_ROUNDED, false)) {
                    handles.push(createArcHandle(state));
                }

                return handles;
            },
            'cross': function (state) {
                return [createHandle(state, ['size'], function (bounds) {
                    var m = Math.min(bounds.width, bounds.height);
                    var size = Math.max(0, Math.min(1, mxUtils.getValue(this.state.style, 'size', CrossShape.prototype.size))) * m / 2;

                    return new mxPoint(bounds.getCenterX() - size, bounds.getCenterY() - size);
                }, function (bounds, pt) {
                    var m = Math.min(bounds.width, bounds.height);
                    this.state.style['size'] = Math.max(0, Math.min(1, Math.min((Math.max(0, bounds.getCenterY() - pt.y) / m) * 2,
                        (Math.max(0, bounds.getCenterX() - pt.x) / m) * 2)));
                })];
            },
            'note': function (state) {
                return [createHandle(state, ['size'], function (bounds) {
                    var size = Math.max(0, Math.min(bounds.width, Math.min(bounds.height, parseFloat(
                        mxUtils.getValue(this.state.style, 'size', NoteShape.prototype.size)))));

                    return new mxPoint(bounds.x + bounds.width - size, bounds.y + size);
                }, function (bounds, pt) {
                    this.state.style['size'] = Math.round(Math.max(0, Math.min(Math.min(bounds.width, bounds.x + bounds.width - pt.x),
                        Math.min(bounds.height, pt.y - bounds.y))));
                })];
            },
            'manualInput': function (state) {
                var handles = [createHandle(state, ['size'], function (bounds) {
                    var size = Math.max(0, Math.min(bounds.height, mxUtils.getValue(this.state.style, 'size', ManualInputShape.prototype.size)));

                    return new mxPoint(bounds.x + bounds.width / 4, bounds.y + size * 3 / 4);
                }, function (bounds, pt) {
                    this.state.style['size'] = Math.round(Math.max(0, Math.min(bounds.height, (pt.y - bounds.y) * 4 / 3)));
                })];

                if (mxUtils.getValue(state.style, mxConstants.STYLE_ROUNDED, false)) {
                    handles.push(createArcHandle(state));
                }

                return handles;
            },
            'dataStorage': function (state) {
                return [createHandle(state, ['size'], function (bounds) {
                    var size = Math.max(0, Math.min(1, parseFloat(mxUtils.getValue(this.state.style, 'size', DataStorageShape.prototype.size))));

                    return new mxPoint(bounds.x + (1 - size) * bounds.width, bounds.getCenterY());
                }, function (bounds, pt) {
                    this.state.style['size'] = Math.max(0, Math.min(1, (bounds.x + bounds.width - pt.x) / bounds.width));
                })];
            },
            'callout': function (state) {
                var handles = [createHandle(state, ['size', 'position'], function (bounds) {
                    var size = Math.max(0, Math.min(bounds.height, mxUtils.getValue(this.state.style, 'size', CalloutShape.prototype.size)));
                    var position = Math.max(0, Math.min(1, mxUtils.getValue(this.state.style, 'position', CalloutShape.prototype.position)));
                    var base = Math.max(0, Math.min(bounds.width, mxUtils.getValue(this.state.style, 'base', CalloutShape.prototype.base)));

                    return new mxPoint(bounds.x + position * bounds.width, bounds.y + bounds.height - size);
                }, function (bounds, pt) {
                    var base = Math.max(0, Math.min(bounds.width, mxUtils.getValue(this.state.style, 'base', CalloutShape.prototype.base)));
                    this.state.style['size'] = Math.round(Math.max(0, Math.min(bounds.height, bounds.y + bounds.height - pt.y)));
                    this.state.style['position'] = Math.round(Math.max(0, Math.min(1, (pt.x - bounds.x) / bounds.width)) * 100) / 100;
                }), createHandle(state, ['position2'], function (bounds) {
                    var position2 = Math.max(0, Math.min(1, mxUtils.getValue(this.state.style, 'position2', CalloutShape.prototype.position2)));

                    return new mxPoint(bounds.x + position2 * bounds.width, bounds.y + bounds.height);
                }, function (bounds, pt) {
                    this.state.style['position2'] = Math.round(Math.max(0, Math.min(1, (pt.x - bounds.x) / bounds.width)) * 100) / 100;
                }), createHandle(state, ['base'], function (bounds) {
                    var size = Math.max(0, Math.min(bounds.height, mxUtils.getValue(this.state.style, 'size', CalloutShape.prototype.size)));
                    var position = Math.max(0, Math.min(1, mxUtils.getValue(this.state.style, 'position', CalloutShape.prototype.position)));
                    var base = Math.max(0, Math.min(bounds.width, mxUtils.getValue(this.state.style, 'base', CalloutShape.prototype.base)));

                    return new mxPoint(bounds.x + Math.min(bounds.width, position * bounds.width + base), bounds.y + bounds.height - size);
                }, function (bounds, pt) {
                    var position = Math.max(0, Math.min(1, mxUtils.getValue(this.state.style, 'position', CalloutShape.prototype.position)));

                    this.state.style['base'] = Math.round(Math.max(0, Math.min(bounds.width, pt.x - bounds.x - position * bounds.width)));
                })];

                if (mxUtils.getValue(state.style, mxConstants.STYLE_ROUNDED, false)) {
                    handles.push(createArcHandle(state));
                }

                return handles;
            },
            'internalStorage': function (state) {
                var handles = [createHandle(state, ['dx', 'dy'], function (bounds) {
                    var dx = Math.max(0, Math.min(bounds.width, mxUtils.getValue(this.state.style, 'dx', InternalStorageShape.prototype.dx)));
                    var dy = Math.max(0, Math.min(bounds.height, mxUtils.getValue(this.state.style, 'dy', InternalStorageShape.prototype.dy)));

                    return new mxPoint(bounds.x + dx, bounds.y + dy);
                }, function (bounds, pt) {
                    this.state.style['dx'] = Math.round(Math.max(0, Math.min(bounds.width, pt.x - bounds.x)));
                    this.state.style['dy'] = Math.round(Math.max(0, Math.min(bounds.height, pt.y - bounds.y)));
                })];

                if (mxUtils.getValue(state.style, mxConstants.STYLE_ROUNDED, false)) {
                    handles.push(createArcHandle(state));
                }

                return handles;
            },
            'corner': function (state) {
                return [createHandle(state, ['dx', 'dy'], function (bounds) {
                    var dx = Math.max(0, Math.min(bounds.width, mxUtils.getValue(this.state.style, 'dx', CornerShape.prototype.dx)));
                    var dy = Math.max(0, Math.min(bounds.height, mxUtils.getValue(this.state.style, 'dy', CornerShape.prototype.dy)));

                    return new mxPoint(bounds.x + dx, bounds.y + dy);
                }, function (bounds, pt) {
                    this.state.style['dx'] = Math.round(Math.max(0, Math.min(bounds.width, pt.x - bounds.x)));
                    this.state.style['dy'] = Math.round(Math.max(0, Math.min(bounds.height, pt.y - bounds.y)));
                })];
            },
            'tee': function (state) {
                return [createHandle(state, ['dx', 'dy'], function (bounds) {
                    var dx = Math.max(0, Math.min(bounds.width, mxUtils.getValue(this.state.style, 'dx', TeeShape.prototype.dx)));
                    var dy = Math.max(0, Math.min(bounds.height, mxUtils.getValue(this.state.style, 'dy', TeeShape.prototype.dy)));

                    return new mxPoint(bounds.x + (bounds.width + dx) / 2, bounds.y + dy);
                }, function (bounds, pt) {
                    this.state.style['dx'] = Math.round(Math.max(0, Math.min(bounds.width / 2, (pt.x - bounds.x - bounds.width / 2)) * 2));
                    this.state.style['dy'] = Math.round(Math.max(0, Math.min(bounds.height, pt.y - bounds.y)));
                })];
            },
            'singleArrow': createArrowHandleFunction(1),
            'doubleArrow': createArrowHandleFunction(0.5),
            'folder': function (state) {
                return [createHandle(state, ['tabWidth', 'tabHeight'], function (bounds) {
                    var tw = Math.max(0, Math.min(bounds.width, mxUtils.getValue(this.state.style, 'tabWidth', FolderShape.prototype.tabWidth)));
                    var th = Math.max(0, Math.min(bounds.height, mxUtils.getValue(this.state.style, 'tabHeight', FolderShape.prototype.tabHeight)));

                    if (mxUtils.getValue(this.state.style, 'tabPosition', FolderShape.prototype.tabPosition) == mxConstants.ALIGN_RIGHT) {
                        tw = bounds.width - tw;
                    }

                    return new mxPoint(bounds.x + tw, bounds.y + th);
                }, function (bounds, pt) {
                    var tw = Math.max(0, Math.min(bounds.width, pt.x - bounds.x));

                    if (mxUtils.getValue(this.state.style, 'tabPosition', FolderShape.prototype.tabPosition) == mxConstants.ALIGN_RIGHT) {
                        tw = bounds.width - tw;
                    }

                    this.state.style['tabWidth'] = Math.round(tw);
                    this.state.style['tabHeight'] = Math.round(Math.max(0, Math.min(bounds.height, pt.y - bounds.y)));
                })];
            },
            'document': function (state) {
                return [createHandle(state, ['size'], function (bounds) {
                    var size = Math.max(0, Math.min(1, parseFloat(mxUtils.getValue(this.state.style, 'size', DocumentShape.prototype.size))));

                    return new mxPoint(bounds.x + 3 * bounds.width / 4, bounds.y + (1 - size) * bounds.height);
                }, function (bounds, pt) {
                    this.state.style['size'] = Math.max(0, Math.min(1, (bounds.y + bounds.height - pt.y) / bounds.height));
                })];
            },
            'tape': function (state) {
                return [createHandle(state, ['size'], function (bounds) {
                    var size = Math.max(0, Math.min(1, parseFloat(mxUtils.getValue(this.state.style, 'size', TapeShape.prototype.size))));

                    return new mxPoint(bounds.getCenterX(), bounds.y + size * bounds.height / 2);
                }, function (bounds, pt) {
                    this.state.style['size'] = Math.max(0, Math.min(1, ((pt.y - bounds.y) / bounds.height) * 2));
                })];
            },
            'offPageConnector': function (state) {
                return [createHandle(state, ['size'], function (bounds) {
                    var size = Math.max(0, Math.min(1, parseFloat(mxUtils.getValue(this.state.style, 'size', OffPageConnectorShape.prototype.size))));

                    return new mxPoint(bounds.getCenterX(), bounds.y + (1 - size) * bounds.height);
                }, function (bounds, pt) {
                    this.state.style['size'] = Math.max(0, Math.min(1, (bounds.y + bounds.height - pt.y) / bounds.height));
                })];
            },
            'step': createDisplayHandleFunction(StepShape.prototype.size, true, null, true, StepShape.prototype.fixedSize),
            'hexagon': createDisplayHandleFunction(HexagonShape.prototype.size, true, 0.5, true),
            'curlyBracket': createDisplayHandleFunction(CurlyBracketShape.prototype.size, false),
            'display': createDisplayHandleFunction(DisplayShape.prototype.size, false),
            'cube': createCubeHandleFunction(1, CubeShape.prototype.size, false),
            'card': createCubeHandleFunction(0.5, CardShape.prototype.size, true),
            'loopLimit': createCubeHandleFunction(0.5, LoopLimitShape.prototype.size, true),
            'trapezoid': createTrapezoidHandleFunction(0.5),
            'parallelogram': createTrapezoidHandleFunction(1)
        };

        // Exposes custom handles
        Graph.createHandle = createHandle;
        Graph.handleFactory = handleFactory;

        mxVertexHandler.prototype.createCustomHandles = function () {
            // Not rotatable means locked
            if (this.state.view.graph.getSelectionCount() == 1) {
                if (this.graph.isCellRotatable(this.state.cell))
                // LATER: Make locked state independent of rotatable flag, fix toggle if default is false
                //if (this.graph.isCellResizable(this.state.cell) || this.graph.isCellMovable(this.state.cell))
                {
                    var name = this.state.style['shape'];

                    if (mxCellRenderer.defaultShapes[name] == null &&
                        mxStencilRegistry.getStencil(name) == null) {
                        name = mxConstants.SHAPE_RECTANGLE;
                    }

                    var fn = handleFactory[name];

                    if (fn == null && this.state.shape != null && this.state.shape.isRoundable()) {
                        fn = handleFactory[mxConstants.SHAPE_RECTANGLE];
                    }

                    if (fn != null) {
                        return fn(this.state);
                    }
                }
            }

            return null;
        };

        mxEdgeHandler.prototype.createCustomHandles = function () {
            if (this.state.view.graph.getSelectionCount() == 1) {
                var name = this.state.style['shape'];

                if (mxCellRenderer.defaultShapes[name] == null &&
                    mxStencilRegistry.getStencil(name) == null) {
                    name = mxConstants.SHAPE_CONNECTOR;
                }

                var fn = handleFactory[name];

                if (fn != null) {
                    return fn(this.state);
                }
            }

            return null;
        }
    } else {
        // Dummy entries to avoid NPE in embed mode
        Graph.createHandle = function () {
        };
        Graph.handleFactory = {};
    }

    var isoHVector = new mxPoint(1, 0);
    var isoVVector = new mxPoint(1, 0);

    var alpha1 = mxUtils.toRadians(-30);

    var cos1 = Math.cos(alpha1);
    var sin1 = Math.sin(alpha1);

    isoHVector = mxUtils.getRotatedPoint(isoHVector, cos1, sin1);

    var alpha2 = mxUtils.toRadians(-150);

    var cos2 = Math.cos(alpha2);
    var sin2 = Math.sin(alpha2);

    isoVVector = mxUtils.getRotatedPoint(isoVVector, cos2, sin2);

    mxEdgeStyle.IsometricConnector = function (state, source, target, points, result) {
        var view = state.view;
        var pt = (points != null && points.length > 0) ? points[0] : null;
        var pts = state.absolutePoints;
        var p0 = pts[0];
        var pe = pts[pts.length - 1];

        if (pt != null) {
            pt = view.transformControlPoint(state, pt);
        }

        if (p0 == null) {
            if (source != null) {
                p0 = new mxPoint(source.getCenterX(), source.getCenterY());
            }
        }

        if (pe == null) {
            if (target != null) {
                pe = new mxPoint(target.getCenterX(), target.getCenterY());
            }
        }

        var a1 = isoHVector.x;
        var a2 = isoHVector.y;

        var b1 = isoVVector.x;
        var b2 = isoVVector.y;

        var elbow = mxUtils.getValue(state.style, 'elbow', 'horizontal') == 'horizontal';

        if (pe != null && p0 != null) {
            var last = p0;

            function isoLineTo(x, y, ignoreFirst) {
                var c1 = x - last.x;
                var c2 = y - last.y;

                // Solves for isometric base vectors
                var h = (b2 * c1 - b1 * c2) / (a1 * b2 - a2 * b1);
                var v = (a2 * c1 - a1 * c2) / (a2 * b1 - a1 * b2);

                if (elbow) {
                    if (ignoreFirst) {
                        last = new mxPoint(last.x + a1 * h, last.y + a2 * h);
                        result.push(last);
                    }

                    last = new mxPoint(last.x + b1 * v, last.y + b2 * v);
                    result.push(last);
                } else {
                    if (ignoreFirst) {
                        last = new mxPoint(last.x + b1 * v, last.y + b2 * v);
                        result.push(last);
                    }

                    last = new mxPoint(last.x + a1 * h, last.y + a2 * h);
                    result.push(last);
                }
            };

            if (pt == null) {
                pt = new mxPoint(p0.x + (pe.x - p0.x) / 2, p0.y + (pe.y - p0.y) / 2);
            }

            isoLineTo(pt.x, pt.y, true);
            isoLineTo(pe.x, pe.y, false);
        }
    };

    mxStyleRegistry.putValue('isometricEdgeStyle', mxEdgeStyle.IsometricConnector);

    var graphCreateEdgeHandler = Graph.prototype.createEdgeHandler;
    Graph.prototype.createEdgeHandler = function (state, edgeStyle) {
        if (edgeStyle == mxEdgeStyle.IsometricConnector) {
            var handler = new mxElbowEdgeHandler(state);
            handler.snapToTerminals = false;

            return handler;
        }

        return graphCreateEdgeHandler.apply(this, arguments);
    };

    // Defines connection points for all shapes
    IsoRectangleShape.prototype.constraints = [];

    IsoCubeShape.prototype.getConstraints = function (style, w, h) {
        var constr = [];
        var tan30 = Math.tan(mxUtils.toRadians(30));
        var tan30Dx = (0.5 - tan30) / 2;
        var m = Math.min(w, h / (0.5 + tan30));
        var dx = (w - m) / 2;
        var dy = (h - m) / 2;

        constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, dx, dy + 0.25 * m));
        constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, dx + 0.5 * m, dy + m * tan30Dx));
        constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, dx + m, dy + 0.25 * m));
        constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, dx + m, dy + 0.75 * m));
        constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, dx + 0.5 * m, dy + (1 - tan30Dx) * m));
        constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, dx, dy + 0.75 * m));

        return (constr);
    };

    CalloutShape.prototype.getConstraints = function (style, w, h) {
        var constr = [];
        var arcSize = mxUtils.getValue(this.style, mxConstants.STYLE_ARCSIZE, mxConstants.LINE_ARCSIZE) / 2;
        var s = Math.max(0, Math.min(h, parseFloat(mxUtils.getValue(this.style, 'size', this.size))));
        var dx = w * Math.max(0, Math.min(1, parseFloat(mxUtils.getValue(this.style, 'position', this.position))));
        var dx2 = w * Math.max(0, Math.min(1, parseFloat(mxUtils.getValue(this.style, 'position2', this.position2))));
        var base = Math.max(0, Math.min(w, parseFloat(mxUtils.getValue(this.style, 'base', this.base))));

        constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false));
        constr.push(new mxConnectionConstraint(new mxPoint(0.25, 0), false));
        constr.push(new mxConnectionConstraint(new mxPoint(0.5, 0), false));
        constr.push(new mxConnectionConstraint(new mxPoint(0.75, 0), false));
        constr.push(new mxConnectionConstraint(new mxPoint(1, 0), false));
        constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, w, (h - s) * 0.5));
        constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, w, h - s));
        constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, dx2, h));
        constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, 0, h - s));
        constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, 0, (h - s) * 0.5));

        if (w >= s * 2) {
            constr.push(new mxConnectionConstraint(new mxPoint(0.5, 0), false));
        }

        return (constr);
    };

    mxRectangleShape.prototype.constraints = [new mxConnectionConstraint(new mxPoint(0.25, 0), true),
        new mxConnectionConstraint(new mxPoint(0.5, 0), true),
        new mxConnectionConstraint(new mxPoint(0.75, 0), true),
        new mxConnectionConstraint(new mxPoint(0, 0.25), true),
        new mxConnectionConstraint(new mxPoint(0, 0.5), true),
        new mxConnectionConstraint(new mxPoint(0, 0.75), true),
        new mxConnectionConstraint(new mxPoint(1, 0.25), true),
        new mxConnectionConstraint(new mxPoint(1, 0.5), true),
        new mxConnectionConstraint(new mxPoint(1, 0.75), true),
        new mxConnectionConstraint(new mxPoint(0.25, 1), true),
        new mxConnectionConstraint(new mxPoint(0.5, 1), true),
        new mxConnectionConstraint(new mxPoint(0.75, 1), true)];
    mxEllipse.prototype.constraints = [new mxConnectionConstraint(new mxPoint(0, 0), true), new mxConnectionConstraint(new mxPoint(1, 0), true),
        new mxConnectionConstraint(new mxPoint(0, 1), true), new mxConnectionConstraint(new mxPoint(1, 1), true),
        new mxConnectionConstraint(new mxPoint(0.5, 0), true), new mxConnectionConstraint(new mxPoint(0.5, 1), true),
        new mxConnectionConstraint(new mxPoint(0, 0.5), true), new mxConnectionConstraint(new mxPoint(1, 0.5))];
    mxLabel.prototype.constraints = mxRectangleShape.prototype.constraints;
    mxImageShape.prototype.constraints = mxRectangleShape.prototype.constraints;
    mxSwimlane.prototype.constraints = mxRectangleShape.prototype.constraints;
    PlusShape.prototype.constraints = mxRectangleShape.prototype.constraints;

    NoteShape.prototype.getConstraints = function (style, w, h) {
        var constr = [];
        var s = Math.max(0, Math.min(w, Math.min(h, parseFloat(mxUtils.getValue(this.style, 'size', this.size)))));

        constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false));
        constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, (w - s) * 0.5, 0));
        constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, w - s, 0));
        constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, w - s * 0.5, s * 0.5));
        constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, w, s));
        constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, w, (h + s) * 0.5));
        constr.push(new mxConnectionConstraint(new mxPoint(1, 1), false));
        constr.push(new mxConnectionConstraint(new mxPoint(0.5, 1), false));
        constr.push(new mxConnectionConstraint(new mxPoint(0, 1), false));
        constr.push(new mxConnectionConstraint(new mxPoint(0, 0.5), false));

        if (w >= s * 2) {
            constr.push(new mxConnectionConstraint(new mxPoint(0.5, 0), false));
        }

        return (constr);
    };

    CardShape.prototype.getConstraints = function (style, w, h) {
        var constr = [];
        var s = Math.max(0, Math.min(w, Math.min(h, parseFloat(mxUtils.getValue(this.style, 'size', this.size)))));

        constr.push(new mxConnectionConstraint(new mxPoint(1, 0), false));
        constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, (w + s) * 0.5, 0));
        constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, s, 0));
        constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, s * 0.5, s * 0.5));
        constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, 0, s));
        constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, 0, (h + s) * 0.5));
        constr.push(new mxConnectionConstraint(new mxPoint(0, 1), false));
        constr.push(new mxConnectionConstraint(new mxPoint(0.5, 1), false));
        constr.push(new mxConnectionConstraint(new mxPoint(1, 1), false));
        constr.push(new mxConnectionConstraint(new mxPoint(1, 0.5), false));

        if (w >= s * 2) {
            constr.push(new mxConnectionConstraint(new mxPoint(0.5, 0), false));
        }

        return (constr);
    };

    CubeShape.prototype.getConstraints = function (style, w, h) {
        var constr = [];
        var s = Math.max(0, Math.min(w, Math.min(h, parseFloat(mxUtils.getValue(this.style, 'size', this.size)))));

        constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false));
        constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, (w - s) * 0.5, 0));
        constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, w - s, 0));
        constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, w - s * 0.5, s * 0.5));
        constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, w, s));
        constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, w, (h + s) * 0.5));
        constr.push(new mxConnectionConstraint(new mxPoint(1, 1), false));
        constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, (w + s) * 0.5, h));
        constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, s, h));
        constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, s * 0.5, h - s * 0.5));
        constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, 0, h - s));
        constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, 0, (h - s) * 0.5));

        return (constr);
    };

    FolderShape.prototype.getConstraints = function (style, w, h) {
        var constr = [];
        var dx = Math.max(0, Math.min(w, parseFloat(mxUtils.getValue(this.style, 'tabWidth', this.tabWidth))));
        var dy = Math.max(0, Math.min(h, parseFloat(mxUtils.getValue(this.style, 'tabHeight', this.tabHeight))));
        var tp = mxUtils.getValue(this.style, 'tabPosition', this.tabPosition);

        if (tp == 'left') {
            constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false));
            constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, dx * 0.5, 0));
            constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, dx, 0));
            constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, dx, dy));
            constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, (w + dx) * 0.5, dy));
        } else {
            constr.push(new mxConnectionConstraint(new mxPoint(1, 0), false));
            constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, w - dx * 0.5, 0));
            constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, w - dx, 0));
            constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, w - dx, dy));
            constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, (w - dx) * 0.5, dy));
        }

        constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, w, dy));
        constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, w, (h - dy) * 0.25 + dy));
        constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, w, (h - dy) * 0.5 + dy));
        constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, w, (h - dy) * 0.75 + dy));
        constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, w, h));
        constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, 0, dy));
        constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, 0, (h - dy) * 0.25 + dy));
        constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, 0, (h - dy) * 0.5 + dy));
        constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, 0, (h - dy) * 0.75 + dy));
        constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, 0, h));
        constr.push(new mxConnectionConstraint(new mxPoint(0.25, 1), false));
        constr.push(new mxConnectionConstraint(new mxPoint(0.5, 1), false));
        constr.push(new mxConnectionConstraint(new mxPoint(0.75, 1), false));

        return (constr);
    }

    InternalStorageShape.prototype.constraints = mxRectangleShape.prototype.constraints;
    DataStorageShape.prototype.constraints = mxRectangleShape.prototype.constraints;
    TapeDataShape.prototype.constraints = mxEllipse.prototype.constraints;
    OrEllipseShape.prototype.constraints = mxEllipse.prototype.constraints;
    SumEllipseShape.prototype.constraints = mxEllipse.prototype.constraints;
    LineEllipseShape.prototype.constraints = mxEllipse.prototype.constraints;
    ManualInputShape.prototype.constraints = mxRectangleShape.prototype.constraints;
    DelayShape.prototype.constraints = mxRectangleShape.prototype.constraints;

    DisplayShape.prototype.getConstraints = function (style, w, h) {
        var constr = [];
        var dx = Math.min(w, h / 2);
        var s = Math.min(w - dx, Math.max(0, parseFloat(mxUtils.getValue(this.style, 'size', this.size))) * w);

        constr.push(new mxConnectionConstraint(new mxPoint(0, 0.5), false, null));
        constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, s, 0));
        constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, (s + w - dx) * 0.5, 0));
        constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, w - dx, 0));
        constr.push(new mxConnectionConstraint(new mxPoint(1, 0.5), false, null));
        constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, w - dx, h));
        constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, (s + w - dx) * 0.5, h));
        constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, s, h));

        return (constr);
    };

    LoopLimitShape.prototype.constraints = mxRectangleShape.prototype.constraints;
    OffPageConnectorShape.prototype.constraints = mxRectangleShape.prototype.constraints;
    mxCylinder.prototype.constraints = [new mxConnectionConstraint(new mxPoint(0.15, 0.05), false),
        new mxConnectionConstraint(new mxPoint(0.5, 0), true),
        new mxConnectionConstraint(new mxPoint(0.85, 0.05), false),
        new mxConnectionConstraint(new mxPoint(0, 0.3), true),
        new mxConnectionConstraint(new mxPoint(0, 0.5), true),
        new mxConnectionConstraint(new mxPoint(0, 0.7), true),
        new mxConnectionConstraint(new mxPoint(1, 0.3), true),
        new mxConnectionConstraint(new mxPoint(1, 0.5), true),
        new mxConnectionConstraint(new mxPoint(1, 0.7), true),
        new mxConnectionConstraint(new mxPoint(0.15, 0.95), false),
        new mxConnectionConstraint(new mxPoint(0.5, 1), true),
        new mxConnectionConstraint(new mxPoint(0.85, 0.95), false)];
    UmlActorShape.prototype.constraints = [new mxConnectionConstraint(new mxPoint(0.25, 0.1), false),
        new mxConnectionConstraint(new mxPoint(0.5, 0), false),
        new mxConnectionConstraint(new mxPoint(0.75, 0.1), false),
        new mxConnectionConstraint(new mxPoint(0, 1 / 3), false),
        new mxConnectionConstraint(new mxPoint(0, 1), false),
        new mxConnectionConstraint(new mxPoint(1, 1 / 3), false),
        new mxConnectionConstraint(new mxPoint(1, 1), false),
        new mxConnectionConstraint(new mxPoint(0.5, 0.5), false)];
    ComponentShape.prototype.constraints = [new mxConnectionConstraint(new mxPoint(0.25, 0), true),
        new mxConnectionConstraint(new mxPoint(0.5, 0), true),
        new mxConnectionConstraint(new mxPoint(0.75, 0), true),
        new mxConnectionConstraint(new mxPoint(0, 0.3), true),
        new mxConnectionConstraint(new mxPoint(0, 0.7), true),
        new mxConnectionConstraint(new mxPoint(1, 0.25), true),
        new mxConnectionConstraint(new mxPoint(1, 0.5), true),
        new mxConnectionConstraint(new mxPoint(1, 0.75), true),
        new mxConnectionConstraint(new mxPoint(0.25, 1), true),
        new mxConnectionConstraint(new mxPoint(0.5, 1), true),
        new mxConnectionConstraint(new mxPoint(0.75, 1), true)];
    mxActor.prototype.constraints = [new mxConnectionConstraint(new mxPoint(0.5, 0), true),
        new mxConnectionConstraint(new mxPoint(0.25, 0.2), false),
        new mxConnectionConstraint(new mxPoint(0.1, 0.5), false),
        new mxConnectionConstraint(new mxPoint(0, 0.75), true),
        new mxConnectionConstraint(new mxPoint(0.75, 0.25), false),
        new mxConnectionConstraint(new mxPoint(0.9, 0.5), false),
        new mxConnectionConstraint(new mxPoint(1, 0.75), true),
        new mxConnectionConstraint(new mxPoint(0.25, 1), true),
        new mxConnectionConstraint(new mxPoint(0.5, 1), true),
        new mxConnectionConstraint(new mxPoint(0.75, 1), true)];
    SwitchShape.prototype.constraints = [new mxConnectionConstraint(new mxPoint(0, 0), false),
        new mxConnectionConstraint(new mxPoint(0.5, 0.25), false),
        new mxConnectionConstraint(new mxPoint(1, 0), false),
        new mxConnectionConstraint(new mxPoint(0.25, 0.5), false),
        new mxConnectionConstraint(new mxPoint(0.75, 0.5), false),
        new mxConnectionConstraint(new mxPoint(0, 1), false),
        new mxConnectionConstraint(new mxPoint(0.5, 0.75), false),
        new mxConnectionConstraint(new mxPoint(1, 1), false)];
    TapeShape.prototype.constraints = [new mxConnectionConstraint(new mxPoint(0, 0.35), false),
        new mxConnectionConstraint(new mxPoint(0, 0.5), false),
        new mxConnectionConstraint(new mxPoint(0, 0.65), false),
        new mxConnectionConstraint(new mxPoint(1, 0.35), false),
        new mxConnectionConstraint(new mxPoint(1, 0.5), false),
        new mxConnectionConstraint(new mxPoint(1, 0.65), false),
        new mxConnectionConstraint(new mxPoint(0.25, 1), false),
        new mxConnectionConstraint(new mxPoint(0.75, 0), false)];
    StepShape.prototype.constraints = [new mxConnectionConstraint(new mxPoint(0.25, 0), true),
        new mxConnectionConstraint(new mxPoint(0.5, 0), true),
        new mxConnectionConstraint(new mxPoint(0.75, 0), true),
        new mxConnectionConstraint(new mxPoint(0.25, 1), true),
        new mxConnectionConstraint(new mxPoint(0.5, 1), true),
        new mxConnectionConstraint(new mxPoint(0.75, 1), true),
        new mxConnectionConstraint(new mxPoint(0, 0.25), true),
        new mxConnectionConstraint(new mxPoint(0, 0.5), true),
        new mxConnectionConstraint(new mxPoint(0, 0.75), true),
        new mxConnectionConstraint(new mxPoint(1, 0.25), true),
        new mxConnectionConstraint(new mxPoint(1, 0.5), true),
        new mxConnectionConstraint(new mxPoint(1, 0.75), true)];
    mxLine.prototype.constraints = [new mxConnectionConstraint(new mxPoint(0, 0.5), false),
        new mxConnectionConstraint(new mxPoint(0.25, 0.5), false),
        new mxConnectionConstraint(new mxPoint(0.75, 0.5), false),
        new mxConnectionConstraint(new mxPoint(1, 0.5), false)];
    LollipopShape.prototype.constraints = [new mxConnectionConstraint(new mxPoint(0.5, 0), false),
        new mxConnectionConstraint(new mxPoint(0.5, 1), false)];
    mxDoubleEllipse.prototype.constraints = mxEllipse.prototype.constraints;
    mxRhombus.prototype.constraints = mxEllipse.prototype.constraints;
    mxTriangle.prototype.constraints = [new mxConnectionConstraint(new mxPoint(0, 0.25), true),
        new mxConnectionConstraint(new mxPoint(0, 0.5), true),
        new mxConnectionConstraint(new mxPoint(0, 0.75), true),
        new mxConnectionConstraint(new mxPoint(0.5, 0), true),
        new mxConnectionConstraint(new mxPoint(0.5, 1), true),
        new mxConnectionConstraint(new mxPoint(1, 0.5), true)];
    mxHexagon.prototype.constraints = [new mxConnectionConstraint(new mxPoint(0.375, 0), true),
        new mxConnectionConstraint(new mxPoint(0.5, 0), true),
        new mxConnectionConstraint(new mxPoint(0.625, 0), true),
        new mxConnectionConstraint(new mxPoint(0, 0.25), true),
        new mxConnectionConstraint(new mxPoint(0, 0.5), true),
        new mxConnectionConstraint(new mxPoint(0, 0.75), true),
        new mxConnectionConstraint(new mxPoint(1, 0.25), true),
        new mxConnectionConstraint(new mxPoint(1, 0.5), true),
        new mxConnectionConstraint(new mxPoint(1, 0.75), true),
        new mxConnectionConstraint(new mxPoint(0.375, 1), true),
        new mxConnectionConstraint(new mxPoint(0.5, 1), true),
        new mxConnectionConstraint(new mxPoint(0.625, 1), true)];
    mxCloud.prototype.constraints = [new mxConnectionConstraint(new mxPoint(0.25, 0.25), false),
        new mxConnectionConstraint(new mxPoint(0.4, 0.1), false),
        new mxConnectionConstraint(new mxPoint(0.16, 0.55), false),
        new mxConnectionConstraint(new mxPoint(0.07, 0.4), false),
        new mxConnectionConstraint(new mxPoint(0.31, 0.8), false),
        new mxConnectionConstraint(new mxPoint(0.13, 0.77), false),
        new mxConnectionConstraint(new mxPoint(0.8, 0.8), false),
        new mxConnectionConstraint(new mxPoint(0.55, 0.95), false),
        new mxConnectionConstraint(new mxPoint(0.875, 0.5), false),
        new mxConnectionConstraint(new mxPoint(0.96, 0.7), false),
        new mxConnectionConstraint(new mxPoint(0.625, 0.2), false),
        new mxConnectionConstraint(new mxPoint(0.88, 0.25), false)];
    ParallelogramShape.prototype.constraints = mxRectangleShape.prototype.constraints;
    TrapezoidShape.prototype.constraints = mxRectangleShape.prototype.constraints;
    DocumentShape.prototype.constraints = [new mxConnectionConstraint(new mxPoint(0.25, 0), true),
        new mxConnectionConstraint(new mxPoint(0.5, 0), true),
        new mxConnectionConstraint(new mxPoint(0.75, 0), true),
        new mxConnectionConstraint(new mxPoint(0, 0.25), true),
        new mxConnectionConstraint(new mxPoint(0, 0.5), true),
        new mxConnectionConstraint(new mxPoint(0, 0.75), true),
        new mxConnectionConstraint(new mxPoint(1, 0.25), true),
        new mxConnectionConstraint(new mxPoint(1, 0.5), true),
        new mxConnectionConstraint(new mxPoint(1, 0.75), true)];
    mxArrow.prototype.constraints = null;

    TeeShape.prototype.getConstraints = function (style, w, h) {
        var constr = [];
        var dx = Math.max(0, Math.min(w, parseFloat(mxUtils.getValue(this.style, 'dx', this.dx))));
        var dy = Math.max(0, Math.min(h, parseFloat(mxUtils.getValue(this.style, 'dy', this.dy))));
        var w2 = Math.abs(w - dx) / 2;

        constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false));
        constr.push(new mxConnectionConstraint(new mxPoint(0.5, 0), false));
        constr.push(new mxConnectionConstraint(new mxPoint(1, 0), false));
        constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, w, dy * 0.5));
        constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, w, dy));
        constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, w * 0.75 + dx * 0.25, dy));
        constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, (w + dx) * 0.5, dy));
        constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, (w + dx) * 0.5, (h + dy) * 0.5));
        constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, (w + dx) * 0.5, h));
        constr.push(new mxConnectionConstraint(new mxPoint(0.5, 1), false));
        constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, (w - dx) * 0.5, h));
        constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, (w - dx) * 0.5, (h + dy) * 0.5));
        constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, (w - dx) * 0.5, dy));
        constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, w * 0.25 - dx * 0.25, dy));
        constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, 0, dy));
        constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, 0, dy * 0.5));

        return (constr);
    };

    CornerShape.prototype.getConstraints = function (style, w, h) {
        var constr = [];
        var dx = Math.max(0, Math.min(w, parseFloat(mxUtils.getValue(this.style, 'dx', this.dx))));
        var dy = Math.max(0, Math.min(h, parseFloat(mxUtils.getValue(this.style, 'dy', this.dy))));

        constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false));
        constr.push(new mxConnectionConstraint(new mxPoint(0.5, 0), false));
        constr.push(new mxConnectionConstraint(new mxPoint(1, 0), false));
        constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, w, dy * 0.5));
        constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, w, dy));
        constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, (w + dx) * 0.5, dy));
        constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, dx, dy));
        constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, dx, (h + dy) * 0.5));
        constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, dx, h));
        constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, dx * 0.5, h));
        constr.push(new mxConnectionConstraint(new mxPoint(0, 0.5), false));
        constr.push(new mxConnectionConstraint(new mxPoint(0, 1), false));

        return (constr);
    };

    CrossbarShape.prototype.constraints = [new mxConnectionConstraint(new mxPoint(0, 0), false),
        new mxConnectionConstraint(new mxPoint(0, 0.5), false),
        new mxConnectionConstraint(new mxPoint(0, 1), false),
        new mxConnectionConstraint(new mxPoint(0.25, 0.5), false),
        new mxConnectionConstraint(new mxPoint(0.5, 0.5), false),
        new mxConnectionConstraint(new mxPoint(0.75, 0.5), false),
        new mxConnectionConstraint(new mxPoint(1, 0), false),
        new mxConnectionConstraint(new mxPoint(1, 0.5), false),
        new mxConnectionConstraint(new mxPoint(1, 1), false)];

    SingleArrowShape.prototype.getConstraints = function (style, w, h) {
        var constr = [];
        var aw = h * Math.max(0, Math.min(1, parseFloat(mxUtils.getValue(this.style, 'arrowWidth', this.arrowWidth))));
        var as = w * Math.max(0, Math.min(1, parseFloat(mxUtils.getValue(this.style, 'arrowSize', this.arrowSize))));
        var at = (h - aw) / 2;
        var ab = at + aw;

        constr.push(new mxConnectionConstraint(new mxPoint(0, 0.5), false));
        constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, 0, at));
        constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, (w - as) * 0.5, at));
        constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, w - as, 0));
        constr.push(new mxConnectionConstraint(new mxPoint(1, 0.5), false));
        constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, w - as, h));
        constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, (w - as) * 0.5, h - at));
        constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, 0, h - at));

        return (constr);
    };

    DoubleArrowShape.prototype.getConstraints = function (style, w, h) {
        var constr = [];
        var aw = h * Math.max(0, Math.min(1, parseFloat(mxUtils.getValue(this.style, 'arrowWidth', SingleArrowShape.prototype.arrowWidth))));
        var as = w * Math.max(0, Math.min(1, parseFloat(mxUtils.getValue(this.style, 'arrowSize', SingleArrowShape.prototype.arrowSize))));
        var at = (h - aw) / 2;
        var ab = at + aw;

        constr.push(new mxConnectionConstraint(new mxPoint(0, 0.5), false));
        constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, as, 0));
        constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, w * 0.5, at));
        constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, w - as, 0));
        constr.push(new mxConnectionConstraint(new mxPoint(1, 0.5), false));
        constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, w - as, h));
        constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, w * 0.5, h - at));
        constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, as, h));

        return (constr);
    };

    CrossShape.prototype.getConstraints = function (style, w, h) {
        var constr = [];
        var m = Math.min(h, w);
        var size = Math.max(0, Math.min(m, m * parseFloat(mxUtils.getValue(this.style, 'size', this.size))));
        var t = (h - size) / 2;
        var b = t + size;
        var l = (w - size) / 2;
        var r = l + size;

        constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, l, t * 0.5));
        constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, l, 0));
        constr.push(new mxConnectionConstraint(new mxPoint(0.5, 0), false));
        constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, r, 0));
        constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, r, t * 0.5));
        constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, r, t));
        constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, l, h - t * 0.5));
        constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, l, h));
        constr.push(new mxConnectionConstraint(new mxPoint(0.5, 1), false));
        constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, r, h));
        constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, r, h - t * 0.5));
        constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, r, b));
        constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, (w + r) * 0.5, t));
        constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, w, t));
        constr.push(new mxConnectionConstraint(new mxPoint(1, 0.5), false));
        constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, w, b));
        constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, (w + r) * 0.5, b));
        constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, l, b));
        constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, l * 0.5, t));
        constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, 0, t));
        constr.push(new mxConnectionConstraint(new mxPoint(0, 0.5), false));
        constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, 0, b));
        constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, l * 0.5, b));
        constr.push(new mxConnectionConstraint(new mxPoint(0, 0), false, null, l, t));

        return (constr);
    };

    UmlLifeline.prototype.constraints = null;
    OrShape.prototype.constraints = [new mxConnectionConstraint(new mxPoint(0, 0.25), false),
        new mxConnectionConstraint(new mxPoint(0, 0.5), false),
        new mxConnectionConstraint(new mxPoint(0, 0.75), false),
        new mxConnectionConstraint(new mxPoint(1, 0.5), false),
        new mxConnectionConstraint(new mxPoint(0.7, 0.1), false),
        new mxConnectionConstraint(new mxPoint(0.7, 0.9), false)];
    XorShape.prototype.constraints = [new mxConnectionConstraint(new mxPoint(0.175, 0.25), false),
        new mxConnectionConstraint(new mxPoint(0.25, 0.5), false),
        new mxConnectionConstraint(new mxPoint(0.175, 0.75), false),
        new mxConnectionConstraint(new mxPoint(1, 0.5), false),
        new mxConnectionConstraint(new mxPoint(0.7, 0.1), false),
        new mxConnectionConstraint(new mxPoint(0.7, 0.9), false)];
    RequiredInterfaceShape.prototype.constraints = [new mxConnectionConstraint(new mxPoint(0, 0.5), false),
        new mxConnectionConstraint(new mxPoint(1, 0.5), false)];
    ProvidedRequiredInterfaceShape.prototype.constraints = [new mxConnectionConstraint(new mxPoint(0, 0.5), false),
        new mxConnectionConstraint(new mxPoint(1, 0.5), false)];
})();

/**
 * Copyright (c) 2006-2012, JGraph Ltd
 */
/**
 * Constructs the actions object for the given UI.
 */
function Actions(editorUi) {
    this.editorUi = editorUi;
    this.actions = new Object();
    this.init();
};

/**
 * Adds the default actions.
 */
Actions.prototype.init = function () {
    var ui = this.editorUi;
    var editor = ui.editor;
    var graph = editor.graph;
    var isGraphEnabled = function () {
        return Action.prototype.isEnabled.apply(this, arguments) && graph.isEnabled();
    };

    // File actions
    this.addAction('new...', function () {
        graph.openLink(ui.getUrl());
    });
    this.addAction('open...', function () {
        window.openNew = true;
        window.openKey = 'open';

        ui.openFile();
    });
    this.addAction('save', function () {
        ui.saveFile(false);
    }, null, null, Editor.ctrlKey + '+S').isEnabled = isGraphEnabled;
    this.addAction('pageSetup...', function () {
        ui.showDialog(new PageSetupDialog(ui).container, 320, 220, true, true);
    }).isEnabled = isGraphEnabled;

    // Edit actions
    this.addAction('undo', function () {
        ui.undo();
    }, null, 'sprite-undo', Editor.ctrlKey + '+Z');
    this.addAction('redo', function () {
        ui.redo();
    }, null, 'sprite-redo', (!mxClient.IS_WIN) ? Editor.ctrlKey + '+Shift+Z' : Editor.ctrlKey + '+Y');
    this.addAction('cut', function () {
        mxClipboard.cut(graph);
    }, null, 'sprite-cut', Editor.ctrlKey + '+X');
    this.addAction('copy', function () {
        mxClipboard.copy(graph);
    }, null, 'sprite-copy', Editor.ctrlKey + '+C');
    this.addAction('paste', function () {
        if (graph.isEnabled() && !graph.isCellLocked(graph.getDefaultParent())) {
            mxClipboard.paste(graph);
        }
    }, false, 'sprite-paste', Editor.ctrlKey + '+V');
    this.addAction('pasteHere', function (evt) {
        if (graph.isEnabled() && !graph.isCellLocked(graph.getDefaultParent())) {
            graph.getModel().beginUpdate();
            try {
                var cells = mxClipboard.paste(graph);

                if (cells != null) {
                    var includeEdges = true;

                    for (var i = 0; i < cells.length && includeEdges; i++) {
                        includeEdges = includeEdges && graph.model.isEdge(cells[i]);
                    }

                    var t = graph.view.translate;
                    var s = graph.view.scale;
                    var dx = t.x;
                    var dy = t.y;
                    var bb = null;

                    if (cells.length == 1 && includeEdges) {
                        var geo = graph.getCellGeometry(cells[0]);

                        if (geo != null) {
                            bb = geo.getTerminalPoint(true);
                        }
                    }

                    bb = (bb != null) ? bb : graph.getBoundingBoxFromGeometry(cells, includeEdges);

                    if (bb != null) {
                        var x = Math.round(graph.snap(graph.popupMenuHandler.triggerX / s - dx));
                        var y = Math.round(graph.snap(graph.popupMenuHandler.triggerY / s - dy));

                        graph.cellsMoved(cells, x - bb.x, y - bb.y);
                    }
                }
            } finally {
                graph.getModel().endUpdate();
            }
        }
    });

    this.addAction('copySize', function (evt) {
        var cell = graph.getSelectionCell();

        if (graph.isEnabled() && cell != null && graph.getModel().isVertex(cell)) {
            var geo = graph.getCellGeometry(cell);

            if (geo != null) {
                ui.copiedSize = new mxRectangle(geo.x, geo.y, geo.width, geo.height);
            }
        }
    }, null, null, 'Alt+Shit+X');

    this.addAction('pasteSize', function (evt) {
        if (graph.isEnabled() && !graph.isSelectionEmpty() && ui.copiedSize != null) {
            graph.getModel().beginUpdate();

            try {
                var cells = graph.getSelectionCells();

                for (var i = 0; i < cells.length; i++) {
                    if (graph.getModel().isVertex(cells[i])) {
                        var geo = graph.getCellGeometry(cells[i]);

                        if (geo != null) {
                            geo = geo.clone();
                            geo.width = ui.copiedSize.width;
                            geo.height = ui.copiedSize.height;

                            graph.getModel().setGeometry(cells[i], geo);
                        }
                    }
                }
            } finally {
                graph.getModel().endUpdate();
            }
        }
    }, null, null, 'Alt+Shit+V');

    function deleteCells(includeEdges) {
        // Cancels interactive operations
        graph.escape();
        var cells = graph.getDeletableCells(graph.getSelectionCells());

        if (cells != null && cells.length > 0) {
            var parents = (graph.selectParentAfterDelete) ? graph.model.getParents(cells) : null;
            graph.removeCells(cells, includeEdges);

            // Selects parents for easier editing of groups
            if (parents != null) {
                var select = [];

                for (var i = 0; i < parents.length; i++) {
                    if (graph.model.contains(parents[i]) &&
                        (graph.model.isVertex(parents[i]) ||
                            graph.model.isEdge(parents[i]))) {
                        select.push(parents[i]);
                    }
                }

                graph.setSelectionCells(select);
            }
        }
    };

    this.addAction('delete', function (evt) {
        deleteCells(evt != null && mxEvent.isShiftDown(evt));
    }, null, null, 'Delete');
    this.addAction('deleteAll', function () {
        deleteCells(true);
    }, null, null, Editor.ctrlKey + '+Delete');
    this.addAction('duplicate', function () {
        graph.setSelectionCells(graph.duplicateCells());
    }, null, null, Editor.ctrlKey + '+D');
    this.put('turn', new Action(mxResources.get('turn') + ' / ' + mxResources.get('reverse'), function () {
        graph.turnShapes(graph.getSelectionCells());
    }, null, null, Editor.ctrlKey + '+R'));
    this.addAction('selectVertices', function () {
        graph.selectVertices();
    }, null, null, Editor.ctrlKey + '+Shift+I');
    this.addAction('selectEdges', function () {
        graph.selectEdges();
    }, null, null, Editor.ctrlKey + '+Shift+E');
    this.addAction('selectAll', function () {
        graph.selectAll(null, true);
    }, null, null, Editor.ctrlKey + '+A');
    this.addAction('selectNone', function () {
        graph.clearSelection();
    }, null, null, Editor.ctrlKey + '+Shift+A');
    this.addAction('lockUnlock', function () {
        if (!graph.isSelectionEmpty()) {
            graph.getModel().beginUpdate();
            try {
                var defaultValue = graph.isCellMovable(graph.getSelectionCell()) ? 1 : 0;
                graph.toggleCellStyles(mxConstants.STYLE_MOVABLE, defaultValue);
                graph.toggleCellStyles(mxConstants.STYLE_RESIZABLE, defaultValue);
                graph.toggleCellStyles(mxConstants.STYLE_ROTATABLE, defaultValue);
                graph.toggleCellStyles(mxConstants.STYLE_DELETABLE, defaultValue);
                graph.toggleCellStyles(mxConstants.STYLE_EDITABLE, defaultValue);
                graph.toggleCellStyles('connectable', defaultValue);
            } finally {
                graph.getModel().endUpdate();
            }
        }
    }, null, null, Editor.ctrlKey + '+L');

    // Navigation actions
    this.addAction('home', function () {
        graph.home();
    }, null, null, 'Home');
    this.addAction('exitGroup', function () {
        graph.exitGroup();
    }, null, null, Editor.ctrlKey + '+Shift+Home');
    this.addAction('enterGroup', function () {
        graph.enterGroup();
    }, null, null, Editor.ctrlKey + '+Shift+End');
    this.addAction('collapse', function () {
        graph.foldCells(true);
    }, null, null, Editor.ctrlKey + '+Home');
    this.addAction('expand', function () {
        graph.foldCells(false);
    }, null, null, Editor.ctrlKey + '+End');

    // Arrange actions
    this.addAction('toFront', function () {
        graph.orderCells(false);
    }, null, null, Editor.ctrlKey + '+Shift+F');
    this.addAction('toBack', function () {
        graph.orderCells(true);
    }, null, null, Editor.ctrlKey + '+Shift+B');
    this.addAction('group', function () {
        if (graph.getSelectionCount() == 1) {
            graph.setCellStyles('container', '1');
        } else {
            graph.setSelectionCell(graph.groupCells(null, 0));
        }
    }, null, null, Editor.ctrlKey + '+G');
    this.addAction('ungroup', function () {
        if (graph.getSelectionCount() == 1 && graph.getModel().getChildCount(graph.getSelectionCell()) == 0) {
            graph.setCellStyles('container', '0');
        } else {
            graph.setSelectionCells(graph.ungroupCells());
        }
    }, null, null, Editor.ctrlKey + '+Shift+U');
    this.addAction('removeFromGroup', function () {
        graph.removeCellsFromParent();
    });
    // Adds action
    this.addAction('edit', function () {
        if (graph.isEnabled()) {
            graph.startEditingAtCell();
        }
    }, null, null, 'F2/Enter');
    this.addAction('editData...', function () {
        var cell = graph.getSelectionCell() || graph.getModel().getRoot();
        ui.showDataDialog(cell);
    }, null, null, Editor.ctrlKey + '+M');
    this.addAction('editTooltip...', function () {
        // 编辑 —— 编辑提示
        var graph = ui.editor.graph;

        if (graph.isEnabled() && !graph.isSelectionEmpty()) {
            var cell = graph.getSelectionCell();
            var tooltip = '';

            if (mxUtils.isNode(cell.value)) {
                var tmp = cell.value.getAttribute('tooltip');

                if (tmp != null) {
                    tooltip = tmp;
                }
            }

            var dlg = new TextareaDialog(ui, mxResources.get('editTooltip') + ':', tooltip, function (newValue) {
                graph.setTooltipForCell(cell, newValue);
            });
            ui.showDialog(dlg.container, 360, 225, true, true);
            dlg.init();
        }
    }, null, null, 'Alt+Shift+T');
    this.addAction('openLink', function () {
        var link = graph.getLinkForCell(graph.getSelectionCell());

        if (link != null) {
            graph.openLink(link);
        }
    });
    this.addAction('editLink...', function () {
        var graph = ui.editor.graph;

        if (graph.isEnabled() && !graph.isSelectionEmpty()) {
            var cell = graph.getSelectionCell();
            var value = graph.getLinkForCell(cell) || '';

            ui.showLinkDialog(value, mxResources.get('apply'), function (link) {
                link = mxUtils.trim(link);
                graph.setLinkForCell(cell, (link.length > 0) ? link : null);
            });
        }
    }, null, null, 'Alt+Shift+L');
    this.put('insertImage', new Action(mxResources.get('image') + '...', function () {
        if (graph.isEnabled() && !graph.isCellLocked(graph.getDefaultParent())) {
            graph.clearSelection();
            ui.actions.get('image').funct();
        }
    })).isEnabled = isGraphEnabled;
    this.put('insertLink', new Action(mxResources.get('link') + '...', function () {
        if (graph.isEnabled() && !graph.isCellLocked(graph.getDefaultParent())) {
            ui.showLinkDialog('', mxResources.get('insert'), function (link, docs) {
                link = mxUtils.trim(link);

                if (link.length > 0) {
                    var icon = null;
                    var title = graph.getLinkTitle(link);

                    if (docs != null && docs.length > 0) {
                        icon = docs[0].iconUrl;
                        title = docs[0].name || docs[0].type;
                        title = title.charAt(0).toUpperCase() + title.substring(1);

                        if (title.length > 30) {
                            title = title.substring(0, 30) + '...';
                        }
                    }

                    var pt = graph.getFreeInsertPoint();
                    var linkCell = new mxCell(title, new mxGeometry(pt.x, pt.y, 100, 40),
                        'fontColor=#0000EE;fontStyle=4;rounded=1;overflow=hidden;' + ((icon != null) ?
                        'shape=label;imageWidth=16;imageHeight=16;spacingLeft=26;align=left;image=' + icon :
                        'spacing=10;'));
                    linkCell.vertex = true;

                    graph.setLinkForCell(linkCell, link);
                    graph.cellSizeUpdated(linkCell, true);

                    graph.getModel().beginUpdate();
                    try {
                        linkCell = graph.addCell(linkCell);
                        graph.fireEvent(new mxEventObject('cellsInserted', 'cells', [linkCell]));
                    } finally {
                        graph.getModel().endUpdate();
                    }

                    graph.setSelectionCell(linkCell);
                    graph.scrollCellToVisible(graph.getSelectionCell());
                }
            });
        }
    })).isEnabled = isGraphEnabled;
    this.addAction('link...', mxUtils.bind(this, function () {
        var graph = ui.editor.graph;

        if (graph.isEnabled()) {
            if (graph.cellEditor.isContentEditing()) {
                var elt = graph.getSelectedElement();
                var link = graph.getParentByName(elt, 'A', graph.cellEditor.textarea);
                var oldValue = '';

                // Workaround for FF returning the outermost selected element after double
                // click on a DOM hierarchy with a link inside (but not as topmost element)
                if (link == null && elt != null && elt.getElementsByTagName != null) {
                    // Finds all links in the selected DOM and uses the link
                    // where the selection text matches its text content
                    var links = elt.getElementsByTagName('a');

                    for (var i = 0; i < links.length && link == null; i++) {
                        if (links[i].textContent == elt.textContent) {
                            link = links[i];
                        }
                    }
                }

                if (link != null && link.nodeName == 'A') {
                    oldValue = link.getAttribute('href') || '';
                    graph.selectNode(link);
                }

                var selState = graph.cellEditor.saveSelection();

                ui.showLinkDialog(oldValue, mxResources.get('apply'), mxUtils.bind(this, function (value) {
                    graph.cellEditor.restoreSelection(selState);

                    if (value != null) {
                        graph.insertLink(value);
                    }
                }));
            } else if (graph.isSelectionEmpty()) {
                this.get('insertLink').funct();
            } else {
                this.get('editLink').funct();
            }
        }
    })).isEnabled = isGraphEnabled;
    this.addAction('autosize', function () {
        var cells = graph.getSelectionCells();

        if (cells != null) {
            graph.getModel().beginUpdate();
            try {
                for (var i = 0; i < cells.length; i++) {
                    var cell = cells[i];

                    if (graph.getModel().getChildCount(cell)) {
                        graph.updateGroupBounds([cell], 20);
                    } else {
                        var state = graph.view.getState(cell);
                        var geo = graph.getCellGeometry(cell);

                        if (graph.getModel().isVertex(cell) && state != null && state.text != null &&
                            geo != null && graph.isWrapping(cell)) {
                            geo = geo.clone();
                            geo.height = state.text.boundingBox.height / graph.view.scale;
                            graph.getModel().setGeometry(cell, geo);
                        } else {
                            graph.updateCellSize(cell);
                        }
                    }
                }
            } finally {
                graph.getModel().endUpdate();
            }
        }
    }, null, null, Editor.ctrlKey + '+Shift+Y');
    this.addAction('formattedText', function () {
        var state = graph.getView().getState(graph.getSelectionCell());

        if (state != null) {
            var value = '1';
            graph.stopEditing();

            graph.getModel().beginUpdate();
            try {
                if (state.style['html'] == '1') {
                    value = null;
                    var label = graph.convertValueToString(state.cell);

                    if (mxUtils.getValue(state.style, 'nl2Br', '1') != '0') {
                        // Removes newlines from HTML and converts breaks to newlines
                        // to match the HTML output in plain text
                        label = label.replace(/\n/g, '').replace(/<br\s*.?>/g, '\n');
                    }

                    // Removes HTML tags
                    var temp = document.createElement('div');
                    temp.innerHTML = label;
                    label = mxUtils.extractTextWithWhitespace(temp.childNodes);

                    graph.cellLabelChanged(state.cell, label);
                } else {
                    // Converts HTML tags to text
                    var label = mxUtils.htmlEntities(graph.convertValueToString(state.cell), false);

                    if (mxUtils.getValue(state.style, 'nl2Br', '1') != '0') {
                        // Converts newlines in plain text to breaks in HTML
                        // to match the plain text output
                        label = label.replace(/\n/g, '<br/>');
                    }

                    graph.cellLabelChanged(state.cell, graph.sanitizeHtml(label));
                }

                graph.setCellStyles('html', value);
                ui.fireEvent(new mxEventObject('styleChanged', 'keys', ['html'],
                    'values', [(value != null) ? value : '0'], 'cells',
                    graph.getSelectionCells()));
            } finally {
                graph.getModel().endUpdate();
            }
        }
    });
    this.addAction('wordWrap', function () {
        var state = graph.getView().getState(graph.getSelectionCell());
        var value = 'wrap';

        graph.stopEditing();

        if (state != null && state.style[mxConstants.STYLE_WHITE_SPACE] == 'wrap') {
            value = null;
        }

        graph.setCellStyles(mxConstants.STYLE_WHITE_SPACE, value);
    });
    this.addAction('rotation', function () {
        // 调整图形 —— 方向——>旋转
        var value = '0';
        var state = graph.getView().getState(graph.getSelectionCell());

        if (state != null) {
            value = state.style[mxConstants.STYLE_ROTATION] || value;
        }

        var dlg = new FilenameDialog(ui, value, mxResources.get('apply'), function (newValue) {
            if (newValue != null && newValue.length > 0) {
                graph.setCellStyles(mxConstants.STYLE_ROTATION, newValue);
            }
        }, mxResources.get('enterValue') + ' (' + mxResources.get('rotation') + ' 0-360)');

        ui.showDialog(dlg.container, 375, 130, true, true);
        dlg.init();
    });
    // View actions
    this.addAction('resetView', function () {
        graph.zoomTo(1);
        ui.resetScrollbars();
    }, null, null, Editor.ctrlKey + '+H');
    this.addAction('zoomIn', function (evt) {
        graph.zoomIn();
    }, null, null, Editor.ctrlKey + ' + (Numpad) / Alt+Mousewheel');
    this.addAction('zoomOut', function (evt) {
        graph.zoomOut();
    }, null, null, Editor.ctrlKey + ' - (Numpad) / Alt+Mousewheel');
    this.addAction('fitWindow', function () {
        graph.fit();
    }, null, null, Editor.ctrlKey + '+Shift+H');
    this.addAction('fitPage', mxUtils.bind(this, function () {
        if (!graph.pageVisible) {
            this.get('pageView').funct();
        }

        var fmt = graph.pageFormat;
        var ps = graph.pageScale;
        var cw = graph.container.clientWidth - 10;
        var ch = graph.container.clientHeight - 10;
        var scale = Math.floor(20 * Math.min(cw / fmt.width / ps, ch / fmt.height / ps)) / 20;
        graph.zoomTo(scale);

        if (mxUtils.hasScrollbars(graph.container)) {
            var pad = graph.getPagePadding();
            graph.container.scrollTop = pad.y * graph.view.scale - 1;
            graph.container.scrollLeft = Math.min(pad.x * graph.view.scale, (graph.container.scrollWidth - graph.container.clientWidth) / 2) - 1;
        }
    }), null, null, Editor.ctrlKey + '+J');
    this.addAction('fitTwoPages', mxUtils.bind(this, function () {
        if (!graph.pageVisible) {
            this.get('pageView').funct();
        }

        var fmt = graph.pageFormat;
        var ps = graph.pageScale;
        var cw = graph.container.clientWidth - 10;
        var ch = graph.container.clientHeight - 10;

        var scale = Math.floor(20 * Math.min(cw / (2 * fmt.width) / ps, ch / fmt.height / ps)) / 20;
        graph.zoomTo(scale);

        if (mxUtils.hasScrollbars(graph.container)) {
            var pad = graph.getPagePadding();
            graph.container.scrollTop = Math.min(pad.y, (graph.container.scrollHeight - graph.container.clientHeight) / 2);
            graph.container.scrollLeft = Math.min(pad.x, (graph.container.scrollWidth - graph.container.clientWidth) / 2);
        }
    }), null, null, Editor.ctrlKey + '+Shift+J');
    this.addAction('fitPageWidth', mxUtils.bind(this, function () {
        if (!graph.pageVisible) {
            this.get('pageView').funct();
        }

        var fmt = graph.pageFormat;
        var ps = graph.pageScale;
        var cw = graph.container.clientWidth - 10;

        var scale = Math.floor(20 * cw / fmt.width / ps) / 20;
        graph.zoomTo(scale);

        if (mxUtils.hasScrollbars(graph.container)) {
            var pad = graph.getPagePadding();
            graph.container.scrollLeft = Math.min(pad.x * graph.view.scale,
                (graph.container.scrollWidth - graph.container.clientWidth) / 2);
        }
    }));
    this.put('customZoom', new Action(mxResources.get('custom') + '...', mxUtils.bind(this, function () {
        var dlg = new FilenameDialog(this.editorUi, parseInt(graph.getView().getScale() * 100), mxResources.get('apply'), mxUtils.bind(this, function (newValue) {
            var val = parseInt(newValue);

            if (!isNaN(val) && val > 0) {
                graph.zoomTo(val / 100);
            }
        }), mxResources.get('zoom') + ' (%)');
        this.editorUi.showDialog(dlg.container, 300, 130, true, true);
        dlg.init();
    }), null, null, Editor.ctrlKey + '+0'));
    this.addAction('pageScale...', mxUtils.bind(this, function () {
        var dlg = new FilenameDialog(this.editorUi, parseInt(graph.pageScale * 100), mxResources.get('apply'), mxUtils.bind(this, function (newValue) {
            var val = parseInt(newValue);

            if (!isNaN(val) && val > 0) {
                ui.setPageScale(val / 100);
            }
        }), mxResources.get('pageScale') + ' (%)');
        this.editorUi.showDialog(dlg.container, 330, 130, true, true);
        dlg.init();
    }));

    // Option actions
    var action = null;
    action = this.addAction('grid', function () {
        graph.setGridEnabled(!graph.isGridEnabled());
        ui.fireEvent(new mxEventObject('gridEnabledChanged'));
    }, null, null, Editor.ctrlKey + '+Shift+G');
    action.setToggleAction(true);
    action.setSelectedCallback(function () {
        return graph.isGridEnabled();
    });
    action.setEnabled(false);

    action = this.addAction('guides', function () {
        graph.graphHandler.guidesEnabled = !graph.graphHandler.guidesEnabled;
        ui.fireEvent(new mxEventObject('guidesEnabledChanged'));
    });
    action.setToggleAction(true);
    action.setSelectedCallback(function () {
        return graph.graphHandler.guidesEnabled;
    });
    action.setEnabled(false);

    action = this.addAction('tooltips', function () {
        debugger;
        graph.tooltipHandler.setEnabled(false);
    });
    action.setToggleAction(true);
    action.setSelectedCallback(function () {
        return graph.tooltipHandler.isEnabled();
    });

    action = this.addAction('collapseExpand', function () {
        var change = new ChangePageSetup(ui);
        change.ignoreColor = true;
        change.ignoreImage = true;
        change.foldingEnabled = !graph.foldingEnabled;

        graph.model.execute(change);
    });
    action.setToggleAction(true);
    action.setSelectedCallback(function () {
        return graph.foldingEnabled;
    });
    action.isEnabled = isGraphEnabled;
    action = this.addAction('scrollbars', function () {
        ui.setScrollbars(!ui.hasScrollbars());
    });
    action.setToggleAction(true);
    action.setSelectedCallback(function () {
        return graph.scrollbars;
    });
    action = this.addAction('pageView', mxUtils.bind(this, function () {
        ui.setPageVisible(!graph.pageVisible);
    }));
    action.setToggleAction(true);
    action.setSelectedCallback(function () {
        return graph.pageVisible;
    });
    action = this.addAction('connectionArrows', function () {
        graph.connectionArrowsEnabled = !graph.connectionArrowsEnabled;
        ui.fireEvent(new mxEventObject('connectionArrowsChanged'));
    }, null, null, 'Alt+Shift+A');
    action.setToggleAction(true);
    action.setSelectedCallback(function () {
        return graph.connectionArrowsEnabled;
    });
    action = this.addAction('connectionPoints', function () {
        graph.setConnectable(!graph.connectionHandler.isEnabled());
        ui.fireEvent(new mxEventObject('connectionPointsChanged'));
    }, null, null, 'Alt+Shift+P');
    action.setToggleAction(true);
    action.setSelectedCallback(function () {
        return graph.connectionHandler.isEnabled();
    });
    action = this.addAction('copyConnect', function () {
        graph.connectionHandler.setCreateTarget(!graph.connectionHandler.isCreateTarget());
        ui.fireEvent(new mxEventObject('copyConnectChanged'));
    });
    action.setToggleAction(true);
    action.setSelectedCallback(function () {
        return graph.connectionHandler.isCreateTarget();
    });
    action.isEnabled = isGraphEnabled;
    action = this.addAction('autosave', function () {
        ui.editor.setAutosave(!ui.editor.autosave);
    });
    action.setToggleAction(true);
    action.setSelectedCallback(function () {
        return ui.editor.autosave;
    });
    action.isEnabled = isGraphEnabled;
    action.visible = false;

    // Help actions
    this.addAction('help', function () {
        var ext = '';

        if (mxResources.isLanguageSupported(mxClient.language)) {
            ext = '_' + mxClient.language;
        }

        graph.openLink(RESOURCES_PATH + '/help' + ext + '.html');
    });

    // Font style actions
    var toggleFontStyle = mxUtils.bind(this, function (key, style, fn, shortcut) {
        return this.addAction(key, function () {
            if (fn != null && graph.cellEditor.isContentEditing()) {
                fn();
            } else {
                graph.stopEditing(false);

                graph.getModel().beginUpdate();
                try {
                    graph.toggleCellStyleFlags(mxConstants.STYLE_FONTSTYLE, style);

                    // Removes bold and italic tags and CSS styles inside labels
                    if ((style & mxConstants.FONT_BOLD) == mxConstants.FONT_BOLD) {
                        graph.updateLabelElements(graph.getSelectionCells(), function (elt) {
                            elt.style.fontWeight = null;

                            if (elt.nodeName == 'B') {
                                graph.replaceElement(elt);
                            }
                        });
                    } else if ((style & mxConstants.FONT_ITALIC) == mxConstants.FONT_ITALIC) {
                        graph.updateLabelElements(graph.getSelectionCells(), function (elt) {
                            elt.style.fontStyle = null;

                            if (elt.nodeName == 'I') {
                                graph.replaceElement(elt);
                            }
                        });
                    } else if ((style & mxConstants.FONT_UNDERLINE) == mxConstants.FONT_UNDERLINE) {
                        graph.updateLabelElements(graph.getSelectionCells(), function (elt) {
                            elt.style.textDecoration = null;

                            if (elt.nodeName == 'U') {
                                graph.replaceElement(elt);
                            }
                        });
                    }
                } finally {
                    graph.getModel().endUpdate();
                }
            }
        }, null, null, shortcut);
    });

    toggleFontStyle('bold', mxConstants.FONT_BOLD, function () {
        document.execCommand('bold', false, null);
    }, Editor.ctrlKey + '+B');
    toggleFontStyle('italic', mxConstants.FONT_ITALIC, function () {
        document.execCommand('italic', false, null);
    }, Editor.ctrlKey + '+I');
    toggleFontStyle('underline', mxConstants.FONT_UNDERLINE, function () {
        document.execCommand('underline', false, null);
    }, Editor.ctrlKey + '+U');

    // Color actions
    this.addAction('fontColor...', function () {
        ui.menus.pickColor(mxConstants.STYLE_FONTCOLOR, 'forecolor', '000000');
    });
    this.addAction('strokeColor...', function () {
        ui.menus.pickColor(mxConstants.STYLE_STROKECOLOR);
    });
    this.addAction('fillColor...', function () {
        ui.menus.pickColor(mxConstants.STYLE_FILLCOLOR);
    });
    this.addAction('gradientColor...', function () {
        ui.menus.pickColor(mxConstants.STYLE_GRADIENTCOLOR);
    });
    this.addAction('backgroundColor...', function () {
        ui.menus.pickColor(mxConstants.STYLE_LABEL_BACKGROUNDCOLOR, 'backcolor');
    });
    this.addAction('borderColor...', function () {
        ui.menus.pickColor(mxConstants.STYLE_LABEL_BORDERCOLOR);
    });

    // Format actions
    this.addAction('vertical', function () {
        ui.menus.toggleStyle(mxConstants.STYLE_HORIZONTAL, true);
    });
    this.addAction('shadow', function () {
        ui.menus.toggleStyle(mxConstants.STYLE_SHADOW);
    });
    this.addAction('solid', function () {
        graph.getModel().beginUpdate();
        try {
            graph.setCellStyles(mxConstants.STYLE_DASHED, null);
            graph.setCellStyles(mxConstants.STYLE_DASH_PATTERN, null);
            ui.fireEvent(new mxEventObject('styleChanged', 'keys', [mxConstants.STYLE_DASHED, mxConstants.STYLE_DASH_PATTERN],
                'values', [null, null], 'cells', graph.getSelectionCells()));
        } finally {
            graph.getModel().endUpdate();
        }
    });
    this.addAction('dashed', function () {
        graph.getModel().beginUpdate();
        try {
            graph.setCellStyles(mxConstants.STYLE_DASHED, '1');
            graph.setCellStyles(mxConstants.STYLE_DASH_PATTERN, null);
            ui.fireEvent(new mxEventObject('styleChanged', 'keys', [mxConstants.STYLE_DASHED, mxConstants.STYLE_DASH_PATTERN],
                'values', ['1', null], 'cells', graph.getSelectionCells()));
        } finally {
            graph.getModel().endUpdate();
        }
    });
    this.addAction('dotted', function () {
        graph.getModel().beginUpdate();
        try {
            graph.setCellStyles(mxConstants.STYLE_DASHED, '1');
            graph.setCellStyles(mxConstants.STYLE_DASH_PATTERN, '1 4');
            ui.fireEvent(new mxEventObject('styleChanged', 'keys', [mxConstants.STYLE_DASHED, mxConstants.STYLE_DASH_PATTERN],
                'values', ['1', '1 4'], 'cells', graph.getSelectionCells()));
        } finally {
            graph.getModel().endUpdate();
        }
    });
    this.addAction('sharp', function () {
        graph.getModel().beginUpdate();
        try {
            graph.setCellStyles(mxConstants.STYLE_ROUNDED, '0');
            graph.setCellStyles(mxConstants.STYLE_CURVED, '0');
            ui.fireEvent(new mxEventObject('styleChanged', 'keys', [mxConstants.STYLE_ROUNDED, mxConstants.STYLE_CURVED],
                'values', ['0', '0'], 'cells', graph.getSelectionCells()));
        } finally {
            graph.getModel().endUpdate();
        }
    });
    this.addAction('rounded', function () {
        graph.getModel().beginUpdate();
        try {
            graph.setCellStyles(mxConstants.STYLE_ROUNDED, '1');
            graph.setCellStyles(mxConstants.STYLE_CURVED, '0');
            ui.fireEvent(new mxEventObject('styleChanged', 'keys', [mxConstants.STYLE_ROUNDED, mxConstants.STYLE_CURVED],
                'values', ['1', '0'], 'cells', graph.getSelectionCells()));
        } finally {
            graph.getModel().endUpdate();
        }
    });
    this.addAction('toggleRounded', function () {
        if (!graph.isSelectionEmpty() && graph.isEnabled()) {
            graph.getModel().beginUpdate();
            try {
                var cells = graph.getSelectionCells();
                var state = graph.view.getState(cells[0]);
                var style = (state != null) ? state.style : graph.getCellStyle(cells[0]);
                var value = (mxUtils.getValue(style, mxConstants.STYLE_ROUNDED, '0') == '1') ? '0' : '1';

                graph.setCellStyles(mxConstants.STYLE_ROUNDED, value);
                graph.setCellStyles(mxConstants.STYLE_CURVED, null);
                ui.fireEvent(new mxEventObject('styleChanged', 'keys', [mxConstants.STYLE_ROUNDED, mxConstants.STYLE_CURVED],
                    'values', [value, '0'], 'cells', graph.getSelectionCells()));
            } finally {
                graph.getModel().endUpdate();
            }
        }
    });
    this.addAction('curved', function () {
        graph.getModel().beginUpdate();
        try {
            graph.setCellStyles(mxConstants.STYLE_ROUNDED, '0');
            graph.setCellStyles(mxConstants.STYLE_CURVED, '1');
            ui.fireEvent(new mxEventObject('styleChanged', 'keys', [mxConstants.STYLE_ROUNDED, mxConstants.STYLE_CURVED],
                'values', ['0', '1'], 'cells', graph.getSelectionCells()));
        } finally {
            graph.getModel().endUpdate();
        }
    });
    this.addAction('collapsible', function () {
        var state = graph.view.getState(graph.getSelectionCell());
        var value = '1';

        if (state != null && graph.getFoldingImage(state) != null) {
            value = '0';
        }

        graph.setCellStyles('collapsible', value);
        ui.fireEvent(new mxEventObject('styleChanged', 'keys', ['collapsible'],
            'values', [value], 'cells', graph.getSelectionCells()));
    });
    this.addAction('editStyle...', mxUtils.bind(this, function () {
        var cells = graph.getSelectionCells();

        if (cells != null && cells.length > 0) {
            var model = graph.getModel();

            var dlg = new TextareaDialog(this.editorUi, mxResources.get('editStyle') + ':',
                model.getStyle(cells[0]) || '', function (newValue) {
                    if (newValue != null) {
                        graph.setCellStyle(mxUtils.trim(newValue), cells);
                    }
                }, null, null, 400, 220);
            this.editorUi.showDialog(dlg.container, 460, 330, true, true);
            dlg.init();
        }
    }), null, null, Editor.ctrlKey + '+E');
    this.addAction('setAsDefaultStyle', function () {
        if (graph.isEnabled() && !graph.isSelectionEmpty()) {
            ui.setDefaultStyle(graph.getSelectionCell());
        }
    }, null, null, Editor.ctrlKey + '+Shift+D');
    this.addAction('clearDefaultStyle', function () {
        if (graph.isEnabled()) {
            ui.clearDefaultStyle();
        }
    }, null, null, Editor.ctrlKey + '+Shift+R');
    this.addAction('addWaypoint', function () {
        var cell = graph.getSelectionCell();

        if (cell != null && graph.getModel().isEdge(cell)) {
            var handler = editor.graph.selectionCellsHandler.getHandler(cell);

            if (handler instanceof mxEdgeHandler) {
                var t = graph.view.translate;
                var s = graph.view.scale;
                var dx = t.x;
                var dy = t.y;

                var parent = graph.getModel().getParent(cell);
                var pgeo = graph.getCellGeometry(parent);

                while (graph.getModel().isVertex(parent) && pgeo != null) {
                    dx += pgeo.x;
                    dy += pgeo.y;

                    parent = graph.getModel().getParent(parent);
                    pgeo = graph.getCellGeometry(parent);
                }

                var x = Math.round(graph.snap(graph.popupMenuHandler.triggerX / s - dx));
                var y = Math.round(graph.snap(graph.popupMenuHandler.triggerY / s - dy));

                handler.addPointAt(handler.state, x, y);
            }
        }
    });
    this.addAction('removeWaypoint', function () {
        // TODO: Action should run with "this" set to action
        var rmWaypointAction = ui.actions.get('removeWaypoint');

        if (rmWaypointAction.handler != null) {
            // NOTE: Popupevent handled and action updated in Menus.createPopupMenu
            rmWaypointAction.handler.removePoint(rmWaypointAction.handler.state, rmWaypointAction.index);
        }
    });
    this.addAction('clearWaypoints', function () {
        var cells = graph.getSelectionCells();

        if (cells != null) {
            cells = graph.addAllEdges(cells);

            graph.getModel().beginUpdate();
            try {
                for (var i = 0; i < cells.length; i++) {
                    var cell = cells[i];

                    if (graph.getModel().isEdge(cell)) {
                        var geo = graph.getCellGeometry(cell);

                        if (geo != null) {
                            geo = geo.clone();
                            geo.points = null;
                            graph.getModel().setGeometry(cell, geo);
                        }
                    }
                }
            } finally {
                graph.getModel().endUpdate();
            }
        }
    }, null, null, 'Alt+Shift+C');
    action = this.addAction('subscript', mxUtils.bind(this, function () {
        if (graph.cellEditor.isContentEditing()) {
            document.execCommand('subscript', false, null);
        }
    }), null, null, Editor.ctrlKey + '+,');
    action = this.addAction('superscript', mxUtils.bind(this, function () {
        if (graph.cellEditor.isContentEditing()) {
            document.execCommand('superscript', false, null);
        }
    }), null, null, Editor.ctrlKey + '+.');
    this.addAction('image...', function () {
        if (graph.isEnabled() && !graph.isCellLocked(graph.getDefaultParent())) {
            var title = mxResources.get('image') + ' (' + mxResources.get('url') + '):';
            var state = graph.getView().getState(graph.getSelectionCell());
            var value = '';

            if (state != null) {
                value = state.style[mxConstants.STYLE_IMAGE] || value;
            }

            var selectionState = graph.cellEditor.saveSelection();

            ui.showImageDialog(title, value, function (newValue, w, h) {
                // Inserts image into HTML text
                if (graph.cellEditor.isContentEditing()) {
                    graph.cellEditor.restoreSelection(selectionState);
                    graph.insertImage(newValue, w, h);
                } else {
                    var cells = graph.getSelectionCells();

                    if (newValue != null && (newValue.length > 0 || cells.length > 0)) {
                        var select = null;

                        graph.getModel().beginUpdate();
                        try {
                            // Inserts new cell if no cell is selected
                            if (cells.length == 0) {
                                var pt = graph.getFreeInsertPoint();
                                cells = [graph.insertVertex(graph.getDefaultParent(), null, '', pt.x, pt.y, w, h,
                                    'shape=image;imageAspect=0;aspect=fixed;verticalLabelPosition=bottom;verticalAlign=top;')];
                                select = cells;
                                graph.fireEvent(new mxEventObject('cellsInserted', 'cells', select));
                            }

                            graph.setCellStyles(mxConstants.STYLE_IMAGE, (newValue.length > 0) ? newValue : null, cells);

                            // Sets shape only if not already shape with image (label or image)
                            var state = graph.view.getState(cells[0]);
                            var style = (state != null) ? state.style : graph.getCellStyle(cells[0]);

                            if (style[mxConstants.STYLE_SHAPE] != 'image' && style[mxConstants.STYLE_SHAPE] != 'label') {
                                graph.setCellStyles(mxConstants.STYLE_SHAPE, 'image', cells);
                            } else if (newValue.length == 0) {
                                graph.setCellStyles(mxConstants.STYLE_SHAPE, null, cells);
                            }

                            if (graph.getSelectionCount() == 1) {
                                if (w != null && h != null) {
                                    var cell = cells[0];
                                    var geo = graph.getModel().getGeometry(cell);

                                    if (geo != null) {
                                        geo = geo.clone();
                                        geo.width = w;
                                        geo.height = h;
                                        graph.getModel().setGeometry(cell, geo);
                                    }
                                }
                            }
                        } finally {
                            graph.getModel().endUpdate();
                        }

                        if (select != null) {
                            graph.setSelectionCells(select);
                            graph.scrollCellToVisible(select[0]);
                        }
                    }
                }
            }, graph.cellEditor.isContentEditing(), !graph.cellEditor.isContentEditing());
        }
    }).isEnabled = isGraphEnabled;
    action = this.addAction('layers', mxUtils.bind(this, function () {
        if (this.layersWindow == null) {
            // LATER: Check outline window for initial placement
            this.layersWindow = new LayersWindow(ui, document.body.offsetWidth - 280, 120, 220, 180);
            this.layersWindow.window.addListener('show', function () {
                ui.fireEvent(new mxEventObject('layers'));
            });
            this.layersWindow.window.addListener('hide', function () {
                ui.fireEvent(new mxEventObject('layers'));
            });
            this.layersWindow.window.setVisible(true);
            ui.fireEvent(new mxEventObject('layers'));
        } else {
            this.layersWindow.window.setVisible(!this.layersWindow.window.isVisible());
        }
    }), null, null, Editor.ctrlKey + '+Shift+L');
    action.setToggleAction(true);
    action.setSelectedCallback(mxUtils.bind(this, function () {
        return this.layersWindow != null && this.layersWindow.window.isVisible();
    }));
    action = this.addAction('formatPanel', mxUtils.bind(this, function () {
        ui.toggleFormatPanel();
    }), null, null, Editor.ctrlKey + '+Shift+P');
    action.setToggleAction(true);
    action.setSelectedCallback(mxUtils.bind(this, function () {
        return ui.formatWidth > 0;
    }));
    action = this.addAction('outline', mxUtils.bind(this, function () {
        if (this.outlineWindow == null) {
            // LATER: Check layers window for initial placement
            this.outlineWindow = new OutlineWindow(ui, document.body.offsetWidth - 260, 100, 180, 180);
            this.outlineWindow.window.addListener('show', function () {
                ui.fireEvent(new mxEventObject('outline'));
            });
            this.outlineWindow.window.addListener('hide', function () {
                ui.fireEvent(new mxEventObject('outline'));
            });
            this.outlineWindow.window.setVisible(true);
            ui.fireEvent(new mxEventObject('outline'));
        } else {
            this.outlineWindow.window.setVisible(!this.outlineWindow.window.isVisible());
        }
    }), null, null, Editor.ctrlKey + '+Shift+O');

    action.setToggleAction(true);
    action.setSelectedCallback(mxUtils.bind(this, function () {
        return this.outlineWindow != null && this.outlineWindow.window.isVisible();
    }));
};

/**
 * Registers the given action under the given name.
 */
Actions.prototype.addAction = function (key, funct, enabled, iconCls, shortcut) {
    var title;

    if (key.substring(key.length - 3) == '...') {
        key = key.substring(0, key.length - 3);
        title = mxResources.get(key) + '...';
    } else {
        title = mxResources.get(key);
    }

    return this.put(key, new Action(title, funct, enabled, iconCls, shortcut));
};

/**
 * Registers the given action under the given name.
 */
Actions.prototype.put = function (name, action) {
    this.actions[name] = action;

    return action;
};

/**
 * Returns the action for the given name or null if no such action exists.
 */
Actions.prototype.get = function (name) {
    return this.actions[name];
};

/**
 * Constructs a new action for the given parameters.
 */
function Action(label, funct, enabled, iconCls, shortcut) {
    mxEventSource.call(this);
    this.label = label;
    this.funct = this.createFunction(funct);
    this.enabled = (enabled != null) ? enabled : true;
    this.iconCls = iconCls;
    this.shortcut = shortcut;
    this.visible = true;
};

// Action inherits from mxEventSource
mxUtils.extend(Action, mxEventSource);

/**
 * Sets the enabled state of the action and fires a stateChanged event.
 */
Action.prototype.createFunction = function (funct) {
    return funct;
};

/**
 * Sets the enabled state of the action and fires a stateChanged event.
 */
Action.prototype.setEnabled = function (value) {
    if (this.enabled != value) {
        this.enabled = value;
        this.fireEvent(new mxEventObject('stateChanged'));
    }
};

/**
 * Sets the enabled state of the action and fires a stateChanged event.
 */
Action.prototype.isEnabled = function () {
    return this.enabled;
};

/**
 * Sets the enabled state of the action and fires a stateChanged event.
 */
Action.prototype.setToggleAction = function (value) {
    this.toggleAction = value;
};

/**
 * Sets the enabled state of the action and fires a stateChanged event.
 */
Action.prototype.setSelectedCallback = function (funct) {
    this.selectedCallback = funct;
};

/**
 * Sets the enabled state of the action and fires a stateChanged event.
 */
Action.prototype.isSelected = function () {
    return this.selectedCallback();
};

/**
 * Copyright (c) 2006-2012, JGraph Ltd
 */
/**
 * Constructs a new graph editor
 */
Menus = function (editorUi) {
    this.editorUi = editorUi;
    this.menus = new Object();
    this.init();

    // Pre-fetches checkmark image
    if (!mxClient.IS_SVG) {
        new Image().src = this.checkmarkImage;
    }
};

/**
 * Sets the default font family.
 */
Menus.prototype.defaultFont = 'Helvetica';

/**
 * Sets the default font size.
 */
Menus.prototype.defaultFontSize = '12';

/**
 * Sets the default font size.
 */
Menus.prototype.defaultMenuItems = [];

/**
 * Adds the label menu items to the given menu and parent.
 */
Menus.prototype.defaultFonts = ['Helvetica', 'Verdana', 'Times New Roman', 'Garamond', 'Comic Sans MS',
    'Courier New', 'Georgia', 'Lucida Console', 'Tahoma'];

/**
 * Adds the label menu items to the given menu and parent.
 */
Menus.prototype.init = function () {
    var graph = this.editorUi.editor.graph;
    var isGraphEnabled = mxUtils.bind(graph, graph.isEnabled);

    this.customFonts = [];
    this.customFontSizes = [];

    this.put('fontFamily', new Menu(mxUtils.bind(this, function (menu, parent) {
        var addItem = mxUtils.bind(this, function (fontname) {
            var tr = this.styleChange(menu, fontname, [mxConstants.STYLE_FONTFAMILY], [fontname], null, parent, function () {
                document.execCommand('fontname', false, fontname);
            }, function () {
                graph.updateLabelElements(graph.getSelectionCells(), function (elt) {
                    elt.removeAttribute('face');
                    elt.style.fontFamily = null;

                    if (elt.nodeName == 'PRE') {
                        graph.replaceElement(elt, 'div');
                    }
                });
            });
            tr.firstChild.nextSibling.style.fontFamily = fontname;
        });

        for (var i = 0; i < this.defaultFonts.length; i++) {
            addItem(this.defaultFonts[i]);
        }

        menu.addSeparator(parent);

        if (this.customFonts.length > 0) {
            for (var i = 0; i < this.customFonts.length; i++) {
                addItem(this.customFonts[i]);
            }

            menu.addSeparator(parent);

            menu.addItem(mxResources.get('reset'), null, mxUtils.bind(this, function () {
                this.customFonts = [];
                this.editorUi.fireEvent(new mxEventObject('customFontsChanged'));
            }), parent);

            menu.addSeparator(parent);
        }

        this.promptChange(menu, mxResources.get('custom') + '...', '', mxConstants.DEFAULT_FONTFAMILY, mxConstants.STYLE_FONTFAMILY, parent, true, mxUtils.bind(this, function (newValue) {
            if (mxUtils.indexOf(this.customFonts, newValue) < 0) {
                this.customFonts.push(newValue);
                this.editorUi.fireEvent(new mxEventObject('customFontsChanged'));
            }
        }));
    })));
    this.put('formatBlock', new Menu(mxUtils.bind(this, function (menu, parent) {
        function addItem(label, tag) {
            return menu.addItem(label, null, mxUtils.bind(this, function () {
                // TODO: Check if visible
                if (graph.cellEditor.textarea != null) {
                    graph.cellEditor.textarea.focus();
                    document.execCommand('formatBlock', false, '<' + tag + '>');
                }
            }), parent);
        };

        addItem(mxResources.get('normal'), 'p');

        addItem('', 'h1').firstChild.nextSibling.innerHTML = '<h1 style="margin:0px;">' + mxResources.get('heading') + ' 1</h1>';
        addItem('', 'h2').firstChild.nextSibling.innerHTML = '<h2 style="margin:0px;">' + mxResources.get('heading') + ' 2</h2>';
        addItem('', 'h3').firstChild.nextSibling.innerHTML = '<h3 style="margin:0px;">' + mxResources.get('heading') + ' 3</h3>';
        addItem('', 'h4').firstChild.nextSibling.innerHTML = '<h4 style="margin:0px;">' + mxResources.get('heading') + ' 4</h4>';
        addItem('', 'h5').firstChild.nextSibling.innerHTML = '<h5 style="margin:0px;">' + mxResources.get('heading') + ' 5</h5>';
        addItem('', 'h6').firstChild.nextSibling.innerHTML = '<h6 style="margin:0px;">' + mxResources.get('heading') + ' 6</h6>';

        addItem('', 'pre').firstChild.nextSibling.innerHTML = '<pre style="margin:0px;">' + mxResources.get('formatted') + '</pre>';
        addItem('', 'blockquote').firstChild.nextSibling.innerHTML = '<blockquote style="margin-top:0px;margin-bottom:0px;">' + mxResources.get('blockquote') + '</blockquote>';
    })));
    this.put('fontSize', new Menu(mxUtils.bind(this, function (menu, parent) {
        var sizes = [6, 8, 9, 10, 11, 12, 14, 18, 24, 36, 48, 72];

        var addItem = mxUtils.bind(this, function (fontsize) {
            this.styleChange(menu, fontsize, [mxConstants.STYLE_FONTSIZE], [fontsize], null, parent, function () {
                if (graph.cellEditor.textarea != null) {
                    // Creates an element with arbitrary size 3
                    document.execCommand('fontSize', false, '3');

                    // Changes the css font size of the first font element inside the in-place editor with size 3
                    // hopefully the above element that we've just created. LATER: Check for new element using
                    // previous result of getElementsByTagName (see other actions)
                    var elts = graph.cellEditor.textarea.getElementsByTagName('font');

                    for (var i = 0; i < elts.length; i++) {
                        if (elts[i].getAttribute('size') == '3') {
                            elts[i].removeAttribute('size');
                            elts[i].style.fontSize = fontsize + 'px';

                            break;
                        }
                    }
                }
            });
        });

        for (var i = 0; i < sizes.length; i++) {
            addItem(sizes[i]);
        }

        menu.addSeparator(parent);

        if (this.customFontSizes.length > 0) {
            for (var i = 0; i < this.customFontSizes.length; i++) {
                addItem(this.customFontSizes[i]);
            }

            menu.addSeparator(parent);

            menu.addItem(mxResources.get('reset'), null, mxUtils.bind(this, function () {
                this.customFontSizes = [];
            }), parent);

            menu.addSeparator(parent);
        }

        this.promptChange(menu, mxResources.get('custom') + '...', '(pt)', '12', mxConstants.STYLE_FONTSIZE, parent, true, mxUtils.bind(this, function (newValue) {
            this.customFontSizes.push(newValue);
        }));
    })));
    this.put('direction', new Menu(mxUtils.bind(this, function (menu, parent) {
        menu.addItem(mxResources.get('flipH'), null, function () {
            graph.toggleCellStyles(mxConstants.STYLE_FLIPH, false);
        }, parent);
        menu.addItem(mxResources.get('flipV'), null, function () {
            graph.toggleCellStyles(mxConstants.STYLE_FLIPV, false);
        }, parent);
        this.addMenuItems(menu, ['-', 'rotation'], parent);
    })));
    this.put('align', new Menu(mxUtils.bind(this, function (menu, parent) {
        menu.addItem(mxResources.get('leftAlign'), null, function () {
            graph.alignCells(mxConstants.ALIGN_LEFT);
        }, parent);
        menu.addItem(mxResources.get('center'), null, function () {
            graph.alignCells(mxConstants.ALIGN_CENTER);
        }, parent);
        menu.addItem(mxResources.get('rightAlign'), null, function () {
            graph.alignCells(mxConstants.ALIGN_RIGHT);
        }, parent);
        menu.addSeparator(parent);
        menu.addItem(mxResources.get('topAlign'), null, function () {
            graph.alignCells(mxConstants.ALIGN_TOP);
        }, parent);
        menu.addItem(mxResources.get('middle'), null, function () {
            graph.alignCells(mxConstants.ALIGN_MIDDLE);
        }, parent);
        menu.addItem(mxResources.get('bottomAlign'), null, function () {
            graph.alignCells(mxConstants.ALIGN_BOTTOM);
        }, parent);
    })));
    this.put('distribute', new Menu(mxUtils.bind(this, function (menu, parent) {
        menu.addItem(mxResources.get('horizontal'), null, function () {
            graph.distributeCells(true);
        }, parent);
        menu.addItem(mxResources.get('vertical'), null, function () {
            graph.distributeCells(false);
        }, parent);
    })));
    this.put('layout', new Menu(mxUtils.bind(this, function (menu, parent) {
        var promptSpacing = mxUtils.bind(this, function (defaultValue, fn) {
            var dlg = new FilenameDialog(this.editorUi, defaultValue, mxResources.get('apply'), function (newValue) {
                fn(parseFloat(newValue));
            }, mxResources.get('spacing'));
            this.editorUi.showDialog(dlg.container, 300, 80, true, true);
            dlg.init();
        });

        menu.addItem(mxResources.get('horizontalFlow'), null, mxUtils.bind(this, function () {
            var layout = new mxHierarchicalLayout(graph, mxConstants.DIRECTION_WEST);

            this.editorUi.executeLayout(function () {
                var selectionCells = graph.getSelectionCells();
                layout.execute(graph.getDefaultParent(), selectionCells.length == 0 ? null : selectionCells);
            }, true);
        }), parent);
        menu.addItem(mxResources.get('verticalFlow'), null, mxUtils.bind(this, function () {
            var layout = new mxHierarchicalLayout(graph, mxConstants.DIRECTION_NORTH);

            this.editorUi.executeLayout(function () {
                var selectionCells = graph.getSelectionCells();
                layout.execute(graph.getDefaultParent(), selectionCells.length == 0 ? null : selectionCells);
            }, true);
        }), parent);
        menu.addSeparator(parent);
        menu.addItem(mxResources.get('horizontalTree'), null, mxUtils.bind(this, function () {
            var tmp = graph.getSelectionCell();
            var roots = null;

            if (tmp == null || graph.getModel().getChildCount(tmp) == 0) {
                if (graph.getModel().getEdgeCount(tmp) == 0) {
                    roots = graph.findTreeRoots(graph.getDefaultParent());
                }
            } else {
                roots = graph.findTreeRoots(tmp);
            }

            if (roots != null && roots.length > 0) {
                tmp = roots[0];
            }

            if (tmp != null) {
                var layout = new mxCompactTreeLayout(graph, true);
                layout.edgeRouting = false;
                layout.levelDistance = 30;

                promptSpacing(layout.levelDistance, mxUtils.bind(this, function (newValue) {
                    layout.levelDistance = newValue;

                    this.editorUi.executeLayout(function () {
                        layout.execute(graph.getDefaultParent(), tmp);
                    }, true);
                }));
            }
        }), parent);
        menu.addItem(mxResources.get('verticalTree'), null, mxUtils.bind(this, function () {
            var tmp = graph.getSelectionCell();
            var roots = null;

            if (tmp == null || graph.getModel().getChildCount(tmp) == 0) {
                if (graph.getModel().getEdgeCount(tmp) == 0) {
                    roots = graph.findTreeRoots(graph.getDefaultParent());
                }
            } else {
                roots = graph.findTreeRoots(tmp);
            }

            if (roots != null && roots.length > 0) {
                tmp = roots[0];
            }

            if (tmp != null) {
                var layout = new mxCompactTreeLayout(graph, false);
                layout.edgeRouting = false;
                layout.levelDistance = 30;

                promptSpacing(layout.levelDistance, mxUtils.bind(this, function (newValue) {
                    layout.levelDistance = newValue;

                    this.editorUi.executeLayout(function () {
                        layout.execute(graph.getDefaultParent(), tmp);
                    }, true);
                }));
            }
        }), parent);
        menu.addItem(mxResources.get('radialTree'), null, mxUtils.bind(this, function () {
            var tmp = graph.getSelectionCell();
            var roots = null;

            if (tmp == null || graph.getModel().getChildCount(tmp) == 0) {
                if (graph.getModel().getEdgeCount(tmp) == 0) {
                    roots = graph.findTreeRoots(graph.getDefaultParent());
                }
            } else {
                roots = graph.findTreeRoots(tmp);
            }

            if (roots != null && roots.length > 0) {
                tmp = roots[0];
            }

            if (tmp != null) {
                var layout = new mxRadialTreeLayout(graph, false);
                layout.levelDistance = 80;
                layout.autoRadius = true;

                promptSpacing(layout.levelDistance, mxUtils.bind(this, function (newValue) {
                    layout.levelDistance = newValue;

                    this.editorUi.executeLayout(function () {
                        layout.execute(graph.getDefaultParent(), tmp);

                        if (!graph.isSelectionEmpty()) {
                            tmp = graph.getModel().getParent(tmp);

                            if (graph.getModel().isVertex(tmp)) {
                                graph.updateGroupBounds([tmp], graph.gridSize * 2, true);
                            }
                        }
                    }, true);
                }));
            }
        }), parent);
        menu.addSeparator(parent);
        menu.addItem(mxResources.get('organic'), null, mxUtils.bind(this, function () {
            var layout = new mxFastOrganicLayout(graph);

            promptSpacing(layout.forceConstant, mxUtils.bind(this, function (newValue) {
                layout.forceConstant = newValue;

                this.editorUi.executeLayout(function () {
                    var tmp = graph.getSelectionCell();

                    if (tmp == null || graph.getModel().getChildCount(tmp) == 0) {
                        tmp = graph.getDefaultParent();
                    }

                    layout.execute(tmp);

                    if (graph.getModel().isVertex(tmp)) {
                        graph.updateGroupBounds([tmp], graph.gridSize * 2, true);
                    }
                }, true);
            }));
        }), parent);
        menu.addItem(mxResources.get('circle'), null, mxUtils.bind(this, function () {
            var layout = new mxCircleLayout(graph);

            this.editorUi.executeLayout(function () {
                var tmp = graph.getSelectionCell();

                if (tmp == null || graph.getModel().getChildCount(tmp) == 0) {
                    tmp = graph.getDefaultParent();
                }

                layout.execute(tmp);

                if (graph.getModel().isVertex(tmp)) {
                    graph.updateGroupBounds([tmp], graph.gridSize * 2, true);
                }
            }, true);
        }), parent);
    })));
    this.put('navigation', new Menu(mxUtils.bind(this, function (menu, parent) {
        this.addMenuItems(menu, ['home', '-', 'exitGroup', 'enterGroup', '-', 'expand', 'collapse', '-', 'collapsible'], parent);
    })));

    this.put('insert', new Menu(mxUtils.bind(this, function (menu, parent) {
        this.addMenuItems(menu, ['insertLink', 'insertImage'], parent);
    })));

    this.put('view', new Menu(mxUtils.bind(this, function (menu, parent) {
        this.addMenuItems(menu, ((this.editorUi.format != null) ? ['formatPanel'] : []).concat(['outline', 'layers', '-', 'pageView', 'pageScale', '-', 'scrollbars', 'tooltips', '-',
            'grid', 'guides', '-', 'connectionArrows', 'connectionPoints', '-',
            'resetView', 'zoomIn', 'zoomOut'], parent));
    })));
    // Two special dropdowns that are only used in the toolbar
    this.put('viewPanels', new Menu(mxUtils.bind(this, function (menu, parent) {
        if (this.editorUi.format != null) {
            this.addMenuItems(menu, ['formatPanel'], parent);
        }

        this.addMenuItems(menu, ['outline', 'layers'], parent);
    })));
    this.put('viewZoom', new Menu(mxUtils.bind(this, function (menu, parent) {
        this.addMenuItems(menu, ['resetView', '-'], parent);
        var scales = [0.25, 0.5, 0.75, 1, 1.25, 1.5, 2, 3, 4];

        for (var i = 0; i < scales.length; i++) {
            (function (scale) {
                menu.addItem((scale * 100) + '%', null, function () {
                    graph.zoomTo(scale);
                }, parent);
            })(scales[i]);
        }

        this.addMenuItems(menu, ['-', 'fitWindow', 'fitPageWidth', 'fitPage', 'fitTwoPages', '-', 'customZoom'], parent);
    })));
};

/**
 * Adds the label menu items to the given menu and parent.
 */
Menus.prototype.put = function (name, menu) {
    this.menus[name] = menu;

    return menu;
};

/**
 * Adds the label menu items to the given menu and parent.
 */
Menus.prototype.get = function (name) {
    return this.menus[name];
};

/**
 * Adds the given submenu.
 */
Menus.prototype.addSubmenu = function (name, menu, parent, label) {
    var entry = this.get(name);

    if (entry != null) {
        var enabled = entry.isEnabled();

        if (menu.showDisabled || enabled) {
            var submenu = menu.addItem(label || mxResources.get(name), null, null, parent, null, enabled);
            this.addMenu(name, menu, submenu);
        }
    }
};

/**
 * Adds the label menu items to the given menu and parent.
 */
Menus.prototype.addMenu = function (name, popupMenu, parent) {
    var menu = this.get(name);

    if (menu != null && (popupMenu.showDisabled || menu.isEnabled())) {
        this.get(name).execute(popupMenu, parent);
    }
};

/**
 * Adds a menu item to insert a table.
 */
Menus.prototype.addInsertTableItem = function (menu) {
    // KNOWN: Does not work in IE8 standards and quirks
    var graph = this.editorUi.editor.graph;

    function createTable(rows, cols) {
        var html = ['<table>'];

        for (var i = 0; i < rows; i++) {
            html.push('<tr>');

            for (var j = 0; j < cols; j++) {
                html.push('<td><br></td>');
            }

            html.push('</tr>');
        }

        html.push('</table>');

        return html.join('');
    };

    // Show table size dialog
    var elt2 = menu.addItem('', null, mxUtils.bind(this, function (evt) {
        var td = graph.getParentByName(mxEvent.getSource(evt), 'TD');

        if (td != null && graph.cellEditor.textarea != null) {
            var row2 = graph.getParentByName(td, 'TR');

            // To find the new link, we create a list of all existing links first
            // LATER: Refactor for reuse with code for finding inserted image below
            var tmp = graph.cellEditor.textarea.getElementsByTagName('table');
            var oldTables = [];

            for (var i = 0; i < tmp.length; i++) {
                oldTables.push(tmp[i]);
            }

            // Finding the new table will work with insertHTML, but IE does not support that
            graph.container.focus();
            graph.pasteHtmlAtCaret(createTable(row2.sectionRowIndex + 1, td.cellIndex + 1));

            // Moves cursor to first table cell
            var newTables = graph.cellEditor.textarea.getElementsByTagName('table');

            if (newTables.length == oldTables.length + 1) {
                // Inverse order in favor of appended tables
                for (var i = newTables.length - 1; i >= 0; i--) {
                    if (i == 0 || newTables[i] != oldTables[i - 1]) {
                        graph.selectNode(newTables[i].rows[0].cells[0]);
                        break;
                    }
                }
            }
        }
    }));

    // Quirks mode does not add cell padding if cell is empty, needs good old spacer solution
    var quirksCellHtml = '<img src="' + mxClient.imageBasePath + '/transparent.gif' + '" width="16" height="16"/>';

    function createPicker(rows, cols) {
        var table2 = document.createElement('table');
        table2.setAttribute('border', '1');
        table2.style.borderCollapse = 'collapse';

        if (!mxClient.IS_QUIRKS) {
            table2.setAttribute('cellPadding', '8');
        }

        for (var i = 0; i < rows; i++) {
            var row = table2.insertRow(i);

            for (var j = 0; j < cols; j++) {
                var cell = row.insertCell(-1);

                if (mxClient.IS_QUIRKS) {
                    cell.innerHTML = quirksCellHtml;
                }
            }
        }

        return table2;
    };

    function extendPicker(picker, rows, cols) {
        for (var i = picker.rows.length; i < rows; i++) {
            var row = picker.insertRow(i);

            for (var j = 0; j < picker.rows[0].cells.length; j++) {
                var cell = row.insertCell(-1);

                if (mxClient.IS_QUIRKS) {
                    cell.innerHTML = quirksCellHtml;
                }
            }
        }

        for (var i = 0; i < picker.rows.length; i++) {
            var row = picker.rows[i];

            for (var j = row.cells.length; j < cols; j++) {
                var cell = row.insertCell(-1);

                if (mxClient.IS_QUIRKS) {
                    cell.innerHTML = quirksCellHtml;
                }
            }
        }
    };

    elt2.firstChild.innerHTML = '';
    var picker = createPicker(5, 5);
    elt2.firstChild.appendChild(picker);

    var label = document.createElement('div');
    label.style.padding = '4px';
    label.style.fontSize = Menus.prototype.defaultFontSize + 'px';
    label.innerHTML = '1x1';
    elt2.firstChild.appendChild(label);

    mxEvent.addListener(picker, 'mouseover', function (e) {
        var td = graph.getParentByName(mxEvent.getSource(e), 'TD');

        if (td != null) {
            var row2 = graph.getParentByName(td, 'TR');
            extendPicker(picker, Math.min(20, row2.sectionRowIndex + 2), Math.min(20, td.cellIndex + 2));
            label.innerHTML = (td.cellIndex + 1) + 'x' + (row2.sectionRowIndex + 1);

            for (var i = 0; i < picker.rows.length; i++) {
                var r = picker.rows[i];

                for (var j = 0; j < r.cells.length; j++) {
                    var cell = r.cells[j];

                    if (i <= row2.sectionRowIndex && j <= td.cellIndex) {
                        cell.style.backgroundColor = 'blue';
                    } else {
                        cell.style.backgroundColor = 'white';
                    }
                }
            }

            mxEvent.consume(e);
        }
    });
};

/**
 * Adds a style change item to the given menu.
 */
Menus.prototype.edgeStyleChange = function (menu, label, keys, values, sprite, parent, reset) {
    return menu.addItem(label, null, mxUtils.bind(this, function () {
        var graph = this.editorUi.editor.graph;
        graph.stopEditing(false);

        graph.getModel().beginUpdate();
        try {
            var cells = graph.getSelectionCells();
            var edges = [];

            for (var i = 0; i < cells.length; i++) {
                var cell = cells[i];

                if (graph.getModel().isEdge(cell)) {
                    if (reset) {
                        var geo = graph.getCellGeometry(cell);

                        // Resets all edge points
                        if (geo != null) {
                            geo = geo.clone();
                            geo.points = null;
                            graph.getModel().setGeometry(cell, geo);
                        }
                    }

                    for (var j = 0; j < keys.length; j++) {
                        graph.setCellStyles(keys[j], values[j], [cell]);
                    }

                    edges.push(cell);
                }
            }

            this.editorUi.fireEvent(new mxEventObject('styleChanged', 'keys', keys,
                'values', values, 'cells', edges));
        } finally {
            graph.getModel().endUpdate();
        }
    }), parent, sprite);
};

/**
 * Adds a style change item to the given menu.
 */
Menus.prototype.styleChange = function (menu, label, keys, values, sprite, parent, fn, post) {
    var apply = this.createStyleChangeFunction(keys, values);

    return menu.addItem(label, null, mxUtils.bind(this, function () {
        var graph = this.editorUi.editor.graph;

        if (fn != null && graph.cellEditor.isContentEditing()) {
            fn();
        } else {
            apply(post);
        }
    }), parent, sprite);
};

/**
 *
 */
Menus.prototype.createStyleChangeFunction = function (keys, values) {
    return mxUtils.bind(this, function (post) {
        var graph = this.editorUi.editor.graph;
        graph.stopEditing(false);

        graph.getModel().beginUpdate();
        try {
            for (var i = 0; i < keys.length; i++) {
                graph.setCellStyles(keys[i], values[i]);

                // Removes CSS alignment to produce consistent output
                if (keys[i] == mxConstants.STYLE_ALIGN) {
                    graph.updateLabelElements(graph.getSelectionCells(), function (elt) {
                        elt.removeAttribute('align');
                        elt.style.textAlign = null;
                    });
                }
            }

            if (post != null) {
                post();
            }

            this.editorUi.fireEvent(new mxEventObject('styleChanged', 'keys', keys, 'values', values,
                'cells', graph.getSelectionCells()));
        } finally {
            graph.getModel().endUpdate();
        }
    });
};

/**
 * Adds a style change item with a prompt to the given menu.
 */
Menus.prototype.promptChange = function (menu, label, hint, defaultValue, key, parent, enabled, fn, sprite) {
    return menu.addItem(label, null, mxUtils.bind(this, function () {
        var graph = this.editorUi.editor.graph;
        var value = defaultValue;
        var state = graph.getView().getState(graph.getSelectionCell());

        if (state != null) {
            value = state.style[key] || value;
        }

        var dlg = new FilenameDialog(this.editorUi, value, mxResources.get('apply'), mxUtils.bind(this, function (newValue) {
            if (newValue != null && newValue.length > 0) {
                graph.getModel().beginUpdate();
                try {
                    graph.stopEditing(false);
                    graph.setCellStyles(key, newValue);
                } finally {
                    graph.getModel().endUpdate();
                }

                if (fn != null) {
                    fn(newValue);
                }
            }
        }), mxResources.get('enterValue') + ((hint.length > 0) ? (' ' + hint) : ''));
        this.editorUi.showDialog(dlg.container, 300, 80, true, true);
        dlg.init();
    }), parent, sprite, enabled);
};

/**
 * Adds a handler for showing a menu in the given element.
 */
Menus.prototype.pickColor = function (key, cmd, defaultValue) {
    var graph = this.editorUi.editor.graph;
    var h = 270 + ((Math.ceil(ColorDialog.prototype.presetColors.length / 12) +
        Math.ceil(ColorDialog.prototype.defaultColors.length / 12)) * 17);

    if (cmd != null && graph.cellEditor.isContentEditing()) {
        // Saves and restores text selection for in-place editor
        var selState = graph.cellEditor.saveSelection();

        var dlg = new ColorDialog(this.editorUi, defaultValue || '000000', mxUtils.bind(this, function (color) {
            graph.cellEditor.restoreSelection(selState);
            document.execCommand(cmd, false, (color != mxConstants.NONE) ? color : 'transparent');
        }), function () {
            graph.cellEditor.restoreSelection(selState);
        });
        this.editorUi.showDialog(dlg.container, 300, h, true, true);
        dlg.init();
    } else {
        if (this.colorDialog == null) {
            this.colorDialog = new ColorDialog(this.editorUi);
        }

        this.colorDialog.currentColorKey = key;
        var state = graph.getView().getState(graph.getSelectionCell());
        var color = 'none';

        if (state != null) {
            color = state.style[key] || color;
        }

        if (color == 'none') {
            color = 'ffffff';
            this.colorDialog.picker.fromString('ffffff');
            this.colorDialog.colorInput.value = 'none';
        } else {
            this.colorDialog.picker.fromString(color);
        }

        this.editorUi.showDialog(this.colorDialog.container, 300, h, true, true);
        this.colorDialog.init();
    }
};

/**
 * Adds a handler for showing a menu in the given element.
 */
Menus.prototype.toggleStyle = function (key, defaultValue) {
    var graph = this.editorUi.editor.graph;
    var value = graph.toggleCellStyles(key, defaultValue);
    this.editorUi.fireEvent(new mxEventObject('styleChanged', 'keys', [key], 'values', [value],
        'cells', graph.getSelectionCells()));
};

/**
 * Creates the keyboard event handler for the current graph and history.
 */
Menus.prototype.addMenuItem = function (menu, key, parent, trigger, sprite, label) {
    var action = this.editorUi.actions.get(key);

    if (action != null && (menu.showDisabled || action.isEnabled()) && action.visible) {
        var item = menu.addItem(label || action.label, null, function () {
            action.funct(trigger);
        }, parent, sprite, action.isEnabled());

        // Adds checkmark image
        if (action.toggleAction && action.isSelected()) {
            menu.addCheckmark(item, Editor.checkmarkImage);
        }

        this.addShortcut(item, action);

        return item;
    }

    return null;
};

/**
 * Adds a checkmark to the given menuitem.
 */
Menus.prototype.addShortcut = function (item, action) {
    if (action.shortcut != null) {
        var td = item.firstChild.nextSibling.nextSibling;
        var span = document.createElement('span');
        span.style.color = 'gray';
        mxUtils.write(span, action.shortcut);
        td.appendChild(span);
    }
};

/**
 * Creates the keyboard event handler for the current graph and history.
 */
Menus.prototype.addMenuItems = function (menu, keys, parent, trigger, sprites) {
    for (var i = 0; i < keys.length; i++) {
        if (keys[i] == '-') {
            menu.addSeparator(parent);
        } else {
            this.addMenuItem(menu, keys[i], parent, trigger, (sprites != null) ? sprites[i] : null);
        }
    }
};

/**
 * Creates the keyboard event handler for the current graph and history.
 */
Menus.prototype.createPopupMenu = function (menu, cell, evt) {
    var graph = this.editorUi.editor.graph;
    menu.smartSeparators = true;

    if (graph.isSelectionEmpty()) {
        this.addMenuItems(menu, ['undo', 'redo', 'pasteHere'], null, evt);
    } else {
        this.addMenuItems(menu, ['delete', '-', 'cut', 'copy', '-', 'duplicate'], null, evt);
    }

    if (!graph.isSelectionEmpty()) {
        if (graph.getSelectionCount() == 1) {
            this.addMenuItems(menu, ['setAsDefaultStyle'], null, evt);
        }

        menu.addSeparator();

        cell = graph.getSelectionCell();
        var state = graph.view.getState(cell);

        if (state != null) {
            var hasWaypoints = false;
            this.addMenuItems(menu, ['toFront', 'toBack', '-'], null, evt);

            if (graph.getModel().isEdge(cell) && mxUtils.getValue(state.style, mxConstants.STYLE_EDGE, null) != 'entityRelationEdgeStyle' &&
                mxUtils.getValue(state.style, mxConstants.STYLE_SHAPE, null) != 'arrow') {
                var handler = graph.selectionCellsHandler.getHandler(cell);
                var isWaypoint = false;

                if (handler instanceof mxEdgeHandler && handler.bends != null && handler.bends.length > 2) {
                    var index = handler.getHandleForEvent(graph.updateMouseEvent(new mxMouseEvent(evt)));

                    // Configures removeWaypoint action before execution
                    // Using trigger parameter is cleaner but have to find waypoint here anyway.
                    var rmWaypointAction = this.editorUi.actions.get('removeWaypoint');
                    rmWaypointAction.handler = handler;
                    rmWaypointAction.index = index;

                    isWaypoint = index > 0 && index < handler.bends.length - 1;
                }

                menu.addSeparator();
                this.addMenuItem(menu, 'turn', null, evt, null, mxResources.get('reverse'));
                this.addMenuItems(menu, [(isWaypoint) ? 'removeWaypoint' : 'addWaypoint'], null, evt);

                // Adds reset waypoints option if waypoints exist
                var geo = graph.getModel().getGeometry(cell);
                hasWaypoints = geo != null && geo.points != null && geo.points.length > 0;
            }

            if (graph.getSelectionCount() == 1 && (hasWaypoints || (graph.getModel().isVertex(cell) &&
                graph.getModel().getEdgeCount(cell) > 0))) {
                this.addMenuItems(menu, ['clearWaypoints'], null, evt);
            }

            if (graph.getSelectionCount() > 1) {
                menu.addSeparator();
                this.addMenuItems(menu, ['group'], null, evt);
            } else if (graph.getSelectionCount() == 1 && !graph.getModel().isEdge(cell) && !graph.isSwimlane(cell) &&
                graph.getModel().getChildCount(cell) > 0) {
                menu.addSeparator();
                this.addMenuItems(menu, ['ungroup'], null, evt);
            }

            if (graph.getSelectionCount() == 1) {
                menu.addSeparator();
                this.addMenuItems(menu, ['editData', 'editLink'], null, evt);

                // Shows edit image action if there is an image in the style
                if (graph.getModel().isVertex(cell) && mxUtils.getValue(state.style, mxConstants.STYLE_IMAGE, null) != null) {
                    menu.addSeparator();
                    this.addMenuItem(menu, 'image', null, evt).firstChild.nextSibling.innerHTML = mxResources.get('editImage') + '...';
                }
            }
        }
    } else {
        this.addMenuItems(menu, ['-', 'selectVertices', 'selectEdges',
            'selectAll', '-', 'clearDefaultStyle'], null, evt);
    }
};

/**
 * Creates the keyboard event handler for the current graph and history.
 */
Menus.prototype.createMenubar = function (container) {
    var menubar = new Menubar(this.editorUi, container);
    var menus = this.defaultMenuItems;

    for (var i = 0; i < menus.length; i++) {
        (mxUtils.bind(this, function (menu) {
            var elt = menubar.addMenu(mxResources.get(menus[i]), mxUtils.bind(this, function () {
                // Allows extensions of menu.funct
                menu.funct.apply(this, arguments);
            }));

            this.menuCreated(menu, elt);
        }))(this.get(menus[i]));
    }
    var self = this;
    //Aric.chen add 设备关联Panel
    var html = `<div class="prototype-device-placeholder-setting-box">
                    <button type="button" class="go-back-device-view-btn"><i class="fa fa-arrow-left"></i>&nbsp;返回设备可视化</button>
                    <button type="button" class="create-device-relation-btn" style="margin-left: 8px;"><i class="fa fa-map-marker"></i>&nbsp;创建设备关联</button>
                    <button type="button" class="prototype-preview" style="margin-left: 8px;"><i class="fa fa-fire"></i>&nbsp;预览</button>
                </div>`;
    container.appendChild($(html)[0]);

    $(container).find(".prototype-device-placeholder-setting-box .go-back-device-view-btn").click(function () {
        self.goToMenuDeviceView();
    });

    $(container).find('.prototype-device-placeholder-setting-box .create-device-relation-btn').click(function () {
        self.showDevicePlaceHolder();
    });

    $(container).find('.prototype-device-placeholder-setting-box .prototype-preview').click(function () {
        self.prototypePreview();
    });
    return menubar;
};

Menus.prototype.prototypePreview = function () {
    var id = NeptuneUtils.findGetParameter('id');
    window.open('/monitor_developer/preview?id=' + id, "_blank");
};

Menus.prototype.goToMenuDeviceView = function () {
    window.location.href = "http://" + window.location.host + "/#/app/triton/menu/3";
};

Menus.prototype.showDevicePlaceHolder = function () {
    var graph = this.editorUi.editor.graph;
    var id = NeptuneUtils.findGetParameter('id');
    NeptuneUtils.getPlaceholderList(id).done(function (list) {
        NeptuneUtils.showDevicePlaceHolderDialog({
            value: {
                devicePlaceHolderList: list
            }
        }).done(function (params) {
            var placeholders = JSON.stringify(params.value.devicePlaceHolderList);
            NeptuneHttp.post('monitor_developer/saveDevicePlaceholders', {
                id: id,
                placeholders: placeholders
            });
            var cells = graph.getSelectionCells();
            graph.clearSelection();
            graph.setSelectionCells(cells);
        });
    });
};

/**
 * Creates the keyboard event handler for the current graph and history.
 */
Menus.prototype.menuCreated = function (menu, elt, className) {
    if (elt != null) {
        className = (className != null) ? className : 'geItem';

        menu.addListener('stateChanged', function () {
            elt.enabled = menu.enabled;

            if (!menu.enabled) {
                elt.className = className + ' mxDisabled';

                if (document.documentMode == 8) {
                    elt.style.color = '#c3c3c3';
                }
            } else {
                elt.className = className;

                if (document.documentMode == 8) {
                    elt.style.color = '';
                }
            }
        });
    }
};

/**
 * Construcs a new menubar for the given editor.
 */
function Menubar(editorUi, container) {
    this.editorUi = editorUi;
    this.container = container;
};

/**
 * Adds the menubar elements.
 */
Menubar.prototype.hideMenu = function () {
    this.editorUi.hideCurrentMenu();
};

/**
 * Adds a submenu to this menubar.
 */
Menubar.prototype.addMenu = function (label, funct, before) {
    var elt = document.createElement('a');
    elt.className = 'geItem';
    mxUtils.write(elt, label);
    this.addMenuHandler(elt, funct);

    if (before != null) {
        this.container.insertBefore(elt, before);
    } else {
        this.container.appendChild(elt);
    }

    return elt;
};

/**
 * Adds a handler for showing a menu in the given element.
 */
Menubar.prototype.addMenuHandler = function (elt, funct) {
    if (funct != null) {
        var show = true;

        var clickHandler = mxUtils.bind(this, function (evt) {
            if (show && elt.enabled == null || elt.enabled) {
                this.editorUi.editor.graph.popupMenuHandler.hideMenu();
                var menu = new mxPopupMenu(funct);
                menu.div.className += ' geMenubarMenu';
                menu.smartSeparators = true;
                menu.showDisabled = true;
                menu.autoExpand = true;

                // Disables autoexpand and destroys menu when hidden
                menu.hideMenu = mxUtils.bind(this, function () {
                    mxPopupMenu.prototype.hideMenu.apply(menu, arguments);
                    this.editorUi.resetCurrentMenu();
                    menu.destroy();
                });

                var offset = mxUtils.getOffset(elt);
                menu.popup(offset.x, offset.y + elt.offsetHeight, null, evt);
                this.editorUi.setCurrentMenu(menu, elt);
            }

            mxEvent.consume(evt);
        });

        // Shows menu automatically while in expanded state
        mxEvent.addListener(elt, 'mousemove', mxUtils.bind(this, function (evt) {
            if (this.editorUi.currentMenu != null && this.editorUi.currentMenuElt != elt) {
                this.editorUi.hideCurrentMenu();
                clickHandler(evt);
            }
        }));

        // Hides menu if already showing and prevents focus
        mxEvent.addListener(elt, (mxClient.IS_POINTER) ? 'pointerdown' : 'mousedown',
            mxUtils.bind(this, function (evt) {
                show = this.currentElt != elt;
                evt.preventDefault();
            }));

        mxEvent.addListener(elt, 'click', mxUtils.bind(this, function (evt) {
            clickHandler(evt);
            show = true;
        }));
    }
};

/**
 * Creates the keyboard event handler for the current graph and history.
 */
Menubar.prototype.destroy = function () {
    // do nothing
};

/**
 * Constructs a new action for the given parameters.
 */
function Menu(funct, enabled) {
    mxEventSource.call(this);
    this.funct = funct;
    this.enabled = (enabled != null) ? enabled : true;
};

// Menu inherits from mxEventSource
mxUtils.extend(Menu, mxEventSource);

/**
 * Sets the enabled state of the action and fires a stateChanged event.
 */
Menu.prototype.isEnabled = function () {
    return this.enabled;
};

/**
 * Sets the enabled state of the action and fires a stateChanged event.
 */
Menu.prototype.setEnabled = function (value) {
    if (this.enabled != value) {
        this.enabled = value;
        this.fireEvent(new mxEventObject('stateChanged'));
    }
};

/**
 * Sets the enabled state of the action and fires a stateChanged event.
 */
Menu.prototype.execute = function (menu, parent) {
    this.funct(menu, parent);
};

/**
 * "Installs" menus in EditorUi.
 */
EditorUi.prototype.createMenus = function () {
    return new Menus(this);
};

/**
 * Copyright (c) 2006-2012, JGraph Ltd
 */
/**
 * Construcs a new toolbar for the given editor.
 */
function Toolbar(editorUi, container) {
    this.editorUi = editorUi;
    this.container = container;
    this.staticElements = [];
    this.init();

    // Global handler to hide the current menu
    this.gestureHandler = mxUtils.bind(this, function (evt) {
        if (this.editorUi.currentMenu != null && mxEvent.getSource(evt) != this.editorUi.currentMenu.div) {
            this.hideMenu();
        }
    });

    mxEvent.addGestureListeners(document, this.gestureHandler);
};

/**
 * Image for the dropdown arrow.
 */
Toolbar.prototype.dropdownImage = (!mxClient.IS_SVG) ? IMAGE_PATH + '/dropdown.gif' : 'data:image/gif;base64,R0lGODlhDQANAIABAHt7e////yH/C1hNUCBEYXRhWE1QPD94cGFja2V0IGJlZ2luPSLvu78iIGlkPSJXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQiPz4gPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iQWRvYmUgWE1QIENvcmUgNS4wLWMwNjAgNjEuMTM0Nzc3LCAyMDEwLzAyLzEyLTE3OjMyOjAwICAgICAgICAiPiA8cmRmOlJERiB4bWxuczpyZGY9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkvMDIvMjItcmRmLXN5bnRheC1ucyMiPiA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDpCREM1NkJFMjE0NEMxMUU1ODk1Q0M5MjQ0MTA4QjNDMSIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDpCREM1NkJFMzE0NEMxMUU1ODk1Q0M5MjQ0MTA4QjNDMSI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkQzOUMzMjZCMTQ0QjExRTU4OTVDQzkyNDQxMDhCM0MxIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOkQzOUMzMjZDMTQ0QjExRTU4OTVDQzkyNDQxMDhCM0MxIi8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+Af/+/fz7+vn49/b19PPy8fDv7u3s6+rp6Ofm5eTj4uHg397d3Nva2djX1tXU09LR0M/OzczLysnIx8bFxMPCwcC/vr28u7q5uLe2tbSzsrGwr66trKuqqainpqWko6KhoJ+enZybmpmYl5aVlJOSkZCPjo2Mi4qJiIeGhYSDgoGAf359fHt6eXh3dnV0c3JxcG9ubWxramloZ2ZlZGNiYWBfXl1cW1pZWFdWVVRTUlFQT05NTEtKSUhHRkVEQ0JBQD8+PTw7Ojk4NzY1NDMyMTAvLi0sKyopKCcmJSQjIiEgHx4dHBsaGRgXFhUUExIREA8ODQwLCgkIBwYFBAMCAQAAIfkEAQAAAQAsAAAAAA0ADQAAAhGMj6nL3QAjVHIu6azbvPtWAAA7';

/**
 * Image element for the dropdown arrow.
 */
Toolbar.prototype.dropdownImageHtml = '<img border="0" style="position:absolute;right:4px;top:' +
    ((!EditorUi.compactUi) ? 8 : 6) + 'px;" src="' + Toolbar.prototype.dropdownImage + '" valign="middle"/>';

/**
 * Defines the background for selected buttons.
 */
Toolbar.prototype.selectedBackground = '#d0d0d0';

/**
 * Defines the background for selected buttons.
 */
Toolbar.prototype.unselectedBackground = 'none';

/**
 * Array that contains the DOM nodes that should never be removed.
 */
Toolbar.prototype.staticElements = null;

/**
 * Adds the toolbar elements.
 */
Toolbar.prototype.init = function () {
    var sw = screen.width;

    // Takes into account initial compact mode
    sw -= (screen.height > 740) ? 56 : 0;

    if (sw >= 700) {
        var formatMenu = this.addMenu('', mxResources.get('view') + ' (' + mxResources.get('panTooltip') + ')', true, 'viewPanels', null, true);
        this.addDropDownArrow(formatMenu, 'geSprite-formatpanel', 38, 50, -4, -3, 36, -8);
        this.addSeparator();
    }

    var viewMenu = this.addMenu('', mxResources.get('zoom') + ' (Alt+Mousewheel)', true, 'viewZoom', null, true);
    viewMenu.showDisabled = true;
    viewMenu.style.whiteSpace = 'nowrap';
    viewMenu.style.position = 'relative';
    viewMenu.style.overflow = 'hidden';

    if (EditorUi.compactUi) {
        viewMenu.style.width = (mxClient.IS_QUIRKS) ? '58px' : '50px';
    } else {
        viewMenu.style.width = (mxClient.IS_QUIRKS) ? '62px' : '36px';
    }

    if (sw >= 420) {
        this.addSeparator();
        var elts = this.addItems(['zoomIn', 'zoomOut']);
        elts[0].setAttribute('title', mxResources.get('zoomIn') + ' (' + this.editorUi.actions.get('zoomIn').shortcut + ')');
        elts[1].setAttribute('title', mxResources.get('zoomOut') + ' (' + this.editorUi.actions.get('zoomOut').shortcut + ')');
    }

    // Updates the label if the scale changes
    this.updateZoom = mxUtils.bind(this, function () {
        viewMenu.innerHTML = Math.round(this.editorUi.editor.graph.view.scale * 100) + '%' +
            this.dropdownImageHtml;

        if (EditorUi.compactUi) {
            viewMenu.getElementsByTagName('img')[0].style.right = '1px';
            viewMenu.getElementsByTagName('img')[0].style.top = '5px';
        }
    });

    this.editorUi.editor.graph.view.addListener(mxEvent.EVENT_SCALE, this.updateZoom);
    this.editorUi.editor.addListener('resetGraphView', this.updateZoom);

    var elts = this.addItems(['-', 'undo', 'redo']);
    elts[1].setAttribute('title', mxResources.get('undo') + ' (' + this.editorUi.actions.get('undo').shortcut + ')');
    elts[2].setAttribute('title', mxResources.get('redo') + ' (' + this.editorUi.actions.get('redo').shortcut + ')');

    if (sw >= 320) {
        var elts = this.addItems(['-', 'delete']);
        elts[1].setAttribute('title', mxResources.get('delete') + ' (' + this.editorUi.actions.get('delete').shortcut + ')');
    }

    this.addItems(['-', 'toFront', 'toBack']);

    this.addSeparator();

    this.edgeShapeMenu = this.addMenuFunction('', mxResources.get('connection'), false, mxUtils.bind(this, function (menu) {
        this.editorUi.menus.edgeStyleChange(menu, '', [mxConstants.STYLE_SHAPE, 'width'], [null, null], 'geIcon geSprite geSprite-connection', null, true).setAttribute('title', mxResources.get('line'));
        this.editorUi.menus.edgeStyleChange(menu, '', [mxConstants.STYLE_SHAPE, 'width'], ['link', null], 'geIcon geSprite geSprite-linkedge', null, true).setAttribute('title', mxResources.get('link'));
        this.editorUi.menus.edgeStyleChange(menu, '', [mxConstants.STYLE_SHAPE, 'width'], ['flexArrow', null], 'geIcon geSprite geSprite-arrow', null, true).setAttribute('title', mxResources.get('arrow'));
        this.editorUi.menus.edgeStyleChange(menu, '', [mxConstants.STYLE_SHAPE, 'width'], ['arrow', null], 'geIcon geSprite geSprite-simplearrow', null, true).setAttribute('title', mxResources.get('simpleArrow'));
    }));

    this.addDropDownArrow(this.edgeShapeMenu, 'geSprite-connection', 44, 50, 0, 0, 22, -4);

    this.edgeStyleMenu = this.addMenuFunction('geSprite-orthogonal', mxResources.get('waypoints'), false, mxUtils.bind(this, function (menu) {
        this.editorUi.menus.edgeStyleChange(menu, '', [mxConstants.STYLE_EDGE, mxConstants.STYLE_CURVED, mxConstants.STYLE_NOEDGESTYLE], [null, null, null], 'geIcon geSprite geSprite-straight', null, true).setAttribute('title', mxResources.get('straight'));
        this.editorUi.menus.edgeStyleChange(menu, '', [mxConstants.STYLE_EDGE, mxConstants.STYLE_CURVED, mxConstants.STYLE_NOEDGESTYLE], ['orthogonalEdgeStyle', null, null], 'geIcon geSprite geSprite-orthogonal', null, true).setAttribute('title', mxResources.get('orthogonal'));
        this.editorUi.menus.edgeStyleChange(menu, '', [mxConstants.STYLE_EDGE, mxConstants.STYLE_ELBOW, mxConstants.STYLE_CURVED, mxConstants.STYLE_NOEDGESTYLE], ['elbowEdgeStyle', null, null, null], 'geIcon geSprite geSprite-horizontalelbow', null, true).setAttribute('title', mxResources.get('simple'));
        this.editorUi.menus.edgeStyleChange(menu, '', [mxConstants.STYLE_EDGE, mxConstants.STYLE_ELBOW, mxConstants.STYLE_CURVED, mxConstants.STYLE_NOEDGESTYLE], ['elbowEdgeStyle', 'vertical', null, null], 'geIcon geSprite geSprite-verticalelbow', null, true).setAttribute('title', mxResources.get('simple'));
        this.editorUi.menus.edgeStyleChange(menu, '', [mxConstants.STYLE_EDGE, mxConstants.STYLE_ELBOW, mxConstants.STYLE_CURVED, mxConstants.STYLE_NOEDGESTYLE], ['isometricEdgeStyle', null, null, null], 'geIcon geSprite geSprite-horizontalisometric', null, true).setAttribute('title', mxResources.get('isometric'));
        this.editorUi.menus.edgeStyleChange(menu, '', [mxConstants.STYLE_EDGE, mxConstants.STYLE_ELBOW, mxConstants.STYLE_CURVED, mxConstants.STYLE_NOEDGESTYLE], ['isometricEdgeStyle', 'vertical', null, null], 'geIcon geSprite geSprite-verticalisometric', null, true).setAttribute('title', mxResources.get('isometric'));
        this.editorUi.menus.edgeStyleChange(menu, '', [mxConstants.STYLE_EDGE, mxConstants.STYLE_CURVED, mxConstants.STYLE_NOEDGESTYLE], ['orthogonalEdgeStyle', '1', null], 'geIcon geSprite geSprite-curved', null, true).setAttribute('title', mxResources.get('curved'));
        this.editorUi.menus.edgeStyleChange(menu, '', [mxConstants.STYLE_EDGE, mxConstants.STYLE_CURVED, mxConstants.STYLE_NOEDGESTYLE], ['entityRelationEdgeStyle', null, null], 'geIcon geSprite geSprite-entity', null, true).setAttribute('title', mxResources.get('entityRelation'));
    }));

    this.addDropDownArrow(this.edgeStyleMenu, 'geSprite-orthogonal', 44, 50, 0, 0, 22, -4);

    this.addSeparator();
    /*Align的Dropdown*/
    var insertMenu = this.addMenu('', mxResources.get('align'), true, 'align', null, true);
    this.addDropDownButton(insertMenu, 'fa fa-align-center', '对齐');

    var insertMenu = this.addMenu('', mxResources.get('distribute'), true, 'distribute', null, true);
    this.addDropDownButton(insertMenu, 'fa fa-exchange', '等距分布');

    /*aric.chen::::增加快捷按钮*/
    var elts = this.addItems(['-', 'lockUnlock']);
    this.addToolbarButton(elts[1], 'fa fa-lock', '锁定');

    this.addSeparator();
    var elts = this.addItems(['group', 'ungroup']);
    this.addToolbarButton(elts[0], 'fa fa-object-group', '组合');
    this.addToolbarButton(elts[1], 'fa fa-object-ungroup', '打散');

    this.addSeparator();

    var insertMenu = this.addMenu('', mxResources.get('insert') + ' (' + mxResources.get('doubleClickTooltip') + ')', true, 'insert', null, true);
    this.addDropDownButton(insertMenu, 'fa fa-plus', '插入');
};

Toolbar.prototype.addToolbarButton = function (element, style, label) {
    element.class = '';
    var html = `<div class="mxgraph-toolbar-button"><i class="${style}"></i><span>${label}</span></div>`;
    element.innerHTML = html;
};

/*Aric.chen*/
Toolbar.prototype.addDropDownButton = function (menu, style, label) {
    menu.style.whiteSpace = 'nowrap';
    menu.style.overflow = 'hidden';
    menu.style.position = 'relative';

    var html = `<div class="mxgraph-toolbar-dropdpwn-button"><i class="${style}"></i><span>${label}</span></div>`;

    menu.innerHTML = html;
}

/**
 * Adds the toolbar elements.
 */
Toolbar.prototype.addDropDownArrow = function (menu, sprite, width, atlasWidth, left, top, atlasDelta, atlasLeft) {
    atlasDelta = (atlasDelta != null) ? atlasDelta : 32;
    left = (EditorUi.compactUi) ? left : atlasLeft;

    menu.style.whiteSpace = 'nowrap';
    menu.style.overflow = 'hidden';
    menu.style.position = 'relative';
    menu.innerHTML = '<div class="geSprite ' + sprite + '" style="margin-left:' + left + 'px;margin-top:' + top + 'px;"></div>' +
        this.dropdownImageHtml;
    menu.style.width = (mxClient.IS_QUIRKS) ? atlasWidth + 'px' : (atlasWidth - atlasDelta) + 'px';

    if (mxClient.IS_QUIRKS) {
        menu.style.height = (EditorUi.compactUi) ? '24px' : '26px';
    }

    // Fix for item size in kennedy theme
    if (EditorUi.compactUi) {
        menu.getElementsByTagName('img')[0].style.left = '24px';
        menu.getElementsByTagName('img')[0].style.top = '5px';
        menu.style.width = (mxClient.IS_QUIRKS) ? width + 'px' : (width - 10) + 'px';
    }
};

/**
 * Sets the current font name.
 */
Toolbar.prototype.setFontName = function (value) {
    if (this.fontMenu != null) {
        this.fontMenu.innerHTML = '<div style="width:60px;overflow:hidden;display:inline-block;">' +
            mxUtils.htmlEntities(value) + '</div>' + this.dropdownImageHtml;
    }
};

/**
 * Sets the current font name.
 */
Toolbar.prototype.setFontSize = function (value) {
    if (this.sizeMenu != null) {
        this.sizeMenu.innerHTML = '<div style="width:24px;overflow:hidden;display:inline-block;">' +
            value + '</div>' + this.dropdownImageHtml;
    }
};

/**
 * Hides the current menu.
 */
Toolbar.prototype.createTextToolbar = function () {
    var graph = this.editorUi.editor.graph;

    var styleElt = this.addMenu('', mxResources.get('style'), true, 'formatBlock');
    styleElt.style.position = 'relative';
    styleElt.style.whiteSpace = 'nowrap';
    styleElt.style.overflow = 'hidden';
    styleElt.innerHTML = mxResources.get('style') + this.dropdownImageHtml;

    if (EditorUi.compactUi) {
        styleElt.style.paddingRight = '18px';
        styleElt.getElementsByTagName('img')[0].style.right = '1px';
        styleElt.getElementsByTagName('img')[0].style.top = '5px';
    }

    this.addSeparator();

    this.fontMenu = this.addMenu('', mxResources.get('fontFamily'), true, 'fontFamily');
    this.fontMenu.style.position = 'relative';
    this.fontMenu.style.whiteSpace = 'nowrap';
    this.fontMenu.style.overflow = 'hidden';
    this.fontMenu.style.width = (mxClient.IS_QUIRKS) ? '80px' : '60px';

    this.setFontName(Menus.prototype.defaultFont);

    if (EditorUi.compactUi) {
        this.fontMenu.style.paddingRight = '18px';
        this.fontMenu.getElementsByTagName('img')[0].style.right = '1px';
        this.fontMenu.getElementsByTagName('img')[0].style.top = '5px';
    }

    this.addSeparator();

    this.sizeMenu = this.addMenu(Menus.prototype.defaultFontSize, mxResources.get('fontSize'), true, 'fontSize');
    this.sizeMenu.style.position = 'relative';
    this.sizeMenu.style.whiteSpace = 'nowrap';
    this.sizeMenu.style.overflow = 'hidden';
    this.sizeMenu.style.width = (mxClient.IS_QUIRKS) ? '44px' : '24px';

    this.setFontSize(Menus.prototype.defaultFontSize);

    if (EditorUi.compactUi) {
        this.sizeMenu.style.paddingRight = '18px';
        this.sizeMenu.getElementsByTagName('img')[0].style.right = '1px';
        this.sizeMenu.getElementsByTagName('img')[0].style.top = '5px';
    }

    var elts = this.addItems(['-', 'undo', 'redo', '-', 'bold', 'italic', 'underline']);
    elts[1].setAttribute('title', mxResources.get('undo') + ' (' + this.editorUi.actions.get('undo').shortcut + ')');
    elts[2].setAttribute('title', mxResources.get('redo') + ' (' + this.editorUi.actions.get('redo').shortcut + ')');
    elts[4].setAttribute('title', mxResources.get('bold') + ' (' + this.editorUi.actions.get('bold').shortcut + ')');
    elts[5].setAttribute('title', mxResources.get('italic') + ' (' + this.editorUi.actions.get('italic').shortcut + ')');
    elts[6].setAttribute('title', mxResources.get('underline') + ' (' + this.editorUi.actions.get('underline').shortcut + ')');

    // KNOWN: Lost focus after click on submenu with text (not icon) in quirks and IE8. This is because the TD seems
    // to catch the focus on click in these browsers. NOTE: Workaround in mxPopupMenu for icon items (without text).
    var alignMenu = this.addMenuFunction('', mxResources.get('align'), false, mxUtils.bind(this, function (menu) {
        elt = menu.addItem('', null, mxUtils.bind(this, function (evt) {
            graph.cellEditor.alignText(mxConstants.ALIGN_LEFT, evt);
        }), null, 'geIcon geSprite geSprite-left');
        elt.setAttribute('title', mxResources.get('left'));

        elt = menu.addItem('', null, mxUtils.bind(this, function (evt) {
            graph.cellEditor.alignText(mxConstants.ALIGN_CENTER, evt);
        }), null, 'geIcon geSprite geSprite-center');
        elt.setAttribute('title', mxResources.get('center'));

        elt = menu.addItem('', null, mxUtils.bind(this, function (evt) {
            graph.cellEditor.alignText(mxConstants.ALIGN_RIGHT, evt);
        }), null, 'geIcon geSprite geSprite-right');
        elt.setAttribute('title', mxResources.get('right'));

        elt = menu.addItem('', null, mxUtils.bind(this, function () {
            document.execCommand('justifyfull', false, null);
        }), null, 'geIcon geSprite geSprite-justifyfull');
        elt.setAttribute('title', mxResources.get('justifyfull'));

        elt = menu.addItem('', null, mxUtils.bind(this, function () {
            document.execCommand('insertorderedlist', false, null);
        }), null, 'geIcon geSprite geSprite-orderedlist');
        elt.setAttribute('title', mxResources.get('numberedList'));

        elt = menu.addItem('', null, mxUtils.bind(this, function () {
            document.execCommand('insertunorderedlist', false, null);
        }), null, 'geIcon geSprite geSprite-unorderedlist');
        elt.setAttribute('title', mxResources.get('bulletedList'));

        elt = menu.addItem('', null, mxUtils.bind(this, function () {
            document.execCommand('outdent', false, null);
        }), null, 'geIcon geSprite geSprite-outdent');
        elt.setAttribute('title', mxResources.get('decreaseIndent'));

        elt = menu.addItem('', null, mxUtils.bind(this, function () {
            document.execCommand('indent', false, null);
        }), null, 'geIcon geSprite geSprite-indent');
        elt.setAttribute('title', mxResources.get('increaseIndent'));
    }));

    alignMenu.style.position = 'relative';
    alignMenu.style.whiteSpace = 'nowrap';
    alignMenu.style.overflow = 'hidden';
    alignMenu.innerHTML = '<div class="geSprite geSprite-left" style="margin-left:-2px;"></div>' + this.dropdownImageHtml;
    alignMenu.style.width = (mxClient.IS_QUIRKS) ? '50px' : '30px';

    if (EditorUi.compactUi) {
        alignMenu.getElementsByTagName('img')[0].style.left = '22px';
        alignMenu.getElementsByTagName('img')[0].style.top = '5px';
    }

    var formatMenu = this.addMenuFunction('', mxResources.get('format'), false, mxUtils.bind(this, function (menu) {
        elt = menu.addItem('', null, this.editorUi.actions.get('subscript').funct,
            null, 'geIcon geSprite geSprite-subscript');
        elt.setAttribute('title', mxResources.get('subscript') + ' (' + Editor.ctrlKey + '+,)');

        elt = menu.addItem('', null, this.editorUi.actions.get('superscript').funct,
            null, 'geIcon geSprite geSprite-superscript');
        elt.setAttribute('title', mxResources.get('superscript') + ' (' + Editor.ctrlKey + '+.)');

        // KNOWN: IE+FF don't return keyboard focus after color dialog (calling focus doesn't help)
        elt = menu.addItem('', null, this.editorUi.actions.get('fontColor').funct,
            null, 'geIcon geSprite geSprite-fontcolor');
        elt.setAttribute('title', mxResources.get('fontColor'));

        elt = menu.addItem('', null, this.editorUi.actions.get('backgroundColor').funct,
            null, 'geIcon geSprite geSprite-fontbackground');
        elt.setAttribute('title', mxResources.get('backgroundColor'));

        elt = menu.addItem('', null, mxUtils.bind(this, function () {
            document.execCommand('removeformat', false, null);
        }), null, 'geIcon geSprite geSprite-removeformat');
        elt.setAttribute('title', mxResources.get('removeFormat'));
    }));

    formatMenu.style.position = 'relative';
    formatMenu.style.whiteSpace = 'nowrap';
    formatMenu.style.overflow = 'hidden';
    formatMenu.innerHTML = '<div class="geSprite geSprite-dots" style="margin-left:-2px;"></div>' +
        this.dropdownImageHtml;
    formatMenu.style.width = (mxClient.IS_QUIRKS) ? '50px' : '30px';

    if (EditorUi.compactUi) {
        formatMenu.getElementsByTagName('img')[0].style.left = '22px';
        formatMenu.getElementsByTagName('img')[0].style.top = '5px';
    }

    this.addSeparator();

    this.addButton('geIcon geSprite geSprite-code', mxResources.get('html'), function () {
        graph.cellEditor.toggleViewMode();

        if (graph.cellEditor.textarea.innerHTML.length > 0 && (graph.cellEditor.textarea.innerHTML != '&nbsp;' || !graph.cellEditor.clearOnChange)) {
            window.setTimeout(function () {
                document.execCommand('selectAll', false, null);
            });
        }
    });

    this.addSeparator();

    // FIXME: Uses geButton here and geLabel in main menu
    var insertMenu = this.addMenuFunction('', mxResources.get('insert'), true, mxUtils.bind(this, function (menu) {
        menu.addItem(mxResources.get('insertLink'), null, mxUtils.bind(this, function () {
            this.editorUi.actions.get('link').funct();
        }));

        menu.addItem(mxResources.get('insertImage'), null, mxUtils.bind(this, function () {
            this.editorUi.actions.get('image').funct();
        }));

        menu.addItem(mxResources.get('insertHorizontalRule'), null, mxUtils.bind(this, function () {
            document.execCommand('inserthorizontalrule', false, null);
        }));
    }));

    insertMenu.style.whiteSpace = 'nowrap';
    insertMenu.style.overflow = 'hidden';
    insertMenu.style.position = 'relative';
    insertMenu.innerHTML = '<div class="geSprite geSprite-plus" style="margin-left:-4px;margin-top:-3px;"></div>' +
        this.dropdownImageHtml;
    insertMenu.style.width = (mxClient.IS_QUIRKS) ? '36px' : '16px';

    // Fix for item size in kennedy theme
    if (EditorUi.compactUi) {
        insertMenu.getElementsByTagName('img')[0].style.left = '24px';
        insertMenu.getElementsByTagName('img')[0].style.top = '5px';
        insertMenu.style.width = (mxClient.IS_QUIRKS) ? '50px' : '30px';
    }

    this.addSeparator();

    // KNOWN: All table stuff does not work with undo/redo
    // KNOWN: Lost focus after click on submenu with text (not icon) in quirks and IE8. This is because the TD seems
    // to catch the focus on click in these browsers. NOTE: Workaround in mxPopupMenu for icon items (without text).
    var elt = this.addMenuFunction('geIcon geSprite geSprite-table', mxResources.get('table'), false, mxUtils.bind(this, function (menu) {
        var elt = graph.getSelectedElement();
        var cell = graph.getParentByNames(elt, ['TD', 'TH'], graph.cellEditor.text2);
        var row = graph.getParentByName(elt, 'TR', graph.cellEditor.text2);

        if (row == null) {
            this.editorUi.menus.addInsertTableItem(menu);
        } else {
            var table = graph.getParentByName(row, 'TABLE', graph.cellEditor.text2);

            elt = menu.addItem('', null, mxUtils.bind(this, function () {
                try {
                    graph.selectNode(graph.insertColumn(table, (cell != null) ? cell.cellIndex : 0));
                } catch (e) {
                    this.editorUi.handleError(e);
                }
            }), null, 'geIcon geSprite geSprite-insertcolumnbefore');
            elt.setAttribute('title', mxResources.get('insertColumnBefore'));

            elt = menu.addItem('', null, mxUtils.bind(this, function () {
                try {
                    graph.selectNode(graph.insertColumn(table, (cell != null) ? cell.cellIndex + 1 : -1));
                } catch (e) {
                    this.editorUi.handleError(e);
                }
            }), null, 'geIcon geSprite geSprite-insertcolumnafter');
            elt.setAttribute('title', mxResources.get('insertColumnAfter'));

            elt = menu.addItem('Delete column', null, mxUtils.bind(this, function () {
                if (cell != null) {
                    try {
                        graph.deleteColumn(table, cell.cellIndex);
                    } catch (e) {
                        this.editorUi.handleError(e);
                    }
                }
            }), null, 'geIcon geSprite geSprite-deletecolumn');
            elt.setAttribute('title', mxResources.get('deleteColumn'));

            elt = menu.addItem('', null, mxUtils.bind(this, function () {
                try {
                    graph.selectNode(graph.insertRow(table, row.sectionRowIndex));
                } catch (e) {
                    this.editorUi.handleError(e);
                }
            }), null, 'geIcon geSprite geSprite-insertrowbefore');
            elt.setAttribute('title', mxResources.get('insertRowBefore'));

            elt = menu.addItem('', null, mxUtils.bind(this, function () {
                try {
                    graph.selectNode(graph.insertRow(table, row.sectionRowIndex + 1));
                } catch (e) {
                    this.editorUi.handleError(e);
                }
            }), null, 'geIcon geSprite geSprite-insertrowafter');
            elt.setAttribute('title', mxResources.get('insertRowAfter'));

            elt = menu.addItem('', null, mxUtils.bind(this, function () {
                try {
                    graph.deleteRow(table, row.sectionRowIndex);
                } catch (e) {
                    this.editorUi.handleError(e);
                }
            }), null, 'geIcon geSprite geSprite-deleterow');
            elt.setAttribute('title', mxResources.get('deleteRow'));

            elt = menu.addItem('', null, mxUtils.bind(this, function () {
                // Converts rgb(r,g,b) values
                var color = table.style.borderColor.replace(
                    /\brgb\s*\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\)/g,
                    function ($0, $1, $2, $3) {
                        return "#" + ("0" + Number($1).toString(16)).substr(-2) + ("0" + Number($2).toString(16)).substr(-2) + ("0" + Number($3).toString(16)).substr(-2);
                    });
                this.editorUi.pickColor(color, function (newColor) {
                    if (newColor == null || newColor == mxConstants.NONE) {
                        table.removeAttribute('border');
                        table.style.border = '';
                        table.style.borderCollapse = '';
                    } else {
                        table.setAttribute('border', '1');
                        table.style.border = '1px solid ' + newColor;
                        table.style.borderCollapse = 'collapse';
                    }
                });
            }), null, 'geIcon geSprite geSprite-strokecolor');
            elt.setAttribute('title', mxResources.get('borderColor'));

            elt = menu.addItem('', null, mxUtils.bind(this, function () {
                // Converts rgb(r,g,b) values
                var color = table.style.backgroundColor.replace(
                    /\brgb\s*\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\)/g,
                    function ($0, $1, $2, $3) {
                        return "#" + ("0" + Number($1).toString(16)).substr(-2) + ("0" + Number($2).toString(16)).substr(-2) + ("0" + Number($3).toString(16)).substr(-2);
                    });
                this.editorUi.pickColor(color, function (newColor) {
                    if (newColor == null || newColor == mxConstants.NONE) {
                        table.style.backgroundColor = '';
                    } else {
                        table.style.backgroundColor = newColor;
                    }
                });
            }), null, 'geIcon geSprite geSprite-fillcolor');
            elt.setAttribute('title', mxResources.get('backgroundColor'));

            elt = menu.addItem('', null, mxUtils.bind(this, function () {
                var value = table.getAttribute('cellPadding') || 0;

                var dlg = new FilenameDialog(this.editorUi, value, mxResources.get('apply'), mxUtils.bind(this, function (newValue) {
                    if (newValue != null && newValue.length > 0) {
                        table.setAttribute('cellPadding', newValue);
                    } else {
                        table.removeAttribute('cellPadding');
                    }
                }), mxResources.get('spacing'));
                this.editorUi.showDialog(dlg.container, 300, 80, true, true);
                dlg.init();
            }), null, 'geIcon geSprite geSprite-fit');
            elt.setAttribute('title', mxResources.get('spacing'));

            elt = menu.addItem('', null, mxUtils.bind(this, function () {
                table.setAttribute('align', 'left');
            }), null, 'geIcon geSprite geSprite-left');
            elt.setAttribute('title', mxResources.get('left'));

            elt = menu.addItem('', null, mxUtils.bind(this, function () {
                table.setAttribute('align', 'center');
            }), null, 'geIcon geSprite geSprite-center');
            elt.setAttribute('title', mxResources.get('center'));

            elt = menu.addItem('', null, mxUtils.bind(this, function () {
                table.setAttribute('align', 'right');
            }), null, 'geIcon geSprite geSprite-right');
            elt.setAttribute('title', mxResources.get('right'));
        }
    }));

    elt.style.position = 'relative';
    elt.style.whiteSpace = 'nowrap';
    elt.style.overflow = 'hidden';
    elt.innerHTML = '<div class="geSprite geSprite-table" style="margin-left:-2px;"></div>' + this.dropdownImageHtml;
    elt.style.width = (mxClient.IS_QUIRKS) ? '50px' : '30px';

    // Fix for item size in kennedy theme
    if (EditorUi.compactUi) {
        elt.getElementsByTagName('img')[0].style.left = '22px';
        elt.getElementsByTagName('img')[0].style.top = '5px';
    }
};

/**
 * Hides the current menu.
 */
Toolbar.prototype.hideMenu = function () {
    this.editorUi.hideCurrentMenu();
};

/**
 * Adds a label to the toolbar.
 */
Toolbar.prototype.addMenu = function (label, tooltip, showLabels, name, c, showAll, ignoreState) {
    var menu = this.editorUi.menus.get(name);
    var elt = this.addMenuFunction(label, tooltip, showLabels, function () {
        menu.funct.apply(menu, arguments);
    }, c, showAll);

    if (!ignoreState) {
        menu.addListener('stateChanged', function () {
            elt.setEnabled(menu.enabled);
        });
    }

    return elt;
};

/**
 * Adds a label to the toolbar.
 */
Toolbar.prototype.addMenuFunction = function (label, tooltip, showLabels, funct, c, showAll) {
    return this.addMenuFunctionInContainer((c != null) ? c : this.container, label, tooltip, showLabels, funct, showAll);
};

/**
 * Adds a label to the toolbar.
 */
Toolbar.prototype.addMenuFunctionInContainer = function (container, label, tooltip, showLabels, funct, showAll) {
    var elt = (showLabels) ? this.createLabel(label) : this.createButton(label);
    this.initElement(elt, tooltip);
    this.addMenuHandler(elt, showLabels, funct, showAll);
    container.appendChild(elt);

    return elt;
};

/**
 * Adds a separator to the separator.
 */
Toolbar.prototype.addSeparator = function (c) {
    c = (c != null) ? c : this.container;
    var elt = document.createElement('div');
    elt.className = 'geSeparator';
    c.appendChild(elt);

    return elt;
};

/**
 * Adds given action item
 */
Toolbar.prototype.addItems = function (keys, c, ignoreDisabled) {
    var items = [];

    for (var i = 0; i < keys.length; i++) {
        var key = keys[i];

        if (key == '-') {
            items.push(this.addSeparator(c));
        } else {
            items.push(this.addItem('geSprite-' + key.toLowerCase(), key, c, ignoreDisabled));
        }
    }

    return items;
};

/**
 * Adds given action item
 */
Toolbar.prototype.addItem = function (sprite, key, c, ignoreDisabled) {
    var action = this.editorUi.actions.get(key);
    var elt = null;

    if (action != null) {
        var tooltip = action.label;

        if (action.shortcut != null) {
            tooltip += ' (' + action.shortcut + ')';
        }

        elt = this.addButton(sprite, tooltip, action.funct, c);

        if (!ignoreDisabled) {
            elt.setEnabled(action.enabled);

            action.addListener('stateChanged', function () {
                elt.setEnabled(action.enabled);
            });
        }
    }

    return elt;
};

/**
 * Adds a button to the toolbar.
 */
Toolbar.prototype.addButton = function (classname, tooltip, funct, c) {
    var elt = this.createButton(classname);
    c = (c != null) ? c : this.container;

    this.initElement(elt, tooltip);
    this.addClickHandler(elt, funct);
    c.appendChild(elt);

    return elt;
};

/**
 * Initializes the given toolbar element.
 */
Toolbar.prototype.initElement = function (elt, tooltip) {
    // Adds tooltip
    if (tooltip != null) {
        elt.setAttribute('title', tooltip);
    }

    this.addEnabledState(elt);
};

/**
 * Adds enabled state with setter to DOM node (avoids JS wrapper).
 */
Toolbar.prototype.addEnabledState = function (elt) {
    var classname = elt.className;

    elt.setEnabled = function (value) {
        elt.enabled = value;

        if (value) {
            elt.className = classname;
        } else {
            elt.className = classname + ' mxDisabled';
        }
    };

    elt.setEnabled(true);
};

/**
 * Adds enabled state with setter to DOM node (avoids JS wrapper).
 */
Toolbar.prototype.addClickHandler = function (elt, funct) {
    if (funct != null) {
        mxEvent.addListener(elt, 'click', function (evt) {
            if (elt.enabled) {
                funct(evt);
            }

            mxEvent.consume(evt);
        });

        // Prevents focus
        mxEvent.addListener(elt, (mxClient.IS_POINTER) ? 'pointerdown' : 'mousedown',
            mxUtils.bind(this, function (evt) {
                evt.preventDefault();
            }));
    }
};

/**
 * Creates and returns a new button.
 */
Toolbar.prototype.createButton = function (classname) {
    var elt = document.createElement('a');
    elt.className = 'geButton';

    var inner = document.createElement('div');

    if (classname != null) {
        inner.className = 'geSprite ' + classname;
    }

    elt.appendChild(inner);

    return elt;
};

/**
 * Creates and returns a new button.
 */
Toolbar.prototype.createLabel = function (label, tooltip) {
    var elt = document.createElement('a');
    elt.className = 'geLabel';
    mxUtils.write(elt, label);

    return elt;
};

/**
 * Adds a handler for showing a menu in the given element.
 */
Toolbar.prototype.addMenuHandler = function (elt, showLabels, funct, showAll) {
    if (funct != null) {
        var graph = this.editorUi.editor.graph;
        var menu = null;
        var show = true;

        mxEvent.addListener(elt, 'click', mxUtils.bind(this, function (evt) {
            if (show && (elt.enabled == null || elt.enabled)) {
                graph.popupMenuHandler.hideMenu();
                menu = new mxPopupMenu(funct);
                menu.div.className += ' geToolbarMenu';
                menu.showDisabled = showAll;
                menu.labels = showLabels;
                menu.autoExpand = true;

                var offset = mxUtils.getOffset(elt);
                menu.popup(offset.x, offset.y + elt.offsetHeight, null, evt);
                this.editorUi.setCurrentMenu(menu, elt);

                // Workaround for scrollbar hiding menu items
                if (!showLabels && menu.div.scrollHeight > menu.div.clientHeight) {
                    menu.div.style.width = '40px';
                }

                menu.hideMenu = mxUtils.bind(this, function () {
                    mxPopupMenu.prototype.hideMenu.apply(menu, arguments);
                    this.editorUi.resetCurrentMenu();
                    menu.destroy();
                });

                // Extends destroy to reset global state
                menu.addListener(mxEvent.EVENT_HIDE, mxUtils.bind(this, function () {
                    this.currentElt = null;
                }));
            }

            show = true;
            mxEvent.consume(evt);
        }));

        // Hides menu if already showing and prevents focus
        mxEvent.addListener(elt, (mxClient.IS_POINTER) ? 'pointerdown' : 'mousedown',
            mxUtils.bind(this, function (evt) {
                show = this.currentElt != elt;
                evt.preventDefault();
            }));
    }
};

/**
 * Adds a handler for showing a menu in the given element.
 */
Toolbar.prototype.destroy = function () {
    if (this.gestureHandler != null) {
        mxEvent.removeGestureListeners(document, this.gestureHandler);
        this.gestureHandler = null;
    }
};

/**
 * Copyright (c) 2006-2012, JGraph Ltd
 */
/**
 * Constructs a new open dialog.
 */
var OpenDialog = function () {
    var iframe = document.createElement('iframe');
    iframe.style.backgroundColor = 'transparent';
    iframe.allowTransparency = 'true';
    iframe.style.borderStyle = 'none';
    iframe.style.borderWidth = '0px';
    iframe.style.overflow = 'hidden';
    iframe.frameBorder = '0';

    // Adds padding as a workaround for box model in older IE versions
    var dx = (mxClient.IS_VML && (document.documentMode == null || document.documentMode < 8)) ? 20 : 0;

    iframe.setAttribute('width', (((Editor.useLocalStorage) ? 640 : 320) + dx) + 'px');
    iframe.setAttribute('height', (((Editor.useLocalStorage) ? 480 : 220) + dx) + 'px');
    iframe.setAttribute('src', OPEN_FORM);

    this.container = iframe;
};

/**
 * Constructs a new color dialog.
 */
var ColorDialog = function (editorUi, color, apply, cancelFn) {
    this.editorUi = editorUi;

    var input = document.createElement('input');
    input.style.marginBottom = '10px';
    input.style.width = '216px';

    // Required for picker to render in IE
    if (mxClient.IS_IE) {
        input.style.marginTop = '10px';
        document.body.appendChild(input);
    }

    this.init = function () {
        if (!mxClient.IS_TOUCH) {
            input.focus();
        }
    };

    var picker = new jscolor.color(input);
    picker.pickerOnfocus = false;
    picker.showPicker();

    var div = document.createElement('div');
    jscolor.picker.box.style.position = 'relative';
    jscolor.picker.box.style.width = '230px';
    jscolor.picker.box.style.height = '100px';
    jscolor.picker.box.style.paddingBottom = '10px';
    div.appendChild(jscolor.picker.box);

    var center = document.createElement('center');

    function createRecentColorTable() {
        var table = addPresets((ColorDialog.recentColors.length == 0) ? ['FFFFFF'] :
            ColorDialog.recentColors, 11, 'FFFFFF', true);
        table.style.marginBottom = '8px';

        return table;
    };

    function addPresets(presets, rowLength, defaultColor, addResetOption) {
        rowLength = (rowLength != null) ? rowLength : 12;
        var table = document.createElement('table');
        table.style.borderCollapse = 'collapse';
        table.setAttribute('cellspacing', '0');
        table.style.marginBottom = '20px';
        table.style.cellSpacing = '0px';
        var tbody = document.createElement('tbody');
        table.appendChild(tbody);

        var rows = presets.length / rowLength;

        for (var row = 0; row < rows; row++) {
            var tr = document.createElement('tr');

            for (var i = 0; i < rowLength; i++) {
                (function (clr) {
                    var td = document.createElement('td');
                    td.style.border = '1px solid black';
                    td.style.padding = '0px';
                    td.style.width = '16px';
                    td.style.height = '16px';

                    if (clr == null) {
                        clr = defaultColor;
                    }

                    if (clr == 'none') {
                        td.style.background = 'url(\'' + Dialog.prototype.noColorImage + '\')';
                    } else {
                        td.style.backgroundColor = '#' + clr;
                    }

                    tr.appendChild(td);

                    if (clr != null) {
                        td.style.cursor = 'pointer';

                        mxEvent.addListener(td, 'click', function () {
                            if (clr == 'none') {
                                picker.fromString('ffffff');
                                input.value = 'none';
                            } else {
                                picker.fromString(clr);
                            }
                        });
                    }
                })(presets[row * rowLength + i]);
            }

            tbody.appendChild(tr);
        }

        if (addResetOption) {
            var td = document.createElement('td');
            td.setAttribute('title', mxResources.get('reset'));
            td.style.border = '1px solid black';
            td.style.padding = '0px';
            td.style.width = '16px';
            td.style.height = '16px';
            td.style.backgroundImage = 'url(\'' + Dialog.prototype.closeImage + '\')';
            td.style.backgroundPosition = 'center center';
            td.style.backgroundRepeat = 'no-repeat';
            td.style.cursor = 'pointer';

            tr.appendChild(td);

            mxEvent.addListener(td, 'click', function () {
                ColorDialog.resetRecentColors();
                table.parentNode.replaceChild(createRecentColorTable(), table);
            });
        }

        center.appendChild(table);

        return table;
    };

    div.appendChild(input);
    mxUtils.br(div);

    // Adds recent colors
    createRecentColorTable();

    // Adds presets
    var table = addPresets(this.presetColors);
    table.style.marginBottom = '8px';
    table = addPresets(this.defaultColors);
    table.style.marginBottom = '16px';

    div.appendChild(center);

    var buttons = document.createElement('div');
    buttons.style.textAlign = 'right';
    buttons.style.whiteSpace = 'nowrap';

    var cancelBtn = mxUtils.button(mxResources.get('cancel'), function () {
        editorUi.hideDialog();

        if (cancelFn != null) {
            cancelFn();
        }
    });
    cancelBtn.className = 'geBtn';

    if (editorUi.editor.cancelFirst) {
        buttons.appendChild(cancelBtn);
    }

    var applyFunction = (apply != null) ? apply : this.createApplyFunction();

    var applyBtn = mxUtils.button(mxResources.get('apply'), function () {
        var color = input.value;

        // Blocks any non-alphabetic chars in colors
        if (/(^#?[a-zA-Z0-9]*$)/.test(color)) {
            ColorDialog.addRecentColor(color, 12);

            if (color != 'none' && color.charAt(0) != '#') {
                color = '#' + color;
            }

            applyFunction(color);
            editorUi.hideDialog();
        } else {
            editorUi.handleError({message: mxResources.get('invalidInput')});
        }
    });
    applyBtn.className = 'geBtn gePrimaryBtn';
    buttons.appendChild(applyBtn);

    if (!editorUi.editor.cancelFirst) {
        buttons.appendChild(cancelBtn);
    }

    if (color != null) {
        if (color == 'none') {
            picker.fromString('ffffff');
            input.value = 'none';
        } else {
            picker.fromString(color);
        }
    }

    div.appendChild(buttons);
    this.picker = picker;
    this.colorInput = input;

    // LATER: Only fires if input if focused, should always
    // fire if this dialog is showing.
    mxEvent.addListener(div, 'keydown', function (e) {
        if (e.keyCode == 27) {
            editorUi.hideDialog();

            if (cancelFn != null) {
                cancelFn();
            }

            mxEvent.consume(e);
        }
    });

    this.container = div;
};

/**
 * Creates function to apply value
 */
ColorDialog.prototype.presetColors = ['E6D0DE', 'CDA2BE', 'B5739D', 'E1D5E7', 'C3ABD0', 'A680B8', 'D4E1F5', 'A9C4EB', '7EA6E0', 'D5E8D4', '9AC7BF', '67AB9F', 'D5E8D4', 'B9E0A5', '97D077', 'FFF2CC', 'FFE599', 'FFD966', 'FFF4C3', 'FFCE9F', 'FFB570', 'F8CECC', 'F19C99', 'EA6B66'];

/**
 * Creates function to apply value
 */
ColorDialog.prototype.defaultColors = ['none', 'FFFFFF', 'E6E6E6', 'CCCCCC', 'B3B3B3', '999999', '808080', '666666', '4D4D4D', '333333', '1A1A1A', '000000', 'FFCCCC', 'FFE6CC', 'FFFFCC', 'E6FFCC', 'CCFFCC', 'CCFFE6', 'CCFFFF', 'CCE5FF', 'CCCCFF', 'E5CCFF', 'FFCCFF', 'FFCCE6',
    'FF9999', 'FFCC99', 'FFFF99', 'CCFF99', '99FF99', '99FFCC', '99FFFF', '99CCFF', '9999FF', 'CC99FF', 'FF99FF', 'FF99CC', 'FF6666', 'FFB366', 'FFFF66', 'B3FF66', '66FF66', '66FFB3', '66FFFF', '66B2FF', '6666FF', 'B266FF', 'FF66FF', 'FF66B3', 'FF3333', 'FF9933', 'FFFF33',
    '99FF33', '33FF33', '33FF99', '33FFFF', '3399FF', '3333FF', '9933FF', 'FF33FF', 'FF3399', 'FF0000', 'FF8000', 'FFFF00', '80FF00', '00FF00', '00FF80', '00FFFF', '007FFF', '0000FF', '7F00FF', 'FF00FF', 'FF0080', 'CC0000', 'CC6600', 'CCCC00', '66CC00', '00CC00', '00CC66',
    '00CCCC', '0066CC', '0000CC', '6600CC', 'CC00CC', 'CC0066', '990000', '994C00', '999900', '4D9900', '009900', '00994D', '009999', '004C99', '000099', '4C0099', '990099', '99004D', '660000', '663300', '666600', '336600', '006600', '006633', '006666', '003366', '000066',
    '330066', '660066', '660033', '330000', '331A00', '333300', '1A3300', '003300', '00331A', '003333', '001933', '000033', '190033', '330033', '33001A'];

/**
 * Creates function to apply value
 */
ColorDialog.prototype.createApplyFunction = function () {
    return mxUtils.bind(this, function (color) {
        var graph = this.editorUi.editor.graph;

        graph.getModel().beginUpdate();
        try {
            graph.setCellStyles(this.currentColorKey, color);
            this.editorUi.fireEvent(new mxEventObject('styleChanged', 'keys', [this.currentColorKey],
                'values', [color], 'cells', graph.getSelectionCells()));
        } finally {
            graph.getModel().endUpdate();
        }
    });
};

/**
 *
 */
ColorDialog.recentColors = [];

/**
 * Adds recent color for later use.
 */
ColorDialog.addRecentColor = function (color, max) {
    if (color != null) {
        mxUtils.remove(color, ColorDialog.recentColors);
        ColorDialog.recentColors.splice(0, 0, color);

        if (ColorDialog.recentColors.length >= max) {
            ColorDialog.recentColors.pop();
        }
    }
};

/**
 * Adds recent color for later use.
 */
ColorDialog.resetRecentColors = function () {
    ColorDialog.recentColors = [];
};

/**
 * Constructs a new filename dialog.
 */
var FilenameDialog = function (editorUi, filename, buttonText, fn, label, validateFn, content, helpLink, closeOnBtn, cancelFn, hints, w) {
    closeOnBtn = (closeOnBtn != null) ? closeOnBtn : true;
    var row, td;

    var table = document.createElement('table');
    var tbody = document.createElement('tbody');
    table.style.marginTop = '8px';

    row = document.createElement('tr');

    td = document.createElement('td');
    td.style.whiteSpace = 'nowrap';
    td.style.fontSize = '10pt';
    td.style.width = '120px';
    mxUtils.write(td, (label || mxResources.get('filename')) + ':');

    row.appendChild(td);

    var nameInput = document.createElement('input');
    nameInput.setAttribute('value', filename || '');
    nameInput.style.marginLeft = '4px';
    nameInput.style.width = (w != null) ? w + 'px' : '180px';

    var genericBtn = mxUtils.button(buttonText, function () {
        if (validateFn == null || validateFn(nameInput.value)) {
            if (closeOnBtn) {
                editorUi.hideDialog();
            }

            fn(nameInput.value);
        }
    });
    genericBtn.className = 'geBtn gePrimaryBtn';

    this.init = function () {
        if (label == null && content != null) {
            return;
        }

        nameInput.focus();

        if (mxClient.IS_GC || mxClient.IS_FF || document.documentMode >= 5 || mxClient.IS_QUIRKS) {
            nameInput.select();
        } else {
            document.execCommand('selectAll', false, null);
        }

        // Installs drag and drop handler for links
        if (Graph.fileSupport) {
            // Setup the dnd listeners
            var dlg = table.parentNode;

            if (dlg != null) {
                var graph = editorUi.editor.graph;
                var dropElt = null;

                mxEvent.addListener(dlg, 'dragleave', function (evt) {
                    if (dropElt != null) {
                        dropElt.style.backgroundColor = '';
                        dropElt = null;
                    }

                    evt.stopPropagation();
                    evt.preventDefault();
                });

                mxEvent.addListener(dlg, 'dragover', mxUtils.bind(this, function (evt) {
                    // IE 10 does not implement pointer-events so it can't have a drop highlight
                    if (dropElt == null && (!mxClient.IS_IE || document.documentMode > 10)) {
                        dropElt = nameInput;
                        dropElt.style.backgroundColor = '#ebf2f9';
                    }

                    evt.stopPropagation();
                    evt.preventDefault();
                }));

                mxEvent.addListener(dlg, 'drop', mxUtils.bind(this, function (evt) {
                    if (dropElt != null) {
                        dropElt.style.backgroundColor = '';
                        dropElt = null;
                    }

                    if (mxUtils.indexOf(evt.dataTransfer.types, 'text/uri-list') >= 0) {
                        nameInput.value = decodeURIComponent(evt.dataTransfer.getData('text/uri-list'));
                        genericBtn.click();
                    }

                    evt.stopPropagation();
                    evt.preventDefault();
                }));
            }
        }
    };

    td = document.createElement('td');
    td.style.whiteSpace = 'nowrap';
    td.appendChild(nameInput);
    row.appendChild(td);

    if (label != null || content == null) {
        tbody.appendChild(row);

        if (hints != null) {
            td.appendChild(FilenameDialog.createTypeHint(editorUi, nameInput, hints));
        }
    }

    if (content != null) {
        row = document.createElement('tr');
        td = document.createElement('td');
        td.colSpan = 2;
        td.appendChild(content);
        row.appendChild(td);
        tbody.appendChild(row);
    }

    row = document.createElement('tr');
    td = document.createElement('td');
    td.colSpan = 2;
    td.style.paddingTop = '20px';
    td.style.whiteSpace = 'nowrap';
    td.setAttribute('align', 'right');

    var cancelBtn = mxUtils.button(mxResources.get('cancel'), function () {
        editorUi.hideDialog();

        if (cancelFn != null) {
            cancelFn();
        }
    });
    cancelBtn.className = 'geBtn';

    if (editorUi.editor.cancelFirst) {
        td.appendChild(cancelBtn);
    }

    if (helpLink != null) {
        var helpBtn = mxUtils.button(mxResources.get('help'), function () {
            editorUi.editor.graph.openLink(helpLink);
        });

        helpBtn.className = 'geBtn';
        td.appendChild(helpBtn);
    }

    mxEvent.addListener(nameInput, 'keypress', function (e) {
        if (e.keyCode == 13) {
            genericBtn.click();
        }
    });

    td.appendChild(genericBtn);

    if (!editorUi.editor.cancelFirst) {
        td.appendChild(cancelBtn);
    }

    row.appendChild(td);
    tbody.appendChild(row);
    table.appendChild(tbody);

    this.container = table;
};

/**
 *
 */
FilenameDialog.filenameHelpLink = null;

/**
 *
 */
FilenameDialog.createTypeHint = function (ui, nameInput, hints) {
    var hint = document.createElement('img');
    hint.style.cssText = 'vertical-align:top;height:16px;width:16px;margin-left:4px;background-repeat:no-repeat;background-position:center bottom;cursor:pointer;';
    mxUtils.setOpacity(hint, 70);

    var nameChanged = function () {
        hint.setAttribute('src', Editor.helpImage);
        hint.setAttribute('title', mxResources.get('help'));

        for (var i = 0; i < hints.length; i++) {
            if (hints[i].ext.length > 0 &&
                nameInput.value.substring(nameInput.value.length -
                    hints[i].ext.length - 1) == '.' + hints[i].ext) {
                hint.setAttribute('src', mxClient.imageBasePath + '/warning.png');
                hint.setAttribute('title', mxResources.get(hints[i].title));
                break;
            }
        }
    };

    mxEvent.addListener(nameInput, 'keyup', nameChanged);
    mxEvent.addListener(nameInput, 'change', nameChanged);
    mxEvent.addListener(hint, 'click', function (evt) {
        var title = hint.getAttribute('title');

        if (hint.getAttribute('src') == Editor.helpImage) {
            ui.editor.graph.openLink(FilenameDialog.filenameHelpLink);
        } else if (title != '') {
            ui.showError(null, title, mxResources.get('help'), function () {
                ui.editor.graph.openLink(FilenameDialog.filenameHelpLink);
            }, null, mxResources.get('ok'), null, null, null, 340, 90);
        }

        mxEvent.consume(evt);
    });

    nameChanged();

    return hint;
};

/**
 * Constructs a new textarea dialog.
 */
var TextareaDialog = function (editorUi, title, url, fn, cancelFn, cancelTitle, w, h,
                               addButtons, noHide, noWrap, applyTitle, helpLink) {
    w = (w != null) ? w : 300;
    h = (h != null) ? h : 120;
    noHide = (noHide != null) ? noHide : false;
    var row, td;

    var table = document.createElement('table');
    var tbody = document.createElement('tbody');

    row = document.createElement('tr');

    td = document.createElement('td');
    td.style.fontSize = '10pt';
    td.style.width = '100px';
    mxUtils.write(td, title);

    row.appendChild(td);
    tbody.appendChild(row);

    row = document.createElement('tr');
    td = document.createElement('td');

    var nameInput = document.createElement('textarea');

    if (noWrap) {
        nameInput.setAttribute('wrap', 'off');
    }

    nameInput.setAttribute('spellcheck', 'false');
    nameInput.setAttribute('autocorrect', 'off');
    nameInput.setAttribute('autocomplete', 'off');
    nameInput.setAttribute('autocapitalize', 'off');

    mxUtils.write(nameInput, url || '');
    nameInput.style.resize = 'none';
    nameInput.style.width = w + 'px';
    nameInput.style.height = h + 'px';

    this.textarea = nameInput;

    this.init = function () {
        nameInput.focus();
        nameInput.scrollTop = 0;
    };

    td.appendChild(nameInput);
    row.appendChild(td);

    tbody.appendChild(row);

    row = document.createElement('tr');
    td = document.createElement('td');
    td.style.paddingTop = '14px';
    td.style.whiteSpace = 'nowrap';
    td.setAttribute('align', 'right');

    if (helpLink != null) {
        var helpBtn = mxUtils.button(mxResources.get('help'), function () {
            editorUi.editor.graph.openLink(helpLink);
        });
        helpBtn.className = 'geBtn';

        td.appendChild(helpBtn);
    }

    var cancelBtn = mxUtils.button(cancelTitle || mxResources.get('cancel'), function () {
        editorUi.hideDialog();

        if (cancelFn != null) {
            cancelFn();
        }
    });
    cancelBtn.className = 'geBtn';

    if (editorUi.editor.cancelFirst) {
        td.appendChild(cancelBtn);
    }

    if (addButtons != null) {
        addButtons(td, nameInput);
    }

    if (fn != null) {
        var genericBtn = mxUtils.button(applyTitle || mxResources.get('apply'), function () {
            if (!noHide) {
                editorUi.hideDialog();
            }

            fn(nameInput.value);
        });

        genericBtn.className = 'geBtn gePrimaryBtn';
        td.appendChild(genericBtn);
    }

    if (!editorUi.editor.cancelFirst) {
        td.appendChild(cancelBtn);
    }

    row.appendChild(td);
    tbody.appendChild(row);
    table.appendChild(tbody);
    this.container = table;
};

/**
 * Constructs a new edit file dialog.
 */
var EditDiagramDialog = function (editorUi) {
    var div = document.createElement('div');
    div.style.textAlign = 'right';
    var textarea = document.createElement('textarea');
    textarea.setAttribute('wrap', 'off');
    textarea.setAttribute('spellcheck', 'false');
    textarea.setAttribute('autocorrect', 'off');
    textarea.setAttribute('autocomplete', 'off');
    textarea.setAttribute('autocapitalize', 'off');
    textarea.style.overflow = 'auto';
    textarea.style.resize = 'none';
    textarea.style.width = '600px';
    textarea.style.height = '360px';
    textarea.style.marginBottom = '16px';

    textarea.value = mxUtils.getPrettyXml(editorUi.editor.getGraphXml());
    div.appendChild(textarea);

    this.init = function () {
        textarea.focus();
    };

    // Enables dropping files
    if (Graph.fileSupport) {
        function handleDrop(evt) {
            evt.stopPropagation();
            evt.preventDefault();

            if (evt.dataTransfer.files.length > 0) {
                var file = evt.dataTransfer.files[0];
                var reader = new FileReader();

                reader.onload = function (e) {
                    textarea.value = e.target.result;
                };

                reader.readAsText(file);
            } else {
                textarea.value = editorUi.extractGraphModelFromEvent(evt);
            }
        };

        function handleDragOver(evt) {
            evt.stopPropagation();
            evt.preventDefault();
        };

        // Setup the dnd listeners.
        textarea.addEventListener('dragover', handleDragOver, false);
        textarea.addEventListener('drop', handleDrop, false);
    }

    var cancelBtn = mxUtils.button(mxResources.get('cancel'), function () {
        editorUi.hideDialog();
    });
    cancelBtn.className = 'geBtn';

    if (editorUi.editor.cancelFirst) {
        div.appendChild(cancelBtn);
    }

    var select = document.createElement('select');
    select.style.width = '180px';
    select.className = 'geBtn';

    if (editorUi.editor.graph.isEnabled()) {
        var replaceOption = document.createElement('option');
        replaceOption.setAttribute('value', 'replace');
        mxUtils.write(replaceOption, mxResources.get('replaceExistingDrawing'));
        select.appendChild(replaceOption);
    }

    var newOption = document.createElement('option');
    newOption.setAttribute('value', 'new');
    mxUtils.write(newOption, mxResources.get('openInNewWindow'));

    if (EditDiagramDialog.showNewWindowOption) {
        select.appendChild(newOption);
    }

    if (editorUi.editor.graph.isEnabled()) {
        var importOption = document.createElement('option');
        importOption.setAttribute('value', 'import');
        mxUtils.write(importOption, mxResources.get('addToExistingDrawing'));
        select.appendChild(importOption);
    }

    div.appendChild(select);

    var okBtn = mxUtils.button(mxResources.get('ok'), function () {
        // Removes all illegal control characters before parsing
        var data = Graph.zapGremlins(mxUtils.trim(textarea.value));
        var error = null;

        if (select.value == 'new') {
            editorUi.hideDialog();
            editorUi.editor.editAsNew(data);
        } else if (select.value == 'replace') {
            editorUi.editor.graph.model.beginUpdate();
            try {
                editorUi.editor.setGraphXml(mxUtils.parseXml(data).documentElement);
                // LATER: Why is hideDialog between begin-/endUpdate faster?
                editorUi.hideDialog();
            } catch (e) {
                error = e;
            } finally {
                editorUi.editor.graph.model.endUpdate();
            }
        } else if (select.value == 'import') {
            editorUi.editor.graph.model.beginUpdate();
            try {
                var doc = mxUtils.parseXml(data);
                var model = new mxGraphModel();
                var codec = new mxCodec(doc);
                codec.decode(doc.documentElement, model);

                var children = model.getChildren(model.getChildAt(model.getRoot(), 0));
                editorUi.editor.graph.setSelectionCells(editorUi.editor.graph.importCells(children));

                // LATER: Why is hideDialog between begin-/endUpdate faster?
                editorUi.hideDialog();
            } catch (e) {
                error = e;
            } finally {
                editorUi.editor.graph.model.endUpdate();
            }
        }

        if (error != null) {
            mxUtils.alert(error.message);
        }
    });
    okBtn.className = 'geBtn gePrimaryBtn';
    div.appendChild(okBtn);

    if (!editorUi.editor.cancelFirst) {
        div.appendChild(cancelBtn);
    }

    this.container = div;
};

/**
 *
 */
EditDiagramDialog.showNewWindowOption = true;

/**
 * Constructs a new export dialog.
 */
var ExportDialog = function (editorUi) {
    var graph = editorUi.editor.graph;
    var bounds = graph.getGraphBounds();
    var scale = graph.view.scale;

    var width = Math.ceil(bounds.width / scale);
    var height = Math.ceil(bounds.height / scale);

    var row, td;

    var table = document.createElement('table');
    var tbody = document.createElement('tbody');
    table.setAttribute('cellpadding', (mxClient.IS_SF) ? '0' : '2');

    row = document.createElement('tr');

    td = document.createElement('td');
    td.style.fontSize = '10pt';
    td.style.width = '100px';
    mxUtils.write(td, mxResources.get('filename') + ':');

    row.appendChild(td);

    var nameInput = document.createElement('input');
    nameInput.setAttribute('value', editorUi.editor.getOrCreateFilename());
    nameInput.style.width = '180px';

    td = document.createElement('td');
    td.appendChild(nameInput);
    row.appendChild(td);

    tbody.appendChild(row);

    row = document.createElement('tr');

    td = document.createElement('td');
    td.style.fontSize = '10pt';
    mxUtils.write(td, mxResources.get('format') + ':');

    row.appendChild(td);

    var imageFormatSelect = document.createElement('select');
    imageFormatSelect.style.width = '180px';

    var pngOption = document.createElement('option');
    pngOption.setAttribute('value', 'png');
    mxUtils.write(pngOption, mxResources.get('formatPng'));
    imageFormatSelect.appendChild(pngOption);

    var gifOption = document.createElement('option');

    if (ExportDialog.showGifOption) {
        gifOption.setAttribute('value', 'gif');
        mxUtils.write(gifOption, mxResources.get('formatGif'));
        imageFormatSelect.appendChild(gifOption);
    }

    var jpgOption = document.createElement('option');
    jpgOption.setAttribute('value', 'jpg');
    mxUtils.write(jpgOption, mxResources.get('formatJpg'));
    imageFormatSelect.appendChild(jpgOption);

    var pdfOption = document.createElement('option');
    pdfOption.setAttribute('value', 'pdf');
    mxUtils.write(pdfOption, mxResources.get('formatPdf'));
    imageFormatSelect.appendChild(pdfOption);

    var svgOption = document.createElement('option');
    svgOption.setAttribute('value', 'svg');
    mxUtils.write(svgOption, mxResources.get('formatSvg'));
    imageFormatSelect.appendChild(svgOption);

    if (ExportDialog.showXmlOption) {
        var xmlOption = document.createElement('option');
        xmlOption.setAttribute('value', 'xml');
        mxUtils.write(xmlOption, mxResources.get('formatXml'));
        imageFormatSelect.appendChild(xmlOption);
    }

    td = document.createElement('td');
    td.appendChild(imageFormatSelect);
    row.appendChild(td);

    tbody.appendChild(row);

    row = document.createElement('tr');

    td = document.createElement('td');
    td.style.fontSize = '10pt';
    mxUtils.write(td, mxResources.get('zoom') + ' (%):');

    row.appendChild(td);

    var zoomInput = document.createElement('input');
    zoomInput.setAttribute('type', 'number');
    zoomInput.setAttribute('value', '100');
    zoomInput.style.width = '180px';

    td = document.createElement('td');
    td.appendChild(zoomInput);
    row.appendChild(td);

    tbody.appendChild(row);

    row = document.createElement('tr');

    td = document.createElement('td');
    td.style.fontSize = '10pt';
    mxUtils.write(td, mxResources.get('width') + ':');

    row.appendChild(td);

    var widthInput = document.createElement('input');
    widthInput.setAttribute('value', width);
    widthInput.style.width = '180px';

    td = document.createElement('td');
    td.appendChild(widthInput);
    row.appendChild(td);

    tbody.appendChild(row);

    row = document.createElement('tr');

    td = document.createElement('td');
    td.style.fontSize = '10pt';
    mxUtils.write(td, mxResources.get('height') + ':');

    row.appendChild(td);

    var heightInput = document.createElement('input');
    heightInput.setAttribute('value', height);
    heightInput.style.width = '180px';

    td = document.createElement('td');
    td.appendChild(heightInput);
    row.appendChild(td);

    tbody.appendChild(row);

    row = document.createElement('tr');

    td = document.createElement('td');
    td.style.fontSize = '10pt';
    mxUtils.write(td, mxResources.get('dpi') + ':');

    row.appendChild(td);

    var dpiSelect = document.createElement('select');
    dpiSelect.style.width = '180px';

    var dpi100Option = document.createElement('option');
    dpi100Option.setAttribute('value', '100');
    mxUtils.write(dpi100Option, '100dpi');
    dpiSelect.appendChild(dpi100Option);

    var dpi200Option = document.createElement('option');
    dpi200Option.setAttribute('value', '200');
    mxUtils.write(dpi200Option, '200dpi');
    dpiSelect.appendChild(dpi200Option);

    var dpi300Option = document.createElement('option');
    dpi300Option.setAttribute('value', '300');
    mxUtils.write(dpi300Option, '300dpi');
    dpiSelect.appendChild(dpi300Option);

    var dpi400Option = document.createElement('option');
    dpi400Option.setAttribute('value', '400');
    mxUtils.write(dpi400Option, '400dpi');
    dpiSelect.appendChild(dpi400Option);

    var dpiCustOption = document.createElement('option');
    dpiCustOption.setAttribute('value', 'custom');
    mxUtils.write(dpiCustOption, mxResources.get('custom'));
    dpiSelect.appendChild(dpiCustOption);

    var customDpi = document.createElement('input');
    customDpi.style.width = '180px';
    customDpi.style.display = 'none';
    customDpi.setAttribute('value', '100');
    customDpi.setAttribute('type', 'number');
    customDpi.setAttribute('min', '50');
    customDpi.setAttribute('step', '50');

    var zoomUserChanged = false;

    mxEvent.addListener(dpiSelect, 'change', function () {
        if (this.value == 'custom') {
            this.style.display = 'none';
            customDpi.style.display = '';
            customDpi.focus();
        } else {
            customDpi.value = this.value;

            if (!zoomUserChanged) {
                zoomInput.value = this.value;
            }
        }
    });

    mxEvent.addListener(customDpi, 'change', function () {
        var dpi = parseInt(customDpi.value);

        if (isNaN(dpi) || dpi <= 0) {
            customDpi.style.backgroundColor = 'red';
        } else {
            customDpi.style.backgroundColor = '';

            if (!zoomUserChanged) {
                zoomInput.value = dpi;
            }
        }
    });

    td = document.createElement('td');
    td.appendChild(dpiSelect);
    td.appendChild(customDpi);
    row.appendChild(td);

    tbody.appendChild(row);

    row = document.createElement('tr');

    td = document.createElement('td');
    td.style.fontSize = '10pt';
    mxUtils.write(td, mxResources.get('background') + ':');

    row.appendChild(td);

    var transparentCheckbox = document.createElement('input');
    transparentCheckbox.setAttribute('type', 'checkbox');
    transparentCheckbox.checked = graph.background == null || graph.background == mxConstants.NONE;

    td = document.createElement('td');
    td.appendChild(transparentCheckbox);
    mxUtils.write(td, mxResources.get('transparent'));

    row.appendChild(td);

    tbody.appendChild(row);

    row = document.createElement('tr');

    td = document.createElement('td');
    td.style.fontSize = '10pt';
    mxUtils.write(td, mxResources.get('borderWidth') + ':');

    row.appendChild(td);

    var borderInput = document.createElement('input');
    borderInput.setAttribute('type', 'number');
    borderInput.setAttribute('value', ExportDialog.lastBorderValue);
    borderInput.style.width = '180px';

    td = document.createElement('td');
    td.appendChild(borderInput);
    row.appendChild(td);

    tbody.appendChild(row);
    table.appendChild(tbody);

    // Handles changes in the export format
    function formatChanged() {
        var name = nameInput.value;
        var dot = name.lastIndexOf('.');

        if (dot > 0) {
            nameInput.value = name.substring(0, dot + 1) + imageFormatSelect.value;
        } else {
            nameInput.value = name + '.' + imageFormatSelect.value;
        }

        if (imageFormatSelect.value === 'xml') {
            zoomInput.setAttribute('disabled', 'true');
            widthInput.setAttribute('disabled', 'true');
            heightInput.setAttribute('disabled', 'true');
            borderInput.setAttribute('disabled', 'true');
        } else {
            zoomInput.removeAttribute('disabled');
            widthInput.removeAttribute('disabled');
            heightInput.removeAttribute('disabled');
            borderInput.removeAttribute('disabled');
        }

        if (imageFormatSelect.value === 'png' || imageFormatSelect.value === 'svg') {
            transparentCheckbox.removeAttribute('disabled');
        } else {
            transparentCheckbox.setAttribute('disabled', 'disabled');
        }

        if (imageFormatSelect.value === 'png') {
            dpiSelect.removeAttribute('disabled');
            customDpi.removeAttribute('disabled');
        } else {
            dpiSelect.setAttribute('disabled', 'disabled');
            customDpi.setAttribute('disabled', 'disabled');
        }
    };

    mxEvent.addListener(imageFormatSelect, 'change', formatChanged);
    formatChanged();

    function checkValues() {
        if (widthInput.value * heightInput.value > MAX_AREA || widthInput.value <= 0) {
            widthInput.style.backgroundColor = 'red';
        } else {
            widthInput.style.backgroundColor = '';
        }

        if (widthInput.value * heightInput.value > MAX_AREA || heightInput.value <= 0) {
            heightInput.style.backgroundColor = 'red';
        } else {
            heightInput.style.backgroundColor = '';
        }
    };

    mxEvent.addListener(zoomInput, 'change', function () {
        zoomUserChanged = true;
        var s = Math.max(0, parseFloat(zoomInput.value) || 100) / 100;
        zoomInput.value = parseFloat((s * 100).toFixed(2));

        if (width > 0) {
            widthInput.value = Math.floor(width * s);
            heightInput.value = Math.floor(height * s);
        } else {
            zoomInput.value = '100';
            widthInput.value = width;
            heightInput.value = height;
        }

        checkValues();
    });

    mxEvent.addListener(widthInput, 'change', function () {
        var s = parseInt(widthInput.value) / width;

        if (s > 0) {
            zoomInput.value = parseFloat((s * 100).toFixed(2));
            heightInput.value = Math.floor(height * s);
        } else {
            zoomInput.value = '100';
            widthInput.value = width;
            heightInput.value = height;
        }

        checkValues();
    });

    mxEvent.addListener(heightInput, 'change', function () {
        var s = parseInt(heightInput.value) / height;

        if (s > 0) {
            zoomInput.value = parseFloat((s * 100).toFixed(2));
            widthInput.value = Math.floor(width * s);
        } else {
            zoomInput.value = '100';
            widthInput.value = width;
            heightInput.value = height;
        }

        checkValues();
    });

    row = document.createElement('tr');
    td = document.createElement('td');
    td.setAttribute('align', 'right');
    td.style.paddingTop = '22px';
    td.colSpan = 2;

    var saveBtn = mxUtils.button(mxResources.get('export'), mxUtils.bind(this, function () {
        if (parseInt(zoomInput.value) <= 0) {
            mxUtils.alert(mxResources.get('drawingEmpty'));
        } else {
            var name = nameInput.value;
            var format = imageFormatSelect.value;
            var s = Math.max(0, parseFloat(zoomInput.value) || 100) / 100;
            var b = Math.max(0, parseInt(borderInput.value));
            var bg = graph.background;
            var dpi = Math.max(1, parseInt(customDpi.value));

            if ((format == 'svg' || format == 'png') && transparentCheckbox.checked) {
                bg = null;
            } else if (bg == null || bg == mxConstants.NONE) {
                bg = '#ffffff';
            }

            ExportDialog.lastBorderValue = b;
            ExportDialog.exportFile(editorUi, name, format, bg, s, b, dpi);
        }
    }));
    saveBtn.className = 'geBtn gePrimaryBtn';

    var cancelBtn = mxUtils.button(mxResources.get('cancel'), function () {
        editorUi.hideDialog();
    });
    cancelBtn.className = 'geBtn';

    if (editorUi.editor.cancelFirst) {
        td.appendChild(cancelBtn);
        td.appendChild(saveBtn);
    } else {
        td.appendChild(saveBtn);
        td.appendChild(cancelBtn);
    }

    row.appendChild(td);
    tbody.appendChild(row);
    table.appendChild(tbody);
    this.container = table;
};

/**
 * Remembers last value for border.
 */
ExportDialog.lastBorderValue = 0;

/**
 * Global switches for the export dialog.
 */
ExportDialog.showGifOption = true;

/**
 * Global switches for the export dialog.
 */
ExportDialog.showXmlOption = true;

/**
 * Hook for getting the export format. Returns null for the default
 * intermediate XML export format or a function that returns the
 * parameter and value to be used in the request in the form
 * key=value, where value should be URL encoded.
 */
ExportDialog.exportFile = function (editorUi, name, format, bg, s, b, dpi) {
    var graph = editorUi.editor.graph;

    if (format == 'xml') {
        ExportDialog.saveLocalFile(editorUi, mxUtils.getXml(editorUi.editor.getGraphXml()), name, format);
    } else if (format == 'svg') {
        ExportDialog.saveLocalFile(editorUi, mxUtils.getXml(graph.getSvg(bg, s, b)), name, format);
    } else {
        var bounds = graph.getGraphBounds();

        // New image export
        var xmlDoc = mxUtils.createXmlDocument();
        var root = xmlDoc.createElement('output');
        xmlDoc.appendChild(root);

        // Renders graph. Offset will be multiplied with state's scale when painting state.
        var xmlCanvas = new mxXmlCanvas2D(root);
        xmlCanvas.translate(Math.floor((b / s - bounds.x) / graph.view.scale),
            Math.floor((b / s - bounds.y) / graph.view.scale));
        xmlCanvas.scale(s / graph.view.scale);

        var imgExport = new mxImageExport()
        imgExport.drawState(graph.getView().getState(graph.model.root), xmlCanvas);

        // Puts request data together
        var param = 'xml=' + encodeURIComponent(mxUtils.getXml(root));
        var w = Math.ceil(bounds.width * s / graph.view.scale + 2 * b);
        var h = Math.ceil(bounds.height * s / graph.view.scale + 2 * b);

        // Requests image if request is valid
        if (param.length <= MAX_REQUEST_SIZE && w * h < MAX_AREA) {
            editorUi.hideDialog();
            var req = new mxXmlRequest(EXPORT_URL, 'format=' + format +
                '&filename=' + encodeURIComponent(name) +
                '&bg=' + ((bg != null) ? bg : 'none') +
                '&w=' + w + '&h=' + h + '&' + param +
                '&dpi=' + dpi);
            req.simulate(document, '_blank');
        } else {
            mxUtils.alert(mxResources.get('drawingTooLarge'));
        }
    }
};

/**
 * Hook for getting the export format. Returns null for the default
 * intermediate XML export format or a function that returns the
 * parameter and value to be used in the request in the form
 * key=value, where value should be URL encoded.
 */
ExportDialog.saveLocalFile = function (editorUi, data, filename, format) {
    if (data.length < MAX_REQUEST_SIZE) {
        editorUi.hideDialog();
        var req = new mxXmlRequest(SAVE_URL, 'xml=' + encodeURIComponent(data) + '&filename=' +
            encodeURIComponent(filename) + '&format=' + format);
        req.simulate(document, '_blank');
    } else {
        mxUtils.alert(mxResources.get('drawingTooLarge'));
        mxUtils.popup(xml);
    }
};

/**
 * Constructs a new metadata dialog.
 */
var EditDataDialog = function (ui, cell) {
    var div = document.createElement('div');
    var graph = ui.editor.graph;

    var value = graph.getModel().getValue(cell);

    // Converts the value to an XML node
    if (!mxUtils.isNode(value)) {
        var doc = mxUtils.createXmlDocument();
        var obj = doc.createElement('object');
        obj.setAttribute('label', value || '');
        value = obj;
    }

    // Creates the dialog contents
    var form = new mxForm('properties');
    form.table.style.width = '100%';

    var attrs = value.attributes;
    var names = [];
    var texts = [];
    var count = 0;

    var id = (EditDataDialog.getDisplayIdForCell != null) ?
        EditDataDialog.getDisplayIdForCell(ui, cell) : null;

    var addRemoveButton = function (text, name) {
        var wrapper = document.createElement('div');
        wrapper.style.position = 'relative';
        wrapper.style.paddingRight = '20px';
        wrapper.style.boxSizing = 'border-box';
        wrapper.style.width = '100%';

        var removeAttr = document.createElement('a');
        var img = mxUtils.createImage(Dialog.prototype.closeImage);
        img.style.height = '9px';
        img.style.fontSize = '9px';
        img.style.marginBottom = (mxClient.IS_IE11) ? '-1px' : '5px';

        removeAttr.className = 'geButton';
        removeAttr.setAttribute('title', mxResources.get('delete'));
        removeAttr.style.position = 'absolute';
        removeAttr.style.top = '4px';
        removeAttr.style.right = '0px';
        removeAttr.style.margin = '0px';
        removeAttr.style.width = '9px';
        removeAttr.style.height = '9px';
        removeAttr.style.cursor = 'pointer';
        removeAttr.appendChild(img);

        var removeAttrFn = (function (name) {
            return function () {
                var count = 0;

                for (var j = 0; j < names.length; j++) {
                    if (names[j] == name) {
                        texts[j] = null;
                        form.table.deleteRow(count + ((id != null) ? 1 : 0));

                        break;
                    }

                    if (texts[j] != null) {
                        count++;
                    }
                }
            };
        })(name);

        mxEvent.addListener(removeAttr, 'click', removeAttrFn);

        var parent = text.parentNode;
        wrapper.appendChild(text);
        wrapper.appendChild(removeAttr);
        parent.appendChild(wrapper);
    };

    var addTextArea = function (index, name, value) {
        names[index] = name;
        texts[index] = form.addTextarea(names[count] + ':', value, 2);
        texts[index].style.width = '100%';

        addRemoveButton(texts[index], name);
    };

    var temp = [];
    var isLayer = graph.getModel().getParent(cell) == graph.getModel().getRoot();

    for (var i = 0; i < attrs.length; i++) {
        if ((isLayer || attrs[i].nodeName != 'label') && attrs[i].nodeName != 'placeholders') {
            temp.push({name: attrs[i].nodeName, value: attrs[i].nodeValue});
        }
    }

    // Sorts by name
    temp.sort(function (a, b) {
        if (a.name < b.name) {
            return -1;
        } else if (a.name > b.name) {
            return 1;
        } else {
            return 0;
        }
    });

    if (id != null) {
        var text = document.createElement('div');
        text.style.width = '100%';
        text.style.fontSize = '11px';
        text.style.textAlign = 'center';
        mxUtils.write(text, id);

        form.addField(mxResources.get('id') + ':', text);
    }

    for (var i = 0; i < temp.length; i++) {
        addTextArea(count, temp[i].name, temp[i].value);
        count++;
    }

    var top = document.createElement('div');
    top.style.cssText = 'position:absolute;left:30px;right:30px;overflow-y:auto;top:30px;bottom:80px;';
    top.appendChild(form.table);

    var newProp = document.createElement('div');
    newProp.style.boxSizing = 'border-box';
    newProp.style.paddingRight = '160px';
    newProp.style.whiteSpace = 'nowrap';
    newProp.style.marginTop = '6px';
    newProp.style.width = '100%';

    var nameInput = document.createElement('input');
    nameInput.setAttribute('placeholder', mxResources.get('enterPropertyName'));
    nameInput.setAttribute('type', 'text');
    nameInput.setAttribute('size', (mxClient.IS_IE || mxClient.IS_IE11) ? '36' : '40');
    nameInput.style.boxSizing = 'border-box';
    nameInput.style.marginLeft = '2px';
    nameInput.style.width = '100%';

    newProp.appendChild(nameInput);
    top.appendChild(newProp);
    div.appendChild(top);

    var addBtn = mxUtils.button(mxResources.get('addProperty'), function () {
        var name = nameInput.value;

        // Avoid ':' in attribute names which seems to be valid in Chrome
        if (name.length > 0 && name != 'label' && name != 'placeholders' && name.indexOf(':') < 0) {
            try {
                var idx = mxUtils.indexOf(names, name);

                if (idx >= 0 && texts[idx] != null) {
                    texts[idx].focus();
                } else {
                    // Checks if the name is valid
                    var clone = value.cloneNode(false);
                    clone.setAttribute(name, '');

                    if (idx >= 0) {
                        names.splice(idx, 1);
                        texts.splice(idx, 1);
                    }

                    names.push(name);
                    var text = form.addTextarea(name + ':', '', 2);
                    text.style.width = '100%';
                    texts.push(text);
                    addRemoveButton(text, name);

                    text.focus();
                }

                addBtn.setAttribute('disabled', 'disabled');
                nameInput.value = '';
            } catch (e) {
                mxUtils.alert(e);
            }
        } else {
            mxUtils.alert(mxResources.get('invalidName'));
        }
    });

    this.init = function () {
        if (texts.length > 0) {
            texts[0].focus();
        } else {
            nameInput.focus();
        }
    };

    addBtn.setAttribute('title', mxResources.get('addProperty'));
    addBtn.setAttribute('disabled', 'disabled');
    addBtn.style.textOverflow = 'ellipsis';
    addBtn.style.position = 'absolute';
    addBtn.style.overflow = 'hidden';
    addBtn.style.width = '144px';
    addBtn.style.right = '0px';
    addBtn.className = 'geBtn';
    newProp.appendChild(addBtn);

    var cancelBtn = mxUtils.button(mxResources.get('cancel'), function () {
        ui.hideDialog.apply(ui, arguments);
    });

    cancelBtn.className = 'geBtn';

    var applyBtn = mxUtils.button(mxResources.get('apply'), function () {
        try {
            ui.hideDialog.apply(ui, arguments);

            // Clones and updates the value
            value = value.cloneNode(true);
            var removeLabel = false;

            for (var i = 0; i < names.length; i++) {
                if (texts[i] == null) {
                    value.removeAttribute(names[i]);
                } else {
                    value.setAttribute(names[i], texts[i].value);
                    removeLabel = removeLabel || (names[i] == 'placeholder' &&
                        value.getAttribute('placeholders') == '1');
                }
            }

            // Removes label if placeholder is assigned
            if (removeLabel) {
                value.removeAttribute('label');
            }

            // Updates the value of the cell (undoable)
            graph.getModel().setValue(cell, value);
        } catch (e) {
            mxUtils.alert(e);
        }
    });
    applyBtn.className = 'geBtn gePrimaryBtn';

    function updateAddBtn() {
        if (nameInput.value.length > 0) {
            addBtn.removeAttribute('disabled');
        } else {
            addBtn.setAttribute('disabled', 'disabled');
        }
    };

    mxEvent.addListener(nameInput, 'keyup', updateAddBtn);

    // Catches all changes that don't fire a keyup (such as paste via mouse)
    mxEvent.addListener(nameInput, 'change', updateAddBtn);

    var buttons = document.createElement('div');
    buttons.style.cssText = 'position:absolute;left:30px;right:30px;text-align:right;bottom:30px;height:40px;'

    if (ui.editor.graph.getModel().isVertex(cell) || ui.editor.graph.getModel().isEdge(cell)) {
        var replace = document.createElement('span');
        replace.style.marginRight = '10px';
        var input = document.createElement('input');
        input.setAttribute('type', 'checkbox');
        input.style.marginRight = '6px';

        if (value.getAttribute('placeholders') == '1') {
            input.setAttribute('checked', 'checked');
            input.defaultChecked = true;
        }

        mxEvent.addListener(input, 'click', function () {
            if (value.getAttribute('placeholders') == '1') {
                value.removeAttribute('placeholders');
            } else {
                value.setAttribute('placeholders', '1');
            }
        });

        replace.appendChild(input);
        mxUtils.write(replace, mxResources.get('placeholders'));

        if (EditDataDialog.placeholderHelpLink != null) {
            var link = document.createElement('a');
            link.setAttribute('href', EditDataDialog.placeholderHelpLink);
            link.setAttribute('title', mxResources.get('help'));
            link.setAttribute('target', '_blank');
            link.style.marginLeft = '8px';
            link.style.cursor = 'help';

            var icon = document.createElement('img');
            mxUtils.setOpacity(icon, 50);
            icon.style.height = '16px';
            icon.style.width = '16px';
            icon.setAttribute('border', '0');
            icon.setAttribute('valign', 'middle');
            icon.style.marginTop = (mxClient.IS_IE11) ? '0px' : '-4px';
            icon.setAttribute('src', Editor.helpImage);
            link.appendChild(icon);

            replace.appendChild(link);
        }

        buttons.appendChild(replace);
    }

    if (ui.editor.cancelFirst) {
        buttons.appendChild(cancelBtn);
        buttons.appendChild(applyBtn);
    } else {
        buttons.appendChild(applyBtn);
        buttons.appendChild(cancelBtn);
    }

    div.appendChild(buttons);
    this.container = div;
};

/**
 * Optional help link.
 */
EditDataDialog.getDisplayIdForCell = function (ui, cell) {
    var id = null;

    if (ui.editor.graph.getModel().getParent(cell) != null) {
        id = cell.getId();
    }

    return id;
};

/**
 * Optional help link.
 */
EditDataDialog.placeholderHelpLink = null;

/**
 * Constructs a new link dialog.
 */
var LinkDialog = function (editorUi, initialValue, btnLabel, fn) {
    var div = document.createElement('div');
    mxUtils.write(div, mxResources.get('editLink') + ':');

    var inner = document.createElement('div');
    inner.className = 'geTitle';
    inner.style.backgroundColor = 'transparent';
    inner.style.borderColor = 'transparent';
    inner.style.whiteSpace = 'nowrap';
    inner.style.textOverflow = 'clip';
    inner.style.cursor = 'default';

    if (!mxClient.IS_VML) {
        inner.style.paddingRight = '20px';
    }

    var linkInput = document.createElement('input');
    linkInput.setAttribute('value', initialValue);
    linkInput.setAttribute('placeholder', 'http://www.example.com/');
    linkInput.setAttribute('type', 'text');
    linkInput.style.marginTop = '6px';
    linkInput.style.width = '400px';
    linkInput.style.backgroundImage = 'url(\'' + Dialog.prototype.clearImage + '\')';
    linkInput.style.backgroundRepeat = 'no-repeat';
    linkInput.style.backgroundPosition = '100% 50%';
    linkInput.style.paddingRight = '14px';

    var cross = document.createElement('div');
    cross.setAttribute('title', mxResources.get('reset'));
    cross.style.position = 'relative';
    cross.style.left = '-16px';
    cross.style.width = '12px';
    cross.style.height = '14px';
    cross.style.cursor = 'pointer';

    // Workaround for inline-block not supported in IE
    cross.style.display = (mxClient.IS_VML) ? 'inline' : 'inline-block';
    cross.style.top = ((mxClient.IS_VML) ? 0 : 3) + 'px';

    // Needed to block event transparency in IE
    cross.style.background = 'url(' + IMAGE_PATH + '/transparent.gif)';

    mxEvent.addListener(cross, 'click', function () {
        linkInput.value = '';
        linkInput.focus();
    });

    inner.appendChild(linkInput);
    inner.appendChild(cross);
    div.appendChild(inner);

    this.init = function () {
        linkInput.focus();

        if (mxClient.IS_GC || mxClient.IS_FF || document.documentMode >= 5 || mxClient.IS_QUIRKS) {
            linkInput.select();
        } else {
            document.execCommand('selectAll', false, null);
        }
    };

    var btns = document.createElement('div');
    btns.style.marginTop = '18px';
    btns.style.textAlign = 'right';

    mxEvent.addListener(linkInput, 'keypress', function (e) {
        if (e.keyCode == 13) {
            editorUi.hideDialog();
            fn(linkInput.value);
        }
    });

    var cancelBtn = mxUtils.button(mxResources.get('cancel'), function () {
        editorUi.hideDialog();
    });
    cancelBtn.className = 'geBtn';

    if (editorUi.editor.cancelFirst) {
        btns.appendChild(cancelBtn);
    }

    var mainBtn = mxUtils.button(btnLabel, function () {
        editorUi.hideDialog();
        fn(linkInput.value);
    });
    mainBtn.className = 'geBtn gePrimaryBtn';
    btns.appendChild(mainBtn);

    if (!editorUi.editor.cancelFirst) {
        btns.appendChild(cancelBtn);
    }

    div.appendChild(btns);

    this.container = div;
};

/**
 *
 */
var OutlineWindow = function (editorUi, x, y, w, h) {
    var graph = editorUi.editor.graph;

    var div = document.createElement('div');
    div.style.position = 'absolute';
    div.style.width = '100%';
    div.style.height = '100%';
    div.style.border = '1px solid whiteSmoke';
    div.style.overflow = 'hidden';

    this.window = new mxWindow(mxResources.get('outline'), div, x, y, w, h, true, true);
    this.window.minimumSize = new mxRectangle(0, 0, 80, 80);
    this.window.destroyOnClose = false;
    this.window.setMaximizable(false);
    this.window.setResizable(true);
    this.window.setClosable(true);
    this.window.setVisible(true);

    this.window.setLocation = function (x, y) {
        var iw = window.innerWidth || document.body.clientWidth || document.documentElement.clientWidth;
        var ih = window.innerHeight || document.body.clientHeight || document.documentElement.clientHeight;

        x = Math.max(0, Math.min(x, iw - this.table.clientWidth));
        y = Math.max(0, Math.min(y, ih - this.table.clientHeight - 48));

        if (this.getX() != x || this.getY() != y) {
            mxWindow.prototype.setLocation.apply(this, arguments);
        }
    };

    var resizeListener = mxUtils.bind(this, function () {
        var x = this.window.getX();
        var y = this.window.getY();

        this.window.setLocation(x, y);
    });

    mxEvent.addListener(window, 'resize', resizeListener);

    var outline = editorUi.createOutline(this.window);

    this.destroy = function () {
        mxEvent.removeListener(window, 'resize', resizeListener);
        this.window.destroy();
        outline.destroy();
    }

    this.window.addListener(mxEvent.RESIZE, mxUtils.bind(this, function () {
        outline.update(false);
        outline.outline.sizeDidChange();
    }));

    this.window.addListener(mxEvent.SHOW, mxUtils.bind(this, function () {
        this.window.fit();
        outline.suspended = false;
        outline.outline.refresh();
        outline.update();
    }));

    this.window.addListener(mxEvent.HIDE, mxUtils.bind(this, function () {
        outline.suspended = true;
    }));

    this.window.addListener(mxEvent.NORMALIZE, mxUtils.bind(this, function () {
        outline.suspended = false;
        outline.update();
    }));

    this.window.addListener(mxEvent.MINIMIZE, mxUtils.bind(this, function () {
        outline.suspended = true;
    }));

    var outlineCreateGraph = outline.createGraph;
    outline.createGraph = function (container) {
        var g = outlineCreateGraph.apply(this, arguments);
        g.gridEnabled = false;
        g.pageScale = graph.pageScale;
        g.pageFormat = graph.pageFormat;
        g.background = (graph.background == null || graph.background == mxConstants.NONE) ? graph.defaultPageBackgroundColor : graph.background;
        g.pageVisible = graph.pageVisible;

        var current = mxUtils.getCurrentStyle(graph.container);
        div.style.backgroundColor = current.backgroundColor;

        return g;
    };

    function update() {
        outline.outline.pageScale = graph.pageScale;
        outline.outline.pageFormat = graph.pageFormat;
        outline.outline.pageVisible = graph.pageVisible;
        outline.outline.background = (graph.background == null || graph.background == mxConstants.NONE) ? graph.defaultPageBackgroundColor : graph.background;
        ;

        var current = mxUtils.getCurrentStyle(graph.container);
        div.style.backgroundColor = current.backgroundColor;

        if (graph.view.backgroundPageShape != null && outline.outline.view.backgroundPageShape != null) {
            outline.outline.view.backgroundPageShape.fill = graph.view.backgroundPageShape.fill;
        }

        outline.outline.refresh();
    };

    outline.init(div);

    editorUi.editor.addListener('resetGraphView', update);
    editorUi.addListener('pageFormatChanged', update);
    editorUi.addListener('backgroundColorChanged', update);
    editorUi.addListener('backgroundImageChanged', update);
    editorUi.addListener('pageViewChanged', function () {
        update();
        outline.update(true);
    });

    if (outline.outline.dialect == mxConstants.DIALECT_SVG) {
        var zoomInAction = editorUi.actions.get('zoomIn');
        var zoomOutAction = editorUi.actions.get('zoomOut');

        mxEvent.addMouseWheelListener(function (evt, up) {
            var outlineWheel = false;
            var source = mxEvent.getSource(evt);

            while (source != null) {
                if (source == outline.outline.view.canvas.ownerSVGElement) {
                    outlineWheel = true;
                    break;
                }

                source = source.parentNode;
            }

            if (outlineWheel) {
                if (up) {
                    zoomInAction.funct();
                } else {
                    zoomOutAction.funct();
                }

                mxEvent.consume(evt);
            }
        });
    }
};

/**
 *
 */
var LayersWindow = function (editorUi, x, y, w, h) {
    var graph = editorUi.editor.graph;

    var div = document.createElement('div');
    div.style.userSelect = 'none';
    div.style.background = (Dialog.backdropColor == 'white') ? 'whiteSmoke' : Dialog.backdropColor;
    div.style.border = '1px solid whiteSmoke';
    div.style.height = '100%';
    div.style.marginBottom = '10px';
    div.style.overflow = 'auto';

    var tbarHeight = (!EditorUi.compactUi) ? '30px' : '26px';

    var listDiv = document.createElement('div')
    listDiv.style.backgroundColor = (Dialog.backdropColor == 'white') ? '#dcdcdc' : Dialog.backdropColor;
    listDiv.style.position = 'absolute';
    listDiv.style.overflow = 'auto';
    listDiv.style.left = '0px';
    listDiv.style.right = '0px';
    listDiv.style.top = '0px';
    listDiv.style.bottom = (parseInt(tbarHeight) + 7) + 'px';
    div.appendChild(listDiv);

    var dragSource = null;
    var dropIndex = null;

    mxEvent.addListener(div, 'dragover', function (evt) {
        evt.dataTransfer.dropEffect = 'move';
        dropIndex = 0;
        evt.stopPropagation();
        evt.preventDefault();
    });

    // Workaround for "no element found" error in FF
    mxEvent.addListener(div, 'drop', function (evt) {
        evt.stopPropagation();
        evt.preventDefault();
    });

    var layerCount = null;
    var selectionLayer = null;

    var ldiv = document.createElement('div');

    ldiv.className = 'geToolbarContainer';
    ldiv.style.position = 'absolute';
    ldiv.style.bottom = '0px';
    ldiv.style.left = '0px';
    ldiv.style.right = '0px';
    ldiv.style.height = tbarHeight;
    ldiv.style.overflow = 'hidden';
    ldiv.style.padding = (!EditorUi.compactUi) ? '1px' : '4px 0px 3px 0px';
    ldiv.style.backgroundColor = (Dialog.backdropColor == 'white') ? 'whiteSmoke' : Dialog.backdropColor;
    ldiv.style.borderWidth = '1px 0px 0px 0px';
    ldiv.style.borderColor = '#c3c3c3';
    ldiv.style.borderStyle = 'solid';
    ldiv.style.display = 'block';
    ldiv.style.whiteSpace = 'nowrap';

    if (mxClient.IS_QUIRKS) {
        ldiv.style.filter = 'none';
    }

    var link = document.createElement('a');
    link.className = 'geButton';

    if (mxClient.IS_QUIRKS) {
        link.style.filter = 'none';
    }

    var removeLink = link.cloneNode();
    removeLink.innerHTML = '<div class="geSprite geSprite-delete" style="display:inline-block;"></div>';

    mxEvent.addListener(removeLink, 'click', function (evt) {
        if (graph.isEnabled()) {
            graph.model.beginUpdate();
            try {
                var index = graph.model.root.getIndex(selectionLayer);
                graph.removeCells([selectionLayer], false);

                // Creates default layer if no layer exists
                if (graph.model.getChildCount(graph.model.root) == 0) {
                    graph.model.add(graph.model.root, new mxCell());
                    graph.setDefaultParent(null);
                } else if (index > 0 && index <= graph.model.getChildCount(graph.model.root)) {
                    graph.setDefaultParent(graph.model.getChildAt(graph.model.root, index - 1));
                } else {
                    graph.setDefaultParent(null);
                }
            } finally {
                graph.model.endUpdate();
            }
        }

        mxEvent.consume(evt);
    });

    if (!graph.isEnabled()) {
        removeLink.className = 'geButton mxDisabled';
    }

    ldiv.appendChild(removeLink);

    var insertLink = link.cloneNode();
    insertLink.setAttribute('title', mxUtils.trim(mxResources.get('moveSelectionTo', [''])));
    insertLink.innerHTML = '<div class="geSprite geSprite-insert" style="display:inline-block;"></div>';

    mxEvent.addListener(insertLink, 'click', function (evt) {
        if (graph.isEnabled() && !graph.isSelectionEmpty()) {
            editorUi.editor.graph.popupMenuHandler.hideMenu();

            var menu = new mxPopupMenu(mxUtils.bind(this, function (menu, parent) {
                for (var i = layerCount - 1; i >= 0; i--) {
                    (mxUtils.bind(this, function (child) {
                        var item = menu.addItem(graph.convertValueToString(child) ||
                            mxResources.get('background'), null, mxUtils.bind(this, function () {
                            graph.moveCells(graph.getSelectionCells(), 0, 0, false, child);
                        }), parent);

                        if (graph.getSelectionCount() == 1 && graph.model.isAncestor(child, graph.getSelectionCell())) {
                            menu.addCheckmark(item, Editor.checkmarkImage);
                        }

                    }))(graph.model.getChildAt(graph.model.root, i));
                }
            }));
            menu.div.className += ' geMenubarMenu';
            menu.smartSeparators = true;
            menu.showDisabled = true;
            menu.autoExpand = true;

            // Disables autoexpand and destroys menu when hidden
            menu.hideMenu = mxUtils.bind(this, function () {
                mxPopupMenu.prototype.hideMenu.apply(menu, arguments);
                menu.destroy();
            });

            var offset = mxUtils.getOffset(insertLink);
            menu.popup(offset.x, offset.y + insertLink.offsetHeight, null, evt);

            // Allows hiding by clicking on document
            editorUi.setCurrentMenu(menu);
        }
    });

    ldiv.appendChild(insertLink);

    var dataLink = link.cloneNode();
    dataLink.innerHTML = '<div class="geSprite geSprite-dots" style="display:inline-block;"></div>';
    dataLink.setAttribute('title', mxResources.get('rename'));

    mxEvent.addListener(dataLink, 'click', function (evt) {
        if (graph.isEnabled()) {
            editorUi.showDataDialog(selectionLayer);
        }

        mxEvent.consume(evt);
    });

    if (!graph.isEnabled()) {
        dataLink.className = 'geButton mxDisabled';
    }

    ldiv.appendChild(dataLink);

    function renameLayer(layer) {
        if (graph.isEnabled() && layer != null) {
            var label = graph.convertValueToString(layer);
            var dlg = new FilenameDialog(editorUi, label || mxResources.get('background'), mxResources.get('rename'), mxUtils.bind(this, function (newValue) {
                if (newValue != null) {
                    graph.cellLabelChanged(layer, newValue);
                }
            }), mxResources.get('enterName'));
            editorUi.showDialog(dlg.container, 300, 100, true, true);
            dlg.init();
        }
    };

    var duplicateLink = link.cloneNode();
    duplicateLink.innerHTML = '<div class="geSprite geSprite-duplicate" style="display:inline-block;"></div>';

    mxEvent.addListener(duplicateLink, 'click', function (evt) {
        if (graph.isEnabled()) {
            var newCell = null;
            graph.model.beginUpdate();
            try {
                newCell = graph.cloneCell(selectionLayer);
                graph.cellLabelChanged(newCell, mxResources.get('untitledLayer'));
                newCell.setVisible(true);
                newCell = graph.addCell(newCell, graph.model.root);
                graph.setDefaultParent(newCell);
            } finally {
                graph.model.endUpdate();
            }

            if (newCell != null && !graph.isCellLocked(newCell)) {
                graph.selectAll(newCell);
            }
        }
    });

    if (!graph.isEnabled()) {
        duplicateLink.className = 'geButton mxDisabled';
    }

    ldiv.appendChild(duplicateLink);

    var addLink = link.cloneNode();
    addLink.innerHTML = '<div class="geSprite geSprite-plus" style="display:inline-block;"></div>';
    addLink.setAttribute('title', mxResources.get('addLayer'));

    mxEvent.addListener(addLink, 'click', function (evt) {
        if (graph.isEnabled()) {
            graph.model.beginUpdate();

            try {
                var cell = graph.addCell(new mxCell(mxResources.get('untitledLayer')), graph.model.root);
                graph.setDefaultParent(cell);
            } finally {
                graph.model.endUpdate();
            }
        }

        mxEvent.consume(evt);
    });

    if (!graph.isEnabled()) {
        addLink.className = 'geButton mxDisabled';
    }

    ldiv.appendChild(addLink);

    div.appendChild(ldiv);

    function refresh() {
        layerCount = graph.model.getChildCount(graph.model.root)
        listDiv.innerHTML = '';

        function addLayer(index, label, child, defaultParent) {
            var ldiv = document.createElement('div');
            ldiv.className = 'geToolbarContainer';

            ldiv.style.overflow = 'hidden';
            ldiv.style.position = 'relative';
            ldiv.style.padding = '4px';
            ldiv.style.height = '22px';
            ldiv.style.display = 'block';
            ldiv.style.backgroundColor = (Dialog.backdropColor == 'white') ? 'whiteSmoke' : Dialog.backdropColor;
            ldiv.style.borderWidth = '0px 0px 1px 0px';
            ldiv.style.borderColor = '#c3c3c3';
            ldiv.style.borderStyle = 'solid';
            ldiv.style.whiteSpace = 'nowrap';
            ldiv.setAttribute('title', label);

            var left = document.createElement('div');
            left.style.display = 'inline-block';
            left.style.width = '100%';
            left.style.textOverflow = 'ellipsis';
            left.style.overflow = 'hidden';

            mxEvent.addListener(ldiv, 'dragover', function (evt) {
                evt.dataTransfer.dropEffect = 'move';
                dropIndex = index;
                evt.stopPropagation();
                evt.preventDefault();
            });

            mxEvent.addListener(ldiv, 'dragstart', function (evt) {
                dragSource = ldiv;

                // Workaround for no DnD on DIV in FF
                if (mxClient.IS_FF) {
                    // LATER: Check what triggers a parse as XML on this in FF after drop
                    evt.dataTransfer.setData('Text', '<layer/>');
                }
            });

            mxEvent.addListener(ldiv, 'dragend', function (evt) {
                if (dragSource != null && dropIndex != null) {
                    graph.addCell(child, graph.model.root, dropIndex);
                }

                dragSource = null;
                dropIndex = null;
                evt.stopPropagation();
                evt.preventDefault();
            });

            var btn = document.createElement('img');
            btn.setAttribute('draggable', 'false');
            btn.setAttribute('align', 'top');
            btn.setAttribute('border', '0');
            btn.style.padding = '4px';
            btn.setAttribute('title', mxResources.get('lockUnlock'));

            var state = graph.view.getState(child);
            var style = (state != null) ? state.style : graph.getCellStyle(child);

            if (mxUtils.getValue(style, 'locked', '0') == '1') {
                btn.setAttribute('src', Dialog.prototype.lockedImage);
            } else {
                btn.setAttribute('src', Dialog.prototype.unlockedImage);
            }

            if (graph.isEnabled()) {
                btn.style.cursor = 'pointer';
            }

            mxEvent.addListener(btn, 'click', function (evt) {
                if (graph.isEnabled()) {
                    var value = null;

                    graph.getModel().beginUpdate();
                    try {
                        value = (mxUtils.getValue(style, 'locked', '0') == '1') ? null : '1';
                        graph.setCellStyles('locked', value, [child]);
                    } finally {
                        graph.getModel().endUpdate();
                    }

                    if (value == '1') {
                        graph.removeSelectionCells(graph.getModel().getDescendants(child));
                    }

                    mxEvent.consume(evt);
                }
            });

            left.appendChild(btn);

            var inp = document.createElement('input');
            inp.setAttribute('type', 'checkbox');
            inp.setAttribute('title', mxResources.get('hideIt', [child.value || mxResources.get('background')]));
            inp.style.marginLeft = '4px';
            inp.style.marginRight = '6px';
            inp.style.marginTop = '4px';
            left.appendChild(inp);

            if (graph.model.isVisible(child)) {
                inp.setAttribute('checked', 'checked');
                inp.defaultChecked = true;
            }

            mxEvent.addListener(inp, 'click', function (evt) {
                graph.model.setVisible(child, !graph.model.isVisible(child));
                mxEvent.consume(evt);
            });

            mxUtils.write(left, label);
            ldiv.appendChild(left);

            if (graph.isEnabled()) {
                // Fallback if no drag and drop is available
                if (mxClient.IS_TOUCH || mxClient.IS_POINTER || mxClient.IS_VML ||
                    (mxClient.IS_IE && document.documentMode < 10)) {
                    var right = document.createElement('div');
                    right.style.display = 'block';
                    right.style.textAlign = 'right';
                    right.style.whiteSpace = 'nowrap';
                    right.style.position = 'absolute';
                    right.style.right = '6px';
                    right.style.top = '6px';

                    // Poor man's change layer order
                    if (index > 0) {
                        var img2 = document.createElement('a');

                        img2.setAttribute('title', mxResources.get('toBack'));

                        img2.className = 'geButton';
                        img2.style.cssFloat = 'none';
                        img2.innerHTML = '&#9660;';
                        img2.style.width = '14px';
                        img2.style.height = '14px';
                        img2.style.fontSize = '14px';
                        img2.style.margin = '0px';
                        img2.style.marginTop = '-1px';
                        right.appendChild(img2);

                        mxEvent.addListener(img2, 'click', function (evt) {
                            if (graph.isEnabled()) {
                                graph.addCell(child, graph.model.root, index - 1);
                            }

                            mxEvent.consume(evt);
                        });
                    }

                    if (index >= 0 && index < layerCount - 1) {
                        var img1 = document.createElement('a');

                        img1.setAttribute('title', mxResources.get('toFront'));

                        img1.className = 'geButton';
                        img1.style.cssFloat = 'none';
                        img1.innerHTML = '&#9650;';
                        img1.style.width = '14px';
                        img1.style.height = '14px';
                        img1.style.fontSize = '14px';
                        img1.style.margin = '0px';
                        img1.style.marginTop = '-1px';
                        right.appendChild(img1);

                        mxEvent.addListener(img1, 'click', function (evt) {
                            if (graph.isEnabled()) {
                                graph.addCell(child, graph.model.root, index + 1);
                            }

                            mxEvent.consume(evt);
                        });
                    }

                    ldiv.appendChild(right);
                }

                if (mxClient.IS_SVG && (!mxClient.IS_IE || document.documentMode >= 10)) {
                    ldiv.setAttribute('draggable', 'true');
                    ldiv.style.cursor = 'move';
                }
            }

            mxEvent.addListener(ldiv, 'dblclick', function (evt) {
                var nodeName = mxEvent.getSource(evt).nodeName;

                if (nodeName != 'INPUT' && nodeName != 'IMG') {
                    renameLayer(child);
                    mxEvent.consume(evt);
                }
            });

            if (graph.getDefaultParent() == child) {
                ldiv.style.background = (Dialog.backdropColor == 'white') ? '#e6eff8' : '#505759';
                ldiv.style.fontWeight = (graph.isEnabled()) ? 'bold' : '';
                selectionLayer = child;
            } else {
                mxEvent.addListener(ldiv, 'click', function (evt) {
                    if (graph.isEnabled()) {
                        graph.setDefaultParent(defaultParent);
                        graph.view.setCurrentRoot(null);
                        refresh();
                    }
                });
            }

            listDiv.appendChild(ldiv);
        };

        // Cannot be moved or deleted
        for (var i = layerCount - 1; i >= 0; i--) {
            (mxUtils.bind(this, function (child) {
                addLayer(i, graph.convertValueToString(child) ||
                    mxResources.get('background'), child, child);
            }))(graph.model.getChildAt(graph.model.root, i));
        }

        var label = graph.convertValueToString(selectionLayer) || mxResources.get('background');
        removeLink.setAttribute('title', mxResources.get('removeIt', [label]));
        duplicateLink.setAttribute('title', mxResources.get('duplicateIt', [label]));
        dataLink.setAttribute('title', mxResources.get('editData'));

        if (graph.isSelectionEmpty()) {
            insertLink.className = 'geButton mxDisabled';
        }
    };

    refresh();
    graph.model.addListener(mxEvent.CHANGE, function () {
        refresh();
    });

    graph.selectionModel.addListener(mxEvent.CHANGE, function () {
        if (graph.isSelectionEmpty()) {
            insertLink.className = 'geButton mxDisabled';
        } else {
            insertLink.className = 'geButton';
        }
    });

    this.window = new mxWindow(mxResources.get('layers'), div, x, y, w, h, true, true);
    this.window.minimumSize = new mxRectangle(0, 0, 120, 120);
    this.window.destroyOnClose = false;
    this.window.setMaximizable(false);
    this.window.setResizable(true);
    this.window.setClosable(true);
    this.window.setVisible(true);

    this.window.addListener(mxEvent.SHOW, mxUtils.bind(this, function () {
        this.window.fit();
    }));

    // Make refresh available via instance
    this.refreshLayers = refresh;

    this.window.setLocation = function (x, y) {
        var iw = window.innerWidth || document.body.clientWidth || document.documentElement.clientWidth;
        var ih = window.innerHeight || document.body.clientHeight || document.documentElement.clientHeight;

        x = Math.max(0, Math.min(x, iw - this.table.clientWidth));
        y = Math.max(0, Math.min(y, ih - this.table.clientHeight - 48));

        if (this.getX() != x || this.getY() != y) {
            mxWindow.prototype.setLocation.apply(this, arguments);
        }
    };

    var resizeListener = mxUtils.bind(this, function () {
        var x = this.window.getX();
        var y = this.window.getY();

        this.window.setLocation(x, y);
    });

    mxEvent.addListener(window, 'resize', resizeListener);

    this.destroy = function () {
        mxEvent.removeListener(window, 'resize', resizeListener);
        this.window.destroy();
    }
};

(function () {
    /**
     * Download from following URL as TSV and convert using https://jgraph.github.io/drawio-tools/tools/convert.html:
     * https://docs.google.com/spreadsheets/d/1sAL1zn-UtmJtKPH4cLApGjRX-TRSJa5dYdfZ9NKYfRs
     * Maps package and stencil names to additional tags.
     */
    Sidebar.prototype.tagIndex = '5V1dV+M6sv01rDvngax0oLvveYQEaGaAziE0PW8sxVYSDbblI9uk6V9/VVWS7ST+kB0zL3etbmIn3ltlfZRKUqkU/rpRLN6MmFJym5yM/8QL/Xnw7yLceXQ03fA3JaOTyfjCQCKZehvu66tErCMW6J9E1M4jlJcFTJWIPP1VIKK1ixj/zML4VBRiTMaf9HOKx8G7/lwy71V/ZJEv8Vv8cKea9KW646tU41nk678/4tK7SZVu5FpC9oz/TDPVnkEPJlsn4wVma1lEnVemGByy6q+M+SXkSmaQ6Vv27gJeBDzyOQDMu1ma5FVEEVBEtuokgQhdyZ62Uv/9qWWoYPRltgx4A3U970/hc6BnIuD+kdI+KbGTcelGce6ec4evOBl/k0r8llGKtWBTvulF98xVKjzEvxWXDVS/M8VHF57Hk0TDpzpxJQGScC9TIoX3euXvVV/UcWWpDFkqsCYyfaM/1ly36vGfgVhv0oiasyfh7ypgyaaBaKHl5/nThqb5VeAvZEigXx8k0AolJJUkVjo7jGBOHFOm29Se3FZin6VsyRL42V+2U90z9crTOGAeIEK8Q1UCnMlGxk4CLWb/gsflKt0y/MLnbzyQccgjaIivAjgTT/Gtr4Quf9cXXWRLjRKxyRwvkBko75hHnjisPzUkP/kyESnHtwoAtQ7kkrehL7UyzUAtLrh6E5g7Nnn9iYo2SWW8ZVr1QYsTIW8gE+ll5kHWQlXGdr/Qug1Zl/RDe2O4FL+fWPBaiJSUZGoDT6HRYT3DN9Gdgy4agY3Q59gj+iIOdAOB/MmYYlHKqYp5PMLaFHMVirSSG2XYySnnZrGHNW19JdaZoiYxGV8LbGq+9DKsT0APT3Sk1ldzXaZszQvOpfzlkndUYodytAPDOEuxuocyEqlUmM+Jbm6HevkAq0sAW8+MB9BmQJs+8HQr1Wup3G2zL6uCetJZjXKofV7J+FLnUUWtxZyLTYa20FzpV1GxEgnVdxH4JOgyS0QECr4F3z3nEUHWUQfUjUi/ZUv7tjqTGaCkl0q6Wou0Ef9tdhslUBAn9Xq4GshZkG6gTmx0m8EqvuGoYzb4iwMYdDnVMcpbS2QM3TYB3mM0Sp71/0fuSVPf7lmki1d10DN3LE6x0/CKut+GuddVgGpRyFCtc/sZYS/Cm9FySdUj3sgIPlOZeZvWNAm1o0uTXH81UO3zZEEqQDkwD5q37t+zdAOqNe/RS/aJ6Tdi5purBt73xV930PiLapT8HTTXqz2Kh7JloQ26bIlVOtAl6dIY9uBPMhbeCdgtu/ZLJeEe1XdduTSPrpc6v9+TlIf64jakMpeQ9RumQFVr3YiV3vcb+eZyy9Viw4Ogl1p+nM2xmofSyNSdYgHjnSzA6m26fu+wTKtwYM30S1LXTkxPsYp0qp+nbu8yg271r4xnWM3/hoseBI+8qttygmLlSfLhZtmsS7CZUd1Kds295iT2m4dTh7aH0qLgF2QqGo5qVVdLtHiPvIp2mdDXinvvXtBgGhLRI4/1sJs09z5TqY6sRCNVqlU+2qxPDNuRuxm20MqLmqNOO3CqHRqxEGEclC3jNtATkMOLhFZpOynrH5FAc3UlcKRsbJHvy/9wD8iylUSFJHhrrfmRYBPaZCGDZ2Mu6QXolr3prFf16OdvsxOjqyqUVPXzVEngw+g2Qrur8WehCxWnqu71sE9gv/QWnrSalK00WglxllLFX+VXVaxv1TMae7yFcRrlV2059PNiNr2+wdxh60gmKamJ7trRDvIm4xsecYXqxI7z6sQ5pICWKDHp6jFiEyjpgtLioL1lU6MmSu3VHZm0QtcI1RVNeCPPjIeKHnuZLamxJzHnNIzdyIzsV2+DJm+Y22ZVlPINS35AxuFl1Bo4nQ5IJ7PIfxyW8xzGplLgaG9BGginPqsrUhn55RCZiLoxbRn4v4dAbkYubdBLFkWoRfXYs24CvPz8lGzpNZchT1XDzN8OSEkcF8ZBhnP+1cq2jJgddJORxMmOmMX7w5A96HXzILoS882Mr/IBWqAHTcjxejheKQPvJRo3kWNuP0g0msMlzn6upFoK36/o6A6R34t5fG0RKMGiNdXSwyFVJX4R6mwE9Y+GsodSb1gcv7cCTRUWmCEx1rI2SAbsPvY2+m9QmTl7mCeBdrAdKeMnTGC24X4ylMvU3qWtzY2Yf5/QdB+kwyKPB1i9agqkwEqZJqm+HLULWY27rx0Q72mUWoass8VjGOIQHihN0cRKenQVagMsqEtZ40YXPq4geB2yGWCXNjHdvWUBLwzZJqO0hL+TVEJ2va5urbACZWbCVYXEuLKywZep5bhnERlBRuANDHRa5c1HgwZlFJY2kWnipFFzIUE+znKy+EtINIQLcbvWDo8tdUmlOANNl1A7/85EXGmvHeBG00tYB81LS0AuLBVnVATUY8Ryv9DreSbjX5/Gw7BN6qTSVmRHniapOrKd1UqFa33dmLRcn4eiO68TzJgwXYga5OrAdj+l/P+s/3w5u4BXnkOdFpGwo5wOb+7Cf+7CX/0GtfRfzjCN8YfJX05g2BeQMAv9mxwCtgIWyOwr5L/o7pR+6SJ3Fe/5QLwwr4C6BIv1fKyzpToXHJTbLiG8/GQotrMJyTgA31zp7sYz07uavDfhI0+ET93fNFPKrlqZnmkCBaS85u7Qkeu8E9ciU7jYt/Oin4Cirkdwp8G3qlPh7jTYKupVrjsR5kytjqzkeYIFXRodnI/DcJL3VsvKmexWjgEoQCsdT/N5gLf5grrxeJ6vHTm4gO6UlxdM9fCJr5VdTooZGIdRDXwVSKniAK23gL3Xr/TsPT66RK06s+5MS1xeX2UqEqZDcGRYCDPKrMfWwKV89WhCtCt0umFC9cHJWKCO87lZ93ND0Yx1Ilesax5NH5/A6H4+Kc+ulmZcK+SoYJnx5BWnwRUNUOzoqJMouyS0VN6PSOkRm10jTnAgsGXKVzQTWkNVwXMVcD3cwHzgiccCc+0iwrV+eIB8vYYrzXPHQmiE1ZMQ1dCqZe8YRowhM391K5bkoGWFgTnpJC0cvypov69W1PHZKu61VvUKlrlgOFehv8dRqYiSVFVPrFeh9R+a6FKwUKF/2DYN5EtABZqrc/t6ZBF2b+Aky+I4EDDf0hE76YPlKyXWsFCNdaYrfEHqwDPaoVMBPZl25/OkuXfYh1AuGViPJI2HzBH4syPx50fiP/fFS0ErkVp1KFpUCxjqH1AdWqWlSspDr9t9mp8sRe05lZKcAbbwhWfvXCT5uaMGgh6KpJLW1xfoBw3LaFijA7pLbA/dLBaAHq0vExEoc+vIsCVvS8dsgKfzHs2zF5UcNegfdc9XQw7LtzEBEfnVuw5qsk9o/ZpU+TG0Qy5lmqJsZZKl/bKVR1cmoRI9kMKywhvIGYGrFIq+bi/73BQ0hZ97urenL6JXo5mqakobbtIVV66p/w8gNxay1cYALkHB9QnaBuTxx//OCudewXQalev3OcXoIopkah29PmH7C415oHVru0dODdPkGKapDAJyVt7oUe06YBVuotXIfZ+gJPdtaYfWuto0odAH8LSEDeELJ+eFgmTOYjMjHzutTu3jF0WpG5cTsOdrF/oO4OA7ZEqfB4GIEzsLWN3o6/CT3nipaAhKotcVWg06C0PjypdFnnW8zKDa16wc7zM8ads4WfHympGqW4QkbMBZ9BJqM5HWi99YkIFBog0Hzio7lkrk6FpEIqHNUzdS+rD2lUqc/dJZEPYVaHSDy8bczBP5mZ0nMo6LJDO2Kt7crnZYv2dpIkqO4Lj+UwiaZGA0N9XXHbZnPaKg7UVm+cmsVbpgLwQqTBDlK2QRjYqU9WGg36q1rR4EKSmgVoQS93g0qWbzMLnj/zKeThc2Ny9xdcxvW89tJ4FBZ+TrYS822IEJJ+OfG7MBproKdaU+lm6ha0k6VD5Wkg2Rn63EH5QRvWjn4LGOw95S7TY+lo3TH5bgr0x4r7qHlmhA5xdL8inC2+X+qnIjibHk+hEt7HPJHmiPr5FDKwqa25qJBIaLoGOvda+c0H4n10rRyKPrgymjDoVVMM5x8qynOBbcSwY9gDZTfidm4q9hNigH6Zq7EjwAgaEWn4CdRLdtSHCS1yLr+oE6voukO1CwEDCn2jNsm2CDCNlvtAe2HK3BYr8H2yZ1uJHuZl7so7STbMGZwqkd6+yc2C8a0q/ngU2T1/pvyFPmk83Tn/jK+AeZjy7QxdUCkrSe3NbTqNgL40jzsEOzt6u1D9tkTG81GT/skQ2ayLenp/lHp2H3zgzG+tdOZtsNHX1oJuNi99VAhH9Z9NF0P6/LNDBfboa6fZhgGdkTPhmqg3Eaf+zelGaa70Uruxfjpw7m7dWUBlIMPOJLqqEnlbYw7m/rCMN8W4EIq3yU28lRr/00O6EP07B7pPtJPgO3BzSObqMkNTPyh4nQVpli6C+Kh7umeGXIdYrzyrTE4a54V+7GdziaNakWdy8rutDfP+5Q6uGXHqZnFasiznRQXfSQERvNwMTfZtcLB/4N88lR1Bd6tC6Wmg+3UpO1nNAGReekn+dT/fCb2QYDbrLizeyyPyxWZ8bSBMBkfKP5KJTH8MncwhpdhJEJPjKZR2kWM4anfp4/4AqMtort1M9HJXJkDjXvCa99fDR7j1goZ+Ci5eNlH6zuA1JT24fiScpErMTelfGWWtwxQgHFjjzCtuJuPPlabFdZTK9hY7OU1LD5pjsLmKV+V7LRWsksxq1hcNHhDR5nYFYqnRg0I1Y7DGhmMD12qaM7njEng52y6I//yONAG9BDsy/0hb98H4T2Hv7Q9t5BMyMPDTB4Nn9XzMNV9SGpaZMwKq/cRu6MBdc0PRqMupDoGiLfYQUGNXqIoSzglobh11Ll0aDyYCql7wahxgrlvX5sEk9cZ8huDzRQKtakbzDk+1FCGCwTPmIQ6tuLe/08bRLHSBvMs1uV8of6M2tpff8UM/Pjklg8LY7ij2R0alrmSxLrke4KNjZKlWGvuIKL9jaT+K844epjeCsbzgtnkPNwXuM/X3fC4BwyjB44eY2kUW1gqzKElvowWzyKevTim5hHprYrSXGfbPU290OwgmbZRoHEXmVmBwR7emHQ9K589FG7k96B/hk0nQWuRNKy6Ee92NUl1NrCPFkWodFqXT7dWLX8EYuTjUw/LIFnGWQh/wD6BXjF5f1UsZTtMB/UxgsRVUy8uA9OYDJGlyEbZyNpS1HacBx90z06HU8knhzZ+GJAVIo1Vl/L92CjS6WtHnxx8r5FZ4xmPbZPYWNQQGbmEnRmuZ+BSxs5k2zBqQJpskiklWy1PIuQ4XrcZbGXdyOzpNmGIhLrhZhgucX6peINVyxIRreX0Gvda5tspRgFQCo8FlPjIwyemeTOGHtHJCIiCLF1sTgfj3fTib1jX+DJSDoQaa0feE+++5K/Z4mSnEGL3N11JS8SdE9HeEraqGfFD0fVEJwXKwldJ25PbrDKdG6T+y0F1RlOcDth5Q1LnHvED0S48Kx/2FCEsd33NxRhFplVkqLAB2obiywGV+ucayDaPEbVTg7QOnlfSrsfbDAhf+w3rmPInvWoA13OtB5XbLiyp9hIlxATesgqVVuZanqbKm6MJh1Y9lBCLL9k9Gl8cwW+HVN5dYJRLrKWiYZmurNPX2FH4z9mJNcfpaWJPKJ1YKpu6aZ3cv+m5HAb00cnVoSnzXdi39v8OjrjroXiW7JZiggXhh5ecLu4/2OIdA7Ih+C08S2Hz/Mi1Fqe56VEdMY8L6Zn4/H4j64J+gKCZEl0trLXXWAjGMsGJWQg26I8EcMmW9IrrmlhBZrg+JIlHLZJUsDSTda8UlJHNIXvj2Y5Dm0N7+NY9pee1o2LUIfB7vYSCPXf0b/4OxT2bsD8RsTjfKH/6Z9VXOcwfICpjK3rhMzX9DytZOyWPLfXrWCUPg9NPwImrq4cFDp2bgze3FOyVbYDpm9SprndbD67s+TRiPMDD27nJfk83rKrqZ7X5xQq0q9YDHNhWMhV5/fLowhZv+42gEJbG6qJssvEbZBSVOXSZTsKYuja+uiYEEIglnuoh940Z5eYnsnancUvHRghyGUuRsN2kzpsWYZVmcuVBAd9W77MgSF8cWI9JZs5sAeipm0DrrRhtrqDCGj+YStWogZxgwj9oEfBAkdsCZHMvHQ0uwCj1xdrQQeRMG1SSzqzI4JDRSpiZTWQ8TCDQIm6wsMEi66wv1qClVex6HKgZJe6zcRte5SqGO6zX6dWll1JmiVrIz2g68ZgQnab6IEXIcRmwh3ZYRxAHN5hGCfHMT5dGKlkiVuP1WAvj64TsOvFLGDWJOJAP/lY+rOPooctUXaFcG5CMCa1a0AHPB6LmSeMTZjfdEePpjmWiipzbiI1JJMhSCDb6SkZvNPUfwVnB0LYx541RzxuJ/k8hFT3ptWjI2OJC8b3RVLQnYF/CSf9GYYUlJRr45LCdn5cmnOM+J+nGctEOKfpC22h0DCFPGOcUCZPT0PubViEX01O6XyqRR4tbFvn7ONCdyczP8nnzoqrvnzzLNmUx3kP0PNFsKof4FFvGGqlYWNjR/bvu+xaITXs0W3mplMCaGSq9dDgslfw95VecO/809fRxfT0YkqMuRWRmxYdiWa1RIXZ4s43G5IMY9p07mxL6Mn4UtAY33ZVfdkuC2NpZQ2orngTjbcXfnaxl7EVNqU7WUX1OZLvoBYVfDWmbgulWK24yneHH1cVriJPvce4Kh95HZSwgX8Tx5T8neyLftHFIDycVUHfSFbhqFqHRluMTCF73Rk7urVIY0gLE+jEreOr5DkbiOfzMTy0c16rX25fTSgzM38k16QXl41tRaVVG+mqHQ9Kj2tRjO4N49KlY/vbrXN4V1f3WuAjOGZmozND0lk84L9yZ3zmzFEzTpQwu8YD2B2viUbXWWKDSOkmchQHFhbnzo2qkgRHQ8tEBty9dVYSnR8lzW0QZLBgZ46HuswCmA8R9ltgtcHh8HNJD3RKA4PMUdZbLlFOtrvUhnEyICPSHGYAsR3mR598eOA4RDUx91qTOIbeVNIBkpDJiqcJlB1dnsAJOg2hOSqwoxkt5cC8PixAfV9cX8Gqx8PJzjAM7N5oP9h+T2rYzFYabfWizslupwMJu8s4qIywhoDnZ+gK/DqkqPM94mMlfji1sFJxfTppGJD3YpwMzng2OOP54IyfB2f8cgzjvK6saydCejFOBmc8G5zxfHDGz4MzfunPCEXQt3+YDK4TahiP0Ak1jEfohBrGI3RCDeMROqGG8QidMBlcJ9QwHqETahiP0Ak1jEfohBrGI3RCDWMfnSDjVL6Y+cxIeMnoK67frkNzxEEetjrhb7XHe/VlzX35Z/NSCj73REj+FIdndDml9mfNO0Si1lGgL+nuK5gEjn+Du6vZ3iiMhyK1J7EeLjJ0IJ0MTApUp8xL0fUFY+1PIThD4lH4kcAc0ZZ7fsEUO87W7k3yOaX2XX9x6sksJg8y+L2461euSImrmyKhGTR4ZOeLfsTzjUylzdYYbqqzuZbvRY8OMSAUjkF3l2M7rL3GgfcSMN/nCg7P1gX0PUvjzEbVbDt124lo0ptoAFl6SwF7LF4S3QbMsrY0LjilL47hGt08fS+aQ3tDMPNvaYbHaMjVCm4278rUQudkb2+mtp+2Z3RgWoYf/YJS812Jv/v7mYQmH57QA7rd3d5cFu+VZMFuaksRSzpcr7Lp9ktr8l9M6+y/mNb5x6Y1f5j/18prJ60PLq+dtD64vHbS+uDyAhVlI6M799fdE5h8YAK31gsPt6BVaZt6RsUp69DTk3fr9ROx1h3yS5LHHaarfvARrtguLAODtUQzBeyZU8d6kM5KpOZkDlwuH5J18iGsZwOxPmOw7TcZpG2xuxs4cH33aI5Jd5J0A/u0wKZ8oZC56GjUdHaNAwVZp8aD2xqnlQ7dlXy5uknqlI8rfmfa4p+V00n/cZ2kaqGdDEA7r5a267C7hbLPjMiWvXFYo0Y/ZnPdiBUy+ToCJYpL0l6tk/j+06MLbE6e4m3OCmUMBlbBmIwYySAVIUXwCUXkNy1blzguKWaN4jE6VDljtma3rNJVX2ak5eHgFEcCGB0nG3TrWcrDQ+wrQdSQmIkm0+0tpXzFpGTTidwVMBCtiEwAsXob3RfLWCX4ypxyl0oZVL1mDXTKAh75Jk66e3WYbjBMgC8SL0vqzqOpBO7WH5vDDkAZ6haFYTV80TxG3EGhkULjQpwqMUeO68F4KirOKKgkwXBn/2FvzDVZc9pEc2C+SiA3Pgq6yskW3VGGFYeCeDJ2blwWhh1SQRGzpMmTZIdgizN+NtQNGoLctdpe2WPnJ+N/XIVx+o67L/O4wYoztyZe5jFhh4EpiyoZ6kje0SLH+OEmmkWxpN90tkyJ4zpgyWbHhcM19WsZkH6Ras0i8du55AloXNdaztzYgSmjVSMTb53tH+BUg7xhGZYONOBme6EMCujYxrX+rN3BeYD6xunkoQ3XlnTdTqBDlETN0hSK5ABzV3IzOXRyoYOyyjWjlS7C4Gzl2KFuctjgTfkpR62bf3bRrzgai5lv1GzlwbDVWPlKbkk35kykmnDxNfh7Eyk+b73cNsoi+HsbRY71qHcpDnlyBic7MhgeB3Q5TsmbJMsckqeTLbVSk+tI5EHclWjjK84IzRcv3ASRtGEiPyEv+h/61AUTSdPlpplatvIkMKP6LPiW06Ed6OhY1wfKmLYftpG+gY7Fc4RyhcXwxBznF3yQ2LXoERXmbJgl6LsIFIGoOEPugOC7tnWi/CywOxNXSxuzuPakZB7BoTLnqxhxGxNtsOAVRmUdSnF0fvb2MtDBzKimE2/MA2mNB7qTEI8873ZXiid0El/MsdYrniqHt38sni8oclZHCnqsvxCLcqZV5+t+fnro/r7m5ryWStYNhRnMYvM+Tnm60EOFmFThlPqfZeZcvRe6EzZntaWkS0wsOJ8spTa4HjHk+6Ibt48fQlPMCVXtlFkLkvG2iMbZYpnXMBwMWHzFas7yPYRn2FSxmTraXlU05nQ71NwNh5Uc4uTB2MANp7Sh5+EmdN03vFN026Vw7ud/xJ2r5Q8KdgOHyTIb+oN5bt1bHpGwXf/vNj8HUrMgLTPqDioiQ1eBf7KAoiFR2zLDcwecuIa+t7TluwWGYR+m9rzA4ghBJ5iZsdwJqknTOi4mHXJ0HtARirSFPaHPBXL1KyZjxYJaSwJh5izfLind6Vpr9KPN18QcHuVG8GizwuetHvkllLGJuoi6sGeG/eObVOI3NJkAhoY154U58DxDm/F6suBsH7TdDa8wy2tA3fQ6YlC9NOXTGgF0TuGI+bD1SyTEX3M0aAXOM1NHtJU7n0ZywCkYmwWjBz30PNV21NvJzuSeO0EfLBzLSaFI8HQybXkJbo+4tZ/tLMW0krl0QcGMLniY2CkXc+kC1c9lJPUyS1OcetH6+4SiDIMPmf4dGpT+0lgaIX3TQmvUXIL7tS5MjYlzg7gjwTfSQF3xN9z0aDhTy1PUXKarOmnpnCoJzWDUmgLFgLBZGF0hcDmELWGhtiVWVYyHIcbCnNNabPDKOwolTaRtHq1FxLnabcBlpslwVCMGezrNyo69hvxMhe7NKq2yCuzowiK1zpsqmSSnl5yFGAIM7kBRVJ1H68B2DYvgp5cBwwNf58z3A5yua4hje1NQxjHTqlC3Bed2VIAx6JNYZTRNUNy1A2UYw6GIJmxFftcFSGvDF8JELCgYOq0S75NO7UvgzpwS72R8qv8/ZWop8DTbmR5fknemaluT2kvj5fRFJLLje6ss2UCcubWuqSZOMX53Uj4XDH+0nxTziHBunKMpfIOWCGTtjU0KwgfbJPYIawXWuUKzqHiBn+9NQxjAUFssWiW8m2z0WSihRldm5Q/ElaZpXEz/6FMhmihnSOm+CF/mw3DTbBjZdrj6CLXi3E5041VrkdJWbsdN3SXA6E78nQk8jJVwWuBLIXHTLNl9S9Ec04PI8pHWKvfRbYEEcvuS8CixfoyRS1PbcJa+8F+wBL2m181vTnDqPM0v3FlG1+IX+QKnipndmk/ZksMe4W/ANBlflVJJs2W7StlP4oAHehqJJ3NiUn8MSXwN4xO/eAtQGNcsGjSN/bzqTf4DMn7D4rLAvbO91851AIa6CmB9wgvHx0e30ekd9TiPUo9cwMH+3uBFFLT571cSLcAO8roTkUFVIjoWj5N7XieKjDzA4dPtYd3b+jiPZCB+xaTSDirhaBFZnWFuWhNLdP3Sb/diemM6EMb2ms3QNzgeGsc+dOUKGM1ktsSZMgjAqTjuIn5idqksZYIGnp6A8MItr205EY/N+dkKcxzX0bLo3kLK9I8hiEr5BNFrh+KEfgwopR5JhgOTPkq5+gBK/QFjy4GFftODSX9ILqqJg5X/TGjj1R8yV3cYSdoPqRDXLMCAGUNSBtJGzhgsO/Y4jyg+xbxXE4/UhoiespQF77gOa0e7eWi0s/FkrD9WNG0CW882fBvwlNxvvFfyzRgorU/HptUVBG6zdODOGk83i2jQkJ/09x4uccbM/F6NH7EINuHhNEZktuOlMlO0SkxXYfnHZpoRBlaYybU5t2wpfL9lQyThV1L6NUm34kZThkF9C91FPjq0dLTEeyeea4Zle02yhLzFiaaEfORJyjLFIrtJa9XA0Uow6UZAnjseLcPmbjwh94VHlsZGJvFhyLlaFp2fuFnzDo/N8PQNxE4Sv5tiJNcw3WJ05d/Mzi2K0n03poX0KACac1zyGqKn2QyqF6wS7MV+zr3Ffc5W5pn9sNl7vLq9ZZrziinM8xgi12CwVt16W+ucAf8z04VDZ2xY+BrLXtdGBSPi9wrCaqp7RnE87+gFdANgfrM75R4c7dvjxeDKy9T7IFTkqpPoAXYQiJZlrB3kA4/TjEKfHyvEPMjQ8/9oogUz+xaPZ4rkdhWwV3hy27QQUIXFY31wI1PasqxWgZv0xJ31xJ13xv3QajQbpCI/82OJnMLpHwJG11x3p1i4shPunlAdMbY+mDQ74SadcT/xlUw/yfthJ12wCVtxPGJgw35XmVR1CLBmupkxBU53VCE5e4Jdu6a1N/jU1l1rz5B4AuZARroHljjTAMIHFadYVUBjqegcRrgofTqgIKykRANWm7VhSMLHsnbdtYLhX+yd4fYTuTUr3ZK8TFkk6wIn7BA84rk3y4CZBY38HByV/9CefZZqa1Lfl8YJ/XyCfkewgYfsgze+EV67KWnwCyZouIcpJvqubXp6Dx4JM7UHUTRkQsZPvlpZHKKVgpsUaIrDDQU11B6PcKoPHFdt7I03bXa7mAqW41X3yDo3lSmmJL/vwBFhASlaZ0jsXfm6MfThLpmtsXarWZdaWwJP3MEp9za1p9FUGY8NLHuHwdEZkWHpAMndYxfT4lC6Wk739fkD6OMCDguCJSBoA4IClZL1lcDRBKiPmgie8rc3xdFw+kwjeHIM+OwY8Pkx4M9dwLDLEephqUG/cXOaBJxi241gdIG+4kXW43VXMcosk0FYzgZhOR+E5fMgLF8GYfnan+USwwljIWfLACtK/kQvqslwVGfDUZ0PQTVlefBuPZhz8PpuYJkMwnI2CMv5kSxwXGOqMvSUXAmcQrK3XWhuFO41mYyfKrRZTYG1ki5oNfaSB2hC6bslXXbkMUtOTIXkCwSfOD/vaNHt0ykmoqEaniUbpOlZskEanyYLB3zLcLiXhOpJgh1RuSzNZBias2Fozoeh+TwMzZdhaL52pzEGUM0iQB1kRM61k/HD1QkeK5NuTjntucUb3rj/tprpZ8605QWTue7CtACZEpkVMuFND5kWP3MmIwfedJDpkq3XNBgIMnvlDFVLdMVZ0HaSDRPKa4knt0sAoRsm4wvsLhYye9Oj0RIfhHRISpdp4+kRO8y0lcR7L3nwnGCMOLdFAsNyFfA3490RiFWHF8OdweQFbLdrOSJxvmjOlJkv6jLjZBjmZqunZ7Og8kSzaixkPM4YUa53yfEfsR6TCvKKsRd7//4P';

    /**
     * To update this, go to https://test.draw.io/?dev=1&test=1&drawdev=1&demo=1&createindex=1 and convert
     * the contents of mxLog (<shapes>...</shapes>) using https://jgraph.github.io/drawio-tools/tools/convert.html
     */
    Sidebar.prototype.searchFileData = '7Z1rU+O4s/A/zVbNeQGVe8LLXLjtEiZ/HGDqeaNSHJHo4Fg+sj3Afvoj+RJiBWbOY3VIO5mtLSCB3fjXklrdrVb3X83hX82L15X3V6P2k8mQC/+v5uivRqN+WlNf1bvMd8Wc+4v07fvpxUlP/6J58Vfz/K9a/6/mMFzSgIXFl+o/DKM3j6X/VfpWc7R6XUgaLE+plOIlPO3rb2QkXtRnDpaReojmqK5+VA8ScZd6N3TGvIkIeZQ+1kxEkVht/EHf4wv9i0gE6t0wkuKZPfJ5tFTvNdbvDIUnZPIgzVryj/pNyvaSPl43Q12mL8+6ycuL0kQ37CnaL1GGkBNlgOWJ7vhieWBI98GhTLoB86NkzpGEDNUw2WIlE+8Aue4DhFC9ZmmoIfU8EUdKmcczj2Fga4Otr5ztPzGdYyCDm4o5GY7Z2DFGrFeea8l+SuFjgDrrFKA65betIZdu7FGJgqo4BTtnpan+jlfBCc+GitRRDdYZFFbjULASK4P6cyQawwTr2IE5SyoDcj5fsDm5YiiVvYX+uBWRu1Rkjnou6q0nJ6oRbJbHO7zdObV982HDgFYcLAsXbHOlYQADW2S4FlcXanE5HvPnTGL1Mm0GLCObvgjySN8OE049BCNTyj0kyw3MJnYiyQMkUGDxKUf9BQ8VFV7VbzFkU8lRbtSd8u5mQXeQKyH5v8KPqHcwQ1bge8geE1ewoLzpf0+mscS4X1sEQDImfbSCEKzTsAXDYodkJADGfgaGJt4NToYkYmA/E0P1IOEp9fmKejqaT6UZtnrinvfRkxSf0Rc+Ky8Bmr1ymR8xuYXZ2wVmAxtmvVYvcpbYBYqcI8YQDmfPWIwlNoYPMNENJ0DoxMAUC/Jd7xY0XGKHrVvDxu4zNsh6rV30ikqcMBYpL3i4JFdUO0byDRuueZ7atqX9h/k+85BjnrVsMcdChAwdpbGHWg/mrVAG+SJEzmm/uTjMdA73D1mvGf6itUXkeCLCt6mcFRWQ9abi+PQZ+8oEmLERnXmHjzll8/kb0aY8NtROcd6WOaFOUZ+EmJ8O8AGCjWUCOKR+mBzDD9QzeQzdltJtgdKKpyeGfXV2SqvahHEkuf/M/QV5pBFKDxR0RA1adI5otwNJe0HDiFyon7BhGlO4V9rfTjHVFzKVCL1Qg7Nd4iRkg/Mfnz/h00ZFl6xup43uWBjRWFI/wqeJmm3ItblBik4LtYtRv3qttJ+9VB5ZtHSpZKd9T32STyP+k5Exm3OX+/gms2ENlva8N7l9NdJLFnKKjtbQwiC0YcjDZIxv1Hfm673WeVM/rbDR96C22g36gaTcxwa6i2EeUjnn6tkX+CKhhr9T2rQo0jKiXPWnJ9KXDN86tj+9/wA5WhL1lOhYi8ObR9csYfUfoIscdqHO3jZIR4w+oeM82wWnXNEIp4IycEufHG/icvWEEb5wjOn/QGw952/YzUYoTPKI8fS4WZy+pQOmG6wXdMW9NzKR1FXPg294oUKom8hchhHpc+yhGRDYS+Yz9SDY1RPIXL5KfiTn89il6TPiZoYYX8UsEQZs6jVDV0GEMVJWdCEbc1hLp7tsooow4BH18I3sTiZxTotubHtQgccN2uvVKvb5v4mKwqeXd+ARXPtPTFkXIg7JiIeMok/7AaIO1BCrj0MHu4Po27X6ID/UsUcdsEFHvJPhTWLqHtqAercOD/0Pn/sMnVu/C9Kb2EeYtWeAQhjNY7paCfU7dIcEu1i0yVpVazZZvIFk6cfiwjay+SACGjn2DZ9JijCDeocjfcdcIef4VvJOkPX9U5J6wdiAwXKJNoHvrrFh7sIXvGWxRBlO38WY3saR5CiDN1DZqhuw330X5cDuQjt9jyMywekQte1LZW3hTpZUrqiLbmjbTfihnSzfwmSznS6Z+gt0zKZJBTG+d2zBFQHOOPMOHHxd44jcUH8R0wU6V9e8EtyDiDY7wuVqTjtM/uQuwvPdHQTqnFguEN6w3LrHBcE6HY2wce7CnpoKhDfWesXxzJevHem9p9RxKGIf37muMX0h9p/HJWOeu6Rckr6r1FPIdQlmdKdFve5XoeM7OtpBauDH6E1s6OZVmtKj7tMo1gk5VOJTYmBOUgb5dxxwhPHIHlTSUYY5poGasjcIkyF7wAM6phKf1QjNyKQb47MYzUJW1pNW4PPyoJXsLQuiGN8xJtg2mmFOvDgS2CA7UFGZDNLR39DNWLN8o+2MdXzx8uQhrFUBPWed2Mdn2oMFxDcg0Rnxu4BEZ65DGwUasnXokNMw9umKo8M0Yt22mPeS+jE6M7bTgl2WDwwjJFTuacCE8rlOB3T2hm8bMczYeq0BgYluI+lCBcIyyuGS+ovkhneE8wwKKpad8wpfPXzsYmQ1Awe2Y3vBVhRfZTKw+jgZ5Rgho3ltJX9tQ4nQdG9C+ScbkOg0bhMqPpJDxqsVukCXWRjHFnLC5kw9Paf4lCxU8CAjdZbiBWPRNTOXwXpxZqDo1qfpkNnafY56cs/Dd4BiZi+Uz+jOQO99HrJXbJhmpMR243yk6rGUfXsnxArfKjXMeYtaKB/holurPahkozWtp0tBYsNsA++mj2KF0fxrgRXyKXCim7UtqOEM6ROL3k4HXCzpv1SiSzCq1wxbt3TlrYx0SGOMjjZYND7HXLJVkrj8yGiAH7e01s1wL6jnpXuM+4wu2glWEGQDVre5d5bMQ5hWAz2VLyRdcHwBlS5U9lCGeUX9ucfII4+WOG+aQ93QzXn5YkkehBfRBcLszhawgirQ4jMnoCIQH9HiOxSGOkjMaP9hLCAjfKliYPmNGectuuQi6K3mVvgn18Ln/ya2BJ1znAdQRund0vGINTU59yN88xd+dImzEhi9c2hz+D3WTYZShCFGZKiklQwZ7WrNj/3t68VlpI7HA3KF0lvvgoVfctZISJZ1Eb4P8JmJXWDDyeBFZyjCrVqXM99lp+rphKSKGt/uA406pgufoasQYPa2Kj+Dc0zuqi3HFQE6DxYstS5HvY1dD2e/bDAPxyBFr5Csx/SR+/OVwsIGatbtLw8aCBmFp/1VsOQRoxgDiGCHGxmqRNldGawTQ4Y5oCGbUXwztw22RDNO7gs39g75CmJOKpSN/0I9fB3ooBIm30EjckNj38V+F7pdOpcnQx3SVYAxOcswGbq2qzTjxG4wtCE4nzjC4xrg3UVzLiTKGiSGsVs+vpKT+gLhiRRYd9MCJrr1aeapt6wXaFJT5IY/oXO9wYoi5aQeX80whnrB4vgZpw5pk6HSRZF8I84z16c12NerRdj3F9Tolq851tbm0pvrYZzShjK2HdwRlxEZcHz3/c3xtAf9iXE4wSKDGaV48ZeKCq9yMobV1pgwgbHrJesFe/7KpMsRtnsBXq8XyrV5EQKd0b91l6j8SWMOGi5RLtWtEqHl0z2KpPjWqHF6XLfVSjnphCMMcgMb/5qVDD1GfYz7a3FkO7ZT+FJ46GrsmYWubG0IzYhwKMEuEq0x/bnwKDZMsMLqGeYVVXro0uNzhENqsHZK947OWZUfg07fgtWhe4fEOJRQTVpySiH1oaL7TKaScnRHi9CRpWuXkcxoOAZU55lGGFGLW4xNFmHGqrYYIYnzwlcrjLzAe83fLNJ+OHZM223mH/pG8Z2MAy/TG/7EyN9KAePLHNxyTG1ZxyIScqZTAdA54cawWh9KvaPi88KLqE3bZTrhrs9dtJdVgU9pMtopRdmzwrT0bY3gAi32mWx9Yn6nfDgm87KECEcXOOXD4MU3vlBVRHNeofwcrIfoYDUKC7C6rBTKwpPgczkpoDXzKMoADPDx45140bYFOkxDH5dujZVjxj7GYLd5J8x66j5gIzTNCNskD4dyjwwwztgG7MJ0qM8jKt/IiKt3Qt2DEWmNY2DTyVEfowzFB85eAsHx9ckFK8G55o1nlCBNdjHG1jZG7DAW0hfklG1bx85h3hO5jJMDnOMIhlfEY7cNDusgOJvpmzYI12oH2Op3njn5O14F2DjPgE/nHI/NMY6nmTdqG1xTnCxIeiUgXaxnwIt1Rb3UVER6XQw8W0t3Aku0E/7Btd5wFOpKzBDW+jNNJutprEjVkhUMoYoyb6VYj2osMeYxmVdYrTGzw2WEYeHintO19tZzUnwBYeOUrnQ5+ndShBMXrsZSSjllvs/x3aUH3lyOwmXT8RVsjGAdQzPGR5whfLAKfjml+pAwuUxz8KhL6rEkNIgRFrh4iS4vFCK1iKDHVYg5uaTRkkmMtFAHjBFzl6d9jDlLUFM3J8Ru752VtvcSwiFdMUnRj2P5q4ublNjHsryXklIyzyOTZfq8qDhbUOZQyilWK4q+JIul6lGQQYwxuAlV7iullAJfWB50HM//m7noTn7N6Ejpk+4UUVs7CKu8mpERu6maXArHWPMK6gpmQjnGHzDo2lk8E90+Ex0iVJPQBFGXhcfetqJd+hQwRXQcdICgrseUeSzQthw+27xV9CItgrEGKTr73Ow5bbcs30HRdQcyCqLnhUbsSVvoSKE6ehmgbWygsHP33hlgA2xBpc8kgA98zgRJAwXYSI2dpWWnbx9pWiBmTF31HZ0924W64BJJ6idR2STZ+LRFHpeMIWwobjpj5VVvEbjP5YyiC0GbpU7PytuBW7iBRzHaS+bl0vL+yyfE6Owms/1Tu3yA4RNkdBbUGViI8xNidJYUnM/6CTE6kwrs7uVnxB10xMVZbeMXfILcxYZsJrO2yh89GcirWayQXXQWF9gFeRPYd5cCY9cHsFPwD3nR7cZgVRc/5sW3FUPldHzMi28jBjuSK/IOuPvmYnSYdrQNZ7wIFRbU1eNPgPFpLLCzgo+Bsaus8g16PgHGp7MMYOg1jM93MFowQVmVgzhEr7DgNLSCxa6sGmDKSsFiV1TN0jf9PoBFp6R6xQiHzUFnkXZ40P1zP4BFt2hNLx9sImta9KsWcmjRrVqw6+YfwN4IF1/1VeP8COp4QRdymbM5ueKL5QtF10kYrJGcgX3BJL62yWYvCSj/QCc1RjJGOKkNjQUVd74Q8tlD2BYRrNGlwXtJEboHYG0JPoBFZ2nsKp9Bw+IzNHZ0Cqph0RkaOxvZpOOwrre18S42eHNHgopJXlE5E/hCzlD1t0xa5nFXBAjv+ZgOUvn2VSYyTnOys6NDlL8ZC/DtwGY0EmpwE1p0WzDcRaAi7Y2aytFSxCHGM6MdzecNZnTjbLZpg2Iei0D5wdiHGCzJLsVFN7q7OkFJ2pIkp0bIicv3qDOIJ1Q9C/W8N+LEsxWTCzXcj5IhjAIYoS0oAegLclSNOkkqziCnLt+exaB2XCEw4hrZDWC4jEZkwDx0sZ7ejhJnFTCZ6KRKbMC7SjB0lrwCtjWUZ5zQ4tuVd3TUP6U+uu3I9InbUGGAKX3F17lwR7vQVLyQPsIAgMELduIwldSNUKZBG2UVoIyrHBi7qgI7KNVVNhF2RmvvyMxIcdGNrtk1AOqINMXFd9Kyo5zgFBdrhx6wEhtb0Ct8C9g0JAF3pBW+9WtmBMNN6Nh9Rji4Z7saXI2LfXTL9xL+EBefdjYqNoAZzwkuupPwXWUFp7j4cvmNjG+owHuKi+4ScHdXLn6Ci+4CsKmqoDTzvc9+Mp/cCYq9dClYgO6BLbm+jYMzp9KAtvF/fzLvtC9l0vqQXHj6jBRdc4mtGl82FlYGLF7IOQ3RRdjNbEqb/eid9PYcHSegZt7gVOsXXY+xHmDO6AbqIzZOyLyNd04H39TdDaeIj2XqOkcydR8Zwv0FqptwRjqgiwVd4Du3NbZRW4NhgPBMzxxKWytwQOWMSd3nMECHWtRDdtdZE1ZG4+iNONRDGCruQMMK8Uz6/lzvMcqP40jH2NDBtktWX3q8U59E0VWFN25f2JUmS1HDJUefHmV15pFg6j7CwyXCbD8zvcKqEmqCGkvJfPeNnL+6S+oj3GCNsbW1I4ZxqB4GXeTB3GNtouEacyRe/DCiXKIntR3QkeT+cxJTErFSwhzdNpvZhHBaeJQF0aYixqeKi7DWqvjcYz91GjI2zo65tdraTuehegKMpHCNkAxQonUUOlpDO1nP3zXtPT5D2NharadwLNG11OmBtXjIGF85vlCL4dDY7qhXymxwY3SYbbAG5zmniBg6n808cgOBJNf+k5ArnAlrRpEaW417vVpx9fZRoL6PKsLsLeBQ9yYsutytNvApoy6ihS/O0gXMLU0pwyiJF2rXDXvGh0UX6ZR2HIcsXqGjBLzDoilvBZlQ+YyxsztwlDDDxKd5u4Bl3zZB0Wld6C1mIrgfke9PylxSn4b/UNV+CmPUu5BlZhJINZLqg7BhdoE9U33Uhi/Ya4yl7R7q4AxpA+fSTbmy/iKs3Qd70H54hjuJpbukITpe6Dk8jX0fX9wBOlB2HyA9fjLWaonRXLjB6YwvyJxG9HTAF/+J2W9St1vNXvdipN5X/4M5V8+1+btOr3ne/1IZ1BtFO6JeL6GxClIYeiKek5H68ckTL39kkcrCo7M/okhFEUj26/OPo5KFcP/IYq42/JkTH/kK0fOBOFE8578+Ojt4QVwyX6y4+2t74VCl4IpVEEfstB8E5Nxf/M7oP3QxpOrhIvZd/XjHPSWG6fc/00KLIsnvYvKPMDaF8T2I+Ir/y+bku/NHJIlI7tiCK5DjdMpycVxO7o+Sf85+Mk8EahpEQnhhtptM9c/kSUgyES9MOkvm/ToGc6zieeBhTL1jtklNCY1Y4Im3lfpQMqY+XfzmYP5QxcJeI0nD04EXM3LFXuniNwk2By4H5bAwyV1yOZxUWwwlTvw3xSDEwmMk8+g9GuksnUoJpG6eZ+xAIMQT7nNcqQhYo1m8atQoGSnPxDKRbM4Tf470J9dVEgSY4uBz9f/n0Ruh/pyEzI2lenE6YG/Cnw+FrNTsqDd6uxTKe7CU3IgwJGr2/NR/92f2fCio6/642jIpqXJ/KZP8d/0XKpmaQeL1OP3BXwlpvT852ft/JLSWUC4S8g97I+c6+9hlq98lEh2qiFZpLgrxGJU+9xfZ/MlSVMhN9vYf2bzL5kFNK5GkEnrqOZjvsqPdu7Yk9LeYhX+kkUvjlkaxpB65of4iposDmCcl9/MtyTgBY+6y+vKAmilJw1OPHrUhvCWUBx4etzx0TDIJT25GdJU4jvPk9BN5nPvzQOf3/xFKFtSexYvKh7JL7zNb0vgT4v9ILudSCn2cqusVV968h5osN2KxqLwwoGbIWPg8EvKPPDJ5OBF1n+eS//yjQlKB6F5Xx5mq47PoRSRXJzMTZDi6/SOIJLB/e5yZSluCOH9VH+cr1/96QvrzuWRhyCpuoJbcZbdEc8Ele6GeR+5i749MsjMN/XGu8H3mHmcYeksiN4LOifp06rvHaoJsyeQ2feOPMJITLiojnRL6Z+mYkrkTcVR1IxVKsSay+LPJZOdWMtIZoH/UyKZQJhU33UvOjlD59vpESt/RmlFlnGbyGPCFesM7TsfuM6HofCX9uz9S2ZSKE1C161Z8o4GWyX9u/shjUx7p+39kkshkwmTIw0jH0EY8PL4dWFL3+ZQG7ml/MiTOSlnw5H7ikHqtVjvRNUPIQ580jMtNnkEhdYPBjcf12JN+GQZUO4o3yatRXfdNndNwyebqVVKIZEnnuoBF8sIQ9VPyzxZxx8iTLlGU6xPgdsbaxsrahRvcbjtBrWNFLWNAJaguD11xOtRfSf2s1iYOk1xH/NTyUX8Wsbl+5yd3WfihS3ZoEmjUq4deek0X0Vv1ZPAV7XFKoHFWq+Dgg8z7xlm9guhlmrJ/gF7FJQ+E3j5W9OZZo3206K1t9KMg73ZqTdyYbYh9TGG2cGN2gUazgxuzXivrgBicZ7g5m/USNVY/4KwjX52NToneslucvWarRvpB4HE3yZQ/+S51YIStT0Z1MfPk99Q3U5PQiAJEH/edPmm3e+2TH6Q/p0HEf7L1TT/0EgBxOfrOnY4b1XHPexAXI0Nt4EaFHNWGmtdHA4vc4gAxrDJU5FZHr0Rt7E9QsW/I9TLdsT9kPVNKGCkk2CpVjB2kjPUW1KQ9q9VrSCEbTbCRPFP/H5yQnXaJ/sFbkIpnrmzBFx65S9KsNdEMqdFtFoJ1SKVyACSZ0KTPRHKHVl9oIo0aGuxdqKRPudtYsUHs4E+xO2iHG8SiGOqOA29hRFpqHxpnaxspMND8XgM3esqYIpd8QWc8IufRkklfjT1qGQBN9rUMWn9koGVwRLyddq15co6MuNWF9ws3iVvYiUFi75vEHezE9W4XGPkMN3CjAeEWbwDX1TrGynoGEZNfsxqOR6OWFJ2+mmChN8paNiAOXj6DbzYS+NFWKXI0+C3QeW7gt2rI8YG8zw/p6zXs9Dsd/PoxL/x68zjGfl2CdZ3881HjlsMyzq8nDmm11eJ2mB8KrHF9EP87O00nfVcNbUh0+xUp0EzoXQzuLXuNQ31sU1vfklxPbezH6YAC0KcJU3JBZ7r/gS5h4c/xnmABYjcaremEXJ4fI3qzMZmomX+s8NPx0cK3epP/HDH8ka74Zq3eQRaE2SXsUQSOc9hO63hg20c0sm0FOzki2rPOFCkmkH+VY94jH1VA3I5O1kUNCziFOzqtEzUsyPFdCtvVt9nrtRPHE/mpNBkuaRjyECk8zLWLTfpelei7wPStCsGX6gL4K/izCsE3ahDnud9vHVJvN2ttMo69iIdpoIwM4zASKybzsOHHPSPRyAJE22eiUMpveEOc77fn06JMjksG4z5xRleoJdBrFwQAkp+XCqDVbqUz4GRbBlL8TFqZ6PtpyASyNSXaEFkBqUiUFVQURKokEUpBJwwXFGUd4oR4snwLdZ2l96t5rfuPK2KhGX4Qs3Cb+0OVcOA1gf6vUji8gldlpNDCKgWQFXE/dEhbZ4bgtg9BtkPN2mm0eveTPLj+eYlmNOQgKz4lT6I61SEHWeWafNhokHEzOTc/7HOUDLZ2TLQt9LCA87iFf2gBaTvHRNuqwLIFpNVj28BNC2JfPfbPT9p1rDd7QfSwRuwcAWK3hRQRZFlqxG6zddAVE1LG7oEzPpyTxhnWuQq0HBVj+wgYO0fA2G0futJJII9A6/QOfSTZ7INadsSpd2tIsWFW6SfYTbTYOx3tzuFhz5nnneqrYWQiXpg8ny/YAR6BfER5eEccH1Ee3hFGQpkAEieSPEDKZzdX3wdwrBvRMHLuu54IY7PbFyLcssc0Jm+rgUbJFq+pNttAhG2shKWvoJuEnXrtFSdi+bvGW4wHP4o9rIRwg3iWPN1BIS6D06sJ6dQb7cv3ulybJQGQApeugZACJ4TOWxixFXGTvm3Yt8zSiQ0fAHerAFxvwQ1x2GlXgLi0kZsCX/tP3OcD6s/JxegO9fJtWI7tRIob5WUrTXWjNlY3Ox5Mhxwnsa3C2iTuHB1xr42SuNnZDfHoRqkGctlDggnmrG5hNhvKWT0Gzs7RcAZHwdnDPJ6lQ4IfcSIeT0jO9lFwtjFvK1CYzk2jWQvxcPZ2o4UUZhsxpuVo5jXMhmnmObnw2OtJvab+HSHhBTN3+Wx1ej0Yk7qO3T/0dctxLIhQrRvXiMoNP9FX1VBjlp66a8xuu0VuhJvO31B4jIypTxdoM1hL66Q18b1aoTQiE+qzd+h/eHSowE3sa7V0k8acsIOdsHS4LCecvyp/BSmctQ5S46b3E6x8pcPZG3xtHca+ekBKaL0AFWG3fbgD+NpU9isZt5DyWe8Qr81288D5Dnz8Onr8mkj5rDeIjA/r+EHwYZ6fEHxnWDcHALgu2k6AIHDtg9YsPbXyfqDJlYH2G16bZwfJJ9RXj53eskjSLAfoR/OkMUB2+xYq7lbAHU6a+hp5fzrs5+lPqKAN46behILuHh309KyGmNk0Y0v3r9uGrh0FapYnojUXUtDSG2yRM6DSJdPWSR33sELT5tsRGYt57GFJBdrNrrSmPtQKGAXaHy29G6EGhZnMPzrvoIc9jdMJfK5riAWSh/rCDvp9qHRk81PmNnrm8heyCtCHvxsd2z5UlR2o9GmLydnCzVk6BSPnjP3M7elU4xKIrV4yePMrTnmDyPPXQOpS7+kiJo1WQOo1cjk7xyIQ6PVclEeWZsX/ZXPSSrg/kczBi+MIIl0bsIkBuq6rd/hjPKIRHTJtkmXXpGb6mlTe9LiDhRzqDHODPF/O9Zpe3BlxtxEcAfJ/Rnebl+IuacRe6Buyi3E74M8jYI0TrIef1tZagRJLBvQubDX80UzIGasob5BiWjuOGjNtnEEaOg1a7b59KenbAfP+vwtnzdyt46kPsWvUJlpU20CtQr3gkpFpHW9qKYBCShh/NOqIGOu7YWxhYtzROLbwZtFCrccfrc5BMQZ8fkoXPKJKpYan/eynvxpDpWS5lKaLnjO5iYun3lDWRKR79twYQpiJKBKrjT/oZ/9lJAKTvABlXuIr45R+DEW+9X13KeR/HRLSUIowPBkwujoorBEP3b0Dlaks9xmQvrTFTtKg0ITO5x7bO16Z0jCf4V0mV9JQYEFOwyvm6UfZO1MTkOl6FTDPY/tXg5BQEyn2RHXWMKgacFTTWM64v/8lVVoRBgGVNIpDwjy2Uo8bno6pvxRmBHz3RHWjaWf+GgLJEe4zi7TJlN2hV89KbsW//349ZtOI/gFCxkEgZEQG2ihm0dePnzF84GA3bPHVUI327uZkRnWnPI59r7UGnPbIsZxnLvcwB4F0iH5EyZ/iBQtPh+uftQIZMZcmZ2ffHFeyl8QNEx6fE2epdrcv3wfqW8sOlFjZV8pVJk7A2Pzr2czRLKtTPmObMPkk1Pxlexu9nRPG6qO/3uLa+axcr739D+HOUVmiY5WxuRePe+dTVG0Uq9VBztF9bgtgoyZWSeqT8nrICeGhOB14ugi4XnsX1N87V+lB2+Iart/RbA/UjeMVmcSr4CAZybf1VN1D8OSLEEdc/Z2ki68PvH4R4Pl/K192D+HyL8Kb8DAS/qHSacfvYNmEjvQpLbqH0NiXIUZUvh0qXWJgHyqcDtqKCsPJxKsLyUJyf660yOkwfWffRB1oIGWlCAQaZAdcV3Q/Ts/uya5XAXWjQyT7m+5fI+4AK92rD41MR9WVH3eZvUnG1FXv7f1UC45yzD0viYDFnnoo/u8hqf9ttgPUmB9BHpzy1JAHqGJSrAc+k1Q/ZGXJ5pIrrtOR/rZvhtLZTpsQOo0r5vPkEucAw5kVDFTmTytr+Cd7Uy7MgHn71xL2bG96Z/7+k/nJyWr6crikq1kaYNax8yf9fvUn5xWjUVILPl4hgCnreWYwaehDDUy8IqnqUIM1jVczTw/gQSgTJ5D07TBQkmjH+zjpU8T3V2PxU49ZvtKqjPvE2FzzXiTf8wAdmdLZHlJe67UWzJLLqXT6pJD6sahHUsS9j9QOmMi3MVOPv4/QeNPAa++CLpuUD1TZ/PvfwG0HMNWS+0mkNGFKDxePIjXdwtOB2r3miXr8apQWlAZco0hGn6OlFPFi+eXLqAc0x3KYoUdXgTLnLzzqL5gyouLA20POZBtq7ay5hMLyw+Qy134nXM8e5UDGRM2xFdN30Vm4h2HZMQ75NmKR2o30Y56o3Uk8VXgH+gzx/DXw1IMeMKG+5Hpyx0IeRtRHEAXYMWCadH2I81btZvONCylfzdQAtp9yolG8Wr0prp97uJncBkaK1eB4X04BbQ5eifDrzXODouxVwjXEtZ8mu+15NKwH41o/qLvUa0VHJtJ4zLd35+PLdRu49/Ex4Xdl7KY/XvtELSx3Lwcn4LBrrOqTSP7EXUYm+h585Wnu2Dx2v34H6gJvqndxEMWS7WWGgbsjDvOeTtSC0Yem/oLcMY/RkKXBsK+36MwAbYkSO0U67jF/D1Oubq4d+3FSX5XeTg26L591sAvIiSTl/tePCnSIJefYU0okNM6DetLK29UPnL1oRXbp0TDct0tqvVIKNOTbja6RVekrCkt95s5eU0tU6iilP2d+uPeCWWUXj8kzErE2ryc8YCTJLzjPf/fVgGcwU9EEPPeUxye5m9BVeGM1uS74q76vrDW6WmNkGs9YuOcRNBddWd1ool5RLgPu73FqFotFlg1DbHHtZUbuSJEUp562MLiXzsq9K3/I8dpEvOC+r9bg8UBmF7b3zgqmRLdgPZG6leoX+8/73NWQJsGZg6VzAi6rfB39t3yFLX/vnFDDmExKovtKXEh9lIfLlCldbtLEvGMztTHu34Qp0fr3I5ykMkkyano2GoNG6l9NaVRKLnuj4f+PsnEUlM1DoUzjkhMdn0Dl8EIp0nT/Q6Y/z0oWBzThpkvun1xwb0XOf9JAyH0kvkFVIjbZ7k8+WHf73ieg2Iij/2qOMk5RFnLFXzXbtX9yw31GsrTssX73y5HOgKxPg8mJlD/k7okJyqLOmP7xlVO3B4wuLIYaC+2hTmj05WnZ5p5cGiWIV0F4OqQ/efS2n/pojWZRBZTcnzKQ9zJoCc3XG77GHOt0QXG+3sJtFHC6sDhfbsqCjo6+BYSipmDZ8H6KcUlDkpWB/OrRaACOhsbYqPq47/NbKzV2yajcy8xqd4vOQt2G4kpI/q/wo2y1f/mQtI1y73UrmopnrKYQEyZ1Hr6nnmDfUYSSvbNSjqSg3V5mlbmDdGAwvn5nNw0vu4nlxLOVsol5ksKwly2xSFOmQ+0mjRoRDBj1ntX8yvrZfHnoonhptGzAMGXYY+3ms7PiCrFSWQ/Zh+/JyzKz5WzmFTkhc+5vmvP7Nrfs/N+MZ11g+iBozt20lL1LHoU8EKQkg0ys6MJne7BgdsKkTf2DALl6m0saewcyLDf8f2I+J3/vo/PWDnDumMsDKdwkp+YwiNIYf1pU/iCI0i44VSfR1bnVqkmdmm/pMtp7agwIVUp0EI02trEOoLnGNpTeWw+J5/BWU/p4P5MbkYFH3aTt4EEBSrHQEWnNmJ6yHRJdwawgVW/wss1X8b4ZYd5sLjy9lOkR77r/XFKRlUWRt1mltaL5OxucacntDczqIxWHjD/t/6YKKJUyqd5cbx+3YHdLZQQrDpMuTLOSJlJvBGkX9aMB1cvxkX29tbJb3gmTK+qrhyfjZOYeGJ6+qR5LTtTOHs9me+hisFs8NR8PC013XeVPSdX8oSfCPfQA2DGVrjh0EExJ8eB87lUWSL2nDeJV2l8oPD1/jWSc1Hrel3djNDYue5j6C7I9eTm7Apswz1MW179J94I9FFqC6uayDaYDCWj6qEJjVbyr0BaWk72RtSoj397T4Q4YMs9yqCziTzUZmReeDui+61+Xvam1QUC+XTvfv3wowDmkZF7aUyj+8kQGIwG+dCzuY5r9DBDU5ZE1U+w/Z7XMkgynQfJge1cB1lyKR5lGESNT6j9/OY0xSl3LZTTUW09SO0+3d9JA6vtQ2RJM7v38vGs/UJ+ykW8DIfZ/plS2us//FfFgVtwvKG/YYv9lNuo1qIWoPC8dCEiK+aRHu8mPlzTcRzURY9cuW/Utp8zK2R2UCk12bJE0btxP6UGgO+E5z4WQLpufjCR90u0MRXIWON3HTTAj0/qsZKb1GiyWPnW/PO/diEIBUXz5zRAzmGar1JMLhuphvC8fkGbxBpitJ6JBroS3h6vrXViX6op6T2ml0ewO+0Pyi71vrd2SxZByrmtfl4nHodGKd2BsLdy/qfusttE5tgErec0qx/rHF+7ziYijvfj27TroqtpLbQ7jYk+vZ82QFvOn+7jrakaOSl5SymGSbh6D2HsmjoKhX1/9Hqqqdw6UhMpjmfRDx6EBGrbGge6rSvqLLKWi2otnT6umBWscrLMC9+KyAYdNEHX+tkZJdRhxgiWT+/ZtrJ2CPLiDQ43Zmmf7WCrAy14jIImVli07UkRZh54GNNxDkeXGjpgO6oSlSHWHoRnoGThSUsl1byNW9HHqtiZojqceZA/JeFt6G0TpZTR6O0Kh/3ogVCOuPw/JooImSs6FkCnDBgjkBfVCti8ms0dOvQGClDdzQDEXIWw9gwmP5rBl20eotF7s3XhWsgxggYE88mhJJtR93kfBA2CgtIrT3qIkzU4RxzJIr69gKEdjPxd9CyRls8SLJIn1UH0U/V1vsU9PyhZSXCNOV8p7kl+fimBGgS2XzztaYj2kO2tylzKWT9Rl5Nqfc32Fef8NrHuwqOd+mlEykMnp0dePZAfWCvwEL28smPVa2EeXS+CU109AM7qT/GAzPRT8etjGV8DuJdnLtH8blvbvJ2x3e5mjXzJszjOXe9A0XzRw06W+HuupLSOMvf1sGbsaRrH6+iDpmdEeHIjlIva89xYumxpT98LceyjY1gHNMSf863X/jkbMYSuOacTq9iPm8tAVp7OYe/OkIbcywnx3Sb4/PXEzM7HwIE/c84bC026e+t82a81OT1nAzUEYSfHMNn7zlPyz/s0jn+s+JKNGWYH8IjOmTJjV5FcqtCrwRfe9XSILxYS/ZD7TpVgH2TvYRWA2MWpCyED7yb4u8FUZMdRrxX4I3RIJIqYYxqN77NidYsCnTFDRpHaU1eSpcQ/1tdEQuwCM5M12iSxHUwBTprxUsVrFassiVyIO0avBeq2oB8tkR/1eCmQyPEZB3Pv8p+6XEL2hp28WWxK0S4R/U3o18IEe+DA5EA/UhqgzmajO2x6MyZhy/0k3HMYukDaUbfgbeXCfk77TqtWwC6RVnCCdEq73/0UgH5xNIZRF0Tsv0y/td7K4oUHqv6AWhGFBdkqkP/1OEGPqcj8S4RK9LIq32zqlzYlfyIK7UgRLYTZ7wScM85Jcac/ic2HgNym69reDfi8E0p8rVaEMrSGVc+wS6Rg21k6mBbkT+lduBeTxFTNEcn+rmCw+SZiXnnegPR2X+j5+SRiqs3xU7heSCBh9xi+JdtHkPNvFnIh93TnpOan8arYYwSeRXjEwX6aX6u8lol7lv0YvD2OGlLiL/zt5TOnMM/sD4ROEoT7L5H//VhBMrrhvdoHDJ4qOIYodaI17/LanMSF2YWk98DkTyuxcqZfYxdExWh6XDu59Lo5HNiMDKV62KsYglEYxfrELV7VKmypcZMtXT6cLnKbyWIl57LHwtF67PCcXQ3GOXRKme2axSj6WRLPebZFvIxY+q4/+LzL04jBxXdd/jl1C3aIeaYLPleYPLaELTwh5APIp0zj71/LRotCHy84Lj9wlGSdvY5dKrwOmbz+WygWX7EWfvTpM/uQuy+SiJtKLM/4v7OIx/LwyF+N+LZ6iVNCLo77jNeS8Ka2yqpBWMU168H3pgcsopl6uVd4lQ749OMNmrVZDv4ha9vd3UhnNlS5xk24Pua499xdJ2e8hdZe6iV/6e/QSMQ+nSmvdd4nk7CdDj4YhueAzyXRfNd9n3low2OVi6pfSQZNNuajn5LNY1y6rihgMDxlietwI9XnzivAbZw/t0me37/za6VtIEQeVmQSm71c6oLqMZ+mWsqCRMsXetNdX0zVJpuQqnmEXg6EqW6UtsG0xDPX7VZCBkQ9Z3sjYlkGeGHyZvlExSZQp//iZJI57Hoz7TlXmQNvYHUobCdtSSLOEKzATdqgVs8xQ5XJUZT5AXZfYlsXD5LYqUjBsxlZp3bBSX0/r7Qb+vM8zKHWYIHe6tZoOUnGG/nqAEQwv7x8k4N12rUZlSL512/UmetfZzEuyG/S+6+rmbxPBffQH6d1ihkX5PKSUfIj+zAcsSpIBO9iBjREuf9MhBR6N0QNDOfopsNMn7Tb+fattpGOX9uxT6jDpCy60IsMf1TCM957lFHfuSL1WmX27Z8CXtlRT+GkfO7BZ/bN88ldGPCbNHv4FbqT0lM+TTakf0G9cwDv1jwl2YNMKtQMeDBz0W7W5lFul80tSZMnos+67MhCv2NGN+4WWy3kg+dzsBIKPuQsVVEmZp47apysQUjDv1toN9VBHE8fUp4vKJTI07fzqIcUPXLTCm3ZWuALWPT6SC166bFCayIJdBrDBlOFodE0u1Bfs2MBm6RC/o31m1FAofWaSAicHp9rxws5t5O+17LaxlHuI3u0CSx3YoL73efRGzl8DWYH6OWauL4QAkmsD2MHBbuGl4LpTtBuRvvs/MZf4bZgzqGTmAv2QVeGWcgcqNXfNrvMrp5L64ZOQq+S6zHu65fQc/UGRUUPLdjI4J+P+HfpAjHmCYGnYOOMT9MjmzSBLl825JyMHfYU85UwXDRtL6vsB+tNAswqa5enYiEWVSAM1TJnyd4ZTahGdzAX6o+5mEdrOLR1Npth5jb3KMnln5Nz00XukxqUQy6Pfkb4iMxZz/HHVNuhyfhyNyQX3KmCfmhWd7SwTHWVKuhhgx64bzYssl/aFFMmtp3l1TvyNioSWCz3JV1drvR8EHqc+/mLehnlqmaSYp+tXZvRh8z2uqD9fMg998TQjAcDybOFqkhRjxQ5tnJ1Zbm1XpNlookeuQ+q26yF6q80wzMuXl82A0UcXujVQYB1J9FlEnEgyXZ0IO369VjwltUx0uf7uEOdmgJ3avEthF1y5Rp/NZNgoXbvUnuvJFH0Nsq0TYLtwuUJ+IHnMvCIJH7C519cTxb9axbojdgWiaqZbZqvXJmTk3GCHNvYyyxOR6yl6vWZOcTvn4+/B9xF24oZxtcBOk//D0F97bBWHuG6X2KKA0R/xG5mZ5QvLJsQ3/VsSCaK+Yec2D7jt9qsbvlhGL0x/JX30igzYXLkR/kL5H7qc1AT9uZ9ZYctuvo/76M92e8WAacNurMdD9MBt0LSd8Xm9jj8xEfa6/pjNeRXMbmPv6tmZJ2PGdK514FH8xwAtUNt7zMLl8W1bY6YekdQrcMMXrFBPyq07sT30f2CnNg4ALMNmYzHjHqtQpNQIotkdcI8d9IYZWJPSFPge/fw24ieW4YTxD/QjbBYqsHO5bvvD6hzbm3Wx7Xau22MrtnKrtmrqVyEKbuRjWU5xFoXCr8DdRyMpyW6nVtQvQj5nBx+6wTp2fkOxWW5dt+w1DitxHQ56kWvuhq6/ckFnOi3p/DVi/hz/qge+AJoKol2BCbAT8G4FwMEqiyfc392Ioe82ZgRbLK2377dOvQrFtcwr7XYhpu9B8mGkv1J26xPHr9mMzENLeybHT64BBkKi39i7oPlpk/6I1LEjG0XFLOMOGrmBHrlotFsGzyfKaCXXLv5ucMZZt+UeNhmgD7iYlb4tx3lIHPEUvVCJPvoA1iIzB08aYmKnNk967eJrkxH6Oh3d4klvbpyXJh7jz7tsFJFtN2gpIuGKzEDxqnAEaihxywpjkx8X2IHN+/l2BvkdjdgqRl8yELZ83h0LGK3AHU9jqC1LROpSaizve1eZC2/mdLcc+Ymj/sXODJtKnrXERJ+IaaQtWQaR80agWYNH7PCGgrN0wRwWkakIqlAMtl4HVXKOg95mM7sR2plsjnNDpkyuuF8Fa828vW3ncjtT9FffjHNvy5vLDv47ImDdxFLgimQrGfVALQ8CnQf8oSRQg3zKPObq627KKK9E6LBTdLstQysaX9cBZRVI5Kk3jQVuFx+fqudDP9qweVvTCanAJQIjlmbpd6UHXlQ/Hm5so4q5pSKfyth9xo68taItlVksJUN/sFnvGJV9Lef3A3Zgo3K35SDfD+7O6uhzF4Czc+7HlxVpjAUNfmwhswcae+hVGKzP8VC5siqWJonuRTwUyuL2I3l8oZMHB/2Shh3ux/6RXRl4vMbfBK1XJD4rP8RizlZps/FgKXwWng7pzGNJCVv8XYOKE71Z/gh7WwrM88hE/4xdCE2wup5bQrig+E9BGsbhV3ntvoV/JUQUVGEKmMfdgNrgelKNVWBsARZ2+5YIsvu/WYf2igqkByqQKuwNxQTsRvnzoy3+ZPxPniqgHGudnSmGSiyCHSrGu4tq2EhGER+LLIEtEegk5mrsj1DVPwImAo+d9v25FAvmizgkEybDChy7FaPz5XMfMwmMqUsexYriBy9uA/Va6X1gTe5Xg9xU/vV2afcoQ58M9c1q/NxFpV9vlXYJMu672Pd1K90KwBsNN89KH1Zk6A6Pki7ClZjxRh7kWWmTN4eP1GZXkYFvFLf58vVWTfZKjDwYvdSp3jI8VftE5W4Ylz+ZzKn703HSNxx/2thO0Kd0kWf5V0MKYDdacikMpKBzl4ZRRQQA1jY+F0BeOj9Pgq+kGOxXwyVf0BmP8tWQL45KSsN+Ulz3R9VEt58I1xOS5FgqL/+tmjIofzl9LQNneF0RdjN9pfylzhy+GPyuhhTOjKJa1grgdnheEXRwBXDLoidPvFQF3yg6U9oDzPHzujP5VcCqyMGouFQ6ISKXQ0WwoWd/ik2ufTKIuTevQJtX445cnqJsL4NHHi2Jwz3uCj+zC7HLwsjEL381NBfFkXsFTkArA19vQlXBXtNHQuoCTdXgNw58yqf15vjT0dHGhh7EES/6R/pTOYD+IqpKUAzcBnzkUkmgMt6PGf4ofeAZMjeWPHo7HepMb04ulBxeqIe+IkTLSO8vHRV9F4B+qXyA9CV2fnMClF4Aa/6qjLzZdNB+6l/SiD0zFuBf9kYpyvJ5sO/sMZVz9NhQvT/W2Lo1dFUmvNnMqXRi05r+RuC/d2vcyCx/q3xNnTcOqIqKbxmLvbRnu5bA5PpHZWa9aeHZj38W46iMAIwjDgsLR/5Mjj0TA+fe15XF52SSVdRIop74dz6joorNrp9JY90/XD1JWE0plM9xzaUwUovBjYR8q4gAjGifjQGUCuCCK6+vEuiAHs87ekWG3WC32QpT9isRor/Bbua42myBKfX1ZPpQkREH3P5T9jF3pXhhs2osdnj871cVGXlwPZdip2db1YjuGSWHyp/srkWgLzRK8VqVbd5wfWyiW5kAslYMZEBDZfxWQwodqPYyaynofG8q56QK2x+8HsjO9qox+Iap3yt9xpPjK8cvqsr6N3o7l0/vy+HT0z3t81Vj/wd39B4fHysy9ka3UAtPP13vWdwj8XbO/QXHf5MVrNLNWgKeiNEH+etGMej8aqMF94iHzyyK0A94G6oeXQ5+MSTZbocd3XB0WuW3uRydz5SZN1xS32ce0TOAOPEsfAsj/Nf44UyetTCU0hvSmVJ66O09s2eqNfwd85LgLlXTgEZ0pix/7DIw9r7yiT25DKbql6QvJcV/2gU99x/ZjAy9OKyAvw+59SVJuyy963ihL/nl17zOo6UyBCuR09uBymwvSKMa+cxwln/OPvRoGJIWaVdEAkZWa/kb/u8SMC58Zjce63X817/PwJfCWhjVmAxQZU7X/EUD8YLOJHcrIoytm3/2s+GS+SwRgHiKqrE5GLGh8rcf1zK4VgvC83j6WjlOFH92lBkkKR8gWwvBGd1WZBmANVFaw9/QNyZJg9yxlVh3gcQuBrgy9oYcmhURALyZOL78QXq1Wo2MYy/iYcFcwC4NsIoI79LQQjjJd8j0FLUasjCKRAHsEYksvGR5VEpJmPYT0KzI9soR0wsEuwxMRQmgKCaDHxWZAOZmWT6ktGaXQr2/WiUl5CsiBHCnusrqEAKfr94VYkWEYCwEe0347jORyeUjGV+ib65rTAQARfjAZRRTj9xUaCbAxxTS9IJjDjKmEqgG/Q4cp0chnxdSxMHRieAluzh92tdhRZ9iJzfuEuZJ1jbkl2rg/XneZxz9xSKjcla9UfqobS2BOzrngkzFC/6ztqZZK7x0avWa3qFJ/BB/nolZL6VV2i/eZtepFujVnjH1y8fP1/yP/OSC67qZ2NHBqoVtoKc/YCc3Vnz5hMItcjKQfF6BHCujma+9xlsL4EakFyhJPwg8TivQof0MqpbAtjDSNt5Cok+1Mm8XAcjgpp/0C1XP6nn4jYAt89d0gNTPCXGYvvO/';

    /**
     * Overrides gear image URL.
     */
    Sidebar.prototype.gearImage = GRAPH_IMAGE_PATH + 'img/clipart/Gear_128x128.png';

    /**
     * Aliases for IDs in the libs parameter.
     */
    Sidebar.prototype.libAliases = {'aws2': 'aws3', 'gcp': 'gcp2'};

    /**
     *
     */
    Sidebar.prototype.defaultEntries = 'general;uml;er;bpmn;flowchart;basic;arrows2';

    /**
     * Library definitions
     */
    Sidebar.prototype.signs = ['Animals', 'Food', 'Healthcare', 'Nature', 'People', 'Safety', 'Science', 'Sports', 'Tech', 'Transportation', 'Travel'];

    Sidebar.prototype.pids = ['Agitators', 'Apparatus Elements', 'Centrifuges', 'Compressors', 'Compressors ISO', 'Crushers Grinding',
        'Driers', 'Engines', 'Feeders', 'Filters', 'Fittings', 'Flow Sensors', 'Heat Exchangers', 'Instruments', 'Misc',
        'Mixers', 'Piping', 'Pumps', 'Pumps DIN', 'Pumps ISO', 'Separators', 'Shaping Machines', 'Valves', 'Vessels'];

    Sidebar.prototype.electrical = ['LogicGates', 'Resistors', 'Capacitors', 'Inductors', 'SwitchesRelays', 'Diodes', 'Sources', 'Transistors', 'Misc', 'Audio', 'PlcLadder', 'Abstract', 'Optical', 'VacuumTubes', 'Waveforms', 'Instruments', 'RotMech', 'Transmission'];

    /**
     * Description of custom libraries, see https://desk.draw.io/a/solutions/articles/16000058316
     */
    Sidebar.prototype.customEntries = null;

    Sidebar.prototype.gmdl = ['Bottom Navigation', 'Bottom Sheets', 'Buttons', 'Cards', 'Chips', 'Dialogs', 'Dividers', 'Grid Lists', 'Icons', 'Lists', 'Menus', 'Misc', 'Pickers',
        'Selection Controls', 'Sliders', 'Steppers', 'Tabs', 'Text Fields'];

    /**
     * Array of strings for the built-in libraries to be enabled in the more shapes dialog. Null means all,
     * empty array means none, possible keys are listed for the libs parameter at
     *
     * https://desk.draw.io/support/solutions/articles/16000042546
     */
    Sidebar.prototype.enabledLibraries = null;

    /**
     *
     */
    Sidebar.prototype.configuration = [{
        id: 'general',
        libs: ['general', 'misc']
    }, {id: 'uml'}, {id: 'search'}, {id: 'er'},
        {id: 'ios', prefix: 'ios', libs: [''/*prefix is library*/, '7icons', '7ui']},
        {id: 'android', prefix: 'android', libs: [''/*prefix is library*/]},
        {id: 'basic'}, {id: 'infographic'}, {id: 'arrows'}, {id: 'arrows2'}, {id: 'azure'}, {id: 'network'},
        {id: 'signs', prefix: 'signs', libs: Sidebar.prototype.signs},
        {id: 'pid', prefix: 'pid', libs: Sidebar.prototype.pids},
        {id: 'gmdl', prefix: 'gmdl', libs: Sidebar.prototype.gmdl},
        {id: 'electrical', prefix: 'electrical', libs: Sidebar.prototype.electrical},
        {id: 'bootstrap', libs: ['bootstrap']},
        {id: 'webicons', libs: ['webicons', 'weblogos']}];

    /**
     * Adds hint for quick tutorial video for certain search terms.
     */
    var siderbarInsertSearchHint = Sidebar.prototype.insertSearchHint;

    Sidebar.prototype.insertSearchHint = function (div, searchTerm, count, page, results, len, more, terms) {
        if (terms != null && page == 1) {
            var hintText = null;

            // Adds hint for text inserts
            if (mxUtils.indexOf(terms, 'text') >= 0) {
                hintText = 'Double click anywhere in the diagram to insert text.';
            } else {
                // Checks if any of the following keywords are in the search terms
                var words = ['line', 'lines', 'arrow', 'arrows', 'connect', 'connection', 'connections',
                    'connector', 'connectors', 'curve', 'curves', 'link', 'links', 'directed',
                    'directional', 'bidirectional'];

                for (var i = 0; i < words.length; i++) {
                    if (mxUtils.indexOf(terms, words[i]) >= 0) {
                        hintText = 'Need help with connections?';
                        break;
                    }
                }
            }

            if (hintText != null && !this.hideSearchHint) {
                var link = document.createElement('a');
                link.setAttribute('href', 'https://youtu.be/Z0D96ZikMkc');
                link.setAttribute('target', '_blank');
                link.className = 'geTitle';
                link.style.cssText = 'background-color:#ffd350;border-radius:6px;color:black;' +
                    'border:1px solid black !important;text-align:center;white-space:normal;' +
                    'padding:6px 0px 6px 0px !important;margin:4px 4px 8px 2px;';
                mxUtils.write(link, hintText);

                // Adds close button
                var img = document.createElement('img');
                img.setAttribute('src', Dialog.prototype.closeImage);
                img.setAttribute('title', mxResources.get('hide'));
                img.className = 'geDialogClose';
                img.style.position = 'relative';
                img.style.cursor = 'default';
                img.style.top = '1px';
                img.style.right = '0px';

                mxEvent.addListener(img, 'click', mxUtils.bind(this, function (evt) {
                    link.parentNode.removeChild(link);
                    this.hideSearchHint = true;
                    mxEvent.consume(evt);
                }));

                link.appendChild(img);
                div.appendChild(link);

                // Shows hint only once
                this.hideSearchHint = true;
            }
        }

        siderbarInsertSearchHint.apply(this, arguments);
    };

    /**
     * Toggle palette.
     */
    Sidebar.prototype.togglePalettes = function (prefix, ids) {
        this.showPalettes(prefix, ids);
    };

    /**
     * Toggle palette.
     */
    Sidebar.prototype.togglePalette = function (id) {
        this.showPalette(id);
    };

    /**
     * Shows or hides palettes.
     */
    Sidebar.prototype.showPalettes = function (prefix, ids, visible) {
        for (var i = 0; i < ids.length; i++) {
            this.showPalette(prefix + ids[i], visible);
        }
    };


    /**
     * Shows or hides a palette.
     */
    Sidebar.prototype.showPalette = function (id, visible) {
        var elts = this.palettes[id];

        if (elts != null) {
            var vis = (visible != null) ? ((visible) ? 'block' : 'none') : (elts[0].style.display == 'none') ? 'block' : 'none';

            for (var i = 0; i < elts.length; i++) {
                elts[i].style.display = vis;
            }
        }
    };

    /**
     *
     */
    Sidebar.prototype.isEntryVisible = function (key) {
        for (var i = 0; i < this.configuration.length; i++) {
            if (this.configuration[i].id == key) {
                var id = (this.configuration[i].libs != null) ? ((this.configuration[i].prefix || '') + this.configuration[i].libs[0]) : key;
                var elts = this.palettes[id];

                if (elts != null) {
                    return elts[0].style.display != 'none';
                }

                break;
            }
        }

        if (this.customEntries != null) {
            for (var i = 0; i < this.customEntries.length; i++) {
                var section = this.customEntries[i];

                for (var j = 0; j < section.entries.length; j++) {
                    var entry = section.entries[j];

                    if (entry.id == key) {
                        if (entry.libs != null && entry.libs.length > 0) {
                            var elts = this.palettes[entry.id + '.0'];

                            if (elts != null) {
                                return elts[0].style.display != 'none';
                            }
                        }

                        break;
                    }
                }
            }
        }

        return false;
    };

    /**
     *
     */
    Sidebar.prototype.showEntries = function (stc, remember, force) {
        this.libs = (stc != null && (force || stc.length > 0)) ? stc : ((urlParams['libs'] != null &&
            urlParams['libs'].length > 0) ? decodeURIComponent(urlParams['libs']) : mxSettings.getLibraries());
        var tmp = this.libs.split(';');

        // Maps library names via the alias table
        for (var i = 0; i < tmp.length; i++) {
            tmp[i] = this.libAliases[tmp[i]] || tmp[i];
        }

        for (var i = 0; i < this.configuration.length; i++) {
            // Search has separate switch in Extras menu
            if (this.configuration[i].id != 'search') {
                this.showPalettes(this.configuration[i].prefix || '',
                    this.configuration[i].libs || [this.configuration[i].id],
                    mxUtils.indexOf(tmp, this.configuration[i].id) >= 0);
            }
        }

        if (this.customEntries != null) {
            for (var i = 0; i < this.customEntries.length; i++) {
                var section = this.customEntries[i];

                for (var j = 0; j < section.entries.length; j++) {
                    var entry = section.entries[j];

                    if (entry.libs != null && entry.libs.length > 0) {
                        var libs = [];

                        for (var k = 0; k < entry.libs.length; k++) {
                            libs.push(entry.id + '.' + k);
                        }

                        this.showPalettes('', libs, mxUtils.indexOf(tmp, entry.id) >= 0);
                    }
                }
            }
        }

        if (remember) {
            mxSettings.setLibraries(stc);
            mxSettings.save();
        }
    };

    /**
     * Overrides the sidebar init.
     */
    Sidebar.prototype.init = function () {
        // Defines all entries for the sidebar. This is used in the MoreShapes dialog. Create screenshots using the savesidebar URL parameter and
        // http://www.alderg.com/merge.html for creating a vertical stack of PNG images if multiple sidebars are part of an entry.
        this.entries = [{
            title: mxResources.get('standard'),
            entries: [{title: mxResources.get('general'), id: 'general', image: IMAGE_PATH + '/sidebar-general.png'},
                {title: mxResources.get('basic'), id: 'basic', image: IMAGE_PATH + '/sidebar-basic.png'},
                {title: mxResources.get('arrows'), id: 'arrows2', image: IMAGE_PATH + '/sidebar-arrows2.png'}
            ]
        },
            {
                title: mxResources.get('software'),
                entries: [
                    {title: mxResources.get('android'), id: 'android', image: IMAGE_PATH + '/sidebar-android.png'},
                    {
                        title: mxResources.get('bootstrap'),
                        id: 'bootstrap',
                        image: IMAGE_PATH + '/sidebar-bootstrap.png'
                    },
                    {title: mxResources.get('ios'), id: 'ios', image: IMAGE_PATH + '/sidebar-ios.png'}]
            },
            {
                title: mxResources.get('networking'),
                entries: [
                    {title: mxResources.get('azure'), id: 'azure', image: IMAGE_PATH + '/sidebar-azure.png'},
                    {title: 'Network', id: 'network', image: IMAGE_PATH + '/sidebar-network.png'}]
            },
            {
                title: mxResources.get('other'),
                entries: [

                    {
                        title: mxResources.get('electrical'),
                        id: 'electrical',
                        image: IMAGE_PATH + '/sidebar-electrical.png'
                    },
                    // TODO add to mxResources
                    {title: mxResources.get('gmdl'), id: 'gmdl', image: IMAGE_PATH + '/sidebar-gmdl.png'},
                    {title: mxResources.get('procEng'), id: 'pid', image: IMAGE_PATH + '/sidebar-pid.png'},
                    {title: 'Web Icons', id: 'webicons', image: IMAGE_PATH + '/sidebar-webIcons.png'},
                    {title: mxResources.get('signs'), id: 'signs', image: IMAGE_PATH + '/sidebar-signs.png'}]
            }];

        // Uses search.xml index file instead (faster load times)
        this.addStencilsToIndex = false;

        // Contains additional tags for shapes
        this.shapetags = {};

        // Adds tags from compressed text file for improved searches
        if (this.tagIndex != null) {
            this.addTagIndex(Graph.decompress(this.tagIndex));
            this.tagIndex = null;
        }

        this.initPalettes();
    }

    /**
     * Overridden to add image export via servlet
     */
    if (urlParams['savesidebar'] == '1') {
        Sidebar.prototype.addFoldingHandler = function (title, content, funct) {
            var initialized = false;

            // Avoids mixed content warning in IE6-8
            if (!mxClient.IS_IE || document.documentMode >= 8) {
                title.style.backgroundImage = (content.style.display == 'none') ?
                    'url(\'' + this.collapsedImage + '\')' : 'url(\'' + this.expandedImage + '\')';
            }

            title.style.backgroundRepeat = 'no-repeat';
            title.style.backgroundPosition = '0% 50%';

            var btn = document.createElement('button');
            btn.style.marginLeft = '4px';
            mxUtils.write(btn, 'Save');

            mxEvent.addListener(title, 'click', mxUtils.bind(this, function (evt) {
                if (mxEvent.getSource(evt).nodeName == 'BUTTON') {
                    var title2 = title.cloneNode(true);
                    title2.style.backgroundImage = '';
                    title2.style.textDecoration = 'none';
                    title2.style.fontWeight = 'bold';
                    title2.style.fontSize = '14px';
                    title2.style.color = 'rgb(80, 80, 80)';
                    title2.style.width = '456px';
                    title2.style.backgroundColor = '#ffffff';
                    title2.style.paddingLeft = '6px';

                    var btn2 = title2.getElementsByTagName('button')[0];
                    btn2.parentNode.removeChild(btn2);

                    var clone = content.cloneNode(true);
                    clone.style.backgroundColor = '#ffffff';
                    clone.style.borderColor = 'transparent';
                    clone.style.width = '456px';

                    var parser = new DOMParser();
                    var doc = parser.parseFromString('<body style="background:#ffffff;font-family:Helvetica,Arial;">' +
                        title2.outerHTML + clone.outerHTML + '</body>', 'text/html');

                    this.editorUi.convertImages(doc.documentElement, mxUtils.bind(this, function (body) {
                        var html = '<!DOCTYPE html><html><head><link rel="stylesheet" type="text/css" ' +
                            'href="https://www.draw.io/styles/grapheditor.css"></head>' +
                            mxUtils.getXml(body) + '</html>';

                        clone.style.position = 'absolute';
                        window.document.body.appendChild(clone);
                        var h = clone.clientHeight + 18;
                        clone.parentNode.removeChild(clone);

                        this.editorUi.confirm('Image data created', mxUtils.bind(this, function () {
                            new mxXmlRequest(EXPORT_URL, 'w=456&h=' + h + '&html=' + encodeURIComponent(
                                Graph.compress(html))).simulate(document, '_blank');
                        }), null, mxResources.get('save'), mxResources.get('cancel'));
                    }));

                    return;
                }

                if (content.style.display == 'none') {
                    if (!initialized) {
                        initialized = true;

                        if (funct != null) {
                            if (btn.parentNode != null) {
                                btn.parentNode.removeChild(btn);
                            }

                            // Wait cursor does not show up on Mac
                            title.style.cursor = 'wait';
                            var prev = title.innerHTML;
                            title.innerHTML = mxResources.get('loading') + '...';

                            window.setTimeout(function () {
                                funct(content);
                                title.style.cursor = '';
                                title.innerHTML = prev;
                                title.appendChild(btn);
                            }, 0);
                        } else {
                            title.appendChild(btn);
                        }
                    } else {
                        title.appendChild(btn);
                    }

                    title.style.backgroundImage = 'url(\'' + this.expandedImage + '\')';
                    content.style.display = 'block';
                } else {
                    title.style.backgroundImage = 'url(\'' + this.collapsedImage + '\')';
                    content.style.display = 'none';

                    if (btn.parentNode != null) {
                        btn.parentNode.removeChild(btn);
                    }
                }

                mxEvent.consume(evt);
            }));
        };
    }

    /**
     * Overridden to use shapetags to improve search results.
     */
    Sidebar.prototype.extractShapeStyle = function (style) {
        if (style != null && style.substring(0, 6) == 'shape=') {
            var semi = style.indexOf(';');

            if (semi < 0) {
                semi = style.length;
            }

            return style.substring(6, semi);
        }

        return null;
    };

    /**
     * Overridden to use shapetags to improve search results.
     */
    var sidebarGetTagsForStencil = Sidebar.prototype.getTagsForStencil;

    Sidebar.prototype.getTagsForStencil = function (pkg, stc, moreTags) {
        var tags = sidebarGetTagsForStencil.apply(this, arguments);

        // Adds tags from tags file
        if (this.shapetags != null) {
            pkg = pkg.toLowerCase();
            stc = stc.toLowerCase();

            if (this.shapetags[pkg] != null) {
                tags.push(this.shapetags[pkg]);
            }

            stc = pkg + '.' + stc;

            if (this.shapetags[stc] != null) {
                tags.push(this.shapetags[stc]);
            }
        }

        return tags;
    };

    /**
     * Overrides the sidebar init.
     */
    Sidebar.prototype.addTagIndex = function (text) {
        var lines = text.split('\n');

        for (var i = 0; i < lines.length; i++) {
            if (lines[i] != null) {
                var tags = lines[i].split('\t');

                if (tags.length > 1) {
                    var key = tags[0].toLowerCase().replace(' ', '_');
                    var value = mxUtils.trim(tags.slice(1, tags.length).join(' ').toLowerCase());

                    if (value.length > 0) {
                        this.shapetags[key] = value;
                    }
                }
            }
        }
    };

    /**
     * Overrides the sidebar init.
     */
    Sidebar.prototype.addSearchFileData = function (node) {
        if (node != null) {
            var shapes = node.getElementsByTagName('shape');

            for (var i = 0; i < shapes.length; i++) {
                var style = shapes[i].getAttribute('style');
                var shapeStyle = this.extractShapeStyle(style);

                if (style != null && shapeStyle != null) {
                    var lastDot = shapeStyle.lastIndexOf('.');

                    if (lastDot > 0) {
                        var pkg = shapeStyle.substring(0, lastDot);
                        var stc = shapeStyle.substring(lastDot + 1, shapeStyle.length);
                        var tags = this.getTagsForStencil(pkg, stc, shapes[i].getAttribute('tags'));

                        // TODO: Use shapetags for programmatic stencils
                        if (tags != null) {
                            // Converts stencil name to lowercase
                            var semi = style.indexOf(';');
                            style = 'shape=' + pkg + '.' + stc.toLowerCase() + ';' +
                                ((semi < 0) ? '' : style.substring(semi + 1));

                            this.createVertexTemplateEntry(style, parseInt(shapes[i].getAttribute('w')),
                                parseInt(shapes[i].getAttribute('h')), '', stc.replace(/_/g, ' '),
                                null, null, this.filterTags(tags.join(' ')));
                        }
                    }
                }
            }
        }
    };

    /**
     * Overrides the sidebar init.
     */
    Sidebar.prototype.initPalettes = function () {
        var imgDir = GRAPH_IMAGE_PATH;
        var dir = STENCIL_PATH;
        var signs = this.signs;
        var gcp = this.gcp;
        var rack = this.rack;
        var pids = this.pids;
        var cisco = this.cisco;
        var cisco_safe = this.cisco_safe;
        var sysml = this.sysml;
        var eip = this.eip;
        var gmdl = this.gmdl;
        var office = this.office;
        var veeam = this.veeam;
        var archimate3 = this.archimate3;
        var electrical = this.electrical;

        if (urlParams['createindex'] == '1') {
            mxLog.show();
            mxLog.textarea.value = '';
        }

        this.addSearchPalette(true);

        // Adds custom sections first
        if (this.customEntries != null) {
            for (var i = 0; i < this.customEntries.length; i++) {
                var section = this.customEntries[i];

                for (var j = 0; j < section.entries.length; j++) {
                    var entry = section.entries[j];

                    for (var k = 0; k < entry.libs.length; k++) {
                        (mxUtils.bind(this, function (lib) {
                            this.addPalette(entry.id + '.' + k, this.editorUi.getResource(lib.title),
                                false, mxUtils.bind(this, function (content, title) {
                                    var dataLoaded = mxUtils.bind(this, function (images) {
                                        this.addEntries(images);
                                        this.editorUi.addLibraryEntries(images, content);
                                    });

                                    var showError = mxUtils.bind(this, function (err) {
                                        content.innerHTML = '';
                                        var div = document.createElement('div');
                                        div.style.color = 'rgb(179, 179, 179)';
                                        div.style.textAlign = 'center';
                                        div.style.paddingTop = '6px';
                                        mxUtils.write(div, err);
                                        content.appendChild(div);
                                    });

                                    if (lib.data) {
                                        dataLoaded(lib.data);
                                    } else {
                                        content.style.display = 'none';
                                        title.innerHTML = '';
                                        mxUtils.write(title, mxResources.get('loading') + '...');
                                        var url = lib.url;

                                        if (!this.editorUi.editor.isCorsEnabledForUrl(url)) {
                                            url = PROXY_URL + '?url=' + encodeURIComponent(url);
                                        }

                                        this.editorUi.loadUrl(url, mxUtils.bind(this, function (data) {
                                            content.style.display = 'block';
                                            title.innerHTML = '';
                                            mxUtils.write(title, this.editorUi.getResource(lib.title));

                                            try {
                                                var doc = mxUtils.parseXml(data);

                                                if (doc.documentElement.nodeName == 'mxlibrary') {
                                                    var images = JSON.parse(mxUtils.getTextContent(doc.documentElement));
                                                    dataLoaded(images);
                                                } else {
                                                    showError(mxResources.get('notALibraryFile'));
                                                }
                                            } catch (e) {
                                                showError(mxResources.get('error') + ': ' + e.message);
                                            }
                                        }));
                                    }
                                }));
                        }))(entry.libs[k]);
                    }
                }
            }
        }

        this.addNeptunePalette();
        this.addGeneralPalette(this.customEntries == null);
        this.addMiscPalette(false);
        this.addBasicPalette();
        this.addStencilPalette('arrows', mxResources.get('arrows'), dir + '/arrows.xml',
            ';html=1;' + mxConstants.STYLE_VERTICAL_LABEL_POSITION + '=bottom;' + mxConstants.STYLE_VERTICAL_ALIGN + '=top;' + mxConstants.STYLE_STROKEWIDTH + '=2;strokeColor=#000000;');
        this.addArrows2Palette();

        this.addAndroidPalette();
        this.addBootstrapPalette();
        this.addIos7Palette();
        this.addIosPalette();
        this.addAzurePalette();

        this.addNetworkPalette();

        this.addElectricalPalette();

        for (var i = 0; i < gmdl.length; i++) {
            if (gmdl[i] == 'Bottom Navigation') {
                this.addGMDLBottomNavigationPalette();
            } else if (gmdl[i] == 'Bottom Sheets') {
                this.addGMDLBottomSheetsPalette();
            } else if (gmdl[i] == 'Buttons') {
                this.addGMDLButtonsPalette();
            } else if (gmdl[i] == 'Cards') {
                this.addGMDLCardsPalette();
            } else if (gmdl[i] == 'Chips') {
                this.addGMDLChipsPalette();
            } else if (gmdl[i] == 'Dialogs') {
                this.addGMDLDialogsPalette();
            } else if (gmdl[i] == 'Dividers') {
                this.addGMDLDividersPalette();
            } else if (gmdl[i] == 'Grid Lists') {
                this.addGMDLGridListsPalette();
            } else if (gmdl[i] == 'Icons') {
                this.addGMDLIconsPalette();
            } else if (gmdl[i] == 'Lists') {
                this.addGMDLListsPalette();
            } else if (gmdl[i] == 'Menus') {
                this.addGMDLMenusPalette();
            } else if (gmdl[i] == 'Misc') {
                this.addGMDLMiscPalette();
            } else if (gmdl[i] == 'Pickers') {
                this.addGMDLPickersPalette();
            } else if (gmdl[i] == 'Selection Controls') {
                this.addGMDLSelectionControlsPalette();
            } else if (gmdl[i] == 'Sliders') {
                this.addGMDLSlidersPalette();
            } else if (gmdl[i] == 'Steppers') {
                this.addGMDLSteppersPalette();
            } else if (gmdl[i] == 'Tabs') {
                this.addGMDLTabsPalette();
            } else if (gmdl[i] == 'Text Fields') {
                this.addGMDLTextFieldsPalette();
            }
        }

        for (var i = 0; i < pids.length; i++) {
            if (pids[i] == 'Instruments') {
                this.addPidInstrumentsPalette();
            } else if (pids[i] == 'Misc') {
                this.addPidMiscPalette();
            } else if (pids[i] == 'Valves') {
                this.addPidValvesPalette();
            } else if (pids[i] == 'Compressors') {
                this.addPidCompressorsPalette();
            } else if (pids[i] == 'Engines') {
                this.addPidEnginesPalette();
            } else if (pids[i] == 'Filters') {
                this.addPidFiltersPalette();
            } else if (pids[i] == 'Flow Sensors') {
                this.addPidFlowSensorsPalette();
            } else if (pids[i] == 'Piping') {
                this.addPidPipingPalette();
            } else {
                this.addStencilPalette('pid' + pids[i], 'Proc. Eng. / ' + pids[i],
                    dir + '/pid/' + pids[i].toLowerCase().replace(' ', '_') + '.xml',
                    ';html=1;pointerEvents=1;align=center;' + mxConstants.STYLE_VERTICAL_LABEL_POSITION + '=bottom;' + mxConstants.STYLE_VERTICAL_ALIGN + '=top;dashed=0;');
            }
        }

        this.addWebIconsPalette();
        this.addWebLogosPalette();

        for (var i = 0; i < signs.length; i++) {
            this.addStencilPalette('signs' + signs[i], 'Signs / ' + signs[i],
                dir + '/signs/' + signs[i].toLowerCase() + '.xml',
                ';html=1;pointerEvents=1;fillColor=#000000;strokeColor=none;verticalLabelPosition=bottom;verticalAlign=top;align=center;');
        }

        // LATER: Check if conflicts with restore libs after loading file
        this.showEntries();
    };

    /**
     * Overridden to manually create search index for stencil files which are not pre-loaded
     * and no entries are created programmatically.
     */
    if (urlParams['createindex'] == '1') {
        var sidebarAddStencilPalette = Sidebar.prototype.addStencilPalette;

        Sidebar.prototype.addStencilPalette = function (id, title, stencilFile, style, ignore, onInit, scale, tags) {
            sidebarAddStencilPalette.apply(this, arguments);
            scale = (scale != null) ? scale : 1;

            // Used for creating index
            mxStencilRegistry.loadStencilSet(stencilFile, mxUtils.bind(this, function (packageName, stencilName, displayName, w, h) {
                if (ignore == null || mxUtils.indexOf(ignore, stencilName) < 0) {
                    var tmpTags = (tags != null) ? tags[stencilName] : null;

                    mxLog.debug('<shape style="shape=' + packageName + stencilName + style + '" ' +
                        'w="' + Math.round(w * scale) + '" h="' + Math.round(h * scale) + '"' +
                        ((tmpTags != null) ? ' tags="' + tmpTags + '"' : '') + '/>');
                }
            }), true);
        };
    }

    /**
     * Adds server icon results to local search results
     */
    var sidebarSearchEntries = Sidebar.prototype.searchEntries;

    Sidebar.prototype.searchEntries = function (searchTerms, count, page, success, error) {
        var succ = success;

        // Lazy-load indices
        if (this.searchFileData != null) {
            this.addSearchFileData(mxUtils.parseXml(Graph.decompress(this.searchFileData)).documentElement);

            this.searchFileData = null;
        }

        // Logs search terms for improving search results
        if (!this.editorUi.isOffline() && page == 0) {
            EditorUi.logEvent({category: 'Shape', action: 'search', label: searchTerms});
        }

        if (ICONSEARCH_PATH != null) {
            success = mxUtils.bind(this, function (results, len, more, terms) {
                if (!this.editorUi.isOffline() && results.length <= count / 4) {
                    var pg = page - Math.ceil((len - count / 4) / count);

                    mxUtils.get(ICONSEARCH_PATH + '?q=' + encodeURIComponent(searchTerms) +
                        '&p=' + pg + '&c=' + count, mxUtils.bind(this, function (req) {
                            try {
                                if (req.getStatus() >= 200 && req.getStatus() <= 299) {
                                    // Ignore without error if no response
                                    if (req.getText() != null && req.getText().length > 0) {
                                        try {
                                            var res = JSON.parse(req.getText());

                                            if (res == null || res.icons == null) {
                                                succ(results, len, false, terms);
                                                this.editorUi.handleError(res);
                                            } else {
                                                for (var i = 0; i < res.icons.length; i++) {
                                                    var sizes = res.icons[i].raster_sizes;
                                                    var index = sizes.length - 1;

                                                    while (index > 0 && sizes[index].size > 128) {
                                                        index--;
                                                    }

                                                    var size = sizes[index].size;
                                                    var url = sizes[index].formats[0].preview_url;

                                                    if (size != null && url != null) {
                                                        (mxUtils.bind(this, function (s, u) {
                                                            results.push(mxUtils.bind(this, function () {
                                                                return this.createVertexTemplate('shape=image;html=1;verticalAlign=top;' +
                                                                    'verticalLabelPosition=bottom;labelBackgroundColor=#ffffff;imageAspect=0;' +
                                                                    'aspect=fixed;image=' + u, s, s, '');
                                                            }));
                                                        }))(size, url);
                                                    }
                                                }

                                                succ(results, (page - 1) * count + results.length, res.icons.length == count, terms);
                                            }
                                        } catch (e) {
                                            succ(results, len, false, terms);
                                            this.editorUi.handleError(e);
                                        }
                                    } else {
                                        succ(results, len, false, terms);
                                    }
                                } else {
                                    succ(results, len, false, terms);
                                    this.editorUi.handleError({message: mxResources.get('unknownError')});
                                }
                            } catch (e) {
                                succ(results, len, false, terms);
                                this.editorUi.handleError(e);
                            }
                        },
                        function () {
                            succ(results, len, false, terms);
                        }));
                } else {
                    succ(results, len, more || !this.editorUi.isOffline(), terms);
                }
            });
        }

        sidebarSearchEntries.apply(this, arguments);
    };

    /**
     * Adds a click handler for inserting the cell as target for dangling edge.
     */
    var sidebarItemClicked = Sidebar.prototype.itemClicked;

    Sidebar.prototype.itemClicked = function (cells, ds, evt) {
        var graph = this.editorUi.editor.graph;
        var handled = false;

        if (cells != null && graph.getSelectionCount() == 1 && graph.getModel().isVertex(cells[0])) {
            var target = graph.cloneCell(cells[0]);

            // Inserts cell as target of selected edge if not connected
            if (graph.getModel().isEdge(graph.getSelectionCell()) && graph.getModel().getTerminal(graph.getSelectionCell(), false) == null &&
                graph.getModel().isVertex(target)) {
                graph.getModel().beginUpdate();
                try {
                    var edgeState = graph.view.getState(graph.getSelectionCell());

                    if (edgeState != null) {
                        var tr = graph.view.translate;
                        var s = graph.view.scale;
                        var pt = edgeState.absolutePoints[edgeState.absolutePoints.length - 1];

                        target.geometry.x = pt.x / s - tr.x - target.geometry.width / 2;
                        target.geometry.y = pt.y / s - tr.y - target.geometry.height / 2;
                    }

                    graph.addCell(target);
                    graph.getModel().setTerminal(graph.getSelectionCell(), target, false);
                } finally {
                    graph.getModel().endUpdate();
                }

                graph.scrollCellToVisible(target);
                graph.setSelectionCell(target);
                handled = true;
            }
        }

        if (!handled) {
            sidebarItemClicked.apply(this, arguments);
        }
    };
})();

(function () {
    /*Aric.chen :: Add Neptune Widgets*/
    Sidebar.prototype.addNeptunePalette = function () {
        var dt = 'neptune ';
        var sb = this;
        var style = 'perimeter=ellipsePerimeter;html=1;align=center;shadow=0;dashed=0;spacingTop=3;resizeWidth=1;resizeHeight=1;tag1=neptune;tag2=';

        var fns = [
            this.addEntry(dt + 'field', function () {
                var html = `<div class="component-content"><div class="component-field"><img style="width:40px;height: 40px;" src="${cynovan.r_path}prototype/monitor/img/lib/neptune/field.svg"/></div></div>`;
                var bg = new mxCell(html, new mxGeometry(0, 0, 60, 60), style + 'field');
                bg.vertex = true;

                return sb.createVertexTemplateFromCells([bg], 60, 60, '数据栏位');
            }),
            this.addEntry(dt + 'control', function () {
                var html = `<div class="component-content"><div class="component-control"><img style="width:45px;height: 45px;" src="${cynovan.r_path}prototype/monitor/img/lib/neptune/control.svg"/></div></div>`;
                var bg = new mxCell(html, new mxGeometry(0, 0, 60, 60), style + 'control');
                bg.vertex = true;

                return sb.createVertexTemplateFromCells([bg], 60, 60, '数据控制');
            }),
            this.addEntry(dt + 'line_chart', function () {
                var html = `<div class="component-content"><div class="component-chart component-linechart"><img style="width:75px;height: 75px;" src="${cynovan.r_path}prototype/monitor/img/lib/neptune/line_chart.svg"/></div></div>`;
                var bg = new mxCell(html, new mxGeometry(0, 0, 100, 100), style + 'linechart');
                bg.vertex = true;

                return sb.createVertexTemplateFromCells([bg], 100, 100, '折线图');
            }),
            this.addEntry(dt + 'history_chart', function () {
                var html = `<div class="component-content"><div class="component-chart component-historychart"><img style="width:75px;height: 75px;" src="${cynovan.r_path}prototype/monitor/img/lib/neptune/history_chart.svg"/></div></div>`;
                var bg = new mxCell(html, new mxGeometry(0, 0, 100, 100), style + 'historychart');
                bg.vertex = true;

                return sb.createVertexTemplateFromCells([bg], 100, 100, '历史数据图表');
            }),
            this.addEntry(dt + 'dashboard', function () {
                var html = `<div class="component-content"><div class="component-chart component-dashboard"><img style="width:90px;height: 90px;" src="${cynovan.r_path}prototype/monitor/img/lib/neptune/dashboard.svg"/></div></div>`;
                var bg = new mxCell(html, new mxGeometry(0, 0, 100, 100), style + 'dashboard');
                bg.vertex = true;

                return sb.createVertexTemplateFromCells([bg], 100, 100, '仪表板');
            }),
            this.addEntry(dt + 'camera', function () {
                var html = `<div class="component-content"><div class="component-camera"><img style="width:90px;height: 90px;" src="${cynovan.r_path}prototype/monitor/img/lib/neptune/camera.svg"/></div></div>`;
                var bg = new mxCell(html, new mxGeometry(0, 0, 100, 100), style + 'camera');
                bg.vertex = true;

                return sb.createVertexTemplateFromCells([bg], 100, 100, '摄像头');
            }),
            this.addEntry(dt + 'timeline', function () {
                var html = `<div class="component-content"><div class="componet-timeline"><img style="width:75px;height: 75px;" src="${cynovan.r_path}prototype/monitor/img/lib/neptune/timeline.svg"/></div></div>`;
                var bg = new mxCell(html, new mxGeometry(0, 0, 100, 100), style + 'timeline');
                bg.vertex = true;

                return sb.createVertexTemplateFromCells([bg], 100, 100, '设备时间轴');
            }),
            this.addEntry(dt + 'map', function () {
                var html = `<div class="component-content"><div class="componet-map"><img style="width:75px;height: 75px;" src="${cynovan.r_path}prototype/monitor/img/lib/neptune/map.svg"/></div></div>`;
                var bg = new mxCell(html, new mxGeometry(0, 0, 100, 100), style + 'map');
                bg.vertex = true;
                return sb.createVertexTemplateFromCells([bg], 100, 100, '地图');
            }),
            this.addEntry(dt + 'flowbar', function () {
                var html = `<div class="component-content"><div class="componet-flowbar"><img style="width:100px;height: 20px;" src="${cynovan.r_path}prototype/monitor/img/lib/neptune/flowbar.svg"/></div></div>`;
                var bg = new mxCell(html, new mxGeometry(0, 0, 100, 30), style + 'flowbar');
                bg.vertex = true;
                return sb.createVertexTemplateFromCells([bg], 100, 30, '流动条');
            }),
            this.addEntry(dt + 'progressbar', function () {
                var html = `<div class="component-content"><div class="componet-progressbar"><img style="width:80px;height: 20px;" src="${cynovan.r_path}prototype/monitor/img/lib/neptune/progressbar.svg"/></div></div>`;
                var bg = new mxCell(html, new mxGeometry(0, 0, 100, 30), style + 'progressbar');
                bg.vertex = true;
                return sb.createVertexTemplateFromCells([bg], 100, 30, '进度条');
            }),
            this.addEntry(dt + 'realtime', function () {
                var html = `<div class="component-content"><div class="componet-realtime"><img style="width:80px;height:75px;" src="${cynovan.r_path}prototype/monitor/img/lib/neptune/realtime.svg"/></div></div>`;
                var bg = new mxCell(html, new mxGeometry(0, 0, 100, 100), style + 'realtime');
                bg.vertex = true;
                return sb.createVertexTemplateFromCells([bg], 100, 100, '实时时间');
            })
        ];

        this.addPalette('neptune', 'Janus组件', false, mxUtils.bind(this, function (content) {
            for (var i = 0; i < fns.length; i++) {
                content.appendChild(fns[i](content));
            }
        }));

        var gn = 'material';
        var r = 100;
        var s = 'aspect=fixed;html=1;points=[];align=center;image;fontSize=12;image=' + cynovan.r_path + 'prototype/monitor/img/lib/neptune/';
        var materialArr = ['AirBlower', 'blower1', 'blower2', 'blower3', 'pump1', 'pump2', 'bluebutton', 'greenbutton',
            'greybutton', 'redbutton', 'yellowbutton', 'selectorSwitch', 'conveyor1', 'conveyor2', 'conveyor3', 'conveyor4',
            'mixer2', 'motor1', 'motor2', 'motor3', 'pipe1', 'pipe2', 'pipe3', 'pipe4', 'pipe5',
            'tank1', 'tank2', 'tank4', 'tank5', 'tank6', 'tank7', 'tank8', 'ballvalve', 'check valve',
            'drainvalve1', 'gatevalve', 'globevalve', 'valve1', 'valve2', 'valve3', 'valve4', 'valvehandleblue', 'valvetop',
            'barrelblue', 'barrelred', 'boiler1', 'boiler2', 'box1', 'fire', 'glassbottle'];

        var materialEntry = [];
        for (let i = 0; i < materialArr.length; i++) {
            let name = materialArr[i];
            materialEntry.push(
                this.createVertexTemplateEntry(s + name + '.svg;',
                    r * 0.49, r * 0.5, '', name, null, null, this.getTagsForStencil(gn, name, dt).join(' ')),
            )
        }

        this.addPalette('material', '素材', false, mxUtils.bind(this, function (content) {
            for (var i = 0; i < materialEntry.length; i++) {
                content.appendChild(materialEntry[i](content));
            }
        }));

    };
})();

(function () {
    // Adds Android shapes
    Sidebar.prototype.addAndroidPalette = function () {
        var sizeX = 211; //reference size for iPhone and all other iOS shapes

        var sizeY = 2 * sizeX; //change only sizeX, to avoid changing aspect ratio

        var sb = this;
        var s = 'strokeWidth=1;html=1;shadow=0;dashed=0;shape=mxgraph.android.';
        var sm = 'strokeWidth=2;shadow=0;dashed=0;html=1;shape=mxgraph.android.';
        var s2 = mxConstants.STYLE_VERTICAL_LABEL_POSITION + '=bottom;' + mxConstants.STYLE_VERTICAL_ALIGN + '=top;html=1;shadow=0;dashed=0;strokeWidth=1;shape=mxgraph.android.';
        var s3 = mxConstants.STYLE_VERTICAL_LABEL_POSITION + '=bottom;' + mxConstants.STYLE_VERTICAL_ALIGN + '=top;html=1;shadow=0;dashed=0;strokeWidth=1;strokeColor=none;shape=';
        var s4 = 'rounded=1;html=1;shadow=0;dashed=0;whiteSpace=wrap;fontSize=10;fillColor=#';
        var s5 = 'whiteSpace=wrap;html=1;shadow=0;dashed=0;fontSize=10;align=left;fillColor=#';
        var s6 = mxConstants.STYLE_VERTICAL_LABEL_POSITION + '=bottom;' + mxConstants.STYLE_VERTICAL_ALIGN + '=top;html=1;shadow=0;dashed=0;strokeWidth=2;shape=mxgraph.android.';
        var s7 = 'strokeWidth=1;html=1;shadow=0;dashed=0;shape=';
        var inh = 'strokeColor=inherit;fillColor=inherit;gradientColor=inherit;';
        //default tags
        var dt = 'android ';

        var fns =
            [
                this.createVertexTemplateEntry(s2 + 'phone2;fillColor=#ffffff;strokeColor=#c0c0c0;',
                    200, 390, '', 'Phone', null, null, dt + 'phone mobile portrait'),
                this.createVertexTemplateEntry(s2 + 'phone2;fillColor=#ffffff;strokeColor=#c0c0c0;direction=south;',
                    390, 200, '', 'Phone (landscape)', null, null, dt + 'phone mobile landscape'),
                this.createVertexTemplateEntry(s2 + 'tab2;fillColor=#ffffff;strokeColor=#c0c0c0;',
                    472, 686, '', 'Tab', null, null, dt + 'tab tablet portrait'),
                this.createVertexTemplateEntry(s2 + 'tab2;fillColor=#ffffff;strokeColor=#c0c0c0;direction=north;',
                    686, 472, '', 'Tab (landscape)', null, null, dt + 'tab tablet landscape'),
                this.createVertexTemplateEntry(s + 'action_bar;fillColor=#1A1A1A;strokeColor=#c0c0c0;strokeWidth=2;fontColor=#FFFFFF;',
                    185, 30, '', 'Action Bar', null, null, dt + 'action bar dark portrait'),
                this.createVertexTemplateEntry(s + 'action_bar;fillColor=#E6E6E6;strokeColor=#c0c0c0;strokeWidth=2;',
                    185, 30, '', 'Action Bar (Bright)', null, null, dt + 'action bar bright portrait'),
                this.createVertexTemplateEntry(s + 'action_bar_landscape;fillColor=#1A1A1A;strokeColor=#c0c0c0;strokeWidth=2;fontColor=#FFFFFF;',
                    320, 30, '', 'Action Bar Landscape', null, null, dt + 'action bar landscape dark'),
                this.createVertexTemplateEntry(s + 'action_bar_landscape;fillColor=#E6E6E6;strokeColor=#c0c0c0;strokeWidth=2;',
                    320, 30, '', 'Action Bar Landscape (Bright)', null, null, dt + 'action bar bright landscape'),
                this.createVertexTemplateEntry(s4 + '666666;align=center;strokeColor=#4D4D4D;fontColor=#ffffff;',
                    sizeX * 0.5, sizeY * 0.04, 'Normal', 'Button (Normal)', null, null, dt + 'button normal'),
                this.createVertexTemplateEntry(s4 + '666666;align=center;strokeColor=#999999;fontColor=#ffffff;',
                    sizeX * 0.5, sizeY * 0.04, 'Focused', 'Button (Focused)', null, null, dt + 'button focused'),
                this.createVertexTemplateEntry(s4 + '999999;align=center;strokeColor=#666666;fontColor=#ffffff;strokeWidth=2;',
                    sizeX * 0.5, sizeY * 0.04, 'Pressed', 'Button (Pressed)', null, null, dt + 'button pressed'),
                this.createVertexTemplateEntry(s4 + '333333;align=center;strokeColor=#4D4D4D;fontColor=#666666;',
                    sizeX * 0.5, sizeY * 0.04, 'Focused disabled', 'Button (Focused, Disabled)', null, null, dt + 'button focused disabled'),
                this.createVertexTemplateEntry(s4 + '333333;align=center;strokeColor=#333333;fontColor=#666666;',
                    sizeX * 0.5, sizeY * 0.04, 'Disabled', 'Button (Disabled)', null, null, dt + 'button disabled'),
                this.createVertexTemplateEntry(s4 + 'E6E6E6;align=center;strokeColor=#E6E6E6;fontColor=#333333;',
                    sizeX * 0.5, sizeY * 0.04, 'Normal', 'Button (Normal, Bright)', null, null, dt + 'button normal bright'),
                this.createVertexTemplateEntry(s4 + 'E6E6E6;align=center;strokeColor=#B3B3B3;fontColor=#333333;',
                    sizeX * 0.5, sizeY * 0.04, 'Focused', 'Button (Focused, Bright)', null, null, dt + 'button focused bright'),
                this.createVertexTemplateEntry(s4 + 'B3B3B3;align=center;strokeColor=#E6E6E6;fontColor=#333333;strokeWidth=2;',
                    sizeX * 0.5, sizeY * 0.04, 'Pressed', 'Button (Pressed, Bright)', null, null, dt + 'button pressed bright'),
                this.createVertexTemplateEntry(s4 + 'F4F4F4;align=center;strokeColor=#E6E6E6;fontColor=#CCCCCC;',
                    sizeX * 0.5, sizeY * 0.04, 'Focused disabled', 'Button (Focused, Disabled, Bright)', null, null, dt + 'button focused disabled bright'),
                this.createVertexTemplateEntry(s4 + 'F4F4F4;align=center;strokeColor=#F4F4F4;fontColor=#CCCCCC;',
                    sizeX * 0.5, sizeY * 0.04, 'Disabled', 'Button (Disabled, Bright)', null, null, dt + 'button disabled bright'),

                this.addEntry(dt + 'checkboxes checkbox', function () {
                    var bg = new mxCell('', new mxGeometry(0, 0, 165, 50), s7 + 'transparent;strokeColor=#33b5e5;fillColor=#ffffff');
                    bg.vertex = true;
                    var button1 = new mxCell('Setting 1', new mxGeometry(0, 0, 165, 12.5), inh + 'shape=transparent;align=left;spacingLeft=10;fontSize=8;fontColor=#33b5e5;');
                    button1.vertex = true;
                    bg.insert(button1);
                    var anchor1 = new mxCell('', new mxGeometry(0, 6, 0, 0), inh + 'shape=transparent;');
                    anchor1.vertex = true;
                    button1.insert(anchor1);
                    var radio1 = new mxCell('', new mxGeometry(2.5, -2.5, 5, 5), inh + s + 'rrect;rSize=0;resizable=0;');
                    radio1.vertex = true;
                    anchor1.insert(radio1);
                    var button2 = new mxCell('Setting 2', new mxGeometry(0, 12.5, 165, 12.5), inh + 'shape=transparent;align=left;spacingLeft=10;fontSize=8;fontColor=#33b5e5;');
                    button2.vertex = true;
                    bg.insert(button2);
                    var anchor2 = new mxCell('', new mxGeometry(0, 6, 0, 0), inh + 'shape=transparent;');
                    anchor2.vertex = true;
                    button2.insert(anchor2);
                    var radio2 = new mxCell('', new mxGeometry(2.5, -2.5, 5, 5), inh + s + 'rrect;rSize=0;resizable=0;');
                    radio2.vertex = true;
                    anchor2.insert(radio2);
                    var button3 = new mxCell('Setting 3', new mxGeometry(0, 25, 165, 12.5), inh + 'shape=transparent;align=left;spacingLeft=10;fontSize=8;fontColor=#33b5e5;');
                    button3.vertex = true;
                    bg.insert(button3);
                    var anchor3 = new mxCell('', new mxGeometry(0, 6, 0, 0), inh + 'shape=transparent;');
                    anchor3.vertex = true;
                    button3.insert(anchor3);
                    var radio3 = new mxCell('', new mxGeometry(2.5, -2.5, 5, 5), inh + s + 'checkbox;rSize=0;resizable=0;');
                    radio3.vertex = true;
                    anchor3.insert(radio3);
                    var button4 = new mxCell('Setting 4', new mxGeometry(0, 37.5, 165, 12.5), inh + 'shape=transparent;align=left;spacingLeft=10;fontSize=8;fontColor=#33b5e5;');
                    button4.vertex = true;
                    bg.insert(button4);
                    var anchor4 = new mxCell('', new mxGeometry(0, 6, 0, 0), inh + 'shape=transparent;');
                    anchor4.vertex = true;
                    button4.insert(anchor4);
                    var radio4 = new mxCell('', new mxGeometry(2.5, -2.5, 5, 5), inh + s + 'rrect;rSize=0;resizable=0;');
                    radio4.vertex = true;
                    anchor4.insert(radio4);

                    return sb.createVertexTemplateFromCells([bg], bg.geometry.width, bg.geometry.height, 'Checkboxes');
                }),

                this.addEntry(dt + 'radiobuttons radiobutton', function () {
                    var bg = new mxCell('', new mxGeometry(0, 0, 165, 50), s7 + 'transparent;strokeColor=#33b5e5;fillColor=#ffffff;');
                    bg.vertex = true;
                    var button1 = new mxCell('Option 1', new mxGeometry(0, 0, 165, 12.5), inh + 'shape=transparent;align=left;spacingLeft=10;fontSize=8;fontColor=#33b5e5;');
                    button1.vertex = true;
                    bg.insert(button1);
                    var anchor1 = new mxCell('', new mxGeometry(0, 6, 0, 0), inh + 'shape=transparent;');
                    anchor1.vertex = true;
                    button1.insert(anchor1);
                    var radio1 = new mxCell('', new mxGeometry(2.5, -2.5, 5, 5), inh + 'shape=ellipse;resizable=0;html=1;');
                    radio1.vertex = true;
                    anchor1.insert(radio1);
                    var button2 = new mxCell('Option 2', new mxGeometry(0, 12.5, 165, 12.5), inh + 'shape=transparent;align=left;spacingLeft=10;fontSize=8;fontColor=#33b5e5;');
                    button2.vertex = true;
                    bg.insert(button2);
                    var anchor2 = new mxCell('', new mxGeometry(0, 6, 0, 0), inh + 'shape=transparent;');
                    anchor2.vertex = true;
                    button2.insert(anchor2);
                    var radio2 = new mxCell('', new mxGeometry(2.5, -2.5, 5, 5), inh + 'shape=ellipse;resizable=0;html=1;');
                    radio2.vertex = true;
                    anchor2.insert(radio2);
                    var button3 = new mxCell('Option 3', new mxGeometry(0, 25, 165, 12.5), inh + 'shape=transparent;align=left;spacingLeft=10;fontSize=8;fontColor=#33b5e5;');
                    button3.vertex = true;
                    bg.insert(button3);
                    var anchor3 = new mxCell('', new mxGeometry(0, 6, 0, 0), inh + 'shape=transparent;');
                    anchor3.vertex = true;
                    button3.insert(anchor3);
                    var radio3 = new mxCell('', new mxGeometry(2.5, -2.5, 5, 5), 'shape=ellipse;strokeColor=inherit;resizable=0;fillColor=#33b5e5;html=1;');
                    radio3.vertex = true;
                    anchor3.insert(radio3);
                    var button4 = new mxCell('Option 4', new mxGeometry(0, 37.5, 165, 12.5), inh + 'shape=transparent;align=left;spacingLeft=10;fontSize=8;fontColor=#33b5e5;');
                    button4.vertex = true;
                    bg.insert(button4);
                    var anchor4 = new mxCell('', new mxGeometry(0, 6, 0, 0), inh + 'shape=transparent;');
                    anchor4.vertex = true;
                    button4.insert(anchor4);
                    var radio4 = new mxCell('', new mxGeometry(2.5, -2.5, 5, 5), inh + 'shape=ellipse;resizable=0;html=1;');
                    radio4.vertex = true;
                    anchor4.insert(radio4);

                    return sb.createVertexTemplateFromCells([bg], bg.geometry.width, bg.geometry.height, 'Radiobuttons');
                }),

                this.createVertexTemplateEntry(s2 + 'contact_badge_focused;', 40, 40, '', 'Contact Badge Focused', null, null, dt + 'contact badge focused'),
                this.createVertexTemplateEntry(s2 + 'contact_badge_focused;', 60, 60, '', 'Contact Badge Focused', null, null, dt + 'contact badge focused'),
                this.createVertexTemplateEntry(s2 + 'contact_badge_normal;', 40, 40, '', 'Contact Badge Normal', null, null, dt + 'contact badge normal'),
                this.createVertexTemplateEntry(s2 + 'contact_badge_normal;', 60, 60, '', 'Contact Badge Normal', null, null, dt + 'contact badge normal'),
                this.createVertexTemplateEntry(s2 + 'contact_badge_pressed;', 40, 40, '', 'Contact Badge Pressed', null, null, dt + 'contact badge pressed'),
                this.createVertexTemplateEntry(s2 + 'contact_badge_pressed;', 60, 60, '', 'Contact Badge Pressed', null, null, dt + 'contact badge pressed'),

                this.addEntry(dt + 'contextual action bar dark portrait', function () {
                    var bg = new mxCell('', new mxGeometry(0, 0, 185, 30), s + 'contextual_action_bar;fillColor=#002E3E;');
                    bg.vertex = true;
                    var text1 = new mxCell('Action', new mxGeometry(40, 0, 100, 30), 'shape=transparent;align=left;fontStyle=1;fontColor=#ffffff;');
                    text1.vertex = true;
                    bg.insert(text1);

                    return sb.createVertexTemplateFromCells([bg], bg.geometry.width, bg.geometry.height, 'Contextual Action Bar');
                }),

                this.addEntry(dt + 'contextual action bar bright portrait', function () {
                    var bg = new mxCell('', new mxGeometry(0, 0, 185, 30), s + 'contextual_action_bar_white;fillColor=#E6E6E6;');
                    bg.vertex = true;
                    var text1 = new mxCell('Action', new mxGeometry(40, 0, 100, 30), 'shape=transparent;align=left;fontStyle=1;');
                    text1.vertex = true;
                    bg.insert(text1);

                    return sb.createVertexTemplateFromCells([bg], bg.geometry.width, bg.geometry.height, 'Contextual Action Bar (Bright)');
                }),

                this.addEntry(dt + 'contextual action bar landscape dark', function () {
                    var bg = new mxCell('', new mxGeometry(0, 0, 320, 30), s + 'contextual_action_bar_landscape;fillColor=#002E3E;');
                    bg.vertex = true;
                    var text1 = new mxCell('Action', new mxGeometry(40, 0, 100, 30), 'shape=transparent;align=left;fontStyle=1;fontColor=#ffffff;');
                    text1.vertex = true;
                    bg.insert(text1);

                    return sb.createVertexTemplateFromCells([bg], bg.geometry.width, bg.geometry.height, 'Contextual Action Bar Landscape');
                }),

                this.addEntry(dt + 'contextual action bar landscape bright', function () {
                    var bg = new mxCell('', new mxGeometry(0, 0, 320, 30), s + 'contextual_action_bar_landscape_white;fillColor=#E6E6E6;');
                    bg.vertex = true;
                    var text1 = new mxCell('Action', new mxGeometry(40, 0, 100, 30), 'shape=transparent;align=left;fontStyle=1;');
                    text1.vertex = true;
                    bg.insert(text1);

                    return sb.createVertexTemplateFromCells([bg], bg.geometry.width, bg.geometry.height, 'Contextual Action Bar Landscape (Bright)');
                }),

                this.addEntry(dt + 'contextual split action bar dark', function () {
                    var bg = new mxCell('', new mxGeometry(0, 0, 185, 70), s + 'contextual_split_action_bar;fillColor=#002E3E;fontColor=#FFFFFF;');
                    bg.vertex = true;
                    var text1 = new mxCell('Contextual', new mxGeometry(0, 0, 185, 30), 'shape=transparent;fontStyle=1;fontColor=#ffffff;');
                    text1.vertex = true;
                    bg.insert(text1);
                    var text2 = new mxCell('Action', new mxGeometry(0, 40, 185, 30), 'shape=transparent;fontStyle=1;fontColor=#ffffff;');
                    text2.vertex = true;
                    bg.insert(text2);

                    return sb.createVertexTemplateFromCells([bg], bg.geometry.width, bg.geometry.height, 'Contextual Split Action Bar');
                }),

                this.addEntry(dt + 'contextual split action bar bright', function () {
                    var bg = new mxCell('', new mxGeometry(0, 0, 185, 70), s + 'contextual_split_action_bar_white;fillColor=#E6E6E6;');
                    bg.vertex = true;
                    var text1 = new mxCell('Contextual', new mxGeometry(0, 0, 185, 30), 'shape=transparent;fontStyle=1;');
                    text1.vertex = true;
                    bg.insert(text1);
                    var text2 = new mxCell('Action', new mxGeometry(0, 40, 185, 30), 'shape=transparent;fontStyle=1;');
                    text2.vertex = true;
                    bg.insert(text2);

                    return sb.createVertexTemplateFromCells([bg], bg.geometry.width, bg.geometry.height, 'Contextual Split Action Bar (Bright)');
                }),

                this.addEntry(dt + 'contextual split action bar landscape dark', function () {
                    var bg = new mxCell('', new mxGeometry(0, 0, 320, 70), s + 'contextual_split_action_bar_landscape;fillColor=#002E3E;fontColor=#FFFFFF;');
                    bg.vertex = true;
                    var text1 = new mxCell('Contextual', new mxGeometry(0, 0, 320, 30), 'shape=transparent;fontStyle=1;fontColor=#ffffff;');
                    text1.vertex = true;
                    bg.insert(text1);
                    var text2 = new mxCell('Action', new mxGeometry(0, 40, 320, 30), 'shape=transparent;fontStyle=1;fontColor=#ffffff;');
                    text2.vertex = true;
                    bg.insert(text2);

                    return sb.createVertexTemplateFromCells([bg], bg.geometry.width, bg.geometry.height, 'Contextual Split Action Bar Landscape');
                }),

                this.addEntry(dt + 'contextual split action bar landscape bright', function () {
                    var bg = new mxCell('', new mxGeometry(0, 0, 320, 70), s + 'contextual_split_action_bar_landscape_white;fillColor=#E6E6E6;');
                    bg.vertex = true;
                    var text1 = new mxCell('Contextual', new mxGeometry(0, 0, 320, 30), 'shape=transparent;fontStyle=1;');
                    text1.vertex = true;
                    bg.insert(text1);
                    var text2 = new mxCell('Action', new mxGeometry(0, 40, 320, 30), 'shape=transparent;fontStyle=1;');
                    text2.vertex = true;
                    bg.insert(text2);

                    return sb.createVertexTemplateFromCells([bg], bg.geometry.width, bg.geometry.height, 'Contextual Split Action Bar Landscape (Bright)');
                }),

                this.createVertexTemplateEntry(s2 + 'indeterminate_progress_bar;strokeColor=#33B5E5;pointerEvents=1',
                    149, 5, '', 'Indeterminate Progress Bar', null, null, dt + 'indeterminate progress bar'),
                this.createVertexTemplateEntry(s2 + 'indeterminateSpinner;',
                    50, 50, '', 'Indeterminate Spinner', null, null, dt + 'indeterminate spinner'),
                this.createVertexTemplateEntry(s2 + 'keyboard;',
                    185, 100, '', 'Keyboard', null, null, dt + 'keyboard'),

                this.addEntry(dt + 'menu bar', function () {
                    var bg = new mxCell('', new mxGeometry(0, 0, 185, 50), s + 'rrect;rSize=0;strokeColor=#888888;fillColor=#444444;');
                    bg.vertex = true;
                    var button1 = new mxCell('Menu Item 1', new mxGeometry(0, 0, 185, 12.5), inh + s + 'rrect;rSize=0;align=left;spacingLeft=10;fontSize=8;fontColor=#ffffff;');
                    button1.vertex = true;
                    bg.insert(button1);
                    var button2 = new mxCell('Menu Item 2', new mxGeometry(0, 12.5, 185, 12.5), inh + s + 'rrect;rSize=0;align=left;spacingLeft=10;fontSize=8;fontColor=#ffffff;');
                    button2.vertex = true;
                    bg.insert(button2);
                    var button3 = new mxCell('Menu Item 3', new mxGeometry(0, 25, 185, 12.5), inh + s + 'rrect;rSize=0;align=left;spacingLeft=10;fontSize=8;fontColor=#ffffff;');
                    button3.vertex = true;
                    bg.insert(button3);
                    var button4 = new mxCell('Menu Item 4', new mxGeometry(0, 37.5, 185, 12.5), inh + s + 'rrect;rSize=0;align=left;spacingLeft=10;fontSize=8;fontColor=#ffffff;');
                    button4.vertex = true;
                    bg.insert(button4);

                    return sb.createVertexTemplateFromCells([bg], bg.geometry.width, bg.geometry.height, 'Menu bar');
                }),

                this.addEntry(dt + 'menu bar', function () {
                    var bg = new mxCell('', new mxGeometry(0, 0, 185, 50), s + 'rrect;rSize=0;strokeColor=#eeeeee;fillColor=#ffffff;gradientColor=none;');
                    bg.vertex = true;
                    var button1 = new mxCell('Menu Item 1', new mxGeometry(0, 0, 185, 12.5), inh + s + 'rrect;rSize=0;align=left;spacingLeft=10;fontSize=8;fontColor=#333333;');
                    button1.vertex = true;
                    bg.insert(button1);
                    var button2 = new mxCell('Menu Item 2', new mxGeometry(0, 12.5, 185, 12.5), inh + s + 'rrect;rSize=0;align=left;spacingLeft=10;fontSize=8;fontColor=#333333;');
                    button2.vertex = true;
                    bg.insert(button2);
                    var button3 = new mxCell('Menu Item 3', new mxGeometry(0, 25, 185, 12.5), inh + s + 'rrect;rSize=0;align=left;spacingLeft=10;fontSize=8;fontColor=#333333;');
                    button3.vertex = true;
                    bg.insert(button3);
                    var button4 = new mxCell('Menu Item 4', new mxGeometry(0, 37.5, 185, 12.5), inh + s + 'rrect;rSize=0;align=left;spacingLeft=10;fontSize=8;fontColor=#333333;');
                    button4.vertex = true;
                    bg.insert(button4);

                    return sb.createVertexTemplateFromCells([bg], bg.geometry.width, bg.geometry.height, 'Menu bar');
                }),

                this.createVertexTemplateEntry(s6 + 'navigation_bar_1;fillColor=#1A1A1A;strokeColor=#999999;',
                    185, 30, '', 'Navigation Bar', null, null, dt + 'navigation bar portrait horizontal'),
                this.createVertexTemplateEntry(s6 + 'navigation_bar_1_landscape;fillColor=#1A1A1A;strokeColor=#999999;',
                    320, 30, '', 'Navigation Bar Landscape', null, null, dt + 'navigation bar landscape horizontal'),
                this.createVertexTemplateEntry(s6 + 'navigation_bar_1_vertical;fillColor=#1A1A1A;strokeColor=#999999;',
                    30, 320, '', 'Navigation Bar Vertical', null, null, dt + 'navigation bar vertical'),
                this.createVertexTemplateEntry(s6 + 'navigation_bar_2;fillColor=#1A1A1A;strokeColor=#999999;',
                    185, 30, '', 'Navigation Bar', null, null, dt + 'navigation bar horizontal'),
                this.createVertexTemplateEntry(s6 + 'navigation_bar_3;fillColor=#1A1A1A;strokeColor=#999999;',
                    185, 30, '', 'Navigation Bar', null, null, dt + 'navigation bar portrait horizontal'),
                this.createVertexTemplateEntry(s6 + 'navigation_bar_3_landscape;fillColor=#1A1A1A;strokeColor=#999999;',
                    320, 30, '', 'Navigation Bar Landscape', null, null, dt + 'navigation bar landscape horizontal'),
                this.createVertexTemplateEntry(s6 + 'navigation_bar_4;fillColor=#1A1A1A;strokeColor=#999999;',
                    185, 30, '', 'Navigation Bar', null, null, dt + 'navigation bar horizontal'),
                this.createVertexTemplateEntry(s6 + 'navigation_bar_5;fillColor=#1A1A1A;strokeColor=#999999;',
                    185, 30, '', 'Navigation Bar', null, null, dt + 'navigation bar horizontal'),
                this.createVertexTemplateEntry(s6 + 'navigation_bar_5_vertical;fillColor=#1A1A1A;strokeColor=#999999;',
                    30, 320, '', 'Navigation Bar Vertical', null, null, dt + 'navigation bar vertical'),
                this.createVertexTemplateEntry(s6 + 'navigation_bar_6;fillColor=#1A1A1A;strokeColor=#999999;',
                    185, 30, '', 'Navigation Bar', null, null, dt + 'navigation bar horizontal'),
                this.createVertexTemplateEntry(s2 + 'progressBar;strokeColor=#33b5e5;dx1=0.8;dx2=0.6;strokeWidth=2;',
                    185, 5, '', 'Progress Bar', null, null, dt + 'progress bar'),
                this.createVertexTemplateEntry(s2 + 'progressScrubberDisabled;dx=0.3;fillColor=#33b5e5;',
                    185, 16, '', 'Progress Scrubber Disabled', null, null, dt + 'progress scrubber disabled'),
                this.createVertexTemplateEntry(s2 + 'progressScrubberFocused;dx=0.3;fillColor=#33b5e5;',
                    185, 16, '', 'Progress Scrubber Focused', null, null, dt + 'progress scrubber focused'),
                this.createVertexTemplateEntry(s2 + 'progressScrubberPressed;dx=0.3;fillColor=#33b5e5;',
                    185, 16, '', 'Progress Scrubber Pressed', null, null, dt + 'progress scrubber pressed'),
                this.createVertexTemplateEntry(s2 + 'quickscroll2;dy=0.5;fillColor=#33b5e5;strokeColor=#66D5F5;',
                    58, 320, '', 'Quickscroll', null, null, dt + 'quickscroll quick scroll'),

                this.createVertexTemplateEntry(s2 + 'quickscroll3;dy=0.5;fillColor=#33b5e5;strokeColor=#66D5F5;',
                    6, 320, '', 'Quickscroll', null, null, dt + 'quickscroll quick scroll'),

                this.addEntry(dt + 'quick contact', function () {
                    var bg = new mxCell('', new mxGeometry(0, 0, 150, 165), s + 'quick_contact;');
                    bg.vertex = true;
                    var text1 = new mxCell('Name', new mxGeometry(0, 65, 150, 18), s + 'anchor;rSize=0;fontStyle=1;fontColor=#FFFFFF;');
                    text1.vertex = true;
                    bg.insert(text1);
                    var text2 = new mxCell('Item 1', new mxGeometry(0, 108, 120, 28), s + 'anchor;rSize=0;align=left;spacingLeft=10;');
                    text2.vertex = true;
                    bg.insert(text2);
                    var text3 = new mxCell('Item 2', new mxGeometry(0, 136, 120, 28), s + 'anchor;rSize=0;align=left;spacingLeft=10;');
                    text3.vertex = true;
                    bg.insert(text3);

                    return sb.createVertexTemplateFromCells([bg], bg.geometry.width, bg.geometry.height, 'Quick Contact');
                }),

                this.addEntry(dt + 'scrollable tab scroll', function () {
                    var bg = new mxCell('', new mxGeometry(0, 0, 185, 15), s + 'rrect;rSize=0;fillColor=#444444;strokeColor=none;');
                    bg.vertex = true;
                    var text1 = new mxCell('One', new mxGeometry(0, 0, 46.25, 15), s + 'anchor;align=left;fontColor=#FFFFFF;');
                    text1.vertex = true;
                    bg.insert(text1);
                    var text2 = new mxCell('Tab Two', new mxGeometry(46.25, 0, 92.5, 15), s + 'anchor;fontColor=#FFFFFF;');
                    text2.vertex = true;
                    bg.insert(text2);
                    var text3 = new mxCell('Tab', new mxGeometry(138.75, 0, 46.25, 15), s + 'anchor;align=right;fontColor=#FFFFFF;');
                    text3.vertex = true;
                    bg.insert(text3);

                    return sb.createVertexTemplateFromCells([bg], bg.geometry.width, bg.geometry.height, 'Scrollable Tab');
                }),

                this.createVertexTemplateEntry(s + 'scrollbars2;fillColor=#999999;strokeColor=none;',
                    56, 56, '', 'Scrollbars', null, null, dt + 'scrollbar scroll bar'),
                this.createVertexTemplateEntry(s5 + '1A1A1A;strokeColor=#1A1A1A;fontColor=#FFFFFF;',
                    sizeX * 0.8, sizeY * 0.04, 'Normal', 'Section Header (Normal)', null, null, dt + 'section header normal dark'),
                this.createVertexTemplateEntry(s5 + '4D4D4D;strokeColor=#4D4D4D;fontColor=#FFFFFF;',
                    sizeX * 0.8, sizeY * 0.04, 'Pressed', 'Section Header (Pressed)', null, null, dt + 'section header pressed dark'),
                this.createVertexTemplateEntry(s5 + '33b5e5;strokeColor=#33B5E5;fontColor=#FFFFFF;',
                    sizeX * 0.8, sizeY * 0.04, 'Activated', 'Section Header (Activated)', null, null, dt + 'section header activated dark'),
                this.createVertexTemplateEntry(s5 + '006699;strokeColor=#33B5E5;fontColor=#FFFFFF;',
                    sizeX * 0.8, sizeY * 0.04, 'Focused', 'Section Header (Focused)', null, null, dt + 'section header focused dark'),
                this.createVertexTemplateEntry(s5 + '006699;strokeColor=#33B5E5;fontColor=#B3B3B3;',
                    sizeX * 0.8, sizeY * 0.04, 'Disabled focused', 'Section Header (Disabled focused)', null, null, dt + 'section header disabled focused dark'),
                this.createVertexTemplateEntry(s5 + '1A1A1A;strokeColor=#1A1A1A;fontColor=#B3B3B3;',
                    sizeX * 0.8, sizeY * 0.04, 'Disabled', 'Section Header (Disabled)', null, null, dt + 'section header disabled dark'),
                this.createVertexTemplateEntry(s5 + 'FFFFFF;strokeColor=#FFFFFF;fontColor=#4D4D4D;',
                    sizeX * 0.8, sizeY * 0.04, 'Normal', 'Section Header (Normal, Bright)', null, null, dt + 'section header normal bright'),
                this.createVertexTemplateEntry(s5 + 'f6f6f6;strokeColor=#f6f6f6;fontColor=#4D4D4D;',
                    sizeX * 0.8, sizeY * 0.04, 'Pressed', 'Section Header (Pressed, Bright)', null, null, dt + 'section header pressed bright'),
                this.createVertexTemplateEntry(s5 + '33b5e5;strokeColor=#33B5E5;fontColor=#4D4D4D;',
                    sizeX * 0.8, sizeY * 0.04, 'Activated', 'Section Header (Activated, Bright)', null, null, dt + 'section header activated bright'),
                this.createVertexTemplateEntry(s5 + '99e5ff;strokeColor=#33B5E5;fontColor=#4D4D4D;',
                    sizeX * 0.8, sizeY * 0.04, 'Focused', 'Section Header (Focused, Bright)', null, null, dt + 'section header focused bright'),
                this.createVertexTemplateEntry(s5 + '99e5ff;strokeColor=#33B5E5;fontColor=#B3B3B3;',
                    sizeX * 0.8, sizeY * 0.04, 'Disabled focused', 'Section Header (Disabled focused, Bright)', null, null, dt + 'section header disabled focused bright'),
                this.createVertexTemplateEntry(s5 + 'FFFFFF;strokeColor=#FFFFFF;fontColor=#B3B3B3;',
                    sizeX * 0.8, sizeY * 0.04, 'Disabled', 'Section Header (Disabled, Bright)', null, null, dt + 'section header disabled bright'),
                this.createVertexTemplateEntry(s + 'spinner2;align=center;fillColor=#999999;strokeColor=#999999;verticalAlign=bottom',
                    110, 10, 'Item', 'Spinner Normal', null, null, dt + 'spinner normal'),
                this.createVertexTemplateEntry(s + 'spinner2;align=center;fillColor=#33b5e5;strokeColor=#33b5e5;verticalAlign=bottom',
                    110, 10, 'Item', 'Spinner Focused', null, null, dt + 'spinner focused'),

                this.addEntry(dt + 'spinner disabled focused', function () {
                    var bg = new mxCell('', new mxGeometry(0, 0, 117, 28), s + 'rect;rounded=1;fillColor=#207585;strokeColor=#33b5e5;');
                    bg.vertex = true;
                    var text1 = new mxCell('Item', new mxGeometry(3, 4, 110, 20), s + 'spinner2;fontStyle=1;fontColor=#ffffff;align=center;verticalAlign=middle;strokeColor=#999999;fillColor=#999999;');
                    text1.vertex = true;
                    bg.insert(text1);

                    return sb.createVertexTemplateFromCells([bg], bg.geometry.width, bg.geometry.height, 'Spinner Disabled Focused');
                }),

                this.addEntry(dt + 'spinner disabled focused light bright', function () {
                    var bg = new mxCell('', new mxGeometry(0, 0, 117, 28), s + 'rect;rounded=1;fillColor=#ccf2ff;strokeColor=#88c5f5;');
                    bg.vertex = true;
                    var text1 = new mxCell('Item', new mxGeometry(3, 4, 110, 20), s + 'spinner2;fontStyle=0;fontColor=#666666;align=center;verticalAlign=middle;strokeColor=#cccccc;fillColor=#cccccc;');
                    text1.vertex = true;
                    bg.insert(text1);

                    return sb.createVertexTemplateFromCells([bg], bg.geometry.width, bg.geometry.height, 'Spinner Disabled Focused Bright');
                }),

                this.addEntry(dt + 'spinner pressed', function () {
                    var bg = new mxCell('', new mxGeometry(0, 0, 117, 28), s + 'rect;rounded=1;fillColor=#33b5e5;strokeColor=#33b5e5;');
                    bg.vertex = true;
                    var text1 = new mxCell('Item', new mxGeometry(3, 4, 110, 20), s + 'spinner2;fontStyle=0;fontColor=#ffffff;align=center;verticalAlign=middle;strokeColor=#aaeeff;fillColor=#aaeeff;');
                    text1.vertex = true;
                    bg.insert(text1);

                    return sb.createVertexTemplateFromCells([bg], bg.geometry.width, bg.geometry.height, 'Spinner Pressed');
                }),

                this.addEntry(dt + 'spinner pressed light bright', function () {
                    var bg = new mxCell('', new mxGeometry(0, 0, 117, 28), s + 'rect;rounded=1;fillColor=#33b5e5;strokeColor=#33b5e5;');
                    bg.vertex = true;
                    var text1 = new mxCell('Item', new mxGeometry(3, 4, 110, 20), s + 'spinner2;fontStyle=0;fontColor=#ffffff;align=center;verticalAlign=middle;strokeColor=#666666;fillColor=#666666;');
                    text1.vertex = true;
                    bg.insert(text1);

                    return sb.createVertexTemplateFromCells([bg], bg.geometry.width, bg.geometry.height, 'Spinner Pressed Bright');
                }),

                this.addEntry(dt + 'split action bar dark', function () {
                    var bg = new mxCell('', new mxGeometry(0, 0, 185, 70), s + 'split_action_bar;fillColor=#1A1A1A;');
                    bg.vertex = true;
                    var text1 = new mxCell('Split', new mxGeometry(0, 0, 185, 30), s + 'anchor;fontStyle=1;fontColor=#ffffff;');
                    text1.vertex = true;
                    bg.insert(text1);
                    var text2 = new mxCell('Action', new mxGeometry(0, 40, 185, 30), s + 'anchor;fontStyle=1;fontColor=#ffffff;');
                    text2.vertex = true;
                    bg.insert(text2);

                    return sb.createVertexTemplateFromCells([bg], bg.geometry.width, bg.geometry.height, 'Split Action Bar');
                }),

                this.addEntry(dt + 'split action bar bright', function () {
                    var bg = new mxCell('', new mxGeometry(0, 0, 185, 70), s + 'split_action_bar;fillColor=#E6E6E6;');
                    bg.vertex = true;
                    var text1 = new mxCell('Split', new mxGeometry(0, 0, 185, 30), s + 'anchor;fontStyle=1;');
                    text1.vertex = true;
                    bg.insert(text1);
                    var text2 = new mxCell('Action', new mxGeometry(0, 40, 185, 30), s + 'anchor;fontStyle=1;');
                    text2.vertex = true;
                    bg.insert(text2);

                    return sb.createVertexTemplateFromCells([bg], bg.geometry.width, bg.geometry.height, 'Split Action Bar (Bright)');
                }),

                this.addEntry(dt + 'split action bar landscape dark', function () {
                    var bg = new mxCell('', new mxGeometry(0, 0, 320, 70), s + 'split_action_bar_landscape;fillColor=#1A1A1A;');
                    bg.vertex = true;
                    var text1 = new mxCell('Split', new mxGeometry(0, 0, 320, 30), s + 'anchor;fontStyle=1;fontColor=#ffffff;');
                    text1.vertex = true;
                    bg.insert(text1);
                    var text2 = new mxCell('Action', new mxGeometry(0, 40, 320, 30), s + 'anchor;fontStyle=1;fontColor=#ffffff;');
                    text2.vertex = true;
                    bg.insert(text2);

                    return sb.createVertexTemplateFromCells([bg], bg.geometry.width, bg.geometry.height, 'Split Action Bar Landscape');
                }),

                this.addEntry(dt + 'split action bar landscape bright', function () {
                    var bg = new mxCell('', new mxGeometry(0, 0, 320, 70), s + 'split_action_bar_landscape;fillColor=#E6E6E6;');
                    bg.vertex = true;
                    var text1 = new mxCell('Split', new mxGeometry(0, 0, 320, 30), s + 'anchor;fontStyle=1;');
                    text1.vertex = true;
                    bg.insert(text1);
                    var text2 = new mxCell('Action', new mxGeometry(0, 40, 320, 30), s + 'anchor;fontStyle=1;');
                    text2.vertex = true;
                    bg.insert(text2);

                    return sb.createVertexTemplateFromCells([bg], bg.geometry.width, bg.geometry.height, 'Split Action Bar Landscape (Bright)');
                }),

                this.createVertexTemplateEntry(s + 'statusBar;align=center;fillColor=#000000;strokeColor=#ffffff;fontColor=#ffffff;fontSize=10;',
                    sizeX * 0.87, sizeY * 0.0375, '', 'Status bar (portrait)', null, null, dt + 'status bar portrait'),
                this.createVertexTemplateEntry(s + 'statusBar;align=center;fillColor=#000000;strokeColor=#ffffff;fontColor=#ffffff;fontSize=10;',
                    sizeX * 1.517, sizeY * 0.0375, '', 'Status bar (landscape)', null, null, dt + 'status bar landscape'),
                this.createVertexTemplateEntry(s2 + 'switch_off;fillColor=#666666;',
                    80, 20, '', 'Switch Off', null, null, dt + 'switch off'),
                this.createVertexTemplateEntry(s2 + 'switch_off;fillColor=#E6E6E6;',
                    80, 20, '', 'Switch Off', null, null, dt + 'switch off'),
                this.createVertexTemplateEntry(s2 + 'switch_on;fillColor=#666666;',
                    80, 20, '', 'Switch On', null, null, dt + 'switch on'),
                this.createVertexTemplateEntry(s2 + 'switch_on;fillColor=#E6E6E6;',
                    80, 20, '', 'Switch On', null, null, dt + 'switch on'),
                this.addDataEntry(dt + 'tab tabulator bar dark', 185, 30, 'Tab Bar Dark',
                    '3ZZfb8IgEMA/Da8NhdY/r+02n/bkkj1jQSGjxVCc7T79KMVpp81qnG6RhIS744D7cVwAOM2rmSZr/qwokwA/ApxqpUw7yquUSQkQFBTgB4AQtB2gpx5r6KxwTTQrzBAH1Dq8E7lhraZVlKaWXlEard7Yq6CGW0UIcMJNLv2w5ISqrRWgFSgpOaNesJZ1s0JerZroAlJQrQQNtGaZPVqi5+KD+blLIWWqpNJuRxy51qzhtt5ZClVYh8SfmGnDqt6oncqHPGMqZ0bXdsrWR9HMmMStG2dixb0bbmlBUrby6st1z9AOPMbTSPER0heysIrw2mRJkfEGVLJUhZn7bUIvH+BdujaUJPqRZDQK0JVYRj0s/yZLv2PtZi2E02mW9WXtNe6gOuJ/m1uJ/2PRwHgRs/iiohGdxlz7SxgPZnw54lFP4uO7KiLeYYqCm+bvuAdudI9wQzwJxjfFOxlQHjwgKdzr7D7ZQwBUNC9fqMLqS7VpTv87UMJdytWdmnb4QYDHeND5eKy4/845W+e39wk='),
                this.addDataEntry(dt + 'tab tabulator bar dark', 185, 30, 'Tab Bar Dark',
                    '3ZZRb4MgEIB/Da9GQdvuVbf1aU9dsmdaaCFDaZCuul8/1OtqV81cOrulJCbcHQfcx3k5RJK0mBu6FU+acYXIAyKJ0do2s7RIuFII+5Ihco8w9t2H8GOPNait/pYantkhDrhxeKNqxxtNo8htqUCRW6Nf+YtkVjhFgEgsbKpgmgvK9N4JvhMYzQVnIDjLttohLTZVdB7NmNGSecbwlbtabBbyncPatVQq0Uqb+kQS1qPaoz76YMl05hxiuDE3lhe9UdcqCHnOdcqtKd2SPURRrZhFjZvgciPAjTS0fJo38ubT9cjQTQBjN1JyhvSZLp0iGJsszVaiAhWvdWYXcEwAcgvvuh5DSeJvSYYTD4/EMuxh+TdZ+hVrK2shNzsTdgz8xRn66zxI9B/rBSHLiEcX1YuwG3MJjzAdzPhyxJOenCc3VT/A4Q57V83faQ/c8BbhBmTmTa+KdzagPAAgJTsqZhsAk9WfL3Xm9LneVbf/HSjBIeXKk5rW7g38czz453iceOzkattJo/cB'),
                this.addDataEntry(dt + 'tab tabulator bar bright', 185, 30, 'Tab Bar Bright',
                    '3ZZfb4MgEMA/Da9GQdvutW7r0566ZM+0YCFDaJCuuk8/QLr+cWYuXbulJCbcHSfc784TgPKynmm8Zk+KUAHQA0C5Vsq0s7LOqRAAxpwAdA8gjO0D4GOPNfHWeI01lWaIA2wd3rDY0FbTKirTiKCojFav9IUTw6wiAWjKTCnCtGKYqK0VYisQXDFKgmAta/eGsl656CIsiVacRFrTpT3aVM/5Ow1rCy5EroTSfkdE/XDv8FvvLFJJpwwnptrQujdqrwohz6gqqdGNXbINUbgVk6x1Y5SvWHBDLa0YV628+nTdM7STgPFrpKiD9BkvrCK5NFksl8yBmhZKmnnYJgnyAd6RH0NJwm9JpqMIXohl2sPyb6r0FOtx1abpMiuyvqo9yUHhx5k5qDv8r5OV7D82DYQWGe3FPwhz+jXmJiRhPJjx+YhHPYWPbqqJBIc7GF21fsc9cNNbhJugSTS+Kt7JgPYQAAkuu//5QwCEuy+fK2n1ldq40/8OlGRXcs1RTzu8IMRdPPDneKy4v85529Ft7wM='),
                this.addDataEntry(dt + 'tab tabulator bar bright', 185, 30, 'Tab Bar Bright',
                    '3Zbfb8IgEMf/Gl6bFlp1r3abT3tyyZ5RUMhoMRRnu79+0J6zzjbr4nSLJE2473H8+HC9gEialTNDN+JJM64QeUAkNVrbppeVKVcK4VAyRO4RxqH7EH7s8Ua1N9xQw3M7JAA3AW9UbXmjNEJhKwVCYY1+5S+SWeGECJGpsJmCbiEo0ztnhM5gtBCcgeE8Gz9DVq796QKaM6MlC4zhS7e1qZnLdw5jV1KpVCtt6hUJr5ufo15678l17kXYMTeWl72nriU48ozrjFtTuSE7OIUfMUmaMMHlWkAYaWiFtGjs9WfogaHrAMZupOQE6TNdOCG6NFmaL4UHNV3p3M5hmQjsFt5R3YaSxN+SjEcBvhDLuIfl32TpV6ytrIXc7EzYS+AvT9Bf50KS/1gvCFkkPDmrXsTdmCu4hPFgxucjHvXkPLmp+gEBdzi4av6Oe+DGtwg3IpNgfFW8kwHlAQAp2VEx2wCY9H++1LnTC731u/8dKNE+5aqjmtZ+G4SnePDP8Tjz8JKrfUcPvQ8='),

                this.createVertexTemplateEntry(s + 'textfield;align=center;strokeColor=#4D4D4D;pointerEvents=1',
                    174, 30, '', 'Textfield Disabled', null, null, dt + 'textfield disabled'),
                this.createVertexTemplateEntry(s + 'textfield;align=center;strokeColor=#999999;pointerEvents=1',
                    174, 30, '', 'Textfield Normal', null, null, dt + 'textfield normal'),
                this.createVertexTemplateEntry(s + 'textfield;align=center;strokeColor=#33b5e5;pointerEvents=1',
                    174, 30, '', 'Textfield Activated', null, null, dt + 'textfield activated'),
                this.createVertexTemplateEntry(s2 + 'text_insertion_point;',
                    20, 30, '', 'Text Insertion Point', null, null, dt + 'textfield insertion point'),
                this.createVertexTemplateEntry(s2 + 'textSelHandles;fillColor=#33b5e5;strokeColor=#0099cc;',
                    sizeX * 0.8, sizeY * 0.1, '', 'Text Selection Handles', null, null, dt + 'text selection handle'),
                this.createVertexTemplateEntry(s2 + 'time_picker;',
                    150, 230, '', 'Time Picker (Bright)', null, null, dt + 'time picker bright'),
                this.createVertexTemplateEntry(s2 + 'time_picker_dark;',
                    150, 230, '', 'Time Picker (Dark)', null, null, dt + 'time picker dark'),
                this.createVertexTemplateEntry(s3 + 'rect;fillColor=#33b5e5;',
                    50, 50, '', 'Color', null, null, dt + 'color'),
                this.createVertexTemplateEntry(s3 + 'rect;fillColor=#0099cc;',
                    50, 50, '', 'Color', null, null, dt + 'color'),
                this.createVertexTemplateEntry(s3 + 'rect;fillColor=#aa66cc;',
                    50, 50, '', 'Color', null, null, dt + 'color'),
                this.createVertexTemplateEntry(s3 + 'rect;fillColor=#9933cc;',
                    50, 50, '', 'Color', null, null, dt + 'color'),
                this.createVertexTemplateEntry(s3 + 'rect;fillColor=#99cc00;',
                    50, 50, '', 'Color', null, null, dt + 'color'),
                this.createVertexTemplateEntry(s3 + 'rect;fillColor=#669900;',
                    50, 50, '', 'Color', null, null, dt + 'color'),
                this.createVertexTemplateEntry(s3 + 'rect;fillColor=#ffbb33;',
                    50, 50, '', 'Color', null, null, dt + 'color'),
                this.createVertexTemplateEntry(s3 + 'rect;fillColor=#ff8800;',
                    50, 50, '', 'Color', null, null, dt + 'color'),
                this.createVertexTemplateEntry(s3 + 'rect;fillColor=#ff4444;',
                    50, 50, '', 'Color', null, null, dt + 'color'),
                this.createVertexTemplateEntry(s3 + 'rect;fillColor=#cc0000;',
                    50, 50, '', 'Color', null, null, dt + 'color')
            ];

        this.addPalette('android', mxResources.get('android'), false, mxUtils.bind(this, function (content) {
            for (var i = 0; i < fns.length; i++) {
                content.appendChild(fns[i](content));
            }
        }));
    };

})();

(function () {
    // Adds Arrow shapes with control points
    Sidebar.prototype.addArrows2Palette = function () {
        var s = 'html=1;shadow=0;dashed=0;align=center;verticalAlign=middle;shape=mxgraph.arrows2.';
        var s2 = 'html=1;shadow=0;dashed=0;fillColor=none;strokeColor=none;shape=mxgraph.arrows2.';
        var gn = 'mxgraph.arrows2';
        var dt = 'arrow ';
        var sb = this;

        var fns = [
            this.createVertexTemplateEntry(s + 'arrow;dy=0.6;dx=40;notch=0;',
                100, 70, '', 'Arrow Right', null, null, this.getTagsForStencil(gn, 'arrow', dt + 'right').join(' ')),
            this.createVertexTemplateEntry(s + 'arrow;dy=0.6;dx=40;flipH=1;notch=0;',
                100, 70, '', 'Arrow Left', null, null, this.getTagsForStencil(gn, 'arrow', dt + 'leftt').join(' ')),
            this.createVertexTemplateEntry(s + 'arrow;dy=0.6;dx=40;direction=north;notch=0;',
                70, 100, '', 'Arrow Up', null, null, this.getTagsForStencil(gn, 'arrow', dt + 'up').join(' ')),
            this.createVertexTemplateEntry(s + 'arrow;dy=0.6;dx=40;direction=south;notch=0;',
                70, 100, '', 'Arrow Down', null, null, this.getTagsForStencil(gn, 'arrow', dt + 'down').join(' ')),
            this.createVertexTemplateEntry(s + 'arrow;dy=0;dx=30;notch=30;',
                100, 60, '', 'Chevron Arrow', null, null, this.getTagsForStencil(gn, 'arrow', dt + 'chevron').join(' ')),
            this.createVertexTemplateEntry(s + 'arrow;dy=0.6;dx=40;notch=15;',
                100, 70, '', 'Notched Arrow', null, null, this.getTagsForStencil(gn, 'arrow', dt + 'notched').join(' ')),
            this.createVertexTemplateEntry(s + 'arrow;dy=0;dx=10;notch=10;',
                100, 30, '', 'Notched Signal-In Arrow', null, null, this.getTagsForStencil(gn, 'arrow', dt + 'notched signal in').join(' ')),
            this.createVertexTemplateEntry(s + 'arrow;dy=0;dx=10;notch=0;',
                100, 30, '', 'Signal-In Arrow', null, null, this.getTagsForStencil(gn, 'arrow', dt + 'signal in').join(' ')),
            this.createVertexTemplateEntry(s + 'arrow;dy=0.67;dx=20;notch=0;',
                100, 60, '', 'Slender Arrow', null, null, this.getTagsForStencil(gn, 'arrow', dt + 'slender').join(' ')),
            this.createVertexTemplateEntry(s + 'twoWayArrow;dy=0.6;dx=35;',
                100, 60, '', 'Two Way Arrow', null, null, this.getTagsForStencil(gn, 'arrow', dt + 'two way').join(' ')),
            this.createVertexTemplateEntry(s + 'twoWayArrow;dy=0.65;dx=22;',
                100, 60, '', 'Slender Two Way Arrow', null, null, this.getTagsForStencil(gn, 'arrow', dt + 'slender two way').join(' ')),
            this.createVertexTemplateEntry(s + 'stylisedArrow;dy=0.6;dx=40;notch=15;feather=0.4;',
                100, 60, '', 'Stylised Arrow', null, null, this.getTagsForStencil(gn, 'arrow', dt + 'stylised notch notched').join(' ')),
            this.createVertexTemplateEntry(s + 'sharpArrow;dy1=0.67;dx1=18;dx2=18;notch=0;',
                100, 60, '', 'Sharp Arrow', null, null, this.getTagsForStencil(gn, 'arrow', dt + 'sharp').join(' ')),
            this.createVertexTemplateEntry(s + 'sharpArrow2;dy1=0.67;dx1=18;dx2=18;dy3=0.15;dx3=27;notch=0;',
                100, 60, '', 'Sharp Arrow', null, null, this.getTagsForStencil(gn, 'arrow', dt + 'sharp').join(' ')),
            this.createVertexTemplateEntry(s + 'calloutArrow;dy=10;dx=20;notch=60;arrowHead=10;',
                100, 60, '', 'Callout with Arrow', null, null, this.getTagsForStencil(gn, 'arrow', dt + 'callout').join(' ')),
            this.createVertexTemplateEntry(s + 'bendArrow;dy=15;dx=38;notch=0;arrowHead=55;rounded=0;',
                100, 100, '', 'Bend Arrow', null, null, this.getTagsForStencil(gn, 'arrow', dt + 'bend').join(' ')),
            this.createVertexTemplateEntry(s + 'bendArrow;dy=15;dx=38;notch=0;arrowHead=55;rounded=1;',
                100, 100, '', 'Bend Arrow (rounded)', null, null, this.getTagsForStencil(gn, 'arrow', dt + 'bend rounded').join(' ')),
            this.createVertexTemplateEntry(s + 'bendDoubleArrow;dy=15;dx=38;arrowHead=55;rounded=0;',
                100, 100, '', 'Bend Double Arrow', null, null, this.getTagsForStencil(gn, 'arrow', dt + 'bend double two way').join(' ')),
            this.createVertexTemplateEntry(s + 'bendDoubleArrow;dy=15;dx=38;arrowHead=55;rounded=1;',
                100, 100, '', 'Bend Double Arrow', null, null, this.getTagsForStencil(gn, 'arrow', dt + 'bend double two way').join(' ')),
            this.createVertexTemplateEntry(s + 'calloutDoubleArrow;dy=10;dx=20;notch=24;arrowHead=10;',
                100, 50, '', 'Callout with Double Arrow', null, null, this.getTagsForStencil(gn, 'arrow', dt + 'callout double two way').join(' ')),
            this.createVertexTemplateEntry(s + 'calloutQuadArrow;dy=10;dx=20;notch=24;arrowHead=10;',
                100, 100, '', 'Callout with Quad Arrow', null, null, this.getTagsForStencil(gn, 'arrow', dt + 'callout quad four war').join(' ')),
            this.createVertexTemplateEntry(s + 'calloutDouble90Arrow;dy1=10;dx1=20;dx2=70;dy2=70;arrowHead=10;',
                100, 100, '', 'Callout with Double Arrow 90' + String.fromCharCode(176), null, null, this.getTagsForStencil(gn, 'arrow', dt + 'callout double two way orthogonal').join(' ')),
            this.createVertexTemplateEntry(s + 'quadArrow;dy=10;dx=20;notch=24;arrowHead=10;',
                100, 100, '', 'Quad Arrow', null, null, this.getTagsForStencil(gn, 'arrow', dt + 'four way quad').join(' ')),
            this.createVertexTemplateEntry(s + 'triadArrow;dy=10;dx=20;arrowHead=40;',
                100, 70, '', 'Triad Arrow', null, null, this.getTagsForStencil(gn, 'arrow', dt + 'three way triad').join(' ')),
            this.createVertexTemplateEntry(s + 'tailedArrow;dy1=10;dx1=20;notch=0;arrowHead=20;dx2=25;dy2=30;',
                100, 60, '', 'Tailed Arrow', null, null, this.getTagsForStencil(gn, 'arrow', dt + 'tailed').join(' ')),
            this.createVertexTemplateEntry(s + 'tailedNotchedArrow;dy1=10;dx1=20;notch=20;arrowHead=20;dx2=25;dy2=30;',
                100, 60, '', 'Tailed Arrow with Notch', null, null, this.getTagsForStencil(gn, 'arrow', dt + 'tailed notch notched').join(' ')),
            this.createVertexTemplateEntry(s + 'stripedArrow;dy=0.6;dx=40;notch=25;',
                100, 70, '', 'Striped Arrow', null, null, this.getTagsForStencil(gn, 'arrow', dt + 'striped').join(' ')),
            this.createVertexTemplateEntry(s + 'jumpInArrow;dy=15;dx=38;arrowHead=55;',
                100, 100, '', 'Jump-In Arrow', null, null, this.getTagsForStencil(gn, 'arrow', dt + 'jump in').join(' ')),
            this.createVertexTemplateEntry(s + 'uTurnArrow;dy=11;arrowHead=43;dx2=25;',
                100, 100, '', 'U Turn Arrow', null, null, this.getTagsForStencil(gn, 'arrow', dt + 'u turn uturn').join(' '))
        ];

        this.addPalette('arrows2', mxResources.get('arrows'), false, mxUtils.bind(this, function (content) {
            for (var i = 0; i < fns.length; i++) {
                content.appendChild(fns[i](content));
            }
        }));
    };

})();

(function () {
    Sidebar.prototype.addAzurePalette = function () {
        var w = 50;
        var h = 50;
        var s = mxConstants.STYLE_VERTICAL_LABEL_POSITION + '=bottom;html=1;' + mxConstants.STYLE_VERTICAL_ALIGN + '=top;align=center;strokeColor=none;fillColor=#00BEF2;shape=mxgraph.azure.';
        var gn = 'mxgraph.azure';
        var dt = '';

        this.addPaletteFunctions('azure', mxResources.get('azure'), false,
            [
                this.createVertexTemplateEntry(s + 'access_control;', w, h, '', 'Access Control', null, null, this.getTagsForStencil(gn, 'access_control', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'automation;pointerEvents=1;', w, h * 0.9, '', 'Automation', null, null, this.getTagsForStencil(gn, 'automation', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'autoscale;', w, h * 0.6, '', 'AutoScale', null, null, this.getTagsForStencil(gn, 'autoscale', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'azure_active_directory;', w * 0.95, h, '', 'Azure Active Directory', null, null, this.getTagsForStencil(gn, 'azure_active_directory', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'azure_alert;', w, h * 0.85, '', 'Azure Alert', null, null, this.getTagsForStencil(gn, 'azure_alert', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'azure_cache;', w * 0.9, h, '', 'Azure Cache', null, null, this.getTagsForStencil(gn, 'azure_cache', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'azure_instance;', w, h, '', 'Azure Instance', null, null, this.getTagsForStencil(gn, 'azure_instance', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'azure_load_balancer;', w, h * 0.7, '', 'Azure Load Balancer', null, null, this.getTagsForStencil(gn, 'azure_load_balancer', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'azure_marketplace;', w * 0.8, h, '', 'Azure Marketplace', null, null, this.getTagsForStencil(gn, 'azure_marketplace', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'azure_sdk;', w, h * 0.95, '', 'Azure SDK', null, null, this.getTagsForStencil(gn, 'azure_sdk', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'azure_subscription;', w, h * 0.7, '', 'Azure Subscription', null, null, this.getTagsForStencil(gn, 'azure_subscription', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'azure_website;pointerEvents=1;', w, h, '', 'Azure Website', null, null, this.getTagsForStencil(gn, 'azure_website', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'backup_service;', w, h * 0.9, '', 'Backup Service', null, null, this.getTagsForStencil(gn, 'backup_service', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'bitbucket_code_source;', w * 0.85, h, '', 'BitBucket Code Source', null, null, this.getTagsForStencil(gn, 'bitbucket_code_source', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'biztalk_services;', w, h, '', 'BizTalk Services', null, null, this.getTagsForStencil(gn, 'biztalk_services', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'certificate;pointerEvents=1;', w, h * 0.8, '', 'Certificate', null, null, this.getTagsForStencil(gn, 'certificate', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'cloud;', w, h * 0.65, '', 'Cloud', null, null, this.getTagsForStencil(gn, 'cloud', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'cloud_service;', w, h * 0.8, '', 'Cloud Service', null, null, this.getTagsForStencil(gn, 'cloud_service', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'cloud_services_configuration_file;pointerEvents=1;', w * 0.95, h, '', 'Cloud Services Configuration File', null, null, this.getTagsForStencil(gn, 'cloud_services_configuration_file', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'cloud_service_package_file;', w * 0.85, h, '', 'Cloud Service Package File', null, null, this.getTagsForStencil(gn, 'cloud_service_package_file', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'codeplex_code_source;', w, h * 0.75, '', 'CodePlex Code Source', null, null, this.getTagsForStencil(gn, 'codeplex_code_source', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'code_file;pointerEvents=1;', w * 0.95, h, '', 'Code File', null, null, this.getTagsForStencil(gn, 'code_file', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'computer;pointerEvents=1;', w, h * 0.9, '', 'Computer', null, null, this.getTagsForStencil(gn, 'computer', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'content_delivery_network;', w, h * 0.65, '', 'Content Delivery Network', null, null, this.getTagsForStencil(gn, 'content_delivery_network', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'database;', w * 0.75, h, '', 'Database', null, null, this.getTagsForStencil(gn, 'database', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'dropbox_code_source;', w, h * 0.95, '', 'DropBox Code Source', null, null, this.getTagsForStencil(gn, 'dropbox_code_source', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'enterprise;pointerEvents=1;', w * 0.6, h, '', 'Enterprise', null, null, this.getTagsForStencil(gn, 'enterprise', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'express_route;pointerEvents=1;', w, h * 0.6, '', 'Express Route', null, null, this.getTagsForStencil(gn, 'express_route', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'file;pointerEvents=1;', w * 0.95, h, '', 'File', null, null, this.getTagsForStencil(gn, 'file', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'file_2;pointerEvents=1;', w * 0.95, h, '', 'File 2', null, null, this.getTagsForStencil(gn, 'file_2', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'github_code;pointerEvents=1;', w, h, '', 'GitHub Code', null, null, this.getTagsForStencil(gn, 'github_code', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'git_repository;', w, h, '', 'Git Repository', null, null, this.getTagsForStencil(gn, 'git_repository', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'hdinsight;', w, h, '', 'HDInsight', null, null, this.getTagsForStencil(gn, 'hdinsight', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'healthy;', w, h * 0.9, '', 'Healthy', null, null, this.getTagsForStencil(gn, 'healthy', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'health_monitoring;', w, h * 0.85, '', 'Health Monitoring', null, null, this.getTagsForStencil(gn, 'health_monitoring', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'hyper_v_recovery_manager;', w, h * 0.9, '', 'Hyper-V Recovery Manager', null, null, this.getTagsForStencil(gn, 'hyper_v_recovery_manager', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'laptop;pointerEvents=1;', w, h * 0.6, '', 'Laptop', null, null, this.getTagsForStencil(gn, 'laptop', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'load_balancer_generic;pointerEvents=1;', w * 0.75, h, '', 'Load Balancer Generic', null, null, this.getTagsForStencil(gn, 'load_balancer_generic', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'media_service;pointerEvents=1;', w * 0.9, h, '', 'Media Service', null, null, this.getTagsForStencil(gn, 'media_service', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'message;pointerEvents=1;', w, h * 0.75, '', 'Message', null, null, this.getTagsForStencil(gn, 'message', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'mobile;pointerEvents=1;', w * 0.7, h, '', 'Mobile', null, null, this.getTagsForStencil(gn, 'mobile', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'mobile_services;pointerEvents=1;', w * 0.65, h, '', 'Mobile Services', null, null, this.getTagsForStencil(gn, 'mobile_services', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'multi_factor_authentication;pointerEvents=1;', w * 0.5, h, '', 'Multi Factor Authentication', null, null, this.getTagsForStencil(gn, 'multi_factor_authentication', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'mysql_database;', w * 0.75, h, '', 'MySQL Database', null, null, this.getTagsForStencil(gn, 'mysql_database', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'notification_hub;pointerEvents=1;', w, h, '', 'Notification Hub', null, null, this.getTagsForStencil(gn, 'notification_hub', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'notification_topic;', w, h, '', 'Notification Topic', null, null, this.getTagsForStencil(gn, 'notification_topic', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'operating_system_image;', w, h, '', 'Operating System Image', null, null, this.getTagsForStencil(gn, 'operating_system_image', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'powershell_file;pointerEvents=1;', w, h, '', 'PowerShell File', null, null, this.getTagsForStencil(gn, 'powershell_file', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'queue_generic;pointerEvents=1;', w, h * 0.3, '', 'Queue Generic', null, null, this.getTagsForStencil(gn, 'queue_generic', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'rdp_remoting_file;pointerEvents=1;', w * 0.95, h, '', 'RDP Remoting File', null, null, this.getTagsForStencil(gn, 'rdp_remoting_file', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'scheduler;pointerEvents=1;', w * 0.8, h, '', 'Scheduler', null, null, this.getTagsForStencil(gn, 'scheduler', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'script_file;pointerEvents=1;', w * 0.95, h, '', 'Script File', null, null, this.getTagsForStencil(gn, 'script_file', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'server;', w, h * 0.3, '', 'Server', null, null, this.getTagsForStencil(gn, 'server', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'server_rack;', w, h, '', 'Server Rack', null, null, this.getTagsForStencil(gn, 'server_rack', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'service_bus;pointerEvents=1;', w * 0.9, h, '', 'Service Bus', null, null, this.getTagsForStencil(gn, 'service_bus', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'service_bus_queues;pointerEvents=1;', w * 0.85, h, '', 'Service Bus Queues', null, null, this.getTagsForStencil(gn, 'service_bus_queues', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'service_bus_relay;pointerEvents=1;', w * 0.8, h, '', 'Service Bus Relay', null, null, this.getTagsForStencil(gn, 'service_bus_relay', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'service_bus_topics_and_subscriptions;pointerEvents=1;', w * 0.9, h, '', 'Service Bus Topics and Subscriptions', null, null, this.getTagsForStencil(gn, 'service_bus_topics_and_subscriptions', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'service_endpoint;', w, h * 0.4, '', 'Service Endpoint', null, null, this.getTagsForStencil(gn, 'service_endpoint', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'sql_database;', w * 0.75, h, '', 'SQL Database', null, null, this.getTagsForStencil(gn, 'sql_database', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'sql_database_sql_azure;', w * 0.95, h, '', 'SQL Database SQL Azure', null, null, this.getTagsForStencil(gn, 'sql_database_sql_azure', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'sql_datasync;', w * 0.75, h, '', 'SQL DataSync', null, null, this.getTagsForStencil(gn, 'sql_datasync', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'sql_reporting;', w * 0.8, h, '', 'SQL Reporting', null, null, this.getTagsForStencil(gn, 'sql_reporting', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'startup_task;pointerEvents=1;', w * 0.95, h, '', 'Startup Task', null, null, this.getTagsForStencil(gn, 'startup_task', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'storage;pointerEvents=1;', w, h * 0.8, '', 'Storage', null, null, this.getTagsForStencil(gn, 'storage', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'storage_blob;', w, h * 0.9, '', 'Storage Blob', null, null, this.getTagsForStencil(gn, 'storage_blob', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'storage_queue;', w, h * 0.9, '', 'Storage Queue', null, null, this.getTagsForStencil(gn, 'storage_queue', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'storage_table;', w, h * 0.9, '', 'Storage Table', null, null, this.getTagsForStencil(gn, 'storage_table', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'storsimple;', w, h * 0.9, '', 'StorSimple', null, null, this.getTagsForStencil(gn, 'storsimple', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'tablet;pointerEvents=1;', w, h * 0.75, '', 'Tablet', null, null, this.getTagsForStencil(gn, 'tablet', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'team_foundation_service;', w, h * 0.75, '', 'Team Foundation Service', null, null, this.getTagsForStencil(gn, 'team_foundation_service', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'traffic_manager;pointerEvents=1;', w, h, '', 'Traffic Manager', null, null, this.getTagsForStencil(gn, 'traffic_manager', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'unidentified_code_object;', w, h * 0.85, '', 'Unidentified Code Object', null, null, this.getTagsForStencil(gn, 'unidentified_code_object', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'user;', w * 0.95, h, '', 'User', null, null, this.getTagsForStencil(gn, 'user', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'vhd;pointerEvents=1;', w * 0.8, h, '', 'VHD', null, null, this.getTagsForStencil(gn, 'vhd', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'vhd_data_disk;pointerEvents=1;', w * 0.75, h, '', 'VHD Data Disk', null, null, this.getTagsForStencil(gn, 'vhd_data_disk', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'virtual_machine;', w, h * 0.8, '', 'Virtual Machine', null, null, this.getTagsForStencil(gn, 'virtual_machine', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'virtual_machine_feature;pointerEvents=1;', w, h * 0.9, '', 'Virtual Machine Feature', null, null, this.getTagsForStencil(gn, 'virtual_machine_feature', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'virtual_network;pointerEvents=1;', w, h * 0.55, '', 'Virtual Network', null, null, this.getTagsForStencil(gn, 'virtual_network', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'visual_studio_online;', w, h * 0.75, '', 'Visual Studio Online', null, null, this.getTagsForStencil(gn, 'visual_studio_online', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'wadcfg_diagnostics_file;pointerEvents=1;', w * 0.95, h, '', 'WADCFG Diagnostics File', null, null, this.getTagsForStencil(gn, 'wadcfg_diagnostics_file', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'website_generic;pointerEvents=1;', w, h * 0.85, '', 'Website Generic', null, null, this.getTagsForStencil(gn, 'website_generic', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'web_role;', w, h * 0.8, '', 'Web Role', null, null, this.getTagsForStencil(gn, 'web_role', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'web_roles;', w * 1.1, h * 0.9, '', 'Web Roles', null, null, this.getTagsForStencil(gn, 'web_roles', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'worker_role;', w, h * 0.8, '', 'Worker Role', null, null, this.getTagsForStencil(gn, 'worker_role', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'worker_roles;', w * 1.1, h * 0.9, '', 'Worker Roles', null, null, this.getTagsForStencil(gn, 'worker_roles', dt).join(' '))
            ]);
    };
})();

(function () {
    Sidebar.prototype.addBasicPalette = function () {
        var w = 100;
        var h = 100;
        var s = 'whiteSpace=wrap;html=1;shape=mxgraph.basic.';
        var s2 = mxConstants.STYLE_VERTICAL_LABEL_POSITION + '=bottom;' + mxConstants.STYLE_VERTICAL_ALIGN + '=top;html=1;shape=mxgraph.basic.';
        var s3 = mxConstants.STYLE_VERTICAL_LABEL_POSITION + '=bottom;' + mxConstants.STYLE_VERTICAL_ALIGN + '=top;html=1;shape=';
        var gn = 'mxgraph.basic';
        var dt = '';

        this.addPaletteFunctions('basic', mxResources.get('basic'), false,
            [
                this.createVertexTemplateEntry(s2 + 'rect;fillColor=#ffffff;fillColor2=none;strokeColor=#000000;strokeWidth=1;size=20;indent=5;', 120, 60, '', 'Partial Rectangle'),
                this.createVertexTemplateEntry('shape=partialRectangle;whiteSpace=wrap;html=1;top=0;bottom=0;fillColor=none;', 120, 60, '', 'Partial Rectangle'),
                this.createVertexTemplateEntry('shape=partialRectangle;whiteSpace=wrap;html=1;right=0;top=0;bottom=0;fillColor=none;routingCenterX=-0.5;', 120, 60, '', 'Partial Rectangle'),
                this.createVertexTemplateEntry('shape=partialRectangle;whiteSpace=wrap;html=1;bottom=0;right=0;fillColor=none;', 120, 60, '', 'Partial Rectangle'),
                this.createVertexTemplateEntry('shape=partialRectangle;whiteSpace=wrap;html=1;top=0;left=0;fillColor=none;', 120, 60, '', 'Partial Rectangle'),
                this.createVertexTemplateEntry(s2 + '4_point_star_2;dx=0.8;', w, h, '', '4 Point Star', null, null, this.getTagsForStencil(gn, '4_point_star', dt).join(' ')),
                this.createVertexTemplateEntry(s2 + '6_point_star', w, h * 0.9, '', '6 Point Star', null, null, this.getTagsForStencil(gn, '6_point_star', dt).join(' ')),
                this.createVertexTemplateEntry(s2 + '8_point_star', w, h, '', '8 Point Star', null, null, this.getTagsForStencil(gn, '8_point_star', dt).join(' ')),
                this.createVertexTemplateEntry(s2 + 'banner', w, h * 0.5, '', 'Banner', null, null, this.getTagsForStencil(gn, 'banner', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'cloud_callout', w * 0.9, h * 0.6, '', 'Cloud Callout', null, null, this.getTagsForStencil(gn, 'cloud_callout', dt).join(' ')),
                this.createVertexTemplateEntry(s2 + 'cone', w, h, '', 'Cone', null, null, this.getTagsForStencil(gn, 'cone', dt).join(' ')),
                this.createVertexTemplateEntry(s2 + 'cone2;dx=0.5;dy=0.9;', w, h, '', 'Cone (adjustable)', null, null, this.getTagsForStencil(gn, 'cone', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'document', w, h, '', 'Document', null, null, this.getTagsForStencil(gn, 'document', dt).join(' ')),
                this.createVertexTemplateEntry(s2 + 'donut;dx=25;', w, h, '', 'Donut', null, null, this.getTagsForStencil(gn, 'donut', dt).join(' ')),
                this.createVertexTemplateEntry(s2 + 'drop', w * 0.7, h, '', 'Drop', null, null, this.getTagsForStencil(gn, 'drop', dt).join(' ')),
                this.createVertexTemplateEntry(s2 + 'flash', w * 0.6, h, '', 'Flash', null, null, this.getTagsForStencil(gn, 'flash', dt).join(' ')),
                this.createVertexTemplateEntry(s2 + 'half_circle', w, h * 0.5, '', 'Half Circle', null, null, this.getTagsForStencil(gn, 'half_circle', dt + ' semicircle').join(' ')),
                this.createVertexTemplateEntry(s2 + 'heart', w, h, '', 'Heart', null, null, this.getTagsForStencil(gn, 'heart', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'isocube;isoAngle=15;', w, h, '', 'Isometric Cube', null, null, this.getTagsForStencil(gn, 'isometric cube', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'loud_callout', w, h * 0.6, '', 'Loud Callout', null, null, this.getTagsForStencil(gn, 'loud_callout', dt).join(' ')),
                this.createVertexTemplateEntry(s2 + 'moon', w * 0.75, h, '', 'Moon', null, null, this.getTagsForStencil(gn, 'moon', dt).join(' ')),
                this.createVertexTemplateEntry(s2 + 'no_symbol', w, h, '', 'No Symbol', null, null, this.getTagsForStencil(gn, 'no_symbol', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'octagon2;align=center;verticalAlign=middle;dx=15;', w, h, '', 'Octagon', null, null, this.getTagsForStencil(gn, 'octagon', dt).join(' ')),
                this.createVertexTemplateEntry(s2 + 'orthogonal_triangle', w, h * 0.7, '', 'Orthogonal Triangle', null, null, this.getTagsForStencil(gn, 'orthogonal_triangle', dt).join(' ')),
                this.createVertexTemplateEntry(s2 + 'acute_triangle;dx=0.5;', w, h * 0.7, '', 'Acute Triangle', null, null, this.getTagsForStencil(gn, 'acute_triangle', dt).join(' ')),
                this.createVertexTemplateEntry(s2 + 'obtuse_triangle;dx=0.25;', w, h * 0.7, '', 'Obtuse Triangle', null, null, this.getTagsForStencil(gn, 'obtuse_triangle', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'oval_callout', w, h * 0.6, '', 'Oval Callout', null, null, this.getTagsForStencil(gn, 'oval_callout', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'pentagon', w, h * 0.9, '', 'Pentagon', null, null, this.getTagsForStencil(gn, 'pentagon', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'pointed_oval', w * 0.5, h, '', 'Pointed Oval', null, null, this.getTagsForStencil(gn, 'pointed oval', dt).join(' ')),
                this.createVertexTemplateEntry(s2 + 'pyramid;dx1=0.4;dx2=0.6;dy1=0.9;dy2=0.8;', w, h, '', 'Pyramid', null, null, this.getTagsForStencil(gn, 'pyramid', dt).join(' ')),
                this.createVertexTemplateEntry(s2 + 'diag_snip_rect;dx=6;', w, h * 0.6, '', 'Diagonal Snip Rectangle', null, null, this.getTagsForStencil(gn, 'diag_snip_rect', dt).join(' ')),
                this.createVertexTemplateEntry(s2 + 'diag_round_rect;dx=6;', w, h * 0.6, '', 'Diagonal Rounded Rectangle', null, null, this.getTagsForStencil(gn, 'diag_round_rect', dt).join(' ')),
                this.createVertexTemplateEntry(s2 + 'corner_round_rect;dx=6;', w, h * 0.6, '', 'Corner Rounded Rectangle', null, null, this.getTagsForStencil(gn, 'corner_round_rect', dt).join(' ')),
                this.createVertexTemplateEntry(s2 + 'three_corner_round_rect;dx=6;', w, h * 0.6, '', 'Rounded Rectangle (three corners)', null, null, this.getTagsForStencil(gn, 'three_corner_round_rect', dt).join(' ')),
                this.createVertexTemplateEntry(s2 + 'plaque;dx=6;', w, h * 0.6, '', 'Plaque', null, null, this.getTagsForStencil(gn, 'plaque', dt).join(' ')),
                this.createVertexTemplateEntry(s2 + 'frame;dx=10;', w, h * 0.6, '', 'Frame', null, null, this.getTagsForStencil(gn, 'frame', dt).join(' ')),
                this.createVertexTemplateEntry(s2 + 'rounded_frame;dx=10;', w, h * 0.6, '', 'Rounded Frame', null, null, this.getTagsForStencil(gn, 'rounded_frame', dt).join(' ')),
                this.createVertexTemplateEntry(s2 + 'plaque_frame;dx=10;', w, h * 0.6, '', 'Plaque Frame', null, null, this.getTagsForStencil(gn, 'plaque_frame', dt).join(' ')),
                this.createVertexTemplateEntry(s2 + 'frame_corner;dx=10;', w, h * 0.6, '', 'Frame Corner', null, null, this.getTagsForStencil(gn, 'frame_corner', dt).join(' ')),
                this.createVertexTemplateEntry(s2 + 'diag_stripe;dx=10;', w, h * 0.6, '', 'Diagonal Stripe', null, null, this.getTagsForStencil(gn, 'diag_stripe', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'rectCallout;dx=30;dy=15;boundedLbl=1;', w, h * 0.6, '', 'Rectangular Callout', null, null, this.getTagsForStencil(gn, 'rectangular_callout', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'roundRectCallout;dx=30;dy=15;size=5;boundedLbl=1;', w, h * 0.6, '', 'Rounded Rectangular Callout', null, null, this.getTagsForStencil(gn, 'rectangular_callout', dt).join(' ')),
                this.createVertexTemplateEntry(s2 + 'layered_rect;dx=10;outlineConnect=0;', w, h * 0.6, '', 'Layered Rectangle', null, null, this.getTagsForStencil(gn, 'layered_rect', dt).join(' ')),
                this.createVertexTemplateEntry(s2 + 'smiley', w, h, '', 'Smiley', null, null, this.getTagsForStencil(gn, 'smiley', dt).join(' ')),
                this.createVertexTemplateEntry(s2 + 'star', w, h * 0.95, '', 'Star', null, null, this.getTagsForStencil(gn, 'star', dt).join(' ')),
                this.createVertexTemplateEntry(s2 + 'sun', w, h, '', 'Sun', null, null, this.getTagsForStencil(gn, 'sun', dt).join(' ')),
                this.createVertexTemplateEntry(s2 + 'tick', w * 0.85, h, '', 'Tick', null, null, this.getTagsForStencil(gn, 'tick', dt).join(' ')),
                this.createVertexTemplateEntry(s2 + 'wave2;dy=0.3;', w, h * 0.6, '', 'Wave', null, null, this.getTagsForStencil(gn, 'wave', dt).join(' ')),
                this.createVertexTemplateEntry('labelPosition=center;verticalLabelPosition=middle;align=center;html=1;shape=mxgraph.basic.button;dx=10;', w, h * 0.6, 'Button', 'Button', null, null, this.getTagsForStencil(gn, 'button', dt).join(' ')),
                this.createVertexTemplateEntry('labelPosition=center;verticalLabelPosition=middle;align=center;html=1;shape=mxgraph.basic.shaded_button;dx=10;fillColor=#E6E6E6;strokeColor=none;', w, h * 0.6, 'Button', 'Button (shaded)', null, null, this.getTagsForStencil(gn, 'button', dt).join(' ')),
                this.createVertexTemplateEntry(s2 + 'x', w, h, '', 'X', null, null, this.getTagsForStencil(gn, 'x', dt).join(' ')),
                this.createVertexTemplateEntry(s2 + 'pie;startAngle=0.2;endAngle=0.9;', w, h, '', 'Pie', null, null, this.getTagsForStencil(gn, 'pie', dt).join(' ')),
                this.createVertexTemplateEntry(s2 + 'arc;startAngle=0.3;endAngle=0.1;', w, h, '', 'Arc', null, null, this.getTagsForStencil(gn, 'arc', dt).join(' ')),
                this.createVertexTemplateEntry(s2 + 'partConcEllipse;startAngle=0.25;endAngle=0.1;arcWidth=0.5;', w, h, '', 'Partial Concentric Ellipse', null, null, this.getTagsForStencil(gn, 'partConcEllipse', dt).join(' '))
            ]);
    };

})();

(function () {
    // Adds Bootstrap shapes
    Sidebar.prototype.addBootstrapPalette = function () {
        var s = 'html=1;shadow=0;dashed=0;shape=mxgraph.bootstrap.';
        var s2 = 'html=1;shadow=0;dashed=0;fillColor=none;strokeColor=none;shape=mxgraph.bootstrap.rect;';
        var inh = 'strokeColor=inherit;fillColor=inherit;gradientColor=inherit;';
        var gn = 'mxgraph.bootstrap';
        var dt = 'bootstrap ';
        var sb = this;

        var fns = [
            this.addDataEntry(dt + 'button bar dark', 800, 40, 'Button Bar (Dark)',
                '5ZhRb5swEMc/DY+NDKaEvIZ2fdm0qpH27gUDVg2HjNuQfvod2EnJnGxRWqJUsRQJn332+ffnbBOPJmX7oFhd/ICUS4/eezRRANo8lW3CpfQCIlKP3nlBQPDnBd8OtPp9K6mZ4pU+xiEwDq9MvnBjMYZGr6U1FLrEsO58j86bgqWwwgrBSsqagqe2gi11179s824tk9+4gkbj40TxJUYyz4SUCUhQ/aA06EvnqBU8801LBRWOMl8VQvNFzZbdkCscBW02UK40bw8utjfZlT5wKLlWa+yyEqkuTI+YGCCk4CIvrFtobawx9Xzr+o4OHyy9/SSpQzKBsmbV+jSgQ16Wyl5U/wcPlR6An/XF2hfirfP1w48wD45gPg7y0EH+yKFGzGd5hUlfDunyF/asL11nJCyq/MmSoGQE9O0u9oESs5GUuHWUiMNPV8HKoOxbG7uSZNkpkpyMP/wnfuuwttvw5NZRY4NtqIYfGZvikmnxynfG2ieRnf8RBIa1nfyGkp3pb+LdESDLGq4diberOEr1yFH9l4AubKiaC931zph+/tTNP98fKQGnjhTh55/kF5eA0ZUnYOyovtAYdKPF8lITcKRk23fYjXXtmLnUuda4q1wZcxq5zKcjMd/sm8O7ngIkd+Jl76syj87J3HeYf4ccDT9f9HVRn9LRqGP1/WvfHAHDPwP+AA=='),
            this.addDataEntry(dt + 'button bar bright', 800, 40, 'Button Bar (Bright)',
                '5ZdRb5swEMc/DY9FBhNCXkPavmxStUh798IB1gxGxmvIPv0OcBKoSZetpYpUIyT77DP278+dwaFx0TwqVuVfZQLCofcOjZWUuq8VTQxCOD7hiUM3ju8TvB3/4UKv1/WSiiko9TUOfu/wzMQv6C29odYHYQy5LnBZG8+h6zpnidxjg2AjYXUOiWlgT9WOL5qs3Yv7A3dQa6y6Cna4knXKhYilkKqblKZhe7WOWsmfcOwpZYmzrPc517Ct2K6dco+zoM0sFJSG5uJmO5PZ6SPIArQ64JA9T3Tej4hID4TkwLPcuAXGxuq+nZ1cz+iwYuhNk6QWyVgWFSsP/wd0yMtQmUT1d/Cy1APwSVeMfct/t75e8Bbm/hXM50EeWMifQFaI+WNeYdJel3R5gX3VlXYwEuZl9s2QoGQG9M0Y+0CJ1UxKLCwlouDdVTAyKPPWRhOSpATLlZKkXXkL/uBV/MbhYNKwu7DUOGIbquGFvU2BYJo/w2iuKYnM858kx2WdHn5Hyejxd9F4BpmmNWhL4tMurlI9tFT/zmW7bFnWN5r1PjD8vKUdf543UwAuLSmC9z/Jby4Aw08egJGl+lbjomvNd7cagDMF29RhN9dnx8qmDlpjVvlkzGloM1/OxPyYN0fQmdrlruvOnecWU3nOpK6xUC+/r6fsTPCsRJuAVJ8PpC9da+PNeB6Fi3FGstOhRyfUo/+uHjbPf7B9Whv+4P4B'),

            this.addEntry(dt + 'button group vertical', function () {
                var bg = new mxCell('', new mxGeometry(0, 0, 100, 150), s + 'rrect;rSize=5;strokeColor=#dddddd;html=1;whiteSpace=wrap;fillColor=#ffffff;');
                bg.vertex = true;
                var button1 = new mxCell('Edit', new mxGeometry(0, 0, 100, 30), inh + s + 'topButton;rSize=5;perimeter=none;whiteSpace=wrap;resizeWidth=1;');
                button1.geometry.relative = true;
                button1.vertex = true;
                bg.insert(button1);
                var button2 = new mxCell('Create', new mxGeometry(0, 0, 100, 30), inh + s + 'rect;perimeter=none;whiteSpace=wrap;resizeWidth=1;');
                button2.geometry.relative = true;
                button2.geometry.offset = new mxPoint(0, 30);
                button2.vertex = true;
                bg.insert(button2);
                var button3 = new mxCell('Delete', new mxGeometry(0, 0, 100, 30), inh + s + 'rect;perimeter=none;whiteSpace=wrap;resizeWidth=1;');
                button3.geometry.relative = true;
                button3.geometry.offset = new mxPoint(0, 60);
                button3.vertex = true;
                bg.insert(button3);
                var button4 = new mxCell('Append', new mxGeometry(0, 0, 100, 30), inh + s + 'rect;perimeter=none;whiteSpace=wrap;resizeWidth=1;');
                button4.geometry.relative = true;
                button4.geometry.offset = new mxPoint(0, 90);
                button4.vertex = true;
                bg.insert(button4);
                var button5 = new mxCell('Prepend', new mxGeometry(0, 1, 100, 30), inh + s + 'bottomButton;rSize=5;perimeter=none;whiteSpace=wrap;resizeWidth=1;');
                button5.geometry.relative = true;
                button5.geometry.offset = new mxPoint(0, -30);
                button5.vertex = true;
                bg.insert(button5);
                var marker1 = new mxCell('', new mxGeometry(1, 0.5, 10, 5), 'shape=triangle;direction=south;fillColor=#000000;strokeColor=none;perimeter=none;');
                marker1.geometry.relative = true;
                marker1.geometry.offset = new mxPoint(-15, -2.5);
                marker1.vertex = true;
                button2.insert(marker1);

                return sb.createVertexTemplateFromCells([bg], bg.geometry.width, bg.geometry.height, 'Button Group (Vertical)');
            }),

            this.addEntry(dt + 'button group vertical', function () {
                var bg = new mxCell('', new mxGeometry(0, 0, 160, 160), s + 'rrect;rSize=5;strokeColor=#dddddd;html=1;whiteSpace=wrap;fillColor=#ffffff;');
                bg.vertex = true;
                var button2 = new mxCell('Verified', new mxGeometry(0, 0, 160, 40), inh + s + 'rect;spacingLeft=10;align=left;perimeter=none;whiteSpace=wrap;resizeWidth=1;');
                button2.geometry.relative = true;
                button2.geometry.offset = new mxPoint(0, 40);
                button2.vertex = true;
                bg.insert(button2);
                var button3 = new mxCell('Banned', new mxGeometry(0, 0, 160, 40), inh + s + 'rect;spacingLeft=10;align=left;perimeter=none;whiteSpace=wrap;resizeWidth=1;');
                button3.geometry.relative = true;
                button3.geometry.offset = new mxPoint(0, 80);
                button3.vertex = true;
                bg.insert(button3);
                var button4 = new mxCell('Deleted', new mxGeometry(0, 1, 160, 40), inh + s + 'bottomButton;rSize=5;spacingLeft=10;align=left;perimeter=none;whiteSpace=wrap;resizeWidth=1;');
                button4.geometry.relative = true;
                button4.geometry.offset = new mxPoint(0, -40);
                button4.vertex = true;
                bg.insert(button4);
                var button1 = new mxCell('All Users', new mxGeometry(0, 0, 160, 40), s + 'topButton;rSize=5;fillColor=#3D8BCD;strokeColor=#3D8BCD;fontColor=#ffffff;spacingLeft=10;align=left;whiteSpace=wrap;resizeWidth=1;');
                button1.geometry.relative = true;
                button1.vertex = true;
                bg.insert(button1);

                return sb.createVertexTemplateFromCells([bg], bg.geometry.width, bg.geometry.height, 'Button Group (Vertical)');
            }),

            this.createVertexTemplateEntry(s + 'topButton;rSize=5;fillColor=#3D8BCD;strokeColor=#0D5B9D;fontColor=#ffffff;spacingLeft=10;align=left;whiteSpace=wrap;',
                160, 40, 'All Users', 'Top Button', null, null, this.getTagsForStencil(gn, 'topButton', dt + 'top button').join(' ')),
            this.createVertexTemplateEntry(s + 'bottomButton;rSize=5;fillColor=#3D8BCD;strokeColor=#0D5B9D;fontColor=#ffffff;spacingLeft=10;align=left;whiteSpace=wrap;',
                160, 40, 'All Users', 'Bottom Button', null, null, this.getTagsForStencil(gn, 'bottomButton', dt + 'bottom button').join(' ')),
            this.createVertexTemplateEntry(s + 'rightButton;rSize=5;fillColor=#3D8BCD;strokeColor=#0D5B9D;fontColor=#ffffff;spacingLeft=10;align=left;whiteSpace=wrap;',
                160, 40, 'All Users', 'Right Button', null, null, this.getTagsForStencil(gn, 'rightButton', dt + 'right button').join(' ')),
            this.createVertexTemplateEntry(s + 'leftButton;rSize=5;fillColor=#3D8BCD;strokeColor=#0D5B9D;fontColor=#ffffff;spacingLeft=10;align=left;whiteSpace=wrap;',
                160, 40, 'All Users', 'Left Button', null, null, this.getTagsForStencil(gn, 'leftButton', dt + 'left button').join(' ')),

            this.addEntry(dt + 'dropdown large', function () {
                var bg = new mxCell('Dropdown', new mxGeometry(0, 0, 140, 40), s + 'rrect;rSize=5;strokeColor=#dddddd;spacingRight=10;fontSize=16;whiteSpace=wrap;fillColor=#ffffff;align=center;');
                bg.vertex = true;
                var marker1 = new mxCell('', new mxGeometry(1, 0.5, 10, 5), 'shape=triangle;direction=south;fillColor=#000000;strokeColor=none;perimeter=none;');
                marker1.geometry.relative = true;
                marker1.geometry.offset = new mxPoint(-20, -2.5);
                marker1.vertex = true;
                bg.insert(marker1);

                return sb.createVertexTemplateFromCells([bg], bg.geometry.width, bg.geometry.height, 'Dropdown (Large)');
            }),

            this.addEntry(dt + 'dropdown normal', function () {
                var bg = new mxCell('Dropdown', new mxGeometry(0, 0, 120, 30), s + 'rrect;rSize=5;strokeColor=#dddddd;spacingRight=10;fontSize=14;whiteSpace=wrap;fillColor=#ffffff;align=center;');
                bg.vertex = true;
                var marker1 = new mxCell('', new mxGeometry(1, 0.5, 10, 5), 'shape=triangle;direction=south;fillColor=#000000;strokeColor=none;perimeter=none;');
                marker1.geometry.relative = true;
                marker1.geometry.offset = new mxPoint(-20, -2.5);
                marker1.vertex = true;
                bg.insert(marker1);

                return sb.createVertexTemplateFromCells([bg], bg.geometry.width, bg.geometry.height, 'Dropdown (Normal)');
            }),

            this.addEntry(dt + 'dropdown small', function () {
                var bg = new mxCell('Dropdown', new mxGeometry(0, 0, 100, 22), s + 'rrect;fontSize=12;rSize=5;strokeColor=#dddddd;spacingRight=10;perimeter=none;whiteSpace=wrap;fillColor=#ffffff;align=center;');
                bg.vertex = true;
                var marker1 = new mxCell('', new mxGeometry(1, 0.5, 10, 5), 'shape=triangle;direction=south;fillColor=#000000;strokeColor=none;perimeter=none;');
                marker1.geometry.relative = true;
                marker1.geometry.offset = new mxPoint(-20, -2.5);
                marker1.vertex = true;
                bg.insert(marker1);

                return sb.createVertexTemplateFromCells([bg], bg.geometry.width, bg.geometry.height, 'Dropdown (Small)');
            }),

            this.addEntry(dt + 'dropdown tiny', function () {
                var bg = new mxCell('Dropdown', new mxGeometry(0, 0, 90, 20), s + 'rrect;rSize=5;strokeColor=#dddddd;spacingRight=10;fontSize=10;whiteSpace=wrap;fillColor=#ffffff;align=center;');
                bg.vertex = true;
                var marker1 = new mxCell('', new mxGeometry(1, 0.5, 10, 5), 'shape=triangle;direction=south;fillColor=#000000;strokeColor=none;perimeter=none;');
                marker1.geometry.relative = true;
                marker1.geometry.offset = new mxPoint(-20, -2.5);
                marker1.vertex = true;
                bg.insert(marker1);

                return sb.createVertexTemplateFromCells([bg], bg.geometry.width, bg.geometry.height, 'Dropdown (Tiny)');
            }),

            this.addEntry(dt + 'button group justified large', function () {
                var bg = new mxCell('', new mxGeometry(0, 0, 240, 40), s + 'rrect;rSize=5;strokeColor=#dddddd;fillColor=#ffffff;');
                bg.vertex = true;
                var button1 = new mxCell('Left', new mxGeometry(0, 0, 80, 40), inh + s + 'leftButton;rSize=5;perimeter=none;fontSize=16;whiteSpace=wrap;');
                button1.vertex = true;
                bg.insert(button1);
                var button2 = new mxCell('Middle', new mxGeometry(80, 0, 80, 40), inh + s + 'rect;perimeter=none;fontSize=16;whiteSpace=wrap;');
                button2.vertex = true;
                bg.insert(button2);
                var button3 = new mxCell('Right', new mxGeometry(160, 0, 80, 40), inh + s + 'rightButton;rSize=5;perimeter=none;fontSize=16;whiteSpace=wrap;');
                button3.vertex = true;
                bg.insert(button3);

                return sb.createVertexTemplateFromCells([bg], bg.geometry.width, bg.geometry.height, 'Button Group (Justified, Large)');
            }),

            this.addEntry(dt + 'button group justified normal', function () {
                var bg = new mxCell('', new mxGeometry(0, 0, 180, 30), s + 'rrect;rSize=5;strokeColor=#dddddd;fillColor=#ffffff;');
                bg.vertex = true;
                var button1 = new mxCell('Left', new mxGeometry(0, 0, 60, 30), inh + s + 'leftButton;rSize=5;perimeter=none;fontSize=14;whiteSpace=wrap;');
                button1.vertex = true;
                bg.insert(button1);
                var button2 = new mxCell('Middle', new mxGeometry(60, 0, 60, 30), inh + s + 'rect;perimeter=none;fontSize=14;whiteSpace=wrap;');
                button2.vertex = true;
                bg.insert(button2);
                var button3 = new mxCell('Right', new mxGeometry(120, 0, 60, 30), inh + s + 'rightButton;rSize=5;perimeter=none;fontSize=14;whiteSpace=wrap;');
                button3.vertex = true;
                bg.insert(button3);

                return sb.createVertexTemplateFromCells([bg], bg.geometry.width, bg.geometry.height, 'Button Group (Justified, Normal)');
            }),

            this.addEntry(dt + 'button group justified small', function () {
                var bg = new mxCell('', new mxGeometry(0, 0, 150, 22), s + 'rrect;rSize=5;strokeColor=#dddddd;fillColor=#ffffff;');
                bg.vertex = true;
                var button1 = new mxCell('Left', new mxGeometry(0, 0, 50, 22), inh + s + 'leftButton;rSize=5;perimeter=none;whiteSpace=wrap;');
                button1.vertex = true;
                bg.insert(button1);
                var button2 = new mxCell('Middle', new mxGeometry(50, 0, 50, 22), inh + s + 'rect;perimeter=none;whiteSpace=wrap;');
                button2.vertex = true;
                bg.insert(button2);
                var button3 = new mxCell('Right', new mxGeometry(100, 0, 50, 22), inh + s + 'rightButton;rSize=5;perimeter=none;whiteSpace=wrap;');
                button3.vertex = true;
                bg.insert(button3);

                return sb.createVertexTemplateFromCells([bg], bg.geometry.width, bg.geometry.height, 'Button Group (Justified, Small)');
            }),

            this.addEntry(dt + 'button group justified tiny', function () {
                var bg = new mxCell('', new mxGeometry(0, 0, 120, 20), s + 'rrect;rSize=5;strokeColor=#dddddd;fillColor=#ffffff;');
                bg.vertex = true;
                var button1 = new mxCell('Left', new mxGeometry(0, 0, 40, 20), inh + s + 'leftButton;rSize=5;perimeter=none;fontSize=10;whiteSpace=wrap;');
                button1.vertex = true;
                bg.insert(button1);
                var button2 = new mxCell('Middle', new mxGeometry(40, 0, 40, 20), inh + s + 'rect;perimeter=none;fontSize=10;whiteSpace=wrap;');
                button2.vertex = true;
                bg.insert(button2);
                var button3 = new mxCell('Right', new mxGeometry(80, 0, 40, 20), inh + s + 'rightButton;rSize=5;perimeter=none;fontSize=10;whiteSpace=wrap;');
                button3.vertex = true;
                bg.insert(button3);

                return sb.createVertexTemplateFromCells([bg], bg.geometry.width, bg.geometry.height, 'Button Group (Justified, Tiny)');
            }),

            this.addEntry(dt + 'button toolbar', function () {
                var bg1 = new mxCell('', new mxGeometry(0, 0, 120, 30), s + 'rrect;rSize=5;strokeColor=#dddddd;fillColor=#ffffff;');
                bg1.vertex = true;
                var button1 = new mxCell('1', new mxGeometry(0, 0, 30, 30), inh + s + 'leftButton;rSize=5;perimeter=none;fontSize=14;whiteSpace=wrap;');
                button1.vertex = true;
                bg1.insert(button1);
                var button2 = new mxCell('2', new mxGeometry(30, 0, 30, 30), inh + s + 'rect;perimeter=none;fontSize=14;whiteSpace=wrap;');
                button2.vertex = true;
                bg1.insert(button2);
                var button3 = new mxCell('3', new mxGeometry(60, 0, 30, 30), inh + s + 'rect;perimeter=none;fontSize=14;whiteSpace=wrap;');
                button3.vertex = true;
                bg1.insert(button3);
                var button4 = new mxCell('4', new mxGeometry(90, 0, 30, 30), inh + s + 'rightButton;rSize=5;perimeter=none;fontSize=14;whiteSpace=wrap;');
                button4.vertex = true;
                bg1.insert(button4);
                var bg2 = new mxCell('', new mxGeometry(130, 0, 90, 30), s + 'rrect;rSize=5;strokeColor=#dddddd;fillColor=#ffffff;');
                bg2.vertex = true;
                var button1 = new mxCell('5', new mxGeometry(0, 0, 30, 30), inh + s + 'leftButton;rSize=5;perimeter=none;fontSize=14;whiteSpace=wrap;');
                button1.vertex = true;
                bg2.insert(button1);
                var button2 = new mxCell('6', new mxGeometry(30, 0, 30, 30), inh + s + 'rect;perimeter=none;fontSize=14;whiteSpace=wrap;');
                button2.vertex = true;
                bg2.insert(button2);
                var button4 = new mxCell('7', new mxGeometry(60, 0, 30, 30), inh + s + 'rightButton;rSize=5;perimeter=none;fontSize=14;whiteSpace=wrap;');
                button4.vertex = true;
                bg2.insert(button4);
                var bg3 = new mxCell('8', new mxGeometry(230, 0, 30, 30), s + 'rrect;fontSize=12;align=center;rSize=5;strokeColor=#dddddd;whiteSpace=wrap;fillColor=#ffffff;');
                bg3.vertex = true;

                return sb.createVertexTemplateFromCells([bg1, bg2, bg3], 260, 30, 'Button Toolbar');
            }),

            this.addEntry(dt + 'button group nested', function () {
                var bg1 = new mxCell('', new mxGeometry(0, 0, 160, 30), s + 'rrect;rSize=5;strokeColor=#dddddd;fillColor=#ffffff;');
                bg1.vertex = true;
                var button1 = new mxCell('1', new mxGeometry(0, 0, 30, 30), inh + s + 'leftButton;rSize=5;perimeter=none;fontSize=14;whiteSpace=wrap;');
                button1.vertex = true;
                bg1.insert(button1);
                var button2 = new mxCell('2', new mxGeometry(30, 0, 30, 30), inh + s + 'rect;perimeter=none;fontSize=14;whiteSpace=wrap;');
                button2.vertex = true;
                bg1.insert(button2);
                var button3 = new mxCell('Dropdown', new mxGeometry(60, 0, 100, 30), inh + s + 'rightButton;rSize=5;perimeter=none;fontSize=14;spacingRight=10;whiteSpace=wrap;');
                button3.vertex = true;
                bg1.insert(button3);
                var marker1 = new mxCell('', new mxGeometry(1, 0.5, 10, 5), 'shape=triangle;direction=south;fillColor=#000000;strokeColor=none;perimeter=none;');
                marker1.geometry.relative = true;
                marker1.geometry.offset = new mxPoint(-15, -2.5);
                marker1.vertex = true;
                button3.insert(marker1);

                return sb.createVertexTemplateFromCells([bg1], bg1.geometry.width, bg1.geometry.height, 'Button Group (Nested)');
            }),

            this.createVertexTemplateEntry(s + 'rrect;rSize=5;strokeColor=#dddddd;fillColor=#ffffff;align=center;fontSize=16;whiteSpace=wrap;',
                80, 40, 'Button', 'Button (Large)', null, null, this.getTagsForStencil(gn, '', dt + 'button large').join(' ')),
            this.createVertexTemplateEntry(s + 'rrect;rSize=5;strokeColor=#dddddd;fillColor=#ffffff;align=center;fontSize=14;whiteSpace=wrap;',
                60, 30, 'Button', 'Button (Normal)', null, null, this.getTagsForStencil(gn, '', dt + 'button normal').join(' ')),
            this.createVertexTemplateEntry(s + 'rrect;rSize=5;strokeColor=#dddddd;fillColor=#ffffff;align=center;fontSize=12;whiteSpace=wrap;',
                44, 22, 'Button', 'Button (Small)', null, null, this.getTagsForStencil(gn, '', dt + 'button small').join(' ')),
            this.createVertexTemplateEntry(s + 'rrect;rSize=5;strokeColor=#dddddd;fillColor=#ffffff;align=center;fontSize=10;whiteSpace=wrap;',
                40, 20, 'Button', 'Button (Tiny)', null, null, this.getTagsForStencil(gn, '', dt + 'button tiny').join(' ')),

            this.createVertexTemplateEntry(s + 'rrect;rSize=5;fillColor=#3D8BCD;align=center;strokeColor=#3D8BCD;fontColor=#ffffff;fontSize=16;whiteSpace=wrap;',
                80, 40, 'Button', 'Button (Large)', null, null, this.getTagsForStencil(gn, '', dt + 'button large').join(' ')),
            this.createVertexTemplateEntry(s + 'rrect;rSize=5;fillColor=#3D8BCD;align=center;strokeColor=#3D8BCD;fontColor=#ffffff;fontSize=14;whiteSpace=wrap;',
                60, 30, 'Button', 'Button (Normal)', null, null, this.getTagsForStencil(gn, '', dt + 'button normal').join(' ')),
            this.createVertexTemplateEntry(s + 'rrect;rSize=5;fillColor=#3D8BCD;align=center;strokeColor=#3D8BCD;fontColor=#ffffff;fontSize=12;whiteSpace=wrap;',
                44, 22, 'Button', 'Button (Small)', null, null, this.getTagsForStencil(gn, '', dt + 'button small').join(' ')),
            this.createVertexTemplateEntry(s + 'rrect;rSize=5;fillColor=#3D8BCD;align=center;strokeColor=#3D8BCD;fontColor=#ffffff;fontSize=10;whiteSpace=wrap;',
                40, 20, 'Button', 'Button (Tiny)', null, null, this.getTagsForStencil(gn, '', dt + 'button tiny').join(' ')),

            this.createVertexTemplateEntry(s + 'rrect;rSize=5;fillColor=#58B957;align=center;strokeColor=#58B957;fontColor=#ffffff;fontSize=16;whiteSpace=wrap;',
                80, 40, 'Button', 'Button (Large)', null, null, this.getTagsForStencil(gn, '', dt + 'button large').join(' ')),
            this.createVertexTemplateEntry(s + 'rrect;rSize=5;fillColor=#58B957;align=center;strokeColor=#58B957;fontColor=#ffffff;fontSize=14;whiteSpace=wrap;',
                60, 30, 'Button', 'Button (Normal)', null, null, this.getTagsForStencil(gn, '', dt + 'button normal').join(' ')),
            this.createVertexTemplateEntry(s + 'rrect;rSize=5;fillColor=#58B957;align=center;strokeColor=#58B957;fontColor=#ffffff;fontSize=12;whiteSpace=wrap;',
                44, 22, 'Button', 'Button (Small)', null, null, this.getTagsForStencil(gn, '', dt + 'button small').join(' ')),
            this.createVertexTemplateEntry(s + 'rrect;rSize=5;fillColor=#58B957;align=center;strokeColor=#58B957;fontColor=#ffffff;fontSize=10;whiteSpace=wrap;',
                40, 20, 'Button', 'Button (Tiny)', null, null, this.getTagsForStencil(gn, '', dt + 'button tiny').join(' ')),

            this.createVertexTemplateEntry(s + 'rrect;rSize=5;fillColor=#55BFE0;align=center;strokeColor=#55BFE0;fontColor=#ffffff;fontSize=16;whiteSpace=wrap;',
                80, 40, 'Button', 'Button (Large)', null, null, this.getTagsForStencil(gn, '', dt + 'button large').join(' ')),
            this.createVertexTemplateEntry(s + 'rrect;rSize=5;fillColor=#55BFE0;align=center;strokeColor=#55BFE0;fontColor=#ffffff;fontSize=14;whiteSpace=wrap;',
                60, 30, 'Button', 'Button (Normal)', null, null, this.getTagsForStencil(gn, '', dt + 'button normal').join(' ')),
            this.createVertexTemplateEntry(s + 'rrect;rSize=5;fillColor=#55BFE0;align=center;strokeColor=#55BFE0;fontColor=#ffffff;fontSize=12;whiteSpace=wrap;',
                44, 22, 'Button', 'Button (Small)', null, null, this.getTagsForStencil(gn, '', dt + 'button small').join(' ')),
            this.createVertexTemplateEntry(s + 'rrect;rSize=5;fillColor=#55BFE0;align=center;strokeColor=#55BFE0;fontColor=#ffffff;fontSize=10;whiteSpace=wrap;',
                40, 20, 'Button', 'Button (Tiny)', null, null, this.getTagsForStencil(gn, '', dt + 'button tiny').join(' ')),

            this.createVertexTemplateEntry(s + 'rrect;rSize=5;fillColor=#EFAC43;align=center;strokeColor=#EFAC43;fontColor=#ffffff;fontSize=16;whiteSpace=wrap;',
                80, 40, 'Button', 'Button (Large)', null, null, this.getTagsForStencil(gn, '', dt + 'button large').join(' ')),
            this.createVertexTemplateEntry(s + 'rrect;rSize=5;fillColor=#EFAC43;align=center;strokeColor=#EFAC43;fontColor=#ffffff;fontSize=14;whiteSpace=wrap;',
                60, 30, 'Button', 'Button (Normal)', null, null, this.getTagsForStencil(gn, '', dt + 'button normal').join(' ')),
            this.createVertexTemplateEntry(s + 'rrect;rSize=5;fillColor=#EFAC43;align=center;strokeColor=#EFAC43;fontColor=#ffffff;fontSize=12;whiteSpace=wrap;',
                44, 22, 'Button', 'Button (Small)', null, null, this.getTagsForStencil(gn, '', dt + 'button small').join(' ')),
            this.createVertexTemplateEntry(s + 'rrect;rSize=5;fillColor=#EFAC43;align=center;strokeColor=#EFAC43;fontColor=#ffffff;fontSize=10;whiteSpace=wrap;',
                40, 20, 'Button', 'Button (Tiny)', null, null, this.getTagsForStencil(gn, '', dt + 'button tiny').join(' ')),

            this.createVertexTemplateEntry(s + 'rrect;rSize=5;fillColor=#DB524C;align=center;strokeColor=#DB524C;fontColor=#ffffff;fontSize=16;whiteSpace=wrap;',
                80, 40, 'Button', 'Button (Large)', null, null, this.getTagsForStencil(gn, '', dt + 'button large').join(' ')),
            this.createVertexTemplateEntry(s + 'rrect;rSize=5;fillColor=#DB524C;align=center;strokeColor=#DB524C;fontColor=#ffffff;fontSize=14;whiteSpace=wrap;',
                60, 30, 'Button', 'Button (Normal)', null, null, this.getTagsForStencil(gn, '', dt + 'button normal').join(' ')),
            this.createVertexTemplateEntry(s + 'rrect;rSize=5;fillColor=#DB524C;align=center;strokeColor=#DB524C;fontColor=#ffffff;fontSize=12;whiteSpace=wrap;',
                44, 22, 'Button', 'Button (Small)', null, null, this.getTagsForStencil(gn, '', dt + 'button small').join(' ')),
            this.createVertexTemplateEntry(s + 'rrect;rSize=5;fillColor=#DB524C;align=center;strokeColor=#DB524C;fontColor=#ffffff;fontSize=10;whiteSpace=wrap;',
                40, 20, 'Button', 'Button (Tiny)', null, null, this.getTagsForStencil(gn, '', dt + 'button tiny').join(' ')),

            this.addEntry(dt + 'dropdown small', function () {
                var bg = new mxCell('Primary', new mxGeometry(0, 0, 100, 22), s + 'rrect;align=center;rSize=5;fillColor=#3D8BCD;strokeColor=#3D8BCD;fontColor=#ffffff;spacingRight=10;whiteSpace=wrap;');
                bg.vertex = true;
                var marker1 = new mxCell('', new mxGeometry(1, 0.5, 10, 5), 'shape=triangle;direction=south;fillColor=#ffffff;strokeColor=none;perimeter=none;');
                marker1.geometry.relative = true;
                marker1.geometry.offset = new mxPoint(-20, -2.5);
                marker1.vertex = true;
                bg.insert(marker1);

                return sb.createVertexTemplateFromCells([bg], bg.geometry.width, bg.geometry.height, 'Dropdown (Small)');
            }),

            this.addEntry(dt + 'dropdown small', function () {
                var bg = new mxCell('Success', new mxGeometry(0, 0, 100, 22), s + 'rrect;align=center;rSize=5;fillColor=#58B957;strokeColor=#58B957;fontColor=#ffffff;spacingRight=10;whiteSpace=wrap;');
                bg.vertex = true;
                var marker1 = new mxCell('', new mxGeometry(1, 0.5, 10, 5), 'shape=triangle;direction=south;fillColor=#ffffff;strokeColor=none;perimeter=none;');
                marker1.geometry.relative = true;
                marker1.geometry.offset = new mxPoint(-20, -2.5);
                marker1.vertex = true;
                bg.insert(marker1);

                return sb.createVertexTemplateFromCells([bg], bg.geometry.width, bg.geometry.height, 'Dropdown (Small)');
            }),

            this.addEntry(dt + 'dropdown small', function () {
                var bg = new mxCell('Info', new mxGeometry(0, 0, 100, 22), s + 'rrect;align=center;rSize=5;fillColor=#55BFE0;strokeColor=#55BFE0;fontColor=#ffffff;spacingRight=10;whiteSpace=wrap;');
                bg.vertex = true;
                var marker1 = new mxCell('', new mxGeometry(1, 0.5, 10, 5), 'shape=triangle;direction=south;fillColor=#ffffff;strokeColor=none;perimeter=none;whiteSpace=wrap;');
                marker1.geometry.relative = true;
                marker1.geometry.offset = new mxPoint(-20, -2.5);
                marker1.vertex = true;
                bg.insert(marker1);

                return sb.createVertexTemplateFromCells([bg], bg.geometry.width, bg.geometry.height, 'Dropdown (Small)');
            }),

            this.addEntry(dt + 'dropdown small', function () {
                var bg = new mxCell('Warning', new mxGeometry(0, 0, 100, 22), s + 'rrect;align=center;rSize=5;fillColor=#EFAC43;strokeColor=#EFAC43;fontColor=#ffffff;spacingRight=10;whiteSpace=wrap;');
                bg.vertex = true;
                var marker1 = new mxCell('', new mxGeometry(1, 0.5, 10, 5), 'shape=triangle;direction=south;fillColor=#ffffff;strokeColor=none;perimeter=none;whiteSpace=wrap;');
                marker1.geometry.relative = true;
                marker1.geometry.offset = new mxPoint(-20, -2.5);
                marker1.vertex = true;
                bg.insert(marker1);

                return sb.createVertexTemplateFromCells([bg], bg.geometry.width, bg.geometry.height, 'Dropdown (Small)');
            }),
            this.addEntry(dt + 'dropdown small', function () {
                var bg = new mxCell('Danger', new mxGeometry(0, 0, 100, 22), s + 'rrect;align=center;rSize=5;fillColor=#DB524C;strokeColor=#DB524C;fontColor=#ffffff;spacingRight=10;whiteSpace=wrap;');
                bg.vertex = true;
                var marker1 = new mxCell('', new mxGeometry(1, 0.5, 10, 5), 'shape=triangle;direction=south;fillColor=#ffffff;strokeColor=none;perimeter=none;whiteSpace=wrap;');
                marker1.geometry.relative = true;
                marker1.geometry.offset = new mxPoint(-20, -2.5);
                marker1.vertex = true;
                bg.insert(marker1);

                return sb.createVertexTemplateFromCells([bg], bg.geometry.width, bg.geometry.height, 'Dropdown (Small)');
            }),

            this.addEntry(dt + 'dropdown split', function () {
                var bg = new mxCell('Default', new mxGeometry(0, 0, 120, 30), s + 'rrect;fillColor=#ffffff;align=center;rSize=5;strokeColor=#dddddd;spacingRight=20;fontSize=14;whiteSpace=wrap;');
                bg.vertex = true;
                var button1 = new mxCell('', new mxGeometry(1, 0, 30, 30), inh + s + 'rightButton;rSize=5;perimeter=none;resizeHeight=1;');
                button1.geometry.relative = true;
                button1.geometry.offset = new mxPoint(-30, 0);
                button1.vertex = true;
                bg.insert(button1);
                var marker1 = new mxCell('', new mxGeometry(1, 0.5, 10, 5), 'shape=triangle;direction=south;fillColor=#000000;strokeColor=none;perimeter=none;');
                marker1.geometry.relative = true;
                marker1.geometry.offset = new mxPoint(-20, -2.5);
                marker1.vertex = true;
                button1.insert(marker1);

                return sb.createVertexTemplateFromCells([bg], bg.geometry.width, bg.geometry.height, 'Dropdown (Split)');
            }),

            this.addEntry(dt + 'dropdown split', function () {
                var bg = new mxCell('Primary', new mxGeometry(0, 0, 120, 30), s + 'rrect;align=center;rSize=5;fillColor=#3D8BCD;strokeColor=#0D5B9D;spacingRight=20;fontSize=14;fontColor=#ffffff;whiteSpace=wrap;');
                bg.vertex = true;
                var button1 = new mxCell('', new mxGeometry(1, 0, 30, 30), inh + s + 'rightButton;rSize=5;perimeter=none;resizeHeight=1;');
                button1.geometry.relative = true;
                button1.geometry.offset = new mxPoint(-30, 0);
                button1.vertex = true;
                bg.insert(button1);
                var marker1 = new mxCell('', new mxGeometry(1, 0.5, 10, 5), 'shape=triangle;direction=south;fillColor=#ffffff;strokeColor=none;perimeter=none;');
                marker1.geometry.relative = true;
                marker1.geometry.offset = new mxPoint(-20, -2.5);
                marker1.vertex = true;
                button1.insert(marker1);

                return sb.createVertexTemplateFromCells([bg], bg.geometry.width, bg.geometry.height, 'Dropdown (Split)');
            }),

            this.addEntry(dt + 'dropdown split', function () {
                var bg = new mxCell('Success', new mxGeometry(0, 0, 120, 30), s + 'rrect;align=center;rSize=5;fillColor=#58B957;strokeColor=#288927;spacingRight=20;fontSize=14;fontColor=#ffffff;whiteSpace=wrap;');
                bg.vertex = true;
                var button1 = new mxCell('', new mxGeometry(1, 0, 30, 30), inh + s + 'rightButton;rSize=5;perimeter=none;resizeHeight=1;');
                button1.geometry.relative = true;
                button1.geometry.offset = new mxPoint(-30, 0);
                button1.vertex = true;
                bg.insert(button1);
                var marker1 = new mxCell('', new mxGeometry(1, 0.5, 10, 5), 'shape=triangle;direction=south;fillColor=#ffffff;strokeColor=none;perimeter=none;');
                marker1.geometry.relative = true;
                marker1.geometry.offset = new mxPoint(-20, -2.5);
                marker1.vertex = true;
                button1.insert(marker1);

                return sb.createVertexTemplateFromCells([bg], bg.geometry.width, bg.geometry.height, 'Dropdown (Split)');
            }),

            this.addEntry(dt + 'dropdown split', function () {
                var bg = new mxCell('Info', new mxGeometry(0, 0, 120, 30), s + 'rrect;align=center;rSize=5;fillColor=#55BFE0;strokeColor=#258FB0;spacingRight=20;fontSize=14;fontColor=#ffffff;whiteSpace=wrap;');
                bg.vertex = true;
                var button1 = new mxCell('', new mxGeometry(1, 0, 30, 30), inh + s + 'rightButton;rSize=5;perimeter=none;resizeHeight=1;');
                button1.geometry.relative = true;
                button1.geometry.offset = new mxPoint(-30, 0);
                button1.vertex = true;
                bg.insert(button1);
                var marker1 = new mxCell('', new mxGeometry(1, 0.5, 10, 5), 'shape=triangle;direction=south;fillColor=#ffffff;strokeColor=none;perimeter=none;');
                marker1.geometry.relative = true;
                marker1.geometry.offset = new mxPoint(-20, -2.5);
                marker1.vertex = true;
                button1.insert(marker1);

                return sb.createVertexTemplateFromCells([bg], bg.geometry.width, bg.geometry.height, 'Dropdown (Split)');
            }),

            this.addEntry(dt + 'dropdown split', function () {
                var bg = new mxCell('Warning', new mxGeometry(0, 0, 120, 30), s + 'rrect;align=center;rSize=5;fillColor=#EFAC43;strokeColor=#BF7C13;spacingRight=20;fontSize=14;fontColor=#ffffff;whiteSpace=wrap;');
                bg.vertex = true;
                var button1 = new mxCell('', new mxGeometry(1, 0, 30, 30), inh + s + 'rightButton;rSize=5;perimeter=none;resizeHeight=1;');
                button1.geometry.relative = true;
                button1.geometry.offset = new mxPoint(-30, 0);
                button1.vertex = true;
                bg.insert(button1);
                var marker1 = new mxCell('', new mxGeometry(1, 0.5, 10, 5), 'shape=triangle;direction=south;fillColor=#ffffff;strokeColor=none;perimeter=none;');
                marker1.geometry.relative = true;
                marker1.geometry.offset = new mxPoint(-20, -2.5);
                marker1.vertex = true;
                button1.insert(marker1);

                return sb.createVertexTemplateFromCells([bg], bg.geometry.width, bg.geometry.height, 'Dropdown (Split)');
            }),

            this.addEntry(dt + 'dropdown split', function () {
                var bg = new mxCell('Danger', new mxGeometry(0, 0, 120, 30), s + 'rrect;align=center;rSize=5;fillColor=#DB524C;strokeColor=#AB221C;spacingRight=20;fontSize=14;fontColor=#ffffff;whiteSpace=wrap;');
                bg.vertex = true;
                var button1 = new mxCell('', new mxGeometry(1, 0, 30, 30), inh + s + 'rightButton;rSize=5;perimeter=none;resizeHeight=1;');
                button1.geometry.relative = true;
                button1.geometry.offset = new mxPoint(-30, 0);
                button1.vertex = true;
                bg.insert(button1);
                var marker1 = new mxCell('', new mxGeometry(1, 0.5, 10, 5), 'shape=triangle;direction=south;fillColor=#ffffff;strokeColor=none;perimeter=none;');
                marker1.geometry.relative = true;
                marker1.geometry.offset = new mxPoint(-20, -2.5);
                marker1.vertex = true;
                button1.insert(marker1);

                return sb.createVertexTemplateFromCells([bg], bg.geometry.width, bg.geometry.height, 'Dropdown (Split)');
            }),

            this.addEntry(dt + 'dropup split', function () {
                var bg = new mxCell('Dropup', new mxGeometry(0, 0, 120, 30), s + 'rrect;fillColor=#ffffff;align=center;rSize=5;strokeColor=#dddddd;spacingRight=20;fontSize=14;whiteSpace=wrap;');
                bg.vertex = true;
                var button1 = new mxCell('', new mxGeometry(1, 0, 30, 30), inh + s + 'rightButton;rSize=5;perimeter=none;resizeHeight=1;');
                button1.geometry.relative = true;
                button1.geometry.offset = new mxPoint(-30, 0);
                button1.vertex = true;
                bg.insert(button1);
                var marker1 = new mxCell('', new mxGeometry(1, 0.5, 10, 5), 'shape=triangle;direction=north;fillColor=#000000;strokeColor=none;perimeter=none;');
                marker1.geometry.relative = true;
                marker1.geometry.offset = new mxPoint(-20, -2.5);
                marker1.vertex = true;
                button1.insert(marker1);

                return sb.createVertexTemplateFromCells([bg], bg.geometry.width, bg.geometry.height, 'Dropup (Split)');
            }),

            this.addEntry(dt + 'dropup split', function () {
                var bg = new mxCell('Right dropup', new mxGeometry(0, 0, 140, 30), s + 'rrect;align=center;rSize=5;fillColor=#3D8BCD;strokeColor=#0D5B9D;spacingRight=20;fontSize=14;fontColor=#ffffff;whiteSpace=wrap;');
                bg.vertex = true;
                var button1 = new mxCell('', new mxGeometry(1, 0, 30, 30), inh + s + 'rightButton;rSize=5;perimeter=none;resizeHeight=1;');
                button1.geometry.relative = true;
                button1.geometry.offset = new mxPoint(-30, 0);
                button1.vertex = true;
                bg.insert(button1);
                var marker1 = new mxCell('', new mxGeometry(1, 0.5, 10, 5), 'shape=triangle;direction=north;fillColor=#ffffff;strokeColor=none;perimeter=none;');
                marker1.geometry.relative = true;
                marker1.geometry.offset = new mxPoint(-20, -2.5);
                marker1.vertex = true;
                button1.insert(marker1);

                return sb.createVertexTemplateFromCells([bg], bg.geometry.width, bg.geometry.height, 'Dropup (Split)');
            }),

            this.addDataEntry(dt + 'dropdown menu', 160, 90, 'Dropdown (Menu)',
                'rVTbbtswDP0aPzaw5TTYaxKv3UMLDOt+QItoS5gsGbKay75+pCQ7bu0CGToHAcw7eQ7prNy350fHO/lsBeis/JqVe2etj2/teQ9aZyxXIiurjLEc/xl7+MBaBGvecQfG3xLAYsCR61eImsrZTtiTiYbeX3QySN9ie1WRlbtecnRBIUdB8F6CSAJaOvJvzw3NtPqFk/QeX1fOwQFb2nGtGoMeB+wQHCrci/pDIfcU7p39DXurrQtFSxEesnT8oEzzQzWSBiuoWG2NT8HFBmUsKRSmncTDmn4TW6WoD2WpBWOdl2g7SeXhBQtQphM2i7qECzgP5w+xDaoE7CPYFry7oMtJCcobPNYR/1xC6hzFQcf7KDdj6JUpfElkLRNXzoibETZw4Z3ipiHtTkym7+1rmL5WWk8Qy8Mz48JYQwk6cAp7hYnqJqTYMlJvAy5pY1f3UZ7iuABj8nKguVdHeJNqCdpU/rtV2NVY+y5dyFD9jg3lhxy2rnvwM3LGMW7iaz3jaxuJYBsEPazz1lgvEVmWD6b/fIHxAN/xXYfn3TWxJC/tBekfeKs0AfYN9BG8OvAhQep2vkALx/wE9XjL40DF5Buhg8OOdgtL6G1Se9tdk/wkoSo/ebKJ/DWbb95m6YK//PMFo3j9rMcFmn71/wI='),
            this.addDataEntry(dt + 'dropdown menu', 160, 200, 'Dropdown (Menu)',
                '7VhRb6MwDP41PK4iQLne47W97WWTTteHe86GgWhpgkK2tvfrzyGhZQXaSgztOi1SJew4tvN9thXVCxfr7Z2iRf4gE+Be+NMLF0pKbb/W2wVw7gU+S7xw6QWBjz8vuO3ZJdWuX1AFQl9yILAHXil/AatZKlkkciPsRql33G3keo3pLYkXzsucogkKPgoJLXNInIA7hbFfbzNzp8kj3qTU+DlRCp4wpblasb/GYmqstZLPsJBcqipGmFTL7BT0iYnsN8tycw9ifKdSaHeYxEZmnDfO3lYL9ZSzTKCOQ6oPru4ryXra5EzDCvXG1wazQ50DApSGbS+YlcoheQdyDVrt0GTDEp07C2IB93NwuaMYOR0trZztjx6owQ/HTjdTYYupFkM1+FoxKjKjnSfMwM6kwaOULybLY9z8arXYEFIYBwUohrlCQ3URUkE3Um8P7FyJTqZWbuLYAaOzUsCpZq/wxlUXtC78L8kwq33sG9cSdfSboA5f+5BpWoJukbO/xkV8Ref5GtpRtqGO6Eyrdbq56mBkYN07BKOgTV/cwR+Zzob3wfTExMJoNMFSHQfozv7omC5H86fJT39TmeHWxVVz6JGe0aWgRIs/Dv2LSY3OD7NOFuNhbeiK5qgU3qXn4lZt/LDD7woL4uOJrufkQKJHYfpbm2khdW5636dfnH8059EYnM/ak5+V9JEjeYHPmXj+7ynvG/KfuRTiMUrh+/nHVU0rFgacfA11gH+VQM/GALp+hn89t678uUX8UcqDtMpjBXhpqq9nKH/m4Uve4/GF4uEPKWve/L/qHw=='),
            this.addDataEntry(dt + 'dropdown menu header', 160, 150, 'Dropdown (Menu, Headers)',
                '7Vffb9sgEP5r/NjIxk6WPS5J25dNmpaHPdP6bKNisDBtkv31OwxO3EBbq2mmtSpSJO64X3wfR3CULuvttaJN9UPmwKP0MkqXSkptZ/V2CZxHJGZ5lK4iQmL8ReTqidWkW40bqkDoMQ7EOjxQfg9Ws1KyyeVG2IVW77hbqHSN5a2SKF20FUUTFGIUctpWkDsBVxpjX29Ls6fJDe6k1TidKAW3WNJCrdkfYzE11lrJO1hKLlWXI827YVYaestE+YuVldlHYmIXUmjnnMyMzDgf+F51A/WUs1KgjkOhD6G+d5KNtKmYhjXqTawNVoc6BwQoDdsnwexUDslrkDVotUOTDct15SwSC3hcgasdxczpaGvlcu96oAYnjp0wU6nHlMdQD75WjIrSaBc5M7AzafBo5b2p8hi3uBseG0IKE6ABxbBWGKhGIUXCSD122LkjOplaeYhjAEZnpYBTzR7gUagQtC79T8mwqn3uC9cSffYL0qfvY8iiaEF75Oy3MYqv7GW+Tu0o21BHdBbdeL65+mTJiefeIZgRn75ZgL8knp/eB1MP12/2gJ8H3WBTBK6Uo0tnSIpzCl06Clq80H473EbTkb18DYXw7w/+axvI0X1E4pt0y8xnVUhd4bWDiT75/af8noXgL/5Dg7X0hiNTJOZM3P33/JrnR+g2/TC8Z+fgfT7+2YKnAJ793wq8Rd4l0LNzAP3VA3oNuGWq30+HBfj9MM01fwPOUTx8GVrz4YfjXw=='),

            this.addEntry(dt + 'input group', function () {
                var bg = new mxCell('Username', new mxGeometry(0, 0, 250, 30), s + 'rrect;rSize=5;strokeColor=#dddddd;fillColor=#ffffff;spacingLeft=50;fontSize=14;align=left;fontColor=#dddddd;whiteSpace=wrap;');
                bg.vertex = true;
                var bg2 = new mxCell('@', new mxGeometry(0, 0, 40, 30), s + 'leftButton;rSize=5;strokeColor=#dddddd;fillColor=#f0f0f0;whiteSpace=wrap;resizeHeight=1;');
                bg2.geometry.relative = true;
                bg2.vertex = true;
                bg.insert(bg2);

                return sb.createVertexTemplateFromCells([bg], bg.geometry.width, bg.geometry.height, 'Input Group');
            }),

            this.addEntry(dt + 'input group', function () {
                var bg = new mxCell('', new mxGeometry(0, 0, 250, 30), s + 'rrect;rSize=5;strokeColor=#dddddd;fillColor=#ffffff;spacingLeft=10;fontSize=14;align=left;fontColor=#dddddd;whiteSpace=wrap;');
                bg.vertex = true;
                var bg2 = new mxCell('.00', new mxGeometry(1, 0, 40, 30), s + 'rightButton;rSize=5;strokeColor=#dddddd;fillColor=#f0f0f0;whiteSpace=wrap;resizeHeight=1;');
                bg2.geometry.relative = true;
                bg2.geometry.offset = new mxPoint(-40, 0);
                bg2.vertex = true;
                bg.insert(bg2);

                return sb.createVertexTemplateFromCells([bg], bg.geometry.width, bg.geometry.height, 'Input Group');
            }),
            this.addDataEntry(dt + 'input group', 250, 30, 'Input Group',
                '1VTrToMwFH6a/nQpFF5gTOcPTUz2BHUcaGOhpJwN5tN7CnUXx3TR/bGE5Nwv35eWiazql0426tnmYJi4ZyJz1uIoVX0GxrCY65yJBYtjTj+LHy54o8HLG+mgxmsS4jFhK80GRstoaHFngkFhRWMtIibmrZK57UjhpOSyVZAHhTyNj6/60u8ye6UNWiRx5hysaZS5W+l3H5H6aHT2DTJrrBt6iHw45Cm0MUf2Yjg+o5FrXZdPUPi1Ut+ysDWGmlFCujS6rEkxQ8zgnurQKY2wonI+saMJyRZAAIfQXwRyMAUUl2ArQLejkE7nqAKY6Qg2V6BLFdJEsMl21Mt96oEWEgIz0yyJCZaSWxPlcZtvEG39a7a4/y5g7KClko+fyETXwh7/CHvyDeoOjES9hZPyf6EiOaNixvnN74xf5P9wcZpwa2ZCvxeraYx9s7vky72yRdECnlG5H3OKXVIPT+0YfvwSfwA='),
            this.addDataEntry(dt + 'input group', 250, 30, 'Input Group',
                'tVRdb4IwFP01PM4AFbNncXMPW7LE7AdUuNDGQkmpgvv1u6VFceJG9lFC0nO/7zlJPRIX7VrRir3IFIRHHjwSKym1vRVtDEJ4oc9Tj6y8MPTx98LHG96g8/oVVVDqKQmhTThQsQdreatBlbQA66j1UTgH0wWOtwo8sqwZTWWDwEeQ0ppB6gB6KhNftLnZabbFTWqN15lSkOBIS7Xh7yYiMtFayR3EUkjV9SBpd9CTcSEG9qw7JqOiCS/zZ8jMepFpmclSu5rBHDEVPC8RiC6mc491aBjXsMFyJrHBCdHmyAClob1JaGdybK5BFqDVEUManmrmSI0s6T4DnjOXRpyN1hbnp9SzPHhxCo2rRa7U+muVDGnLvday/LFUvvluEKygxpJPPS3BVM7Dbzmff0G5AkE1P8BF+d/oMP93HRIGyW4r24EKZEyFRXem0kjGaXQJ/iyyKcdPeEBzsLimubdNptlN8Co5DnZqf3d/0b2HfQGZZTXoK5VOa4wJh/D8lNrw4Uv7AQ=='),
            this.addDataEntry(dt + 'input group', 250, 30, 'Input Group',
                'tVTtToMwFH2a/nQBOhZ/j+n8oYnJ4gPUcYHGQknbDebTe0vLPoQp8aOEpOd+33OSEpqU7VqxuniSKQhC7whNlJTG3co2ASFIFPCU0BWJogB/Et1f8YadN6iZgspMSYhcwp6JHTjLiwZVsRKcQ5uD8I7ClDjeKiR0qQuWygZBgCBluoDUA/TUNr5sc7vT7BU30QavM6VgiyMt1Ya/24jYRhsl3yCRQqquB027g56MC3Fmz7pjM2q25VX+CJldL7YtM1kZXzOcI2aC5xUC0cV07rEOTcENbLCcTWxwQrR5MkAZaK8S2pk8m2uQJRh1wJCGp6bwpMaO9KAAnhc+jXob0w7nx9STPHjxCo2rRQdq/bVKlrTlzhhZ/ViqwH5XCFagseRDT0s4lfPoW87nX1CuQDDD93BR/jc6zP9dB8VSLgdC0DEhFt2ZyiQdZ9InBLPYpRw+4TOmw8WQ6d42mWk/wbPkONix/c3tRfce9gVklmkwA6GOa4xph/D0mrrw88f2Aw=='),
            this.addDataEntry(dt + 'username large', 250, 40, 'Username (Large)',
                'tVTrboMgGH0af65BafsAtVv3Y0uWNHsAVj+FDMEArXZPvw+ht9Vu3Q1jwvnunKMkNK+7hWENf9QFyITeJjQ3Wruwq7scpEwyIoqEzpMsI/gm2d0Fb9p7ScMMKHdNQhYSNkyuIVieLRjFaggO67YyOrircbx5mtCZ5azQLQKCoGCWQxEBehofX3eVP9PoBU9iHW5HxsAKR5qZpXjzERMf7Yx+hVxLbfoetOgXekoh5ZG97JfPaNhKqOoBSn+8qW9ZauVizXSKmElRKQSyj+ndQx1aLhwssZxPbHFCtEUywDjoLhLamyKbC9A1OLPFkFYUjkdSJ4F0wkFUPKaNo43ZgKt96kEe3ESFhtWiZ2r9tUqetNnaOa1+LBXxzwWCDVgseb+jJb2W8+xLzj+j3IBkTmzgpPxvdBj/uw5r/As/VUBpBefkk35dyyodZjUmkNEkpGw/4OMvfYD17LusxwmetMDB9u1vUnLSfo93JXRZWnBnsu0PMqQkwsPdGsKPr953'),
            this.addDataEntry(dt + 'username normal', 250, 30, 'Username (Normal)',
                'tVTJboMwEP0ajo0MDuo9pE0PrVQp6ge4YQCrBiPbCaRf3/GSpYG0qIsRkmd5s7wniGhW9yvF2upJ5iAiehfRTElp/K3uMxAiSgjPI7qMkoTgGyX3V6Kxi5KWKWjMFEDiATsmtuA9LxpUw2rwAW32IgQqU+N4yziiC12xXHZoEDRypivIg4GR1ubXfWl3mr3iJtrgdaYUbHCkhVrzd5uR2myj5BtkUkjletDcHYwUXIgzf+GORbRsw5vyEQq7XmpbFrIxoWY8R5sJXjZoCJfjwmMduoobWGM5C+xwQvQFMkAZ6K8S6lyBzRXIGozaY0rHc1MFUlNPOqmAl1WA0eBj2tvlEXqSBy9BoXG16ECtv1bJkrbYGiObH0tF7HOFYAUaSz4caImncp58y/n8C8oVCGb4Dj6V/40O83/XYYtf4ZcKNLKBIfnEnams0nFWA4DMUg/ZX9hnrMfpkPWDbzLrYYJnyXGwY/ub24v+J8ehiCwKDWYg3HGVMS3RPP1dffr5z/cD'),
            this.addDataEntry(dt + 'username tiny', 250, 20, 'Username (Tiny)',
                'tVRZbsMgFDwNn42wSS6QpMtHK1WKegAaPxtUDBaQ2Onp+8Bka5w03bAsMbx9xoawWd3dW96IJ1OAIuyWsJk1xve7upuBUiSnsiBsTvKc4kvyuzPWLFppwy1of01A3gesuVpBf/LiwGpeQ29wfqOSQfga25tnhE2d4IVpEVAEBXcCigTQ0gT/uqvCTKNXnMR53I6shSW2NLUL+R48JsHbW/MGM6OMjTVYERdaSqnUwXkZV4ho+FLq6hHKMN44lCyN9ilnFjBXstIIVPSJ5qEKrZAeFpguBLbYIZ4lMsB66M4SGo8Sm/dgavB2gy6tLLxIpE560qkAWYkUloSg3PW42oXu5cFNUmhYLXai1l+rFEibrrw3+sdS0fCcIdiCw5QPW1qyqwjPvyScXeDbguJeruEo/W9EGP+7CCv8BS/Sr42GU+ZpXNd+xmyY1RRAR5M+ZPMJH7CeDbCefZf11MGzkdjYrvzNcfUt3CYwZenAn4i2G2NIR4T7a7V3P7x1PwA='),

            this.createVertexTemplateEntry(s + 'rrect;rSize=5;fillColor=#ffffff;strokeColor=#dddddd;fontSize=16;align=left;spacingLeft=10;whiteSpace=wrap;',
                250, 40, 'Johnny Boo', 'Full Name (Large)', null, null, this.getTagsForStencil(gn, '', dt + 'full name large').join(' ')),
            this.createVertexTemplateEntry(s + 'rrect;rSize=5;fillColor=#ffffff;strokeColor=#dddddd;fontSize=14;align=left;spacingLeft=8;whiteSpace=wrap;',
                250, 30, 'Johnny Boo', 'Full Name (Normal)', null, null, this.getTagsForStencil(gn, '', dt + 'full name normal').join(' ')),
            this.createVertexTemplateEntry(s + 'rrect;rSize=5;fillColor=#ffffff;strokeColor=#dddddd;fontSize=10;align=left;spacingLeft=6;whiteSpace=wrap;',
                250, 20, 'Johnny Boo', 'Full Name (Tiny)', null, null, this.getTagsForStencil(gn, '', dt + 'full name tiny').join(' ')),

            this.addEntry(dt + 'final price large', function () {
                var bg = new mxCell('Amount', new mxGeometry(0, 0, 200, 40), s + 'rrect;fillColor=#ffffff;rSize=5;strokeColor=#dddddd;spacingLeft=10;fontSize=16;align=left;fontColor=#dddddd;whiteSpace=wrap;');
                bg.vertex = true;
                var bg1 = new mxCell('UAH', new mxGeometry(1, 0, 50, 40), s + 'rightButton;rSize=5;strokeColor=#dddddd;fillColor=#f0f0f0;fontSize=16;whiteSpace=wrap;resizeHeight=1;');
                bg1.geometry.relative = true;
                bg1.geometry.offset = new mxPoint(-50, 0);
                bg1.vertex = true;
                bg.insert(bg1);

                return sb.createVertexTemplateFromCells([bg], bg.geometry.width, bg.geometry.height, 'Final Price (Large)');
            }),

            this.addEntry(dt + 'final price normal', function () {
                var bg = new mxCell('Amount', new mxGeometry(0, 0, 200, 30), s + 'rrect;fillColor=#ffffff;rSize=5;strokeColor=#dddddd;spacingLeft=8;fontSize=14;align=left;fontColor=#dddddd;whiteSpace=wrap;');
                bg.vertex = true;
                var bg1 = new mxCell('UAH', new mxGeometry(1, 0, 40, 30), s + 'rightButton;rSize=5;strokeColor=#dddddd;fillColor=#f0f0f0;fontSize=14;whiteSpace=wrap;resizeHeight=1;');
                bg1.geometry.relative = true;
                bg1.geometry.offset = new mxPoint(-40, 0);
                bg1.vertex = true;
                bg.insert(bg1);

                return sb.createVertexTemplateFromCells([bg], bg.geometry.width, bg.geometry.height, 'Final Price (Normal)');
            }),

            this.addEntry(dt + 'final price tiny', function () {
                var bg = new mxCell('Amount', new mxGeometry(0, 0, 200, 20), s + 'rrect;fillColor=#ffffff;rSize=5;strokeColor=#dddddd;spacingLeft=6;fontSize=10;align=left;fontColor=#dddddd;whiteSpace=wrap;');
                bg.vertex = true;
                var bg1 = new mxCell('UAH', new mxGeometry(1, 0, 30, 20), s + 'rightButton;rSize=5;strokeColor=#dddddd;fillColor=#f0f0f0;fontSize=10;whiteSpace=wrap;resizeHeight=1;');
                bg1.geometry.relative = true;
                bg1.geometry.offset = new mxPoint(-30, 0);
                bg1.vertex = true;
                bg.insert(bg1);

                return sb.createVertexTemplateFromCells([bg], bg.geometry.width, bg.geometry.height, 'Final Price (Tiny)');
            }),
            this.addDataEntry(dt + 'segmented button large', 400, 40, 'Segmented Button (Large)',
                'vZXdTuswDMefhYteUvWDIrjddhgX50hIEw8QVreJTtpUicc2nh6nSUdHu1HERKRKsWM7zv+npEE6r3ZLzRr+T+Ugg/RPkM61Uuhm1W4OUgZJJPIgXQRJEtEXJA8nVuN2NWqYhhqnJCQu4ZXJDTjPCphe8zAM3YrBvfQrHCvqbxEH6cxwlqstGREZOTMccm/QSmPjq11pDxW+0FEM0jTUGtbU06wQUs6VVLqtmhbtIL9eiTebmdkqqNV/6EXl7bDZqkYfGN96eyyOSVHW5JNQ2E1Nw9aiLv+21uLedrrlAmFFfltrSx2Sz6sBGmF3UtHW5eVcgqoA9Z5CtiJH7iJuIqd6xEGUHDun8zHj7PKQ+sGHJh7ROK50gOvZgDaXRmVFm20QVT2dS49qrWoYQXUWSXwKiQZDNR47IeOplJIvKd2dgaRBMhSvcFT+J+RuBuQG0DoeqAWrS+ud5cJeGmE5LIza2M4/35+oHQM2nkEDWlCv0HNNUi8dV+84Ye9fmDBzdk/beETb7JvS+u2flKCuDntf+xet2/066bbvaqiiMIADOIdjTOKVDXgt1dXFn0QrzuUv2i9co+OEHvjsEpfqBPks+jloMj/+ri68//N9Bw=='),
            this.addDataEntry(dt + 'segmented button normal', 400, 30, 'Segmented Button (Normal)',
                'vZXfT4MwEMf/Fh94lADd1OdtOh80MVn8A+o4aGOhpO1++dd7pWVjwiZmi01Iete76/X7SUtApsV2rmjFXmUKIiCPAZkqKY2bFdspCBEkEU8DMguSJMIvSJ5OrMb1alRRBaUZkpC4hDUVK3CeBVC1ZGEYuhVtdsKvMFNgf7M4IBPNaCo3aERopFQzSL2BK5WNL7a5PVT4gUfRBqehUrDEniYZF2IqhVR1VZLVA/1qwb9s5thWMUp+QisqrYfNlqXxgfHI231xVPC8RJ+AzG6qK7rkZf5SW7MH2+mGcQML9NtaG+wQfV4NUAa2JxWtXV7OOcgCjNphyIanhrmIUeRUjxjwnPk04n1UOzvfpx744MQj6sdFOrjeNSh9bVRWtMnKGFkO59KiWsoSelCdRXJ3gogCjSWeGx3joZCSXyHdn2GkQFDD13BU/hJwow64DrMGh1Gclrn1TlJu7wy3GGZarmznP69PVI8OGo+gAsWxV2i5BqlH+tU7Ttj5ByYcO7ulbdyj7fiP0vrt3yTHrvZ73/oHrdn9Nmm2b2rILNNgOnD2xxjEa9zhNZc3V38RrTjXv2f/cI2OE45evitcqhPkR9HloNE8/FxdePvf+w0='),
            this.addDataEntry(dt + 'segmented button tiny', 400, 20, 'Segmented Button (Tiny)',
                'vZXfT8MgEMf/Fh/6aEOL0/dtOh80MVn8A3C9FiItDbBf/vUehc7OdlqzRZIm3HF3HN9PoBGdlbuFZjV/VhnIiN5HdKaVsn5W7mYgZZQSkUV0HqUpwS9KH06sJs0qqZmGyo5JSH3Chsk1eM8SmF7xOI79irF7GVa4LbG/eRLRqeEsU1s0CBoZMxyyYOBK7eLLXeEOFb/hUYzFaaw1rLCnaS6knCmpdFOV5s1Av16KD5c5cVWsVu/Qicqa4bJVZUNgQoI9FMekKCr0ScjdpqZmK1EVT401v3OZWy4sLNHvam2xQ/QFNUBb2J1UtHEFORegSrB6jyFbkVnuI26IV51wEAUPaYEEYcbbxSH1iw9OAqJhXLSH69WANpdG5USbrq1V1XguHaqVqmAA1Y9I6AkiGgyWeGx1TMZCSn+FdPsDIw2SWbGBo/LngLvpgesxa3FYLVhVOO80E+7OCIdhbtTadf79+pBm9NAEBDVogb1CxzVKPTqs3nHCPjww8cTbHW2TAW0nf5Q2bP+iBHZ12Pu6RbRv7Xb7tobKcwO2B+dwjFG8Jj1eC3V18RfRiXP5e/YP1+g4oQOeXuJSnSBPyfmg0fz6ufrw7r/3Ew=='),

            this.addEntry(dt + 'search button large', function () {
                var bg = new mxCell('Search...', new mxGeometry(0, 0, 200, 40), s + 'rrect;fillColor=#ffffff;rSize=5;strokeColor=#dddddd;align=left;spacingLeft=10;fontSize=16;fontColor=#dddddd;whiteSpace=wrap;');
                bg.vertex = true;
                var bg1 = new mxCell('Go!', new mxGeometry(1, 0, 50, 40), s + 'rightButton;rSize=5;strokeColor=#dddddd;fillColor=none;fontSize=16;whiteSpace=wrap;resizeHeight=1;');
                bg1.geometry.relative = true;
                bg1.geometry.offset = new mxPoint(-50, 0);
                bg1.vertex = true;
                bg.insert(bg1);

                return sb.createVertexTemplateFromCells([bg], bg.geometry.width, bg.geometry.height, 'Search Button (Large)');
            }),

            this.addEntry(dt + 'search button normal', function () {
                var bg = new mxCell('Search...', new mxGeometry(0, 0, 200, 30), s + 'rrect;fillColor=#ffffff;rSize=5;strokeColor=#dddddd;align=left;spacingLeft=6;fontSize=14;fontColor=#dddddd;whiteSpace=wrap;');
                bg.vertex = true;
                var bg1 = new mxCell('Go!', new mxGeometry(1, 0, 40, 30), s + 'rightButton;rSize=5;strokeColor=#dddddd;fillColor=none;fontSize=14;whiteSpace=wrap;resizeHeight=1;');
                bg1.geometry.relative = true;
                bg1.geometry.offset = new mxPoint(-40, 0);
                bg1.vertex = true;
                bg.insert(bg1);

                return sb.createVertexTemplateFromCells([bg], bg.geometry.width, bg.geometry.height, 'Search Button (Normal)');
            }),

            this.addEntry(dt + 'search button tiny', function () {
                var bg = new mxCell('Search...', new mxGeometry(0, 0, 200, 20), s + 'rrect;fillColor=#ffffff;rSize=5;strokeColor=#dddddd;align=left;spacingLeft=3;fontSize=10;fontColor=#dddddd;whiteSpace=wrap;');
                bg.vertex = true;
                var bg1 = new mxCell('Go!', new mxGeometry(1, 0, 30, 20), s + 'rightButton;rSize=5;strokeColor=#dddddd;fillColor=none;fontSize=10;whiteSpace=wrap;resizeHeight=1;');
                bg1.geometry.relative = true;
                bg1.geometry.offset = new mxPoint(-30, 0);
                bg1.vertex = true;
                bg.insert(bg1);

                return sb.createVertexTemplateFromCells([bg], bg.geometry.width, bg.geometry.height, 'Search Button (Tiny)');
            }),
            this.addDataEntry(dt + 'dropdown menu', 300, 300, 'Dropdown (Menu)',
                '7Zhtb5swEIB/DR8b8Za3jwnpKq3tNDWdpn104QAvBCPjvO3X7wyGkEFWJEpTqSGKxNlnn33P3cWxZjnr/R0nSfjIPIg061azHM6YyN/WeweiSDN16mnWQjNNHb+a+eVMr5H16gnhEIs2A8x8wJZEG8hbFpsXQjXTwdYfs9u8OxWHSHWHYo2LXBiaNU9D4rEdCjoKHklD8JSAPYnUX+8DubPBC+4nFfg64BxcXNicL+kfqTGU2oKzFTgsYjyzYXnZI3sS4tI4eKJBKHdjyLl9Fgs12BihjBY8irutjAdbfip9CyrNUhZjf8y4CI9zP4BfTk0iGkiVKGub70IqYIlq0tYOV49tyl3ABezPujxrUv6+A7YGwQ+osqOetCw1LD3Hooeg9oairdpImstBOfQIEF8Uw2aeVo1njWABR3BK4kC2zr2Kf1K2yfzj0yiq+FTPnhqtmMVyggQ4xbVCpamVp8xmT50OOKhAHgxzueJHo8GNSotDRATdwslUTa5V5r8ziqsqbd8YwxPrN2ZhvpiD+X4Kogan3EYrXvbrvLpmXJ5w/+D0s6dN8lUTpLRv1LNFkqYuiWaqWbDkOMmzFBZWh0g5k1OKjm3WQqMxxczhpHuODWvMlkC4Gw4Ggw9RLv9T0mTxbBrZVOo4pGj0p/Ko0RaU/WrxMycNZCz9TdK2KAgqLqY9pOyohn8O9Df6Pf/RdEIak56SuBP6SgE4X7XfNRAaU7RrIBQVYdID+vF7n5beALs8LqkFGZ8vDMZ9hMGk9x9tNwR3VZIvfG41xcIoe9rSGPdw4Jr0c+CyeyA3rZG7p7BV+bvihGL0f8Ac/lw5a+h9JG0RuRX2Dyz28D9PTv/+Cv7i4K1ewBs18I8sdRFnBv5pk6b0emC7PPxRL/DrF1zfAMnrvxhfqcxfzq70L05/2gv9+nXYM1sdWA7+K0lIfEV/afTlAbILehSPl+a5evVO/S8='),
            this.addDataEntry(dt + 'dropdown menu', 200, 252, 'Dropdown (Menu)',
                '7Zhtb5swEIB/DR8b8ZYs/ZiQrtLaTlPTaepHFw7w4mBknLf9+p3BISQQjS5hmbY4isTd2Xf2PT4bYTjefH0vSBo/8QCY4dwZjic4l8XTfO0BY4Zt0sBwJoZtm/g37I9HrFZuNVMiIJFtBtjFgCVhCyg0k8UboYbtofbr6K4wZ3LDtDmWc5zkxDKccRaTgK9QMFEISBZDoAW0pKr/fB2plfXecD2ZxMeeEODjxMZiSn+oHn3VWwo+A48zLvIYTpA3ZUmJT5PomUaxWo2lfIc8kXqwNUAZIwQUV1sZD676VWwTqsJSnqA94ULGO9+PEJauCaOR6sJy3XgVUwlT7KZirXD2qNPpAiFhfTTluUrn+x74HKTYYJcVDVTkPO1mgcWMQa8NRVfrSFbIUTl0BxAfNMNmnk6NZ43gFo4UlCSR0o6DSn4yvsjzE1LGKjk181ajlfBEOUhBUJwrVFStMmU3Z2p/wEZv5F6/kCt5tBrSqHsJYETSJey5akqtDv+FU5xVGfvG6u9Fv7G34bc+eBhmIGtwymW04uX+mtepFVcU3AHOMG9tiq9aIGV8q14tijT1CRtpteTpzsmLEibOCTvlSE1pOq5d2xqNJVZumFNqrF9jNgb6HVdZnJpeTBPSEcV30ToAVN0Bx8u26dATkOGB+03n1mqLzP29Y9Ax31nAbbkN/vRddwZm6rLTE7L+ZYYHh/Bm381Zj9wPnR+5fgz+rCS/zbnTtBcGeWtLY9DBdTns5rp0OyA3rJF7oLDU9TsThOLu/wtr+P+q2UEXNXtbI//IkwDfVwv2D1fsl8Z+2wX27XlV4f7EMx9p5tyfF1lGr69aF2dv2Z3At2rwPwOSN1+5mOnCn46u9C9Ov98J/fqXqRc+2/AC/CeSkuSK/uLoh2dAj+Lue2fRvfo59Cc='),
            this.addDataEntry(dt + 'context menu', 140, 128, 'Context Menu',
                '7VfLbsIwEPyaXJHjlEePBVourVSJQ88u2cQWjh05Lo9+fdexeTWgogokQCAh2eNdr3dmEjlRMigWI8NK/qZTkFHyHCUDo7X1o2IxACkjSkQaJcOIUoL/iL4cWI3rVVIyA8oek0B9wozJL/CIByq7lAHgtsBjDeMo6VecpXqOE4KTlFUc0jDBldLFF4vc9dL6xA4qi8OWgQmepJ8JKQdaalNvmmT1zyVao6ewtZLWv+1irvKcCwvjkk1ckTnui1g4OhgLi4Pt11DofQS6AGuWGDIXqeUh4sFTRDiInK/SaM+DrPJAvs7dsImDQOh+cpMGuUOjS2xK1dVYCuZMbO+yqrQCByJ9QuWvkLkmO4gwKXKFY1lDOxqFnBKMwL5hC8q0svv0cvhYfLtzxeSAZAYqjPgI5MfHikj/KWLHYwYks2IGO/vvEzaUeNcCK1Oy9BG/nKCzrALb8MH6XEdZ46FhjaeJFVpdqR9uUveVSCcVvt0UXmnL3ZuAsLsFLswCq61PaoFOwwJjl85RCIRBVlA3Y+DuhMtxQrtzBid0/759rdSUwst08Lq0R4yrJLpLz0B0734Tu4WHsHeOq9hj83UM2DKzKDIl+NxNr9QaN2mBmJzgVobTzSe2D9/+Av8B'),
            this.addDataEntry(dt + 'context menu', 140, 96, 'Context Menu',
                '7VZRb4IwEP41vBooE7fHiZsvW7LEhz13ctDGQknpBPfrd6VVIWhmNk1cIglJ7+td7+77rgEvjPNmrmjJXmUCwgufvDBWUmq7ypsYhPCIzxMvnHmE+Ph65PnIbtDu+iVVUOhTAogNWFPxCRaxQKU3wgFM51jWLPDCacVoIms0fDQSWjFInIE7pfHPm8z0MvrADiqNy5GCJVYyTbkQsRRStYeGafuYQK3kCjo7Sft0k5nMrkxQGpqjrbaQ63MOMgetNuhS80Qz53Fn6fAZ8Iy5sIfIYrSydrYL3ROHC8fdYR7DAY+PS81lcSE2+6wVsgADlnTJi+wFUtNYhAgVPCtwLVqop4GLKUFxbBY6UCoLveBfJn9giqkZ17DAsw1SYxGIKajQ490Re7JA5HcCBU4gBYJqvobe+YdUcyneJMfMxN9Yj/t+gEzTCvRA5F1dJ+l+N9S9kJohn5joNgFXNgFbuc46AuPBCCxMOEMhEAZRQduMgtskXM8kbI8+6yREP39Mt2oKbmU6+vU7IMa/JHocXYDoyfDKAbZMNd4a4iO3q9tdu54RmJC/jwCa+59i6979Z/4G'),

            this.addEntry(dt + 'pagination', function () {
                var bg = new mxCell('', new mxGeometry(0, 0, 330, 30), s + 'rrect;fillColor=#ffffff;strokeColor=#dddddd;whiteSpace=wrap;');
                bg.vertex = true;
                var bg2 = new mxCell('<<', new mxGeometry(0, 0, 30, 30), inh + s + 'leftButton;fontColor=#3D8BCD;whiteSpace=wrap;');
                bg2.vertex = true;
                bg.insert(bg2);
                var bg3 = new mxCell('1', new mxGeometry(30, 0, 30, 30), inh + s + 'rect;perimeter=none;fontColor=#3D8BCD;whiteSpace=wrap;');
                bg3.vertex = true;
                bg.insert(bg3);
                var bg5 = new mxCell('3', new mxGeometry(90, 0, 30, 30), inh + s + 'rect;perimeter=none;fontColor=#3D8BCD;whiteSpace=wrap;');
                bg5.vertex = true;
                bg.insert(bg5);
                var bg6 = new mxCell('4', new mxGeometry(120, 0, 30, 30), inh + s + 'rect;perimeter=none;fontColor=#3D8BCD;whiteSpace=wrap;');
                bg6.vertex = true;
                bg.insert(bg6);
                var bg7 = new mxCell('5', new mxGeometry(150, 0, 30, 30), inh + s + 'rect;perimeter=none;fontColor=#3D8BCD;whiteSpace=wrap;');
                bg7.vertex = true;
                bg.insert(bg7);
                var bg8 = new mxCell('6', new mxGeometry(180, 0, 30, 30), inh + s + 'rect;perimeter=none;fontColor=#3D8BCD;whiteSpace=wrap;');
                bg8.vertex = true;
                bg.insert(bg8);
                var bg9 = new mxCell('7', new mxGeometry(210, 0, 30, 30), inh + s + 'rect;perimeter=none;fontColor=#3D8BCD;whiteSpace=wrap;');
                bg9.vertex = true;
                bg.insert(bg9);
                var bg10 = new mxCell('8', new mxGeometry(240, 0, 30, 30), inh + s + 'rect;perimeter=none;fontColor=#3D8BCD;whiteSpace=wrap;');
                bg10.vertex = true;
                bg.insert(bg10);
                var bg11 = new mxCell('9', new mxGeometry(270, 0, 30, 30), inh + s + 'rect;perimeter=none;fontColor=#3D8BCD;whiteSpace=wrap;');
                bg11.vertex = true;
                bg.insert(bg11);
                var bg12 = new mxCell('>>', new mxGeometry(300, 0, 30, 30), inh + s + 'rightButton;fontColor=#3D8BCD;whiteSpace=wrap;');
                bg12.vertex = true;
                bg.insert(bg12);
                var bg4 = new mxCell('2', new mxGeometry(60, 0, 30, 30), s + 'rect;strokeColor=#3D8BCD;fillColor=#3D8BCD;perimeter=none;fontColor=#ffffff;whiteSpace=wrap;');
                bg4.vertex = true;
                bg.insert(bg4);

                return sb.createVertexTemplateFromCells([bg], bg.geometry.width, bg.geometry.height, 'Pagination');
            }),

            this.createVertexTemplateEntry(s + 'roundedButton;fillColor=#ffffff;align=center;strokeColor=#dddddd;fontColor=#3D8BCD;whiteSpace=wrap;',
                100, 30, 'Previous', 'Button (Previous)', null, null, this.getTagsForStencil(gn, '', dt + '').join(' ')),
            this.createVertexTemplateEntry(s + 'roundedButton;fillColor=#ffffff;align=center;strokeColor=#dddddd;fontColor=#3D8BCD;whiteSpace=wrap;',
                60, 30, 'Next', 'Button (Next)', null, null, this.getTagsForStencil(gn, '', dt + '').join(' ')),

            this.addEntry(dt + 'button older', function () {
                var bg = new mxCell('Older', new mxGeometry(0, 0, 100, 30), s + 'roundedButton;fillColor=#ffffff;align=center;strokeColor=#dddddd;fontColor=#dddddd;spacingLeft=10;whiteSpace=wrap;');
                bg.vertex = true;
                var bg2 = new mxCell('', new mxGeometry(0, 0.5, 16, 4), s + 'arrow;strokeColor=#dddddd;flipH=1;');
                bg2.geometry.relative = true;
                bg2.geometry.offset = new mxPoint(12, -2);
                bg2.vertex = true;
                bg.insert(bg2);

                return sb.createVertexTemplateFromCells([bg], bg.geometry.width, bg.geometry.height, 'Button (Older)');
            }),

            this.addEntry(dt + 'button newer', function () {
                var bg = new mxCell('Newer', new mxGeometry(0, 0, 100, 30), s + 'roundedButton;fillColor=#ffffff;align=center;strokeColor=#dddddd;fontColor=#3D8BCD;spacingRight=10;whiteSpace=wrap;');
                bg.vertex = true;
                var bg2 = new mxCell('', new mxGeometry(1, 0.5, 16, 4), s + 'arrow;strokeColor=#3D8BCD;');
                bg2.geometry.relative = true;
                bg2.geometry.offset = new mxPoint(-28, -2);
                bg2.vertex = true;
                bg.insert(bg2);

                return sb.createVertexTemplateFromCells([bg], bg.geometry.width, bg.geometry.height, 'Button (Newer)');
            }),
            this.addDataEntry(dt + 'tabs', 460, 45, 'Tabs',
                'tZZRk5sgEMc/jY/JoCTWPjaxvT70Zjq9fgESN8ocigPkkvTTd1FMTDA3uVaZcQaWXRf+P1YJ6Lo8PilWF88yAxHQrwFdKylN2yuPaxAiiAjPApoGUUTwCaJvd2bDZpbUTEFlHgmI2oA3JvbQWr7LElqjNifhjIUpcWlpGNCVLlgmDzggOMiYLiBzA5yprX95zO1+5hvchTbYnRu2+S1rdNlxIdZSSNW8lu6ahnYmeF6hbYvLBmUdZWV6jqRpNodR8hV6M1nTcEa98D82+xL7h4IbeKnZ1hoOuAK0uY2CMnC8K1Zjcko9ASph1AldDjwzReuxTNqoAnheuKhFqzFhuh3n58iL8thx4g+DoB6IlGu2EahuRH7w6nV0JrJe7Y2R1TtYrtWuZAU3Qt9gOsMYG4ALiN1x7fEICZkGyMID8gxasxz0lCT8QhgJDU2T1Tq1gUiFV/kvpxYl0+EK49jnFcbT8Fp6vDqE45FSCramp3PiA/rctHuAbqCcadagOO4Yeq7/zGTxPpM24OR+DvOlR6hTsg+og6ZAMMPf4OpdQ9Rc/p+S47LOyWc0vko/S67fIHc7Dcajft7FQwch9g7Cl63hWF34HZX5pNU7dbFGExZrlAwUK5moWD95jDwsneJGcVbl1rrKuK0/i5KmWu7tKm8lvyg3JPlAmT2kXPyfJRUO/KOW41TUTfZZ1KUftaaSx3kJ3uh6/6I2wlntLmFu09RXfEGiga/Yx08uDi+X8Va4/l39Lw=='),
            this.addDataEntry(dt + 'pills', 392, 45, 'Pills',
                '3ZbdbpswFMefhstEgANjlwO27mKVpvUJ3HACVg1Gttske/odg6Ekhipdx80sIdnH5/jj//Mx9khWn+4kbat7UQD3yFePZFII3dfqUwace6HPCo/kXhj6+Hnht4XeoOv1Wyqh0bcEhH3AC+XP0Fu+ixp6o9Jnbo2VrnFpeeCRVFW0EEds+NgoqKqgsA3saY1/fSrNfraPuAulsbqVEva4nJRyVjboscfVgUSDfGC/TUhkwrUUT5AJLrAnb0SDHemBcT6YvJCQPEmz3NhFoyf2Q1euBjxWTMNDS/fGcMR1oM1uF6SG06JkncnqdQeoh5ZndDmyQle9R5T0URWwsrJRu15pn6q+XY6Rr/pjxSKYx0EcHDlT9JGjxqH/gzVPa5G50nnU801iS9CmPlegiq6sAMcGxPZAT1gFvr8OrJ0D6x6UoiWotShdCHsrsfciGnNMIR3WlL+sasRfD1sQxy63IF6HW+RwG1CuRyxxiX3uyuLFt3DBtSAZ7hgmrn/NZPc2kz7gbH8j28ghNCg5BTRAk8CpZi9wMdYcNTv/T8FwWePkGxJfTL9JLkcQh4MC7VAfd3HTQYidg/Blr5lozF0ryv8zi8MVszhMZrLYXymLPznwHF4DCi0ZbUpjTQtmIBjGJFfi2axy8Y0xK/lM/t2kXPzBXAtmfmLRv0m1q9k34TD9R5INm6+v2N59+sj9Aw=='),
            this.addDataEntry(dt + 'breadcrumb', 460, 30, 'Breadcrumb',
                '7ZZdb4IwFIZ/TW8NtH7sGph64ZIl/oIqB2lWKCmd4H79Tm39irqZTI1LhJC0b8+hp+/DSSAsLtqR5lX+plKQhL0SFmuljBsVbQxSEhqIlLCEUBrgQ+jwzGq4Xg0qrqE0lyRQl7Dk8hOc4oTarKQXclNgWUlIWFTnPFUNTgKcpLzOIfUTXKlsfNEu7Fk6MzxBbXDY0RrmWEqkp+LLRvRstNHqA2IllUalVCUuRJmQciMRyrK+vVH3FYI20J495VryRxyBKsDoFYY0IjW5i+j2nRNBDmKR+zTmNV67+WKbuvMMB9620xayIwvH+JKr2+hcrEALrBD2fPvVzI2kSrPnL0teojix+RWfi3IxgcyaEtoymlwYmKJua2lwe8sPagQ43pgXXkqG/kqm9wMYDZIbsYSD1/+FVvfEBz98eFjp+ro7GXoNMn6HdyVwYxq0h9A3GSrLajBHJLd1XQS3dwR3Imaa+y/kkQFvu/Eftt5pwINbAO4/u/chujekt6A7OKKbcMOfeO/eu2H3CnhxuvuPdeH7v7nf'),

            this.addEntry(dt + 'pills vertical', function () {
                var bg = new mxCell('', new mxGeometry(0, 0, 200, 158), s + 'rrect;rSize5=;strokeColor=none;fillColor=#ffffff;');
                bg.vertex = true;
                var bg1 = new mxCell('Home', new mxGeometry(0, 0, 200, 30), s + 'rrect;rSize=5;strokeColor=none;fillColor=#3D8BCD;fontColor=#ffffff;align=left;spacingLeft=10;whiteSpace=wrap;resizeWidth=1;');
                bg1.geometry.relative = true;
                bg1.vertex = true;
                bg.insert(bg1);
                var notif1 = new mxCell('42', new mxGeometry(1, 0.5, 25, 16), s + 'rrect;rSize=8;fillColor=#ffffff;strokeColor=none;fontColor=#3D8BCD;whiteSpace=wrap;');
                notif1.geometry.relative = true;
                notif1.geometry.offset = new mxPoint(-33, -8);
                notif1.vertex = true;
                bg1.insert(notif1);
                var bg2 = new mxCell('Profile', new mxGeometry(0, 0, 200, 30), inh + s + 'rect;fontColor=#3D8BCD;align=left;spacingLeft=10;whiteSpace=wrap;resizeWidth=1;');
                bg2.geometry.relative = true;
                bg2.geometry.offset = new mxPoint(0, 32);
                bg2.vertex = true;
                bg.insert(bg2);
                var bg3 = new mxCell('Messages', new mxGeometry(0, 0, 200, 30), inh + s + 'rect;fontColor=#3D8BCD;align=left;spacingLeft=10;whiteSpace=wrap;resizeWidth=1;');
                bg3.geometry.relative = true;
                bg3.geometry.offset = new mxPoint(0, 64);
                bg3.vertex = true;
                bg.insert(bg3);
                var notif2 = new mxCell('24', new mxGeometry(1, 0.5, 25, 16), s + 'rrect;rSize=8;fillColor=#999999;strokeColor=none;fontColor=#ffffff;whiteSpace=wrap;');
                notif2.geometry.relative = true;
                notif2.geometry.offset = new mxPoint(-33, -8);
                notif2.vertex = true;
                bg3.insert(notif2);
                var bg4 = new mxCell('Disabled Link', new mxGeometry(0, 0, 200, 30), inh + s + 'rect;fontColor=#dddddd;align=left;spacingLeft=10;whiteSpace=wrap;resizeWidth=1;');
                bg4.geometry.relative = true;
                bg4.geometry.offset = new mxPoint(0, 96);
                bg4.vertex = true;
                bg.insert(bg4);
                var bg5 = new mxCell('System Settings', new mxGeometry(0, 0, 200, 30), inh + s + 'bottomRect;fontColor=#3D8BCD;align=left;spacingLeft=10;whiteSpace=wrap;resizeWidth=1;');
                bg5.geometry.relative = true;
                bg5.geometry.offset = new mxPoint(0, 128);
                bg5.vertex = true;
                bg.insert(bg5);
                var notif3 = new mxCell('1', new mxGeometry(1, 0.5, 25, 16), s + 'rrect;rSize=8;fillColor=#999999;strokeColor=none;fontColor=#ffffff;whiteSpace=wrap;');
                notif3.geometry.relative = true;
                notif3.geometry.offset = new mxPoint(-33, -8);
                notif3.vertex = true;
                bg5.insert(notif3);

                return sb.createVertexTemplateFromCells([bg], 200, 158, 'Pills (Vertical)');
            }),

            this.addDataEntry(dt + 'navbar', 720, 100, 'Navbar',
                '3ZjdjqIwFMefhksJBXX0Vt2dm9lkMz5BBw7QTGlJqaPu028LFUFgcCKwk8WYtKenX79/21OwvG1yehY4jX/xAKjl/bC8reBcFqnktAVKLdchgeXtLNd11N9yf3aUorzUSbEAJu+p4BYVPjA9QGEpDJk8U2OIZaKGtUOWt8liHPCjyjgqE+AshsBkVEmq/ZNTpOdiv6kZZFIlbSHAV0PZiD35oz0WKh0SSreccpH34IVL/dOtSMHfoVIS5I+uDf5BZOQDXiEr2tG9msGDkHDqBJCbzOyfgScgxVm5HEkg48LjyUByYiBRfKnmGCPOCkNU1r3yVAmDtB2v18C7EZgFgzMuENfxMc7ghvXFxJmsQF7nj7EbldBc5Y8xkbBPsa8tR9XRvcjdXuSrFuLzAYDPG8BfCHsfiffNMi4Xa7sOHdCHhnyqA64wX47EfDEl80fX+Ei40Xw63ssG753gqQLKvinzTOEmLHo1GJAzng6u09ShPMmHFuKpP3he2EpBMIvoLbgapTbKAdEaEM6UKeMHPaVNCoKosULF7S5yy89XcFHhbG4N9qLBcdWkaJwEUCxVcK611EbW9P6bEzWosusZWtc6n3n1FngYZiAbypRzuEusVUOsPWDhx7ZtT3Hl6b7a3Oya0o4pibTsFEJ53UQveW7UPeQ5i5oczZXgtu0ob4AdtW6KdHhLiPy3Co3EeYGcHs5tt6QhMF86HjlkY+bHGubkwbiGFX0pMD98lK3qos5uA80ghxlCk90BekWcMLr3CftppH9YWXcSZe94I/9OlwrU8Xr9f94qVPb6baZwr366+Qs='),
            this.addDataEntry(dt + 'navbar form', 720, 40, 'Navbar Form',
                'xZVvb4IwEMY/Td+SUmTTt+LmXmzJEj9BlYM2K5SUKrhPv4PW/3NzmVGMSe+5O3p9fhBIlBTt1PBKvOkUFImeSJQYra1bFW0CShFGZUqiCWGM4p+w5zPZsM/Sihso7SUNzDWsuFqCU5xQ27XygrAFjjUJSTSuBU91gwHFIOW1gNQHmKm6+qLNu7MEczxBbXEZGAMLHGVsZvKzq4hxnUmlEq206XeIsofu193FGv0Be5m0vzDjxwRjoT171F7y55yCLsCaNZY0MrXCVTx6O6gAmQvfNvAar12cb1t3xuHCe/e9j9GJj2PDy/TqZjovD30qdQlHpm4kXdo9N0f95XWPIxxg3AhpYVbxRac0uFHHC2qseNn4FF4Kgf0KYfgDAwOKW7mCg9v/B8zgBMwMuFmIIAhu8aSff6KP2Gx1rmReoqYg61EjFVnmr300CenNaTH6Da7or7j8Fu9a4s6M+oGGsetYuzA+7NdZVoM9gb0d8yL+8Sn/5byQ9r7w7//CXYkgG9FrI8Rw9/1z5fufxy8='),
            this.addDataEntry(dt + 'navbar button', 720, 40, 'Navbar Button',
                'vZRbT8MgFIB/Da9LW7apr+10vpiY7BfgOC1EWhrAtfPXeyi4S7bqFi80Tc6dcz4IhBZ1vzSsFU+agyL0ntDCaO2CVPcFKEWyRHJCFyTLEvxJ9jDiTQdv0jIDjbskIQsJG6beIFiCwbqtigbhamxrkRKaW8G47lBJUOHMCuBRQU/r4+u+8rNMXnAC61CcGANrbCU3K/nuI2Yol1KpQitthh1oOfefr+KMfoUDDx8WejohHaxatvYlOqyLttg6GAf96PiDKc6+BF2DM1sM6SR3IkTcRESJAFmJmDaNNmaDXu1S9zBRiDzPs6UnbHPDGv7bgFmzFp5XXurGHbC7G1a0R/jpdISlAYsRj58E0kvxZt/ivf2CrgHFnNzAUfmfIJ+eIF/JqvEBzX/c6+vu798xn59hTq9lHnd41hI3zpL++Di3QZ0d5+uytOBOTmzX5blDRHX/3oXww+fwAw=='),
            this.addDataEntry(dt + 'navbar text', 720, 40, 'Navbar Text',
                'vVTbboMwDP2avFYhtLu8QrfuYdUm9QuyxpCoIUEhK3RfP0PS27pulVYNhLCPL7GPrZA0r7qZ47WcWwGapA8kzZ21PkhVl4PWhFElSDoljFH8CHs8Y00GK625A+MvCWAhYM31OwQkAI3f6AhIX2FZ04SkWSO5sC0qFBXBGwkiKmipe/+qK/teRm/YQeNRHDkHSywlcwv10XtMUC6U1rnV1g0npMVN//ZZvLMrOLCI4UFLK5WHRc2XfYoW8yIWSwfnoTvb/gDF3mdgK/Bugy6tEl4Gj9tIEZWgShnDxhHjTdDLXeieTBQin99zm55wmzluxLUJ5mYpe76ywhp/wN398EQ8kp+Mz3DpoEGPpy0DyaX0sl/pvfuBXQeae7WGo/R/oXx8QvlClQZJRBcTcjM6526Fvxfv7dWXPez68R4ba+DL0m+hMxPjGqtGTEMxpMNZKVM+D9o0of8+w2RyjSHGI16twpMZ7Y73Yxthi6IBfzL0XWHf7QGq+yszuB/eqJ8='),
            this.addDataEntry(dt + 'non nav link', 720, 40, 'Non-nav Link',
                'vZRfb4IwEMA/TR9noDi3vaKbezFb5ifo5KCNhZK2E9yn35VWxKibyYwQwv3v3e+SkmRatnPNar5QGUiSPJNkqpWyXirbKUhJaCQykswIpRF+hL6c8cadN6qZhspekkB9wobJL/AWbzB2K4OB2xLbmsUkSQ1nmWpQiVDJmOGQBQU9tYsv28LNMvrECYxFcaQ1rLCVVC/Ft4u4RzkXUk6VVLo7Ickn7nVVrFZrGHiy7kFPaBO0hfbsqJ0pzDkHVYLVWwxpRGa5j3gIOCIOouAhbRxszHi96FP34FAI7E5zTI44pppV2bVhsmrFHZs0V5UdcHrqnmAPoOMx6g0XFpY1WzlLgyXcJsBgxOuOQHwpXvon3sdf6GqQzIoNHJT/D/LxEfKlKCqEiCGVr02jBdNr/L1Zq26+CyaxH7RpDyM1uAZRFR+BDY1us5/DhMG24sk11hUOfFcC++hPu+uL73JUnhuwRwvuGz21c1T3V6EPH96UPw=='),
            this.addDataEntry(dt + 'navbar', 720, 40, 'Navbar',
                '7ZZrT4MwFIZ/Tb8upWxTv47p9kETk/2COg5rs0JJqYP56z3QshtOl4iXGJuQ9Lw9p5f3AVISRmk1MzwXDzoGRcJbEkZGa+t6aRWBUoRRGZNwShij+BB2d2Y0aEZpzg1k9pIC5go2XD2DU5xQ2K3ygrApbmsakHBSCB7rEgOKQcwLAbEPcCSv89NqVZ9l8IQnKCx2B8bA0tYZ1ug1RFppg3mZzjB9YhbypS4bYT+RSrXDhIWsaaj7HYKxUJ09ZSP5I85Ap2DNFlNKGVvhMq68E1SAXAlfNvQaL1y82pXuPcOOt+1tC8OOhRPDs7h3H9+x8dC6VtKZPXDzpmle96YHQ4xLIS0scr6slRIXqqlAgRnz1qfgUgjsQwjX7zAwoLiVGzia/jNghh0wc5zki7icvL20aWd5HcNJmvbtMMZ9wPArPGqJCzNaHXNuK3SSFGA78Hb7uojnqMPzXmbrX/qd/RmUwek/sheW43+WP8CS0R5YYri/n7j0w+vLKw=='),
            this.addDataEntry(dt + 'jumbotron', 800, 500, 'Jumbotron',
                'vZXNjtMwEMefhYOPRI5DS89J2eUAp+UFvM0kNvgjctxtytMzE6fslqRSkQKtWo3nw7F//7HDisoOj0F26quvwbDiEyuq4H1Mlh0qMIYJrmtW7JkQHH9MPNyI5mOUdzKAi/cUiFTwIs0Rkic5+ng2k0NFi8va56woeyVrf8IBx0EtewX1NMBIR/l2aGkv2TPuoI9oZiHAAZdShif9kzI2aDfamMobH8YnFA2nL80Sg/8Bl4jzDgvKaYUQIgw3dzm6pi0+grcQwxlTTrqOKmXseCLBFehWTWWbi1P2ydH+rn2FhsbEbZlhMWP4GRM8ExWtwAdTv1sbqnQHRYzKxrs4gd1RiTS6dTgw0BD0k9IRnjp5oIQTVt7LUyzznAq2E7XzBW0avqG93S3Q3q0A+8MM9jele0qgP0mUte0QMz06oAj86HRMWlxFvx/ts8d+c++TLIIfvO2w5RCB4A3SRY80RrsWLRiQO00RIyZo79CONHsDMh4DSkb1LqbqsVg7nMRKSs7+h/6IZlnwP3piff3zpQbYLjRAvsZx28w64AvIQIJYH+BfXV8E+s2V9TB+5lcZHsOy2t+6yu5RawV5eMY/bq4U4tl2plC+dEQvqgUw2LkvcLWCv1ANh68vsTF29Y77BQ=='),

            this.addEntry(dt + 'page header', function () {
                var button1 = new mxCell('Example page header', new mxGeometry(0, 0, 360, 50), s + 'anchor;fontSize=35;align=left;whiteSpace=wrap;');
                button1.vertex = true;
                var button2 = new mxCell('Subtext for header', new mxGeometry(360, 10, 300, 40), s + 'anchor;fontSize=24;align=left;fontColor=#999999;whiteSpace=wrap;');
                button2.vertex = true;
                var button3 = new mxCell('', new mxGeometry(0, 50, 750, 10), 'shape=line;strokeColor=#dddddd;');
                button3.vertex = true;

                return sb.createVertexTemplateFromCells([button1, button2, button3], 700, 80, 'Page header');
            }),
            this.addDataEntry(dt + 'thumbnail custom content', 330, 400, 'Thumbnail with custom content',
                '1VbdkpowFH4aLuvEoNZeVmz3qp3ObF8gQjCnDYSGgz99+p5AUBDcsVPt7OJIcn6TfOdLQhBG2eHJikJ9MYnUQfgpCCNrDDa97BBJrQPOIAnCdcA5o3/AP1+xTmsrK4SVOd4SwJuAndCVbDSNosSj9gqFGU1rPQ3CValEYvYkMBISUSqZeIEshfPPDlu3lsmGVlAidSfWypimskpB68hoY+usYVo/pLfP8NtFzl0WtOan7Hgl9UMWP01pUR6uLrVW+XU+SZNJtEdy2UOCqvEIwwYOpiRslQ+bMa8UZaPYnmLPyFHHgzcOZDgAMuTswNvUHTxbqFpcTI4eAj4bwYm53wCb3OTSB3ecP9QP6fcKUD4XInZp91SGWyHk4xD6gHkTcOxJXXj5CLz8HvDOBvB+V1W2yQU4Ly02tHXuTFyRx8oB26vQgmShYZuToGWKj8N62ge73cg9uNkom/8d7fkA7chSPs5+VCUaak0C1FAelogCNpWziZheqYhBQwlOAXnjIreyxDqcekjNr0pkE2rXROK4GZZsGpyNiE3vDBxWxqKglgqzg8T1BJ6T0KKq0mX5WmktsjZNUu8GL+SwUdRUGi3EIMu6JgriSrtsFXbHnjyMP9dPtTHqXLDLcQhioT96NZqiT8np7P9xcHEjB5d34OBiwMFVhejY8Zj7qXsPdeFdDM/kcL1cResbz+TTRXfvGh17AZ2SLF84FazUAmEne7FjZfLjfTOQ41VCvFtcFNqkael250WZT7O+qfLvX1Hl/27vvrlytpv3nvUk8fz92rh3P2//AA=='),

            this.createVertexTemplateEntry(s + 'rrect;align=center;rSize=5;strokeColor=none;fillColor=#999999;fontColor=#ffffff;fontStyle=1;whiteSpace=wrap;',
                60, 30, 'Label', 'Label (Normal)', null, null, this.getTagsForStencil(gn, '', dt + 'label normal').join(' ')),
            this.createVertexTemplateEntry(s + 'rrect;align=center;rSize=5;strokeColor=none;fillColor=#0D5B9D;fontColor=#ffffff;fontStyle=1;whiteSpace=wrap;',
                60, 30, 'Label', 'Label (Normal)', null, null, this.getTagsForStencil(gn, '', dt + 'label normal').join(' ')),
            this.createVertexTemplateEntry(s + 'rrect;align=center;rSize=5;strokeColor=none;fillColor=#58B957;fontColor=#ffffff;fontStyle=1;whiteSpace=wrap;',
                60, 30, 'Label', 'Label (Normal)', null, null, this.getTagsForStencil(gn, '', dt + 'label normal').join(' ')),
            this.createVertexTemplateEntry(s + 'rrect;align=center;rSize=5;strokeColor=none;fillColor=#55BFE0;fontColor=#ffffff;fontStyle=1;whiteSpace=wrap;',
                60, 30, 'Label', 'Label (Normal)', null, null, this.getTagsForStencil(gn, '', dt + 'label normal').join(' ')),
            this.createVertexTemplateEntry(s + 'rrect;align=center;rSize=5;strokeColor=none;fillColor=#EFAC43;fontColor=#ffffff;fontStyle=1;whiteSpace=wrap;',
                60, 30, 'Label', 'Label (Normal)', null, null, this.getTagsForStencil(gn, '', dt + 'label normal').join(' ')),
            this.createVertexTemplateEntry(s + 'rrect;align=center;rSize=5;strokeColor=none;fillColor=#DB524C;fontColor=#ffffff;fontStyle=1;whiteSpace=wrap;',
                60, 30, 'Label', 'Label (Normal)', null, null, this.getTagsForStencil(gn, '', dt + 'label normal').join(' ')),
            this.createVertexTemplateEntry(s + 'rrect;align=center;rSize=5;strokeColor=none;fillColor=#999999;fontColor=#ffffff;fontStyle=1;whiteSpace=wrap;fontSize=10;',
                40, 20, 'Label', 'Label (Small)', null, null, this.getTagsForStencil(gn, '', dt + 'label normal').join(' ')),
            this.createVertexTemplateEntry(s + 'rrect;align=center;rSize=5;strokeColor=none;fillColor=#0D5B9D;fontColor=#ffffff;fontStyle=1;whiteSpace=wrap;fontSize=10;',
                40, 20, 'Label', 'Label (Small)', null, null, this.getTagsForStencil(gn, '', dt + 'label normal').join(' ')),
            this.createVertexTemplateEntry(s + 'rrect;align=center;rSize=5;strokeColor=none;fillColor=#58B957;fontColor=#ffffff;fontStyle=1;whiteSpace=wrap;fontSize=10;',
                40, 20, 'Label', 'Label (Small)', null, null, this.getTagsForStencil(gn, '', dt + 'label normal').join(' ')),
            this.createVertexTemplateEntry(s + 'rrect;align=center;rSize=5;strokeColor=none;fillColor=#55BFE0;fontColor=#ffffff;fontStyle=1;whiteSpace=wrap;fontSize=10;',
                40, 20, 'Label', 'Label (Small)', null, null, this.getTagsForStencil(gn, '', dt + 'label normal').join(' ')),
            this.createVertexTemplateEntry(s + 'rrect;align=center;rSize=5;strokeColor=none;fillColor=#EFAC43;fontColor=#ffffff;fontStyle=1;whiteSpace=wrap;fontSize=10;',
                40, 20, 'Label', 'Label (Small)', null, null, this.getTagsForStencil(gn, '', dt + 'label normal').join(' ')),
            this.createVertexTemplateEntry(s + 'rrect;align=center;rSize=5;strokeColor=none;fillColor=#DB524C;fontColor=#ffffff;fontStyle=1;whiteSpace=wrap;fontSize=10;',
                40, 20, 'Label', 'Label (Small)', null, null, this.getTagsForStencil(gn, '', dt + 'label normal').join(' ')),

            this.createVertexTemplateEntry(s + 'rect;strokeColor=none;fillColor=none;fontSize=30;align=left;spacingLeft=10;',
                250, 40, 'Header Text', 'Header Text (30)', null, null, this.getTagsForStencil(gn, '', dt + 'label normal').join(' ')),
            this.createVertexTemplateEntry(s + 'rect;strokeColor=none;fillColor=none;fontSize=25;align=left;spacingLeft=10;',
                250, 35, 'Header Text', 'Header Text (25)', null, null, this.getTagsForStencil(gn, '', dt + 'label normal').join(' ')),
            this.createVertexTemplateEntry(s + 'rect;strokeColor=none;fillColor=none;fontSize=20;align=left;spacingLeft=10;',
                250, 30, 'Header Text', 'Header Text (20)', null, null, this.getTagsForStencil(gn, '', dt + 'label normal').join(' ')),
            this.createVertexTemplateEntry(s + 'rect;strokeColor=none;fillColor=none;fontSize=16;align=left;spacingLeft=10;',
                250, 26, 'Header Text', 'Header Text (16)', null, null, this.getTagsForStencil(gn, '', dt + 'label normal').join(' ')),
            this.createVertexTemplateEntry(s + 'rect;strokeColor=none;fillColor=none;fontSize=12;align=left;spacingLeft=10;',
                250, 22, 'Header Text', 'Header Text (12)', null, null, this.getTagsForStencil(gn, '', dt + 'label normal').join(' ')),
            this.createVertexTemplateEntry(s + 'rect;strokeColor=none;fillColor=none;fontSize=10;align=left;spacingLeft=10;',
                250, 20, 'Header Text', 'Header Text (10)', null, null, this.getTagsForStencil(gn, '', dt + 'label normal').join(' ')),

            this.createVertexTemplateEntry(s + 'image;align=center;rSize=5;strokeColor=#f6f6f6;fillColor=#f6f6f6;fontColor=#999999;strokeWidth=2;whiteSpace=wrap;',
                150, 150, 'Image', 'Image', null, null, this.getTagsForStencil(gn, 'image', dt + '').join(' ')),

            this.addEntry(dt + 'image', function () {
                var bg1 = new mxCell('Image', new mxGeometry(0, 0, 150, 70), s + 'image;align=center;rSize=5;strokeColor=#f6f6f6;fillColor=#f6f6f6;fontColor=#999999;strokeWidth=2;whiteSpace=wrap;');
                bg1.vertex = true;
                var bg2 = new mxCell('Image', new mxGeometry(0, 80, 70, 70), s + 'image;align=center;rSize=5;strokeColor=#f6f6f6;fillColor=#f6f6f6;fontColor=#999999;strokeWidth=2;whiteSpace=wrap;');
                bg2.vertex = true;
                var bg3 = new mxCell('Image', new mxGeometry(80, 80, 70, 70), s + 'image;align=center;rSize=5;strokeColor=#f6f6f6;fillColor=#f6f6f6;fontColor=#999999;strokeWidth=2;whiteSpace=wrap;');
                bg3.vertex = true;

                return sb.createVertexTemplateFromCells([bg1, bg2, bg3], 150, 150, 'Images');
            }),

            this.addEntry(dt + 'dismissible alert', function () {
                var bg1 = new mxCell(
                    '<table cellpadding="0" cellspacing="0" style="width:100%;height:100%;margin-left:14px;"><tbody><tr><td align="left" valign="middle" width="50%"><b>Well done!</b> You successfully read <u>this important alert message.</u></td></tr></tbody></table>',
                    new mxGeometry(0, 0, 800, 40), s + 'rrect;rSize=5;strokeColor=none;fillColor=#E0F0D6;fontColor=#59B958;overflow=fill;whiteSpace=wrap;');
                bg1.vertex = true;
                var bg2 = new mxCell('', new mxGeometry(1, 0.5, 10, 10), s + 'x;strokeColor=#59B958;strokeWidth=2;');
                bg2.geometry.relative = true;
                bg2.geometry.offset = new mxPoint(-25, -5);
                bg2.vertex = true;
                bg1.insert(bg2);

                return sb.createVertexTemplateFromCells([bg1], bg1.geometry.width, bg1.geometry.height, 'Dismissible Alert');
            }),

            this.addEntry(dt + 'dismissible alert', function () {
                var bg1 = new mxCell(
                    '<table cellpadding="0" cellspacing="0" style="width:100%;height:100%;margin-left:14px;"><tbody><tr><td align="left" valign="middle" width="50%"><b>Heads up!</b> This <u>alert needs you attention</u>, but it\'s not super important.</td></tr></tbody></table>',
                    new mxGeometry(0, 0, 800, 40), s + 'rrect;rSize=5;strokeColor=none;fillColor=#D9EDF8;fontColor=#55C0E0;overflow=fill;whiteSpace=wrap;');
                bg1.vertex = true;
                var bg2 = new mxCell('', new mxGeometry(1, 0.5, 10, 10), s + 'x;strokeColor=#55C0E0;strokeWidth=2;');
                bg2.geometry.relative = true;
                bg2.geometry.offset = new mxPoint(-25, -5);
                bg2.vertex = true;
                bg1.insert(bg2);

                return sb.createVertexTemplateFromCells([bg1], bg1.geometry.width, bg1.geometry.height, 'Dismissible Alert');
            }),

            this.addEntry(dt + 'dismissible alert', function () {
                var bg1 = new mxCell(
                    '<table cellpadding="0" cellspacing="0" style="width:100%;height:100%;margin-left:14px;"><tbody><tr><td align="left" valign="middle" width="50%"><b>Warning!</b> Better check yourself, <u>you\'re not looking too good.</u></td></tr></tbody></table>',
                    new mxGeometry(0, 0, 800, 40), s + 'rrect;rSize=5;strokeColor=none;fillColor=#FDF8E4;fontColor=#F2AE43;overflow=fill;whiteSpace=wrap;');
                bg1.vertex = true;
                var bg2 = new mxCell('', new mxGeometry(1, 0.5, 10, 10), s + 'x;strokeColor=#F2AE43;strokeWidth=2;');
                bg2.geometry.relative = true;
                bg2.geometry.offset = new mxPoint(-25, -5);
                bg2.vertex = true;
                bg1.insert(bg2);

                return sb.createVertexTemplateFromCells([bg1], bg1.geometry.width, bg1.geometry.height, 'Dismissible Alert');
            }),

            this.addEntry(dt + 'dismissible alert', function () {
                var bg1 = new mxCell(
                    '<table cellpadding="0" cellspacing="0" style="width:100%;height:100%;margin-left:14px;"><tbody><tr><td align="left" valign="middle" width="50%"><b>Oh snap!</b> <u>Change a few things up</u> and try submitting again.</td></tr></tbody></table>',
                    new mxGeometry(0, 0, 800, 40), s + 'rrect;rSize=5;strokeColor=none;fillColor=#F2DEDF;fontColor=#DB524C;overflow=fill;whiteSpace=wrap;');
                bg1.vertex = true;
                var bg2 = new mxCell('', new mxGeometry(1, 0.5, 10, 10), s + 'x;strokeColor=#DB524C;strokeWidth=2;');
                bg2.geometry.relative = true;
                bg2.geometry.offset = new mxPoint(-25, -5);
                bg2.vertex = true;
                bg1.insert(bg2);

                return sb.createVertexTemplateFromCells([bg1], bg1.geometry.width, bg1.geometry.height, 'Dismissible Alert');
            }),

            this.addEntry(dt + 'progress bar', function () {
                var bg1 = new mxCell('', new mxGeometry(0, 0, 800, 20), s + 'rrect;rSize=5;strokeColor=none;fillColor=#f6f6f6;whiteSpace=wrap;');
                bg1.vertex = true;
                var bg2 = new mxCell('60%', new mxGeometry(0, 0, 500, 20), s + 'leftButton;rSize=5;strokeColor=none;fillColor=#59B958;fontColor=#FFFFFF;whiteSpace=wrap;');
                bg2.vertex = true;
                bg1.insert(bg2);

                return sb.createVertexTemplateFromCells([bg1], bg1.geometry.width, bg1.geometry.height, 'Progress Bar');
            }),

            this.addEntry(dt + 'progress bar', function () {
                var bg1 = new mxCell('', new mxGeometry(0, 0, 800, 20), s + 'rrect;rSize=5;strokeColor=none;fillColor=#f6f6f6;whiteSpace=wrap;');
                bg1.vertex = true;
                var bg2 = new mxCell('60%', new mxGeometry(0, 0, 500, 20), s + 'leftButton;rSize=5;strokeColor=none;fillColor=#55C0E0;fontColor=#FFFFFF;whiteSpace=wrap;');
                bg2.vertex = true;
                bg1.insert(bg2);

                return sb.createVertexTemplateFromCells([bg1], bg1.geometry.width, bg1.geometry.height, 'Progress Bar');
            }),

            this.addEntry(dt + 'progress bar', function () {
                var bg1 = new mxCell('', new mxGeometry(0, 0, 800, 20), s + 'rrect;rSize=5;strokeColor=none;fillColor=#f6f6f6;whiteSpace=wrap;');
                bg1.vertex = true;
                var bg2 = new mxCell('60%', new mxGeometry(0, 0, 500, 20), s + 'leftButton;rSize=5;strokeColor=none;fillColor=#F2AE43;fontColor=#FFFFFF;whiteSpace=wrap;');
                bg2.vertex = true;
                bg1.insert(bg2);

                return sb.createVertexTemplateFromCells([bg1], bg1.geometry.width, bg1.geometry.height, 'Progress Bar');
            }),

            this.addEntry(dt + 'progress bar', function () {
                var bg1 = new mxCell('', new mxGeometry(0, 0, 800, 20), s + 'rrect;rSize=5;strokeColor=none;fillColor=#f6f6f6;whiteSpace=wrap;');
                bg1.vertex = true;
                var bg2 = new mxCell('60%', new mxGeometry(0, 0, 500, 20), s + 'leftButton;rSize=5;strokeColor=none;fillColor=#DB524C;fontColor=#FFFFFF;whiteSpace=wrap;');
                bg2.vertex = true;
                bg1.insert(bg2);

                return sb.createVertexTemplateFromCells([bg1], bg1.geometry.width, bg1.geometry.height, 'Progress Bar');
            }),

            this.addEntry(dt + 'progress bar low percentage', function () {
                var bg1 = new mxCell('0%', new mxGeometry(0, 0, 800, 20), s + 'rrect;rSize=5;strokeColor=none;fillColor=#f6f6f6;fontColor=#000000;align=left;spacingLeft=5;whiteSpace=wrap;');
                bg1.vertex = true;

                return sb.createVertexTemplateFromCells([bg1], bg1.geometry.width, bg1.geometry.height, 'Progress Bar (Low percentage)');
            }),

            this.addEntry(dt + 'progress bar low percentage', function () {
                var bg1 = new mxCell('', new mxGeometry(0, 0, 800, 20), s + 'rrect;rSize=5;strokeColor=none;fillColor=#f6f6f6;whiteSpace=wrap;');
                bg1.vertex = true;
                var bg2 = new mxCell('2%', new mxGeometry(0, 0, 30, 20), s + 'leftButton;rSize=5;strokeColor=none;fillColor=#55C0E0;fontColor=#FFFFFF;whiteSpace=wrap;');
                bg2.vertex = true;
                bg1.insert(bg2);

                return sb.createVertexTemplateFromCells([bg1], bg1.geometry.width, bg1.geometry.height, 'Progress Bar (Low percentage)');
            }),

            this.addEntry(dt + 'progress bar striped', function () {
                var bg1 = new mxCell('', new mxGeometry(0, 0, 800, 20), s + 'rrect;rSize=5;strokeColor=none;fillColor=#f6f6f6;whiteSpace=wrap;');
                bg1.vertex = true;
                var bg2 = new mxCell('60%', new mxGeometry(0, 0, 500, 20), s + 'leftButtonStriped;fillColor=#59B958;fontColor=#FFFFFF;whiteSpace=wrap;');
                bg2.vertex = true;
                bg1.insert(bg2);

                return sb.createVertexTemplateFromCells([bg1], bg1.geometry.width, bg1.geometry.height, 'Progress Bar (Striped)');
            }),

            this.addEntry(dt + 'progress bar striped', function () {
                var bg1 = new mxCell('', new mxGeometry(0, 0, 800, 20), s + 'rrect;rSize=5;strokeColor=none;fillColor=#f6f6f6;whiteSpace=wrap;');
                bg1.vertex = true;
                var bg2 = new mxCell('60%', new mxGeometry(0, 0, 500, 20), s + 'leftButtonStriped;fillColor=#55BFE0;fontColor=#FFFFFF;whiteSpace=wrap;');
                bg2.vertex = true;
                bg1.insert(bg2);

                return sb.createVertexTemplateFromCells([bg1], bg1.geometry.width, bg1.geometry.height, 'Progress Bar (Striped)');
            }),

            this.addEntry(dt + 'progress bar striped', function () {
                var bg1 = new mxCell('', new mxGeometry(0, 0, 800, 20), s + 'rrect;rSize=5;strokeColor=none;fillColor=#f6f6f6;whiteSpace=wrap;');
                bg1.vertex = true;
                var bg2 = new mxCell('60%', new mxGeometry(0, 0, 500, 20), s + 'leftButtonStriped;fillColor=#EFAC43;fontColor=#FFFFFF;whiteSpace=wrap;');
                bg2.vertex = true;
                bg1.insert(bg2);

                return sb.createVertexTemplateFromCells([bg1], bg1.geometry.width, bg1.geometry.height, 'Progress Bar (Striped)');
            }),

            this.addEntry(dt + 'progress bar striped', function () {
                var bg1 = new mxCell('', new mxGeometry(0, 0, 800, 20), s + 'rrect;rSize=5;strokeColor=none;fillColor=#f6f6f6;whiteSpace=wrap;');
                bg1.vertex = true;
                var bg2 = new mxCell('60%', new mxGeometry(0, 0, 500, 20), s + 'leftButtonStriped;fillColor=#DB524C;fontColor=#FFFFFF;whiteSpace=wrap;');
                bg2.vertex = true;
                bg1.insert(bg2);

                return sb.createVertexTemplateFromCells([bg1], bg1.geometry.width, bg1.geometry.height, 'Progress Bar (Striped)');
            }),
            this.addDataEntry(dt + 'progress bar', 800, 20, 'Progress Bar',
                'vZXNboMwDMefJtcqTUjVHgf9OO3UJ8iKadACQSEddE8/Q7K121q12qBCSPbfdmT/MArhSdFurKzUs0lBE74iPLHGOG8VbQJaE0bzlPAlYYziS9j6SnTaR2klLZTungLmC96kPoBXvFC7ow6CcgW2tZwSHtdKpqZBh6KTylpBGhyMVF1+0e67WSYvOEHt0JxYCztsJbbb/L3LEF22s+YVEqONRaU0JQbiLNf6UyKMZ7PuQb1RuYNtJXdddYNHoha6BuugvTp5L4WxN2AKcPaIKU2eOuUz5tTToQryvQplgRiVtff3X6UnjmgElJex8tGxashcfHDOlH9gu4wFi5L/sGU32U7FSGyj22zDyt2DYs2eVhFH/ex7DE2l/UHkjBIbawPFoJTEIl6I+UMo8QuUxlql2bCQREJX9CGQIvob0lA/HLqn+6ePfbuePgA='),
            this.addDataEntry(dt + 'default media', 700, 290, 'Default Media',
                '7VjLcpswFP0ath5eIc2yxk1WySZfIEsC7lRIVEjY7tf3SsiNHdtNZmq8aMGDka50Hzr3cBZEWdlunzTpmmfFuIiyb1FWaqXMOGq3JRciSmNgUbaK0jTGO0ofL6wmfjXuiObSfMYhHR0GIiwfLUW+LfLR2pudCNbGtFjbKomyZd8QpjY4iXHCSN9wFia40rn97bZ2B1qs8Ri9weFCc4rlLImAWuIGitVx7TyMVt95qYTC2Uoqie7LCoTYm6I0qwr3c3YlzYH9wV9o3zRg+GtHqMu9wXRoC8fi2vDtRWi8KeDyxFXLjd7hlg0w0+zBGL0aDnVjjm2kH+f1b883nHEQoD4Pe3YC+zNnQHwmwkDW124AkbRxwHkQX+Gn25XmBy0RvDITYBkc7kcWHkKbxvEptln899jmJ9iWGuMhmmBcaAyIDwnrBh8C1lyrKC1dAIl/CNwAzHVCWiHIAgcvbuARcGnQ3fpolAuuof+BWTAqEtoZlRBAwVjmg1HVtoopFyTU0FntvRWDkHXgvYG1FbbdlzBY0VlDfEBixl2Gt513HAAboV05xuoOehf70WIxPp1k0GJLfCxpJXURqD9tD+8iVxppBuGIK3zz3D5BKEjPQ4xV+5NVXEC/L60ilmKxLutE/HzHR8c6oER8DWajugssPSB2kk/P5N0xYQ81IztD7OIKxL6btfqkK6ENSXymDxNpd/GfavcfoJ5My+9nLZ+1/GbMvqWYf5nF/JNtSW+o7Q8nXXnBVxpxdlrxL4t8kn8MejaVyifxLPOzzN+O22d0/q64js7j9O3jjV87+rbzCw=='),
            this.addDataEntry(dt + 'media list', 700, 460, 'Media List',
                '7Vldc6MgFP01vmYErG0eN2a3T+1LfwEREpmiuIj56K/vBU1rotlmZkMfrMkkwoV7wXMPZ5xrQJJ8/6hpmT0pxmVAfgck0UqZppXvEy5lgEPBArIMMA7hF+A/F0aRGw1LqnlhrnHAjcOWypo3ljjax1FjrcxBttbM5LC3JQrIosooUzvohNBhtMo4azswUtr5+X5jb2i2gtuoDDRnmqewnQWVYlPAhBR2x7X1MFq98kRJBb1loQpwX6yFlEdTgMk6tl9rV4Xp2OfuA/ZdJgx/KWlq197BcmBrb4trw/cXoXGmFpdHrnJu9AGm7AQz2RGMxivjYpOZUxutmv7mw/MTZ2i0UA/DTnqwP3EmqFuJMlFsbp0AWqSZBc6B+CLe7CwcdVIi+dp4wLJ1uG9Y2IUWh2EfWxL+P7ZRD9tEQzxAUxgbGgLCpRCrDC5SrLhWAU5sgAL+ALitYDYTRS0lnUHj2TYcAnYZcK9dtJRLrkX1F1aBqEBoa1RSilSYmrlgqcpzxZQN0u6hrLXzVky0q255ZcSqlnV+3MK2lmVtqAtITTPL8Lx0jlsBidB2O6bWpahm3phyxgybf5FS+as1G1Ve4EuHYijyz6nDKXW6p5cMUCy+AcXuJtW8Mivzgax40tS4l5RnOFoAMw7HLa4o+hJz4kts7yex/RFie84xhPsku4s9ye3DJLdX5+Xh+wR3fllw81ELLkZfg+5NcY9rT5I7csk9Z9lHv8OyaO5JchGaNPfKR1z8jZKL+vWaH/qQO4S6P83t12smzR2j5p6zjAxorrfHXNSvXE2a2zrEJD5NzEBF0Zvo9ss9I9Xaf4DrrVyL+nWbSVtHpa0tq6Jw4MjeqEIL3c93Zm7s5JXaOw=='),

            this.addEntry(dt + 'linked item custom content', function () {
                var bg = new mxCell('', new mxGeometry(0, 0, 400, 240), s + 'rrect;rSize=5;fillColor=#ffffff;strokeColor=#dddddd;whiteSpace=wrap;');
                bg.vertex = true;
                var button2 = new mxCell('Donec id elit non mi porta gravida at eget metus.\nMaecenas sed diam eget risus varius blandit.', new mxGeometry(0, 0, 400, 80),
                    inh + s + 'rect;perimeter=none;spacingLeft=10;align=left;fontSize=14;whiteSpace=wrap;verticalAlign=bottom;spacingBottom=10;resizeWidth=1;');
                button2.geometry.relative = true;
                button2.geometry.offset = new mxPoint(0, 80);
                button2.vertex = true;
                bg.insert(button2);
                var heading2 = new mxCell('List group item heading', new mxGeometry(0, 0, 400, 40), s + 'anchor;spacingLeft=10;align=left;fontSize=18;whiteSpace=wrap;resizeWidth=1;');
                heading2.geometry.relative = true;
                heading2.vertex = true;
                button2.insert(heading2);
                var button3 = new mxCell('Donec id elit non mi porta gravida at eget metus.\nMaecenas sed diam eget risus varius blandit.', new mxGeometry(0, 1, 400, 80),
                    inh + s + 'bottomButton;rSize=5;spacingLeft=10;align=left;fontSize=14;perimeter=none;whiteSpace=wrap;verticalAlign=bottom;spacingBottom=13;resizeWidth=1;');
                button3.geometry.relative = true;
                button3.geometry.offset = new mxPoint(0, -80);
                button3.vertex = true;
                bg.insert(button3);
                var heading3 = new mxCell('List group item heading', new mxGeometry(0, 0, 400, 40), s + 'anchor;spacingLeft=10;align=left;fontSize=18;whiteSpace=wrap;resizeWidth=1;');
                heading3.geometry.relative = true;
                heading3.vertex = true;
                button3.insert(heading3);
                var button1 = new mxCell('Donec id elit non mi porta gravida at eget metus.\nMaecenas sed diam eget risus varius blandit.', new mxGeometry(0, 0, 400, 80),
                    s + 'topButton;rSize=5;fillColor=#3D8BCD;strokeColor=#3D8BCD;fontColor=#ffffff;spacingLeft=10;align=left;fontSize=14;perimeter=none;whiteSpace=wrap;verticalAlign=bottom;spacingBottom=13;resizeWidth=1;');
                button1.geometry.relative = true;
                button1.vertex = true;
                bg.insert(button1);
                var heading1 = new mxCell('List group item heading', new mxGeometry(0, 0, 400, 40), s + 'anchor;fontColor=#ffffff;spacingLeft=10;align=left;fontSize=18;whiteSpace=wrap;resizeWidth=1;');
                heading1.geometry.relative = true;
                heading1.vertex = true;
                button1.insert(heading1);

                return sb.createVertexTemplateFromCells([bg], bg.geometry.width, bg.geometry.height, 'Linked Items (Custom Content)');
            }),

            this.addEntry(dt + 'panel', function () {
                var bg1 = new mxCell('Panel content', new mxGeometry(0, 0, 150, 200), s + 'rrect;align=center;rSize=5;strokeColor=#E0F0D6;fillColor=#ffffff;fontColor=#f0f0f0;spacingTop=30;whiteSpace=wrap;');
                bg1.vertex = true;
                var bg2 = new mxCell('Panel title', new mxGeometry(0, 0, 150, 30), s + 'topButton;rSize=5;strokeColor=none;fillColor=#E0F0D6;fontColor=#59B958;fontSize=14;fontStyle=1;align=left;spacingLeft=10;whiteSpace=wrap;resizeWidth=1;');
                bg2.geometry.relative = true;
                bg2.vertex = true;
                bg1.insert(bg2);

                return sb.createVertexTemplateFromCells([bg1], bg1.geometry.width, bg1.geometry.height, 'Panel');
            }),

            this.addEntry(dt + 'panel', function () {
                var bg1 = new mxCell('Panel content', new mxGeometry(0, 0, 150, 200), s + 'rrect;align=center;rSize=5;strokeColor=#D9EDF8;fillColor=#ffffff;fontColor=#f0f0f0;spacingTop=30;whiteSpace=wrap;');
                bg1.vertex = true;
                var bg2 = new mxCell('Panel title', new mxGeometry(0, 0, 150, 30), s + 'topButton;rSize=5;strokeColor=none;fillColor=#D9EDF8;fontColor=#55C0E0;fontSize=14;fontStyle=1;align=left;spacingLeft=10;whiteSpace=wrap;resizeWidth=1;');
                bg2.geometry.relative = true;
                bg2.vertex = true;
                bg1.insert(bg2);

                return sb.createVertexTemplateFromCells([bg1], bg1.geometry.width, bg1.geometry.height, 'Panel');
            }),

            this.addEntry(dt + 'panel', function () {
                var bg1 = new mxCell('Panel content', new mxGeometry(0, 0, 150, 200), s + 'rrect;align=center;rSize=5;strokeColor=#FDF8E4;fillColor=#ffffff;fontColor=#f0f0f0;spacingTop=30;whiteSpace=wrap;');
                bg1.vertex = true;
                var bg2 = new mxCell('Panel title', new mxGeometry(0, 0, 150, 30), s + 'topButton;rSize=5;strokeColor=none;fillColor=#FDF8E4;fontColor=#F2AE43;fontSize=14;fontStyle=1;align=left;spacingLeft=10;whiteSpace=wrap;resizeWidth=1;');
                bg2.geometry.relative = true;
                bg2.vertex = true;
                bg1.insert(bg2);

                return sb.createVertexTemplateFromCells([bg1], bg1.geometry.width, bg1.geometry.height, 'Panel');
            }),

            this.addEntry(dt + 'panel', function () {
                var bg1 = new mxCell('Panel content', new mxGeometry(0, 0, 150, 200), s + 'rrect;align=center;rSize=5;strokeColor=#F2DEDF;fillColor=#ffffff;fontColor=#f0f0f0;spacingTop=30;whiteSpace=wrap;');
                bg1.vertex = true;
                var bg2 = new mxCell('Panel title', new mxGeometry(0, 0, 150, 30), s + 'topButton;rSize=5;strokeColor=none;fillColor=#F2DEDF;fontColor=#DB524C;fontSize=14;fontStyle=1;align=left;spacingLeft=10;whiteSpace=wrap;resizeWidth=1;');
                bg2.geometry.relative = true;
                bg2.vertex = true;
                bg1.insert(bg2);

                return sb.createVertexTemplateFromCells([bg1], bg1.geometry.width, bg1.geometry.height, 'Panel');
            }),

            this.addEntry(dt + 'panel', function () {
                var bg1 = new mxCell('Panel content', new mxGeometry(0, 0, 150, 200), s + 'rrect;align=center;rSize=5;strokeColor=#3D8BCD;fillColor=#ffffff;fontColor=#f0f0f0;spacingTop=30;whiteSpace=wrap;');
                bg1.vertex = true;
                var bg2 = new mxCell('Panel title', new mxGeometry(0, 0, 150, 30), s + 'topButton;rSize=5;strokeColor=none;fillColor=#3D8BCD;fontColor=#ffffff;fontSize=14;fontStyle=1;align=left;spacingLeft=10;whiteSpace=wrap;resizeWidth=1;');
                bg2.geometry.relative = true;
                bg2.vertex = true;
                bg1.insert(bg2);

                return sb.createVertexTemplateFromCells([bg1], bg1.geometry.width, bg1.geometry.height, 'Panel');
            }),

            this.addEntry(dt + 'panel footer', function () {
                var bg1 = new mxCell('Panel content', new mxGeometry(0, 0, 150, 200), s + 'rrect;align=center;rSize=5;strokeColor=#E0F0D6;fillColor=#ffffff;fontColor=#f0f0f0;spacingBottom=30;whiteSpace=wrap;');
                bg1.vertex = true;
                var bg2 = new mxCell('Panel title', new mxGeometry(0, 1, 150, 30), s + 'bottomButton;rSize=5;strokeColor=none;fillColor=#E0F0D6;fontColor=#59B958;fontSize=14;fontStyle=1;align=left;spacingLeft=10;whiteSpace=wrap;resizeWidth=1;');
                bg2.geometry.relative = true;
                bg2.geometry.offset = new mxPoint(0, -30);
                bg2.vertex = true;
                bg1.insert(bg2);

                return sb.createVertexTemplateFromCells([bg1], bg1.geometry.width, bg1.geometry.height, 'Panel (Footer)');
            }),

            this.addEntry(dt + 'table', function () {
                var bg1 = new mxCell('', new mxGeometry(0, 0, 800, 280), s + 'rrect;rSize=5;strokeColor=#dddddd;fillColor=#ffffff;whiteSpace=wrap;');
                bg1.vertex = true;
                var bg2 = new mxCell('Panel title', new mxGeometry(0, 0, 800, 40), s + 'topButton;rSize=5;strokeColor=inherit;fillColor=#000000;fillOpacity=3;fontColor=#999999;fontSize=14;fontStyle=1;align=left;spacingLeft=10;whiteSpace=wrap;resizeWidth=1;');
                bg2.geometry.relative = true;
                bg2.vertex = true;
                bg1.insert(bg2);
                var bg2a = new mxCell(
                    'Some default panel content here. Nulla vitae elit libero, a pharetra augue. Aenean lacinia bibendum nulla sed consectetur. ' +
                    'Aenean eu leo quam. Pellentesque ornare sem lacinia quam venenatis vestibulum. Nullam id dolor id nibh ultricies vehicula. ',
                    new mxGeometry(0, 0, 800, 80), inh + s + 'rect;align=left;spacingLeft=10;whiteSpace=wrap;resizeWidth=1;');
                bg2a.geometry.relative = true;
                bg2a.geometry.offset = new mxPoint(0, 40);
                bg2a.vertex = true;
                bg1.insert(bg2a);
                var bg3 = new mxCell('', new mxGeometry(0, 0, 800, 40), s + 'rect;strokeColor=inherit;fillColor=#000000;fillOpacity=3;whiteSpace=wrap;resizeWidth=1;');
                bg3.geometry.relative = true;
                bg3.geometry.offset = new mxPoint(0, 120);
                bg3.vertex = true;
                bg1.insert(bg3);
                var bg4 = new mxCell('#', new mxGeometry(0, 0, 50, 40), s + 'rect;strokeColor=none;fillColor=none;fontSize=14;fontStyle=1;whiteSpace=wrap;resizeHeight=1;');
                bg4.geometry.relative = true;
                bg4.vertex = true;
                bg3.insert(bg4);
                var bg5 = new mxCell('First Name', new mxGeometry(0, 0, 150, 40), s + 'rect;strokeColor=none;fillColor=none;fontSize=14;fontStyle=1;align=left;whiteSpace=wrap;resizeHeight=1;');
                bg5.geometry.relative = true;
                bg5.geometry.offset = new mxPoint(80, 0);
                bg5.vertex = true;
                bg3.insert(bg5);
                var bg6 = new mxCell('Last Name', new mxGeometry(0, 0, 150, 40), s + 'rect;strokeColor=none;fillColor=none;fontSize=14;fontStyle=1;align=left;whiteSpace=wrap;resizeHeight=1;');
                bg6.geometry.relative = true;
                bg6.geometry.offset = new mxPoint(230, 0);
                bg6.vertex = true;
                bg3.insert(bg6);
                var bg7 = new mxCell('Username', new mxGeometry(0, 0, 150, 40), s + 'rect;strokeColor=none;fillColor=none;fontSize=14;fontStyle=1;align=left;whiteSpace=wrap;resizeHeight=1;');
                bg7.geometry.relative = true;
                bg7.geometry.offset = new mxPoint(380, 0);
                bg7.vertex = true;
                bg3.insert(bg7);
                var bg8 = new mxCell('Active', new mxGeometry(0, 0, 100, 40), s + 'rect;strokeColor=none;fillColor=none;fontSize=14;fontStyle=1;align=left;whiteSpace=wrap;resizeHeight=1;');
                bg8.geometry.relative = true;
                bg8.geometry.offset = new mxPoint(560, 0);
                bg8.vertex = true;
                bg3.insert(bg8);
                var bg9 = new mxCell('Boss', new mxGeometry(0, 0, 100, 40), s + 'rect;strokeColor=none;fillColor=none;fontSize=14;fontStyle=1;align=left;whiteSpace=wrap;resizeHeight=1;');
                bg9.geometry.relative = true;
                bg9.geometry.offset = new mxPoint(700, 0);
                bg9.vertex = true;
                bg3.insert(bg9);
                var bg10 = new mxCell('', new mxGeometry(0, 0, 800, 40), inh + s + 'rect;whiteSpace=wrap;resizeWidth=1;');
                bg10.geometry.relative = true;
                bg10.geometry.offset = new mxPoint(0, 160);
                bg10.vertex = true;
                bg1.insert(bg10);
                var bg11 = new mxCell('1', new mxGeometry(0, 0, 50, 40), s + 'rect;strokeColor=none;fillColor=none;fontSize=14;whiteSpace=wrap;resizeHeight=1;');
                bg11.geometry.relative = true;
                bg11.vertex = true;
                bg10.insert(bg11);
                var bg12 = new mxCell('John', new mxGeometry(0, 0, 150, 40), s + 'rect;strokeColor=none;fillColor=none;fontSize=14;align=left;whiteSpace=wrap;resizeHeight=1;');
                bg12.geometry.relative = true;
                bg12.geometry.offset = new mxPoint(80, 0);
                bg12.vertex = true;
                bg10.insert(bg12);
                var bg13 = new mxCell('Boo', new mxGeometry(0, 0, 150, 40), s + 'rect;strokeColor=none;fillColor=none;fontSize=14;align=left;whiteSpace=wrap;resizeHeight=1;');
                bg13.geometry.relative = true;
                bg13.geometry.offset = new mxPoint(230, 0);
                bg13.vertex = true;
                bg10.insert(bg13);
                var bg14 = new mxCell('johnny81', new mxGeometry(0, 0, 150, 40), s + 'rect;strokeColor=none;fillColor=none;fontSize=14;align=left;whiteSpace=wrap;resizeHeight=1;');
                bg14.geometry.relative = true;
                bg14.geometry.offset = new mxPoint(380, 0);
                bg14.vertex = true;
                bg10.insert(bg14);
                var notif1 = new mxCell('', new mxGeometry(0, 0.5, 20, 20), s + 'checkbox;fillColor=#ffffff;strokeColor=#666666;');
                notif1.geometry.relative = true;
                notif1.geometry.offset = new mxPoint(560, -10);
                notif1.vertex = true;
                bg10.insert(notif1);
                var notif2 = new mxCell('', new mxGeometry(0, 0.5, 20, 20), 'shape=ellipse;strokeColor=#666666;fillColor=#ffffff;html=1;');
                notif2.geometry.relative = true;
                notif2.geometry.offset = new mxPoint(700, -10);
                notif2.vertex = true;
                bg10.insert(notif2);
                var bg17 = new mxCell('', new mxGeometry(0, 0, 800, 40), inh + s + 'rect;whiteSpace=wrap;resizeWidth=1;');
                bg17.geometry.relative = true;
                bg17.geometry.offset = new mxPoint(0, 200);
                bg17.vertex = true;
                bg1.insert(bg17);
                var bg18 = new mxCell('2', new mxGeometry(0, 0, 50, 40), s + 'rect;strokeColor=none;fillColor=none;fontSize=14;whiteSpace=wrap;resizeHeight=1;');
                bg18.geometry.relative = true;
                bg18.vertex = true;
                bg17.insert(bg18);
                var bg19 = new mxCell('Mary', new mxGeometry(0, 0, 150, 40), s + 'rect;strokeColor=none;fillColor=none;fontSize=14;align=left;whiteSpace=wrap;resizeHeight=1;');
                bg19.geometry.relative = true;
                bg19.geometry.offset = new mxPoint(80, 0);
                bg19.vertex = true;
                bg17.insert(bg19);
                var bg20 = new mxCell('Brown', new mxGeometry(0, 0, 150, 40), s + 'rect;strokeColor=none;fillColor=none;fontSize=14;align=left;whiteSpace=wrap;resizeHeight=1;');
                bg20.geometry.relative = true;
                bg20.geometry.offset = new mxPoint(230, 0);
                bg20.vertex = true;
                bg17.insert(bg20);
                var bg21 = new mxCell('missmary', new mxGeometry(0, 0, 150, 40), s + 'rect;strokeColor=none;fillColor=none;fontSize=14;align=left;whiteSpace=wrap;resizeHeight=1;');
                bg21.geometry.relative = true;
                bg21.geometry.offset = new mxPoint(380, 0);
                bg21.vertex = true;
                bg17.insert(bg21);
                var notif3 = new mxCell('', new mxGeometry(0, 0.5, 20, 20), s + 'checkbox;fillColor=#ffffff;strokeColor=#666666;');
                notif3.geometry.relative = true;
                notif3.geometry.offset = new mxPoint(560, -10);
                notif3.vertex = true;
                bg17.insert(notif3);
                var notif4 = new mxCell('', new mxGeometry(0, 0.5, 20, 20), s + 'radioButton;fillColor=#ffffff;strokeColor=#666666;');
                notif4.geometry.relative = true;
                notif4.geometry.offset = new mxPoint(700, -10);
                notif4.vertex = true;
                bg17.insert(notif4);
                var bg24 = new mxCell('', new mxGeometry(0, 0, 800, 40), inh + s + 'bottomButton;rSize=5;whiteSpace=wrap;resizeWidth=1;');
                bg24.geometry.relative = true;
                bg24.geometry.offset = new mxPoint(0, 240);
                bg24.vertex = true;
                bg1.insert(bg24);
                var bg25 = new mxCell('3', new mxGeometry(0, 0, 50, 40), s + 'rect;strokeColor=none;fillColor=none;fontSize=14;whiteSpace=wrap;resizeHeight=1;');
                bg25.geometry.relative = true;
                bg25.vertex = true;
                bg24.insert(bg25);
                var bg26 = new mxCell('James', new mxGeometry(0, 0, 150, 40), s + 'rect;strokeColor=none;fillColor=none;fontSize=14;align=left;whiteSpace=wrap;resizeHeight=1;');
                bg26.geometry.relative = true;
                bg26.geometry.offset = new mxPoint(80, 0);
                bg26.vertex = true;
                bg24.insert(bg26);
                var bg27 = new mxCell('Mooray', new mxGeometry(0, 0, 150, 40), s + 'rect;strokeColor=none;fillColor=none;fontSize=14;align=left;whiteSpace=wrap;resizeHeight=1;');
                bg27.geometry.relative = true;
                bg27.geometry.offset = new mxPoint(230, 0);
                bg27.vertex = true;
                bg24.insert(bg27);
                var bg28 = new mxCell('jijames', new mxGeometry(0, 0, 150, 40), s + 'rect;strokeColor=none;fillColor=none;fontSize=14;align=left;whiteSpace=wrap;resizeHeight=1;');
                bg28.geometry.relative = true;
                bg28.geometry.offset = new mxPoint(380, 0);
                bg28.vertex = true;
                bg24.insert(bg28);
                var notif5 = new mxCell('', new mxGeometry(0, 0.5, 20, 20), s + 'rrect;rSize=3;fillColor=#ffffff;strokeColor=#666666;');
                notif5.geometry.relative = true;
                notif5.geometry.offset = new mxPoint(560, -10);
                notif5.vertex = true;
                bg24.insert(notif5);
                var notif6 = new mxCell('', new mxGeometry(0, 0.5, 20, 20), 'shape=ellipse;fillColor=#ffffff;strokeColor=#666666;html=1;');
                notif6.geometry.relative = true;
                notif6.geometry.offset = new mxPoint(700, -10);
                notif6.vertex = true;
                bg24.insert(notif6);

                return sb.createVertexTemplateFromCells([bg1], bg1.geometry.width, bg1.geometry.height, 'Table');
            }),

            this.addEntry(dt + 'panel list group', function () {
                var bg1 = new mxCell('', new mxGeometry(0, 0, 600, 320), s + 'rrect;rSize=5;strokeColor=#dddddd;fillColor=#ffffff;');
                bg1.vertex = true;
                var bg2 = new mxCell('Panel title', new mxGeometry(0, 0, 600, 40), s + 'topButton;rSize=5;strokeColor=inherit;fillColor=#000000;fillOpacity=3;fontColor=#999999;fontSize=14;fontStyle=1;align=left;spacingLeft=10;whiteSpace=wrap;resizeWidth=1;');
                bg2.geometry.relative = true;
                bg2.vertex = true;
                bg1.insert(bg2);
                var bg3 = new mxCell(
                    'Some default panel content here. Nulla vitae elit libero, a pharetra augue. Aenean lacinia bibendum nulla sed consectetur. ' +
                    'Aenean eu leo quam. Pellentesque ornare sem lacinia quam venenatis vestibulum. Nullam id dolor id nibh ultricies vehicula. ',
                    new mxGeometry(0, 0, 600, 80), inh + s + 'rect;align=left;spacingLeft=10;whiteSpace=wrap;fontSize=14;whiteSpace=wrap;resizeWidth=1;');
                bg3.geometry.relative = true;
                bg3.geometry.offset = new mxPoint(0, 40);
                bg3.vertex = true;
                bg1.insert(bg3);
                var bg4 = new mxCell('Cras justo odio', new mxGeometry(0, 0, 600, 40), inh + s + 'rect;spacingLeft=10;fontSize=14;align=left;whiteSpace=wrap;resizeWidth=1;');
                bg4.geometry.relative = true;
                bg4.geometry.offset = new mxPoint(0, 120);
                bg4.vertex = true;
                bg1.insert(bg4);
                var bg5 = new mxCell('Dapibus ac facilisis in', new mxGeometry(0, 0, 600, 40), inh + s + 'rect;spacingLeft=10;fontSize=14;align=left;whiteSpace=wrap;resizeWidth=1;');
                bg5.geometry.relative = true;
                bg5.geometry.offset = new mxPoint(0, 160);
                bg5.vertex = true;
                bg1.insert(bg5);
                var bg6 = new mxCell('Morbi leo risus', new mxGeometry(0, 0, 600, 40), inh + s + 'rect;spacingLeft=10;fontSize=14;align=left;whiteSpace=wrap;resizeWidth=1;');
                bg6.geometry.relative = true;
                bg6.geometry.offset = new mxPoint(0, 200);
                bg6.vertex = true;
                bg1.insert(bg6);
                var bg7 = new mxCell('Porta ac consectetur ac', new mxGeometry(0, 0, 600, 40), inh + s + 'rect;spacingLeft=10;fontSize=14;align=left;whiteSpace=wrap;resizeWidth=1;');
                bg7.geometry.relative = true;
                bg7.geometry.offset = new mxPoint(0, 240);
                bg7.vertex = true;
                bg1.insert(bg7);
                var bg8 = new mxCell('Vestibulum at eros', new mxGeometry(0, 1, 600, 40), inh + s + 'bottomButton;rSize=5;spacingLeft=10;fontSize=14;align=left;whiteSpace=wrap;resizeWidth=1;');
                bg8.geometry.relative = true;
                bg8.geometry.offset = new mxPoint(0, -40);
                bg8.vertex = true;
                bg1.insert(bg8);

                return sb.createVertexTemplateFromCells([bg1], bg1.geometry.width, bg1.geometry.height, 'Panel (List Group)');
            }),

            this.addEntry(dt + 'table', function () {
                var bg1 = new mxCell('', new mxGeometry(0, 0, 800, 160), 'html=1;shadow=0;dashed=0;shape=partialRectangle;top=0;bottom=0;right=0;left=0;strokeColor=#dddddd;fillColor=#ffffff;');
                bg1.vertex = true;
                var bg2 = new mxCell('', new mxGeometry(0, 0, 800, 40), s + 'horLines;strokeColor=inherit;fillColor=#000000;fillOpacity=3;resizeWidth=1;');
                bg2.geometry.relative = true;
                bg2.vertex = true;
                bg1.insert(bg2);
                var bg3 = new mxCell('#', new mxGeometry(0, 0, 50, 40), s + 'rect;strokeColor=none;fillColor=none;fontSize=14;fontStyle=1;whiteSpace=wrap;resizeHeight=1;');
                bg3.geometry.relative = true;
                bg3.vertex = true;
                bg2.insert(bg3);
                var bg4 = new mxCell('First Name', new mxGeometry(0, 0, 150, 40), s + 'rect;strokeColor=none;fillColor=none;fontSize=14;fontStyle=1;align=left;whiteSpace=wrap;resizeHeight=1;');
                bg4.geometry.relative = true;
                bg4.geometry.offset = new mxPoint(80, 0);
                bg4.vertex = true;
                bg2.insert(bg4);
                var bg5 = new mxCell('Last Name', new mxGeometry(0, 0, 150, 40), s + 'rect;strokeColor=none;fillColor=none;fontSize=14;fontStyle=1;align=left;whiteSpace=wrap;resizeHeight=1;');
                bg5.geometry.relative = true;
                bg5.geometry.offset = new mxPoint(230, 0);
                bg5.vertex = true;
                bg2.insert(bg5);
                var bg6 = new mxCell('Username', new mxGeometry(0, 0, 150, 40), s + 'rect;strokeColor=none;fillColor=none;fontSize=14;fontStyle=1;align=left;whiteSpace=wrap;resizeHeight=1;');
                bg6.geometry.relative = true;
                bg6.geometry.offset = new mxPoint(380, 0);
                bg6.vertex = true;
                bg2.insert(bg6);
                var bg7 = new mxCell('Active', new mxGeometry(0, 0, 100, 40), s + 'rect;strokeColor=none;fillColor=none;fontSize=14;fontStyle=1;align=left;whiteSpace=wrap;resizeHeight=1;');
                bg7.geometry.relative = true;
                bg7.geometry.offset = new mxPoint(560, 0);
                bg7.vertex = true;
                bg2.insert(bg7);
                var bg8 = new mxCell('Boss', new mxGeometry(0, 0, 100, 40), s + 'rect;strokeColor=none;fillColor=none;fontSize=14;fontStyle=1;align=left;whiteSpace=wrap;resizeHeight=1;');
                bg8.geometry.relative = true;
                bg8.geometry.offset = new mxPoint(700, 0);
                bg8.vertex = true;
                bg2.insert(bg8);
                var bg9 = new mxCell('', new mxGeometry(0, 0, 800, 40), inh + s + 'horLines;resizeWidth=1;');
                bg9.geometry.relative = true;
                bg9.geometry.offset = new mxPoint(0, 40);
                bg9.vertex = true;
                bg1.insert(bg9);
                var bg10 = new mxCell('1', new mxGeometry(0, 0, 50, 40), s + 'rect;strokeColor=none;fillColor=none;fontSize=14;whiteSpace=wrap;resizeHeight=1;');
                bg10.geometry.relative = true;
                bg10.vertex = true;
                bg9.insert(bg10);
                var bg11 = new mxCell('John', new mxGeometry(0, 0, 150, 40), s + 'rect;strokeColor=none;fillColor=none;fontSize=14;align=left;whiteSpace=wrap;resizeHeight=1;');
                bg11.geometry.relative = true;
                bg11.geometry.offset = new mxPoint(80, 0);
                bg11.vertex = true;
                bg9.insert(bg11);
                var bg12 = new mxCell('Boo', new mxGeometry(0, 0, 150, 40), s + 'rect;strokeColor=none;fillColor=none;fontSize=14;align=left;whiteSpace=wrap;resizeHeight=1;');
                bg12.geometry.relative = true;
                bg12.geometry.offset = new mxPoint(230, 0);
                bg12.vertex = true;
                bg9.insert(bg12);
                var bg13 = new mxCell('johnny81', new mxGeometry(0, 0, 150, 40), s + 'rect;strokeColor=none;fillColor=none;fontSize=14;align=left;whiteSpace=wrap;resizeHeight=1;');
                bg13.geometry.relative = true;
                bg13.geometry.offset = new mxPoint(380, 0);
                bg13.vertex = true;
                bg9.insert(bg13);
                var notif1 = new mxCell('', new mxGeometry(0, 0.5, 20, 20), s + 'checkbox;strokeColor=#666666;fillColor=#ffffff;');
                notif1.geometry.relative = true;
                notif1.geometry.offset = new mxPoint(560, -10);
                notif1.vertex = true;
                bg9.insert(notif1);
                var notif2 = new mxCell('', new mxGeometry(0, 0.5, 20, 20), 'shape=ellipse;strokeColor=#666666;html=1;fillColor=#ffffff;');
                notif2.geometry.relative = true;
                notif2.geometry.offset = new mxPoint(700, -10);
                notif2.vertex = true;
                bg9.insert(notif2);
                var bg16 = new mxCell('', new mxGeometry(0, 0, 800, 40), inh + s + 'horLines;resizeWidth=1;');
                bg16.geometry.relative = true;
                bg16.geometry.offset = new mxPoint(0, 80);
                bg16.vertex = true;
                bg1.insert(bg16);
                var bg17 = new mxCell('2', new mxGeometry(0, 0, 50, 40), s + 'rect;strokeColor=none;fillColor=none;fontSize=14;whiteSpace=wrap;resizeHeight=1;');
                bg17.geometry.relative = true;
                bg17.vertex = true;
                bg16.insert(bg17);
                var bg18 = new mxCell('Mary', new mxGeometry(0, 0, 150, 40), s + 'rect;strokeColor=none;fillColor=none;fontSize=14;align=left;whiteSpace=wrap;resizeHeight=1;');
                bg18.geometry.relative = true;
                bg18.geometry.offset = new mxPoint(80, 0);
                bg18.vertex = true;
                bg16.insert(bg18);
                var bg19 = new mxCell('Brown', new mxGeometry(0, 0, 150, 40), s + 'rect;strokeColor=none;fillColor=none;fontSize=14;align=left;whiteSpace=wrap;resizeHeight=1;');
                bg19.geometry.relative = true;
                bg19.geometry.offset = new mxPoint(230, 0);
                bg19.vertex = true;
                bg16.insert(bg19);
                var bg20 = new mxCell('missmary', new mxGeometry(0, 0, 150, 40), s + 'rect;strokeColor=none;fillColor=none;fontSize=14;align=left;whiteSpace=wrap;resizeHeight=1;');
                bg20.geometry.relative = true;
                bg20.geometry.offset = new mxPoint(380, 0);
                bg20.vertex = true;
                bg16.insert(bg20);
                var notif3 = new mxCell('', new mxGeometry(0, 0.5, 20, 20), s + 'checkbox;strokeColor=#666666;fillColor=#ffffff;');
                notif3.geometry.relative = true;
                notif3.geometry.offset = new mxPoint(560, -10);
                notif3.vertex = true;
                bg16.insert(notif3);
                var notif4 = new mxCell('', new mxGeometry(0, 0.5, 20, 20), s + 'radioButton;strokeColor=#666666;fillColor=#ffffff;');
                notif4.geometry.relative = true;
                notif4.geometry.offset = new mxPoint(700, -10);
                notif4.vertex = true;
                bg16.insert(notif4);
                var bg23 = new mxCell('', new mxGeometry(0, 0, 800, 40), inh + s + 'horLines;resizeWidth=1;');
                bg23.geometry.relative = true;
                bg23.geometry.offset = new mxPoint(0, 120);
                bg23.vertex = true;
                bg1.insert(bg23);
                var bg24 = new mxCell('3', new mxGeometry(0, 0, 50, 40), s + 'rect;strokeColor=none;fillColor=none;fontSize=14;whiteSpace=wrap;resizeHeight=1;');
                bg24.geometry.relative = true;
                bg24.vertex = true;
                bg23.insert(bg24);
                var bg25 = new mxCell('James', new mxGeometry(0, 0, 150, 40), s + 'rect;strokeColor=none;fillColor=none;fontSize=14;align=left;whiteSpace=wrap;resizeHeight=1;');
                bg25.geometry.relative = true;
                bg25.geometry.offset = new mxPoint(80, 0);
                bg25.vertex = true;
                bg23.insert(bg25);
                var bg26 = new mxCell('Mooray', new mxGeometry(0, 0, 150, 40), s + 'rect;strokeColor=none;fillColor=none;fontSize=14;align=left;whiteSpace=wrap;resizeHeight=1;');
                bg26.geometry.relative = true;
                bg26.geometry.offset = new mxPoint(230, 0);
                bg26.vertex = true;
                bg23.insert(bg26);
                var bg27 = new mxCell('jijames', new mxGeometry(0, 0, 150, 40), s + 'rect;strokeColor=none;fillColor=none;fontSize=14;align=left;whiteSpace=wrap;resizeHeight=1;');
                bg27.geometry.relative = true;
                bg27.geometry.offset = new mxPoint(380, 0);
                bg27.vertex = true;
                bg23.insert(bg27);
                var notif5 = new mxCell('', new mxGeometry(0, 0.5, 20, 20), s + 'rrect;rSize=3;strokeColor=#666666;fillColor=#ffffff;');
                notif5.geometry.relative = true;
                notif5.geometry.offset = new mxPoint(560, -10);
                notif5.vertex = true;
                bg23.insert(notif5);
                var notif6 = new mxCell('', new mxGeometry(0, 0.5, 20, 20), 'shape=ellipse;strokeColor=#666666;fillColor=#ffffff;html=1;');
                notif6.geometry.relative = true;
                notif6.geometry.offset = new mxPoint(700, -10);
                notif6.vertex = true;
                bg23.insert(notif6);

                return sb.createVertexTemplateFromCells([bg1], bg1.geometry.width, bg1.geometry.height, 'Table');
            }),

            this.addEntry(dt + 'table', function () {
                var bg1 = new mxCell('', new mxGeometry(0, 0, 800, 360), 'shape=partialRectangle;right=0;left=0;strokeColor=#dddddd;fillColor=#ffffff;whiteSpace=wrap;');
                bg1.vertex = true;
                var bg2 = new mxCell('', new mxGeometry(0, 0, 800, 40), s + 'horLines;strokeColor=inherit;fillColor=#000000;fillOpacity=3;resizeWidth=1;');
                bg2.geometry.relative = true;
                bg2.vertex = true;
                bg1.insert(bg2);
                var bg3 = new mxCell('Name', new mxGeometry(0, 0, 150, 40), s + 'rect;strokeColor=none;fillColor=none;fontSize=14;fontStyle=1;align=left;whiteSpace=wrap;resizeHeight=1;');
                bg3.geometry.relative = true;
                bg3.geometry.offset = new mxPoint(50, 0);
                bg3.vertex = true;
                bg2.insert(bg3);
                var bg4 = new mxCell('Double-Line\nHeader', new mxGeometry(0, 0, 150, 40), s + 'rect;strokeColor=none;fillColor=none;fontSize=14;fontStyle=1;align=left;whiteSpace=wrap;resizeHeight=1;');
                bg4.geometry.relative = true;
                bg4.geometry.offset = new mxPoint(250, 0);
                bg4.vertex = true;
                bg2.insert(bg4);
                var bg5 = new mxCell('Rating', new mxGeometry(0, 0, 150, 40), s + 'rect;strokeColor=none;fillColor=none;fontSize=14;fontStyle=1;align=left;whiteSpace=wrap;resizeHeight=1;');
                bg5.geometry.relative = true;
                bg5.geometry.offset = new mxPoint(450, 0);
                bg5.vertex = true;
                bg2.insert(bg5);
                var bg6 = new mxCell('Signed Up', new mxGeometry(0, 0, 100, 40), s + 'rect;strokeColor=none;fillColor=none;fontSize=14;fontStyle=1;align=left;whiteSpace=wrap;resizeHeight=1;');
                bg6.geometry.relative = true;
                bg6.geometry.offset = new mxPoint(620, 0);
                bg6.vertex = true;
                bg2.insert(bg6);
                var notif1 = new mxCell('', new mxGeometry(1, 0.5, 10, 5), 'shape=triangle;direction=south;strokeColor=none;fillColor=#000000;');
                notif1.geometry.relative = true;
                notif1.geometry.offset = new mxPoint(-25, -2.5);
                notif1.vertex = true;
                bg6.insert(notif1);
                var bg8 = new mxCell('', new mxGeometry(0, 0, 800, 40), inh + s + 'horLines;resizeWidth=1;');
                bg8.geometry.relative = true;
                bg8.geometry.offset = new mxPoint(0, 40);
                bg8.vertex = true;
                bg1.insert(bg8);
                var notif2 = new mxCell('', new mxGeometry(0, 0.5, 20, 20), 'shape=ellipse;strokeColor=none;fillColor=#dddddd;html=1;');
                notif2.geometry.relative = true;
                notif2.geometry.offset = new mxPoint(15, -10);
                notif2.vertex = true;
                bg8.insert(notif2);
                var notif3 = new mxCell('', new mxGeometry(0.5, 0.5, 14, 12), s + 'user;strokeColor=none;fillColor=#999999;');
                notif3.geometry.relative = true;
                notif3.geometry.offset = new mxPoint(-7, -6);
                notif3.vertex = true;
                notif2.insert(notif3);
                var bg11 = new mxCell('John Boo', new mxGeometry(0, 0, 150, 40), s + 'rect;strokeColor=none;fillColor=none;fontSize=14;align=left;whiteSpace=wrap;resizeHeight=1;');
                bg11.geometry.relative = true;
                bg11.geometry.offset = new mxPoint(50, 0);
                bg11.vertex = true;
                bg8.insert(bg11);
                var notif4 = new mxCell('ok', new mxGeometry(0, 0.5, 30, 20), s + 'rrect;rSize=3;strokeColor=none;fillColor=#58B957;fontSize=12;fontStyle=1;fontColor=#ffffff;whiteSpace=wrap;');
                notif4.geometry.relative = true;
                notif4.geometry.offset = new mxPoint(250, -10);
                notif4.vertex = true;
                bg8.insert(notif4);
                var notif5 = new mxCell('', new mxGeometry(0, 0.5, 150, 14), s + 'rating;strokeColor=none;fillColor=#EFAC43;emptyFillColor=#dddddd;grade=3;ratingScale=5;ratingStyle=star;');
                notif5.geometry.relative = true;
                notif5.geometry.offset = new mxPoint(450, -7);
                notif5.vertex = true;
                bg8.insert(notif5);
                var bg14 = new mxCell(
                    '<table cellpadding="0" cellspacing="0" style="width:100%;height:100%;"><tr><td align="center" valign="middle" width="50%">15 Sep, 8:56 AM <font color="#dddddd">(2013)</font></td></tr></table>',
                    new mxGeometry(0, 0, 160, 40), s + 'rect;strokeColor=none;fillColor=none;fontSize=14;align=left;overflow=fill;whiteSpace=wrap;resizeHeight=1;');
                bg14.geometry.relative = true;
                bg14.geometry.offset = new mxPoint(620, 0);
                bg14.vertex = true;
                bg8.insert(bg14);
                var bg15 = new mxCell('', new mxGeometry(0, 0, 800, 40), inh + s + 'horLines;resizeWidth=1;');
                bg15.geometry.relative = true;
                bg15.geometry.offset = new mxPoint(0, 80);
                bg15.vertex = true;
                bg1.insert(bg15);
                var notif6 = new mxCell('', new mxGeometry(0, 0.5, 20, 20), 'shape=ellipse;strokeColor=none;fillColor=#dddddd;html=1;');
                notif6.geometry.relative = true;
                notif6.geometry.offset = new mxPoint(15, -10);
                notif6.vertex = true;
                bg15.insert(notif6);
                var notif7 = new mxCell('', new mxGeometry(0.5, 0.5, 14, 12), s + 'user;strokeColor=none;fillColor=#999999;');
                notif7.geometry.relative = true;
                notif7.geometry.offset = new mxPoint(-7, -6);
                notif7.vertex = true;
                notif6.insert(notif7);
                var bg18 = new mxCell('Michael Robinson', new mxGeometry(0, 0, 150, 40), s + 'rect;strokeColor=none;fillColor=none;fontSize=14;align=left;whiteSpace=wrap;resizeHeight=1;');
                bg18.geometry.relative = true;
                bg18.geometry.offset = new mxPoint(50, 0);
                bg18.vertex = true;
                bg15.insert(bg18);
                var notif8 = new mxCell('ok', new mxGeometry(0, 0.5, 30, 20), s + 'rrect;rSize=3;strokeColor=none;fillColor=#58B957;fontSize=12;fontStyle=1;fontColor=#ffffff;whiteSpace=wrap;');
                notif8.geometry.relative = true;
                notif8.geometry.offset = new mxPoint(250, -10);
                notif8.vertex = true;
                bg15.insert(notif8);
                var notif9 = new mxCell('', new mxGeometry(0, 0.5, 150, 14), s + 'rating;strokeColor=none;fillColor=#EFAC43;emptyFillColor=#dddddd;grade=5;ratingScale=5;ratingStyle=star;');
                notif9.geometry.relative = true;
                notif9.geometry.offset = new mxPoint(450, -7);
                notif9.vertex = true;
                bg15.insert(notif9);
                var bg21 = new mxCell(
                    '<table cellpadding="0" cellspacing="0" style="width:100%;height:100%;"><tr><td align="center" valign="middle" width="50%">15 Sep, 7:12 AM <font color="#dddddd">(2013)</font></td></tr></table>',
                    new mxGeometry(0, 0, 160, 40), s + 'rect;strokeColor=none;fillColor=none;fontSize=14;align=left;overflow=fill;whiteSpace=wrap;resizeHeight=1;');
                bg21.geometry.relative = true;
                bg21.geometry.offset = new mxPoint(620, 0);
                bg21.vertex = true;
                bg15.insert(bg21);
                var bg22 = new mxCell('', new mxGeometry(0, 0, 800, 40), inh + s + 'horLines;resizeWidth=1;');
                bg22.geometry.relative = true;
                bg22.geometry.offset = new mxPoint(0, 120);
                bg22.vertex = true;
                bg1.insert(bg22);
                var notif10 = new mxCell('', new mxGeometry(0, 0.5, 20, 20), 'shape=ellipse;strokeColor=none;fillColor=#dddddd;html=1;');
                notif10.geometry.relative = true;
                notif10.geometry.offset = new mxPoint(15, -10);
                notif10.vertex = true;
                bg22.insert(notif10);
                var notif11 = new mxCell('', new mxGeometry(0.5, 0.5, 14, 12), s + 'user;strokeColor=none;fillColor=#999999;');
                notif11.geometry.relative = true;
                notif11.geometry.offset = new mxPoint(-7, -6);
                notif11.vertex = true;
                notif10.insert(notif11);
                var bg25 = new mxCell('Alexander Robson', new mxGeometry(0, 0, 150, 40), s + 'rect;strokeColor=none;fillColor=none;fontSize=14;align=left;whiteSpace=wrap;resizeHeight=1;');
                bg25.geometry.relative = true;
                bg25.geometry.offset = new mxPoint(50, 0);
                bg25.vertex = true;
                bg22.insert(bg25);
                var notif12 = new mxCell('Blocked', new mxGeometry(0, 0.5, 70, 20), s + 'rrect;rSize=3;strokeColor=none;fillColor=#999999;fontSize=12;fontStyle=1;fontColor=#ffffff;whiteSpace=wrap;');
                notif12.geometry.relative = true;
                notif12.geometry.offset = new mxPoint(250, -10);
                notif12.vertex = true;
                bg22.insert(notif12);
                var bg27 = new mxCell(
                    '<table cellpadding="0" cellspacing="0" style="width:100%;height:100%;"><tr><td align="center" valign="middle" width="50%">15 Sep, 4:32 AM <font color="#dddddd">(2013)</font></td></tr></table>',
                    new mxGeometry(0, 0, 160, 40), s + 'rect;strokeColor=none;fillColor=none;fontSize=14;align=left;overflow=fill;whiteSpace=wrap;resizeHeight=1;');
                bg27.geometry.relative = true;
                bg27.geometry.offset = new mxPoint(620, 0);
                bg27.vertex = true;
                bg22.insert(bg27);
                var bg28 = new mxCell('', new mxGeometry(0, 0, 800, 40), inh + s + 'horLines;resizeWidth=1;');
                bg28.geometry.relative = true;
                bg28.geometry.offset = new mxPoint(0, 160);
                bg28.vertex = true;
                bg1.insert(bg28);
                var notif13 = new mxCell('', new mxGeometry(0, 0.5, 20, 20), 'shape=ellipse;strokeColor=none;fillColor=#dddddd;html=1;');
                notif13.geometry.relative = true;
                notif13.geometry.offset = new mxPoint(15, -10);
                notif13.vertex = true;
                bg28.insert(notif13);
                var notif14 = new mxCell('', new mxGeometry(0.5, 0.5, 14, 12), s + 'user;strokeColor=none;fillColor=#999999;');
                notif14.geometry.relative = true;
                notif14.geometry.offset = new mxPoint(-7, -6);
                notif14.vertex = true;
                notif13.insert(notif14);
                var bg31 = new mxCell('Jennifer Pinsker', new mxGeometry(0, 0, 150, 40), s + 'rect;strokeColor=none;fillColor=none;fontSize=14;align=left;whiteSpace=wrap;resizeHeight=1;');
                bg31.geometry.relative = true;
                bg31.geometry.offset = new mxPoint(50, 0);
                bg31.vertex = true;
                bg28.insert(bg31);
                var notif15 = new mxCell('Blocked 24h', new mxGeometry(0, 0.5, 90, 20), s + 'rrect;rSize=3;strokeColor=none;fillColor=#999999;fontSize=12;fontStyle=1;fontColor=#ffffff;whiteSpace=wrap;');
                notif15.geometry.relative = true;
                notif15.geometry.offset = new mxPoint(250, -10);
                notif15.vertex = true;
                bg28.insert(notif15);
                var bg33 = new mxCell(
                    '<table cellpadding="0" cellspacing="0" style="width:100%;height:100%;"><tr><td align="center" valign="middle" width="50%">15 Sep, 2:08 AM <font color="#dddddd">(2013)</font></td></tr></table>',
                    new mxGeometry(0, 0, 160, 40), s + 'rect;strokeColor=none;fillColor=none;fontSize=14;align=left;overflow=fill;whiteSpace=wrap;resizeHeight=1;');
                bg33.geometry.relative = true;
                bg33.geometry.offset = new mxPoint(620, 0);
                bg33.vertex = true;
                bg28.insert(bg33);
                var bg34 = new mxCell('', new mxGeometry(0, 0, 800, 40), inh + s + 'horLines;resizeWidth=1;');
                bg34.geometry.relative = true;
                bg34.geometry.offset = new mxPoint(0, 200);
                bg34.vertex = true;
                bg1.insert(bg34);
                var notif16 = new mxCell('', new mxGeometry(0, 0.5, 20, 20), 'shape=ellipse;strokeColor=none;fillColor=#dddddd;html=1;');
                notif16.geometry.relative = true;
                notif16.geometry.offset = new mxPoint(15, -10);
                notif16.vertex = true;
                bg34.insert(notif16);
                var notif17 = new mxCell('', new mxGeometry(0.5, 0.5, 14, 12), s + 'user;strokeColor=none;fillColor=#999999;');
                notif17.geometry.relative = true;
                notif17.geometry.offset = new mxPoint(-7, -6);
                notif17.vertex = true;
                notif16.insert(notif17);
                var bg37 = new mxCell('Bob Robson', new mxGeometry(0, 0, 150, 40), s + 'rect;strokeColor=none;fillColor=none;fontSize=14;align=left;whiteSpace=wrap;resizeHeight=1;');
                bg37.geometry.relative = true;
                bg37.geometry.offset = new mxPoint(50, 0);
                bg37.vertex = true;
                bg34.insert(bg37);
                var notif18 = new mxCell('ok', new mxGeometry(0, 0.5, 30, 20), s + 'rrect;rSize=3;strokeColor=none;fillColor=#58B957;fontSize=12;fontStyle=1;fontColor=#ffffff;whiteSpace=wrap;');
                notif18.geometry.relative = true;
                notif18.geometry.offset = new mxPoint(250, -10);
                notif18.vertex = true;
                bg34.insert(notif18);
                var notif20 = new mxCell('', new mxGeometry(0, 0.5, 150, 14), s + 'rating;strokeColor=none;fillColor=#EFAC43;emptyFillColor=#dddddd;grade=1;ratingScale=5;ratingStyle=star;');
                notif20.geometry.relative = true;
                notif20.geometry.offset = new mxPoint(450, -7);
                notif20.vertex = true;
                bg34.insert(notif20);
                var bg40 = new mxCell(
                    '<table cellpadding="0" cellspacing="0" style="width:100%;height:100%;"><tr><td align="center" valign="middle" width="50%">15 Sep, 8:56 AM <font color="#dddddd">(2013)</font></td></tr></table>',
                    new mxGeometry(0, 0, 160, 40), s + 'rect;strokeColor=none;fillColor=none;fontSize=14;align=left;overflow=fill;whiteSpace=wrap;resizeHeight=1;');
                bg40.geometry.relative = true;
                bg40.geometry.offset = new mxPoint(620, 0);
                bg40.vertex = true;
                bg34.insert(bg40);
                var bg41 = new mxCell('', new mxGeometry(0, 0, 800, 40), inh + s + 'horLines;resizeWidth=1;');
                bg41.geometry.relative = true;
                bg41.geometry.offset = new mxPoint(0, 240);
                bg41.vertex = true;
                bg1.insert(bg41);
                var notif21 = new mxCell('', new mxGeometry(0, 0.5, 20, 20), 'shape=ellipse;strokeColor=none;fillColor=#dddddd;html=1;');
                notif21.geometry.relative = true;
                notif21.geometry.offset = new mxPoint(15, -10);
                notif21.vertex = true;
                bg41.insert(notif21);
                var notif22 = new mxCell('', new mxGeometry(0.5, 0.5, 14, 12), s + 'user;strokeColor=none;fillColor=#999999;');
                notif22.geometry.relative = true;
                notif22.geometry.offset = new mxPoint(-7, -6);
                notif22.vertex = true;
                notif21.insert(notif22);
                var bg44 = new mxCell('Michael Robinson', new mxGeometry(0, 0, 150, 40), s + 'rect;strokeColor=none;fillColor=none;fontSize=14;align=left;whiteSpace=wrap;resizeHeight=1;');
                bg44.geometry.relative = true;
                bg44.geometry.offset = new mxPoint(50, 0);
                bg44.vertex = true;
                bg41.insert(bg44);
                var notif23 = new mxCell('Suspect', new mxGeometry(0, 0.5, 70, 20), s + 'rrect;rSize=3;strokeColor=none;fillColor=#55BFE0;fontSize=12;fontStyle=1;fontColor=#ffffff;whiteSpace=wrap;');
                notif23.geometry.relative = true;
                notif23.geometry.offset = new mxPoint(250, -10);
                notif23.vertex = true;
                bg41.insert(notif23);
                var notif24 = new mxCell('', new mxGeometry(0, 0.5, 150, 14), s + 'rating;strokeColor=none;fillColor=#EFAC43;emptyFillColor=#dddddd;grade=4;ratingScale=5;ratingStyle=star;');
                notif24.geometry.relative = true;
                notif24.geometry.offset = new mxPoint(450, -7);
                notif24.vertex = true;
                bg41.insert(notif24);
                var bg47 = new mxCell(
                    '<table cellpadding="0" cellspacing="0" style="width:100%;height:100%;"><tr><td align="center" valign="middle" width="50%">15 Sep, 7:12 AM <font color="#dddddd">(2013)</font></td></tr></table>',
                    new mxGeometry(0, 0, 160, 40), s + 'rect;strokeColor=none;fillColor=none;fontSize=14;align=left;overflow=fill;whiteSpace=wrap;resizeHeight=1;');
                bg47.geometry.relative = true;
                bg47.geometry.offset = new mxPoint(620, 0);
                bg47.vertex = true;
                bg41.insert(bg47);
                var bg48 = new mxCell('', new mxGeometry(0, 0, 800, 40), inh + s + 'horLines;resizeWidth=1;');
                bg48.geometry.relative = true;
                bg48.geometry.offset = new mxPoint(0, 280);
                bg48.vertex = true;
                bg1.insert(bg48);
                var notif25 = new mxCell('', new mxGeometry(0, 0.5, 20, 20), 'shape=ellipse;strokeColor=none;fillColor=#dddddd;html=1;');
                notif25.geometry.relative = true;
                notif25.geometry.offset = new mxPoint(15, -10);
                notif25.vertex = true;
                bg48.insert(notif25);
                var notif26 = new mxCell('', new mxGeometry(0.5, 0.5, 14, 12), s + 'user;strokeColor=none;fillColor=#999999;');
                notif26.geometry.relative = true;
                notif26.geometry.offset = new mxPoint(-7, -6);
                notif26.vertex = true;
                notif25.insert(notif26);
                var bg51 = new mxCell('Jennifer Pinsker', new mxGeometry(0, 0, 150, 40), s + 'rect;strokeColor=none;fillColor=none;fontSize=14;align=left;whiteSpace=wrap;resizeHeight=1;');
                bg51.geometry.relative = true;
                bg51.geometry.offset = new mxPoint(50, 0);
                bg51.vertex = true;
                bg48.insert(bg51);
                var notif27 = new mxCell('ok', new mxGeometry(0, 0.5, 30, 20), s + 'rrect;rSize=3;strokeColor=none;fillColor=#58B957;fontSize=12;fontStyle=1;fontColor=#ffffff;whiteSpace=wrap;');
                notif27.geometry.relative = true;
                notif27.geometry.offset = new mxPoint(250, -10);
                notif27.vertex = true;
                bg48.insert(notif27);
                var bg53 = new mxCell(
                    '<table cellpadding="0" cellspacing="0" style="width:100%;height:100%;"><tr><td align="center" valign="middle" width="50%">15 Sep, 4:34 AM <font color="#dddddd">(2013)</font></td></tr></table>',
                    new mxGeometry(0, 0, 160, 40), s + 'rect;strokeColor=none;fillColor=none;fontSize=14;align=left;overflow=fill;whiteSpace=wrap;resizeHeight=1;');
                bg53.geometry.relative = true;
                bg53.geometry.offset = new mxPoint(620, 0);
                bg53.vertex = true;
                bg48.insert(bg53);
                var bg54 = new mxCell('', new mxGeometry(0, 0, 800, 40), inh + s + 'horLines;resizeWidth=1;');
                bg54.geometry.relative = true;
                bg54.geometry.offset = new mxPoint(0, 320);
                bg54.vertex = true;
                bg1.insert(bg54);
                var notif28 = new mxCell('', new mxGeometry(0, 0.5, 20, 20), 'shape=ellipse;strokeColor=none;fillColor=#dddddd;html=1;');
                notif28.geometry.relative = true;
                notif28.geometry.offset = new mxPoint(15, -10);
                notif28.vertex = true;
                bg54.insert(notif28);
                var notif29 = new mxCell('', new mxGeometry(0.5, 0.5, 14, 12), s + 'user;strokeColor=none;fillColor=#999999;');
                notif29.geometry.relative = true;
                notif29.geometry.offset = new mxPoint(-7, -6);
                notif29.vertex = true;
                notif28.insert(notif29);
                var bg57 = new mxCell('John Boo', new mxGeometry(0, 0, 150, 40), s + 'rect;strokeColor=none;fillColor=none;fontSize=14;align=left;whiteSpace=wrap;resizeHeight=1;');
                bg57.geometry.relative = true;
                bg57.geometry.offset = new mxPoint(50, 0);
                bg57.vertex = true;
                bg54.insert(bg57);
                var notif30 = new mxCell('Violation', new mxGeometry(0, 0.5, 70, 20), s + 'rrect;rSize=3;strokeColor=none;fillColor=#DB524C;fontSize=12;fontStyle=1;fontColor=#ffffff;whiteSpace=wrap;');
                notif30.geometry.relative = true;
                notif30.geometry.offset = new mxPoint(250, -10);
                notif30.vertex = true;
                bg54.insert(notif30);
                var notif31 = new mxCell('', new mxGeometry(0, 0.5, 150, 14), s + 'rating;strokeColor=none;fillColor=#EFAC43;emptyFillColor=#dddddd;grade=2;ratingScale=5;ratingStyle=star;');
                notif31.geometry.relative = true;
                notif31.geometry.offset = new mxPoint(450, -7);
                notif31.vertex = true;
                bg54.insert(notif31);
                var bg60 = new mxCell(
                    '<table cellpadding="0" cellspacing="0" style="width:100%;height:100%;"><tr><td align="center" valign="middle" width="50%">15 Sep, 2:08 AM <font color="#dddddd">(2013)</font></td></tr></table>',
                    new mxGeometry(0, 0, 160, 40), s + 'rect;strokeColor=none;fillColor=none;fontSize=14;align=left;overflow=fill;whiteSpace=wrap;resizeHeight=1;');
                bg60.geometry.relative = true;
                bg60.geometry.offset = new mxPoint(620, 0);
                bg60.vertex = true;
                bg54.insert(bg60);

                return sb.createVertexTemplateFromCells([bg1], bg1.geometry.width, bg1.geometry.height, 'Table');
            }),

            this.addEntry(dt + 'table', function () {
                var bg1 = new mxCell('', new mxGeometry(0, 0, 800, 340), 'shape=partialRectangle;right=0;left=0;strokeColor=#dddddd;fillColor=#ffffff;whiteSpace=wrap;');
                bg1.vertex = true;
                var bg2 = new mxCell('', new mxGeometry(0, 0, 800, 40), s + 'horLines;strokeColor=inherit;fillColor=#000000;fillOpacity=3;resizeWidth=1;');
                bg2.geometry.relative = true;
                bg2.vertex = true;
                bg1.insert(bg2);
                var bg3 = new mxCell('Admin Name', new mxGeometry(0, 0, 150, 40), s + 'rect;strokeColor=none;fillColor=none;fontSize=14;fontStyle=1;align=left;whiteSpace=wrap;resizeHeight=1;');
                bg3.geometry.relative = true;
                bg3.geometry.offset = new mxPoint(10, 0);
                bg3.vertex = true;
                bg2.insert(bg3);
                var bg4 = new mxCell('Object', new mxGeometry(0, 0, 150, 40), s + 'rect;strokeColor=none;fillColor=none;fontSize=14;fontStyle=1;align=left;whiteSpace=wrap;resizeHeight=1;');
                bg4.geometry.relative = true;
                bg4.geometry.offset = new mxPoint(200, 0);
                bg4.vertex = true;
                bg2.insert(bg4);
                var bg5 = new mxCell('Action', new mxGeometry(0, 0, 150, 40), s + 'rect;strokeColor=none;fillColor=none;fontSize=14;fontStyle=1;align=left;whiteSpace=wrap;resizeHeight=1;');
                bg5.geometry.relative = true;
                bg5.geometry.offset = new mxPoint(400, 0);
                bg5.vertex = true;
                bg2.insert(bg5);
                var bg6 = new mxCell('Date', new mxGeometry(0, 0, 100, 40), s + 'rect;strokeColor=none;fillColor=none;fontSize=14;fontStyle=1;align=left;whiteSpace=wrap;resizeHeight=1;');
                bg6.geometry.relative = true;
                bg6.geometry.offset = new mxPoint(620, 0);
                bg6.vertex = true;
                bg2.insert(bg6);
                var notif1 = new mxCell('', new mxGeometry(0, 0.5, 10, 5), 'shape=triangle;direction=south;strokeColor=none;fillColor=#000000;');
                notif1.geometry.relative = true;
                notif1.geometry.offset = new mxPoint(665, -2.5);
                notif1.vertex = true;
                bg2.insert(notif1);
                var bg8 = new mxCell('', new mxGeometry(0, 0, 800, 50), inh + s + 'horLines;resizeWidth=1;');
                bg8.geometry.relative = true;
                bg8.geometry.offset = new mxPoint(0, 40);
                bg8.vertex = true;
                bg1.insert(bg8);
                var bg9 = new mxCell('Jennifer Pinsker\n', new mxGeometry(0, 0, 150, 50), s + 'rect;strokeColor=none;fillColor=none;fontSize=14;align=left;whiteSpace=wrap;resizeHeight=1;');
                bg9.geometry.relative = true;
                bg9.geometry.offset = new mxPoint(10, 0);
                bg9.vertex = true;
                bg8.insert(bg9);
                var notif2 = new mxCell('', new mxGeometry(0, 0.5, 20, 20), 'shape=ellipse;strokeColor=none;fillColor=#dddddd;html=1;');
                notif2.geometry.relative = true;
                notif2.geometry.offset = new mxPoint(200, -15);
                notif2.vertex = true;
                bg8.insert(notif2);
                var notif3 = new mxCell('', new mxGeometry(0.5, 0.5, 14, 12), s + 'user;strokeColor=none;fillColor=#999999;');
                notif3.geometry.relative = true;
                notif3.geometry.offset = new mxPoint(-7, -6);
                notif3.vertex = true;
                notif2.insert(notif3);
                var bg12 = new mxCell('John Boo\n', new mxGeometry(0, 0, 150, 50), s + 'rect;strokeColor=none;fillColor=none;fontSize=14;align=left;whiteSpace=wrap;resizeHeight=1;');
                bg12.geometry.relative = true;
                bg12.geometry.offset = new mxPoint(230, 0);
                bg12.vertex = true;
                bg8.insert(bg12);
                var bg13 = new mxCell(
                    '<table cellpadding="0" cellspacing="0" style="width:100%;height:100%;"><tr><td align="left" valign="middle" width="50%">Profile Updated<br/><font color="#dddddd">First Name is set to Bobby</font></td></tr></table>',
                    new mxGeometry(0, 0, 210, 50), s + 'rect;strokeColor=none;fillColor=none;fontSize=14;align=left;overflow=fill;whiteSpace=wrap;resizeHeight=1;');
                bg13.geometry.relative = true;
                bg13.geometry.offset = new mxPoint(400, 0);
                bg13.vertex = true;
                bg8.insert(bg13);
                var bg14 = new mxCell(
                    '<table cellpadding="0" cellspacing="0" style="width:100%;height:100%;"><tr><td align="center" valign="middle" width="50%">15 Sep, 8:56 AM <font color="#dddddd">(2013)<br><br></font></td></tr></table>',
                    new mxGeometry(0, 0, 160, 50), s + 'rect;strokeColor=none;fillColor=none;fontSize=14;align=left;overflow=fill;whiteSpace=wrap;resizeHeight=1;');
                bg14.geometry.relative = true;
                bg14.geometry.offset = new mxPoint(620, 0);
                bg14.vertex = true;
                bg8.insert(bg14);
                var bg15 = new mxCell('', new mxGeometry(0, 0, 800, 50), inh + s + 'horLines;resizeWidth=1;');
                bg15.geometry.relative = true;
                bg15.geometry.offset = new mxPoint(0, 90);
                bg15.vertex = true;
                bg1.insert(bg15);
                var bg16 = new mxCell('Bob Robson\n', new mxGeometry(0, 0, 150, 50), s + 'rect;strokeColor=none;fillColor=none;fontSize=14;align=left;whiteSpace=wrap;resizeHeight=1;');
                bg16.geometry.relative = true;
                bg16.geometry.offset = new mxPoint(10, 0);
                bg16.vertex = true;
                bg15.insert(bg16);
                var notif4 = new mxCell('', new mxGeometry(0, 0.5, 20, 20), 'shape=ellipse;strokeColor=none;fillColor=#dddddd;html=1;');
                notif4.geometry.relative = true;
                notif4.geometry.offset = new mxPoint(200, -15);
                notif4.vertex = true;
                bg15.insert(notif4);
                var notif5 = new mxCell('', new mxGeometry(0.5, 0.5, 14, 12), s + 'user;strokeColor=none;fillColor=#999999;');
                notif5.geometry.relative = true;
                notif5.geometry.offset = new mxPoint(-7, -6);
                notif5.vertex = true;
                notif4.insert(notif5);
                var bg19 = new mxCell('Michael Robinson\n', new mxGeometry(0, 0, 150, 50), s + 'rect;strokeColor=none;fillColor=none;fontSize=14;align=left;whiteSpace=wrap;resizeHeight=1;');
                bg19.geometry.relative = true;
                bg19.geometry.offset = new mxPoint(230, 0);
                bg19.vertex = true;
                bg15.insert(bg19);
                var bg20 = new mxCell(
                    '<table cellpadding="0" cellspacing="0" style="width:100%;height:100%;"><tr><td align="left" valign="middle" width="50%">Violation Resolved<br/><font color="#dddddd">Fake Person Violation resolved</font></td></tr></table>',
                    new mxGeometry(0, 0, 210, 50), s + 'rect;strokeColor=none;fillColor=none;fontSize=14;align=left;overflow=fill;whiteSpace=wrap;resizeHeight=1;');
                bg20.geometry.relative = true;
                bg20.geometry.offset = new mxPoint(400, 0);
                bg20.vertex = true;
                bg15.insert(bg20);
                var bg21 = new mxCell(
                    '<table cellpadding="0" cellspacing="0" style="width:100%;height:100%;"><tr><td align="center" valign="middle" width="50%">15 Sep, 7:12 AM <font color="#dddddd">(2013)<br><br></font></td></tr></table>',
                    new mxGeometry(0, 0, 160, 50), s + 'rect;strokeColor=none;fillColor=none;fontSize=14;align=left;overflow=fill;whiteSpace=wrap;resizeHeight=1;');
                bg21.geometry.relative = true;
                bg21.geometry.offset = new mxPoint(620, 0);
                bg21.vertex = true;
                bg15.insert(bg21);
                var bg8 = new mxCell('', new mxGeometry(0, 0, 800, 50), inh + s + 'horLines;resizeWidth=1;');
                bg8.geometry.relative = true;
                bg8.geometry.offset = new mxPoint(0, 140);
                bg8.vertex = true;
                bg1.insert(bg8);
                var bg9 = new mxCell('Michael Robinson\n', new mxGeometry(0, 0, 150, 50), s + 'rect;strokeColor=none;fillColor=none;fontSize=14;align=left;whiteSpace=wrap;resizeHeight=1;');
                bg9.geometry.relative = true;
                bg9.geometry.offset = new mxPoint(10, 0);
                bg9.vertex = true;
                bg8.insert(bg9);
                var notif6 = new mxCell('', new mxGeometry(0, 0.5, 20, 20), 'shape=ellipse;strokeColor=none;fillColor=#dddddd;html=1;');
                notif6.geometry.relative = true;
                notif6.geometry.offset = new mxPoint(200, -15);
                notif6.vertex = true;
                bg8.insert(notif6);
                var notif7 = new mxCell('', new mxGeometry(0.5, 0.5, 14, 12), s + 'user;strokeColor=none;fillColor=#999999;');
                notif7.geometry.relative = true;
                notif7.geometry.offset = new mxPoint(-7, -6);
                notif7.vertex = true;
                notif6.insert(notif7);
                var bg12 = new mxCell('Alexander Robson\n', new mxGeometry(0, 0, 150, 50), s + 'rect;strokeColor=none;fillColor=none;fontSize=14;align=left;whiteSpace=wrap;resizeHeight=1');
                bg12.geometry.relative = true;
                bg12.geometry.offset = new mxPoint(230, 0);
                bg12.vertex = true;
                bg8.insert(bg12);
                var bg13 = new mxCell(
                    '<table cellpadding="0" cellspacing="0" style="width:100%;height:100%;"><tr><td align="left" valign="middle" width="50%">Suspect Resolved<br/><font color="#dddddd">Mass Friending Suspect resolved</font></td></tr></table>',
                    new mxGeometry(0, 0, 210, 50), s + 'rect;strokeColor=none;fillColor=none;fontSize=14;align=left;overflow=fill;whiteSpace=wrap;resizeWidth=1;');
                bg13.geometry.relative = true;
                bg13.geometry.offset = new mxPoint(400, 0);
                bg13.vertex = true;
                bg8.insert(bg13);
                var bg14 = new mxCell(
                    '<table cellpadding="0" cellspacing="0" style="width:100%;height:100%;"><tr><td align="center" valign="middle" width="50%">15 Sep, 4:34 AM <font color="#dddddd">(2013)<br><br></font></td></tr></table>',
                    new mxGeometry(0, 0, 160, 50), s + 'rect;strokeColor=none;fillColor=none;fontSize=14;align=left;overflow=fill;whiteSpace=wrap;resizeHeight=1;');
                bg14.geometry.relative = true;
                bg14.geometry.offset = new mxPoint(620, 0);
                bg14.vertex = true;
                bg8.insert(bg14);
                var bg8 = new mxCell('', new mxGeometry(0, 0, 800, 50), inh + s + 'horLines;resizeWidth=1;');
                bg8.geometry.relative = true;
                bg8.geometry.offset = new mxPoint(0, 190);
                bg8.vertex = true;
                bg1.insert(bg8);
                var bg9 = new mxCell('Jennifer Pinsker\n', new mxGeometry(0, 0, 150, 50), s + 'rect;strokeColor=none;fillColor=none;fontSize=14;align=left;whiteSpace=wrap;resizeHeight=1;');
                bg9.geometry.relative = true;
                bg9.geometry.offset = new mxPoint(10, 0);
                bg9.vertex = true;
                bg8.insert(bg9);
                var notif8 = new mxCell('', new mxGeometry(0, 0.5, 20, 20), 'shape=ellipse;strokeColor=none;fillColor=#dddddd;html=1;');
                notif8.geometry.relative = true;
                notif8.geometry.offset = new mxPoint(200, -15);
                notif8.vertex = true;
                bg8.insert(notif8);
                var notif9 = new mxCell('', new mxGeometry(0.5, 0.5, 14, 12), s + 'user;strokeColor=none;fillColor=#999999;');
                notif9.geometry.relative = true;
                notif9.geometry.offset = new mxPoint(-7, -6);
                notif9.vertex = true;
                notif8.insert(notif9);
                var bg12 = new mxCell('Jennifer Pinsker\n', new mxGeometry(0, 0, 150, 50), s + 'rect;strokeColor=none;fillColor=none;fontSize=14;align=left;whiteSpace=wrap;resizeHeight=1;');
                bg12.geometry.relative = true;
                bg12.geometry.offset = new mxPoint(230, 0);
                bg12.vertex = true;
                bg8.insert(bg12);
                var bg13 = new mxCell(
                    '<table cellpadding="0" cellspacing="0" style="width:100%;height:100%;"><tr><td align="left" valign="middle" width="50%">Profile Violation Detected<br/><font color="#dddddd">First Name is marked as Violation</font></td></tr></table>',
                    new mxGeometry(0, 0, 210, 50), s + 'rect;strokeColor=none;fillColor=none;fontSize=14;align=left;overflow=fill;whiteSpace=wrap;resizeHeight=1;');
                bg13.geometry.relative = true;
                bg13.geometry.offset = new mxPoint(400, 0);
                bg13.vertex = true;
                bg8.insert(bg13);
                var bg14 = new mxCell(
                    '<table cellpadding="0" cellspacing="0" style="width:100%;height:100%;"><tr><td align="center" valign="middle" width="50%">15 Sep, 2:08 AM <font color="#dddddd">(2013)<br><br></font></td></tr></table>',
                    new mxGeometry(0, 0, 160, 50), s + 'rect;strokeColor=none;fillColor=none;fontSize=14;align=left;overflow=fill;whiteSpace=wrap;resizeHeight=1;');
                bg14.geometry.relative = true;
                bg14.geometry.offset = new mxPoint(620, 0);
                bg14.vertex = true;
                bg8.insert(bg14);
                var bg8 = new mxCell('', new mxGeometry(0, 0, 800, 50), inh + s + 'horLines;resizeWidth=1;');
                bg8.geometry.relative = true;
                bg8.geometry.offset = new mxPoint(0, 240);
                bg8.vertex = true;
                bg1.insert(bg8);
                var bg9 = new mxCell('John Boo\n', new mxGeometry(0, 0, 150, 50), s + 'rect;strokeColor=none;fillColor=none;fontSize=14;align=left;whiteSpace=wrap;resizeHeight=1;');
                bg9.geometry.relative = true;
                bg9.geometry.offset = new mxPoint(10, 0);
                bg9.vertex = true;
                bg8.insert(bg9);
                var notif10 = new mxCell('', new mxGeometry(0, 0.5, 20, 20), 'shape=ellipse;strokeColor=none;fillColor=#dddddd;html=1;');
                notif10.geometry.relative = true;
                notif10.geometry.offset = new mxPoint(200, -15);
                notif10.vertex = true;
                bg8.insert(notif10);
                var notif11 = new mxCell('', new mxGeometry(0.5, 0.5, 14, 12), s + 'user;strokeColor=none;fillColor=#999999;');
                notif11.geometry.relative = true;
                notif11.geometry.offset = new mxPoint(-7, -6);
                notif11.vertex = true;
                notif10.insert(notif11);
                var bg12 = new mxCell('Bob Robson\n', new mxGeometry(0, 0, 150, 50), s + 'rect;strokeColor=none;fillColor=none;fontSize=14;align=left;whiteSpace=wrap;resizeHeight=1;');
                bg12.geometry.relative = true;
                bg12.geometry.offset = new mxPoint(230, 0);
                bg12.vertex = true;
                bg8.insert(bg12);
                var bg13 = new mxCell(
                    '<table cellpadding="0" cellspacing="0" style="width:100%;height:100%;"><tr><td align="left" valign="middle" width="50%">Profile Updated<br/><font color="#dddddd">First Name is set to Bobby</font></td></tr></table>',
                    new mxGeometry(0, 0, 210, 50), s + 'rect;strokeColor=none;fillColor=none;fontSize=14;align=left;overflow=fill;whiteSpace=wrap;resizeHeight=1;');
                bg13.geometry.relative = true;
                bg13.geometry.offset = new mxPoint(400, 0);
                bg13.vertex = true;
                bg8.insert(bg13);
                var bg14 = new mxCell(
                    '<table cellpadding="0" cellspacing="0" style="width:100%;height:100%;"><tr><td align="center" valign="middle" width="50%">15 Sep, 8:56 AM <font color="#dddddd">(2013)<br><br></font></td></tr></table>',
                    new mxGeometry(0, 0, 160, 50), s + 'rect;strokeColor=none;fillColor=none;fontSize=14;align=left;overflow=fill;whiteSpace=wrap;resizeHeight=1;');
                bg14.geometry.relative = true;
                bg14.geometry.offset = new mxPoint(620, 0);
                bg14.vertex = true;
                bg8.insert(bg14);
                var bg8 = new mxCell('', new mxGeometry(0, 0, 800, 50), inh + s + 'horLines;resizeWidth=1;');
                bg8.geometry.relative = true;
                bg8.geometry.offset = new mxPoint(0, 290);
                bg8.vertex = true;
                bg1.insert(bg8);
                var bg9 = new mxCell('Michael Robinson\n', new mxGeometry(0, 0, 150, 50), s + 'rect;strokeColor=none;fillColor=none;fontSize=14;align=left;whiteSpace=wrap;resizeHeight=1;');
                bg9.geometry.relative = true;
                bg9.geometry.offset = new mxPoint(10, 0);
                bg9.vertex = true;
                bg8.insert(bg9);
                var notif12 = new mxCell('', new mxGeometry(0, 0.5, 20, 20), 'shape=ellipse;strokeColor=none;fillColor=#dddddd;html=1;');
                notif12.geometry.relative = true;
                notif12.geometry.offset = new mxPoint(200, -15);
                notif12.vertex = true;
                bg8.insert(notif12);
                var notif13 = new mxCell('', new mxGeometry(0.5, 0.5, 14, 12), s + 'user;strokeColor=none;fillColor=#999999;');
                notif13.geometry.relative = true;
                notif13.geometry.offset = new mxPoint(-7, -6);
                notif13.vertex = true;
                notif12.insert(notif13);
                var bg12 = new mxCell('Michael Robinson\n', new mxGeometry(0, 0, 150, 50), s + 'rect;strokeColor=none;fillColor=none;fontSize=14;align=left;whiteSpace=wrap;resizeHeight=1;');
                bg12.geometry.relative = true;
                bg12.geometry.offset = new mxPoint(230, 0);
                bg12.vertex = true;
                bg8.insert(bg12);
                var bg13 = new mxCell(
                    '<table cellpadding="0" cellspacing="0" style="width:100%;height:100%;"><tr><td align="left" valign="middle" width="50%">User Blocked<br/><font color="#dddddd">Blocked for 24 hours</font></td></tr></table>',
                    new mxGeometry(0, 0, 210, 50), s + 'rect;strokeColor=none;fillColor=none;fontSize=14;align=left;overflow=fill;whiteSpace=wrap;resizeHeight=1;');
                bg13.geometry.relative = true;
                bg13.geometry.offset = new mxPoint(400, 0);
                bg13.vertex = true;
                bg8.insert(bg13);
                var bg14 = new mxCell(
                    '<table cellpadding="0" cellspacing="0" style="width:100%;height:100%;"><tr><td align="center" valign="middle" width="50%">15 Sep, 7:12 AM <font color="#dddddd">(2013)<br><br></font></td></tr></table>',
                    new mxGeometry(0, 0, 160, 50), s + 'rect;strokeColor=none;fillColor=none;fontSize=14;align=left;overflow=fill;whiteSpace=wrap;resizeHeight=1;');
                bg14.geometry.relative = true;
                bg14.geometry.offset = new mxPoint(620, 0);
                bg14.vertex = true;
                bg8.insert(bg14);

                return sb.createVertexTemplateFromCells([bg1], bg1.geometry.width, bg1.geometry.height, 'Table');
            }),

            this.addEntry(dt + 'table', function () {
                var bg1 = new mxCell('', new mxGeometry(0, 0, 800, 430), s + 'horLines;strokeColor=#dddddd;fillColor=#ffffff;');
                bg1.vertex = true;
                var bg2 = new mxCell('', new mxGeometry(0, 0, 800, 40), s + 'horLines;strokeColor=inherit;fillColor=#000000;fillOpacity=3;resizeWidth=1;');
                bg2.geometry.relative = true;
                bg2.vertex = true;
                bg1.insert(bg2);
                var bg3 = new mxCell('Template Name', new mxGeometry(0, 0, 200, 40), s + 'rect;strokeColor=none;fillColor=none;fontSize=14;fontStyle=1;align=left;spacingLeft=10;whiteSpace=wrap;resizeHeight=1;');
                bg3.geometry.relative = true;
                bg3.vertex = true;
                bg2.insert(bg3);
                var bg4 = new mxCell('Message', new mxGeometry(0, 0, 200, 40), s + 'rect;strokeColor=none;fillColor=none;fontSize=14;fontStyle=1;align=left;spacingLeft=10;whiteSpace=wrap;resizeWidth=1;resizeHeight=1;');
                bg4.geometry.relative = true;
                bg4.geometry.offset = new mxPoint(200, 0);
                bg4.vertex = true;
                bg2.insert(bg4);
                var bg5 = new mxCell('', new mxGeometry(0, 0, 800, 130), inh + s + 'horLines;resizeWidth=1;');
                bg5.geometry.relative = true;
                bg5.geometry.offset = new mxPoint(0, 40);
                bg5.vertex = true;
                bg1.insert(bg5);
                var bg6 = new mxCell('Uncompleted Profile', new mxGeometry(0, 0, 200, 40), s + 'rect;strokeColor=none;fillColor=none;align=left;spacingLeft=10;whiteSpace=wrap;');
                bg6.geometry.relative = true;
                bg6.vertex = true;
                bg5.insert(bg6);
                var bg7 = new mxCell(
                    'Hello! At vero eos et accusamus et iusto odio dignissimos ducimus qui blanditiis praesentium deleniti atque corrupti quos dolores' +
                    'et quas molestias excepturi sint occaecati cupiditate non provident, similique sunt in culpa qui officia deserunt mollitia animi, id est' +
                    'laborum et dolorum fuga. Et harum quidem rerum facilis est et expedita distinctio. Name libero tempore, cum soluta nobis est eligendi' +
                    'optio cumque nihil impedit quo.',
                    new mxGeometry(0, 0, 400, 130), s + 'rect;strokeColor=none;fillColor=none;align=left;valign=top;spacingLeft=10;verticalAlign=top;spacingTop=6;whiteSpace=wrap;resizeWidth=1;');
                bg7.geometry.relative = true;
                bg7.geometry.offset = new mxPoint(200, 0);
                bg7.vertex = true;
                bg5.insert(bg7);
                var notif1 = new mxCell('Edit', new mxGeometry(1, 0, 50, 30), s + 'rrect;rSize=5;strokeColor=#dddddd;fillColor=#ffffff;whiteSpace=wrap;');
                notif1.geometry.relative = true;
                notif1.geometry.offset = new mxPoint(-140, 15);
                notif1.vertex = true;
                bg5.insert(notif1);
                var notif2 = new mxCell('Delete', new mxGeometry(1, 0, 60, 30), s + 'rrect;rSize=5;strokeColor=#dddddd;fillColor=#ffffff;whiteSpace=wrap;');
                notif2.geometry.relative = true;
                notif2.geometry.offset = new mxPoint(-80, 15);
                notif2.vertex = true;
                bg5.insert(notif2);
                var bg8 = new mxCell('', new mxGeometry(0, 0, 800, 100), inh + s + 'horLines;resizeWidth=1;');
                bg8.geometry.relative = true;
                bg8.geometry.offset = new mxPoint(0, 170);
                bg8.vertex = true;
                bg1.insert(bg8);
                var bg9 = new mxCell('Spam Suspect', new mxGeometry(0, 0, 200, 40), s + 'rect;strokeColor=none;fillColor=none;align=left;spacingLeft=10;whiteSpace=wrap;');
                bg9.geometry.relative = true;
                bg9.vertex = true;
                bg8.insert(bg9);
                var bg10 = new mxCell(
                    'Hello, deleniti atque corrupti quos dolores et quas molestias excepturi sint occaecati cupiditate non provident, similique sunt in culpa qui' +
                    'officia deserunt mollitia animi, id est fuga. Et harum quidem rerum facilis est et expedita distinctio. Nam nobis est eligendi optio cumque' +
                    'nihil impedit quo minus id quod maxime placeat.',
                    new mxGeometry(0, 0, 400, 100), s + 'rect;strokeColor=none;fillColor=none;align=left;valign=top;spacingLeft=10;verticalAlign=top;spacingTop=6;whiteSpace=wrap;resizeWidth=1;');
                bg10.geometry.relative = true;
                bg10.geometry.offset = new mxPoint(200, 0);
                bg10.vertex = true;
                bg8.insert(bg10);
                var notif3 = new mxCell('Edit', new mxGeometry(1, 0, 50, 30), s + 'rrect;rSize=5;strokeColor=#dddddd;fillColor=#ffffff;whiteSpace=wrap;');
                notif3.geometry.relative = true;
                notif3.geometry.offset = new mxPoint(-140, 15);
                notif3.vertex = true;
                bg8.insert(notif3);
                var notif4 = new mxCell('Delete', new mxGeometry(1, 0, 60, 30), s + 'rrect;rSize=5;strokeColor=#dddddd;fillColor=#ffffff;whiteSpace=wrap;');
                notif4.geometry.relative = true;
                notif4.geometry.offset = new mxPoint(-80, 15);
                notif4.vertex = true;
                bg8.insert(notif4);

                var bg11 = new mxCell('', new mxGeometry(0, 0, 800, 160), inh + s + 'horLines;resizeWidth=1;');
                bg11.geometry.relative = true;
                bg11.geometry.offset = new mxPoint(0, 270);
                bg11.vertex = true;
                bg1.insert(bg11);
                var bg12 = new mxCell('Profile Blocked', new mxGeometry(0, 0, 200, 40), s + 'rect;strokeColor=none;fillColor=none;align=left;spacingLeft=10;whiteSpace=wrap;');
                bg12.vertex = true;
                bg11.insert(bg12);
                var bg13 = new mxCell(
                    'Hello! Sed ut perspiciatis unde omnis iste natus error sit voluptatem accusantium doloremque laudantium, totam rem aperiam, eaque ipsa' +
                    'quae ab illo inventore veritatis et quasi architecto beatae vitae dicta sunt explicabo. Nemo enim ipsam voluptatem quia voluptas sit' +
                    'aspernatur aut odit aut fugit, sed quia consequuntur magni dolores eos qui ratione voluptatem sequi nesciunt. Neque porro quisquam est,' +
                    'qui dolorem ipsum quia dolor sit amet, consectetur, adipisci velit, sed quia non numquam eius modi tempora incidunt ut labore et dolore' +
                    'magnam aliquam quaerat voluptarem.',
                    new mxGeometry(0, 0, 400, 160), s + 'rect;strokeColor=none;fillColor=none;align=left;valign=top;spacingLeft=10;verticalAlign=top;spacingTop=6;whiteSpace=wrap;resizeWidth=1;');
                bg13.geometry.relative = true;
                bg13.geometry.offset = new mxPoint(200, 0);
                bg13.vertex = true;
                bg11.insert(bg13);
                var notif1 = new mxCell('Edit', new mxGeometry(1, 0, 50, 30), s + 'rrect;rSize=5;strokeColor=#dddddd;fillColor=#ffffff;whiteSpace=wrap;');
                notif1.geometry.relative = true;
                notif1.geometry.offset = new mxPoint(-140, 15);
                notif1.vertex = true;
                bg11.insert(notif1);
                var notif2 = new mxCell('Delete', new mxGeometry(1, 0, 60, 30), s + 'rrect;rSize=5;strokeColor=#dddddd;fillColor=#ffffff;whiteSpace=wrap;');
                notif2.geometry.relative = true;
                notif2.geometry.offset = new mxPoint(-80, 15);
                notif2.vertex = true;
                bg11.insert(notif2);

                return sb.createVertexTemplateFromCells([bg1], bg1.geometry.width, bg1.geometry.height, 'Table');
            }),

            this.addEntry(dt + 'table', function () {
                var bg1 = new mxCell('', new mxGeometry(0, 0, 800, 80), s + 'horLines;strokeColor=#dddddd;fillColor=#fdfdfd;');
                bg1.vertex = true;
                var bg2 = new mxCell('Group Name', new mxGeometry(20, 20, 500, 40), s + 'rrect;rSize=5;strokeColor=#dddddd;fillColor=#ffffff;align=left;spacingLeft=10;fontSize=18;fontColor=#999999;whiteSpace=wrap;');
                bg2.vertex = true;
                bg1.insert(bg2);
                var bg3 = new mxCell('Create Templates Group', new mxGeometry(540, 20, 240, 40), s + 'rrect;rSize=5;strokeColor=none;fillColor=#3D8BCD;fontSize=18;fontColor=#ffffff;whiteSpace=wrap;');
                bg3.vertex = true;
                bg1.insert(bg3);

                return sb.createVertexTemplateFromCells([bg1], bg1.geometry.width, bg1.geometry.height, 'Table');
            }),
            this.addDataEntry(dt + 'edit template', 800, 720, 'Edit Template',
                '7Vtfc6M4DP8s98Brhz8hSR+bhO7tTNLtlPReOw64iW8NZrFp0/v0JxvIJrG7TbdAk50w0xRk2Vj6WbIkwPLGyfpLjrLVjMWYWl5geeOcMVGeJesxptRybRJb3sRyXRv+LPf6lVZHtdoZynEqDunglh2eEC1wSZnjJKNIYKCmKMFlOxcvtGpfiQRmOXEsb8RXKGbPcGHDRYz4CsfVBbRkkj9ZL6VoFwsQiAs4vchxJCSDyNl3PGaU5cCWshS4R4+E0n0SS0VNslzvUh1AR5QsU6BR/KiGy1BE0uVUXU18oDyviMAhkOU0nuHOQKtkxbnA61f1pUiVsr5glmCRvwDLM4nFqtKZXerUXmGyXImaWNIQL6+Xm64/tQ8nFQBmMDwNjPs0YgAHFqBZ177NGaioeUgqTPKQ/Icr9e3iA5qP1SGVuIsTND2q4y1QHLuCs7qL028BpZddMLZAG5pA6zUAWk8DLSwW/0qNni1nG5OhjklrhuRrmPwNDMxyoScM79+Hwd3D9f10+nBzNQusmv9sUq/D59gd2lRfw+9rymH2QAtfuMAJnPyDcoIWLXjD95lZDVBeamAHDrsFOKoOfb9S8+vW5bgtWddAQ0fDoFavAIzSpaS+rVBY9rY6JFZEwkCY1CxnhRSpCa0NBu6u1gb6mjas6I+rbKipbIY5R8vPXr3Htkk4/Q53icvXdgnjFvGXJd2Sp4x66/RKlDLLbphx+SspKIoKjpJiQyAFF5KHxUT+i0G/hHOSqC5xERHFK/enHwWB3wVFaUwEIbI9yxHmoEJSSM/3xGiRCSTUBeQMOAU+eU/xo5Bhe8TyHBhIPRzjsYQYb+byo0DyPGEUc0HUOV5HOBNFLsfhBMBSfdkiQjhCavSoyAhMqMoMwDLltNgTiXHNDdIQSso58CJVUqeqJ83Qtmzs8ZFEBKnZg1svWWE2FORAKIVhSm4ig16YIvxStGC5ElhJoARSl4/FEl3A/0CSV6gkwm1itUnkuOKC9UuVKsvh1CB4nWEpkYIDFJFKjyPHukGyDyWLElbYbzJQXzmnSI3HAQKBUrbYHhNsBgNmUkDQPtvwlxpJyYqo1Zeou27AkaKTVC0UKW9FlZInaE1kAmZDPhZhVHUBUXCuqEyun3rVsCRVc6kWB1e2wYsEZoTU/LaZlPqUejJY8cBS8IsuQqDtzdFtNiSq91vpfkiE6FXFJVjWorsybLvGoKiRqMixz2HRO8Mi037SWlzkOH9MYOT0u4qMHL0CZU7QtjbfsjmYXX2dmptu775df50GD+Nvs9tpMA9ugjA0c97czx7C+/EYGB7md1eT4BW+rucSBtNp2GJiuu+Jay/9a698oEs2++A9R72ZvdOeO/D33cHA18PLnsEdOI34a72et4n67flL9tk++tiC/16vw+Df0et2QYJUhGa5II19W/BVFzHRaZeFeoYN1rtsqSzk6HW9U9lgvcGuJ+oN9A3WMajNb0BrejVtDvBDXoPyJT6XqXeB6jl7QHXqlPTS2uaZjx1GOcbp2SW9G8FOXZRe6TsVFzUYfp6L0ktxIU5lDUTVzL7krMjOfmpn4/UNzzhb80uuXnmYM7mFzFAK4WyiSoDNwhOtcPR9wdaHVI02YBzomyhaYHrLOKmMqC5S6OA1YFZ73sjvebpV9XTYnAZya1cvSMxQ/h0LmYa59gSDFKIN8N7KMr2TR7HfIYp6hWSCuVRFmxD+sfY37BA5vQBwTVKURgTRs/19BMW+3SGKpjd8soy+nCH8EIRuhxDqhYNQPQI8V+HeTJ+6DTT1WoUGT6156EkyjjVg3m0UW3g3oT/3EwM+vX5wg595W76pXqIRqAbnv3RO5pTWH44u/YFuBBtolPer5u1YnT1G3BR9foGh+bFBAxgeUEH4KH4oJmxUCCGd/m8YTBtW0mVArVcb7nDGcnHEhuKPrgP7BAzFAKPfkqF4elHi5PeKDpMTTy8OTFgkXxg6YjsIrq/GPe8E7MAA5KAtO9DrA6duB12md57pKX0s3048UhvwJsPReHL8NmACsa2gydNz9JO3gQ7zY0/Pj+d43VpN48Mm8BOaIzcBA4ZeWyagp84helKvGm2+6OwYTv1Z8kc8Wvsvs/RNX9GYwtcmnhR7eq4+RmmEaVswvVUTPAC+nXcBu3ma7+y9OGPEqK3v0Dw9F4ftA4uTsKrJyHd740+0qvqdbO8ABE3B8W8gCJc/v51XbTuf1v8P'),
            this.addDataEntry(dt + 'business contact', 800, 270, 'Business Contacts',
                '7VnRbtowFP2aSNtDke0kBB4HlD6s1Sox7d0Qh1g4GDlugX39rpNAAw6MiSRlW4MQ8Y3t2Of4+lxfHHeYbB4UXcVPMmTCce8dd6ik1PldshkyIRyCeOi4I4cQBF+HjE88xdlTtKKKLfUlDUje4JWKF5ZbckOqt6IwxDqBYY2w4w7SmIZyDQUEhZCmMQuLAjxZmfrJZm7m0pnCDFINt51Yqke+ZKmppJVcsKEUUmVdu2F2wZOIC1GyR6H5gL0YHVOabU7OMDMV03tgMmFabaHKmoc6zmv0UI4Cihmfx0Uzv7DRNC/P903f8IKbArJq+FwLPlOMOBNhalBkgs00gFQzprOYzRZTubkY06VcQk8DKvh8CUXBIgBhIOiUiWeZcs2lMascnEG6ojO+nD9mtUbYjCWSSz0pxo8vJYZUE7MtFmbHz5uUiMKezdPOppigmr+yg9dVkVe88VlyGAhBu/EVXBVvvwsOO5BRlDJtcb8f9kXLwbOWwxNVi/wtBH37Wvc6UAqWF9RQE/7T1PDPLogKP8susK9jrtkEaDe9rKHr5ijuV7iii+qheOfSO46x3wDJ/lmSf3Bp5gD+9ME1waQ5skkrZHdPkp1V+9/8+rDBOearFLcm5u8wboP6wKL+OTYyWjfXOdWH9BZ6XSHhRohLTPezy5b2Qwn3r1kKJ8KrooF3SEWALlsKpIbgq2cR1GactUf+lO/VAO5RzIKR+0cR0zXg9ivAHbgAOfqEut3P8NsLwOtQF9wE9YN32QF/S8GRU2RBbN4f7lbHue14Sd/2kq5X4SVeDV6y2ytLTMpFU3TtAJ8BLkyV+HMv2eKAOr836PvBEVek4gBytA9er3jnCQzQIYP7Ta1EodvQPoexxeDgJTVnahN9sIRy8SFK59wNey2qEm4+pXJrshS0J0vYzrikTDoeoquVYJ2ZTG5Kicajce/eu2Elwt02pcjOj3yXUDaZT0V1/aF1Xap0P/4y9Ny/QJUqwu+qfEst+5ydB5kstquP89FZf9uHY61IkZ29aHp3tD3qfTSJeC1qkp0poIJtOkpOp9ubkqObPxjtY+hW5MhOIDR3Mio7iKVH/9LJiFQE2zWdjKD49s9ontEr/3H6Cw=='),
            this.addDataEntry(dt + 'experience', 800, 270, 'Experience',
                '7Vpdc6IwFP01PLYTCGh9Vbt9aWc7687sM5UomQbihFh1f/3e8GGFRBdbwH5Apw5ckpCcc8+98YqFJ9H2Tvir8IEHhFn41sITwbnMzqLthDBmOYgGFp5ajoPg33J+HLlrp3fRyhcklnU6OFmHF5+tSWbJDIncsdwQygimNbUtPE5CP+AbuEBwEfhJSIL8Au6sVPtou1RruX6CFSQSTq9DLu5pTBLVSAr+TCaccZEOjYP0gDsLytiBfRGoP7DnsyNCku3RFaamfHl3hEdEih002dBAhlmLG5ShgEJCl2HezcttfpJdL/ddX/GCkxwyM3xYg29GGJlLsC0oYUECJ5LDx3oV+JKkwPpynTQNshDqoXgsZvSvaoHPQjs9wO4zuozBxshCDcb8J8IeeUIl5cosMuzGycqf03h5n7aa2mpmCx7LWb4auy5vjpm3Xe63117W5YBH29VpLGyCMF/SF1J6nInb/ImPnMaKp2J+OZX506+G5QH4YpEQqbnGftq1vMXVvGWPbtP+kLlD2QViHpMK+4UJ6DtwiFF66A5RJt4DyyakkszArKaxgSe/U7N5BxeVyBgi3RNMinYaULTXekCspdU9Bce02gDKFZe3ET5LcO9BeWCImzGFRTroNl5CuiCibdi9N8FeUUQa97Lx7IE5NHYjkZEukYFrkIjbgESGGnn8uQuRFNjPASLwjxrhDZjzbsYjb1ihyjGkrEoM3DPeEn9DVCZwH9AOGMQtxbgbjcAJj1Z+vOvT0CmN2W6HeWj0SfJQS9BXc9Owu9xkIw363yRhPpgeuOSi9c3718pM9qDD1GTbfW5qITcZNuBt5SZbr0j84eIZXFd9pxY86nPUKbXto1cXOcrWyx8fM0k1n5Act8OEpNcNfs4lf+q/I52pDWzQhimONZKJahQSCiKkoH68VNZxQBUFWb0t4Ws1zSrOKD2OhawVERQmSw5Mb0fXPS2JErrGep2p7Go1Ua67wmVur3B5hEbqdbZepnBQscXoVXfMLUaXlJ1enPh8sht8c9np9YnXLaD6NaXfAJaS3CV3gHqZYrIW6dSBKlDEhckqSKn8dPUrR8HT+fS8CbptMTp6NxekqxijTnRkNEUwQ/pPPjnnJG0NwIOrezZDzc1UPGgEHb14MCVzEvUb7bNjUJcpv/DhD5Dya0H5v+3TV0/vhpcmYFfdeuXgk0vM8y4pMb0C8bElhr+5xPTiQ18Gf3cZ3LQXaagMDpev7/xlhB++EvgP'),
            this.addDataEntry(dt + 'skills', 800, 480, 'Skills',
                '7Zpbc6IwFMc/DY/tEAJeHtdbH7ad7Yw70+e0HCRjJE6I1e6n3wSi1Sa1WoV1R+jYIYfcOP+cH+Soh/uz1Z0g8/SBx8A8PPRwX3Auy7PZqg+MeYFPYw8PvCDw1ccLRp9cRcVVf04EZPKQBkHZ4JWwBZSW0pDLN2YMqZypaQ2Qh3t5SmK+VAVfFWKSpxCbgroy1/Vnq4m+l9tndQe5VKe3KRf3NINcV5KCT6HPGRdF1zguDnUloYxt2ZNY/ym7mR0ICatP77Awmdu7Az4DKd5UlSWNZVrW6PilF/wU6CQ1zSJjI3lZnmyavvtLnRiXud2HLfeNgcGLVLaEAotzdSK5+reYx0RC4VgiF/m5nSyEHhT3xJj+0TXwUd4uDmUnjE4yZWOQ6M4YeQb2yHMqKddmUfqul8/JC80m90WtAdIzS3gmx+Zu0KG6BW7d3sy6vY3KJls6otCWcW0TwIikr7AznEtbM+Ijp5nWaT0/I6UZ/aa92wFPkhyktTQ20z5otYTWankgYqpHKaoRvVp+/ax6bUTfisRlSiWMlfK6i6Xq90SVdxvs09wVu9g/i+g3yOBxIzuKKtA9qhyyB8V/tzj2xP8ptHWHEfLxUUF8CotblpeH2UQ9eUAoWP2ToPrS4R+AW1C07A+13KD9dhjuly3cDYOub6nWCh1hGJ7hEdq2ZOPTqtRa+/tFuQXE3njJeAa2clGn143aH6QKHA9AXXYpXpF+bX9XwA00txTEDgGDMwjYuV66teujW9fy8u+UZtNLQ9toMOoMwwtGG2rVyDbk26rp3YDe6oliP3ChnBuOfvRD/B9wrm2r2a2IcwhdLeiCsD7QITsl8cTFxYHu4t/hNs/7WkBnJ0Kat7iT6baRpoa3OGQnJ66FbhjVSDc7FzBmAPMGb0fiDTt2ONXhzc4tNHg7GW8Y1Yg3O81wNXjr1Ig3OxkwJLKB27Fwc2xrqoObnVpo4HY63Dr1wS2w0wzXArcwqg9ugZ0AeCKs2ZkeS7fQsa2pjG7rUGjodk66hVFldFPF95+/lF+2bv865i8='),
            this.addDataEntry(dt + 'chat', 400, 660, 'Chat',
                '7VpRc+I2EP4tfWD6BCPbmCOPCSTX6TTTm+ShzwIvWHOy5ZNkQvrru5JlDrDvoI2VGKZmQqy1JMv77bf+tMMgmmXbz5IW6aNIgA+i+0E0k0Lo6izbzoDzQUhYMojmgzAk+DcIH35wNbBXSUEl5PqcAWE1YEN5CZWlMij9yp0h1Rkuax4MojuV0kS8YINgI6EqhcQ18Eph+mfbtXmW0QKfQGk8HUlYatNBS/EVZoILaaeNqgOvrBjne/aVPdD+kjINzwVdmnlfcCq0udWC1LD94RNbk3vczyAy0PIVu7ywRKdVjzGpvEJSYOvUDZtMnJGqyrDejf3uQDxxPmz3Z9Q7f+7sbf6UoNjf8JfzTHCuh8P/5uHY2SRwqtkGDuZ/i9fHDa//LtIcLXdCNPxfuxanYIWChi9zkUNLWBLzQTunC+BfhGKaiRyvyer57ihna9PmsLL4oKNZvv7DtuaBGbkSuW6bcS8gzvJ+1O79V8f3UVwN2UMjagEj+rdguDt+EQwXEpJ6fe5u7u7Dul3PIFYrBboB5m7dZ+Ebe2dVqUCeGQk39jgXrHE7WNsjsH4CXtgCXtgNeMOAHKFHPKA3aaD3yJYpBdPnSSxYrpBInlnqWFmTtCatY+mT8+x70PRwwMeQdjh+D9Z+ulzWTv5n7bSBngkS8gyFhmyBfg9JSIKoc3nj9I18RmGCPeJzmZ+YT5O+O9w/Xv68lbwO7k8+uHrTQPs3hu2M5r/0BeF78kDmk5NKK37L1uE0stMWYMfd8Do8pHUQ+QC6zhV7SE8H0W2Mjr0NUKyQ28fOAW/bsbRgXJsOCZzYw9ldyNj39FEYeMQ8aGNzR8n8GHQv7A6CJr2xB+6NiE5Bwmg06gvL5zf384fpGVLNB88PB5yKgI5oPwyOY+DGSww0Sz0XTvw6Mj42CjoTdUdREPpJ/80C1bxkytym1GA65qU0/xMLhGnbZyskpJAnIJmujRvBy0JTO2oD3F4ApUxzyTgrs3oWY4ESv1blmlHTLS85pxUYaChlb7LPCY3xDvpil1X2Y2zq5V0Txl4irFmMu/A8c1UCI/KTVpoVuiegnOPwB9xAkBnNfzVrWmCegA1Y3WEywaxne4xT6uPdhUfoU3g0YsNPQmjW/y48IVy38Ij8yM9mNfA2T4wy2IBREzk1eoGzBUi7LYGssMrBZIil1RIK9YY2qiEXC6tYQFnJgaCgMjHVClFoJqr+30qTZHKWMruIrIDECpRvpemQocpR1eKsKbFpaMsyM6jgCKiVKSs8seqlEEqxzAwxyxFZbu/vBJCiSpUZLoHWa9rvZBVQb/JbT/XNLr67fdeNvZS1g2Zl9MLz2VUJnNgP6M0C6Z9fcdtC5ihzekPv3skXj9XS4S6mauC9KNvw6uql161eYi8F1LClgFqm/amavuG97jHrT/yx/xh1L5o1vLqS6VW96SddJHxsfv+1ZdV9/8eY/wA='),
            this.addDataEntry(dt + 'log in', 240, 220, 'Log in',
                '7ZhLj9owEIB/TY4gJ04CHAtst5W2EupW6tmQgVjrxMjx8uiv7zgxgZAAUZVsD60RUmbs8WO+mbESh86Sw7Ni2/ibjEA49MmhMyWlLp6SwwyEcDzCI4fOHc8j+He8zzd63byXbJmCVLcx8AqDHRPvUGhmMtVKmjELluKG8v5MH4Xtj3WCu5y7Dp1mMYvkHgWCQsSyGCIrYM/WjE8OG3O04RIPlGl8HCoFK9zZdM2FmEkhVT4rXecN9UzwTYq6FR4AsHOqXvkvM1VgpsWdvcGFGckb9uxAab5i4pM113Jrxm/ZiqebH0aYe2bcGk9nJ3T9k2wPZ460j7mGVzQzij1uGHXWRbgCHG66OVdZHz+DTECrIw7Z80jH1tV+gYLEwDexNTvxISwrFJvS9kwNHyy4Zoi0BvEpYbw3dHeJTPJ2B3ATgYtxUd4uAkHAWp9RvuTS3Cc3WCnIcO6f1utuW3reQ3rupIEetToFgmm+g8r8TUTtEgvJcWWPHKrTHAsxvAoJuV5noGsBUe6zVYz4tRjpOjwMqOm71jL94xiJzK+k+OXk6dYY6UOMtAuKbfMy6N3neZo3eLj05JWHS88XFmWeDGlbF/vNLrYGZBhUQrmULzMprCNwvU4SaTCurD4Ie0iksAZ1wbJsL1X00Vdlyxz7X28f1FuX9FFwR/9CwQ0/puBeYeyU07h3TttTfbhHplqQW5fjUT/lOOylHI97SLNJDd93SCBZ4ruDRxLomuUqhtXbUh4uMo42cQ3zdqd4C7YEsZAZ19zk71wV3r9fhoOrek46rLd+Qxj4nYTBiFbLrd9HHLikFggvcoOKr2lf9/LtkpvKFOrsg/F0EozqV/DdV6NHL6fdXsDHisHfuY4HQQfXMYrnjyjF8MtvLL8B'),
            this.addDataEntry(dt + 'log in', 240, 260, 'Log in',
                '7Vhtb5swEP41fJnUyJiXJB+b0HaVOilaJ+2zAw54NTgzbl7263cGE0ghadRCVWmjqorPd+Z8z/OcC5YzT3d3kqyTbyKi3HJuLGcuhVDlXbqbU84tjFhkOYGFMYJfC9+emLWLWbQmkmbqkgBcBmwIf6alZS4yJYX2WZAMEirmc7XnZj5RKWQZ2JYzyxMSiS0MEAwikic0MgOYWWv/dBfrrY2WsKFcwe1IShpCZrMV43wuuJDFqs6quMBOOIszsIWwAQqTM/nI/uilPL0sZPZEG2GouGBmQ6ViIeHXJlyJtfZfk5Bl8Q89CLD2W8HuzIK2W43N5vSWtglT9BHCtGELCYPNlAieQHcny1yYTI3vqEipkntw2bJIJabUbgkFSiiLExOGfWMkeWmID7E1anBjgOsG0WmBaGGf6yorsoStYRRCwJpEERSjcPB/P2uGzVB9a7xMyc541VyojGaT1zZAgTVO1Q5rS3MFPzZ/yxRlyxLpehgg60DDiGYqm7ZXyqJIb7nhVWNQGb0iq1ZK91koSn5q1ZTJLKvJm5QwXlkBkWWdNgI6dkQsSJ5vhYy6gw42vd22sVUVbSzRrOzDCPO03jKR0bZyb3FwE9waKTXswczD7hzsApSz4kU6OvSEyCTN4bk/DVT2pbLDr8rOnnbIrpKipJwotqFH63dJ0TxiIVim2WEScswy+3LovdCyWK1yqlpKPuR5kbjdlrh/iSSzXBRrQo5CkX48EwDeaXF1NPJI/3R02kqqnK5U3ZofilHgok9BC2cQWhRNsHdeeB1Nv18eaKRmz0qJ7M1kqE71EsavVakvxtF9FUenDxgvPWj9wWteHDIdFa5ldVzhQ+XLiINQRs6lJfa6S2wC0Mg74vJh3JSS34bAxr0o6Wpy9PQrfwAhjVugfjHX/8b6yRurO0RjnfwLjXX8uRrrdPCar6t/xs9V+biJXtxCJ8O0UH+QFjoZQDI2auH3naY0Xer3NZTSvsEMExo+LcWuIR+nC1i/uM7Ih5Ml5QuRM8W0GANZlv98T/VeNGH0zua5PwpossLtYIXbCyvGzjErxngIWtgtWjyIGAz32ccfrd1vr95kNvXG7bfXA0Pe8sGo37P1ND0+7qS96uPVFob1h83Svfnd8y8=')
        ];

        this.addPalette('bootstrap', mxResources.get('bootstrap'), false, mxUtils.bind(this, function (content) {
            for (var i = 0; i < fns.length; i++) {
                content.appendChild(fns[i](content));
            }
        }));
    };

})();

(function () {
    // Adds electrical stencils
    Sidebar.prototype.addElectricalPalette = function () {
        var s = mxConstants.STYLE_VERTICAL_LABEL_POSITION + '=bottom;shadow=0;dashed=0;align=center;fillColor=#ffffff;html=1;' + mxConstants.STYLE_VERTICAL_ALIGN + '=top;strokeWidth=1;' + mxConstants.STYLE_SHAPE;
        var mea = s + '=mxgraph.electrical.abstract.';
        var mec = 'pointerEvents=1;' + s + '=mxgraph.electrical.capacitors.';
        var med = 'pointerEvents=1;fillColor=#000000;' + s + '=mxgraph.electrical.diodes.';
        var mei = 'pointerEvents=1;' + s + '=mxgraph.electrical.inductors.';
        var mem = 'pointerEvents=1;' + s + '=mxgraph.electrical.miscellaneous.';
        var meem = 'pointerEvents=1;' + s + '=mxgraph.electrical.electro-mechanical.';
        var mel = s + '=mxgraph.electrical.logic_gates.';
        var mef1 = s + '=mxgraph.electrical.mosfets1.';
        var mef2 = s + '=mxgraph.electrical.mosfets2.';
        var met = s + '=mxgraph.electrical.transistors.';
        var meoe = s + '=mxgraph.electrical.opto_electronics.';
        var mep = 'pointerEvents=1;' + s + '=mxgraph.electrical.plc_ladder.';
        var mer = s + '=mxgraph.electrical.radio.';
        var mere = 'pointerEvents=1;' + s + '=mxgraph.electrical.resistors.';
        var mess = 'pointerEvents=1;' + s + '=mxgraph.electrical.signal_sources.';
        var metd = s + '=mxgraph.electrical.thermionic_devices.';
        var mew = 'pointerEvents=1;' + s + '=mxgraph.electrical.waveforms.';
        var mein = 'perimeter=ellipsePerimeter;' + s + '=mxgraph.electrical.instruments.';
        var meiecl = s + '=mxgraph.electrical.iec_logic_gates.';
        var merm = s + '=mxgraph.electrical.rot_mech.';
        var metr = s + '=mxgraph.electrical.transmission.';
        var gnmel = 'mxgraph.electrical.logic_gates';
        var dtmel = 'electrical logic gate ';
        var gnmeiecl = 'mxgraph.electrical.iec_logic_gates';
        var dtmeiecl = 'electrical iec logic gate ';
        var gnmere = 'mxgraph.electrical.resistors';
        var dtmere = 'electrical resistor ';
        var gnmec = 'mxgraph.electrical.capacitors';
        var dtmec = 'electrical capacitor ';
        var gnmei = 'mxgraph.electrical.inductors';
        var dtmei = 'electrical inductor ';
        var gnmeem = 'mxgraph.electrical.electro-mechanical';
        var dtmeem = 'electrical switch relay ';
        var gnmed = 'mxgraph.electrical.diodes';
        var dtmed = 'electrical diode ';
        var gnmess = 'mxgraph.electrical.signal_sources';
        var dtmess = 'electrical signal source ';
        var gnmet = 'mxgraph.electrical.transistors';
        var dtmet = 'electrical transistor ';
        var gnmein = 'mxgraph.electrical.instruments';
        var dtmein = 'electrical instrument ';
        var gnmer = 'mxgraph.electrical.radio';
        var dtmer = 'electrical radio audio ';
        var gnmem = 'mxgraph.electrical.miscellaneous';
        var dtmem = 'electrical ';
        var gnmea = 'mxgraph.electrical.abstract';
        var dtmea = 'electrical ';
        var gnmep = 'mxgraph.electrical.plc_ladder';
        var dtmep = 'electrical plc ladder programmable logic logical controller';
        var gnmeoe = 'mxgraph.electrical.opto_electronics';
        var dtmeoe = 'electrical optical ';
        var gnmetd = 'mxgraph.electrical.thermionic_devices';
        var dtmetd = 'electrical thermionic thermo device vacuum tube ';
        var gnmew = 'mxgraph.electrical.waveforms';
        var dtmew = 'electrical waveform signal ';
        var gnmerm = 'mxgraph.electrical.rot_mech';
        var dtmerm = 'electrical rotating equipment mechanical function functions';
        var gnmetr = 'mxgraph.electrical.transmission';
        var dtmetr = 'electrical transmission paths bus buses';

        this.addPaletteFunctions('electrical\LogicGates', 'Electrical / Logic Gates', false,
            [
                this.createVertexTemplateEntry(mel + 'logic_gate;operation=and;', 100, 60, '', 'AND', null, null, this.getTagsForStencil(gnmel, 'and', dtmel).join(' ')),
                this.createVertexTemplateEntry(mel + 'buffer2;', 100, 60, '', 'Buffer', null, null, this.getTagsForStencil(gnmel, 'buffer', dtmel).join(' ')),
                this.createVertexTemplateEntry(mel + 'd_type_flip-flop;', 100, 80, '', 'D Type Flip-Flop', null, null, this.getTagsForStencil(gnmel, 'd_type_flip-flop', dtmel).join(' ')),
                this.createVertexTemplateEntry(mel + 'd_type_flip-flop_with_clear;', 100, 90, '', 'D Type Flip-Flop With Clear', null, null, this.getTagsForStencil(gnmel, 'd_type_flip-flop_with_clear', dtmel).join(' ')),
                this.createVertexTemplateEntry(mel + 'd_type_rs_flip-flop;', 100, 100, '', 'D Type RS Flip-Flop', null, null, this.getTagsForStencil(gnmel, 'd_type_rs_flip-flop', dtmel).join(' ')),
                this.createVertexTemplateEntry(mel + 'buffer2;negating=1;', 100, 60, '', 'Inverter', null, null, this.getTagsForStencil(gnmel, 'inverter', dtmel).join(' ')),
                this.createVertexTemplateEntry(mel + 'inverting_contact;', 5, 5, '', 'Inverting Contact', null, null, this.getTagsForStencil(gnmel, 'inverting_contact', dtmel).join(' ')),
                this.createVertexTemplateEntry(mel + 'jk_flip-flop;', 100, 80, '', 'JK Flip-Flop', null, null, this.getTagsForStencil(gnmel, 'jk_flip-flop', dtmel).join(' ')),
                this.createVertexTemplateEntry(mel + 'jk_flip-flop_with_clear;', 100, 90, '', 'JK Flip-Flop With Clear', null, null, this.getTagsForStencil(gnmel, 'jk_flip-flop_with_clear', dtmel).join(' ')),
                this.createVertexTemplateEntry(mel + 'jk_flip-flop_with_sr;', 100, 100, '', 'JK Flip-Flop With SR', null, null, this.getTagsForStencil(gnmel, 'jk_flip-flop_with_sr', dtmel).join(' ')),
                this.createVertexTemplateEntry(mel + 'logic_gate;operation=and;negating=1;', 100, 60, '', 'NAND', null, null, this.getTagsForStencil(gnmel, 'nand not and', dtmel).join(' ')),
                this.createVertexTemplateEntry(mel + 'logic_gate;operation=or;', 100, 60, '', 'OR', null, null, this.getTagsForStencil(gnmel, 'or', dtmel).join(' ')),
                this.createVertexTemplateEntry(mel + 'logic_gate;operation=or;negating=1;', 100, 60, '', 'NOR', null, null, this.getTagsForStencil(gnmel, 'nor', dtmel).join(' ')),
                this.createVertexTemplateEntry(mel + 'rs_latch;', 100, 80, '', 'RS Latch', null, null, this.getTagsForStencil(gnmel, 'rs_latch', dtmel).join(' ')),
                this.createVertexTemplateEntry(mel + 'synchronous_rs_latch;', 100, 80, '', 'RS Latch (Synchronous)', null, null, this.getTagsForStencil(gnmel, 'synchronous_rs_latch', dtmel).join(' ')),
                this.createVertexTemplateEntry(mel + 'schmitt_trigger;', 100, 60, '', 'Schmitt Trigger', null, null, this.getTagsForStencil(gnmel, 'schmitt_trigger', dtmel).join(' ')),
                this.createVertexTemplateEntry(mel + 't_type_flip-flop;', 100, 80, '', 'T Type Flip-Flop', null, null, this.getTagsForStencil(gnmel, 't_type_flip-flop', dtmel).join(' ')),
                this.createVertexTemplateEntry(mel + 'logic_gate;operation=xor;', 100, 60, '', 'XOR', null, null, this.getTagsForStencil(gnmel, 'xor', dtmel).join(' ')),
                this.createVertexTemplateEntry(mel + 'logic_gate;operation=xor;negating=1;', 100, 60, '', 'XNOR', null, null, this.getTagsForStencil(gnmel, 'xnor', dtmel).join(' ')),
                this.createVertexTemplateEntry(meiecl + 'and;', 60, 80, '', 'AND (IEC)', null, null, this.getTagsForStencil(gnmeiecl, 'and', dtmeiecl).join(' ')),
                this.createVertexTemplateEntry(meiecl + 'nand;', 66, 80, '', 'NAND (IEC)', null, null, this.getTagsForStencil(gnmeiecl, 'nand', dtmeiecl).join(' ')),
                this.createVertexTemplateEntry(meiecl + 'or;', 60, 80, '', 'OR (IEC)', null, null, this.getTagsForStencil(gnmeiecl, 'or', dtmeiecl).join(' ')),
                this.createVertexTemplateEntry(meiecl + 'nor;', 66, 80, '', 'NOR (IEC)', null, null, this.getTagsForStencil(gnmeiecl, 'nor', dtmeiecl).join(' ')),
                this.createVertexTemplateEntry(meiecl + 'not;', 66, 80, '', 'NOT (IEC)', null, null, this.getTagsForStencil(gnmeiecl, 'xor', dtmeiecl).join(' ')),
                this.createVertexTemplateEntry(meiecl + 'xor;', 60, 80, '', 'XOR (IEC)', null, null, this.getTagsForStencil(gnmeiecl, 'xor', dtmeiecl).join(' ')),
                this.createVertexTemplateEntry(
                    'shadow=0;dashed=0;align=center;fillColor=#ffffff;html=1;strokeWidth=1;shape=mxgraph.electrical.logic_gates.dual_inline_ic;labelNames=a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t;',
                    100, 200, 'IC', 'Dual In-Line IC', null, null, this.getTagsForStencil(gnmel, 'dual inline in line ic integrated circuit', dtmel).join(' ')),
                this.createVertexTemplateEntry(
                    'shadow=0;dashed=0;align=center;fillColor=#ffffff;html=1;strokeWidth=1;shape=mxgraph.electrical.logic_gates.qfp_ic;' +
                    'labelNames=a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,a1,b1,c1,d1,e1,f1,g1,h1,i1,j1,k1,l1,m1,n1;',
                    200, 200, 'IC', 'Quad Flat Package IC', null, null, this.getTagsForStencil(gnmel, 'quad flat package qfp ic integrated circuit', dtmel).join(' '))
            ]);

        this.addPaletteFunctions('electrical\Resistors', 'Electrical / Resistors', false,
            [
                this.createVertexTemplateEntry(mere + 'resistor_1;',
                    100, 20, '', 'Resistor', null, null, this.getTagsForStencil(gnmere, 'resistor_1', dtmere).join(' ')),
                this.createVertexTemplateEntry(mere + 'resistor_2;',
                    100, 20, '', 'Resistor', null, null, this.getTagsForStencil(gnmere, 'resistor_2', dtmere).join(' ')),
                this.createVertexTemplateEntry(mere + 'potentiometer_1;',
                    100, 40, '', 'Potentiometer', null, null, this.getTagsForStencil(gnmere, 'potentiometer_1', dtmere).join(' ')),
                this.createVertexTemplateEntry(mere + 'potentiometer_2;',
                    100, 40, '', 'Potentiometer', null, null, this.getTagsForStencil(gnmere, 'potentiometer_2', dtmere).join(' ')),
                this.createVertexTemplateEntry(mere + 'trimmer_pot_1;',
                    100, 40, '', 'Potentiometer (Trimmer)', null, null, this.getTagsForStencil(gnmere, 'trimmer_pot_1', dtmere).join(' ')),
                this.createVertexTemplateEntry(mere + 'trimmer_pot_2;',
                    100, 40, '', 'Potentiometer (Trimmer)', null, null, this.getTagsForStencil(gnmere, 'trimmer_pot_2', dtmere).join(' ')),
                this.createVertexTemplateEntry(mere + 'trimmer_resistor_1;',
                    100, 65.5, '', 'Resistor (Trimmer)', null, null, this.getTagsForStencil(gnmere, 'trimmer_resistor_1', dtmere).join(' ')),
                this.createVertexTemplateEntry(mere + 'trimmer_resistor_2;',
                    100, 65.5, '', 'Resistor (Trimmer)', null, null, this.getTagsForStencil(gnmere, 'trimmer_resistor_2', dtmere).join(' ')),
                this.createVertexTemplateEntry(mere + 'variable_resistor_1;',
                    100, 60, '', 'Resistor (Variable)', null, null, this.getTagsForStencil(gnmere, 'variable_resistor_1', dtmere).join(' ')),
                this.createVertexTemplateEntry(mere + 'variable_resistor_2;',
                    100, 60, '', 'Resistor (Variable)', null, null, this.getTagsForStencil(gnmere, 'variable_resistor_2', dtmere).join(' ')),
                this.createVertexTemplateEntry(mere + 'resistor_with_instrument_or_relay_shunt;',
                    100, 20, '', 'Resistor (Instrument/Relay Shunt)', null, null, this.getTagsForStencil(gnmere, 'resistor_with_instrument_or_relay_shunt', dtmere).join(' ')),
                this.createVertexTemplateEntry(mere + 'attenuator;',
                    100, 60, '', 'Attenuator', null, null, this.getTagsForStencil(gnmere, 'attenuator', dtmere).join(' ')),
                this.createVertexTemplateEntry(mere + 'resistor,_adjustable_contact;',
                    100, 40, '', 'Resistor (Adjustable Contact)', null, null, this.getTagsForStencil(gnmere, 'resistor,_adjustable_contact', dtmere).join(' ')),
                this.createVertexTemplateEntry(mere + 'resistor,_shunt;',
                    100, 45, '', 'Resistor (Shunt)', null, null, this.getTagsForStencil(gnmere, 'resistor,_shunt', dtmere).join(' ')),
                this.createVertexTemplateEntry(mere + 'symmetrical_varistor;',
                    100, 60, '', 'Varistor (Symmetrical)', null, null, this.getTagsForStencil(gnmere, 'symmetrical_varistor', dtmere).join(' ')),
                this.createVertexTemplateEntry(mere + 'tapped_resistor;',
                    100, 40, '', 'Resistor (Tapped)', null, null, this.getTagsForStencil(gnmere, 'tapped_resistor', dtmere).join(' ')),
                this.createVertexTemplateEntry(mere + 'nonlinear_resistor;',
                    100, 60, '', 'Resistor (Nonlinear)', null, null, this.getTagsForStencil(gnmere, 'nonlinear_resistor', dtmere).join(' ')),
                this.createVertexTemplateEntry(mere + 'memristor_1;',
                    100, 20, '', 'Memristor', null, null, this.getTagsForStencil(gnmere, 'memristor_1', dtmere).join(' ')),
                this.createVertexTemplateEntry(mere + 'memristor_2;',
                    100, 24, '', 'Memristor', null, null, this.getTagsForStencil(gnmere, 'memristor_2', dtmere).join(' ')),
                this.createVertexTemplateEntry(mere + 'magnetoresistor;',
                    100, 60, '', 'Magnetoresistor', null, null, this.getTagsForStencil(gnmere, 'magnetoresistor', dtmere).join(' ')),
                this.createVertexTemplateEntry(mere + 'symmetrical_photoconductive_transducer;',
                    100, 40, '', 'Photoconductive Transducer (Symmetrical)', null, null, this.getTagsForStencil(gnmere, 'symmetrical_photoconductive_transducer', dtmere).join(' '))
            ]);

        this.addPaletteFunctions('electrical\Capacitors', 'Electrical / Capacitors', false,
            [
                this.createVertexTemplateEntry(mec + 'capacitor_1;',
                    100, 60, '', 'Capacitor (US)', null, null, this.getTagsForStencil(gnmec, 'capacitor_1', dtmec).join(' ')),
                this.createVertexTemplateEntry(mec + 'capacitor_2;',
                    100, 60, '', 'Capacitor (US)', null, null, this.getTagsForStencil(gnmec, 'capacitor_2', dtmec).join(' ')),
                this.createVertexTemplateEntry(mec + 'capacitor_3;',
                    100, 60, '', 'Electrolytic Capacitor (US)', null, null, this.getTagsForStencil(gnmec, 'capacitor_3', dtmec).join(' ')),
                this.createVertexTemplateEntry(mec + 'capacitor_4;',
                    100, 60, '', 'Capacitor (UK)', null, null, this.getTagsForStencil(gnmec, 'capacitor_4', dtmec).join(' ')),
                this.createVertexTemplateEntry(mec + 'capacitor_5;',
                    100, 60, '', 'Electrolytic Capacitor (US)', null, null, this.getTagsForStencil(gnmec, 'capacitor_5', dtmec).join(' ')),
                this.createVertexTemplateEntry(mec + 'capacitor_6;',
                    100, 60, '', 'Capacitor', null, null, this.getTagsForStencil(gnmec, 'capacitor_6', dtmec).join(' ')),
                this.createVertexTemplateEntry(mec + 'differential_capacitor;',
                    100, 80, '', 'Differential Capacitor', null, null, this.getTagsForStencil(gnmec, 'differential_capacitor', dtmec).join(' ')),
                this.createVertexTemplateEntry(mec + 'trimmer_capacitor_1;',
                    100, 65.5, '', 'Tuning Variable Capacitor (US)', null, null, this.getTagsForStencil(gnmec, 'trimmer_capacitor_1', dtmec).join(' ')),
                this.createVertexTemplateEntry(mec + 'trimmer_capacitor_2;',
                    100, 65.5, '', 'Tuning Variable Capacitor (US)', null, null, this.getTagsForStencil(gnmec, 'trimmer_capacitor_2', dtmec).join(' ')),
                this.createVertexTemplateEntry(mec + 'variable_capacitor_1;',
                    100, 60, '', 'Trimmer Variable Capacitor (US)', null, null, this.getTagsForStencil(gnmec, 'variable_capacitor_1', dtmec).join(' ')),
                this.createVertexTemplateEntry(mec + 'variable_capacitor_2;',
                    100, 60, '', 'Trimmer Variable Capacitor (US)', null, null, this.getTagsForStencil(gnmec, 'variable_capacitor_2', dtmec).join(' ')),
                this.createVertexTemplateEntry(mec + 'feed_through_capacitor;',
                    100, 90, '', 'Feed Through Capacitor', null, null, this.getTagsForStencil(gnmec, 'feed_through_capacitor', dtmec).join(' ')),
                this.createVertexTemplateEntry(mec + 'ganged_capacitor;',
                    100, 130, '', 'Ganged Capacitor', null, null, this.getTagsForStencil(gnmec, 'ganged_capacitor', dtmec).join(' ')),
                this.createVertexTemplateEntry(mec + 'multiple_capacitor;',
                    100, 130, '', 'Multiple Capacitor', null, null, this.getTagsForStencil(gnmec, 'multiple_capacitor', dtmec).join(' ')),
                this.createVertexTemplateEntry(mec + 'multiple_electrolytic_capacitor_comm_neg;',
                    100, 130, '', 'Multiple Electrolytic Capacitor (Common Negative)', null, null, this.getTagsForStencil(gnmec, 'multiple_electrolytic_capacitor_comm_neg', dtmec).join(' ')),
                this.createVertexTemplateEntry(mec + 'multiple_electrolytic_capacitor_comm_pos;',
                    100, 130, '', 'Multiple Electrolytic Capacitor (Common Positive)', null, null, this.getTagsForStencil(gnmec, 'multiple_electrolytic_capacitor_comm_pos', dtmec).join(' '))
            ]);

        this.addPaletteFunctions('electrical\Inductors', 'Electrical / Inductors', false,
            [
                this.createVertexTemplateEntry(mei + 'inductor_3;',
                    100, 8, '', 'Inductor (Air Core)', null, null, this.getTagsForStencil(gnmei, 'inductor_3', dtmei).join(' ')),
                this.createVertexTemplateEntry(mei + 'inductor_5;',
                    100, 14, '', 'Inductor (Air Core)', null, null, this.getTagsForStencil(gnmei, 'inductor_5', dtmei).join(' ')),
                this.createVertexTemplateEntry(mei + 'inductor_1;',
                    100, 15, '', 'Inductor (Air Core)', null, null, this.getTagsForStencil(gnmei, 'inductor_1', dtmei).join(' ')),
                this.createVertexTemplateEntry(mei + 'variable_inductor;',
                    100, 60, '', 'Variable', null, null, this.getTagsForStencil(gnmei, 'variable_inductor', dtmei).join(' ')),
                this.createVertexTemplateEntry(mei + 'ferrite_core;',
                    64, 4, '', 'Ferrite Core', null, null, this.getTagsForStencil(gnmei, 'ferrite_core', dtmei).join(' ')),
                this.createVertexTemplateEntry(mei + 'iron_core;',
                    64, 4, '', 'Iron Core', null, null, this.getTagsForStencil(gnmei, 'iron_core', dtmei).join(' ')),
                this.createVertexTemplateEntry(mei + 'magnetic_core;direction=north;',
                    64, 3, '', 'Magnetic Core', null, null, this.getTagsForStencil(gnmei, 'magnetic core', dtmei).join(' ')),
                this.createVertexTemplateEntry(mei + 'transformer_1;',
                    64, 60, '', 'Transformer (Iron Core)', null, null, this.getTagsForStencil(gnmei, 'transformer_1', dtmei).join(' ')),
                this.createVertexTemplateEntry(mei + 'transformer_2;',
                    64, 60, '', 'Transformer (Iron Core)', null, null, this.getTagsForStencil(gnmei, 'transformer_2', dtmei).join(' ')),
                this.createVertexTemplateEntry(mei + 'half_inductor;',
                    32, 23, '', 'Half Inductor', null, null, this.getTagsForStencil(gnmei, 'half inductor', dtmei).join(' ')),
                this.createVertexTemplateEntry(mei + 'transformer;direction=north;',
                    64, 64, '', 'Transformer', null, null, this.getTagsForStencil(gnmei, 'transformer', dtmei).join(' ')),
                this.createVertexTemplateEntry(mei + 'inductor;',
                    100, 42, '', 'Inductor', null, null, this.getTagsForStencil(gnmei, 'inductor', dtmei).join(' ')),
                this.createVertexTemplateEntry(mei + 'choke;',
                    100, 200, '', 'Choke', null, null, this.getTagsForStencil(gnmei, 'choke', dtmei).join(' ')),
                this.createVertexTemplateEntry('verticalLabelPosition=top;shadow=0;dashed=0;align=center;fillColor=#000000;strokeColor=#000000;html=1;verticalAlign=bottom;strokeWidth=1;shape=mxgraph.electrical.inductors.variometer;',
                    150, 88, '', 'Variometer', null, null, this.getTagsForStencil(gnmei, 'variometer', dtmei).join(' ')),
                this.createVertexTemplateEntry(mei + 'coaxial_choke;',
                    300, 50, '', 'Coaxial Choke', null, null, this.getTagsForStencil(gnmei, 'coaxial choke', dtmei).join(' ')),
                this.createVertexTemplateEntry(mei + 'transductor;',
                    200, 100, '', 'Transductor', null, null, this.getTagsForStencil(gnmei, 'transductor', dtmei).join(' ')),
                this.createVertexTemplateEntry(mei + 'saturating_transformer;',
                    200, 150, '', 'Saturating Transformer', null, null, this.getTagsForStencil(gnmei, 'saturating_transformer', dtmei).join(' ')),
                this.createVertexTemplateEntry(mei + 'potential_transformer_2;',
                    92, 40, '', 'Potential Transformer', null, null, this.getTagsForStencil(gnmei, 'potential transformer', dtmei).join(' ')),
                this.createVertexTemplateEntry(mei + 'pot_trans_3_windings;',
                    67, 96, '', 'Pot. Trans. 3 Windings', null, null, this.getTagsForStencil(gnmei, 'potential transformer 3 three windings', dtmei).join(' ')),
                this.createVertexTemplateEntry('verticalLabelPosition=bottom;shadow=0;dashed=0;align=center;fillColor=#ffffff;strokeColor=#000000;html=1;verticalAlign=top;strokeWidth=1;shape=mxgraph.electrical.signal_sources.current_source;',
                    40, 60, '', 'Transformer', null, null, this.getTagsForStencil(gnmei, '', dtmei).join(' ')),
                this.createVertexTemplateEntry(mei + 'adjustable_transformer;',
                    46, 60, '', 'Adjustable Transformer', null, null, this.getTagsForStencil(gnmei, 'adjustable_transformer', dtmei).join(' ')),
                this.createVertexTemplateEntry(mei + '1_phase_induction_volt_reg;',
                    100, 100, '', '1-Phase Induction Voltage Regulator', null, null, this.getTagsForStencil(gnmei, '1 phase induction voltage regulator monophase', dtmei).join(' ')),
                this.createVertexTemplateEntry(mei + 'triplex_induction_volt_reg;',
                    100, 100, '', 'Triplex Induction Voltage Regulator', null, null, this.getTagsForStencil(gnmei, 'triplex induction voltage regulator', dtmei).join(' ')),
                this.createVertexTemplateEntry(mei + 'induction_voltage_regulator;',
                    160, 210, '', 'Induction Voltage Regulator', null, null, this.getTagsForStencil(gnmei, 'induction voltage regulator', dtmei).join(' ')),
                this.createVertexTemplateEntry(mei + 'current_transformer_1;',
                    12, 75, '', 'Current Transformer', null, null, this.getTagsForStencil(gnmei, 'current transformer', dtmei).join(' ')),
                this.createVertexTemplateEntry(mei + 'current_transformer_2;',
                    125, 175, '', 'Current Transformer', null, null, this.getTagsForStencil(gnmei, 'current transformer', dtmei).join(' ')),
                this.createVertexTemplateEntry(mei + 'current_transformer_3;',
                    75, 10, '', 'Current Transformer', null, null, this.getTagsForStencil(gnmei, 'current transformer', dtmei).join(' ')),
                this.createVertexTemplateEntry(mei + 'potential_transformer;',
                    100, 50, '', 'Potential Transformer', null, null, this.getTagsForStencil(gnmei, 'potential transformer', dtmei).join(' ')),
                this.createVertexTemplateEntry(mei + 'outdoor_metering_device;',
                    100, 100, '', 'Outdoor Metering Device', null, null, this.getTagsForStencil(gnmei, 'outdoor metering device', dtmei).join(' ')),
                this.createVertexTemplateEntry(mei + 'linear_coupler;',
                    80, 20, '', 'Linear Coupler', null, null, this.getTagsForStencil(gnmei, 'linear coupler', dtmei).join(' '))
            ]);

        this.addPaletteFunctions('electrical\SwitchesRelays', 'Electrical / Switches and Relays', false,
            [
                this.createVertexTemplateEntry(meem + '2-way_switch;',
                    75, 26, '', 'SPDT', null, null, this.getTagsForStencil(gnmeem, '2-way switch', dtmeem).join(' ')),
                this.createVertexTemplateEntry(meem + 'push_switch_nc;',
                    75, 10, '', 'Pushbutton NC', null, null, this.getTagsForStencil(gnmeem, 'push switch nc', dtmeem).join(' ')),
                this.createVertexTemplateEntry(meem + 'push_switch_no;',
                    75, 19, '', 'Pushbutton NO', null, null, this.getTagsForStencil(gnmeem, 'push switch no', dtmeem).join(' ')),
                this.createVertexTemplateEntry(meem + 'simple_switch;',
                    75, 19, '', 'SPST', null, null, this.getTagsForStencil(gnmeem, 'simple switch', dtmeem).join(' ')),
                this.createVertexTemplateEntry(meem + 'switch_disconnector;',
                    75, 19, '', 'Switch Disconnector', null, null, this.getTagsForStencil(gnmeem, 'switch disconnector', dtmeem).join(' ')),
                this.createVertexTemplateEntry(meem + 'fuse;',
                    75, 16, '', 'Fuse', null, null, this.getTagsForStencil(gnmeem, 'fuse', dtmeem).join(' ')),
                this.createVertexTemplateEntry(meem + 'liquid_level_actuated;',
                    75, 28, '', 'Liquid Level Actuated', null, null, this.getTagsForStencil(gnmeem, 'liquid level actuated', dtmeem).join(' ')),
                this.createVertexTemplateEntry(meem + 'liquid_level_actuated_2;',
                    75, 32, '', 'Liquid Level Actuated', null, null, this.getTagsForStencil(gnmeem, 'liquid level actuated', dtmeem).join(' ')),
                this.createVertexTemplateEntry(meem + 'gas_flow_actuated;',
                    75, 32, '', 'Gas Flow Actuated', null, null, this.getTagsForStencil(gnmeem, 'gas flow actuated', dtmeem).join(' ')),
                this.createVertexTemplateEntry(meem + 'flow_actuated;',
                    75, 31, '', 'Flow Actuated', null, null, this.getTagsForStencil(gnmeem, 'flow actuated', dtmeem).join(' ')),
                this.createVertexTemplateEntry(meem + 'pressure_actuated;',
                    75, 31, '', 'Pressure Actuated', null, null, this.getTagsForStencil(gnmeem, 'pressure actuated', dtmeem).join(' ')),
                this.createVertexTemplateEntry(meem + 'temperature_actuated;',
                    75, 31, '', 'Temperature Actuated', null, null, this.getTagsForStencil(gnmeem, 'temperature actuated', dtmeem).join(' ')),
                this.createVertexTemplateEntry(meem + 'safety_interlock;',
                    75, 37, '', 'Safety Interlock', null, null, this.getTagsForStencil(gnmeem, 'safety interlock', dtmeem).join(' ')),
                this.createVertexTemplateEntry(meem + 'temperature_switch;',
                    75, 18, '', 'Temperature Switch', null, null, this.getTagsForStencil(gnmeem, 'temperature switch', dtmeem).join(' ')),
                this.createVertexTemplateEntry('verticalLabelPosition=top;shadow=0;dashed=0;align=center;fillColor=#ffffff;strokeColor=#000000;html=1;verticalAlign=bottom;strokeWidth=1;shape=mxgraph.electrical.electro-mechanical.thermostat;fontColor=#000000;fontSize=10;',
                    75, 7, 'tº', 'Thermostat', null, null, this.getTagsForStencil(gnmeem, 'thermostat', dtmeem).join(' ')),
                this.createVertexTemplateEntry(meem + 'limit_switch;',
                    75, 16, '', 'Limit Switch', null, null, this.getTagsForStencil(gnmeem, 'limit switch', dtmeem).join(' ')),
                this.createVertexTemplateEntry(meem + 'circuit_breaker;',
                    75, 20, '', 'Circuit Breaker', null, null, this.getTagsForStencil(gnmeem, 'circuit breaker', dtmeem).join(' ')),
                this.createVertexTemplateEntry(meem + 'selector_switch;',
                    75, 66, '', 'Selector Switch', null, null, this.getTagsForStencil(gnmeem, 'selector_switch', dtmeem).join(' ')),
                this.createVertexTemplateEntry(meem + 'shorting_selector;',
                    60, 66, '', 'Shorting Selector', null, null, this.getTagsForStencil(gnmeem, 'shorting selector', dtmeem).join(' ')),
                this.createVertexTemplateEntry(meem + 'proximity_limit_switch;',
                    75, 55, '', 'Proximity Limit Switch', null, null, this.getTagsForStencil(gnmeem, 'proximity limit switch', dtmeem).join(' ')),
                this.createVertexTemplateEntry(meem + 'inertia_switch;',
                    75, 19, '', 'Inertia Switch', null, null, this.getTagsForStencil(gnmeem, 'inertia switch', dtmeem).join(' ')),
                this.createVertexTemplateEntry(meem + 'pushbutton_break;',
                    75, 54, '', 'Pushbutton Break', null, null, this.getTagsForStencil(gnmeem, 'pushbutton break', dtmeem).join(' ')),
                this.createVertexTemplateEntry(meem + 'manual_switch;',
                    75, 18, '', 'Manual Switch', null, null, this.getTagsForStencil(gnmeem, 'manual switch', dtmeem).join(' ')),
                this.createVertexTemplateEntry(meem + 'make_contact;',
                    75, 16, '', 'Make Contact', null, null, this.getTagsForStencil(gnmeem, 'make contact', dtmeem).join(' ')),
                this.createVertexTemplateEntry(meem + 'break_contact;',
                    75, 10, '', 'Break Contact', null, null, this.getTagsForStencil(gnmeem, 'break contact', dtmeem).join(' ')),
                this.createVertexTemplateEntry(meem + 'two_way_contact;',
                    75, 30, '', 'Two Way Contact', null, null, this.getTagsForStencil(gnmeem, 'two way contact', dtmeem).join(' ')),
                this.createVertexTemplateEntry(meem + 'passing_make_contact;',
                    75, 23, '', 'Passing Make-Contact', null, null, this.getTagsForStencil(gnmeem, 'passing make contact', dtmeem).join(' ')),
                this.createVertexTemplateEntry(meem + 'stay_put;',
                    75, 7, '', 'Stay Put', null, null, this.getTagsForStencil(gnmeem, 'stay put', dtmeem).join(' ')),
                this.createVertexTemplateEntry(meem + 'dpst;',
                    75, 26, '', 'DPST', null, null, this.getTagsForStencil(gnmeem, 'dpst', dtmeem).join(' ')),
                this.createVertexTemplateEntry(meem + 'spring_return;',
                    75, 10, '', 'Spring Return', null, null, this.getTagsForStencil(gnmeem, 'spring return', dtmeem).join(' ')),
                this.createVertexTemplateEntry(meem + 'spring_return_2;',
                    75, 19, '', 'Spring Return', null, null, this.getTagsForStencil(gnmeem, 'spring return', dtmeem).join(' ')),
                this.createVertexTemplateEntry(meem + 'limit_switch_no;',
                    75, 24, '', 'Limit Switch NO', null, null, this.getTagsForStencil(gnmeem, 'limit switch no normally open', dtmeem).join(' ')),
                this.createVertexTemplateEntry(meem + 'limit_switch_nc;',
                    75, 13, '', 'Limit Switch NC', null, null, this.getTagsForStencil(gnmeem, 'limit switch nc normally closed', dtmeem).join(' ')),
                this.createVertexTemplateEntry(meem + 'dpdt2;',
                    58, 62, '', 'DPDT', null, null, this.getTagsForStencil(gnmeem, 'dpdt', dtmeem).join(' ')),
                this.createVertexTemplateEntry(meem + '2_position_switch;',
                    75, 70, '', '2-Position Switch', null, null, this.getTagsForStencil(gnmeem, '2 position switch', dtmeem).join(' ')),
                this.createVertexTemplateEntry(meem + '3_position_switch;',
                    60, 60, '', '3-Position Switch', null, null, this.getTagsForStencil(gnmeem, '3 position switch', dtmeem).join(' ')),
                this.createVertexTemplateEntry(meem + '4_position_switch;',
                    75, 70, '', '4-Position Switch', null, null, this.getTagsForStencil(gnmeem, '4 position switch', dtmeem).join(' ')),
                this.createVertexTemplateEntry(meem + 'pushbutton_make;',
                    75, 53, '', 'Pushbutton Make', null, null, this.getTagsForStencil(gnmeem, 'pushbutton make', dtmeem).join(' ')),
                this.createVertexTemplateEntry(meem + 'pushbutton_2_circuit;',
                    75, 73, '', 'Pushbutton 2-Circuit', null, null, this.getTagsForStencil(gnmeem, 'pushbutton 2 circuit', dtmeem).join(' ')),
                this.createVertexTemplateEntry(meem + 'time_delay_make;',
                    75, 31, '', 'Time Delay Make', null, null, this.getTagsForStencil(gnmeem, 'time delay make', dtmeem).join(' ')),
                this.createVertexTemplateEntry(meem + 'time_delay_break;',
                    75, 32, '', 'Time Delay Break', null, null, this.getTagsForStencil(gnmeem, 'time delay break', dtmeem).join(' ')),
                this.createVertexTemplateEntry(meem + 'time_delay_make_2;',
                    75, 36, '', 'Time Delay Make', null, null, this.getTagsForStencil(gnmeem, 'time delay make', dtmeem).join(' ')),
                this.createVertexTemplateEntry(meem + 'time_delay_break_2;',
                    75, 30, '', 'Time Delay Break', null, null, this.getTagsForStencil(gnmeem, 'time delay break', dtmeem).join(' ')),
                this.createVertexTemplateEntry(meem + 'isolator;',
                    75, 20, '', 'Isolator', null, null, this.getTagsForStencil(gnmeem, 'isolator', dtmeem).join(' ')),
                this.createVertexTemplateEntry(meem + 'changeover_contact;',
                    75, 20, '', 'Changeover Contact', null, null, this.getTagsForStencil(gnmeem, 'changeover contact', dtmeem).join(' ')),
                this.createVertexTemplateEntry(meem + 'reed_switch;',
                    75, 20, '', 'Reed Switch', null, null, this.getTagsForStencil(gnmeem, 'reed switch', dtmeem).join(' ')),
                this.createVertexTemplateEntry(meem + 'relay_coil;',
                    70, 35, '', 'Relay Coil', null, null, this.getTagsForStencil(gnmeem, 'relay coil', dtmeem).join(' ')),
                this.createVertexTemplateEntry(meem + 'relay;',
                    100, 50, '', 'Relay', null, null, this.getTagsForStencil(gnmeem, 'relay', dtmeem).join(' ')),
                this.createVertexTemplateEntry(meem + 'relay_contacts;',
                    30, 24, '', 'Relay Contacts', null, null, this.getTagsForStencil(gnmeem, 'relay contacts', dtmeem).join(' ')),
                this.createVertexTemplateEntry(meem + 'resonator;',
                    100, 50, '', 'Resonator', null, null, this.getTagsForStencil(gnmeem, 'resonator', dtmeem).join(' ')),
                this.createVertexTemplateEntry(meem + 'pilot_light;',
                    100, 100, '', 'Pilot Light', null, null, this.getTagsForStencil(gnmeem, 'pilot light', dtmeem).join(' ')),
                this.createVertexTemplateEntry(meem + 'relay_coil_2;',
                    100, 70, '', 'Relay Coil', null, null, this.getTagsForStencil(gnmeem, 'relay coil', dtmeem).join(' ')),
                this.createVertexTemplateEntry(meem + 'mercury_switch;',
                    80, 80, '', 'Mercury Switch', null, null, this.getTagsForStencil(gnmeem, 'mercury switch', dtmeem).join(' ')),
                this.createVertexTemplateEntry(meem + 'mercury_switch_2;',
                    50, 90, '', 'Mercury Switch', null, null, this.getTagsForStencil(gnmeem, 'mercury switch', dtmeem).join(' '))
            ]);

        this.addPaletteFunctions('electrical\Diodes', 'Electrical / Diodes', false,
            [
                this.createVertexTemplateEntry(med + 'diode;',
                    100, 60, '', 'PN Diode', null, null, this.getTagsForStencil(gnmed, 'diode', dtmed).join(' ')),
                this.createVertexTemplateEntry(med + 'gunn_diode;',
                    100, 60, '', 'Gunn Diode', null, null, this.getTagsForStencil(gnmed, 'gunn_diode', dtmed).join(' ')),
                this.createVertexTemplateEntry(med + 'schottky_diode;',
                    100, 60, '', 'Schottky Diode', null, null, this.getTagsForStencil(gnmed, 'schottky_diode', dtmed).join(' ')),
                this.createVertexTemplateEntry(med + 'zener_diode_2;',
                    100, 60, '', 'Breakdown', null, null, this.getTagsForStencil(gnmed, 'zener_diode_2', dtmed).join(' ')),
                this.createVertexTemplateEntry(med + 'tunnel_diode;',
                    100, 60, '', 'Tunnel Diode 1', null, null, this.getTagsForStencil(gnmed, 'tunnel_diode', dtmed).join(' ')),
                this.createVertexTemplateEntry(med + 'tunnel_diode_2;',
                    100, 80, '', 'Tunnel Diode 2', null, null, this.getTagsForStencil(gnmed, 'tunnel_diode_2', dtmed).join(' ')),
                this.createVertexTemplateEntry(med + 'field_effect_diode;',
                    100, 60, '', 'Field Effect Diode', null, null, this.getTagsForStencil(gnmed, 'field_effect_diode', dtmed).join(' ')),
                this.createVertexTemplateEntry(med + 'varactor_-_varicap;',
                    100, 60, '', 'Varactor - Varicap', null, null, this.getTagsForStencil(gnmed, 'varactor_-_varicap', dtmed).join(' ')),
                this.createVertexTemplateEntry(med + 'zener_diode_1;',
                    100, 60, '', 'Zener Diode 1', null, null, this.getTagsForStencil(gnmed, 'zener_diode_1', dtmed).join(' ')),
                this.createVertexTemplateEntry(med + 'zener_diode_3;',
                    100, 60, '', 'Zener Diode 2', null, null, this.getTagsForStencil(gnmed, 'zener_diode_3', dtmed).join(' ')),
                this.createVertexTemplateEntry(med + 'four_layer_diode;',
                    100, 80, '', 'Four Layer Diode', null, null, this.getTagsForStencil(gnmed, 'four_layer_diode', dtmed).join(' ')),
                this.createVertexTemplateEntry(med + 'transorb_1;',
                    100, 60, '', 'Transorb 1', null, null, this.getTagsForStencil(gnmed, 'transorb_1', dtmed).join(' ')),
                this.createVertexTemplateEntry(med + 'transorb_2;',
                    100, 60, '', 'Transorb 2', null, null, this.getTagsForStencil(gnmed, 'transorb_2', dtmed).join(' '))
            ]);

        this.addPaletteFunctions('electrical\Sources', 'Electrical / Sources', false,
            [
                this.createVertexTemplateEntry(mess + 'ac_source;',
                    60, 60, '', 'AC', null, null, this.getTagsForStencil(gnmess, 'ac_source', dtmess).join(' ')),
                this.createVertexTemplateEntry(mess + 'current_source;',
                    40, 60, '', 'Current', null, null, this.getTagsForStencil(gnmess, 'current_source', dtmess).join(' ')),
                this.createVertexTemplateEntry(mess + 'dc_source_1;',
                    70, 75, '', 'DC', null, null, this.getTagsForStencil(gnmess, 'dc_source_1', dtmess).join(' ')),
                this.createVertexTemplateEntry(mess + 'dc_source_2;',
                    60, 60, '', 'DC', null, null, this.getTagsForStencil(gnmess, 'dc_source_2', dtmess).join(' ')),
                this.createVertexTemplateEntry(mess + 'dc_source_3;',
                    60, 60, '', 'DC', null, null, this.getTagsForStencil(gnmess, 'dc_source_3', dtmess).join(' ')),
                this.createVertexTemplateEntry(mess + 'dependent_source_1;',
                    60, 60, '', 'Dependent', null, null, this.getTagsForStencil(gnmess, 'dependent_source_1', dtmess).join(' ')),
                this.createVertexTemplateEntry(mess + 'dependent_source_2;',
                    60, 60, '', 'Dependent', null, null, this.getTagsForStencil(gnmess, 'dependent_source_2', dtmess).join(' ')),
                this.createVertexTemplateEntry(mess + 'dependent_source_3;',
                    60, 60, '', 'Dependent', null, null, this.getTagsForStencil(gnmess, 'dependent_source_3', dtmess).join(' ')),
                this.createVertexTemplateEntry(mess + 'noise_source;',
                    60, 60, '', 'Noise', null, null, this.getTagsForStencil(gnmess, 'noise_source', dtmess).join(' ')),
                this.createVertexTemplateEntry(mess + 'ideal_source;',
                    60, 60, '', 'Ideal Source', null, null, this.getTagsForStencil(gnmess, 'ideal source', dtmess).join(' ')),
                this.createVertexTemplateEntry(mess + 'explosive_squib',
                    60, 60, '', 'Explosive Squib', null, null, this.getTagsForStencil(gnmess, 'explosive squib', dtmem).join(' ')),
                this.createVertexTemplateEntry('verticalLabelPosition=bottom;shadow=0;dashed=0;align=center;fillColor=#000000;strokeColor=#000000;html=1;verticalAlign=top;strokeWidth=1;shape=mxgraph.electrical.miscellaneous.monocell_battery;',
                    100, 60, '', 'Accumulator / Monocell Battery', null, null, this.getTagsForStencil(gnmess, 'accumulator monocell battery single cell', dtmem).join(' ')),
                this.createVertexTemplateEntry(mem + 'batteryStack;',
                    100, 60, '', 'Battery Stack', null, null, this.getTagsForStencil(gnmess, 'battery stack', dtmess).join(' ')),
                this.createVertexTemplateEntry('pointerEvents=1;verticalLabelPosition=bottom;shadow=0;dashed=0;align=center;fillColor=#000000;strokeColor=#000000;html=1;verticalAlign=top;strokeWidth=1;shape=mxgraph.electrical.miscellaneous.multicell_battery_tapped;',
                    100, 70, '', 'Multicell Battery Tapped', null, null, this.getTagsForStencil(gnmess, 'accumulator multicell battery tapped multi multiple cell', dtmem).join(' '))
            ]);

        this.addPaletteFunctions('electrical\Transistors', 'Electrical / Transistors', false,
            [
                this.createVertexTemplateEntry(met + 'npn_transistor_1;',
                    95, 100, '', 'BJT (NPN)', null, null, this.getTagsForStencil(gnmet, 'npn_transistor_1', dtmet).join(' ')),
                this.createVertexTemplateEntry(met + 'pnp_transistor_1;',
                    95, 100, '', 'BJT (PNP)', null, null, this.getTagsForStencil(gnmet, 'pnp_transistor_1', dtmet).join(' ')),
                this.createVertexTemplateEntry(met + 'n-channel_jfet_1;',
                    95, 100, '', 'N Channel JFET', null, null, this.getTagsForStencil(gnmet, 'n-channel_jfet_1', dtmet).join(' ')),
                this.createVertexTemplateEntry(met + 'p-channel_jfet_1;',
                    95, 100, '', 'P Channel JFET', null, null, this.getTagsForStencil(gnmet, 'p-channel_jfet_1', dtmet).join(' ')),
                this.createVertexTemplateEntry(mef1 + 'n-channel_mosfet_1;',
                    95, 100, '', 'MOSFET (N)', null, null, this.getTagsForStencil(gnmet, 'n-channel_mosfet_1', dtmet).join(' ')),
                this.createVertexTemplateEntry(mef1 + 'p-channel_mosfet_1;',
                    95, 100, '', 'MOSFET (P)', null, null, this.getTagsForStencil(gnmet, 'p-channel_mosfet_1', dtmet).join(' ')),
                this.createVertexTemplateEntry(mef1 + 'mosfet_ic_n;',
                    95, 100, '', 'NMOS', null, null, this.getTagsForStencil(gnmet, 'mosfet_ic_n', dtmet).join(' ')),
                this.createVertexTemplateEntry(mef1 + 'mosfet_ic_p;',
                    95, 100, '', 'PMOS', null, null, this.getTagsForStencil(gnmet, 'mosfet_ic_p', dtmet).join(' ')),
                this.createVertexTemplateEntry(mef1 + 'mosfet_n_no_bulk;',
                    95, 100, '', 'MOSFET No Bulk (N)', null, null, this.getTagsForStencil(gnmet, 'mosfet_n_no_bulk', dtmet).join(' ')),
                this.createVertexTemplateEntry(mef1 + 'mosfet_p_no_bulk;',
                    95, 100, '', 'MOSFET No Bulk (P)', null, null, this.getTagsForStencil(gnmet, 'mosfet_p_no_bulk', dtmet).join(' ')),
                this.createVertexTemplateEntry(mef1 + 'dual_gate_mosfet_n;',
                    95, 100, '', 'Dual Gate MOSFET (N)', null, null, this.getTagsForStencil(gnmet, 'dual_gate_mosfet_n', dtmet).join(' ')),
                this.createVertexTemplateEntry(mef1 + 'dual_gate_mosfet_p;',
                    95, 100, '', 'Dual Gate MOSFET (P)', null, null, this.getTagsForStencil(gnmet, 'dual_gate_mosfet_p', dtmet).join(' ')),
                this.createVertexTemplateEntry(met + 'nmos;pointerEvents=1;',
                    60, 100, '', 'NMOS', null, null, this.getTagsForStencil(gnmet, 'nmos', dtmet).join(' ')),
                this.createVertexTemplateEntry(met + 'pmos;pointerEvents=1;',
                    60, 100, '', 'PMOS', null, null, this.getTagsForStencil(gnmet, 'pmos', dtmet).join(' '))
            ]);

        this.addPaletteFunctions('electrical\Instruments', 'Electrical / Instruments', false,
            [
                this.createVertexTemplateEntry('verticalLabelPosition=middle;shadow=0;dashed=0;align=center;fillColor=#ffffff;html=1;verticalAlign=middle;strokeWidth=1;shape=ellipse;aspect=fixed;fontSize=50;',
                    90, 90, 'A', 'Ammeter', null, null, this.getTagsForStencil(gnmein, 'ampermeter ammeter', dtmein).join(' ')),
                this.createVertexTemplateEntry(mein + 'galvanometer;',
                    90, 90, '', 'Galvanometer', null, null, this.getTagsForStencil(gnmein, 'galvanometer', dtmein).join(' ')),
                this.createVertexTemplateEntry(mein + 'oscilloscope;',
                    90, 90, '', 'Oscilloscope', null, null, this.getTagsForStencil(gnmein, 'oscilloscope', dtmein).join(' ')),
                this.createVertexTemplateEntry(mein + 'signal_generator;',
                    90, 90, '', 'Signal Generator', null, null, this.getTagsForStencil(gnmein, 'signal_generator', dtmein).join(' ')),
                this.createVertexTemplateEntry('verticalLabelPosition=middle;shadow=0;dashed=0;align=center;fillColor=#ffffff;html=1;verticalAlign=middle;strokeWidth=1;shape=ellipse;aspect=fixed;fontSize=50;',
                    90, 90, 'V', 'Voltmeter', null, null, this.getTagsForStencil(gnmein, 'ampermeter ammeter', dtmein).join(' '))
            ]);

        this.addPaletteFunctions('electrical\Misc', 'Electrical / Misc', false,
            [
                this.createVertexTemplateEntry(mer + 'aerial_-_antenna_1;',
                    80, 100, '', 'Antenna', null, null, this.getTagsForStencil(gnmer, 'aerial_-_antenna_1', dtmer).join(' ')),
                this.createVertexTemplateEntry(mer + 'aerial_-_antenna_2;',
                    79, 100, '', 'Antenna', null, null, this.getTagsForStencil(gnmer, 'aerial_-_antenna_2', dtmer).join(' ')),
                this.createVertexTemplateEntry(mer + 'loop_antenna;',
                    64.8, 69.78, '', 'Loop Antenna', null, null, this.getTagsForStencil(gnmer, 'loop_antenna', dtmer).join(' ')),
                this.createVertexTemplateEntry(mem + 'loop_antenna',
                    100, 100, '', 'Loop Antenna', null, null, this.getTagsForStencil(gnmess, 'loop antenna', dtmem).join(' ')),
                this.createVertexTemplateEntry('verticalLabelPosition=middle;shadow=0;dashed=0;align=center;fillColor=#ffffff;html=1;verticalAlign=middle;strokeWidth=1;shape=ellipse;aspect=fixed;fontSize=35;',
                    60, 60, 'M', 'Electrical Motor', null, null, this.getTagsForStencil(gnmeem, 'motor_1', dtmeem).join(' ')),
                this.createVertexTemplateEntry(mxConstants.STYLE_SHAPE + '=mxgraph.electrical.electro-mechanical.motor_2;html=1;shadow=0;dashed=0;fillColor=#ffffff;align=center;fontSize=30;strokeColor=#000000;strokeWidth=1;',
                    100, 60, '', 'Motor Armature', null, null, this.getTagsForStencil(gnmeem, 'motor_2', dtmeem).join(' ')),
                this.createVertexTemplateEntry(mem + 'co-ax;',
                    40, 60, '', 'Co-Ax', null, null, this.getTagsForStencil(gnmem, 'co-ax', dtmem).join(' ')),
                this.createVertexTemplateEntry(mem + 'crystal_1;',
                    100, 40, '', 'Crystal', null, null, this.getTagsForStencil(gnmem, 'crystal_1', dtmem).join(' ')),
                this.createVertexTemplateEntry(mem + 'fuse_1;',
                    100, 20, '', 'Fuse (IEC)', null, null, this.getTagsForStencil(gnmem, 'fuse_1', dtmem).join(' ')),
                this.createVertexTemplateEntry(mem + 'fuse_2;',
                    100, 20, '', 'Fuse (IEEE)', null, null, this.getTagsForStencil(gnmem, 'fuse_2', dtmem).join(' ')),
                this.createVertexTemplateEntry(mem + 'fuse_3;',
                    100, 12, '', 'Fuse (obsolete)', null, null, this.getTagsForStencil(gnmem, 'fuse_3', dtmem).join(' ')),
                this.createVertexTemplateEntry(mem + 'fuse_4;',
                    100, 32, '', 'Fuse (IEEE)', null, null, this.getTagsForStencil(gnmem, 'fuse_4', dtmem).join(' ')),
                this.createVertexTemplateEntry(mem + 'light_bulb;',
                    60, 50, '', 'Light Bulb', null, null, this.getTagsForStencil(gnmem, 'light_bulb', dtmem).join(' ')),
                this.createVertexTemplateEntry(mem + 'illuminating_bulb;',
                    60, 50, '', 'Illuminating Bulb', null, null, this.getTagsForStencil(gnmem, 'illuminating_bulb', dtmem).join(' ')),
                this.createVertexTemplateEntry(mem + 'light_bulb;',
                    60, 50, '', 'Pilot Light', null, null, this.getTagsForStencil(gnmem, 'light_bulb', dtmem).join(' ')),
                this.createVertexTemplateEntry(mem + 'neon_lamp_2;',
                    60, 50, '', 'Neon Lamp', null, null, this.getTagsForStencil(gnmem, 'neon_lamp_2', dtmem).join(' ')),
                this.createVertexTemplateEntry(mem + 'flourescent_lamp',
                    80, 30, '', 'Flourescent Lamp', null, null, this.getTagsForStencil(gnmess, 'flourescent lamp', dtmem).join(' ')),
                this.createVertexTemplateEntry(meoe + 'lamp',
                    50, 100, '', 'Lamp', null, null, this.getTagsForStencil(gnmess, 'lamp', dtmeoe).join(' ')),
                this.createVertexTemplateEntry(mem + 'thermocouple;',
                    80, 81, '', 'Thermocouple', null, null, this.getTagsForStencil(gnmem, 'thermocouple', dtmem).join(' ')),
                this.createVertexTemplateEntry(mea + 'amplifier;',
                    90, 100, '', 'Amplifier', null, null, this.getTagsForStencil(gnmea, 'amplifier', dtmea).join(' ')),
                this.createVertexTemplateEntry(mea + 'controlled_amplifier;',
                    100, 90, '', 'Controlled Amplifier', null, null, this.getTagsForStencil(gnmea, 'controlled_amplifier', dtmea).join(' ')),
                this.createVertexTemplateEntry(mea + 'dac;',
                    70, 46, '', 'DAC', null, null, this.getTagsForStencil(gnmea, 'dac', dtmea).join(' ')),
                this.createVertexTemplateEntry(
                    'shadow=0;dashed=0;align=center;fillColor=#ffffff;html=1;strokeWidth=1;shape=mxgraph.electrical.abstract.mux2;',
                    80, 120, 'Mux', 'Mux', null, null, this.getTagsForStencil(gnmea, 'mux', dtmea).join(' ')),
                this.createVertexTemplateEntry(
                    'shadow=0;dashed=0;align=center;fillColor=#ffffff;html=1;strokeWidth=1;shape=mxgraph.electrical.abstract.mux2;operation=demux;',
                    80, 120, 'Demux', 'Demux', null, null, this.getTagsForStencil(gnmea, 'mux', dtmea).join(' ')),
                this.createVertexTemplateEntry(mea + 'operational_amp_1;',
                    98, 90, '', 'Operational Amp', null, null, this.getTagsForStencil(gnmea, 'operational_amp_1', dtmea).join(' ')),
                this.createVertexTemplateEntry(mea + 'operational_amp_2;',
                    98, 90, '', 'Operational Amp', null, null, this.getTagsForStencil(gnmea, 'operational_amp_2', dtmea).join(' ')),
                this.createVertexTemplateEntry(mea + 'ota_1;',
                    100, 90, '', 'OTA', null, null, this.getTagsForStencil(gnmea, 'ota_1', dtmea).join(' ')),
                this.createVertexTemplateEntry(mea + 'ota_2;',
                    100, 90, '', 'OTA', null, null, this.getTagsForStencil(gnmea, 'ota_2', dtmea).join(' ')),
                this.createVertexTemplateEntry(mea + 'ota_3;',
                    100, 90, '', 'OTA', null, null, this.getTagsForStencil(gnmea, 'ota_3', dtmea).join(' ')),
                this.createVertexTemplateEntry(mea + 'quantizer;',
                    52, 46, '', 'Quantizer', null, null, this.getTagsForStencil(gnmea, 'quantizer', dtmea).join(' ')),
                this.createVertexTemplateEntry(mea + 'delta;',
                    50, 50, '', 'Delta', null, null, this.getTagsForStencil(gnmea, 'delta', dtmea).join(' ')),
                this.createVertexTemplateEntry(mxConstants.STYLE_SHAPE + '=mxgraph.electrical.abstract.function;html=1;shadow=0;dashed=0;fillColor=#ffffff;align=center;strokeColor=#000000;strokeWidth=1;fontSize=24',
                    50, 50, 'fn', 'Function', null, null, this.getTagsForStencil(gnmea, 'function', dtmea).join(' ')),
                this.createVertexTemplateEntry(mea + 'integrator;',
                    50, 50, '', 'Integrator', null, null, this.getTagsForStencil(gnmea, 'integrator', dtmea).join(' ')),
                this.createVertexTemplateEntry(mea + 'multiplier;',
                    50, 50, '', 'Multiplier', null, null, this.getTagsForStencil(gnmea, 'multiplier', dtmea).join(' ')),
                this.createVertexTemplateEntry(mea + 'sum;',
                    50, 50, '', 'Sum', null, null, this.getTagsForStencil(gnmea, 'sum', dtmea).join(' ')),
                this.createVertexTemplateEntry(mea + 'summation_point;',
                    50, 50, '', 'Summation Point', null, null, this.getTagsForStencil(gnmea, 'summation_point', dtmea).join(' ')),
                this.createVertexTemplateEntry(mea + 'filter;',
                    52, 46, '', 'Filter', null, null, this.getTagsForStencil(gnmea, 'filter', dtmea).join(' ')),
                this.createVertexTemplateEntry(s + '=mxgraph.electrical.logic_gates.bandpass_filter;',
                    52, 46, '', 'Bandpass Filter', null, null, this.getTagsForStencil('mxgraph.electrical.logic_gates', 'bandpass_filter', '').join(' ')),
                this.createVertexTemplateEntry(s + '=mxgraph.electrical.logic_gates.highpass_filter;',
                    52, 46, '', 'Highpass Filter', null, null, this.getTagsForStencil('mxgraph.electrical.logic_gates', 'highpass_filter', '').join(' ')),
                this.createVertexTemplateEntry(s + '=mxgraph.electrical.logic_gates.lowpass_filter;',
                    52, 46, '', 'Lowpass Filter', null, null, this.getTagsForStencil('mxgraph.electrical.logic_gates', 'lowpass_filter', '').join(' ')),
                this.createVertexTemplateEntry(mxConstants.STYLE_SHAPE + '=mxgraph.electrical.abstract.thermistor_with_independent_integral_heater;html=1;shadow=0;dashed=0;fillColor=#ffffff;strokeColor=#000000;strokeWidth=1;align=center;overflow=fill;fontSize=12;',
                    100, 94.25,
                    '<table cellpadding="0" cellspacing="0" style="width:100%;height:100%;">' +
                    '<tr height="45%">' +
                    '<td align="center">\\temp\\</td>' +
                    '</tr>' +
                    '<tr height="55%">' +
                    '<td></td>' +
                    '</tr>' +
                    '</table>',
                    'Thermistor With Independent Integral Heater', null, null, this.getTagsForStencil(gnmea, 'thermistor_with_independent_integral_heater', dtmea).join(' ')),
                this.createVertexTemplateEntry(mea + 'voltage_regulator;',
                    70, 58, '', 'Voltage Regulator', null, null, this.getTagsForStencil(gnmea, 'voltage_regulator', dtmea).join(' ')),
                this.createVertexTemplateEntry(mess + 'vdd;fontSize=24;',
                    60, 40,
                    'V<sub>dd</sub>', 'Vdd', null, null, this.getTagsForStencil(gnmess, 'vdd', dtmess).join(' ')),
                this.createVertexTemplateEntry(mxConstants.STYLE_VERTICAL_LABEL_POSITION + '=top;' + mxConstants.STYLE_VERTICAL_ALIGN + '=bottom;' + mxConstants.STYLE_SHAPE + '=mxgraph.electrical.signal_sources.vss2;shadow=0;dashed=0;fillColor=#ffffff;align=center;strokeColor=#000000;strokeWidth=1;fontSize=24;html=1;',
                    60, 40,
                    'V<sub>ss</sub>', 'Vss', null, null, this.getTagsForStencil(gnmess, 'vss2', dtmess).join(' ')),
                this.createVertexTemplateEntry(mxConstants.STYLE_VERTICAL_LABEL_POSITION + '=top;' + mxConstants.STYLE_VERTICAL_ALIGN + '=bottom;' + mxConstants.STYLE_SHAPE + '=mxgraph.electrical.signal_sources.current_flow;shadow=0;dashed=0;fillColor=#ffffff;align=center;strokeColor=#000000;strokeWidth=1;fontSize=10;html=1;',
                    70, 10,
                    '5 mA', 'Current Flow', null, null, this.getTagsForStencil(gnmess, 'current_flow', dtmess).join(' ')),
                this.createVertexTemplateEntry(mxConstants.STYLE_LABEL_POSITION + '=right;' + mxConstants.STYLE_ALIGN + '=left;' + mxConstants.STYLE_SHAPE + '=mxgraph.electrical.signal_sources.voltage;shadow=0;dashed=0;fillColor=#ffffff;strokeColor=#000000;strokeWidth=1;fontSize=10;html=1;',
                    10, 70,
                    '1.2 V', 'Voltage', null, null, this.getTagsForStencil(gnmess, 'voltage', dtmess).join(' ')),
                this.createVertexTemplateEntry(mess + 'equipotential;',
                    90, 90, '', 'Equipotential', null, null, this.getTagsForStencil(gnmess, 'equipotential', dtmess).join(' ')),
                this.createVertexTemplateEntry(mess + 'protective_earth;',
                    25, 20, '', 'Equipotential', null, null, this.getTagsForStencil(gnmess, 'protective_earth', dtmess).join(' ')),
                this.createVertexTemplateEntry(mess + 'signal_ground;',
                    45, 30, '', 'Ground', null, null, this.getTagsForStencil(gnmess, 'signal_ground', dtmess).join(' ')),
                this.createVertexTemplateEntry(mem + 'chassis;',
                    65, 32, '', 'Chassis', null, null, this.getTagsForStencil(gnmess, 'chassis', dtmem).join(' ')),
                this.createVertexTemplateEntry(mem + 'circuit_breaker;',
                    100, 13, '', 'Circuit Breaker', null, null, this.getTagsForStencil(gnmess, 'circuit breaker', dtmem).join(' ')),
                this.createVertexTemplateEntry(mem + 'generic_component',
                    60, 60, '', 'Generic Component', null, null, this.getTagsForStencil(gnmess, 'generic component', dtmem).join(' ')),
                this.createVertexTemplateEntry(mem + 'permanent_magnet',
                    20, 70, '', 'Permanent Magnet', null, null, this.getTagsForStencil(gnmess, 'permanent magnet', dtmem).join(' ')),
                this.createVertexTemplateEntry(mem + 'thermal_element',
                    100, 32, '', 'Thermal Element', null, null, this.getTagsForStencil(gnmess, 'thermal element', dtmem).join(' ')),
                this.createVertexTemplateEntry(mem + 'igniter_plug',
                    72, 39, '', 'Igniter Plug', null, null, this.getTagsForStencil(gnmess, 'igniter plug', dtmem).join(' ')),
                this.createVertexTemplateEntry('shape=mxgraph.arrows2.arrow;verticalLabelPosition=bottom;shadow=0;dashed=0;align=center;fillColor=#ffffff;html=1;verticalAlign=top;strokeWidth=1;dy=0;dx=10;notch=0;',
                    100, 30, '', 'Pickup Head', null, null, this.getTagsForStencil(gnmess, 'pickup head', dtmem).join(' ')),
                this.createVertexTemplateEntry(mem + 'squib_ignitor',
                    100, 100, '', 'Squib Ignitor', null, null, this.getTagsForStencil(gnmess, 'squib ignitor', dtmem).join(' ')),
                this.createVertexTemplateEntry(mem + 'transducer',
                    70, 60, '', 'Transducer', null, null, this.getTagsForStencil(gnmess, 'transducer', dtmem).join(' ')),
                this.createVertexTemplateEntry(mem + 'transducer_2',
                    80, 100, '', 'Transducer', null, null, this.getTagsForStencil(gnmess, 'transducer', dtmem).join(' ')),
                this.createVertexTemplateEntry(mem + 'thermopile',
                    80, 82, '', 'Thermopile', null, null, this.getTagsForStencil(gnmess, 'thermopile', dtmem).join(' ')),
                this.createVertexTemplateEntry(mem + 'indicator',
                    60, 60, '', 'Indicator', null, null, this.getTagsForStencil(gnmess, 'indicator', dtmem).join(' ')),
                this.createVertexTemplateEntry('verticalLabelPosition=bottom;shadow=0;dashed=0;align=center;fillColor=#000000;html=1;verticalAlign=top;strokeWidth=1;shape=mxgraph.electrical.miscellaneous.surge_protector;',
                    70, 20, '', 'Surge Protector', null, null, this.getTagsForStencil(gnmess, 'surge protector', dtmem).join(' ')),
                this.createVertexTemplateEntry(mem + 'surge_protector_2;',
                    70, 24, '', 'Surge Protector', null, null, this.getTagsForStencil(gnmess, 'surge protector', dtmem).join(' ')),
                this.createVertexTemplateEntry('verticalLabelPosition=bottom;shadow=0;dashed=0;align=center;fillColor=#ffffff;html=1;verticalAlign=top;strokeWidth=1;shape=rect;',
                    130, 50, '', 'Material', null, null, this.getTagsForStencil(gnmess, 'material', dtmem).join(' ')),
                this.createVertexTemplateEntry(mem + 'sensing_link_squib',
                    130, 40, '', 'Sensing Link Squib', null, null, this.getTagsForStencil(gnmess, 'sensing link squib', dtmem).join(' ')),
                this.createVertexTemplateEntry(mem + 'delay_element',
                    100, 100, '', 'Delay Element', null, null, this.getTagsForStencil(gnmess, 'delay_element', dtmem).join(' ')),
                this.createVertexTemplateEntry(mer + 'buzzer',
                    80, 50, '', 'Buzzer', null, null, this.getTagsForStencil(gnmess, 'buzzer', dtmer).join(' ')),
                this.createVertexTemplateEntry(mem + 'adapter',
                    100, 40, '', 'Adapter', null, null, this.getTagsForStencil(gnmess, 'adapter', dtmer).join(' ')),
                this.createVertexTemplateEntry('verticalLabelPosition=bottom;shadow=0;dashed=0;align=center;fillColor=#ffffff;html=1;verticalAlign=top;strokeWidth=1;shape=ellipse;perimeter=ellipsePerimeter;',
                    15, 15, '', 'Circuit Terminal', null, null, this.getTagsForStencil(gnmess, 'circuit terminal', dtmer).join(' ')),
                this.createEdgeTemplateEntry('endArrow=open;html=1;strokeColor=#000000;strokeWidth=1;endFill=0;endSize=20;',
                    100, 0, '', 'M/F Contact', null, this.getTagsForStencil(gnmess, '', 'mf contact').join(' ')),
                this.createVertexTemplateEntry('verticalLabelPosition=bottom;shadow=0;dashed=0;align=center;fillColor=#000000;strokeColor=#000000;html=1;verticalAlign=top;strokeWidth=1;shape=mxgraph.electrical.miscellaneous.mf_contact_2',
                    100, 10, '', 'MF Contact 2', null, null, this.getTagsForStencil(gnmess, 'mf contact', dtmer).join(' ')),
                this.createVertexTemplateEntry(mem + 'terminal_board',
                    75, 150, '', 'Terminal Board', null, null, this.getTagsForStencil(gnmess, 'terminal board', dtmer).join(' ')),
                this.createVertexTemplateEntry(mem + 'cable_termination',
                    100, 50, '', 'Cable Termination', null, null, this.getTagsForStencil(gnmess, 'cable termination', dtmer).join(' ')),
                this.createVertexTemplateEntry(mem + '2_conductor_jack',
                    100, 50, '', '2-Conductor Jack', null, null, this.getTagsForStencil(gnmess, '2 conductor jack two', dtmer).join(' ')),
                this.createVertexTemplateEntry(mem + '3_conductor_jack',
                    100, 50, '', '3-Conductor Jack', null, null, this.getTagsForStencil(gnmess, '3 conductor jack three', dtmer).join(' ')),
                this.createVertexTemplateEntry(mem + '2_conductor_plug',
                    53, 24, '', '2-Conductor Plug', null, null, this.getTagsForStencil(gnmess, '2 conductor plug two', dtmer).join(' ')),
                this.createVertexTemplateEntry(mem + '3_conductor_plug',
                    53, 24, '', '3 Conductor Plug', null, null, this.getTagsForStencil(gnmess, '3 conductor plug', dtmer).join(' ')),
                this.createVertexTemplateEntry(mem + 'normalled_jacks',
                    230, 65, '', 'Normalled Jacks', null, null, this.getTagsForStencil(gnmess, 'normalled jacks', dtmer).join(' ')),
                this.createVertexTemplateEntry(mem + 'normalled_jack',
                    110, 65, '', 'Normalled Jack', null, null, this.getTagsForStencil(gnmess, 'normalled jack', dtmer).join(' ')),
                this.createVertexTemplateEntry(mem + 'coaxial_outside_conductor',
                    300, 150, '', 'Coaxial Outside Conductor', null, null, this.getTagsForStencil(gnmess, 'coaxial outside conductor', dtmer).join(' ')),
                this.createVertexTemplateEntry(mem + 'coaxial_center_conductor',
                    300, 150, '', 'Coaxial Center Conductor', null, null, this.getTagsForStencil(gnmess, 'coaxial center conductor', dtmer).join(' ')),
                this.createVertexTemplateEntry(mem + 'large_d_connector',
                    375, 75, '', 'Large D Connector', null, null, this.getTagsForStencil(gnmess, 'large d connector', dtmer).join(' ')),
                this.createVertexTemplateEntry(mem + 'small_d_connector',
                    150, 75, '', 'Small D Connector', null, null, this.getTagsForStencil(gnmess, 'small d connector', dtmer).join(' ')),
                this.createVertexTemplateEntry(mem + 'c_header_connector',
                    200, 75, '', 'C Header Connector', null, null, this.getTagsForStencil(gnmess, 'c header connector', dtmer).join(' ')),
                this.createVertexTemplateEntry(mem + 'ac_out',
                    200, 100, '', 'AC Out', null, null, this.getTagsForStencil(gnmess, 'ac out alternate current', dtmer).join(' ')),
                this.createVertexTemplateEntry(mem + 'shielded_jack_plug',
                    50, 100, '', 'Shielded Jack/Plug', null, null, this.getTagsForStencil(gnmess, 'shielded jack plug', dtmer).join(' ')),
                this.createVertexTemplateEntry(mem + 'coaxial_jack_plug',
                    50, 100, '', 'Coaxial Jack/Plug', null, null, this.getTagsForStencil(gnmess, 'coaxial jack/plug', dtmer).join(' ')),
                this.createVertexTemplateEntry(mem + 'f_m_2_conductor_1',
                    100, 100, '', 'F/M 2 Conductor', null, null, this.getTagsForStencil(gnmess, 'fm 2 conductor', dtmer).join(' ')),
                this.createVertexTemplateEntry(mem + 'f_m_2_conductor_2',
                    100, 100, '', 'F/M 2 Conductor', null, null, this.getTagsForStencil(gnmess, 'fm 2 conductor', dtmer).join(' ')),
                this.createVertexTemplateEntry(mem + 'f_m_2_conductor_3',
                    100, 50, '', 'F/M 2 Conductor', null, null, this.getTagsForStencil(gnmess, 'fm 2 conductor', dtmer).join(' ')),
                this.createVertexTemplateEntry(mem + 'f_m_3_conductor_1',
                    100, 100, '', 'F/M 3 Conductor', null, null, this.getTagsForStencil(gnmess, 'fm 2 conductor', dtmer).join(' ')),
                this.createVertexTemplateEntry(mem + 'f_m_3_conductor_2',
                    100, 100, '', 'F/M 3 Conductor', null, null, this.getTagsForStencil(gnmess, 'fm 2 conductor', dtmer).join(' ')),
                this.createVertexTemplateEntry(mem + 'f_m_3_conductor_3',
                    100, 100, '', 'F/M 3 Conductor', null, null, this.getTagsForStencil(gnmess, 'fm 2 conductor', dtmer).join(' ')),
                this.createVertexTemplateEntry(mem + 'f_m_3_conductor_4',
                    100, 100, '', 'F/M 3 Conductor', null, null, this.getTagsForStencil(gnmess, 'fm 2 conductor', dtmer).join(' ')),
                this.createVertexTemplateEntry(mem + 'f_m_3_conductor_5',
                    100, 100, '', 'F/M 3 Conductor', null, null, this.getTagsForStencil(gnmess, 'fm 2 conductor', dtmer).join(' '))
            ]);

        this.addPaletteFunctions('electrical\Audio', 'Electrical / Audio', false,
            [
                this.createVertexTemplateEntry(mer + 'dipole;pointerEvents=1;',
                    100, 40, '', 'Dipole', null, null, this.getTagsForStencil(gnmer, 'dipole', dtmer).join(' ')),
                this.createVertexTemplateEntry(mer + 'electret_microphone;',
                    70, 70, '', 'Electret Microphone', null, null, this.getTagsForStencil(gnmer, 'electret_microphone', dtmer).join(' ')),
                this.createVertexTemplateEntry(mer + 'microphone_1;',
                    70, 70, '', 'Microphone', null, null, this.getTagsForStencil(gnmer, 'microphone_1', dtmer).join(' ')),
                this.createVertexTemplateEntry(mer + 'microphone_2;',
                    42, 70, '', 'Microphone', null, null, this.getTagsForStencil(gnmer, 'microphone_2', dtmer).join(' ')),
                this.createVertexTemplateEntry(meem + 'piezo_sounder;pointerEvents=1;',
                    100, 40, '', 'Piezo Sounder', null, null, this.getTagsForStencil(gnmeem, 'piezo_sounder', dtmeem).join(' ')),
                this.createVertexTemplateEntry(meem + 'buzzer;',
                    45, 60, '', 'Buzzer', null, null, this.getTagsForStencil(gnmeem, 'buzzer', dtmeem).join(' ')),
                this.createVertexTemplateEntry(meem + 'loudspeaker;',
                    25, 50, '', 'Loudspeaker', null, null, this.getTagsForStencil(gnmeem, 'loudspeaker', dtmeem).join(' ')),
                this.createVertexTemplateEntry(mer + 'headphones;pointerEvents=1;',
                    66, 56, '', 'Headphones', null, null, this.getTagsForStencil(gnmer, 'headphones', dtmer).join(' ')),
                this.createVertexTemplateEntry(meem + 'bell;',
                    47, 60, '', 'Bell', null, null, this.getTagsForStencil(gnmeem, 'bell', dtmeem).join(' '))
            ]);

        this.addPaletteFunctions('electrical\PlcLadder', 'Electrical / PLC Ladder', false,
            [
                this.createVertexTemplateEntry(mep + 'contact;',
                    50, 25, '', 'Contact', null, null, this.getTagsForStencil(gnmep, 'contact', dtmep).join(' ')),
                this.createVertexTemplateEntry(mep + 'not_contact;',
                    50, 25, '', 'Contact (N)', null, null, this.getTagsForStencil(gnmep, 'not_contact', dtmep).join(' ')),
                this.createVertexTemplateEntry(mep + 'not_output_1;',
                    50, 25, '', 'Output (N)', null, null, this.getTagsForStencil(gnmep, 'not_output_1;', dtmep).join(' ')),
                this.createVertexTemplateEntry(mep + 'not_output_2;',
                    50, 25, '', 'Output (N)', null, null, this.getTagsForStencil(gnmep, 'not_output_2', dtmep).join(' ')),
                this.createVertexTemplateEntry(mep + 'output_1;',
                    50, 25, '', 'Output', null, null, this.getTagsForStencil(gnmep, 'output_1', dtmep).join(' ')),
                this.createVertexTemplateEntry(mep + 'output_2;',
                    50, 25, '', 'Output', null, null, this.getTagsForStencil(gnmep, 'output_2', dtmep).join(' '))
            ]);

        this.addPaletteFunctions('electrical\Optical', 'Electrical / Optical', false,
            [
                this.createVertexTemplateEntry(meoe + '7_segment_display;pointerEvents=1;',
                    74.7, 96.1, '', '7 Segment Display', null, null, this.getTagsForStencil(gnmeoe, '7_segment_display', dtmeoe).join(' ')),
                this.createVertexTemplateEntry(meoe + '7_segment_display_with_dp;pointerEvents=1;',
                    79.8, 96.9, '', '7 Segment Display with DP', null, null, this.getTagsForStencil(gnmeoe, '7_segment_display_with_dp', dtmeoe).join(' ')),
                this.createVertexTemplateEntry(meoe + '9_segment_display;pointerEvents=1;',
                    74.7, 96.1, '', '9 Segment Display', null, null, this.getTagsForStencil(gnmeoe, '9_segment_display', dtmeoe).join(' ')),
                this.createVertexTemplateEntry(meoe + '9_segment_display_with_dp;pointerEvents=1;',
                    79.8, 96.9, '', '9 Segment Display with DP', null, null, this.getTagsForStencil(gnmeoe, '9_segment_display_with_dp', dtmeoe).join(' ')),
                this.createVertexTemplateEntry(meoe + 'led_1;pointerEvents=1;',
                    100, 65, '', 'LED', null, null, this.getTagsForStencil(gnmeoe, 'led_1', dtmeoe).join(' ')),
                this.createVertexTemplateEntry(meoe + 'led_2;pointerEvents=1;',
                    100, 70, '', 'LED', null, null, this.getTagsForStencil(gnmeoe, 'led_2', dtmeoe).join(' ')),
                this.createVertexTemplateEntry(meoe + 'light-activated_scr;pointerEvents=1;',
                    100, 70, '', 'Light Activated SCR', null, null, this.getTagsForStencil(gnmeoe, 'light-activated_scr', dtmeoe).join(' ')),
                this.createVertexTemplateEntry(meoe + 'opto-coupler;',
                    99, 60, '', 'Opto-coupler', null, null, this.getTagsForStencil(gnmeoe, 'opto-coupler', dtmeoe).join(' ')),
                this.createVertexTemplateEntry(meoe + 'opto-transistor;',
                    100, 110, '', 'Opto-transistor', null, null, this.getTagsForStencil(gnmeoe, 'opto-transistor', dtmeoe).join(' ')),
                this.createVertexTemplateEntry(meoe + 'photodiode;pointerEvents=1;',
                    100, 70, '', 'Photodiode', null, null, this.getTagsForStencil(gnmeoe, 'photodiode', dtmeoe).join(' ')),
                this.createVertexTemplateEntry(meoe + 'photo_resistor_1;',
                    100, 90, '', 'Photo Resistor', null, null, this.getTagsForStencil(gnmeoe, 'photo_resistor_1', dtmeoe).join(' ')),
                this.createVertexTemplateEntry(meoe + 'photo_resistor_2;pointerEvents=1;',
                    100, 50, '', 'Photo Resistor', null, null, this.getTagsForStencil(gnmeoe, 'photo_resistor_2', dtmeoe).join(' ')),
                this.createVertexTemplateEntry(meoe + 'photo_resistor_3;',
                    100, 90, '', 'Photo Resistor', null, null, this.getTagsForStencil(gnmeoe, 'photo_resistor_3', dtmeoe).join(' ')),
                this.createVertexTemplateEntry(meoe + 'solar_cell;pointerEvents=1;',
                    100, 70, '', 'Solar Cell', null, null, this.getTagsForStencil(gnmeoe, 'solar_cell', dtmeoe).join(' '))
            ]);

        this.addPaletteFunctions('electrical\VacuumTubes', 'Electrical / Vacuum Tubes', false,
            [
                this.createVertexTemplateEntry(metd + 'diode;',
                    70, 77, '', 'Diode', null, null, this.getTagsForStencil(gnmetd, 'diode', dtmetd).join(' ')),
                this.createVertexTemplateEntry(metd + 'double_diode;',
                    70, 77, '', 'Double Diode', null, null, this.getTagsForStencil(gnmetd, 'double_diode', dtmetd).join(' ')),
                this.createVertexTemplateEntry(metd + 'triode;',
                    70, 77, '', 'Triode', null, null, this.getTagsForStencil(gnmetd, 'triode', dtmetd).join(' ')),
                this.createVertexTemplateEntry(metd + 'double_triode;',
                    70, 77, '', 'Double Triode', null, null, this.getTagsForStencil(gnmetd, 'double_triode', dtmetd).join(' ')),
                this.createVertexTemplateEntry(metd + 'tetrode;',
                    70, 77, '', 'Tetrode', null, null, this.getTagsForStencil(gnmetd, 'tetrode', dtmetd).join(' ')),
                this.createVertexTemplateEntry(metd + 'pentode;',
                    70, 77, '', 'Pentode', null, null, this.getTagsForStencil(gnmetd, 'pentode', dtmetd).join(' ')),
                this.createVertexTemplateEntry(metd + 'photocell;',
                    70, 87, '', 'Photocell', null, null, this.getTagsForStencil(gnmetd, 'photocell', dtmetd).join(' '))
            ]);

        this.addPaletteFunctions('electrical\Waveforms', 'Electrical / Waveforms', false,
            [
                this.createVertexTemplateEntry(mew + 'pulse_1;',
                    90, 90, '', 'Pulse', null, null, this.getTagsForStencil(gnmew, 'pulse_1', dtmew).join(' ')),
                this.createVertexTemplateEntry(mew + 'pulse_2;',
                    90, 90, '', 'Pulse', null, null, this.getTagsForStencil(gnmew, 'pulse_2', dtmew).join(' ')),
                this.createVertexTemplateEntry(mew + 'sawtooth;',
                    90, 40, '', 'Sawtooth', null, null, this.getTagsForStencil(gnmew, 'sawtooth', dtmew).join(' ')),
                this.createVertexTemplateEntry(mew + 'sine_wave;',
                    90, 66.18, '', 'Sine Wave', null, null, this.getTagsForStencil(gnmew, 'sine_wave', dtmew).join(' ')),
                this.createVertexTemplateEntry(mew + 'slow_square_wave;',
                    90, 80, '', 'Chopped Square Wave', null, null, this.getTagsForStencil(gnmew, 'slow_square_wave', dtmew).join(' ')),
                this.createVertexTemplateEntry(mew + 'square_wave;',
                    90, 80, '', 'square_wave', null, null, this.getTagsForStencil(gnmew, 'square_wave', dtmew).join(' ')),
                this.createVertexTemplateEntry(mew + 'step_1;',
                    90, 90, '', 'Step', null, null, this.getTagsForStencil(gnmew, 'step_1', dtmew).join(' ')),
                this.createVertexTemplateEntry(mew + 'step_2;',
                    90, 90, '', 'Step', null, null, this.getTagsForStencil(gnmew, 'step_2', dtmew).join(' '))
            ]);

        this.addPaletteFunctions('electrical\RotMech', 'Electrical / Rotating Equipment & Mechanical Functions', false,
            [
                this.createVertexTemplateEntry('verticalLabelPosition=middle;shadow=0;dashed=0;align=center;fillColor=#ffffff;html=1;verticalAlign=middle;strokeWidth=1;shape=ellipse;fontSize=32;fontColor=#000000;perimeter=ellipsePerimeter;',
                    100, 100, 'M', 'Rotating Machine', null, null, this.getTagsForStencil(gnmerm, 'rotating machine', dtmerm).join(' ')),
                this.createVertexTemplateEntry(merm + 'armature;pointerEvents=1;',
                    100, 100, '', 'Armature', null, null, this.getTagsForStencil(gnmerm, 'armature', dtmerm).join(' ')),
                this.createVertexTemplateEntry(merm + 'field;pointerEvents=1;',
                    90, 15, '', 'Field', null, null, this.getTagsForStencil(gnmerm, 'field', dtmerm).join(' ')),
                this.createVertexTemplateEntry(mem + 'permanent_magnet;pointerEvents=1;',
                    20, 70, '', 'Permanent Magnet', null, null, this.getTagsForStencil(gnmerm, 'permanent magnet', dtmerm).join(' ')),
                this.createVertexTemplateEntry(merm + 'winding_connection;',
                    100, 100, '', 'Winding Connection', null, null, this.getTagsForStencil(gnmerm, 'winding connection', dtmerm).join(' ')),
                this.createVertexTemplateEntry(merm + 'synchro;',
                    80, 100, '', 'Synchro', null, null, this.getTagsForStencil(gnmerm, 'synchro', dtmerm).join(' ')),
                this.createVertexTemplateEntry('verticalLabelPosition=bottom;shadow=0;dashed=0;align=center;fillColor=#ffffff;html=1;verticalAlign=top;strokeWidth=1;shape=trapezoid;perimeter=none;',
                    75, 25, '', 'Brake', null, null, this.getTagsForStencil(gnmerm, 'brake', dtmerm).join(' ')),
                this.createVertexTemplateEntry(merm + 'gearing;pointerEvents=1;',
                    100, 64, '', 'Gearing', null, null, this.getTagsForStencil(gnmerm, 'gearing', dtmerm).join(' ')),
                this.createVertexTemplateEntry(merm + 'verticalLabelPosition=bottom;shadow=0;dashed=0;align=center;fillColor=#000000;html=1;verticalAlign=top;strokeWidth=1;shape=mxgraph.electrical.rot_mech.rotation;',
                    69, 54, '', 'Rotation', null, null, this.getTagsForStencil(gnmerm, 'rotation', dtmerm).join(' ')),
                this.createVertexTemplateEntry(merm + 'clutch;pointerEvents=1;',
                    100, 20, '', 'Clutch', null, null, this.getTagsForStencil(gnmerm, 'clutch', dtmerm).join(' ')),
                this.createVertexTemplateEntry(merm + 'clutch_2;pointerEvents=1;',
                    90, 60, '', 'Clutch', null, null, this.getTagsForStencil(gnmerm, 'clutch', dtmerm).join(' ')),
                this.createVertexTemplateEntry(merm + 'delayed_action;pointerEvents=1;',
                    72, 50, '', 'Delayed Action', null, null, this.getTagsForStencil(gnmerm, 'delayed action', dtmerm).join(' ')),
                this.createVertexTemplateEntry(merm + 'manual_control;pointerEvents=1;',
                    50, 50, '', 'Manual Control', null, null, this.getTagsForStencil(gnmerm, 'manual control', dtmerm).join(' ')),
                this.createVertexTemplateEntry(merm + 'blocking_device;pointerEvents=1;',
                    100, 15, '', 'Blocking Device', null, null, this.getTagsForStencil(gnmerm, 'blocking device', dtmerm).join(' ')),
                this.createVertexTemplateEntry(merm + 'latching_device;pointerEvents=1;',
                    100, 22, '', 'Latching Device', null, null, this.getTagsForStencil(gnmerm, 'latching device', dtmerm).join(' ')),
                this.createVertexTemplateEntry(merm + 'mechanical_interlock;pointerEvents=1;',
                    100, 30, '', 'Mechanical Interlock', null, null, this.getTagsForStencil(gnmerm, 'mechanical interlock', dtmerm).join(' ')),
                this.createVertexTemplateEntry(merm + 'automatic_return;pointerEvents=1;',
                    100, 12, '', 'Automatic Return', null, null, this.getTagsForStencil(gnmerm, 'automatic_return', dtmerm).join(' ')),
                this.createVertexTemplateEntry(merm + 'detent;pointerEvents=1;',
                    100, 8, '', 'Detent', null, null, this.getTagsForStencil(gnmerm, 'detent', dtmerm).join(' '))
            ]);

        var sb = this;

        var fns =
            [
                this.createVertexTemplateEntry(metr + 'bus_width;pointerEvents=1;',
                    130, 156, '', 'Bus Width', null, null, this.getTagsForStencil(gnmetr, 'bus width', dtmetr).join(' ')),
                this.createVertexTemplateEntry(metr + 'line_concentrator;',
                    130, 130, '', 'Line Concentrator', null, null, this.getTagsForStencil(gnmetr, 'line concentrator', dtmetr).join(' ')),
                this.createVertexTemplateEntry(metr + 'cable_group;pointerEvents=1;',
                    130, 130, '', 'Cable Group', null, null, this.getTagsForStencil(gnmetr, 'cable group', dtmetr).join(' ')),
                this.createVertexTemplateEntry(metr + 'overground_enclosure;',
                    130, 136, '', 'Overground Enclosure', null, null, this.getTagsForStencil(gnmetr, 'overground enclosure', dtmetr).join(' ')),
                this.createVertexTemplateEntry(metr + 'optical_fiber;',
                    130, 80, '', 'Optical Fiber', null, null, this.getTagsForStencil(gnmetr, 'optical fiber', dtmetr).join(' ')),
                this.createVertexTemplateEntry('verticalLabelPosition=bottom;shadow=0;dashed=0;align=center;fillColor=#ffffff;strokeColor=#000000;html=1;verticalAlign=top;strokeWidth=1;shape=ellipse;',
                    10, 10, '', 'Terminal', null, null, this.getTagsForStencil(gnmetr, 'terminal', dtmetr).join(' ')),
                this.createVertexTemplateEntry(metr + 'terminal_3_phase;pointerEvents=1;',
                    43, 10, '', 'Terminal 3 Phase', null, null, this.getTagsForStencil(gnmetr, 'Terminal 3 Phase', dtmetr).join(' ')),
                this.createVertexTemplateEntry('verticalLabelPosition=middle;shadow=0;dashed=0;align=center;fillColor=#ffffff;strokeColor=#000000;html=1;verticalAlign=middle;strokeWidth=1;shape=ellipse;fontColor=#000000;fontSize=50;fontStyle=1;perimeter=ellipsePerimeter;',
                    130, 130, 'T', 'Terminal', null, null, this.getTagsForStencil(gnmetr, 'terminal', dtmetr).join(' ')),
                this.createVertexTemplateEntry(metr + 'line_cable;',
                    130, 60, '', 'Line/Cable', null, null, this.getTagsForStencil(gnmetr, 'line cable', dtmetr).join(' ')),
                this.createVertexTemplateEntry(metr + 'anticreepage_device;pointerEvents=1;',
                    130, 88, '', 'Anticreepage Device', null, null, this.getTagsForStencil(gnmetr, 'anticreepage device', dtmetr).join(' ')),
                this.createVertexTemplateEntry(metr + 'testPoint;',
                    60, 130, '', 'Test Point', null, null, this.getTagsForStencil(gnmetr, 'test point', dtmetr).join(' ')),
                this.createEdgeTemplateEntry('endArrow=none;html=1;strokeColor=#000000;strokeWidth=1;',
                    100, 0, '', 'Transmission Path', null, this.getTagsForStencil(gnmess, '', 'transmission path').join(' ')),
                this.createEdgeTemplateEntry('endArrow=classicThin;html=1;strokeColor=#000000;strokeWidth=1;endSize=20;',
                    100, 0, '', 'Direction of Flow', null, this.getTagsForStencil(gnmess, '', 'direction flow').join(' ')),
                this.createVertexTemplateEntry(metr + 'straightBus;',
                    90, 130, '', 'Straight Bus', null, null, this.getTagsForStencil(gnmetr, 'straight bus', dtmetr).join(' ')),
                this.createVertexTemplateEntry('html=1;shadow=0;dashed=0;align=center;verticalAlign=middle;shape=mxgraph.arrows2.bendArrow;dy=15;dx=38;notch=0;arrowHead=55;rounded=0;strokeColor=#000000;strokeWidth=1;fillColor=#FFFFFF;',
                    130, 130, '', 'Elbow Bus', null, null, this.getTagsForStencil(gnmetr, 'elbow bus', dtmetr).join(' ')),
                this.createVertexTemplateEntry('html=1;shadow=0;dashed=0;align=center;verticalAlign=middle;shape=mxgraph.arrows2.bendArrow;dy=15;dx=38;notch=0;arrowHead=55;rounded=0;strokeColor=#000000;strokeWidth=1;fillColor=#FFFFFF;flipH=1;',
                    130, 130, '', 'Elbow Bus', null, null, this.getTagsForStencil(gnmetr, 'elbow bus', dtmetr).join(' ')),
                this.createVertexTemplateEntry(metr + '2_line_bus;',
                    130, 25, '', '2-Line Bus', null, null, this.getTagsForStencil(gnmetr, '2 two line bus', dtmetr).join(' ')),
                this.createVertexTemplateEntry(metr + '3_line_bus;',
                    130, 30, '', '3-Line Bus', null, null, this.getTagsForStencil(gnmetr, '3 three line bus', dtmetr).join(' ')),
                this.createVertexTemplateEntry(metr + '4_line_bus;',
                    130, 75, '', '4-Line Bus', null, null, this.getTagsForStencil(gnmetr, '3 three line bus', dtmetr).join(' ')),
                this.createVertexTemplateEntry(metr + '8_line_bus;',
                    130, 180, '', '8-Line Bus', null, null, this.getTagsForStencil(gnmetr, '3 three line bus', dtmetr).join(' ')),
                this.createVertexTemplateEntry(metr + 'twoLineBusElbow;notch=25;',
                    120, 120, '', '2-Line Bus Elbow', null, null, this.getTagsForStencil(gnmetr, '2 two line bus elbow', dtmetr).join(' ')),
                this.createVertexTemplateEntry(metr + 'threeLineBusElbow;notch=30;',
                    120, 120, '', '3-Line Bus Elbow', null, null, this.getTagsForStencil(gnmetr, '3 two line bus elbow', dtmetr).join(' ')),
                this.createVertexTemplateEntry(metr + 'fourLineBusElbow;notch=75;',
                    120, 120, '', '4-Line Bus Elbow', null, null, this.getTagsForStencil(gnmetr, '4 two line bus elbow', dtmetr).join(' ')),
                this.createVertexTemplateEntry(metr + 'eightLineBusElbow;notch=180;',
                    200, 200, '', '8-Line Bus Elbow', null, null, this.getTagsForStencil(gnmetr, '8 two line bus elbow', dtmetr).join(' '))
            ];

        this.addPalette('electrical\Transmission', 'Electrical / Transmission Paths', false, mxUtils.bind(this, function (content) {
            for (var i = 0; i < fns.length; i++) {
                content.appendChild(fns[i](content));
            }
        }));
    };

})();

(function () {
    // Adds iOS shapes
    Sidebar.prototype.addIosPalette = function () {
        // Avoids having to bind all functions to "this"
        sb = this;

        //default tags
        var dt = 'ios icon ';

        var sizeX = 200; //reference size for iPhone and all other iOS shapes

        var sizeY = 2 * sizeX; //change only sizeX, to avoid changing aspect ratio

        var s = mxConstants.STYLE_VERTICAL_LABEL_POSITION + '=bottom;' + mxConstants.STYLE_VERTICAL_ALIGN + '=top;html=1;shadow=0;dashed=0;strokeWidth=1;shape=mxgraph.ios.';
        var s2 = mxConstants.STYLE_STROKEWIDTH + '=1;html=1;shadow=0;dashed=0;shape=mxgraph.ios.';
        var s3 = mxConstants.STYLE_VERTICAL_LABEL_POSITION + '=top;html=1;shadow=0;dashed=0;' + mxConstants.STYLE_VERTICAL_ALIGN + '=bottom;strokeWidth=1;shape=mxgraph.ios.';
        var s4 = 'html=1;shadow=0;dashed=0;shape=mxgraph.ios.';
        var gn = 'mxgraph.ios';

        var fns =
            [

                this.createVertexTemplateEntry(s + 'iPhone;bgStyle=bgGreen;fillColor=#aaaaaa;', sizeX, sizeY, '', 'iPhone (portrait)', null, null, null),
                this.createVertexTemplateEntry(s + 'iPhone;direction=north;bgStyle=bgGreen;fillColor=#aaaaaa;', sizeY, sizeX, '', 'iPhone (landscape)', null, null, null),
                this.createVertexTemplateEntry(s + 'iPad;bgStyle=bgGreen;fillColor=#aaaaaa;', sizeX * 2.425, sizeY * 1.5625, '', 'iPad (portrait)', null, null, null),
                this.createVertexTemplateEntry(s + 'iPad;direction=north;bgStyle=bgGreen;fillColor=#aaaaaa;', sizeY * 1.5625, sizeX * 2.425, '', 'iPad (landscape)', null, null, null),
                this.createVertexTemplateEntry(s + 'iBgFlat;strokeColor=#18211b;fillColor=#ffffff;', sizeX * 0.875, sizeY * 0.7, '', 'iPad background (white)', null, null, null),
                this.createVertexTemplateEntry(s + 'iBgFlat;strokeColor=#18211b;fillColor=#1f2923;', sizeX * 0.875, sizeY * 0.7, '', 'iPad background (green)', null, null, null),
                this.createVertexTemplateEntry(s + 'iBgFlat;strokeColor=#18211b;fillColor=#dddddd;', sizeX * 0.875, sizeY * 0.7, '', 'iPad background (gray)', null, null, null),
                this.createVertexTemplateEntry(s + 'iBgStriped;strokeColor=#18211b;fillColor=#5D7585;strokeColor2=#657E8F;', sizeX * 0.875, sizeY * 0.7, '', 'iPad background (striped)', null, null, null),
                this.createVertexTemplateEntry(s + 'iBgMap;strokeColor=#18211b;fillColor=#ffffff;strokeColor2=#008cff;fillColor2=#96D1FF;', sizeX * 0.875, sizeY * 0.7, '', 'iPad background (map)', null, null, null),
                this.addDataEntry(null, 165, 50, 'Button bar',
                    '3ZfdboIwFMefhltSKCjeIptZsl3tCTqo0KxQUurUPf0OpfgJiVN0OowJ55z20P7Ov01r4Wm+mklSZm8iodzCTxaeSiFU85avppRzy0UssXBkuS6Cv+U+90QdHUUlkbRQp3Rwmw5fhC9o42kclVpz48hUDsOKHAuHVUYSsQQDgZGQKqOJMSBS1u3zVVrPxWaisqWkMQwilO/su475dTslxSedCi6kzo49/UBkzjjf8c/1A37IlzCYTRsrRAHJQjNuKhVd9c5du8zEZ1TkVMk1NFmyRGWmxchvumWUpZnp5jfMEKkaO9103ZKEFwOzGyw+AvuiaA4eZzjASpThQilRHEDeRWlwHXGPvfoHEcJZCgkiTud1saqSxKxIX7UVOfWn56JQJntgzJ1EI/2cWhH3vIo4ru1fXhOvQ+yjVG3GPkRNSBFnNZpDTBvemqb5kHMqNtyNre3gGcGu9xLsQkUdTAdQud+ncny9bQQ9pMJNaVpitxH86GEF79+p4Md9gveGI/ohYE/P/8nObiqEx/ZNlR88rPLHd6r8SZ/yr3hiPNzqAa4fjf3g+CRpFsOlku89dUIMoSDWsQGWw1bkt1kOrQAecD1M7nQ9OE4H0r+/Ov3menTmYfyM6xGY2zutju1deX8A'),

                this.createVertexTemplateEntry(s + 'iButtonBar;buttonText=Item 1,+Item 2,Item 3,Item 4;textColor=#999999;textColor2=#ffffff;strokeColor=#444444;strokeColor2=#c4c4c4;', 165, 80, '', 'Button Bar', null, null, null),

                this.addEntry(null, function () {
                    var bg = new mxCell('', new mxGeometry(0, 0, 175, 15), s4 + 'iAppBar;strokeWidth=1;');
                    bg.vertex = true;
                    var text1 = new mxCell('CARRIER', new mxGeometry(0, 2, 50, 13), s4 + 'anchor;align=left;fontSize=8;spacingLeft=18;');
                    text1.vertex = true;
                    bg.insert(text1);
                    var text2 = new mxCell('11:55PM', new mxGeometry(60, 2, 50, 13), s4 + 'rect;fontSize=8;strokeColor=none;fillColor=none;');
                    text2.vertex = true;
                    bg.insert(text2);

                    return sb.createVertexTemplateFromCells([bg], bg.geometry.width, bg.geometry.height, 'App bar (portrait)');
                }),

                this.addEntry(null, function () {
                    var bg = new mxCell('', new mxGeometry(0, 0, 280, 15), s4 + 'iAppBar;strokeWidth=1;');
                    bg.vertex = true;
                    var text1 = new mxCell('CARRIER', new mxGeometry(0, 2, 50, 13), s4 + 'anchor;align=left;fontSize=8;spacingLeft=18;');
                    text1.vertex = true;
                    bg.insert(text1);
                    var text2 = new mxCell('11:55PM', new mxGeometry(115, 2, 50, 13), s4 + 'rect;fontSize=8;strokeColor=none;fillColor=none;');
                    text2.vertex = true;
                    bg.insert(text2);

                    return sb.createVertexTemplateFromCells([bg], bg.geometry.width, bg.geometry.height, 'App bar (landscape)');
                }),

                this.addEntry(null, function () {
                    var bg = new mxCell('', new mxGeometry(0, 0, 175, 15), s4 + 'iTopBar2;opacity=50;fillColor=#999999;strokeColor=#cccccc;strokeWidth=1;');
                    bg.vertex = true;
                    var text1 = new mxCell('CARRIER', new mxGeometry(0, 2, 50, 13), s4 + 'rect;align=left;fontSize=7.5;spacingLeft=18;fontColor=#cccccc;textOpacity=50;strokeColor=none;fillColor=none;');
                    text1.vertex = true;
                    bg.insert(text1);
                    var text2 = new mxCell('11:15AM', new mxGeometry(60, 2, 50, 13), s4 + 'rect;fontSize=7.5;fontColor=#cccccc;textOpacity=50;strokeColor=none;fillColor=none;');
                    text2.vertex = true;
                    bg.insert(text2);

                    return sb.createVertexTemplateFromCells([bg], bg.geometry.width, bg.geometry.height, 'Top bar');
                }),

                this.addEntry(null, function () {
                    var bg = new mxCell('', new mxGeometry(0, 0, 175, 15), s4 + 'iTopBarLocked;strokeWidth=1;');
                    bg.vertex = true;
                    var text1 = new mxCell('CARRIER', new mxGeometry(0, 2, 50, 13), s4 + 'anchor;align=left;fontSize=7.5;spacingLeft=18;fontColor=#cccccc;');
                    text1.vertex = true;
                    bg.insert(text1);

                    return sb.createVertexTemplateFromCells([bg], bg.geometry.width, bg.geometry.height, 'Top bar locked');
                }),

                this.createVertexTemplateEntry(s2 + 'iButton;strokeColor=#444444;fontColor=#ffffff;buttonText=;fontSize=8;fillColor=#dddddd;fillColor2=#3D5565;whiteSpace=wrap;align=center;',
                    sizeX * 0.2175, sizeY * 0.0375, 'Button', 'Button', null, null, null),
                this.createVertexTemplateEntry(s2 + 'iButtonBack;strokeColor=#444444;fontColor=#ffffff;buttonText=;fontSize=8;fillColor=#dddddd;fillColor2=#3D5565;spacingLeft=10;whiteSpace=wrap;align=center;',
                    sizeX * 0.2175, sizeY * 0.0375, 'Button', 'Back button', null, null, null),
                this.createVertexTemplateEntry(s2 + 'iButtonFw;strokeColor=#444444;fontColor=#ffffff;buttonText=;fontSize=8;fillColor=#dddddd;fillColor2=#3D5565;spacingRight=10;whiteSpace=wrap;align=center;',
                    sizeX * 0.2175, sizeY * 0.0375, 'Button', 'Forward button', null, null, null),
                this.createVertexTemplateEntry(s + 'iPrevNext;strokeColor=#444444;fillColor=#dddddd;fillColor2=#3D5565;fillColor3=#ffffff;align=center;',
                    sizeX * 0.2175, sizeY * 0.0375, '', 'Prev/next button', null, null, null),
                this.createVertexTemplateEntry(s2 + 'iTextInput;strokeColor=#444444;fontColor=#000000;buttonText=;fontSize=8;fillColor=#ffffff;whiteSpace=wrap;align=left;',
                    sizeX * 0.2175, sizeY * 0.0375, 'Default text', 'Text input', null, null, null),
                this.addDataEntry(null, 165, 50, 'Radio Buttons',
                    '7VbbbsIwDP2avqI2AcTrgI2XTZu2/UAgpo2WNlWSMdjXz0kMu0AlNLa9jEiV6nNsyz6nkZrxSb2eWdFWN0aCzvhlxifWGJ/e6vUEtM5YrmTGpxljOT4Zu+pgi8jmrbDQ+GMKWCpYCf0MCUmA8xtNQOVrHGtaZHzsKiHNCwY5BlK4CiQFyLQhv16XYZeeMq5nLSxwiLF9UK+B4yHPW/MEE6ONjd35MB5klkrrD/gyHsSxn1S4zZZrTAOhKSyerVMruAeX2ue0ClgP6045IkRazMDU4O0GU16U9BVlDAeprAJVVlQ2oO7Cpbjclb6Liy+k72Gt+Z7Wt61XpkGs2FN9Kyi2UK1LG+OiYq6BJP8imIwHcaFV2SCmYRnUd61YqKa8jtGUhULTeLJkROEhQ7SYg74zTsUZ+dQmNcZBYLUQ+voLXyspw3C7hAsaZEfQKI+mpa/hKMfYYceogPXIrQ2JvI0/OHrIz9Pt7HfbuX+JznZ+z85i+EduDrrd5Ke72Y/n37vJRn92O4fdfvbPt/OH/OwXv+Mmhu+/QJH79If0Bg=='),
                this.addDataEntry(null, 165, 50, 'Checkboxes',
                    '7ZZbT8IwFMc/zV7J1gLBRxnKCyZG/AJlPWyN3bq0RYef3tOLeGEQEoUXbbKk55rT/29NmtC87uaatdWd4iATepPQXCtlw67ucpAyIangCZ0lhKT4JeT2QDTz0bRlGhp7SgEJBc9MbiB4gsPYrYyOytY41ixL6NRUjKsXNFI0ODMV8GhgpHX5dVe6swyEMgOtocAhpnopXl2Mujyr1RPkSirtu9OxXxhZCyk/+dd+oR/7cYGneY81qgHXFIqNNuIZHsCE9m6MeBrQFrqDinhXlGMOqgart5jyIritYsZ4FMoqEGUVy0ZByZSZYJe70g99cRMl7peb7sm9BGtFU6IzO5/y6b6+3C/0MynKBn0S1q7EtKzAeRbemhFXqBob+0yi2cdPshXIe2WEFcr100G5qYMhCiYX3+K14NwddJdwHQfZBeIoj6qNP89JdEk/3VhABpHsNgJ5tz/R72P/c/TDI+jPeOn+0R9Cn40vRH50hDz9PfJFBcXTSnX7wK/8+vPAyeRil318BPnw/7Jfnv0wOw95ND8eaz725S33Bg=='),

                this.createVertexTemplateEntry(s2 + 'iComboBox;spacingTop=2;spacingLeft=2;align=left;strokeColor=#444444;fontColor=#666666;buttonText=;fontSize=8;fillColor=#dddddd;fillColor2=#3D5565;',
                    sizeX * 0.29, sizeY * 0.0375, 'Option 1', 'Combobox', null, null, null),
                this.createVertexTemplateEntry(s2 + 'iOnOffButton;mainText=;strokeColor=#444444;fontSize=9;fontColor=#ffffff;spacingRight=14;buttonState=on', sizeX * 0.2175, sizeY * 0.0375,
                    'ON', 'On-off button', null, null, null),
                this.createVertexTemplateEntry(s2 + 'iTextInput;strokeColor=#444444;fontColor=#000000;align=left;buttonText=;fontSize=8;fillColor=#ffffff;', sizeX * 0.2175, sizeY * 0.0375,
                    '********', 'Password field', null, null, null),
                this.addDataEntry(null, 150, 100, 'Alert Box',
                    'rVVNb6MwEP01PjaycdI2x02629NKq+awZwsGbNXYyHYb6K/fMTgNCLJKP5CQmDdf9nszgvB93T460cjftgBN+E/C987aMHzV7R60JhlVBeEPJMsoviT7dcHLei9thAMTrknIhoRXoV9gQH5ocAGhAnzuVBOUNWgFaBG8JRlnlPDdkpN6yK0p8EMrA0NdHzqd6spQ4+0eGGZ7KQp7RKMvJbyEIhnoaWJ83VaRkpWyflUKk3dPT5DjhXbuoN5iwH0MDs4+w95q6/oWvOgf9JRK6xG+3t6xbczAooVCZkY+tuXsNvpsI3IVulg7nqS0k7CyfxKezrBF8yhVgAOmRuCIZ0ZMaFUZNHPsBJi/Sxwjr9Be1KmHkkiPYGsIrsOQoyqCTBGbQUsqQVXylEYTKPwAVO+5Z9nxIym/PAV8NgWHWEQqU8V2omnAoEbfJikqKiOzYzYZ/w/rSzQ78Jj5N/HDruU5+xzP2WbAHGgR1CtM6n+F+/WM+91LCHGvvott56a7w+djfIn32Yqd9+D6Fcs3OQCbr9iSqF+RMCXQVZKqmxQYCXy/pC/9oL6p/x+rTDg3v1nTSfOb09ycStiy9BBmA/J+jaWZQfP8RxjCxz+Mfw=='),
                this.addDataEntry(null, 150, 100, 'Dialog Box',
                    '7VZNb6MwEP01PjbCdkk315BuD6vVrprDni08YKsGs8ZtQn99x+A0IJJVtu2pKhKS59P2e28QhGfV/s6JRv20Egzht4Rnzlo/rKp9BsYQlmhJ+IYwluBL2PczUdpHk0Y4qP0lBWwoeBLmEQbPRgtjS/T9fYTWa1vj0sPeE7YkjNOE8PUskrSQ21riwugahpat70xsqXyFF9tQLG2VkHaHRugjRatARgMjTciv9mVAY6FtuyhEnXf395DjXdZuq59DwreQ7J19gMwa6/otuOwfjBTamJH/enVDV6ECm0qNoIxidMXpMsRsI3Ltu9A7nKSwk7Sif6I/nmGF5k5pD1ssDY4dnhl9wuiyRjPHnQDr1xFecAjUWYp6V+TnDmwF3nWYstPSq5iRDjQmCnSpDmVJdIp2cJSvtUfGcRFJPy0APhPANjRRug4aQE4aqJGjD6MUGVUB2TGalP8D9VMwO2ix8k/Eh16KM3sbziwdfA6M8PoJJv3fg/31DPsM4cGPwIeh7dx0dvhcxudwn43YcQ4uH7E8zQHofMROkfoeCmNBsjhw1U06jBhepicITv6T4HiA31bX/rj7FWeL6fZXh+McmtiiaMHPNPJ6k4tkk85k8+vHl2TeLJmbzycZNI+/EEP6+A/jBQ=='),

                this.createVertexTemplateEntry(s2 + 'iLockButton;fontColor=#cccccc;fontSize=13;mainText=;spacingLeft=50;spacingRight=10;align=center;', sizeX * 0.87, sizeY * 0.125, 'slide to unlock', 'Lock button', null, null, null),
                this.createVertexTemplateEntry(s + 'iArrowIcon;fillColor=#8BbEff;fillColor2=#135Ec8;strokeColor=#ffffff;', sizeX * 0.075, sizeY * 0.0375, '', 'Arrow', null, null, null),
                this.createVertexTemplateEntry(s + 'iDeleteIcon;fillColor=#e8878E;fillColor2=#BD1421;strokeColor=#ffffff;', sizeX * 0.075, sizeY * 0.0375, '', 'Delete', null, null, null),
                this.createVertexTemplateEntry(s + 'iAddIcon;fillColor=#7AdF78;fillColor2=#1A9917;strokeColor=#ffffff;', sizeX * 0.075, sizeY * 0.0375, '', 'Add', null, null, null),
                this.createVertexTemplateEntry(s + 'iInfoIcon;fillColor=#8BbEff;fillColor2=#135Ec8;strokeColor=#ffffff;', sizeX * 0.075, sizeY * 0.0375, '', 'Info', null, null, null),
                this.createVertexTemplateEntry(s + 'iSortFindIcon;fillColor=#8BbEff;fillColor2=#135Ec8;strokeColor=#ffffff;', sizeX * 0.075, sizeY * 0.0375, '', 'Sort/find', null, null, null),
                this.createVertexTemplateEntry(s + 'iCheckIcon;fillColor=#e8878E;fillColor2=#BD1421;strokeColor=#ffffff;', sizeX * 0.075, sizeY * 0.0375, '', 'Check', null, null, null),
                this.createVertexTemplateEntry(s + 'iKeybLett;', sizeX * 0.87, sizeY * 0.25, '', 'Keyboard (letters)', null, null, null),
                this.createVertexTemplateEntry(s + 'iKeybNumb;', sizeX * 0.87, sizeY * 0.25, '', 'Keyboard (numbers)', null, null, null),
                this.createVertexTemplateEntry(s + 'iKeybSymb;', sizeX * 0.87, sizeY * 0.25, '', 'Keyboard (symbols)', null, null, null),
                this.createVertexTemplateEntry(s + 'iDeleteApp;fillColor=#cccccc;fillColor2=#000000;strokeColor=#ffffff;', sizeX * 0.075, sizeY * 0.0375, '', 'Delete app', null, null, null),
                this.createVertexTemplateEntry(s + 'iDir;', sizeX * 0.5, sizeY * 0.25, '', 'Direction', null, null, null),
                this.createVertexTemplateEntry(s2 + 'iLocBar;align=left;spacingLeft=4;spacingBottom=4;fontColor=#ffffff;fontSize=10;barPos=80;pointerPos=bottom;buttonText=5th Street Music Store', sizeX * 0.775, sizeY * 0.08125, '', 'Location bar', null, null, null),
                this.createVertexTemplateEntry(s + 'iCallDialog;', sizeX * 0.75, sizeY * 0.3125, '', 'Call Dialog', null, null, null),
                this.createVertexTemplateEntry(s + 'iCallButtons;', sizeX * 0.87, sizeY * 0.575, '', 'Call buttons', null, null, null),
                this.createVertexTemplateEntry(s2 + 'iOption;barPos=80;pointerPos=bottom;buttonText=Option;fontSize=10;fontColor=#ffffff;spacingBottom=6;', sizeX * 0.375, sizeY * 0.06875, '', 'Option', null, null, null),
                this.createVertexTemplateEntry(s + 'iAlphaList;fontSize=7.5;', sizeX * 0.075, sizeY * 0.5625, '', 'Alphabet list', null, null, null),
                this.createVertexTemplateEntry(s2 + 'iHorButtonBar;buttonText=Item 1,+Item 2,Item 3,Item 4;textColor=#999999;textColor2=#ffffff;strokeColor=#444444;strokeColor2=#c4c4c4;fillColor=#ffffff;fillColor2=#008cff;fontSize=8;', sizeX * 0.825, sizeY * 0.03125,
                    '', 'Horizontal button bar', null, null, null),
                this.createVertexTemplateEntry(s3 + 'iPin;fillColor2=#00dd00;fillColor3=#004400;strokeColor=#006600;', sizeX * 0.05, sizeY * 0.0625, '', 'Pin', null, null, null),
                this.createVertexTemplateEntry(s3 + 'iPin;fillColor2=#dd0000;fillColor3=#440000;strokeColor=#660000;', sizeX * 0.05, sizeY * 0.0625, '', 'Pin', null, null, null),
                this.createVertexTemplateEntry(s3 + 'iPin;fillColor2=#ccccff;fillColor3=#0000ff;strokeColor=#000066;', sizeX * 0.05, sizeY * 0.0625, '', 'Pin', null, null, null),
                this.createVertexTemplateEntry(s3 + 'iPin;fillColor2=#ffff00;fillColor3=#888800;strokeColor=#999900;', sizeX * 0.05, sizeY * 0.0625, '', 'Pin', null, null, null),
                this.createVertexTemplateEntry(s3 + 'iPin;fillColor2=#ffa500;fillColor3=#885000;strokeColor=#997000;', sizeX * 0.05, sizeY * 0.0625, '', 'Pin', null, null, null),
                this.createVertexTemplateEntry(s + 'iVideoControls;barPos=20;', sizeX * 0.87, sizeY * 0.125, '', 'Video controls', null, null, null),

                this.addEntry(null, function () {
                    var bg = new mxCell('Page title', new mxGeometry(0, 0, 175, 30), s4 + 'iURLBar;verticalAlign=top;fontSize=8;spacingTop=-5;align=center;');
                    bg.vertex = true;
                    var text1 = new mxCell('https://www.draw.io/', new mxGeometry(5, 12, 115, 13), s4 + 'anchor;fontSize=8;spacingLeft=3;align=left;spacingTop=2;');
                    text1.vertex = true;
                    bg.insert(text1);
                    var text2 = new mxCell('Cancel', new mxGeometry(137, 12, 32, 13), s4 + 'anchor;fontSize=8;fontColor=#ffffff;spacingTop=2;');
                    text2.vertex = true;
                    bg.insert(text2);

                    return sb.createVertexTemplateFromCells([bg], bg.geometry.width, bg.geometry.height, 'URL bar');
                }),

                this.createVertexTemplateEntry(s + 'iSlider;barPos=20;', sizeX * 0.75, sizeY * 0.025, '', 'Slider', null, null, null),
                this.createVertexTemplateEntry(s + 'iProgressBar;barPos=40;', sizeX * 0.75, sizeY * 0.025, '', 'Progress bar', null, null, null),
                this.createVertexTemplateEntry(s + 'iCloudProgressBar;barPos=20;', sizeX * 0.75, sizeY * 0.025, '', 'Cloud progress bar', null, null, null),
                this.createVertexTemplateEntry(s2 + 'iDownloadBar;verticalAlign=top;spacingTop=-4;fontSize=8;fontColor=#ffffff;buttonText=' + ';barPos=30;align=center;', sizeX * 0.87, sizeY * 0.075, 'Downloading 2 of 6', 'Download bar', null, null, null),
                this.createVertexTemplateEntry(s2 + 'iScreenNameBar;fillColor2=#000000;fillColor3=#ffffff;buttonText=;fontColor=#ffffff;fontSize=10;whiteSpace=wrap;align=center;', sizeX * 0.87, sizeY * 0.0625, 'Screen Name', 'Screen name bar', null, null, null),
                this.createVertexTemplateEntry(s + 'iIconGrid;fillColor=#ffffff;strokeColor=#000000;gridSize=3,3;', sizeX * 0.75, sizeY * 0.375, '', 'Icon grid', null, null, null),
                this.createVertexTemplateEntry(s2 + 'iCopy;fillColor=#000000;strokeColor=#000000;buttonText=;fontColor=#ffffff;spacingBottom=6;fontSize=9;fillColor2=#000000;fillColor3=#ffffff;align=center;', sizeX * 0.2, sizeY * 0.06875, 'Copy', 'Copy', null, null, null),

                this.addEntry(null, function () {
                    var bg = new mxCell('Copy', new mxGeometry(sizeX * 0.05, 0, sizeX * 0.2, sizeY * 0.06875), s4 + 'iCopy;fillColor=#000000;strokeColor=#000000;buttonText=;fontColor=#ffffff;spacingBottom=6;fontSize=9;fillColor2=#000000;fillColor3=#ffffff;align=center;');
                    bg.vertex = true;
                    var area1 = new mxCell('', new mxGeometry(0, sizeY * 0.06875, sizeX * 0.3, sizeY * 0.13125), s4 + 'rect;fillColor=#2266ff;strokeColor=none;opacity=30;');
                    area1.vertex = true;

                    return sb.createVertexTemplateFromCells([bg, area1], sizeX * 0.3, sizeY * 0.2, 'Copy Area');
                }),

                this.createVertexTemplateEntry(s + 'iHomePageControl;fillColor=#666666;strokeColor=#cccccc;', sizeX * 0.25, sizeY * 0.0125, '', 'Home page control', null, null, null),
                this.createVertexTemplateEntry(s + 'iPageControl;fillColor=#666666;strokeColor=#cccccc;', sizeX * 0.25, sizeY * 0.0125, '', 'Page control', null, null, null)

            ];

        this.addPalette('ios', 'iOS6', false, mxUtils.bind(this, function (content) {
            for (var i = 0; i < fns.length; i++) {
                content.appendChild(fns[i](content));
            }
        }));
    };

})();

(function () {
    // Adds iOS7 shapes
    Sidebar.prototype.addIos7Palette = function () {
        // Avoids having to bind all functions to "this"
        var sb = this;

        var sizeX = 200; //reference size for iPhone and all other iOS shapes

        var sizeY = 2 * sizeX; //change only sizeX, to avoid changing aspect ratio
        var sc = 0.3; // stencil scaling

        //default tags
        var dt = 'ios icon ';

        var s = 'html=1;verticalLabelPosition=bottom;align=center;labelBackgroundColor=#ffffff;verticalAlign=top;strokeWidth=2;strokeColor=#0080F0;fillColor=#ffffff;shadow=0;dashed=0;shape=mxgraph.ios7.icons.'
        var inh = 'strokeColor=inherit;fillColor=inherit;gradientColor=inherit;';
        var gn = 'mxgraph.ios7.icons';

        this.addPaletteFunctions('ios7icons', 'iOS Icons', false,
            [
                this.createVertexTemplateEntry(s + 'add;', 100 * sc, 100 * sc, '', 'Add', null, null, this.getTagsForStencil(gn, 'add', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'alarm_clock;', 90 * sc, 100 * sc, '', 'Alarm Clock', null, null, this.getTagsForStencil(gn, 'alarm_clock', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'back;', 100 * sc, 85 * sc, '', 'Back', null, null, this.getTagsForStencil(gn, 'back', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'backward;', 100 * sc, 56 * sc, '', 'Backward', null, null, this.getTagsForStencil(gn, 'backward', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'bag;', 70 * sc, 70 * sc, '', 'Bag', null, null, this.getTagsForStencil(gn, 'bag', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'basket_cancel;', 100 * sc, 40 * sc, '', 'Basket Cancel', null, null, this.getTagsForStencil(gn, 'basket_cancel', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'basketball;', 100 * sc, 100 * sc, '', 'Basketball', null, null, this.getTagsForStencil(gn, 'basketball', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'battery;', 100 * sc, 40 * sc, '', 'Battery', null, null, this.getTagsForStencil(gn, 'battery', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'bell;', 80 * sc, 77 * sc, '', 'Bell', null, null, this.getTagsForStencil(gn, 'bell', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'bluetooth;pointerEvents=1', 50 * sc, 96 * sc, '', 'Bluetooth', null, null, this.getTagsForStencil(gn, 'bluetooth', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'book;', 100 * sc, 85 * sc, '', 'Book', null, null, this.getTagsForStencil(gn, 'book', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'bookmark;', 60 * sc, 80 * sc, '', 'Bookmark', null, null, this.getTagsForStencil(gn, 'bookmark', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'box;', 100 * sc, 100 * sc, '', 'Box', null, null, this.getTagsForStencil(gn, 'box', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'briefcase;', 100 * sc, 67 * sc, '', 'Briefcase', null, null, this.getTagsForStencil(gn, 'briefcase', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'calculator;', 80 * sc, 100 * sc, '', 'Calculator', null, null, this.getTagsForStencil(gn, 'calculator', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'calendar;', 100 * sc, 100 * sc, '', 'Calendar', null, null, this.getTagsForStencil(gn, 'calendar', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'camera;', 100 * sc, 58 * sc, '', 'Camera', null, null, this.getTagsForStencil(gn, 'camera', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'chat;', 100 * sc, 60 * sc, '', 'Chat', null, null, this.getTagsForStencil(gn, 'chat', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'clock;', 100 * sc, 100 * sc, '', 'Clock', null, null, this.getTagsForStencil(gn, 'clock', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'cloud;', 100 * sc, 100 * sc, '', 'Cloud', null, null, this.getTagsForStencil(gn, 'cloud', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'compose;', 97 * sc, 97 * sc, '', 'Compose', null, null, this.getTagsForStencil(gn, 'compose', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'controls;', 90 * sc, 80 * sc, '', 'Controls', null, null, this.getTagsForStencil(gn, 'controls', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'credit_card;', 100 * sc, 50 * sc, '', 'Credit Card', null, null, this.getTagsForStencil(gn, 'credit_card', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'crop;', 100 * sc, 100 * sc, '', 'Crop', null, null, this.getTagsForStencil(gn, 'crop', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'cube;', 100 * sc, 100 * sc, '', 'Cube', null, null, this.getTagsForStencil(gn, 'cube', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'cup;', 100 * sc, 100 * sc, '', 'Cup', null, null, this.getTagsForStencil(gn, 'cup', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'data;', 80 * sc, 97 * sc, '', 'Data', null, null, this.getTagsForStencil(gn, 'data', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'delete;', 100 * sc, 100 * sc, '', 'Delete', null, null, this.getTagsForStencil(gn, 'delete', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'document;', 70 * sc, 100 * sc, '', 'Document', null, null, this.getTagsForStencil(gn, 'document', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'documents;', 75 * sc, 100 * sc, '', 'Documents', null, null, this.getTagsForStencil(gn, 'documents', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'down;', 70 * sc, 85 * sc, '', 'Down', null, null, this.getTagsForStencil(gn, 'down', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'edit;', 98 * sc, 98 * sc, '', 'Edit', null, null, this.getTagsForStencil(gn, 'edit', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'envelope_(empty);', 100 * sc, 100 * sc, '', 'Envelope (Empty)', null, null, this.getTagsForStencil(gn, 'envelope_(empty)', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'envelope_(message);', 100 * sc, 100 * sc, '', 'Envelope (Message)', null, null, this.getTagsForStencil(gn, 'envelope_(message)', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'eye;', 100 * sc, 47 * sc, '', 'Eye', null, null, this.getTagsForStencil(gn, 'eye', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'flag;', 100 * sc, 100 * sc, '', 'Flag', null, null, this.getTagsForStencil(gn, 'flag', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'flash;', 60 * sc, 100 * sc, '', 'Flash', null, null, this.getTagsForStencil(gn, 'flash', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'flashlight;', 50 * sc, 100 * sc, '', 'Flashlight', null, null, this.getTagsForStencil(gn, 'flashlight', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'folder;', 100 * sc, 65 * sc, '', 'Folder', null, null, this.getTagsForStencil(gn, 'folder', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'folders;', 100 * sc, 85 * sc, '', 'Folders', null, null, this.getTagsForStencil(gn, 'folders', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'folders_2;', 100 * sc, 75 * sc, '', 'Folders', null, null, this.getTagsForStencil(gn, 'folders_2', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'forward;', 100 * sc, 56 * sc, '', 'Forward', null, null, this.getTagsForStencil(gn, 'forward', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'gauge;', 108 * sc, 105 * sc, '', 'Gauge', null, null, this.getTagsForStencil(gn, 'gauge', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'glasses;', 100 * sc, 40 * sc, '', 'Glasses', null, null, this.getTagsForStencil(gn, 'glasses', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'globe;', 100 * sc, 100 * sc, '', 'Globe', null, null, this.getTagsForStencil(gn, 'globe', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'heart;', 102 * sc, 91 * sc, '', 'Heart', null, null, this.getTagsForStencil(gn, 'heart', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'help;', 100 * sc, 100 * sc, '', 'Help', null, null, this.getTagsForStencil(gn, 'help', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'home;', 80 * sc, 85 * sc, '', 'Home', null, null, this.getTagsForStencil(gn, 'home', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'info;', 100 * sc, 100 * sc, '', 'Info', null, null, this.getTagsForStencil(gn, 'info', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'keypad;', 100 * sc, 100 * sc, '', 'Keypad', null, null, this.getTagsForStencil(gn, 'keypad', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'lightbulb;', 76 * sc, 99 * sc, '', 'Lightbulb', null, null, this.getTagsForStencil(gn, 'lightbulb', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'link;', 100 * sc, 100 * sc, '', 'Link', null, null, this.getTagsForStencil(gn, 'link', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'location;', 80 * sc, 100 * sc, '', 'Location', null, null, this.getTagsForStencil(gn, 'location', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'location_2;', 100 * sc, 100 * sc, '', 'Location', null, null, this.getTagsForStencil(gn, 'location_2', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'locked;', 80 * sc, 100 * sc, '', 'Locked', null, null, this.getTagsForStencil(gn, 'locked', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'looking_glass;', 100 * sc, 100 * sc, '', 'Looking Glass', null, null, this.getTagsForStencil(gn, 'looking_glass', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'loud;', 102 * sc, 108 * sc, '', 'Loud', null, null, this.getTagsForStencil(gn, 'loud', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'magnet;pointerEvents=1', 80 * sc, 100 * sc, '', 'Magnet', null, null, this.getTagsForStencil(gn, 'magnet', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'mail;', 100 * sc, 55 * sc, '', 'Mail', null, null, this.getTagsForStencil(gn, 'mail', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'map;', 100 * sc, 100 * sc, '', 'Map', null, null, this.getTagsForStencil(gn, 'map', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'message;', 100 * sc, 65 * sc, '', 'Message', null, null, this.getTagsForStencil(gn, 'message', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'messages;', 100 * sc, 85 * sc, '', 'Messages', null, null, this.getTagsForStencil(gn, 'messages', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'microphone;', 40 * sc, 100 * sc, '', 'Microphone', null, null, this.getTagsForStencil(gn, 'microphone', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'monitor;', 100 * sc, 65 * sc, '', 'Monitor', null, null, this.getTagsForStencil(gn, 'monitor', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'moon;', 98 * sc, 98 * sc, '', 'Moon', null, null, this.getTagsForStencil(gn, 'moon', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'most_viewed;pointerEvents=1', 94 * sc, 76 * sc, '', 'Most Viewed', null, null, this.getTagsForStencil(gn, 'most_viewed', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'move_to_folder;', 100 * sc, 75 * sc, '', 'Move to Folder', null, null, this.getTagsForStencil(gn, 'move_to_folder', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'note;pointerEvents=1', 99 * sc, 99 * sc, '', 'Note', null, null, this.getTagsForStencil(gn, 'note', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'options;pointerEvents=1', 100 * sc, 50 * sc, '', 'Options', null, null, this.getTagsForStencil(gn, 'options', dt).join(' ')),
                this.createVertexTemplateEntry('html=1;verticalLabelPosition=bottom;strokeWidth=2;strokeColor=#0080F0;fillColor=#0080F0;shadow=0;dashed=0;shape=mxgraph.ios7.icons.orientation_lock;pointerEvents=1', 77 * sc, 70 * sc, '', 'Orientation Lock', null, null, this.getTagsForStencil(gn, 'orientation_lock', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'page_navigation;pointerEvents=1', 100 * sc, 16 * sc, '', 'Page Navigation', null, null, this.getTagsForStencil(gn, 'page_navigation', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'paint;', 100 * sc, 85 * sc, '', 'Paint', null, null, this.getTagsForStencil(gn, 'paint', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'pause;pointerEvents=1', 50 * sc, 80 * sc, '', 'Pause', null, null, this.getTagsForStencil(gn, 'pause', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'pen;', 98 * sc, 99 * sc, '', 'Pen', null, null, this.getTagsForStencil(gn, 'pen', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'pie_chart;', 100 * sc, 100 * sc, '', 'Pie Chart', null, null, this.getTagsForStencil(gn, 'pie_chart', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'play;', 70 * sc, 80 * sc, '', 'Play', null, null, this.getTagsForStencil(gn, 'play', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'pointer;', 100 * sc, 100 * sc, '', 'Pointer', null, null, this.getTagsForStencil(gn, 'pointer', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'preferences;pointerEvents=1', 100 * sc, 80 * sc, '', 'Preferences', null, null, this.getTagsForStencil(gn, 'preferences', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'printer;', 100 * sc, 85 * sc, '', 'Printer', null, null, this.getTagsForStencil(gn, 'printer', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'privacy;', 56 * sc, 95 * sc, '', 'Privacy', null, null, this.getTagsForStencil(gn, 'privacy', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'radio;', 100 * sc, 75 * sc, '', 'Radio', null, null, this.getTagsForStencil(gn, 'radio', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'reload;', 80 * sc, 90 * sc, '', 'Reload', null, null, this.getTagsForStencil(gn, 'reload', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'repeat;pointerEvents=1', 100 * sc, 80 * sc, '', 'Repeat', null, null, this.getTagsForStencil(gn, 'repeat', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'retry;', 92 * sc, 48 * sc, '', 'Retry', null, null, this.getTagsForStencil(gn, 'retry', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'select;', 100 * sc, 100 * sc, '', 'Select', null, null, this.getTagsForStencil(gn, 'select', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'settings;', 100 * sc, 100 * sc, '', 'Settings', null, null, this.getTagsForStencil(gn, 'settings', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'share;', 70 * sc, 95 * sc, '', 'Share', null, null, this.getTagsForStencil(gn, 'share', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'shopping_cart;', 100 * sc, 85 * sc, '', 'Shopping Cart', null, null, this.getTagsForStencil(gn, 'shopping_cart', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'shuffle;pointerEvents=1', 100 * sc, 70 * sc, '', 'Shuffle', null, null, this.getTagsForStencil(gn, 'shuffle', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'silent;', 100 * sc, 100 * sc, '', 'Silent', null, null, this.getTagsForStencil(gn, 'silent', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'smartphone;', 60 * sc, 100 * sc, '', 'Smartphone', null, null, this.getTagsForStencil(gn, 'smartphone', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'star;', 100 * sc, 90 * sc, '', 'Star', null, null, this.getTagsForStencil(gn, 'star', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'stopwatch;', 90 * sc, 94 * sc, '', 'Stopwatch', null, null, this.getTagsForStencil(gn, 'stopwatch', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'storage;', 100 * sc, 35 * sc, '', 'Storage', null, null, this.getTagsForStencil(gn, 'storage', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'sun;pointerEvents=1', 100 * sc, 100 * sc, '', 'Sun', null, null, this.getTagsForStencil(gn, 'sun', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'tape;pointerEvents=1', 100 * sc, 40 * sc, '', 'Tape', null, null, this.getTagsForStencil(gn, 'tape', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'tools;pointerEvents=1', 99 * sc, 99 * sc, '', 'Tools', null, null, this.getTagsForStencil(gn, 'tools', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'trashcan;', 80 * sc, 100 * sc, '', 'Trashcan', null, null, this.getTagsForStencil(gn, 'trashcan', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'trophy;', 95 * sc, 100 * sc, '', 'Trophy', null, null, this.getTagsForStencil(gn, 'trophy', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'umbrella;', 100 * sc, 100 * sc, '', 'Umbrella', null, null, this.getTagsForStencil(gn, 'umbrella', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'unlocked;', 80 * sc, 100 * sc, '', 'Unlocked', null, null, this.getTagsForStencil(gn, 'unlocked', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'up;', 70 * sc, 85 * sc, '', 'Up', null, null, this.getTagsForStencil(gn, 'up', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'user;', 100 * sc, 100 * sc, '', 'User', null, null, this.getTagsForStencil(gn, 'user', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'video_conversation;', 100 * sc, 50 * sc, '', 'Video Conversation', null, null, this.getTagsForStencil(gn, 'video_conversation', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'volume;pointerEvents=1', 100 * sc, 100 * sc, '', 'Volume', null, null, this.getTagsForStencil(gn, 'volume', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'volume_2;pointerEvents=1', 101 * sc, 94 * sc, '', 'Volume', null, null, this.getTagsForStencil(gn, 'volume_2', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'wallet;', 100 * sc, 80 * sc, '', 'Wallet', null, null, this.getTagsForStencil(gn, 'wallet', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'wifi;pointerEvents=1', 99 * sc, 70 * sc, '', 'WiFi', null, null, this.getTagsForStencil(gn, 'wifi', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'window;', 100 * sc, 100 * sc, '', 'Window', null, null, this.getTagsForStencil(gn, 'window', dt).join(' '))
            ]);

        var s = 'html=1;verticalLabelPosition=bottom;labelBackgroundColor=#ffffff;verticalAlign=top;shadow=0;dashed=0;strokeWidth=1;shape=mxgraph.ios7ui.';
        var s2 = 'html=1;strokeWidth=1;shadow=0;dashed=0;shape=mxgraph.ios7ui.';
        var s3 = mxConstants.STYLE_VERTICAL_LABEL_POSITION + '=bottom;' + mxConstants.STYLE_VERTICAL_ALIGN + '=top;html=1;shadow=0;dashed=0;strokeWidth=1;shape=mxgraph.ios.';
        var sm = 'html=1;verticalLabelPosition=bottom;labelBackgroundColor=#ffffff;verticalAlign=top;shadow=0;dashed=0;strokeWidth=2;shape=mxgraph.ios7.misc.';
        var s4 = 'html=1;strokeWidth=2;shadow=0;dashed=0;shape=mxgraph.ios7ui.';
        var skcl9 = 'strokeColor=#999999;';
        var dt = 'ios ui ';
        var gn = 'mxgraph.ios7ui';
        var gnm = 'mxgraph.ios7.misc';

        var fns =
            [
                this.createVertexTemplateEntry(
                    'html=1;verticalLabelPosition=bottom;labelBackgroundColor=#ffffff;verticalAlign=top;shadow=0;dashed=0;strokeWidth=1;shape=mxgraph.ios7.misc.iphone;fillColor=#ffffff;strokeColor=#c0c0c0;',
                    sizeX, sizeY, '', 'iPhone (Portrait)', null, null, this.getTagsForStencil(gn, 'phone', dt + 'portrait').join(' ')),
                this.createVertexTemplateEntry(
                    'html=1;verticalLabelPosition=bottom;labelBackgroundColor=#ffffff;verticalAlign=top;shadow=0;dashed=0;strokeWidth=1;shape=mxgraph.ios7.misc.ipad7inch;fillColor=#ffffff;strokeColor=#c0c0c0;',
                    sizeX * 1.83, sizeY * 1.3725, '', "iPad (7'')", null, null, this.getTagsForStencil(gn, 'tablet tab 7', dt + 'portrait').join(' ')),
                this.createVertexTemplateEntry(
                    'html=1;verticalLabelPosition=bottom;labelBackgroundColor=#ffffff;verticalAlign=top;shadow=0;dashed=0;strokeWidth=1;shape=mxgraph.ios7.misc.ipad10inch;fillColor=#ffffff;strokeColor=#c0c0c0;',
                    sizeX * 2.44, sizeY * 1.7325, '', "iPad (10'')", null, null, this.getTagsForStencil(gn, 'tablet tab 10', dt + 'portrait').join(' ')),
                this.createVertexTemplateEntry(
                    'html=1;verticalLabelPosition=bottom;labelBackgroundColor=#ffffff;verticalAlign=top;shadow=0;dashed=0;strokeWidth=1;shape=mxgraph.ios7.misc.ipad13inch;fillColor=#ffffff;strokeColor=#c0c0c0;',
                    sizeX * 2.86, sizeY * 2.0325, '', "iPad (13'')", null, null, this.getTagsForStencil(gn, 'tablet tab 10', dt + 'portrait').join(' ')),
                this.addDataEntry(dt + 'app bar portrait', 175, 15, 'App Bar (portrait)',
                    'zVVdb4IwFP01fZTw6cejoDNLZmLYkj03o0CzQkmpivv1u0BBEIw+zMUmJL3n3tt7e05LkeUlxUbgLN7ygDBkrZHlCc5lPUsKjzCGTJ0GyFoh09ThQ+bLFa9RefUMC5LKexLMOuGA2Z7USA3k8sQUEMsE2loZyHJzKfg3+aSBjBskxgE/gqGDEeA8JoEywJOVKyRFVO5Oozyf7amGs8zFAvwhZczjjIuqihVWA3CIDih03/hSnsIyruqTCEmKq3utILXRDeEJkeIEIUfVcBkxc+q0mNAobtIUhvPajtrUM3MwUeSNE2kNiPSWvv+69gd8NsQI8gX1XcxolILJSFiaIU/lO/0pA+Ylixn+omn0VjlXpt2PaMwOj7garVYXLHZJV5Cq8MEzteBdTJvjTJ/UmdMUox3mHX2EeMWaIAxLeiC9cmNqqIo7TqGRttxkql0oyMMwJ3KgX9vpXZLaA0kNOPJLx9ltb4l6oeJTaVRcaPTPmqnyE0vvlX+Qhs5Aw8UcNejtSynqfV+5lb5ixVj0Q6ZPKrlxU3B77O/4R4LbzgMEB/P8WNbh3bf0Fw=='),
                this.addDataEntry(dt + 'app bar landscape', 280, 15, 'App Bar (landscape)',
                    'zZVdb4IwFIZ/TS81UMDppaIzS2Zi2JJdN6NAs0JJqYr79TvQovJh9MbFJiScj/ac87wlIMdPy7UkebIRIeXIWSHHl0Io/ZaWPuUcYYuFyFkijC14EH69ErXrqJUTSTN1zwasN+wJ31Ht0Y5CHblxJCqFtpY2chaFkuKHfrFQJY0nIaE4gGGBEZIioaExIJJXJ6RlXE03ZqJ42bExyfMFkRCPGOe+4ELWVZyoXuCH7JBB900sExkcszB9UqloeXXW2mUGXVORUiWPkHIwDVfzTjUPK6EsTpptnvaRQtvxaeuZHLwYeMMgnR5Ifx4Eb6ugx7MBI+k31F8QzuIMTE6jyoxEpj7Yb5UwrSjm5Jtl8XsdXGK3ndGYFxxJvU5adSheQjcuU+FT5ObAu0jjYdJHc+fGhugFeW8IvKEmKSeK7Wmr3JAapuJWMGjkVG40GXcUFFFUUNXT79TpXZK6PUltuPJzz9tubonaUfGpNCo7Gv2zZqb8CLfLP0hDr6fhbIoa7+2PUuq5r3yVgaFiz9opkyeV3L4puOs9TnD3EYKDef5Z6vTLf+kf'),

                this.createVertexTemplateEntry(
                    s + 'slider;barPos=20;strokeColor=#0080f0;fillColor=#ffffff;strokeColor2=#a0a0a0;',
                    sizeX * 0.75, sizeY * 0.0375, '', 'Slider', null, null, this.getTagsForStencil(gn, dt + 'slider', null).join(' ')),
                this.createVertexTemplateEntry(
                    s2 + 'downloadBar;verticalAlign=middle;fontSize=8;fontColor=#000000;buttonText=;barPos=30;fillColor=#aaaaaa;strokeColor=#0080f0;align=center;',
                    sizeX * 0.75, sizeY * 0.075, 'Downloading 2 of 6\n\n', 'Download bar', null, null, this.getTagsForStencil(gn, 'downloadBar', dt + '').join(' ')),
                this.createVertexTemplateEntry(
                    sm + 'adjust;fillColor=#ffffff;gradientColor=none;',
                    sizeX * 0.4, sizeY * 0.05, '', 'Adjust', null, null, this.getTagsForStencil(gn, 'adjust', dt + '').join(' ')),

                this.addEntry(dt + 'horizontal button bar', function () {
                    var bg = new mxCell('', new mxGeometry(0, 0, 164, 12.5), s2 + 'rrect;rSize=3;strokeColor=#0080F0;fillColor=#ffffff;gradientColor=none;');
                    bg.vertex = true;
                    var button1 = new mxCell('Item 1', new mxGeometry(0, 0, 41, 12.5), inh + s2 + 'leftButton;rSize=3;fontSize=8;');
                    button1.vertex = true;
                    bg.insert(button1);
                    var button3 = new mxCell('Item 3', new mxGeometry(82, 0, 41, 12.5), inh + s2 + 'rrect;rSize=0;fontSize=8;');
                    button3.vertex = true;
                    bg.insert(button3);
                    var button4 = new mxCell('Item 4', new mxGeometry(123, 0, 41, 12.5), inh + s2 + 'rightButton;rSize=3;fontSize=8;');
                    button4.vertex = true;
                    bg.insert(button4);
                    var button2 = new mxCell('Item 2', new mxGeometry(41, 0, 41, 12.5), s2 + 'rrect;rSize=0;strokeColor=#0080F0;fillColor=#0080F0;fontColor=#ffffff;fontSize=8;');
                    button2.vertex = true;
                    bg.insert(button2);

                    return sb.createVertexTemplateFromCells([bg], bg.geometry.width, bg.geometry.height, 'Horizontal button bar');
                }),

                this.addDataEntry(dt + 'select bar', sizeX * 0.825, sizeY * 0.0675, 'Select Bar',
                    '7ZRNb8IwDIZ/Ta6oTcZ6HmWDy6RJHHaOiEujpU2VBCj79XM+ClTAhrbrIlWKX8dO/LxSCSubfmF4V79qAYqwZ8JKo7WLu6YvQSlCMykImxNKM/wIfbmRzUM267iB1t1TQGPBjqstRCUK1h1UEmrX4LPmOWEz64z+gHcpXI0K9UrNhd5jkGEguK1BpAAzne/Q9Bs/3URqW2zlxIKCtZtx48/3vi8NpQfcToOGbeeF31r5CUmNF5daaRMexaqwMFNJpc50GhbqeKmQCGHItbrFZrM0LhgH/U1kQUq8FqAbcOaAR/Zpbn/icRrLapCbOpXRImrcxnhzLD0ZgJvkwXU/2IUfqwDswpUBr/HJMYY06phZEit9QjLCiPoq8s5pil94I5X3ZQlqB06uOSY6MBKngrOeBrxTy4FEfi9m+iPm4hvKBhR3cgej9n9B/3ATffbkD/4b8EsD0g1vWrYeZj9uPVToqrLgLgw7vuuahxiefpXx+Pmf9As='),
                this.addDataEntry(dt + 'select bar', sizeX * 0.825, sizeY * 0.0675, 'Select Bar',
                    '7ZVNb8IwDIZ/Ta4oTddxHmXAZRISh50j6tJoaVMlAcp+/ZyPAlWHhrYdiVQpfh078fMeStK87paat9WbKkCS9JWkuVbKhl3d5SAlYVQUJJ0Txih+hC1uZBOfpS3X0Nh7ClgoOHC5h6AEwdiTjEJla3zWPCHpzFitPuBdFLZChTml4oU6YkAxKLipoIgBZlrXoe52brqJUGa6FxMDErZ2xrU737m+zJeecJt5jbmd7yA+Iarh4lxJpf2j0tIvzJRCyiud+YU6XloIhNDnGtVgs1kcF7SF7iYyL0VeS1A1WH3CI8c4tzvxnIWyCsSuimVsGjRuQrw7l14MwE304Hs/0pEfGw9s5EqPV7vkEEMcdcgsiqW6IBlgRH0TeCc0xgteC+l8WYE8gBVbjokWtMCp4KqnBufUqieR3IuZ/Yg5o7cpa5DcigMM2v8F/dNN9PTFHXwY8EsD4g1rJRoHsxu27itUWRqwI8PO77rLw2zk4ZobCw/z/tm8hP6DexhefnTh+PV/8As='),

                this.addEntry(dt + 'labels', function () {
                    var bg = new mxCell('', new mxGeometry(0, 0, 164, 20), 'shape=rect;fillColor=#F6F6F8;strokeColor=none;');
                    bg.vertex = true;
                    var text1 = new mxCell('Label', new mxGeometry(55, 0, 54, 20), 'text;fontColor=#000000;fontSize=10;verticalAlign=middle;align=center;spacingTop=2;');
                    text1.vertex = true;
                    bg.insert(text1);
                    var text2 = new mxCell('Label', new mxGeometry(109, 0, 55, 20), 'text;fontColor=#0080f0;fontSize=10;verticalAlign=middle;align=right;spacingTop=2;spacingRight=4;');
                    text2.vertex = true;
                    bg.insert(text2);

                    return sb.createVertexTemplateFromCells([bg], bg.geometry.width, bg.geometry.height, 'Labels');
                }),

                this.addEntry(dt + 'search box', function () {
                    var bg = new mxCell('', new mxGeometry(0, 0, 164, 20), 'shape=rect;fillColor=#e0e0e0;strokeColor=none;');
                    bg.vertex = true;
                    var part1 = new mxCell('', new mxGeometry(0, 0, 164, 20), s2 + 'marginRect;rx=3;ry=3;rectMargin=5;fillColor=#ffffff;strokeColor=none;');
                    part1.vertex = true;
                    bg.insert(part1);
                    var icon1 = new mxCell('Search', new mxGeometry(0.5, 0.5, 6, 6), 'shape=mxgraph.ios7.icons.looking_glass;strokeColor=#e0e0e0;fillColor=none;fontColor=#e0e0e0;labelPosition=right;verticalLabelPosition=middle;align=left;verticalAlign=middle;fontSize=6;fontStyle=0;spacingTop=2;');
                    icon1.geometry.relative = true;
                    icon1.geometry.offset = new mxPoint(-17, -3);
                    icon1.vertex = true;
                    bg.insert(icon1);

                    return sb.createVertexTemplateFromCells([bg], bg.geometry.width, bg.geometry.height, 'Search Box');
                }),

                this.addEntry(dt + 'search box', function () {
                    var bg = new mxCell('', new mxGeometry(0, 0, 164, 20), 'shape=rect;fillColor=#F6F6F6;strokeColor=none;');
                    bg.vertex = true;
                    var part1 = new mxCell('', new mxGeometry(0, 0, 164, 20), s2 + 'marginRect;rx=3;ry=3;rectMargin=5;fillColor=#E4E4E4;strokeColor=none;');
                    part1.vertex = true;
                    bg.insert(part1);
                    var icon1 = new mxCell('Search', new mxGeometry(0.5, 0.5, 6, 6), 'shape=mxgraph.ios7.icons.looking_glass;strokeColor=#878789;fillColor=none;fontColor=#878789;labelPosition=right;verticalLabelPosition=middle;align=left;verticalAlign=middle;fontSize=6;fontStyle=0;spacingTop=2;');
                    icon1.geometry.relative = true;
                    icon1.geometry.offset = new mxPoint(-17, -3);
                    icon1.vertex = true;
                    bg.insert(icon1);

                    return sb.createVertexTemplateFromCells([bg], bg.geometry.width, bg.geometry.height, 'Search Box');
                }),
                this.addDataEntry(dt + 'status', 164, 25, 'Status',
                    'vZRtb4MgEMc/jS9rnNZ2b1e7NlmyZcnWD8D0VDLkDNDW7tMPhD5qM7cm0xi5/3HA/eDwoqRqloLU5TNmwLzo0YsSgahsq2oSYMwLA5p50dwLw0B/Xri44r1rvUFNBHA1JCC0ARvC1mAVK0i1Y06QJalNU0Cqh5zllLEEGYrWGy0m5tW6VAI/Ye/hyHXMzI0OQkFzdYWt5Ja3BKxAiZ3usqWZKl2PydiGlUCL0oWFsdWItHZxCD3mqxsu5f70o076qzojCjItPq2l0r8X3HaQ6GxaFMjVCYqgfZz+Rr9M51ibJn2aEvbAaMG1prDWKnFWqjmAMABrklJevBvvfBQOpRf+kV5wO71xh54xV1wAyQYy+2ifn5lVNMvMSF1st0DaWa87SP+BLB5eb1VTmGvBpyinPk2RSz/FqkYJnWprD999kAcX9fmbKryC6DzAAQv8HmRxl9heE8CIohs4G6sPo5v/FSlXx8lHe/Ju+tHUv6h9zHMJqrMRhzz69kabx3vWdj+9hr8B'),
                this.addDataEntry(dt + 'message', 164, 20, 'Message',
                    'xVbbbqMwEP0aHouICUnzSnp52UirdqU+WzDB1toY2W6b9OvX4IGWW5ZVuyoWkn3GM545x4MI4r083WtasYPKQQTxbRDvtVLWz+RpD0IEJOJ5EN8EhETuDcjdjHXVWKOKaijtEgfiHV6oeAaPeMDYs0DAMFrVUw2ZC5keuRB7JZRurPHdth4ON1ar39BaSlU6nxSjg7Zwms2wgTC9e1ASrD67La88twx3bNbejQEvGLphZRE1fl10ru/1ugmWPF1+PCqfH8AYWsCIBmali3Kz6kp9wvwahNFcvbpF5BY5NQxyXLTsyVNRixxyZbbPPJRUF7x88JTqmpu4npzbiTMcmi0/4FjXS5Ie+oA0DOBfqhoFSJW1SiI8FC+tx0g8Z0mbUXuo0k7hVPCidJho8ktNRTNeFm22O/R85G918ddLrwL5vquwXtAJY92HvHXtMGB60zwz9yHkmSpNmFEJmn6SqjN2fZh4l4/UJWPmdh7SIKjlL9A7bYpNPPCn4i4PEmF6GBjPvlq3h7cR1PFowI7U6NJeJFCyVKDBN+hvSrhTeGUWf61meO87XFJh4v622CdluFrt+kJs/4MMm3+VYa4rUJ4LDSF5plXFcN+o+RbJlVyUqxPogmBTekVfoxfpy/UFXeOW7z8PfvvHf4s/'),
                this.addDataEntry(dt + 'action sheet', 164, 115, 'Action Sheet',
                    '7VZNc4IwEP01HOuERNSzUL3UmU576DlKgEwDYUL86q/vQoKi2Err0F7UcWb3ZXez2ffMxCF+upsrmicLGTLhkEeH+EpKbax05zMhHIx46JDAwRjBz8GzL1bdahXlVLFMd0nAJmFDxZoZxACF3gsLFAnNS1OxFZScqlf+UboE7EIr+c58KaQCJJMZLEwjLkQNOZgEOCCBB3isaMihrbNwKB/KLfgIHNsNU5rtvjxRBdnjzJlMmVZ7CNnyUCc2YjQ0aQnjcVKnuZ4BaWGA+JB7HBAYdkaX50Va83qiS6DtfGiJTqFE4B6G9Ga7c8+PHNIiYaF16lmnu7iUxIDLYrzmAy3z6VprmX07/+awI5lpGzhpczJzy68Na+AITdCs7EOxApKbPXdiBl9nxrvAjNUoUkxQzTfspP4ltuwWz5LDzhjZhiy9+xOvTpdRVDDdovrQZSf2hx3ZP/vLtMRwZ+wSY71Q5t0p65GyYR+Ujf7ljl1KuGDT+zX7QwWM+lDAuKUAn2ar3iWQUhXz7MW+c8rjlhyXTRsDFhZViAV+q4uo+vyZLvYnCdeeSeRGldjdHuo6twgD3ONT2IQ3X8qf'),

                this.addDataEntry(dt + 'action sheet', 164, 115, 'Action Sheet',
                    '7VhRj6IwEP41PK4BqoiPKyz7suY2t5fc46ULFZotlLR11fv1N5XiouCK52ruEjWadjpTynzfN0OwUJCvHgUusxlPCLPQg4UCwbmqRvkqIIxZrk0TC4WW69rws9zowKqzWbVLLEih+gS4VcA7ZgtSWSqDVGtmDDLDpR4KEsOWU/FCf+spgrFUgr+RgDMuwFLwAhamc8pYbbJcFLohCkdgTwVOKBxrzx22T/gS5jZMzGmIUGR18I42JnM7j4TnRIk1uCxpojLj4Q2rsIzQNKvDnFFlxLIypNvYjwTBwOSoO1/oeL4ylUN06Gzz89MczNm/2wTLjCRmUqc5X6WaDQPK5XhBB4qX04VSvPg09c08z3mhjKPfhiNy9Ne4Ney27duRPocgEoKbZ+4FinsclFEHKMOKnrYgDCv6Tnb27wLKXOKZU7iya5sDGWTXO7M6nM/nkqgWyttT9gJ+2AJ+RqTEKTmqF74okg3KzkHFfCA2aiPm+dHYR12I6U+HsPTaaOo5cB9TjRqNMbtnNAUKhUAnsDL8Stgzl1RRTawwhmgiGu5Pew6vHCiYgwM2+2wjZIljWqQ/9L7h3bAvXVA3XQyA9sBA2KBPrbQme2rbl7Lnbr9OfAl/Rv0LbV0BXrGk8YBDyC+AhPGF6lly55tPXyiG3VCsdhrEeqf8NVXtd1Ra7/xC67X1him7uNiciWc/BKeJzYnCIIpuYusnNjS+gtrGp6tN99sBjXkhB7lmWkeLdd3JJELn6s37VG9oJzteW29eh97s8/XmX/vBpmL57dnmxO40vIRcJi3wv5Wk0A76774sL153txI6VHevXFvHYFlmVJEXMOszL4G7ffni/0v19hoPN3UBahPoiRZvN/L8t+S5SrN2nBZ7AlzE5PDT3l4rybFIafHdsGlluoi+fDWAhdnGxdDnb/vLYZ5dpL+sdwKOvd5AZ3abGmJknw8xTD9eYVXuzTdcfwA='),
                this.addDataEntry(dt + 'cell list', 164, 120, 'Cell List',
                    '7ZlNb6MwEIZ/DcdGtgmEHBtSeulKK3WlPbPBgLUGI0PbpL9+HWyaD2BlWlxVBUuR7MEz2O+YRxmwbD/b3/OwSH+wCFPLvrNsnzNWyV629zGlFgIksuythRAQPwsFPVdhfRUUIcd5peOApMNzSJ+wtEhDWR2oMpRpWBy7HO9EyE1ZcfYX+4wyLow5y8W1TUwobUwWsuO6CXvCw4iIpVxNFyEj9iLGQAzUCjCv8L53F7VJbeEeswxX/CCmvJCoStUMdyndUkyStHFT2wdhKQ3Jm+9JFNFRunRrZLc0egj/iFS9SyiWV4/k9TgNAjU+Ew7UTdg5LsWs32p7UFhCSpJc9CmO6+hFuCN58lCPtsg5mX6x4mjRVRa9T9lGWI5pWJFnfBH/I2ovB59Izp7yCEdKJ67ktTXPahCsHQB11bK71TqoZ23hSJdz9ZyOY+kMFE/d8ScjYiEIqPWpKOrmN6vm7k0EFsclrlriv61bKx+Ofj6yfXIE2YKwcrXISLlbcLnnq0QI1d26fVD1S4f/5KArBUPPb3cKbuBVEkykwJ0BNAKArhJ4uAwzasJWn84we3Ncrp7g7uQY5n0BhvWoPhWGrWeGGWPY0gTDmsP1aRBb+ttbIZKm4uvJQQzCL0CxHtmnQjHYrpdnjI2FMdcIxtrVu1mMAbC6DbT/i8Eeyb8zxwZU+MY41qf7ZEDWLutnkI0FMs8IyNpvAcyCzPEcZ6v/QDnTA9mAMt8cyHp0nwzI2rX9DLKxQAaBEZK13wWYJZkXeHdr7cpSnqhJkQwNqPXNkaxH929KMjE8feaV08+/Av8D'),
                this.addDataEntry(dt + 'cell list', 164, 60, 'Cell List',
                    '7Vddb4IwFP01PGr4dnucuvniErMt2XMnBZoVStpOZb9+F1pRQCPqfJImJL3nfrXn9D5gOJNkM+Moi19ZgKnhPBvOhDMm1S7ZTDClhm2SwHCmhm2b8Bn2yxGvVXrNDHGcyi4JtkpYIfqDFaIAIXOqARGjrNhyvISSYyE5+8YTRhkHMGUp+MYhoXQLGbYTlgvwiKOAwFEa4VAyYGuwTTD0CTCXeHP0FiWkrzDDLMGS5xCyJoGMdYTvqrQYkyjWab66vYmEsqMqdccJbDQthylyWhTN0RcodRFPLJXv5LcIs0xt7/FmlgtwjgVEferbWYAgSqIU9hSHZfUMLUkafbAMMHsHzEv31OvKq30Zr/pVmRxTJMkK1+pfQ7Z7JtnJJipmZ0iYGA0TIpZDrk7Z4B/I9csFHlpUXDBBJGF7lBZMkSWi84Y7IUFQtK0k2HbYJjxpvApsqqy1edP8uW3hH8vVVTTnsGj1hFyP/9BT9p6kXltQ61xBdfsFI3CqqvfA8mrdB169AgtDgWXrQVSX6PRGvH4grx/Ihn55vcy/6uX3M31ad+++Z3rUz/StZtq9xUw/9DN9WvfRXc00mLv/FhW+/1vzBw=='),
                this.addDataEntry(dt + 'message', 164, 35, 'Message',
                    '1VbbbqMwEP0aHhdxyaX72KSbaKWuFO3uSx+98QBuDYNsp0n263cMJikQWqQ2K9URhDme8WXO8YAXL/PDWrEy+4EcpBd/8+KlQjT1U35YgpReFAjuxXdeFAV0edFqoDeseoOSKSjMmICoDnhmcgc1UgPaHKUDdMZK+6hgS0MutFH4BEuUqAgssKC+RSKkbCAvipOqEZ4qxgUtpeNOQ3Lckx2Q4VYAysBhcBcV5LawBszBqCO57AU3mfOYTeqwDESaubB4WmNM13Z6Cj3nhB5cWi6nKO6laAMGFEFr2jXowYTRMKLUMDJnQTBfrW4sjoX5Jf7aERqz5WYb4UyKtCBMQlLRUrKtKNLfWBIWnoH7qvuOkreQ7A/IDWphBNpIVedpYVMvtkzed/pzwbnd08nh1k156hhFXfQ2dUGfuQZTIJkRz9Aa/hKdboYNCpo4Ctx6HP/HltWEY5JoMD0tnBY5Sh6TnjzsYm4n00Fd5IfUnndfoJ77udBbv2GirRNie1a1C9w51t+krlFJl+selR3VOfX8dIRM+kL8WrV3iqAd8EIS06sp4kt4fU1Me5r4TubjTtt1pGjvjK4C9nRPFFVIPqgWyupg2e3UgDHkznulIZy/UmVaZSX6wCN/qVq/l2HHaHgNSmc9Sh9wR8BTgZZEy++eFQa445Zj6tPfA2h6V3B2dD5n8stdWVrU9/3/xf1sFPc3gf19Uu4/4jiTef4Aq91ffp/9Aw=='),
                this.addDataEntry(dt + 'message', 164, 100, 'Message',
                    '7Zbfb9sgEMf/Gj8uwjg/2sckTdqHVZqaSntm5myzYmMBbpL99TsM+VUnm9el0h6GFAu+3AF393FwlMzLzb1mdfGoOMgoWUTJXCtlfa/czEHKiBLBo+QuopTgL6LLC7NxO0tqpqGyfRyod3hlsgGveMHYrQyCKVjtuhpSXHJmrFYvMFdSaRQrVeHcLBNS7qSIJlnbUM814wKP8sYcl+RqjWOCg3AC0BY2F6NopRDCPagSrN6iyVpwWwSL8dC7FSDyYudGfPiEGS/ke99DUrAT8nI+R0knRytmG82ZO0GMIUxjNz99vJg6jMyljkmRVzhMMSzAdMxc0CJlchomSsG5bPOpKrsSP5zvKAyP0nvbtj612OW7Zqmo8mdVo5agoMHg6l9D9uK+VaDvrYLXNEhmxSucrH+uMmGLL0rgzgcTlWUGbKd0+5P0quawU80HcEGUrIooepNctXu6SkIaJctOVQtbypA1X4DjPJ6gzZkpgIfBDoZyk7vXfSCUmTRigOWXqun7Zi0mi/FifsSShMz2JGlyIOFz63UXT7pwkba9hQZrMlsXwsIKVbfYGmP4SJBuSZcj+pcchfOMvMM2uI9O/a8C2agLmcDxsyg9YyrDR6oabcAL3xvjTpi7qJBFCASiSS1bRVSNBYM9q/CRiUqYAjvfNLCXjBk7+KcwJeMbslw6XYr6Iez5G2StA+3XvNIurvur5gTXT5d4DVZPAaqYXp3h4EAGSYDg+N+RnKF6Z/deqgPHQ/IBHI87HD8B46gstWjvv34XnvbR/r/v/qiiN1eoKA4PH5Pe/Phb8yc='),

                this.addEntry(dt + 'alert', function () {
                    var bg = new mxCell("A dialog text that notifies you of something of which you don't need to make a decision, just to acknowledge it by pressing the close button.",
                        new mxGeometry(0, 0, 120, 70), 'shape=rect;rounded=1;strokeColor=none;fillColor=#F6F6F8;gradientColor=none;shadow=0;glass=0;dashed=1;fontFamily=Helvetica;fontSize=7;fontColor=#333333;align=center;html=0;verticalAlign=top;whiteSpace=wrap;spacing=8;spacingTop=0;');
                    bg.vertex = true;
                    var text1 = new mxCell('Close', new mxGeometry(0, 1, 120, 20), 'shape=text;align=center;verticalAlign=middle;fontSize=8;fontColor=#0680FF;strokeColor=none;fillColor=none;spacingTop=3;resizeWidth=1;');
                    text1.geometry.relative = true;
                    text1.geometry.offset = new mxPoint(0, -20);
                    text1.vertex = true;
                    bg.insert(text1);

                    return sb.createVertexTemplateFromCells([bg], bg.geometry.width, bg.geometry.height, 'Alert');
                }),
                this.addDataEntry(dt + 'dialog', 120, 70, 'Dialog',
                    '5ZZNb9pAEIZ/jY+JjN0SroHW6aVSpVTqeeUde0dZ71rr4cP99Z3FAwFiNyhtDlVB4J3vwc+L5CRfNbuHoFrz1WuwSf45yVfBexpOzW4F1iZZijrJPyVZlvInyYqJ6GwfTVsVwNE1BdlQsFF2DYPnnk2NyvqaD4RkYUjpqLeS0hnVxmOAkocsg187DbHhjK2Ogn+Clbc+sMd5x5nLCq09uJIsL+b8XrC/Dkojr3qRzgO037Kdxhyruk7OWnXmOKnyjgrVoO3Z8QXsBghLJYFH/BlXXIh5Mnx4sV9ZrB37Sl4AOLg01FgZtIEQm9l7ySHfsndrkOCxVWVsvWVocVc20dUyS6zvMX3fSO4vt4PdJKO9SwA9gG+AQs8pW9RkJEM4pgawNlJ2Jz7VDXZ9LH0mzgeBPi6A/BUBwI7ixah4cZ6wQuj42Ps1f/sqKiNONfEe8CpOH4MOIBrkY0MoUUP8TQZLExNLQu8OYVJPcDups/0SI7wuITWotYVzAdz9RgCvSvUgx1OoNxFzgI7b/xA+swlpXMU+exv7XHwBrCLcwFn/MUHIiG8eXUTZy/QLCfmq6oBeCOi42FWa+vBSUwfas3eBPPIvT+eLtCjeCjkfZfwnPPuzghO68xG42d+Be/MudD9O083+V7pSkN7KzflnabP5/PAxpJ8+m/wC'),

                this.createVertexTemplateEntry(
                    'html=1;strokeWidth=1;shadow=0;dashed=0;shape=mxgraph.ios7.misc.bluetooth;fillColor=#007AFF;strokeColor=none;buttonText=;strokeColor2=#222222;fontColor=#222222;fontSize=8;verticalLabelPosition=bottom;verticalAlign=top;align=center;',
                    15, 15, '', 'Bluetooth', null, null, this.getTagsForStencil(gn, 'bluetooth', dt + '').join(' ')),
                this.createVertexTemplateEntry(
                    'html=1;strokeWidth=1;shadow=0;dashed=0;shape=mxgraph.ios7.misc.broadcast;fillColor=#4CDA64;strokeColor=none;buttonText=;strokeColor2=#222222;fontColor=#222222;fontSize=8;verticalLabelPosition=bottom;verticalAlign=top;align=center;',
                    15, 15, '', 'Broadcast', null, null, this.getTagsForStencil(gn, 'broadcast', dt + '').join(' ')),
                this.createVertexTemplateEntry(
                    'html=1;strokeWidth=1;shadow=0;dashed=0;shape=mxgraph.ios7.misc.link;fillColor=#4CDA64;strokeColor=none;buttonText=;strokeColor2=#222222;fontColor=#222222;fontSize=8;verticalLabelPosition=bottom;verticalAlign=top;align=center;',
                    15, 15, '', 'Link', null, null, this.getTagsForStencil(gn, 'link', dt + '').join(' ')),
                this.createVertexTemplateEntry(
                    'html=1;strokeWidth=1;shadow=0;dashed=0;shape=mxgraph.ios7.misc.night;fillColor=#5855D6;strokeColor=none;buttonText=;strokeColor2=#222222;fontColor=#222222;fontSize=8;verticalLabelPosition=bottom;verticalAlign=top;align=center;',
                    15, 15, '', 'Night', null, null, this.getTagsForStencil(gn, 'night', dt + '').join(' ')),
                this.createVertexTemplateEntry(
                    'html=1;strokeWidth=1;shadow=0;dashed=0;shape=mxgraph.ios7.misc.notification;fillColor=#FF3B2F;strokeColor=none;buttonText=;strokeColor2=#222222;fontColor=#222222;fontSize=8;verticalLabelPosition=bottom;verticalAlign=top;align=center;',
                    15, 15, '', 'Notification', null, null, this.getTagsForStencil(gn, 'notification', dt + '').join(' ')),
                this.createVertexTemplateEntry(
                    'html=1;strokeWidth=1;shadow=0;dashed=0;shape=mxgraph.ios7.misc.settings;fillColor=#8F8E94;strokeColor=none;buttonText=;strokeColor2=#222222;fontColor=#222222;fontSize=8;verticalLabelPosition=bottom;verticalAlign=top;align=center;',
                    15, 15, '', 'Settings', null, null, this.getTagsForStencil(gn, 'settings', dt + '').join(' ')),
                this.createVertexTemplateEntry(
                    'html=1;strokeWidth=1;shadow=0;dashed=0;shape=mxgraph.ios7.misc.switch;fillColor=#8F8E94;strokeColor=none;buttonText=;strokeColor2=#222222;fontColor=#222222;fontSize=8;verticalLabelPosition=bottom;verticalAlign=top;align=center;',
                    15, 15, '', 'Switch', null, null, this.getTagsForStencil(gn, 'switch', dt + '').join(' ')),
                this.createVertexTemplateEntry(
                    'html=1;strokeWidth=1;shadow=0;dashed=0;shape=mxgraph.ios7.misc.text_size;fillColor=#007AFF;strokeColor=none;buttonText=;strokeColor2=#222222;fontColor=#222222;fontSize=8;verticalLabelPosition=bottom;verticalAlign=top;align=center;',
                    15, 15, '', 'Text Size', null, null, this.getTagsForStencil(gn, 'text size', dt + '').join(' ')),
                this.createVertexTemplateEntry(
                    'html=1;strokeWidth=1;shadow=0;dashed=0;shape=mxgraph.ios7.misc.travel;fillColor=#FF9501;strokeColor=none;buttonText=;strokeColor2=#222222;fontColor=#222222;fontSize=8;verticalLabelPosition=bottom;verticalAlign=top;align=center;',
                    15, 15, '', 'Travel', null, null, this.getTagsForStencil(gn, 'travel', dt + '').join(' ')),
                this.createVertexTemplateEntry(
                    'html=1;strokeWidth=1;shadow=0;dashed=0;shape=mxgraph.ios7.misc.vpn;fillColor=#007AFF;strokeColor=none;buttonText=;strokeColor2=#222222;fontColor=#222222;fontSize=8;verticalLabelPosition=bottom;verticalAlign=top;align=center;',
                    15, 15, '', 'VPN', null, null, this.getTagsForStencil(gn, 'vpn virtual private network', dt + '').join(' ')),
                this.createVertexTemplateEntry(
                    'html=1;strokeWidth=1;shadow=0;dashed=0;shape=mxgraph.ios7.misc.wifi;fillColor=#007AFF;strokeColor=none;buttonText=;strokeColor2=#222222;fontColor=#222222;fontSize=8;verticalLabelPosition=bottom;verticalAlign=top;align=center;',
                    15, 15, '', 'WiFi', null, null, this.getTagsForStencil(gn, 'wifi', dt + '').join(' ')),
                this.createVertexTemplateEntry(
                    s2 + 'url;fillColor=#e0e0e0;strokeColor=#c0c0c0;buttonText=;strokeColor2=#222222;fontColor=#222222;fontSize=8;spacingTop=2;align=center;',
                    sizeX * 0.825, sizeY * 0.03125, 'draw.io', 'URL', null, null, this.getTagsForStencil(gn, 'url', dt + 'url').join(' ')),
                this.createVertexTemplateEntry(
                    s + 'iconGrid;fillColor=#c0c0c0;gridSize=3,3;',
                    sizeX * 0.875, sizeY * 0.7, '', 'Icon grid', null, null, this.getTagsForStencil(gn, 'iconGrid', dt + 'icon grid').join(' ')),

                this.addEntry(dt + 'action dialog', function () {
                    var bg = new mxCell('', new mxGeometry(0, 0, 164, 60), 'shape=rect;fillColor=#a0a0a0;strokeColor=none;shadow=0;');
                    bg.vertex = true;
                    var button1 = new mxCell('Action', new mxGeometry(8, 6, 148, 21), 'html=1;strokeWidth=1;shadow=0;dashed=0;rounded=1;absoluteArcSize=1;arcSize=6;fontColor=#0080F0;fontSize=7;fontSize=14;fillColor=#e0e0e0;strokeColor=none;fontStyle=1;');
                    button1.vertex = true;
                    bg.insert(button1);
                    var button2 = new mxCell('Cancel', new mxGeometry(8, 33, 148, 21), 'html=1;strokeWidth=1;shadow=0;dashed=0;rounded=1;absoluteArcSize=1;arcSize=6;fontColor=#0080F0;fontSize=7;fontSize=14;fillColor=#e0e0e0;strokeColor=none;fontStyle=1;');
                    button2.vertex = true;
                    bg.insert(button2);

                    return sb.createVertexTemplateFromCells([bg], bg.geometry.width, bg.geometry.height, 'Action Dialog');
                }),

                this.createVertexTemplateEntry(s3 + 'iKeybLett;',
                    sizeX * 0.87, sizeY * 0.25, '', 'iPhone Keyboard (letters)', null, null, this.getTagsForStencil(gnm, 'keyboard letters', dt + '').join(' ')),
                this.createVertexTemplateEntry(s3 + 'iKeybNumb;',
                    sizeX * 0.87, sizeY * 0.25, '', 'iPhone Keyboard (numbers)', null, null, this.getTagsForStencil(gnm, 'keyboard letters', dt + '').join(' ')),
                this.createVertexTemplateEntry(s3 + 'iKeybSymb;',
                    sizeX * 0.87, sizeY * 0.25, '', 'iPhone Keyboard (symbols)', null, null, this.getTagsForStencil(gnm, 'keyboard symbols', dt + '').join(' ')),
                this.createVertexTemplateEntry(s3 + 'iKeybLett;',
                    sizeX * 1.66, sizeY * 0.36, '', "iPad 7''Keyboard (letters)", null, null, this.getTagsForStencil(gnm, 'keyboard letters', dt + '').join(' ')),
                this.createVertexTemplateEntry(s3 + 'iKeybNumb;',
                    sizeX * 1.66, sizeY * 0.36, '', "iPad 7'' Keyboard (numbers)", null, null, this.getTagsForStencil(gnm, 'keyboard letters', dt + '').join(' ')),
                this.createVertexTemplateEntry(s3 + 'iKeybSymb;',
                    sizeX * 1.66, sizeY * 0.36, '', "iPad 7'' Keyboard (symbols)", null, null, this.getTagsForStencil(gnm, 'keyboard symbols', dt + '').join(' ')),
                this.createVertexTemplateEntry(s3 + 'iKeybLett;',
                    sizeX * 2.21, sizeY * 0.48, '', "iPad 10''Keyboard (letters)", null, null, this.getTagsForStencil(gnm, 'keyboard letters', dt + '').join(' ')),
                this.createVertexTemplateEntry(s3 + 'iKeybNumb;',
                    sizeX * 2.21, sizeY * 0.48, '', "iPad 10'' Keyboard (numbers)", null, null, this.getTagsForStencil(gnm, 'keyboard letters', dt + '').join(' ')),
                this.createVertexTemplateEntry(s3 + 'iKeybSymb;',
                    sizeX * 2.21, sizeY * 0.48, '', "iPad 10'' Keyboard (symbols)", null, null, this.getTagsForStencil(gnm, 'keyboard symbols', dt + '').join(' ')),
                this.createVertexTemplateEntry(s3 + 'iKeybLett;',
                    sizeX * 2.53, sizeY * 0.55, '', "iPad 13''Keyboard (letters)", null, null, this.getTagsForStencil(gnm, 'keyboard letters', dt + '').join(' ')),
                this.createVertexTemplateEntry(s3 + 'iKeybNumb;',
                    sizeX * 2.53, sizeY * 0.55, '', "iPad 13'' Keyboard (numbers)", null, null, this.getTagsForStencil(gnm, 'keyboard letters', dt + '').join(' ')),
                this.createVertexTemplateEntry(s3 + 'iKeybSymb;',
                    sizeX * 2.53, sizeY * 0.55, '', "iPad 13'' Keyboard (symbols)", null, null, this.getTagsForStencil(gnm, 'keyboard symbols', dt + '').join(' ')),
                this.createVertexTemplateEntry(sm + 'call_pad;',
                    sizeX * 0.7, sizeY * 0.4, '', 'Call Pad', null, null, this.getTagsForStencil(gnm, 'call_pad', dt + '').join(' ')),
                this.createVertexTemplateEntry(
                    sm + 'number_pad;strokeWidth=1;',
                    sizeX * 0.7, sizeY * 0.4, '', 'Number Pad', null, null, this.getTagsForStencil(gnm, 'number_pad', dt + '').join(' ')),
                this.createVertexTemplateEntry(
                    sm + 'keyboard_(letters);',
                    sizeX * 0.875, sizeY * 0.3, '', 'Keyboard', null, null, this.getTagsForStencil(gnm, 'keyboard_(letters)', dt + '').join(' ')),
                this.createVertexTemplateEntry(
                    sm + 'scroll_(horizontal);fillColor=#a0a0a0;',
                    sizeX * 0.4, sizeY * 0.015, '', 'Scroll (Horizontal)', null, null, this.getTagsForStencil(gnm, 'scroll_(horizontal)', dt + '').join(' ')),
                this.createVertexTemplateEntry(
                    sm + 'scroll_(vertical);fillColor=#a0a0a0;',
                    sizeX * 0.03, sizeY * 0.2, '', 'Scroll (Vertical)', null, null, this.getTagsForStencil(gnm, 'scroll_(vertical)', dt + '').join(' ')),
                this.createVertexTemplateEntry(
                    sm + 'add;fillColor=#00dd00;strokeColor=#ffffff;',
                    sizeX * 0.06, sizeY * 0.03, '', 'Add', null, null, this.getTagsForStencil(gnm, 'add', dt + '').join(' ')),
                this.createVertexTemplateEntry(
                    sm + 'delete;fillColor=#ff0000;strokeColor=#ffffff;',
                    sizeX * 0.06, sizeY * 0.03, '', 'Delete', null, null, this.getTagsForStencil(gnm, 'delete', dt + '').join(' ')),
                this.createVertexTemplateEntry(
                    sm + 'select;fillColor=#0080f0;strokeColor=#ffffff;',
                    sizeX * 0.06, sizeY * 0.03, '', 'Select', null, null, this.getTagsForStencil(gnm, 'select', dt + '').join(' ')),
                this.createVertexTemplateEntry(
                    sm + 'remove;fillColor=#0080f0;strokeColor=#ffffff;',
                    sizeX * 0.08, sizeY * 0.03, '', 'Remove', null, null, this.getTagsForStencil(gnm, 'remove', dt + '').join(' ')),
                this.createVertexTemplateEntry(
                    sm + 'check;strokeColor=#0080f0;',
                    sizeX * 0.05, sizeY * 0.02, '', 'Check', null, null, this.getTagsForStencil(gnm, 'check', dt + '').join(' ')),
                this.createVertexTemplateEntry(
                    sm + 'flagged;strokeColor=#0080f0;',
                    sizeX * 0.06, sizeY * 0.03, '', 'Flagged', null, null, this.getTagsForStencil(gnm, 'flagged', dt + '').join(' ')),
                this.createVertexTemplateEntry(
                    sm + 'up;strokeColor=#0080f0;',
                    sizeX * 0.06, sizeY * 0.015, '', 'Up', null, null, this.getTagsForStencil(gnm, 'up', dt + '').join(' ')),
                this.createVertexTemplateEntry(
                    sm + 'down;strokeColor=#0080f0;',
                    sizeX * 0.06, sizeY * 0.015, '', 'Down', null, null, this.getTagsForStencil(gnm, 'down', dt + '').join(' ')),
                this.createVertexTemplateEntry(
                    sm + 'left;strokeColor=#0080f0;',
                    sizeX * 0.03, sizeY * 0.03, '', 'Left', null, null, this.getTagsForStencil(gnm, 'left', dt + '').join(' ')),
                this.createVertexTemplateEntry(
                    sm + 'right;strokeColor=#0080f0;',
                    sizeX * 0.03, sizeY * 0.03, '', 'Right', null, null, this.getTagsForStencil(gnm, 'right', dt + '').join(' ')),
                this.createVertexTemplateEntry(
                    sm + 'increase;fillColor=#ffffff;strokeColor=#0080f0;',
                    sizeX * 0.06, sizeY * 0.03, '', 'Increase', null, null, this.getTagsForStencil(gnm, 'increase', dt + '').join(' ')),
                this.createVertexTemplateEntry(
                    sm + 'info;fillColor=#ffffff;strokeColor=#0080f0;',
                    sizeX * 0.06, sizeY * 0.03, '', 'Info', null, null, this.getTagsForStencil(gnm, 'info', dt + '').join(' ')),
                this.createVertexTemplateEntry(
                    sm + 'more_2;strokeColor=#a0a0a0;',
                    sizeX * 0.03, sizeY * 0.02, '', 'More 2', null, null, this.getTagsForStencil(gnm, 'more_2', dt + '').join(' ')),
                this.createVertexTemplateEntry(
                    sm + 'more;strokeColor=#a0a0a0;',
                    sizeX * 0.025, sizeY * 0.02, '', 'More', null, null, this.getTagsForStencil(gnm, 'more', dt + '').join(' ')),
                this.createVertexTemplateEntry(
                    sm + 'options;fillColor=#222222;',
                    sizeX * 0.06, sizeY * 0.015, '', 'Options', null, null, this.getTagsForStencil(gnm, 'options', dt + '').join(' ')),
                this.createVertexTemplateEntry(
                    sm + 'pause;fillColor=#ffffff;strokeColor=#0080f0;',
                    sizeX * 0.06, sizeY * 0.03, '', 'Pause', null, null, this.getTagsForStencil(gnm, 'pause', dt + '').join(' ')),
                this.createVertexTemplateEntry(
                    sm + 'star;fillColor=#0080f0;strokeColor=none;',
                    sizeX * 0.06, sizeY * 0.03, '', 'Star', null, null, this.getTagsForStencil(gnm, 'star', dt + '').join(' ')),
                this.createVertexTemplateEntry(
                    sm + 'contacts_bar;strokeColor=#0080F0;fillColor=#e0e0e0',
                    sizeX * 0.875, sizeY * 0.07, '', 'Contacts Bar', null, null, this.getTagsForStencil(gnm, 'contacts_bar', dt + '').join(' ')),
                this.createVertexTemplateEntry(
                    sm + 'edit_bar;strokeColor=#0080F0;fillColor=#e0e0e0',
                    sizeX * 0.875, sizeY * 0.07, '', 'Edit Bar', null, null, this.getTagsForStencil(gnm, 'edit_bar', dt + '').join(' ')),
                this.createVertexTemplateEntry(
                    sm + 'message_bar;strokeColor=#0080F0;fillColor=#e0e0e0',
                    sizeX * 0.875, sizeY * 0.07, '', 'Message Bar', null, null, this.getTagsForStencil(gnm, 'message_bar', dt + '').join(' ')),
                this.createVertexTemplateEntry(
                    sm + 'misc_bar;strokeColor=#0080F0;fillColor=#e0e0e0',
                    sizeX * 0.875, sizeY * 0.07, '', 'Misc Bar', null, null, this.getTagsForStencil(gnm, 'misc_bar', dt + '').join(' ')),
                this.createVertexTemplateEntry(
                    s + 'onOffButton;buttonState=on;strokeColor=#38D145;strokeColor2=#aaaaaa;fillColor=#38D145;fillColor2=#ffffff;',
                    sizeX * 0.2175, sizeY * 0.0375, '', 'On-off button (On)', null, null, this.getTagsForStencil(gn, 'onOffButton', dt + '').join(' ')),
                this.createVertexTemplateEntry(
                    s + 'onOffButton;buttonState=off;strokeColor=#38D145;strokeColor2=#aaaaaa;fillColor=#38D145;fillColor2=#ffffff;',
                    sizeX * 0.2175, sizeY * 0.0375, '', 'On-off button (Off)', null, null, this.getTagsForStencil(gn, 'onOffButton', dt + '').join(' ')),
                this.createVertexTemplateEntry(
                    s2 + 'icon;fontSize=8;fontColor=#ffffff;buttonText=;whiteSpace=wrap;align=center;',
                    sizeX * 0.2, sizeY * 0.09, 'Icon', 'Icon', null, null, this.getTagsForStencil(gn, 'icon', dt + '').join(' ')),
                this.createVertexTemplateEntry(
                    sm + 'loading_circle;',
                    sizeX * 0.2, sizeY * 0.1, '', 'Loading Circle', null, null, this.getTagsForStencil(gnm, 'loading_circle', dt + '').join(' ')),
                this.createVertexTemplateEntry(
                    sm + 'circle;strokeColor=#222222;fillColor=none;',
                    sizeX * 0.06, sizeY * 0.03, '', 'Circle', null, null, this.getTagsForStencil(gnm, 'circle', dt + '').join(' ')),
                this.createVertexTemplateEntry(
                    s + 'pageControl;fillColor=#222222;strokeColor=#aaaaaa;',
                    sizeX * 0.25, sizeY * 0.0125, '', 'Page control', null, null, this.getTagsForStencil(gn, 'pageControl', dt + '').join(' ')),
                this.createVertexTemplateEntry(
                    sm + 'current_location;strokeColor=#ffffff;fillColor=#0080F0',
                    sizeX * 0.3, sizeY * 0.15, '', 'Current Location', null, null, this.getTagsForStencil(gnm, 'current_location', dt + '').join(' ')),
                this.createVertexTemplateEntry(
                    sm + 'expand;fillColor=#c0c0c0;',
                    sizeX * 0.12, sizeY * 0.015, '', 'Expand', null, null, this.getTagsForStencil(gnm, 'expand', dt + '').join(' ')),
                this.addDataEntry(dt + 'volume control', 160, 14, 'Volume Control',
                    'vVVdb8IgFP01fbTBVqvPuunTEpM97HFhchUyWhqgWvfrd1to/WjdjHEjacI9cLmcc4AG8Twtl5rm/EUxkEH8HMRzrZR1vbScg5RBRAQL4qcgigh+QbS4MjqsR0lONWT2loTIJeyoLMAhDjD2ID1gOM2rroY1LjkzVqtPmCupNIKZynBsthFSXkB+YdAWyqubqyG/syWoFKw+4JS9YJb7GYkjQDiILW/SRg6jxsXbNvVIFTuebT/z+HbmabmtDAqFMpMwFWYd7pQsUnhnap9dsA+iOKnbNalu0iXq1+XgLQ3HLuVEp6Sr0tRBGiS1YgdnxfqU8/VWSuA22mKDC63VZmPAdpRud3mT+KMHiF/k/yn9ecIPRjRns++83muFLz5o1mmsmfyBNePfreE2xeynYavzm6dfI5zitcCAYMCo4cB80OdoIUIjBQN0afZB9UpVVBLScRC9JcmULJDXTOV0LWylwZCQ7hlY1A1xTjMm4VV8VUVRusccgGnX8WHP5bvjicLw+PA7507/C98='),
                this.addDataEntry(dt + 'picker', 175, 160, 'Picker',
                    '7ZZta8IwEMc/Td5Km9i6vV3dZLDBYC/2OqxXE5Y2kkSt+/S7mtQHtEx8gg0Vofe/u9z1/6tQwrKyHhk+Ea86B0XYI2GZ0dr5q7LOQClCI5kTNiSURvgj9KkjGy+z0YQbqNwhDdQ3zLiagle8YN1CBUG4EtcaxoQ9WGf0F3zI3IlWETzXcwwiDHJuBeQhwMykOaGsx83d9aS2g6ns8epTaIP5MBiMg7pz+aUUNh+BLsGZBZbMwwZNxSDxbQLkWLRtqb/riFsvjFe9ay/wItix3xq2Y82zgxKV+FoWFbpy7/K7KYmTEGdaNTmcynjUfFE3YLFqc+ZB5tLjzGXhETGguJMz2Dr/FMP7XYZf7Zn8J4aHEW9a4mQaLbaPaTt0UVhwO4BWix3ELOlixi7MDIG9yArs79To8rOauo9nIZVq9UpXsLMi/avQ0/4FoKdd0Pu3P+oZmN2nF2A26GKW3JidgVlM706HhuH6zc+Xb74Y/gA=')
            ];

        this.addPalette('ios7ui', 'iOS UI', false, mxUtils.bind(this, function (content) {
            for (var i = 0; i < fns.length; i++) {
                content.appendChild(fns[i](content));
            }
        }));
    };

})();

(function () {
    Sidebar.prototype.addNetworkPalette = function () {
        var w = 50;
        var h = 50;
        var sb = this;
        var s0 = 'fontColor=#0066CC;verticalAlign=top;verticalLabelPosition=bottom;labelPosition=center;align=center;';
        var s = 'html=1;outlineConnect=0;fillColor=#CCCCCC;strokeColor=#6881B3;gradientColor=none;gradientDirection=north;strokeWidth=2;shape=mxgraph.networks.';
        var s1 = 'fontColor=#0066CC;';
        var gn = 'mxgraph.networks';
        var dt = 'computer network ';

        this.addPaletteFunctions('network', 'Network', false,
            [
                this.addDataEntry(dt + 'ring bus', 100, 100, 'Ring Bus',
                    '7VfJboMwEP0arpWBkNJjgTanSpF66NmKJ2DVYDQ429/XYIclKi2Nkp5AQrLfrLzHsDh+nB9XSMvsTTIQjv/i+DFKqcwqP8YghOMRzhw/cTyP6NPxXkesbmMlJUUo1JQAzwTsqdiBQQxQqZOwQKZy3VbiOn605ULEUkhsLH7cHBqvFMpP6FmWYehGfm3JaFnn0VV5WelVVALyHBRgh647KEqRMq6bPycrZAE9OOEIG8Vl0ZhQZXVXsnPXtbfN0Xb1wVntlXgasRcLqOA4SlgDWbZWIHVjeNIuNsALTMRpuD3YKnoXGMZJBjzN1BCjldmnbd5OG72w8nwvlf+7VOM6AEvh3TpaSlHuCgZ1clI7FOwZUR46O6NV1pp7N8EYrXWJAamKYgpqcJ9N4BlBUMX3w1Tf8WZD15LrjK0+l0xXcocbsE4XZLdVJ/G/mPmfwH8YPAwnxF2cgdtLEsySTJDEJWSgyP1GZDnrcc2IdMDtJXmcJfnDW+P8zCJ3G5Fw1mPKI2vxjyPyNEvykyR3f2u4ZBbgmpm44ZeV3nb/nMa9/0v6BQ=='),
                this.addDataEntry(dt + 'bus backbone', 260, 140, 'Bus',
                    '7ZdNj4IwEIZ/DVcD1HXd4wK7njYx8bDnKiM0FmqGori/fltaBb8Ws5EbJCb0nel0fF4yBIeEWTVDuk2/RAzcIR8OCVEIae6yKgTOHd9lsUMix/dd9XP8zztRr466W4qQy0c2+GbDjvISjGKEQh64FVKZqbYizyHBmnEeCi6wjpCwvpReSBQbaEUm06kXEBVJkMZM9XKM5SKHlhwxhJVkIq9DKNNTsW8W61XkayWlW91MViUa1CgHuRe4KUbLsvjfGWvRpKt21/Wl9C0gy0CC1pd0tVmqUvNGC47agv3ohhRcEliCgBKquy7UkrVgBkLVw4NKOZjoxJjk7u2f1sYctRRYktoq1kyXFmadnCo1Fqsb6/Jtx0m34/fthDiBhU20mFGUeQy6uIYBefyOKPZNvPX4XDtrjtZVz8hJignIsyf0AZgInEq2Oy91C5XdOhdMVfRd69r4Am4hSlyBTbrgezr1IeTjAflt5J7bG/OXgfkd5pPemE8G5reZXw3u5zF/HZj/Pc7tK9brb7xPBws6xnv/HrwNHnSM+/498NzBhI75/3QT1LL5WDTp7W/JXw=='),
                this.createVertexTemplateEntry(s + 'bus;gradientColor=none;gradientDirection=north;fontColor=#ffffff;perimeter=backbonePerimeter;backboneSize=20;', 200, 20, '', 'Bus', null, null, this.getTagsForStencil(gn, 'bus backbone', dt).join(' ')),
                this.createEdgeTemplateEntry(s + 'comm_link_edge;html=1;', 100, 100, '', 'Comm Link', null, this.getTagsForStencil(gn, 'comm_link_edge', dt).join(' ')),
                this.createVertexTemplateEntry(s0 + s + 'biometric_reader;', 60, 100, '', 'Biometric Reader', null, null, this.getTagsForStencil(gn, 'biometric_reader', dt).join(' ')),
                this.createVertexTemplateEntry(s0 + s + 'business_center;', 90, 100, '', 'Business Center', null, null, this.getTagsForStencil(gn, 'business_center', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'cloud;fontColor=#ffffff;', 90, 50, '', 'Cloud', null, null, this.getTagsForStencil(gn, 'cloud', dt).join(' ')),
                this.createVertexTemplateEntry(s0 + s + 'community;', 95, 100, '', 'Community', null, null, this.getTagsForStencil(gn, 'community', dt).join(' ')),
                this.createVertexTemplateEntry(s0 + s + 'comm_link;', 30, 100, '', 'Comm Link (Icon)', null, null, this.getTagsForStencil(gn, 'comm_link', dt).join(' ')),
                this.createVertexTemplateEntry(s0 + s + 'copier;', 100, 100, '', 'Copier', null, null, this.getTagsForStencil(gn, 'copier', dt).join(' ')),
                this.createVertexTemplateEntry(s0 + s + 'pc;', 100, 70, '', 'PC', null, null, this.getTagsForStencil(gn, 'pc', dt).join(' ')),
                this.createVertexTemplateEntry(s0 + s + 'desktop_pc;', 30, 60, '', 'Desktop PC', null, null, this.getTagsForStencil(gn, 'desktop_pc', dt + '').join(' ')),
                this.createVertexTemplateEntry(s0 + s + 'external_storage;', 90, 100, '', 'External Storage', null, null, this.getTagsForStencil(gn, 'external_storage', dt).join(' ')),
                this.createVertexTemplateEntry(s0 + s + 'firewall;', 100, 100, '', 'Firewall', null, null, this.getTagsForStencil(gn, 'firewall', dt).join(' ')),
                this.createVertexTemplateEntry(s0 + s + 'gamepad;', 100, 70, '', 'Gamepad', null, null, this.getTagsForStencil(gn, 'gamepad', dt).join(' ')),
                this.createVertexTemplateEntry(s0 + s + 'hub;', 100, 30, '', 'Hub', null, null, this.getTagsForStencil(gn, 'hub', dt).join(' ')),
                this.createVertexTemplateEntry(s0 + s + 'laptop;', 100, 55, '', 'Laptop', null, null, this.getTagsForStencil(gn, 'laptop', dt).join(' ')),
                this.createVertexTemplateEntry(s0 + s + 'load_balancer;', 100, 30, '', 'Load Balancer', null, null, this.getTagsForStencil(gn, 'load_balancer', dt).join(' ')),
                this.createVertexTemplateEntry(s0 + s + 'mail_server;', 105, 105, '', 'Mail Server', null, null, this.getTagsForStencil(gn, 'mail_server', dt).join(' ')),
                this.createVertexTemplateEntry(s0 + s + 'mainframe;', 80, 100, '', 'Mainframe', null, null, this.getTagsForStencil(gn, 'mainframe', dt).join(' ')),
                this.createVertexTemplateEntry(s0 + s + 'mobile;', 50, 100, '', 'Mobile', null, null, this.getTagsForStencil(gn, 'mobile', dt).join(' ')),
                this.createVertexTemplateEntry(s0 + s + 'modem;', 100, 30, '', 'Modem', null, null, this.getTagsForStencil(gn, 'modem', dt).join(' ')),
                this.createVertexTemplateEntry(s0 + s + 'monitor;', 80, 65, '', 'Monitor', null, null, this.getTagsForStencil(gn, 'monitor', dt).join(' ')),
                this.createVertexTemplateEntry(s0 + s + 'nas_filer;', 100, 35, '', 'NAS Filer', null, null, this.getTagsForStencil(gn, 'NAS Filer', dt).join(' ')),
                this.createVertexTemplateEntry(s0 + s + 'patch_panel;', 100, 35, '', 'Patch Panel', null, null, this.getTagsForStencil(gn, 'patch_panel', dt).join(' ')),
                this.createVertexTemplateEntry(s0 + s + 'pc;', 100, 70, '', 'PC', null, null, this.getTagsForStencil(gn, 'pc', dt).join(' ')),
                this.createVertexTemplateEntry(s0 + s + 'phone_1;', 100, 70, '', 'Phone', null, null, this.getTagsForStencil(gn, 'phone_1', dt).join(' ')),
                this.createVertexTemplateEntry(s0 + s + 'phone_2;', 100, 90, '', 'Phone', null, null, this.getTagsForStencil(gn, 'phone_2', dt).join(' ')),
                this.createVertexTemplateEntry(s0 + s + 'printer;', 100, 100, '', 'Printer', null, null, this.getTagsForStencil(gn, 'printer', dt).join(' ')),
                this.createVertexTemplateEntry(s0 + s + 'proxy_server;', 105, 105, '', 'Proxy Server', null, null, this.getTagsForStencil(gn, 'proxy_server', dt).join(' ')),
                this.createVertexTemplateEntry(s0 + s + 'rack;', 50, 100, '', 'Rack', null, null, this.getTagsForStencil(gn, 'rack', dt).join(' ')),
                this.createVertexTemplateEntry(s0 + s + 'radio_tower;', 55, 100, '', 'Radio Tower', null, null, this.getTagsForStencil(gn, 'radio_tower', dt).join(' ')),
                this.createVertexTemplateEntry(s0 + s + 'router;', 100, 30, '', 'Router', null, null, this.getTagsForStencil(gn, 'router', dt).join(' ')),
                this.createVertexTemplateEntry(s0 + s + 'satellite;', 100, 100, '', 'Satellite', null, null, this.getTagsForStencil(gn, 'satellite', dt).join(' ')),
                this.createVertexTemplateEntry(s0 + s + 'satellite_dish;', 90, 100, '', 'Satellite Dish', null, null, this.getTagsForStencil(gn, 'satellite_dish', dt).join(' ')),
                this.createVertexTemplateEntry(s0 + s + 'scanner;', 100, 75, '', 'Scanner', null, null, this.getTagsForStencil(gn, 'scanner', dt).join(' ')),
                this.createVertexTemplateEntry(s0 + s + 'secured;', 80, 100, '', 'Secured', null, null, this.getTagsForStencil(gn, 'secured', dt).join(' ')),
                this.createVertexTemplateEntry(s0 + s + 'security_camera;', 100, 75, '', 'Security Camera', null, null, this.getTagsForStencil(gn, 'security_camera', dt).join(' ')),
                this.createVertexTemplateEntry(s0 + s + 'server;', 90, 100, '', 'Server', null, null, this.getTagsForStencil(gn, 'server', dt).join(' ')),
                this.createVertexTemplateEntry(s0 + s + 'server_storage;', 105, 105, '', 'Server Storage', null, null, this.getTagsForStencil(gn, 'server_storage', dt).join(' ')),
                this.createVertexTemplateEntry(s0 + s + 'storage;', 100, 100, '', 'Storage', null, null, this.getTagsForStencil(gn, 'storage', dt).join(' ')),
                this.createVertexTemplateEntry(s0 + s + 'supercomputer;', 100, 100, '', 'Supercomputer', null, null, this.getTagsForStencil(gn, 'supercomputer', dt).join(' ')),
                this.createVertexTemplateEntry(s0 + s + 'switch;', 100, 30, '', 'Switch', null, null, this.getTagsForStencil(gn, 'switch', dt).join(' ')),
                this.createVertexTemplateEntry(s0 + s + 'tablet;', 100, 70, '', 'Tablet', null, null, this.getTagsForStencil(gn, 'tablet', dt).join(' ')),
                this.createVertexTemplateEntry(s0 + s + 'tape_storage;', 105, 105, '', 'Tape Storage', null, null, this.getTagsForStencil(gn, 'tape_storage', dt).join(' ')),
                this.createVertexTemplateEntry(s0 + s + 'terminal;', 80, 65, '', 'Terminal', null, null, this.getTagsForStencil(gn, 'terminal', dt).join(' ')),
                this.createVertexTemplateEntry(s0 + s + 'unsecure;', 80, 100, '', 'Unsecure', null, null, this.getTagsForStencil(gn, 'unsecure', dt).join(' ')),
                this.createVertexTemplateEntry(s0 + s + 'ups_enterprise;', 100, 100, '', 'UPS Enterprise', null, null, this.getTagsForStencil(gn, 'ups_enterprise', dt).join(' ')),
                this.createVertexTemplateEntry(s0 + s + 'ups_small;', 70, 100, '', 'UPS Small', null, null, this.getTagsForStencil(gn, 'ups_small', dt).join(' ')),
                this.createVertexTemplateEntry(s0 + s + 'usb_stick;', 45, 100, '', 'USB Stick', null, null, this.getTagsForStencil(gn, 'usb_stick', dt).join(' ')),
                this.createVertexTemplateEntry(s0 + s + 'users;', 90, 100, '', 'Users', null, null, this.getTagsForStencil(gn, 'users', dt).join(' ')),
                this.createVertexTemplateEntry(s0 + s + 'user_female;', 40, 100, '', 'User Female', null, null, this.getTagsForStencil(gn, 'user_female', dt).join(' ')),
                this.createVertexTemplateEntry(s0 + s + 'user_male;', 40, 100, '', 'User Male', null, null, this.getTagsForStencil(gn, 'user_male', dt).join(' ')),
                this.createVertexTemplateEntry(s0 + s + 'video_projector;', 100, 35, '', 'Video Projector', null, null, this.getTagsForStencil(gn, 'video_projector', dt).join(' ')),
                this.createVertexTemplateEntry(s0 + s + 'video_projector_screen;', 80, 100, '', 'Video Projector Screen', null, null, this.getTagsForStencil(gn, 'video_projector_screen', dt).join(' ')),
                this.createVertexTemplateEntry(s0 + s + 'virtual_pc;', 115, 85, '', 'Virtual PC', null, null, this.getTagsForStencil(gn, 'virtual_pc', dt).join(' ')),
                this.createVertexTemplateEntry(s0 + s + 'virtual_server;', 110, 120, '', 'Virtual Server', null, null, this.getTagsForStencil(gn, 'virtual_server', dt).join(' ')),
                this.createVertexTemplateEntry(s0 + s + 'virus;', 100, 90, '', 'Virus', null, null, this.getTagsForStencil(gn, 'virus', dt).join(' ')),
                this.createVertexTemplateEntry(s0 + s + 'web_server;', 105, 105, '', 'Web Server', null, null, this.getTagsForStencil(gn, 'web_server', dt).join(' ')),
                this.createVertexTemplateEntry(s0 + s + 'wireless_hub;', 100, 85, '', 'Wireless Hub', null, null, this.getTagsForStencil(gn, 'wireless_hub', dt).join(' ')),
                this.createVertexTemplateEntry(s0 + s + 'wireless_modem;', 100, 85, '', 'Wireless Modem', null, null, this.getTagsForStencil(gn, 'wireless_modem', dt).join(' '))
            ]);
    };

})();

(function () {
    // Adds Web Icons shapes
    Sidebar.prototype.addWebIconsPalette = function () {
        var sb = this;
        var s = 'dashed=0;outlineConnect=0;html=1;align=center;labelPosition=center;verticalLabelPosition=bottom;verticalAlign=top;' + mxConstants.STYLE_SHAPE + "=mxgraph.webicons.";
        var gn = 'mxgraph.webicons';
        var dt = 'web icons icon';
        var w = 0.2;
        var h = 0.2;

        this.addPaletteFunctions('webicons', 'Web Icons', false,
            [
                this.createVertexTemplateEntry(s + 'adfty;fillColor=#66E8F3;gradientColor=#1C7CBA',
                    w * 512, h * 512, '', 'Adfty', null, null, this.getTagsForStencil(gn, 'adfty', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'adobe_pdf;fillColor=#F40C0C;gradientColor=#610603',
                    w * 512, h * 512, '', 'Adobe PDF', null, null, this.getTagsForStencil(gn, 'adobe pdf', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'aim;fillColor=#27E1E5;gradientColor=#0A4361',
                    w * 512, h * 512, '', 'Aim', null, null, this.getTagsForStencil(gn, 'aim', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'allvoices;fillColor=#807E7E;gradientColor=#1B1C1C',
                    w * 512, h * 512, '', 'Allvoices', null, null, this.getTagsForStencil(gn, 'allvoices', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'amazon;fillColor=#FFFFFF;gradientColor=#DFDEDE',
                    w * 512, h * 512, '', 'Amazon', null, null, this.getTagsForStencil(gn, 'amazon', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'amazon_2;fillColor=#605658;gradientColor=#231F20',
                    w * 512, h * 512, '', 'Amazon', null, null, this.getTagsForStencil(gn, 'amazon', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'android;fillColor=#FFFFFF;gradientColor=#DFDEDE',
                    w * 512, h * 512, '', 'Android', null, null, this.getTagsForStencil(gn, 'android', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'apache;fillColor=#FFFFFF;gradientColor=#DFDEDE',
                    w * 512, h * 512, '', 'Apache', null, null, this.getTagsForStencil(gn, 'apache db database', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'apple;fillColor=#807E7E;gradientColor=#1B1C1C',
                    w * 512, h * 512, '', 'Apple', null, null, this.getTagsForStencil(gn, 'apple', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'apple_classic;fillColor=#66E8F3;gradientColor=#1C7CBA',
                    w * 512, h * 512, '', 'Apple (classic)', null, null, this.getTagsForStencil(gn, 'apple classic', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'arduino;fillColor=#FFFFFF;gradientColor=#DFDEDE',
                    w * 512, h * 512, '', 'Arduino', null, null, this.getTagsForStencil(gn, 'arduino', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'ask;fillColor=#F33543;gradientColor=#B50E11',
                    w * 512, h * 512, '', 'Ask', null, null, this.getTagsForStencil(gn, 'ask', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'atlassian;fillColor=#FFFFFF;gradientColor=#DFDEDE',
                    w * 512, h * 512, '', 'Atlassian', null, null, this.getTagsForStencil(gn, 'atlassian', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'audioboo;fillColor=#EB35CF;gradientColor=#8C0E35',
                    w * 512, h * 512, '', 'Audioboo', null, null, this.getTagsForStencil(gn, 'audioboo', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'aws;fillColor=#FFFFFF;gradientColor=#DFDEDE',
                    w * 512, h * 512, '', 'AWS', null, null, this.getTagsForStencil(gn, 'aws amazon web service', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'aws_s3;fillColor=#FFFFFF;gradientColor=#DFDEDE',
                    w * 512, h * 512, '', 'AWS S3', null, null, this.getTagsForStencil(gn, 'aws s3 amazon web service', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'baidu;fillColor=#738FE8;gradientColor=#1F2470',
                    w * 512, h * 512, '', 'Baidu', null, null, this.getTagsForStencil(gn, 'baidu', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'bebo;fillColor=#695D5D;gradientColor=#100E0E',
                    w * 512, h * 512, '', 'Bebo', null, null, this.getTagsForStencil(gn, 'bebo', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'behance;fillColor=#695D5D;gradientColor=#100E0E',
                    w * 512, h * 512, '', 'Behance', null, null, this.getTagsForStencil(gn, 'behance', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'bing;fillColor=#0A776E;gradientColor=#053D39',
                    w * 512, h * 512, '', 'Bing', null, null, this.getTagsForStencil(gn, 'bing', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'bitbucket;fillColor=#FFFFFF;gradientColor=#DFDEDE',
                    w * 512, h * 512, '', 'Bitbucket', null, null, this.getTagsForStencil(gn, 'bitbucket', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'blinklist;fillColor=#695D5D;gradientColor=#100E0E',
                    w * 512, h * 512, '', 'Blinklist', null, null, this.getTagsForStencil(gn, 'blinklist', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'blogger;fillColor=#FDE47C;gradientColor=#F55F21',
                    w * 512, h * 512, '', 'Blogger', null, null, this.getTagsForStencil(gn, 'blogger', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'blogmarks;fillColor=#FFFFFF;gradientColor=#DFDEDE',
                    w * 512, h * 512, '', 'Blogmarks', null, null, this.getTagsForStencil(gn, 'blogmarks', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'bookmarks.fr;fillColor=#F9FAF4;gradientColor=#DCDFBB',
                    w * 512, h * 512, '', 'Bookmarks.fr', null, null, this.getTagsForStencil(gn, 'bookmarks.fr', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'box;fillColor=#4CDFEF;gradientColor=#153EA0',
                    w * 512, h * 512, '', 'Box', null, null, this.getTagsForStencil(gn, 'box', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'buddymarks;fillColor=#FFFFFF;gradientColor=#DFDEDE',
                    w * 512, h * 512, '', 'Buddymarks', null, null, this.getTagsForStencil(gn, 'buddymarks', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'buffer;fillColor=#FFFFFF;gradientColor=#DFDEDE',
                    w * 512, h * 512, '', 'Buffer', null, null, this.getTagsForStencil(gn, 'buffer', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'buzzfeed;fillColor=#FFFFFF;gradientColor=#DFDEDE',
                    w * 512, h * 512, '', 'Buzzfeed', null, null, this.getTagsForStencil(gn, 'buzzfeed', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'chrome;fillColor=#FFFFFF;gradientColor=#DFDEDE',
                    w * 516, h * 520, '', 'Chrome', null, null, this.getTagsForStencil(gn, 'chrome', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'citeulike;fillColor=#ACD65E;gradientColor=#2E3618',
                    w * 512, h * 512, '', 'Citeulike', null, null, this.getTagsForStencil(gn, 'citeulike', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'confluence;fillColor=#FFFFFF;gradientColor=#DFDEDE',
                    w * 512, h * 512, '', 'Confluence', null, null, this.getTagsForStencil(gn, 'confluence', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'connotea;fillColor=#E9FDFC;gradientColor=#BADBE9',
                    w * 512, h * 512, '', 'Connotea', null, null, this.getTagsForStencil(gn, 'connotea', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'dealsplus;fillColor=#B569B5;gradientColor=#7A467A',
                    w * 512, h * 512, '', 'Dealsplus', null, null, this.getTagsForStencil(gn, 'dealsplus', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'delicious',
                    w * 512, h * 512, '', 'Delicious', null, null, this.getTagsForStencil(gn, 'delicious', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'designfloat;fillColor=#247BE0;gradientColor=#0A1F42',
                    w * 512, h * 512, '', 'Designfloat', null, null, this.getTagsForStencil(gn, 'designfloat', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'deviantart;fillColor=#00C659;gradientColor=#00813B',
                    w * 512, h * 512, '', 'Deviantart', null, null, this.getTagsForStencil(gn, 'deviantart', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'digg;fillColor=#FFFFFF;gradientColor=#DFDEDE',
                    w * 512, h * 512, '', 'Digg', null, null, this.getTagsForStencil(gn, 'digg', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'diigo;fillColor=#2C7DE0;gradientColor=#1E5599',
                    w * 512, h * 512, '', 'Diigo', null, null, this.getTagsForStencil(gn, 'diiigo', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'dopplr;fillColor=#FFFFFF;gradientColor=#DFDEDE',
                    w * 512, h * 512, '', 'Dopplr', null, null, this.getTagsForStencil(gn, 'dopplr', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'drawio2;fillColor=#2174CE;gradientColor=#134277',
                    w * 512, h * 512, '', 'Draw.io', null, null, this.getTagsForStencil(gn, 'drawio draw io draw.io', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'dribbble;fillColor=#FFFFFF;gradientColor=#DFDEDE',
                    w * 512, h * 512, '', 'Dribbble', null, null, this.getTagsForStencil(gn, 'dribbble', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'dropbox;fillColor=#0BAAFE;gradientColor=#0080E6',
                    w * 512, h * 512, '', 'Dropbox', null, null, this.getTagsForStencil(gn, 'dropbox', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'dropbox2;fillColor=#2FB8FC;gradientColor=#0080E6',
                    w * 512, h * 512, '', 'Dropbox', null, null, this.getTagsForStencil(gn, 'dropbox', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'drupal;fillColor=#FFFFFF;gradientColor=#DFDEDE',
                    w * 512, h * 512, '', 'Drupal', null, null, this.getTagsForStencil(gn, 'drupal', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'dzone;fillColor=#FFFFFF;gradientColor=#DFDEDE',
                    w * 512, h * 512, '', 'Dzone', null, null, this.getTagsForStencil(gn, 'dzone', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'ebay;fillColor=#FFFFFF;gradientColor=#DFDEDE',
                    w * 512, h * 512, '', 'Ebay', null, null, this.getTagsForStencil(gn, 'ebay', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'edmodo;fillColor=#2F81CE;gradientColor=#1F5487',
                    w * 512, h * 512, '', 'Edmodo', null, null, this.getTagsForStencil(gn, 'edmodo', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'evernote;fillColor=#D4EF75;gradientColor=#399F1F',
                    w * 512, h * 512, '', 'Evernote', null, null, this.getTagsForStencil(gn, 'evernote', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'facebook;fillColor=#6294E4;gradientColor=#1A2665',
                    w * 512, h * 512, '', 'Facebook', null, null, this.getTagsForStencil(gn, 'facebook', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'fancy;fillColor=#C3ECF8;gradientColor=#348DD4',
                    w * 512, h * 512, '', 'Fancy', null, null, this.getTagsForStencil(gn, 'fancy', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'fark;fillColor=#EBEBF1;gradientColor=#8482A7',
                    w * 512, h * 512, '', 'Fark', null, null, this.getTagsForStencil(gn, 'fark', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'fashiolista;fillColor=#FFFFFF;gradientColor=#DFDEDE',
                    w * 512, h * 512, '', 'Fashiolista', null, null, this.getTagsForStencil(gn, 'fashiolista', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'feed;fillColor=#FFAC75;gradientColor=#FF6600',
                    w * 512, h * 512, '', 'Feed', null, null, this.getTagsForStencil(gn, 'feed', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'feedburner;fillColor=#FFFFFF;gradientColor=#DFDEDE',
                    w * 512, h * 512, '', 'Feedburner', null, null, this.getTagsForStencil(gn, 'feedburner', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'flickr;fillColor=#FFFFFF;gradientColor=#DFDEDE',
                    w * 512, h * 512, '', 'Flickr', null, null, this.getTagsForStencil(gn, 'flickr', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'folkd;fillColor=#27A2E9;gradientColor=#0A2977',
                    w * 512, h * 512, '', 'Folkd', null, null, this.getTagsForStencil(gn, 'folkd', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'forrst;fillColor=#3E6B32;gradientColor=#111C0D',
                    w * 512, h * 512, '', 'Forrst', null, null, this.getTagsForStencil(gn, 'forrst', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'fotolog;fillColor=#FFFFFF;gradientColor=#DFDEDE',
                    w * 512, h * 512, '', 'Fotolog', null, null, this.getTagsForStencil(gn, 'fotolog', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'freshbump;fillColor=#695D5D;gradientColor=#100E0E',
                    w * 512, h * 512, '', 'Freshbump', null, null, this.getTagsForStencil(gn, 'freshbump', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'fresqui;fillColor=#FFFFFF;gradientColor=#DFDEDE',
                    w * 512, h * 512, '', 'Fresqui', null, null, this.getTagsForStencil(gn, 'fresqui', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'friendfeed;fillColor=#7BDCEF;gradientColor=#21379E',
                    w * 512, h * 512, '', 'Friendfeed', null, null, this.getTagsForStencil(gn, 'fiendfeed', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'funp;fillColor=#FFFFFF;gradientColor=#DFDEDE',
                    w * 512, h * 512, '', 'Funp', null, null, this.getTagsForStencil(gn, 'funp', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'fwisp;fillColor=#FFFFFF;gradientColor=#DFDEDE',
                    w * 512, h * 512, '', 'Fwisp', null, null, this.getTagsForStencil(gn, 'fwisp', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'gabbr;fillColor=#FBAC39;gradientColor=#EA2B0E',
                    w * 512, h * 512, '', 'Gabbr', null, null, this.getTagsForStencil(gn, 'gabbr', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'gamespot;fillColor=#695D5D;gradientColor=#100E0E',
                    w * 512, h * 512, '', 'Gamespot', null, null, this.getTagsForStencil(gn, 'gamespot', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'github;fillColor=#FFFFFF;gradientColor=#DFDEDE',
                    w * 512, h * 512, '', 'Github', null, null, this.getTagsForStencil(gn, 'github', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'gmail;fillColor=#FFFFFF;gradientColor=#DFDEDE',
                    w * 512, h * 512, '', 'Gmail', null, null, this.getTagsForStencil(gn, 'gmail', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'google;fillColor=#FFFFFF;gradientColor=#DFDEDE',
                    w * 512, h * 512, '', 'Google', null, null, this.getTagsForStencil(gn, 'google', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'google_drive;fillColor=#FFFFFF;gradientColor=#DFDEDE',
                    w * 512, h * 512, '', 'Google Drive', null, null, this.getTagsForStencil(gn, 'google drive', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'google_hangout;fillColor=#FFFFFF;gradientColor=#DFDEDE',
                    w * 512, h * 512, '', 'Google Hangout', null, null, this.getTagsForStencil(gn, 'google hangout', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'google_play;fillColor=#000000',
                    w * 347, h * 103, '', 'Google Play', null, null, this.getTagsForStencil(gn, 'google play', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'google_play_light;fillColor=#66E8F3;gradientColor=#1C7CBA',
                    w * 300, h * 52, '', 'Google Play Light', null, null, this.getTagsForStencil(gn, 'google play light', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'google_photos;fillColor=#FFFFFF;gradientColor=#DFDEDE',
                    w * 512, h * 512, '', 'Google Photos', null, null, this.getTagsForStencil(gn, 'google photos', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'google_plus;fillColor=#F24B46;gradientColor=#AD3832',
                    w * 512, h * 512, '', 'Google Plus', null, null, this.getTagsForStencil(gn, 'google plus', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'grooveshark;fillColor=#695D5D;gradientColor=#000000',
                    w * 512, h * 512, '', 'Grooveshark', null, null, this.getTagsForStencil(gn, 'grooveshark', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'hatena;fillColor=#FFFFFF;gradientColor=#DFDEDE',
                    w * 512, h * 512, '', 'Hatena', null, null, this.getTagsForStencil(gn, 'hatena', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'html5;fillColor=#FFFFFF;gradientColor=#DFDEDE',
                    w * 512, h * 512, '', 'HTML5', null, null, this.getTagsForStencil(gn, 'html5 html', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'identi.ca;fillColor=#FFFFFF;gradientColor=#DFDEDE',
                    w * 512, h * 512, '', 'Identi.ca', null, null, this.getTagsForStencil(gn, 'identi.ca', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'instagram;fillColor=#FFFFFF;gradientColor=#DFDEDE',
                    w * 512, h * 512, '', 'Instagram', null, null, this.getTagsForStencil(gn, 'instagram', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'instapaper;fillColor=#807E7E;gradientColor=#1B1C1C',
                    w * 512, h * 512, '', 'Instapaper', null, null, this.getTagsForStencil(gn, 'instapaper', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'ios;fillColor=#695D5D;gradientColor=#100E0E',
                    w * 512, h * 512, '', 'iOS', null, null, this.getTagsForStencil(gn, 'ios', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'jamespot;fillColor=#695D5D;gradientColor=#100E0E',
                    w * 512, h * 512, '', 'Jamespot', null, null, this.getTagsForStencil(gn, 'jamespot', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'java;fillColor=#FFFFFF;gradientColor=#DFDEDE',
                    w * 512, h * 512, '', 'Java', null, null, this.getTagsForStencil(gn, 'java', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'joomla;fillColor=#1F457D;gradientColor=#081220',
                    w * 512, h * 512, '', 'Joomla', null, null, this.getTagsForStencil(gn, 'joomla', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'jquery;fillColor=#0BB9EA;gradientColor=#032F80',
                    w * 512, h * 512, '', 'Jquery', null, null, this.getTagsForStencil(gn, 'jquery', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'json;fillColor=#FFFFFF;gradientColor=#DFDEDE',
                    w * 512, h * 512, '', 'JSON', null, null, this.getTagsForStencil(gn, 'json', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'json_2;fillColor=#FFFFFF;gradientColor=#DFDEDE',
                    w * 512, h * 512, '', 'JSON', null, null, this.getTagsForStencil(gn, 'json', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'last.fm;fillColor=#F33543;gradientColor=#BD0E11',
                    w * 512, h * 512, '', 'Last.fm', null, null, this.getTagsForStencil(gn, 'last.fm last fm', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'linkagogo;fillColor=#F6F5FA;gradientColor=#C8C1E1',
                    w * 512, h * 512, '', 'Linkagogo', null, null, this.getTagsForStencil(gn, 'linkagogo', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'linkedin;fillColor=#0095DB;gradientColor=#006391',
                    w * 512, h * 512, '', 'LinkedIn', null, null, this.getTagsForStencil(gn, 'linkedin', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'livejournal;fillColor=#2690E5;gradientColor=#0A2463',
                    w * 512, h * 512, '', 'Livejournal', null, null, this.getTagsForStencil(gn, 'livejournal', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'mail.ru;fillColor=#267BE0;gradientColor=#0A1F42',
                    w * 512, h * 512, '', 'Mail.ru', null, null, this.getTagsForStencil(gn, 'mail.ru', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'meetup;fillColor=#F83263;gradientColor=#D40D19',
                    w * 512, h * 512, '', 'Meetup', null, null, this.getTagsForStencil(gn, 'meetup', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'meneame;fillColor=#FFFFFF;gradientColor=#DFDEDE',
                    w * 512, h * 512, '', 'Meneame', null, null, this.getTagsForStencil(gn, 'meneame', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'messenger;fillColor=#FFFFFF;gradientColor=#DFDEDE',
                    w * 512, h * 512, '', 'Messenger', null, null, this.getTagsForStencil(gn, 'messenger', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'messenger_2;fillColor=#FFFFFF;gradientColor=#DFDEDE',
                    w * 512, h * 512, '', 'Messenger', null, null, this.getTagsForStencil(gn, 'messenger', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'messenger_3;fillColor=#09BEFC;gradientColor=#0060FA',
                    w * 512, h * 512, '', 'Messenger', null, null, this.getTagsForStencil(gn, 'messenger', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'mind_body_green;fillColor=#E0EEF8;gradientColor=#4496D5',
                    w * 512, h * 512, '', 'Mind Body Green', null, null, this.getTagsForStencil(gn, 'mind body green', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'mongodb;fillColor=#FFFFFF;gradientColor=#DFDEDE',
                    w * 512, h * 512, '', 'MongoDb', null, null, this.getTagsForStencil(gn, 'mongodb', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'myspace;fillColor=#3C69E2;gradientColor=#101B54',
                    w * 512, h * 512, '', 'MySpace', null, null, this.getTagsForStencil(gn, 'myspace', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'n4g;fillColor=#FFFFFF;gradientColor=#DFDEDE',
                    w * 512, h * 512, '', 'N4g', null, null, this.getTagsForStencil(gn, 'n4g', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'netlog;fillColor=#FA3743;gradientColor=#E10E11',
                    w * 512, h * 512, '', 'Netlog', null, null, this.getTagsForStencil(gn, 'netlog', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'netvibes;fillColor=#99DB00;gradientColor=#638E00',
                    w * 512, h * 512, '', 'Netvibes', null, null, this.getTagsForStencil(gn, 'netvibes', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'netvouz;fillColor=#FFFFFF;gradientColor=#DFDEDE',
                    w * 512, h * 512, '', 'Netvouz', null, null, this.getTagsForStencil(gn, 'netvouz', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'networkedblogs;fillColor=#FFFFFF;gradientColor=#DFDEDE',
                    w * 512, h * 512, '', 'Networkedblogs', null, null, this.getTagsForStencil(gn, 'networkedblogs', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'newsvine;fillColor=#008733;gradientColor=#00441B',
                    w * 512, h * 512, '', 'Newsvine', null, null, this.getTagsForStencil(gn, 'newsvine', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'odnoklassniki;fillColor=#FDE15A;gradientColor=#F24317',
                    w * 512, h * 512, '', 'Odnoklassniki', null, null, this.getTagsForStencil(gn, 'odnoklassniki', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'oknotizie;fillColor=#FFFFFF;gradientColor=#DFDEDE',
                    w * 512, h * 512, '', 'Oknotizie', null, null, this.getTagsForStencil(gn, 'oknotizie', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'onedrive;fillColor=#FFFFFF;gradientColor=#DFDEDE',
                    w * 512, h * 512, '', 'OneDrive', null, null, this.getTagsForStencil(gn, 'onedrive', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'oracle;fillColor=#FA3743;gradientColor=#E10E11',
                    w * 512, h * 512, '', 'Oracle', null, null, this.getTagsForStencil(gn, 'oracle', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'paypal;fillColor=#FFFFFF;gradientColor=#DFDEDE',
                    w * 512, h * 512, '', 'Paypal', null, null, this.getTagsForStencil(gn, 'paypal', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'phone;fillColor=#76F21E;gradientColor=#079704',
                    w * 512, h * 512, '', 'Phone', null, null, this.getTagsForStencil(gn, 'phone', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'phonefavs;fillColor=#FFFFFF;gradientColor=#DFDEDE',
                    w * 512, h * 512, '', 'Phonefavs', null, null, this.getTagsForStencil(gn, 'phonefavs', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'pinterest;fillColor=#E50B28;gradientColor=#890616',
                    w * 512, h * 512, '', 'Pinterest', null, null, this.getTagsForStencil(gn, 'pinterest', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'plaxo;fillColor=#FFFFFF;gradientColor=#DFDEDE',
                    w * 512, h * 512, '', 'Plaxo', null, null, this.getTagsForStencil(gn, 'plaxo', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'playfire;fillColor=#695D5D;gradientColor=#100E0E',
                    w * 512, h * 512, '', 'Playfire', null, null, this.getTagsForStencil(gn, 'playfire', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'plurk;fillColor=#FF5656;gradientColor=#A8312D',
                    w * 512, h * 512, '', 'Plurk', null, null, this.getTagsForStencil(gn, 'plurk', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'pocket;fillColor=#FF4460;gradientColor=#B73143',
                    w * 512, h * 512, '', 'Pocket', null, null, this.getTagsForStencil(gn, 'pocket', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'protopage;fillColor=#4B78C0;gradientColor=#294282',
                    w * 512, h * 512, '', 'Protopage', null, null, this.getTagsForStencil(gn, 'protopage', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'readernaut;fillColor=#695D5D;gradientColor=#100E0E',
                    w * 512, h * 512, '', 'Readernaut', null, null, this.getTagsForStencil(gn, 'readernaut', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'reddit;fillColor=#F3F8FC;gradientColor=#B4D2F0',
                    w * 512, h * 512, '', 'Reddit', null, null, this.getTagsForStencil(gn, 'reddit', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'rss;fillColor=#FDE532;gradientColor=#F4600D',
                    w * 512, h * 512, '', 'RSS', null, null, this.getTagsForStencil(gn, 'rss', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'scoopit;fillColor=#8CD845;gradientColor=#4E7A27',
                    w * 512, h * 512, '', 'Scoopit', null, null, this.getTagsForStencil(gn, 'scoopit', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'scribd;fillColor=#1D637D;gradientColor=#071920',
                    w * 512, h * 512, '', 'Scribd', null, null, this.getTagsForStencil(gn, 'scribd', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'segnalo;fillColor=#FFFFFF;gradientColor=#DFDEDE',
                    w * 512, h * 512, '', 'Segnalo', null, null, this.getTagsForStencil(gn, 'segnalo', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'sina;fillColor=#FFFFFF;gradientColor=#DFDEDE',
                    w * 512, h * 512, '', 'Sina', null, null, this.getTagsForStencil(gn, 'sina', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'sitejot;fillColor=#FFFFFF;gradientColor=#DFDEDE',
                    w * 512, h * 512, '', 'Sitejot', null, null, this.getTagsForStencil(gn, 'sitejot', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'skype;fillColor=#FFFFFF;gradientColor=#DFDEDE',
                    w * 512, h * 512, '', 'Skype', null, null, this.getTagsForStencil(gn, 'skype', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'skyrock;fillColor=#47B8FF;gradientColor=#006AAD',
                    w * 512, h * 512, '', 'Skyrock', null, null, this.getTagsForStencil(gn, 'skyrock', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'slashdot;fillColor=#03B2AC;gradientColor=#012C2C',
                    w * 512, h * 512, '', 'Slashdot', null, null, this.getTagsForStencil(gn, 'slashdot', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'sms;fillColor=#86D466;gradientColor=#42B418',
                    w * 512, h * 512, '', 'SMS', null, null, this.getTagsForStencil(gn, 'sms', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'socialvibe;fillColor=#FA16E2;gradientColor=#DF064B',
                    w * 512, h * 512, '', 'Socialvibe', null, null, this.getTagsForStencil(gn, 'socialvibe', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'society6;fillColor=#695D5D;gradientColor=#100E0E',
                    w * 512, h * 512, '', 'Society6', null, null, this.getTagsForStencil(gn, 'society6', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'sonico;fillColor=#3FEAF6;gradientColor=#117EC9',
                    w * 512, h * 512, '', 'Sonico', null, null, this.getTagsForStencil(gn, 'sonico', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'soundcloud;fillColor=#F78E11;gradientColor=#F93A0E',
                    w * 512, h * 512, '', 'Soundcloud', null, null, this.getTagsForStencil(gn, 'soundcloud', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'sourceforge;fillColor=#FFFFFF;gradientColor=#DFDEDE',
                    w * 512, h * 512, '', 'Sourceforge', null, null, this.getTagsForStencil(gn, 'sourceforge', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'sourceforge_2;fillColor=#0078AF;gradientColor=#00385E',
                    w * 512, h * 512, '', 'Sourceforge', null, null, this.getTagsForStencil(gn, 'sourceforge', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'spring.me;fillColor=#3CBEF2;gradientColor=#2B8AAF',
                    w * 512, h * 512, '', 'Spring.me', null, null, this.getTagsForStencil(gn, 'spring me', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'stackexchange;fillColor=#FFFFFF;gradientColor=#DFDEDE',
                    w * 512, h * 512, '', 'Stackexchange', null, null, this.getTagsForStencil(gn, 'stackexchange stack exchange', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'stackoverflow;fillColor=#FFFFFF;gradientColor=#DFDEDE',
                    w * 512, h * 512, '', 'StackOverflow', null, null, this.getTagsForStencil(gn, 'stackoverflow stack overflow', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'startaid;fillColor=#47B0E5;gradientColor=#2F7599',
                    w * 512, h * 512, '', 'Startaid', null, null, this.getTagsForStencil(gn, 'startaid', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'startlap;fillColor=#B9E6F0;gradientColor=#3062A2',
                    w * 512, h * 512, '', 'Startlap', null, null, this.getTagsForStencil(gn, 'startlap', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'steam;fillColor=#695D5D;gradientColor=#100E0E',
                    w * 512, h * 512, '', 'Steam', null, null, this.getTagsForStencil(gn, 'steam', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'stumbleupon;fillColor=#FA823C;gradientColor=#E12110',
                    w * 512, h * 512, '', 'StumbleUpon', null, null, this.getTagsForStencil(gn, 'stumbleupon', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'stumpedia;fillColor=#FFFFFF;gradientColor=#DFDEDE',
                    w * 512, h * 512, '', 'Stumpedia', null, null, this.getTagsForStencil(gn, 'stumpedia', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'technorati;fillColor=#99EC92;gradientColor=#288925',
                    w * 512, h * 512, '', 'Technorati', null, null, this.getTagsForStencil(gn, 'technorati', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'translate;fillColor=#FFFFFF;gradientColor=#DFDEDE',
                    w * 512, h * 512, '', 'Translate', null, null, this.getTagsForStencil(gn, 'translate', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'tumblr;fillColor=#588BBC;gradientColor=#172330',
                    w * 512, h * 512, '', 'Tumblr', null, null, this.getTagsForStencil(gn, 'tumblr', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'tunein;fillColor=#FFFFFF;gradientColor=#DFDEDE',
                    w * 512, h * 512, '', 'Tunein', null, null, this.getTagsForStencil(gn, 'tunein', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'twitter;fillColor=#49EAF7;gradientColor=#137BD0',
                    w * 512, h * 512, '', 'Twitter', null, null, this.getTagsForStencil(gn, 'twitter', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'two;fillColor=#FFFFFF;gradientColor=#DFDEDE',
                    w * 512, h * 512, '', 'Two', null, null, this.getTagsForStencil(gn, 'two', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'typepad;fillColor=#CBD372;gradientColor=#818748',
                    w * 512, h * 512, '', 'Typepad', null, null, this.getTagsForStencil(gn, 'typepad', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'viadeo;fillColor=#FFFFFF;gradientColor=#DFDEDE',
                    w * 512, h * 512, '', 'Viadeo', null, null, this.getTagsForStencil(gn, 'viadeo', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'viber;fillColor=#9964C4;gradientColor=#52366B',
                    w * 512, h * 512, '', 'Viber', null, null, this.getTagsForStencil(gn, 'viber', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'viddler;fillColor=#FFFFFF;gradientColor=#DFDEDE',
                    w * 512, h * 512, '', 'Viddler', null, null, this.getTagsForStencil(gn, 'viddler', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'vimeo;fillColor=#A4EDF9;gradientColor=#2B8ED9',
                    w * 512, h * 512, '', 'Vimeo', null, null, this.getTagsForStencil(gn, 'vimeo', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'virb;fillColor=#536873;gradientColor=#161A1D',
                    w * 512, h * 512, '', 'Virb', null, null, this.getTagsForStencil(gn, 'virb', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'vkontakte;fillColor=#5F94CC;gradientColor=#39587A',
                    w * 512, h * 512, '', 'Vkontakte', null, null, this.getTagsForStencil(gn, 'vkontakte', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'wakoopa;fillColor=#FFFFFF;gradientColor=#DFDEDE',
                    w * 512, h * 512, '', 'Wakoopa', null, null, this.getTagsForStencil(gn, 'wakoopa', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'weheartit;fillColor=#FF7AA2;gradientColor=#FF4577',
                    w * 512, h * 512, '', 'Weheartit', null, null, this.getTagsForStencil(gn, 'weheartit', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'whatsapp;fillColor=#4FE238;gradientColor=#138709',
                    w * 512, h * 512, '', 'Whatsapp', null, null, this.getTagsForStencil(gn, 'whatsapp', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'wix;fillColor=#8AE3F2;gradientColor=#2451B0',
                    w * 512, h * 512, '', 'Wix', null, null, this.getTagsForStencil(gn, 'wix', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'wordpress;fillColor=#35E2EE;gradientColor=#0E4D99',
                    w * 512, h * 512, '', 'Wordpress', null, null, this.getTagsForStencil(gn, 'wordpress', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'wordpress_2;fillColor=#35E2EE;gradientColor=#0E4D99',
                    w * 512, h * 512, '', 'Wordpress', null, null, this.getTagsForStencil(gn, 'wordpress', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'xanga;fillColor=#FFFFFF;gradientColor=#DFDEDE',
                    w * 512, h * 512, '', 'Xanga', null, null, this.getTagsForStencil(gn, 'xanga', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'xerpi;fillColor=#7F719B;gradientColor=#32264B',
                    w * 512, h * 512, '', 'Xerpi', null, null, this.getTagsForStencil(gn, 'xerpi', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'xing;fillColor=#FFFFFF;gradientColor=#DFDEDE',
                    w * 512, h * 512, '', 'Xing', null, null, this.getTagsForStencil(gn, 'xing', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'yahoo;fillColor=#AC37AE;gradientColor=#2E0E2D',
                    w * 512, h * 512, '', 'Yahoo', null, null, this.getTagsForStencil(gn, 'yahoo', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'yahoo_2;fillColor=#AC37AE;gradientColor=#2E0E2D',
                    w * 512, h * 512, '', 'Yahoo', null, null, this.getTagsForStencil(gn, 'yahoo', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'yammer;fillColor=#00AFE0;gradientColor=#005F7A',
                    w * 512, h * 512, '', 'Yammer', null, null, this.getTagsForStencil(gn, 'yammer', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'yandex;fillColor=#FFFFFF;gradientColor=#DFDEDE',
                    w * 512, h * 512, '', 'Yandex', null, null, this.getTagsForStencil(gn, 'yandex', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'yelp;fillColor=#EF5140;gradientColor=#9C1410',
                    w * 512, h * 512, '', 'Yelp', null, null, this.getTagsForStencil(gn, 'yelp', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'yoolink;fillColor=#FFFFFF;gradientColor=#DFDEDE',
                    w * 512, h * 512, '', 'Yoolink', null, null, this.getTagsForStencil(gn, 'yoolink', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'youmob;fillColor=#FFFFFF;gradientColor=#DFDEDE',
                    w * 512, h * 512, '', 'Youmob', null, null, this.getTagsForStencil(gn, 'youmob', dt).join(' '))
            ]);
    };

    // Adds Web Icons shapes
    Sidebar.prototype.addWebLogosPalette = function () {
        var sb = this;
        var s = 'dashed=0;outlineConnect=0;html=1;align=center;labelPosition=center;verticalLabelPosition=bottom;verticalAlign=top;' + mxConstants.STYLE_SHAPE + "=mxgraph.weblogos.";
        var gn = 'mxgraph.weblogos';
        var dt = 'web logos logo';
        var w = 0.2;
        var h = 0.2;

        this.addPaletteFunctions('weblogos', 'Web Logos', false,
            [
                this.createVertexTemplateEntry(s + 'adfty;fillColor=#66E8F3;gradientColor=#1C7CBA',
                    w * 456, h * 458, '', 'Adfty', null, null, this.getTagsForStencil(gn, 'adfty', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'adobe_pdf;fillColor=#A60908',
                    w * 347, h * 338, '', 'Adobe PDF', null, null, this.getTagsForStencil(gn, 'adobe pdf', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'aim',
                    w * 312, h * 342, '', 'Aim', null, null, this.getTagsForStencil(gn, 'aim', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'allvoices',
                    w * 420, h * 398, '', 'Allvoices', null, null, this.getTagsForStencil(gn, 'allvoices', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'amazon',
                    w * 314, h * 341, '', 'Amazon', null, null, this.getTagsForStencil(gn, 'amazon', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'android;fillColor=#A4CA39;strokeColor=none',
                    w * 338, h * 400, '', 'Android', null, null, this.getTagsForStencil(gn, 'android', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'apache',
                    w * 213, h * 426, '', 'Apache', null, null, this.getTagsForStencil(gn, 'apache db database', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'apple;fillColor=#1B1C1C;strokeColor=none',
                    w * 312, h * 381, '', 'Apple', null, null, this.getTagsForStencil(gn, 'apple', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'apple_classic',
                    w * 312, h * 381, '', 'Apple (classic)', null, null, this.getTagsForStencil(gn, 'apple classic', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'app_store;fillColor=#000000;strokeColor=none',
                    w * 306, h * 100, '', 'App Store', null, null, this.getTagsForStencil(gn, 'app store application', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'app_store_iphone;fillColor=#75797C;strokeColor=none',
                    w * 306, h * 100, '', 'App Store iPhone', null, null, this.getTagsForStencil(gn, 'app store iphone', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'arduino;fillColor=#36868D;strokeColor=none',
                    w * 337, h * 160, '', 'Arduino', null, null, this.getTagsForStencil(gn, 'arduino', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'ask;fillColor=#D22028;strokeColor=none',
                    w * 343, h * 253, '', 'Ask', null, null, this.getTagsForStencil(gn, 'ask', dt).join(' ')),
                this.createVertexTemplateEntry('image;image=' + window.GRAPH_IMAGE_PATH + 'img/lib/atlassian/Atlassian_Logo.svg;',
                    66, 66, '', 'Atlassian', null, null, this.getTagsForStencil(gn, 'atlassian logo', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'audioboo;fillColor=#B9217E',
                    w * 270, h * 397, '', 'Audioboo', null, null, this.getTagsForStencil(gn, 'audioboo', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'aws',
                    w * 318, h * 292, '', 'AWS', null, null, this.getTagsForStencil(gn, 'aws amazon web service', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'aws_s3',
                    w * 308, h * 288, '', 'AWS S3', null, null, this.getTagsForStencil(gn, 'aws s3 amazon web service', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'baidu;fillColor=#3F4D9E',
                    w * 355, h * 385, '', 'Baidu', null, null, this.getTagsForStencil(gn, 'baidu', dt).join(' ')),
                this.createVertexTemplateEntry('image;image=' + window.GRAPH_IMAGE_PATH + 'img/lib/atlassian/Bamboo_Logo.svg;',
                    64, 74, '', 'Bamboo', null, null, this.getTagsForStencil(gn, 'bamboo logo', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'bebo;fillColor=#EC1C23;strokeColor=none',
                    w * 279, h * 357, '', 'Bebo', null, null, this.getTagsForStencil(gn, 'bebo', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'behance;fillColor=#3A3333',
                    w * 369, h * 228, '', 'Behance', null, null, this.getTagsForStencil(gn, 'behance', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'bing;fillColor=#008373;strokeColor=none',
                    w * 265, h * 331, '', 'Bing', null, null, this.getTagsForStencil(gn, 'bing', dt).join(' ')),
                this.createVertexTemplateEntry('image;image=' + window.GRAPH_IMAGE_PATH + 'img/lib/atlassian/Bitbucket_Logo.svg;',
                    57, 50, '', 'Bitbucket', null, null, this.getTagsForStencil(gn, 'bitbucket logo atlassian', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'blinklist;fillColor=#3A3333;strokeColor=none',
                    w * 406, h * 360, '', 'Blinklist', null, null, this.getTagsForStencil(gn, 'blinklist', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'blogger;fillColor=#F66C2A;strokeColor=none',
                    w * 290, h * 291, '', 'Blogger', null, null, this.getTagsForStencil(gn, 'blogger', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'blogmarks',
                    w * 188, h * 322, '', 'Blogmarks', null, null, this.getTagsForStencil(gn, 'blogmarks', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'bookmarks.fr',
                    w * 351, h * 314, '', 'Bookmarks.fr', null, null, this.getTagsForStencil(gn, 'bookmarks.fr', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'box;fillColor=#2771B9;strokeColor=none',
                    w * 223, h * 321, '', 'Box', null, null, this.getTagsForStencil(gn, 'box', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'buddymarks',
                    w * 397, h * 285, '', 'Buddymarks', null, null, this.getTagsForStencil(gn, 'buddymarks', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'buffer;fillColor=#221F1F;strokeColor=none',
                    w * 352, h * 302, '', 'Buffer', null, null, this.getTagsForStencil(gn, 'buffer', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'buzzfeed;fillColor=#ED3223;strokeColor=none',
                    w * 390, h * 390, '', 'Buzzfeed', null, null, this.getTagsForStencil(gn, 'buzzfeed', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'chrome',
                    w * 374, h * 377, '', 'Chrome', null, null, this.getTagsForStencil(gn, 'chrome', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'citeulike;fillColor=#698139',
                    w * 378, h * 180, '', 'Citeulike', null, null, this.getTagsForStencil(gn, 'citeulike', dt).join(' ')),
                this.createVertexTemplateEntry('image;image=' + window.GRAPH_IMAGE_PATH + 'img/lib/atlassian/Clover_Logo.svg;',
                    71, 71, '', 'Clover', null, null, this.getTagsForStencil(gn, 'clover logo', dt).join(' ')),
                this.createVertexTemplateEntry('image;image=' + window.GRAPH_IMAGE_PATH + 'img/lib/atlassian/Confluence_Logo.svg;',
                    63, 57, '', 'Confluence', null, null, this.getTagsForStencil(gn, 'confluence logo', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'connotea',
                    w * 405, h * 413, '', 'Connotea', null, null, this.getTagsForStencil(gn, 'connotea', dt).join(' ')),
                this.createVertexTemplateEntry('image;image=' + window.GRAPH_IMAGE_PATH + 'img/lib/atlassian/Crowd_Logo.svg;',
                    66, 65, '', 'Crowd', null, null, this.getTagsForStencil(gn, 'crowd logo', dt).join(' ')),
                this.createVertexTemplateEntry('image;image=' + window.GRAPH_IMAGE_PATH + 'img/lib/atlassian/Crucible_Logo.svg;',
                    61, 61, '', 'Crucible', null, null, this.getTagsForStencil(gn, 'crucible logo', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'dealsplus;fillColor=#935492',
                    w * 380, h * 333, '', 'Dealsplus', null, null, this.getTagsForStencil(gn, 'dealsplus', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'designfloat;strokeColor=none',
                    w * 360, h * 360, '', 'Designfloat', null, null, this.getTagsForStencil(gn, 'designfloat', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'deviantart;fillColor=#009544;strokeColor=none;',
                    w * 310, h * 432, '', 'Deviantart', null, null, this.getTagsForStencil(gn, 'deviantart', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'digg;fillColor=#ffffff',
                    w * 290, h * 280, '', 'Digg', null, null, this.getTagsForStencil(gn, 'digg', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'diigo;fillColor=#2973D2;strokeColor=none',
                    w * 306, h * 344, '', 'Diigo', null, null, this.getTagsForStencil(gn, 'diiigo', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'dopplr;fillColor=#F9634D;strokeColor=none',
                    w * 512, h * 512, '', 'Dopplr', null, null, this.getTagsForStencil(gn, 'dopplr', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'drawio2;fillColor=#1A5BA3',
                    w * 261, h * 354, '', 'Draw.io', null, null, this.getTagsForStencil(gn, 'drawio draw io draw.io', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'drawio3;fillColor=#1A5BA3;fontSize=15;fontColor=#1A5BA3;fontStyle=1',
                    w * 261, h * 261, 'draw.<font color="#f08707">io</font>', 'Draw.io', null, null, this.getTagsForStencil(gn, 'drawio draw io draw.io', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'dribbble;fillColor=#EB548D',
                    w * 337, h * 336, '', 'Dribbble', null, null, this.getTagsForStencil(gn, 'dribbble', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'dropbox;fillColor=#0287EA',
                    w * 367, h * 310, '', 'Dropbox2', null, null, this.getTagsForStencil(gn, 'dropbox', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'drupal',
                    w * 303, h * 345, '', 'Drupal', null, null, this.getTagsForStencil(gn, 'drupal', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'dzone',
                    w * 438, h * 306, '', 'Dzone', null, null, this.getTagsForStencil(gn, 'dzone', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'ebay',
                    w * 406, h * 172, '', 'Ebay', null, null, this.getTagsForStencil(gn, 'ebay', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'edmodo;fillColor=#276CB0;strokeColor=none',
                    w * 346, h * 369, '', 'Edmodo', null, null, this.getTagsForStencil(gn, 'edmodo', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'evernote;fillColor=#3F3F3F',
                    w * 317, h * 376, '', 'Evernote', null, null, this.getTagsForStencil(gn, 'evernote', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'fancy;fillColor=#6DB3E3',
                    w * 196, h * 395, '', 'Fancy', null, null, this.getTagsForStencil(gn, 'fancy', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'fark;fillColor=#B1B0C7;gradientColor=#ffffff;strokeColor=#B1B0C7',
                    w * 221, h * 351, '', 'Fark', null, null, this.getTagsForStencil(gn, 'fark', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'fashiolista',
                    w * 388, h * 366, '', 'Fashiolista', null, null, this.getTagsForStencil(gn, 'fashiolista', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'feed;fillColor=#000000',
                    w * 302, h * 296, '', 'Feed', null, null, this.getTagsForStencil(gn, 'feed', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'feedburner',
                    w * 342, h * 372, '', 'Feedburner', null, null, this.getTagsForStencil(gn, 'feedburner', dt).join(' ')),
                this.createVertexTemplateEntry('image;image=' + window.GRAPH_IMAGE_PATH + 'img/lib/atlassian/Fisheye_Logo.svg;',
                    71, 59, '', 'Fisheye', null, null, this.getTagsForStencil(gn, 'fisheye logo', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'flickr',
                    w * 356, h * 156, '', 'Flickr', null, null, this.getTagsForStencil(gn, 'flickr', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'folkd;fillColor=#165AA6',
                    w * 419, h * 218, '', 'Folkd', null, null, this.getTagsForStencil(gn, 'folkd', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'forrst;fillColor=#27431F',
                    w * 264, h * 366, '', 'Forrst', null, null, this.getTagsForStencil(gn, 'forrst', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'fotolog;fillColor=#000000;strokeColor=none',
                    w * 238, h * 238, '', 'Fotolog', null, null, this.getTagsForStencil(gn, 'fotolog', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'freshbump;fillColor=#C2D952;strokeColor=none',
                    w * 356, h * 380, '', 'Freshbump', null, null, this.getTagsForStencil(gn, 'freshbump', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'fresqui',
                    w * 512, h * 512, '', 'Fresqui', null, null, this.getTagsForStencil(gn, 'fresqui', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'friendfeed;fillColor=#4172BB',
                    w * 369, h * 355, '', 'Friendfeed', null, null, this.getTagsForStencil(gn, 'fiendfeed', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'funp',
                    w * 375, h * 200, '', 'Funp', null, null, this.getTagsForStencil(gn, 'funp', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'fwisp;fillColor=#66676A;strokeColor=none',
                    w * 327, h * 330, '', 'Fwisp', null, null, this.getTagsForStencil(gn, 'fwisp', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'gabbr;fillColor=#F05B1E',
                    w * 322, h * 330, '', 'Gabbr', null, null, this.getTagsForStencil(gn, 'gabbr', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'gamespot',
                    w * 408, h * 408, '', 'Gamespot', null, null, this.getTagsForStencil(gn, 'gamespot', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'github',
                    w * 375, h * 375, '', 'Github', null, null, this.getTagsForStencil(gn, 'github', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'gmail',
                    w * 324, h * 234, '', 'Gmail', null, null, this.getTagsForStencil(gn, 'gmail', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'google',
                    w * 326, h * 347, '', 'Google', null, null, this.getTagsForStencil(gn, 'google', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'google_drive',
                    w * 332, h * 290, '', 'Google Drive', null, null, this.getTagsForStencil(gn, 'google drive', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'google_hangout;fillColor=#4BA139;strokeColor=none',
                    w * 324, h * 377, '', 'Google Hangout', null, null, this.getTagsForStencil(gn, 'google hangout', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'google_play;fillColor=#000000',
                    w * 347, h * 103, '', 'Google Play', null, null, this.getTagsForStencil(gn, 'google play', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'google_play_light;fillColor=#66E8F3;gradientColor=#1C7CBA',
                    w * 300, h * 52, '', 'Google Play Light', null, null, this.getTagsForStencil(gn, 'google play light', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'google_photos',
                    w * 436, h * 436, '', 'Google Photos', null, null, this.getTagsForStencil(gn, 'google photos', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'google_plus;fillColor=#DD4C40;strokeColor=none',
                    w * 328, h * 220, '', 'Google+', null, null, this.getTagsForStencil(gn, 'google plus', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'grooveshark;fillColor=#000000;strokeColor=none',
                    w * 311, h * 311, '', 'Grooveshark', null, null, this.getTagsForStencil(gn, 'grooveshark', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'hatena',
                    w * 431, h * 221, '', 'Hatena', null, null, this.getTagsForStencil(gn, 'hatena', dt).join(' ')),
                this.createVertexTemplateEntry('image;image=' + window.GRAPH_IMAGE_PATH + 'img/lib/atlassian/Hipchat_Logo.svg;',
                    66, 62, '', 'Hipchat', null, null, this.getTagsForStencil(gn, 'hipchat logo atlassian', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'html5',
                    w * 262, h * 370, '', 'HTML5', null, null, this.getTagsForStencil(gn, 'html5 html', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'identi.ca',
                    w * 371, h * 238, '', 'Identi.ca', null, null, this.getTagsForStencil(gn, 'identi.ca', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'instagram;fillColor=#6FC0E4;gradientColor=#1E305B',
                    w * 361, h * 361, '', 'Instagram', null, null, this.getTagsForStencil(gn, 'instagram', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'instapaper',
                    w * 138, h * 351, '', 'Instapaper', null, null, this.getTagsForStencil(gn, 'instapaper', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'ios;fillColor=#695D5D;gradientColor=#100E0E',
                    w * 368, h * 197, '', 'iOS', null, null, this.getTagsForStencil(gn, 'ios', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'jamespot;fillColor=#695D5D;gradientColor=#100E0E',
                    w * 390, h * 390, '', 'Jamespot', null, null, this.getTagsForStencil(gn, 'jamespot', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'java',
                    w * 172, h * 325, '', 'Java', null, null, this.getTagsForStencil(gn, 'java', dt).join(' ')),
                this.createVertexTemplateEntry('image;image=' + window.GRAPH_IMAGE_PATH + 'img/lib/atlassian/Jira_Logo.svg;',
                    72, 72, '', 'Jira', null, null, this.getTagsForStencil(gn, 'jira logo', dt).join(' ')),
                this.createVertexTemplateEntry('image;image=' + window.GRAPH_IMAGE_PATH + 'img/lib/atlassian/Jira_Core_Logo.svg;',
                    55, 66, '', 'Jira Core', null, null, this.getTagsForStencil(gn, 'jira core logo atlassian', dt).join(' ')),
                this.createVertexTemplateEntry('image;image=' + window.GRAPH_IMAGE_PATH + 'img/lib/atlassian/Jira_Service_Desk_Logo.svg;',
                    59, 76, '', 'Jira Service Desk', null, null, this.getTagsForStencil(gn, 'jira service desk logo atlassian', dt).join(' ')),
                this.createVertexTemplateEntry('image;image=' + window.GRAPH_IMAGE_PATH + 'img/lib/atlassian/Jira_Software_Logo.svg;',
                    74, 76, '', 'Jira Software', null, null, this.getTagsForStencil(gn, 'jira software logo atlassian', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'joomla;fillColor=#1F457D;gradientColor=#081220',
                    w * 330, h * 328, '', 'Joomla', null, null, this.getTagsForStencil(gn, 'joomla', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'jquery;fillColor=#0BB9EA;gradientColor=#032F80',
                    w * 369, h * 335, '', 'Jquery', null, null, this.getTagsForStencil(gn, 'jquery', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'json',
                    w * 350, h * 379, '', 'JSON', null, null, this.getTagsForStencil(gn, 'json', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'json_2',
                    w * 402, h * 126, '', 'JSON', null, null, this.getTagsForStencil(gn, 'json', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'last.fm;fillColor=#F33543;gradientColor=#BD0E11',
                    w * 416, h * 250, '', 'Last.fm', null, null, this.getTagsForStencil(gn, 'last.fm last fm', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'linkagogo;fillColor=#F6F5FA;gradientColor=#C8C1E1',
                    w * 511, h * 400, '', 'Linkagogo', null, null, this.getTagsForStencil(gn, 'linkagogo', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'linkedin;fillColor=#0095DB;gradientColor=#006391',
                    w * 287, h * 303, '', 'LinkedIn', null, null, this.getTagsForStencil(gn, 'linkedin', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'livejournal;fillColor=#2690E5;gradientColor=#0A2463',
                    w * 320, h * 343, '', 'Livejournal', null, null, this.getTagsForStencil(gn, 'livejournal', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'mail.ru;fillColor=#267BE0;gradientColor=#0A1F42',
                    w * 406, h * 393, '', 'Mail.ru', null, null, this.getTagsForStencil(gn, 'mail.ru', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'mathoverflow;fillColor=#656463;gradientColor=#F28711;gradientDirection=east',
                    w * 295, h * 241, '', 'MathOverflow', null, null, this.getTagsForStencil(gn, 'mathoverflow', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'meetup;fillColor=#413E3E;strokeColor=none',
                    w * 374, h * 150, '', 'Meetup', null, null, this.getTagsForStencil(gn, 'meetup', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'meneame',
                    w * 380, h * 338, '', 'Meneame', null, null, this.getTagsForStencil(gn, 'meneame', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'messenger',
                    w * 413, h * 384, '', 'Messenger', null, null, this.getTagsForStencil(gn, 'messenger', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'messenger_2',
                    w * 322, h * 324, '', 'Messenger', null, null, this.getTagsForStencil(gn, 'messenger', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'messenger_3;fillColor=#437BBD;strokeColor=#dddddd',
                    w * 322, h * 324, '', 'Messenger', null, null, this.getTagsForStencil(gn, 'messenger', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'mind_body_green;strokeColor=#888888',
                    w * 407, h * 464, '', 'Mind Body Green', null, null, this.getTagsForStencil(gn, 'mind body green', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'mongodb',
                    w * 206, h * 431, '', 'MongoDb', null, null, this.getTagsForStencil(gn, 'mongodb', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'myspace;fillColor=#003399;strokeColor=none',
                    w * 315, h * 351, '', 'MySpace', null, null, this.getTagsForStencil(gn, 'myspace', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'n4g;fillColor=#000000;strokeColor=none',
                    w * 441, h * 159, '', 'N4g', null, null, this.getTagsForStencil(gn, 'n4g', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'netlog;fillColor=#F42424;strokeColor=none',
                    w * 383, h * 344, '', 'Netlog', null, null, this.getTagsForStencil(gn, 'netlog', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'netvibes;fillColor=#84BD00;strokeColor=none',
                    w * 309, h * 309, '', 'Netvibes', null, null, this.getTagsForStencil(gn, 'netvibes', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'netvouz',
                    w * 286, h * 287, '', 'Netvouz', null, null, this.getTagsForStencil(gn, 'netvouz', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'networkedblogs',
                    w * 394, h * 394, '', 'Networkedblogs', null, null, this.getTagsForStencil(gn, 'networkedblogs', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'newsvine;fillColor=#005221;strokeColor=none',
                    w * 203, h * 386, '', 'Newsvine', null, null, this.getTagsForStencil(gn, 'newsvine', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'odnoklassniki;fillColor=#F58220;strokeColor=none',
                    w * 247, h * 410, '', 'Odnoklassniki', null, null, this.getTagsForStencil(gn, 'odnoklassniki', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'oknotizie',
                    w * 237, h * 352, '', 'Oknotizie', null, null, this.getTagsForStencil(gn, 'oknotizie', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'onedrive;fillColor=#094AB1;strokeColor=none',
                    w * 356, h * 216, '', 'OneDrive', null, null, this.getTagsForStencil(gn, 'onedrive', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'oracle;fillColor=#FF0000;strokeColor=none',
                    w * 450, h * 115, '', 'Oracle', null, null, this.getTagsForStencil(gn, 'oracle', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'paypal',
                    w * 256, h * 290, '', 'Paypal', null, null, this.getTagsForStencil(gn, 'paypal', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'phone;fillColor=#36BE0F;strokeColor=none',
                    w * 289, h * 271, '', 'Phone', null, null, this.getTagsForStencil(gn, 'phone', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'phonefavs',
                    w * 322, h * 394, '', 'Phonefavs', null, null, this.getTagsForStencil(gn, 'phonefavs', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'pinterest;fillColor=#BD081C;strokeColor=none',
                    w * 384, h * 372, '', 'Pinterest', null, null, this.getTagsForStencil(gn, 'pinterest', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'plaxo;fillColor=#414F5C;strokeColor=none',
                    w * 400, h * 400, '', 'Plaxo', null, null, this.getTagsForStencil(gn, 'plaxo', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'playfire;fillColor=#FDA21A;gradientColor=#FEE635;strokeColor=none',
                    w * 310, h * 308, '', 'Playfire', null, null, this.getTagsForStencil(gn, 'playfire', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'plurk;fillColor=#E9443D;strokeColor=none',
                    w * 512, h * 512, '', 'Plurk', null, null, this.getTagsForStencil(gn, 'plurk', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'pocket;fillColor=#EE4056;strokeColor=none',
                    w * 314, h * 289, '', 'Pocket', null, null, this.getTagsForStencil(gn, 'pocket', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'protopage;fillColor=#4B78C0;gradientColor=#294282',
                    w * 394, h * 400, '', 'Protopage', null, null, this.getTagsForStencil(gn, 'protopage', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'readernaut;fillColor=#000000;strokeColor=none',
                    w * 360, h * 360, '', 'Readernaut', null, null, this.getTagsForStencil(gn, 'readernaut', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'reddit;fillColor=#F3F8FC;gradientColor=#B4D2F0',
                    w * 440, h * 368, '', 'Reddit', null, null, this.getTagsForStencil(gn, 'reddit', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'rss;fillColor=#F56800;strokeColor=none',
                    w * 408, h * 408, '', 'RSS', null, null, this.getTagsForStencil(gn, 'rss', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'scoopit;fillColor=#6CAB36;strokeColor=none',
                    w * 290, h * 350, '', 'Scoopit', null, null, this.getTagsForStencil(gn, 'scoopit', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'scribd;fillColor=#3D3533;strokeColor=none',
                    w * 289, h * 346, '', 'Scribd', null, null, this.getTagsForStencil(gn, 'scribd', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'segnalo',
                    w * 403, h * 389, '', 'Segnalo', null, null, this.getTagsForStencil(gn, 'segnalo', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'sina',
                    w * 429, h * 343, '', 'Sina', null, null, this.getTagsForStencil(gn, 'sina', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'sitejot',
                    w * 386, h * 330, '', 'Sitejot', null, null, this.getTagsForStencil(gn, 'sitejot', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'skype;fillColor=#2AACE2;strokeColor=none',
                    w * 388, h * 394, '', 'Skype', null, null, this.getTagsForStencil(gn, 'skype', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'skyrock;fillColor=#009AFF;strokeColor=none',
                    w * 339, h * 352, '', 'Skyrock', null, null, this.getTagsForStencil(gn, 'skyrock', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'slashdot;fillColor=#026664;strokeColor=none',
                    w * 262, h * 310, '', 'Slashdot', null, null, this.getTagsForStencil(gn, 'slashdot', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'sms;fillColor=#48B921;strokeColor=none',
                    w * 346, h * 320, '', 'SMS', null, null, this.getTagsForStencil(gn, 'sms', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'socialvibe;fillColor=#EE2F7F;strokeColor=none',
                    w * 250, h * 250, '', 'Socialvibe', null, null, this.getTagsForStencil(gn, 'socialvibe', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'society6;fillColor=#000000;strokeColor=none',
                    w * 374, h * 265, '', 'Society6', null, null, this.getTagsForStencil(gn, 'society6', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'sonico;fillColor=#01AEF0;strokeColor=none',
                    w * 346, h * 316, '', 'Sonico', null, null, this.getTagsForStencil(gn, 'sonico', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'soundcloud;fillColor=#FE4600;strokeColor=none',
                    w * 367, h * 163, '', 'Soundcloud', null, null, this.getTagsForStencil(gn, 'soundcloud', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'sourceforge',
                    w * 371, h * 372, '', 'Sourceforge', null, null, this.getTagsForStencil(gn, 'sourceforge', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'sourceforge_2;fillColor=#00547E;strokeColor=none',
                    w * 316, h * 234, '', 'Sourceforge', null, null, this.getTagsForStencil(gn, 'sourceforge', dt).join(' ')),
                this.createVertexTemplateEntry('image;image=' + window.GRAPH_IMAGE_PATH + 'img/lib/atlassian/Sourcetree_Logo.svg;',
                    57, 71, '', 'Sourcetree', null, null, this.getTagsForStencil(gn, 'sourcetree logo', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'spring.me;fillColor=#0374B8;strokeColor=none',
                    w * 366, h * 158, '', 'Spring.me', null, null, this.getTagsForStencil(gn, 'spring me', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'stackexchange',
                    w * 319, h * 395, '', 'Stackexchange', null, null, this.getTagsForStencil(gn, 'stackexchange stack exchange', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'stackoverflow',
                    w * 272, h * 320, '', 'StackOverflow', null, null, this.getTagsForStencil(gn, 'stackoverflow stack overflow', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'startaid;fillColor=#409FCF;strokeColor=none',
                    w * 206, h * 213, '', 'Startaid', null, null, this.getTagsForStencil(gn, 'startaid', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'startlap;fillColor=#B9E6F0;gradientColor=#3062A2',
                    w * 410, h * 421, '', 'Startlap', null, null, this.getTagsForStencil(gn, 'startlap', dt).join(' ')),
                this.createVertexTemplateEntry('image;image=' + window.GRAPH_IMAGE_PATH + 'img/lib/atlassian/Statuspage_Logo.svg;',
                    75, 52, '', 'Statuspage', null, null, this.getTagsForStencil(gn, 'statuspage logo', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'steam;fillColor=#695D5D;gradientColor=#100E0E',
                    w * 426, h * 198, '', 'Steam', null, null, this.getTagsForStencil(gn, 'steam', dt).join(' ')),
                this.createVertexTemplateEntry('image;image=' + window.GRAPH_IMAGE_PATH + 'img/lib/atlassian/Stride_Logo.svg;',
                    69, 57, '', 'Stride', null, null, this.getTagsForStencil(gn, 'stride logo atlassian', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'stumbleupon;fillColor=#EB4924;strokeColor=none',
                    w * 512, h * 512, '', 'StumbleUpon', null, null, this.getTagsForStencil(gn, 'stumbleupon', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'stumpedia',
                    w * 335, h * 338, '', 'Stumpedia', null, null, this.getTagsForStencil(gn, 'stumpedia', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'translate',
                    w * 342, h * 335, '', 'Translate', null, null, this.getTagsForStencil(gn, 'translate', dt).join(' ')),
                this.createVertexTemplateEntry('image;image=' + window.GRAPH_IMAGE_PATH + 'img/lib/atlassian/Trello_Logo.svg;',
                    70, 70, '', 'Trello', null, null, this.getTagsForStencil(gn, 'trello logo', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'tumblr;fillColor=#36465D;strokeColor=none',
                    w * 203, h * 326, '', 'Tumblr', null, null, this.getTagsForStencil(gn, 'tumblr', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'tunein',
                    w * 350, h * 350, '', 'Tunein', null, null, this.getTagsForStencil(gn, 'tunein', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'twitter;fillColor=#1DA1F2;strokeColor=none',
                    w * 400, h * 350, '', 'Twitter', null, null, this.getTagsForStencil(gn, 'twitter', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'two;fillColor=#FF6D00;strokeColor=none',
                    w * 377, h * 100, '', 'Two', null, null, this.getTagsForStencil(gn, 'two', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'typepad;fillColor=#ADB560;strokeColor=none',
                    w * 324, h * 192, '', 'Typepad', null, null, this.getTagsForStencil(gn, 'typepad', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'viadeo',
                    w * 367, h * 420, '', 'Viadeo', null, null, this.getTagsForStencil(gn, 'viadeo', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'viber;fillColor=#7D539F;strokeColor=none',
                    w * 387, h * 426, '', 'Viber', null, null, this.getTagsForStencil(gn, 'viber', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'viddler;fillColor=#1896E0;gradientColor=#06253F',
                    w * 410, h * 106, '', 'Viddler', null, null, this.getTagsForStencil(gn, 'viddler', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'vimeo;fillColor=#1AB7EA;strokeColor=none',
                    w * 313, h * 290, '', 'Vimeo', null, null, this.getTagsForStencil(gn, 'vimeo', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'virb;fillColor=#000000;strokeColor=none',
                    w * 330, h * 353, '', 'Virb', null, null, this.getTagsForStencil(gn, 'virb', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'vkontakte;fillColor=#4C75A3;strokeColor=none',
                    w * 352, h * 200, '', 'Vkontakte', null, null, this.getTagsForStencil(gn, 'vkontakte', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'wakoopa;fillColor=#FF6D00;strokeColor=none',
                    w * 413, h * 224, '', 'Wakoopa', null, null, this.getTagsForStencil(gn, 'wakoopa', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'weheartit;fillColor=#FF4577;strokeColor=none',
                    w * 411, h * 348, '', 'Weheartit', null, null, this.getTagsForStencil(gn, 'weheartit', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'whatsapp;fillColor=#00E676;strokeColor=#dddddd',
                    w * 372, h * 374, '', 'Whatsapp', null, null, this.getTagsForStencil(gn, 'whatsapp', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'wix;strokeColor=#dddddd',
                    w * 370, h * 308, '', 'Wix', null, null, this.getTagsForStencil(gn, 'wix', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'wordpress;fillColor=#00A7DA;strokeColor=none',
                    w * 333, h * 327, '', 'Wordpress', null, null, this.getTagsForStencil(gn, 'wordpress', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'wordpress_2;fillColor=#00A7DA;strokeColor=none',
                    w * 344, h * 344, '', 'Wordpress', null, null, this.getTagsForStencil(gn, 'wordpress', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'xanga;fillColor=#000000;strokeColor=none',
                    w * 350, h * 190, '', 'Xanga', null, null, this.getTagsForStencil(gn, 'xanga', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'xerpi;fillColor=#7F719B;gradientColor=#32264B;strokeColor=none',
                    w * 351, h * 328, '', 'Xerpi', null, null, this.getTagsForStencil(gn, 'xerpi', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'xing',
                    w * 325, h * 369, '', 'Xing', null, null, this.getTagsForStencil(gn, 'xing', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'yahoo;fillColor=#65106E;strokeColor=none',
                    w * 372, h * 218, '', 'Yahoo', null, null, this.getTagsForStencil(gn, 'yahoo', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'yahoo_2;fillColor=#65106E;strokeColor=none',
                    w * 400, h * 233, '', 'Yahoo', null, null, this.getTagsForStencil(gn, 'yahoo', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'yammer;fillColor=#0093BE;strokeColor=none',
                    w * 348, h * 298, '', 'Yammer', null, null, this.getTagsForStencil(gn, 'yammer', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'yandex',
                    w * 159, h * 332, '', 'Yandex', null, null, this.getTagsForStencil(gn, 'yandex', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'yelp;fillColor=#C41200;strokeColor=none',
                    w * 317, h * 415, '', 'Yelp', null, null, this.getTagsForStencil(gn, 'yelp', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'yoolink',
                    w * 396, h * 396, '', 'Yoolink', null, null, this.getTagsForStencil(gn, 'yoolink', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'youmob',
                    w * 380, h * 381, '', 'Youmob', null, null, this.getTagsForStencil(gn, 'youmob', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'youtube;fillColor=#FF2626;gradientColor=#B5171F',
                    w * 786, h * 329, '', 'Youtube', null, null, this.getTagsForStencil(gn, 'youtube', dt).join(' ')),
                this.createVertexTemplateEntry(s + 'youtube_2;fillColor=#FF2626;gradientColor=#B5171F',
                    w * 232, h * 163, '', 'Youtube', null, null, this.getTagsForStencil(gn, 'youtube', dt).join(' '))
            ]);
    };

})();

(function()
{
	//Adds Google Media Design shapes
	Sidebar.prototype.addGMDLBottomNavigationPalette = function(expand)
	{
		var s = "dashed=0;align=center;fontSize=12;shape=";
		var s2 = "dashed=0;html=1;shape=mxgraph.gmdl.";
		var anc = "shape=rect;fillColor=none;strokeColor=none;";
		var fac = 'shape=ellipse;dashed=0;fillColor=#ffffff;strokeColor=none;shadow=1;fontSize=13;fontColor=#000000;align=center;verticalAlign=top;labelPosition=center;verticalLabelPosition=bottom;html=1;aspect=fixed;';
		var gn = 'mxgraph.gmdl';
		var dt = 'gmdl google media design library bottom navigation ';
		var sb = this;
		
		var fns = [
			this.addDataEntry(dt + 'bottom navigation', 358, 48, 'Bottom Navigation',
				'7VbbToNAEP0aHtss0Gp9tPXyosaoP7AtA2xcGLKMtfXr3WWH2go1jZcHjRCSndkzlz1zIATxrFhdGlnl15iADuLzIJ4ZRPKrYjUDrYNIqCSIz4IoEvYJoos9u2GzKyppoKRDAiIfsJT6CbzHO2paa3Ykss7BwUUQT6VWWWnXC5sfjHWkWNK9enHYMLJ2ncvKGQYW5LaV1jPUaJpccdpcDkYGH6HdKbEEH5vgM1fixsAQrPYernHxyS4BCyCztpBnlVDuEfF44sNyUFnOYSP2ydrb2Sb0jSq7YLb6mYs7zN2BY6X+mMCcCu242qKqWGVu/sOsSPTQcJIOdRPh7n3UuTH0gR1/aiH1Kc+NsHIpKrlQZXYFKXFb22N0tpZz0LdYK1K4M+824dU7wByJsOhTCBebMqApx74H183Z4OjQcUf94+YAMQzHPmbdOtje0gO/DztyaH0GtCS1hJ36fRrhFm5R2c429Qeh2Ck/aNtpU2Ca1kAdkW1OcpDuRh3dXcglGkXwReXlIE3PKyvE8cnR9EDdbcC/Qnfj79Ld52QXTn5IdqMfkN24I7sbq5f5+muaK32O/4/dJ0Q3+XsfO2u+/fp4+Paf0Ss='),
			this.addDataEntry(dt + 'bottom navigation', 358, 48, 'Bottom Navigation',
				'7Zbfb5swEMf/Gh4TGRxY9rikW19aqdL2PjlwgFXDIXPNj/31s7FJ84Oo6UqeOiQk39d3PvvuE4eAL6vtvRZN+YgZqIB/D/hSI5IbVdslKBVETGYBvwuiiJk3iH5cmA27WdYIDTVdExC5gLVQL+AUJ7S0U17IRFuCdWcBXwgli9qMU7M+aCPkWNNP+cf6hpGx21I01tCQkp2WSi1Roe7W4ox9+ZosrBtpfIZ+psYaXGyGG5/Jbww0wfbi4TrJn+wesALSO+OykRmVzoPHcxdWgixKHzbzmmidXexDX0tlBr5aw5Xj76xcSZWyRTqoUbUtbOOnRZWp6VpmgL+j85rl3XOpZrb+Q862cDIV6ptvGGFjl2hEKuviAXLy2zrsn7WVWIF6wlaSxKNG9ws+nDiskAirITR8soV36NJ57Zfdzd0kMQpahXbGTK5uezTcdh/ApmHsYna94O0DLvzv4giLMHGaBiVIruEo/xArfgtPKM3O9vknITtKPzmhDfO8BTpjbX+Qq/CbneH3+NLK9GMMVt0Sn4nAeCzk+PxN5MLZOXI9hmMj1+calbl45Ctvhfj8qWi71X2XRG/Dl9wOvvkJe+wG7CUjs7eBVSMK+I/fCPjN/+3v9mZ3X/xx/oz5+hHu3A+/0f8C')
   		];
		  
		this.addPalette('gmdlBottom Navigation', 'GMDL / Bottom Navigation', expand || false, mxUtils.bind(this, function(content)
		{
			for (var i = 0; i < fns.length; i++)
			{
				content.appendChild(fns[i](content));
			}
		}));
	};

	Sidebar.prototype.addGMDLBottomSheetsPalette = function(expand)
	{
		var s = "dashed=0;align=center;fontSize=12;shape=";
		var s2 = "dashed=0;html=1;shape=mxgraph.gmdl.";
		var anc = "shape=rect;fillColor=none;strokeColor=none;";
		var fac = 'shape=ellipse;dashed=0;fillColor=#ffffff;strokeColor=none;shadow=1;fontSize=13;fontColor=#000000;align=center;verticalAlign=top;labelPosition=center;verticalLabelPosition=bottom;html=1;aspect=fixed;';
		var gn = 'mxgraph.gmdl';
		var dt = 'gmdl google media design library bottom sheets ';
		var sb = this;
		
		var fns = [
			this.addDataEntry(dt + 'bottom sheet', 358, 320, 'Bottom Sheet',
				'7ZbRbtsgFIafxrcVgbjJLud0Sau12rQ9wETjE4yKwQLSOnv6gSFpFhwJaUsvqiaKxDnnPyfm+4VMQRZtv9K0ax5UDaIgXwqy0ErZsGr7BQhRYMTrgtwUGCP3K/DyTHUyVFFHNUib04BDwzMVWwiZkDB2J2KipqYBL0cFqajgTLr12s0H7RIbJe1P/ttrJ9jFpqGdDzSsrS9zIRZKKD3MIpvh42VWqyfYV6SSEHpr9RL/yQ3YasOf4QeYMN9n4+OCttCf3fKQivtdgWrB6p2TvPDaNkFBynloa4CzJraRyApRExLs0PtK0C0ixHGgJAH6rQPpBTIhe8JqlMkxwJjaeyBgY6MDR4jnyH9PnJnmosPj6PYNEdAuhmUIj8BihFKw/4PrNOH6FaA7i7TtmT9TV6ytxdWTV2bwdfSW02qGqhSyoI8gvivDLVc+rcPuKo+Tr6m4P6m3vK79Mx0En+O8Q8F0dM0lux/m3+C3cewajTh2GcPKxLA7+aj6PMf4IP2wzIeTEc/wZTy7Tjy7pZKprTV5tjVBnWkcWn6aleX7NS73sOF/N26WGPcAxoBk7h2d5Vx7kH8cOi9+w0M3T7xbKcXc3nGV5x0b5L86sTWZ7jls7gr0ft273GvOha+X86H21939Dw=='),
			this.addDataEntry(dt + 'grid style options', 358, 642, 'Grid Style With Some Options',
				'7VvRbuI4FP0apNkHUGI7BB4LHToPU6naXWkeqwAmRHVilLgzdL9+HRIDwQ44xAbKDFUlYuwQ33PPvdfHpgPH8fopDVbLZzrHpAO/duA4pZQV7+L1GBPSAU4078DHDgAO/++ASc2n7uZTZxWkOGE6A0Ax4GdA3nHRUjRk7IOUDfMgW+K8u9OBo4BEYcLfz/j9ccobFjRh/0T/5X1dwK+zZbDKL1I8Y/nHESFjSmi6uRdcbF55N5bSNyw+SWjCx4zKZ8Epw+va+Wyaysk8YRpjln7wLr+iOVsWPaA3KIYtcRQuy2F9VM4syIqGcDt2Zx7+prSQ2lpQslY+5wfomDWa6J8Wj39oRPAIh4N+nRHze+91nmxeeedVMIuS8O/SJGjX9C9d5Q8inquchHPwnJBfpzjjVz9KU7u6kIHzIAOoaEsxCVj0E1fu3wZG1NDplywm5XwFUvE6zDnbC+M56TG6ep0GaSu3hmobVQd8lJTuecX1ngVRXzag29SA5fe/0Ig/1vbLu0NQ+fquX70DXSwyzCQAtrPQwsSTMHkgEW8Y0yShaWaWYGriVFkGh8gf+kqn37t7brRTlCv41c0JlDtBNAvIQ/nAcTSf5zPazoDgBduN/L65evSBZaZ5fjtH+agS1qhj9A2TVVi44gJyahJ4a5veU5v+CGVdFWX7Rigr6CQYO7AAjG8YGDyPdLm5xaoNMtqh1SJO3f4FgBoYBoo/EePBKbtJsDx7WJWltFWshg2xspH5nM2Lt9M8C7F8usC5ePUnmNEyJw1cCyi5jmFKMUzwalmgoVWcTDx35OkiMGycmoSrtyrH9VKTC2wA5EoAfel7zl+8yfM8/p0QSYBxC7IDAiG5uNuSo7aUk2liqLhrDqN6WeUYIVb3cIgZ4GRB4plOI25YDbigDJfnoAmafBK4XE9Fu6Zw6a6CXVnNaBfElkES0nfdLDN6zP9aGlO/hvPNE0HUBeigLhDZwSwxmooWfyqDEwHMFZKJWZxkIeMLBFBknr4/GH6+zFM4372nHllp+EHTt8+XeK6GlnbmMS0d2Mw8ddb8jVJPUwHhflOPoQC2XZ+YxUlDPBCWJ5Firblv5qoK6hozfOFMtXRyesBxT3MKDFSanKHs4lnABjRVDO6XQ4bKNwBtcAjIwkG71BQHETm63VCn7Jy5DVE4WjOxBym4ZGgfAlXzkw3JVCC0Bxknz6zcN0QOXgfxiuDejMYSlDdfeZ8B5+ervBXnKl5wmtEkIDqI3Vb1fQZil9V9Gh9/+JOKTqWioQ0lQXEkgiPxei+Brfki1QxNLhrY7kVSuBpa2kFNQ1K4+trnzChlaF0DPStRShYHnjY179GUsu/pTl3pHJa186G7s/w81YgEU0xeaBaxiFayk+j+/aDDlDLGI2VNPlPxrHJ+q98S5e0C10UDiSyq03tii7L1sYWyuhJuIE7zmXUDWXv4Vopy7R1hJ+/dhiu4cj3jDh8c72td8WPEbxRnPhURFtk57AIHNoIHlFWRJ0rDfLd3ZCKAbO71uiLv2U35jj0fGXjI1wouxtwEXsJNZFHm2UyKuakMg45sVegeV4VWs5Qi3kBgJd6goY2zxOJh9x0JZ1kQysdLzvCl8k634k5dRZpq7E/IYvZSyI7IlDeBqjeJTXez3iTLVs80NeJK+W1uxY/cvrYf2U9ligjk2olA3Bg2fOamxDez69iPyoBTq1qRX9oKN8jGngKUtbfjMJ3aBpoGs7cm20A1WoS2YAOPn1pwegfHcJUKjmpfyNCi1K98u5VflEGNXw4JrPjIaJUpVaGrIXT/ADXQ7JTR7Zro+PcGD7/c/ey86L7/q/T/AQ=='),
			this.addDataEntry(dt + 'grid style all options', 358, 642, 'Grid Style With All Options', 
				'7Vvfj+IqFP5rTPY+aFqg/ngcnXXuw04yuXeTfdxURW2GlqZldvX+9RdsUSvUoRZWx10nk1gEWs73Hb7DgXbgJN48ZWG6fqYLTDrwcwdOMkpZ8S3eTDAhHeBFiw587ADg8f8OmNb86u9+9dIwwwkzaQCKBj9C8oaLkqIgZ1tSFizCfI1Fda8DxyGJVgn/Puf944wXLGnC/o3+E3V9wK/zdZiKiwzPmfg5ImRCCc12fcHl7iOqsYy+YvlLQhPeZlw+C84Y3tSOZ1dUDuYJ0xizbMur/IwWbF3UgMGwaLbG0WpdNuujcmRhXhSs9m0P5uFfSgvprQUVa4kxP0DPrtFk/ax4/FMjgkc4GvbrjCj6Pqo83X1E5TScR8nqn9Ik6FD0labiQeRzlYPwTp4T8usM5/zqW2lq3xQycBlkABVlGSYhi37gSv9tYEQNSb9mMSnHK5GKNyvhs71VvCA9RtPvszBripSR7aDedtUG29LVe0FxfWRZ1FcN6zc1bHn/Fxrxx9rfvDsCldt3B9Ue6HKZY6YAsx+FEVaBgtUDiXjBhCYJzXK7jqd3qCqmcIQGo4HWGY56F0Z7zxULv+sKxxIkiOYheSgfOI4WCzGi/QgIXrJDyy+7q8cBcOyBwaAdUbZVR7ZKjL5lJ5YWrlBAlSyJt7HpA73pz7isr3PZvhWXle4kPXboAJiBZWDwIjL1zT1WbZAxnlod4tTt/wKghpaB4k/E+OSU3yRYgTusyhDbKVajhli5UD5v9+HlVKgQE8MF3i+PCqVntNSkoe8AJd+z7FIME5yuCzSMgpNp4I8DUwRGjaVJUr1VmG4mTT5wAZCvAPSpH3h/8aIgCPg9IVIA4xZkJw6E1OBu7xyuQ7nmoOkXV54VN+qeNrEDk5qWeKaziJvRAByoghN4aIqm58BR57APDpfpWthXcxrtpqx1mKzom6mmjB/FX0tjmkdsA/uOIKMAdBIFSC2w6xhNUxd/4oB3JjBfJkjs4qSmLT5BAKXO9AfDkTOdcTaVFeS7d+lR8wrfaPb68YTnamgZK4/tRIFL5amz5m8kPU3TBfcrPZYmsP1qxC5OBqkCaXkSaVaWx2au5jx9a4YvyFTrTl4PeP77PgWGugycJXUJHGADmuYH7teHLIVvALrwIaCmCdpJUxxG5OzmQl0e58JNh4JozVI7SONLlnYdUFWfXCRIJUJHkHHnmZe7hMjDmzBOCe7NaaxAefOR9wVwfrzIW3O64gVnOU1CYoLYbUXfV0PMNPo2OQRx9TDhQm2xFAKAkROaq6mBp508nBWYOt2vqMyqlJlTujNx0GBMwhkmLzSPWEQrMYWs/uWkwowyxmfLmihE52eVgw39lijvY0EfDRVn0R1rkbn71vt5sCJXELg416I5v/B3uX5tT4TDSvg2qOCrEY4/evCCz3UhqxXeaA5DabavkJtdYOhGI9WcyROlK7ExMrYxgez6+p6St/ymuOOOI8MADYwmF2s0OZ1cnNBEzdU825GYm1IYdCarZ3qOCzpVKc18A4GT+QbJ+M0ukdRk0jPO83Cl7sRewKWyp1uhU1cjU435hByql2aFjmyxCVTZ5LuIeaCa/prQdGuBSnPRza3wCJzQKNGd31G5ZZ1BWm2DOhJZ2oeQpNmTyEWiB6q5uWk4xzNK1U265kRayq5uhUzmc5LNsMh0yeUoKgrkqRS7zFFThF9/RkyA0Z44rOzp9+aN2fsnH4s1TQ9IOd2zsZtI21YavJdWk3NC2+wxciILtl/qmoXz1yZbNjXJUOOMMTz/ppfXOzkgqz1koNvDsZQVq2q7k3e9oJoaVTCUWPGWUZpr46qrIXT/ABm8dHV2drsmOoN7g4dfHl4UL6ofv0f+Pw=='),
			this.addDataEntry(dt + 'list style', 358, 642, 'List Style',
				'7Vtdb5s8FP41uUxlbALJZZruQ9MmVe827XLyEiegEoyM2zXvr5/NV0JsGrPYLV1DVQmM7djnOc85h8NhhBbbxw8MZ9EXuiLJCL0boQWjlJdn28cFSZIRBPFqhG5GEALxP4LvO+56xV2QYUZSbjIAlgMecHJPypayIee7pGpY4TwisjsYoWucxJtUnC/F/ISJhjVN+df4f9nXg+I6j3AmLxhZcnk7TpIFTSgr5kLr4pDdOKN3pL6T0lSMua7WQhgnj537KZqqzXwgdEs424kuv+MVj8oeaDIth0Uk3kTVsMCvdobzsmHTjN2LR5xUEtJLCynSknueI2BXaHV/Vi7/WIjwBs2mQZcQ5dwHnd8Xh+yc4WWcbv6rROLvm77RTC6kXle1CXC0TiSuGcnF1Y9K1J4pZPDvIIN+2cZIgnn8QFrznwOj31PpI75Nqv3WSG0fN5KzV5vtKrniNPv5C7O+SBnJDull1x6wq6h+NSmvDyTrB6pgvb6CrX7/lsZiWc2Pj2ew9fPjsD0DXa9zwhVgml0YYTVRsJrL+zbppqdRG0k088NZqKXAwexSVKcIWLJtLOkkoY+XOJlXC97Gq5XcUbODhKz5fuTn4uomhI55NwnPU49dm75W1SGwTN2MkTUREluS3FATGhdmBMFED8EThK3F1iJsYIWw9TQ1X6cOAApt21YW43RTsGII6HhAwxc74AC/jQ5ygM7UMjo5wWwZKdgcAnEIUIVZ2bm2ocbmrAMtY1fo6VyhHWaNg4l7as2sg8e5cCvPaviMwZq4wwr67rGq7cQBWJ9wKqcFt4TdxWn+NHYuYhhQHKKdyniCy+1DcCqk8Xw1pGkmGmoAc6ZFrhRj6rlQDM82i3nx5GGiADcijA3eGT9og97esX5Abj3FeXbc41HsUhPMLjh90yGnwLnPiSk4UyD/zgXH2L4ijTNElgzsBBxh5cTCqsmYL7iQwScapTlNLwZ26AbWqxXOrmLYTu+4I/G5yZ3XT2I1vXNLJB8hWGCW5BcavwYaz5wESrZTPe5ofO6zzuunsZr1+cbIA5U8/ojTnFxYPHgWN28K7GqG7YyTOxaHb57FfRNML0tbl5yq5XsmpxBw4RmhmltScKoln8QHGVedmNu5WM+a4Etl6qQTuILAO80pONWQyg42Yxevp6Ca3ZljJoNYcE3SlHA+ZEZdHGExd20H7WqGmlqaK7oghMLbOEANDk0arxOH4zoORa3MYOgoten58rJ3GYdhAhC6QElNKg00XOkC5+2EK5oynq+RkNDzW9jmzdjFpHaY1NCJs1WTR+eRNS/URxMtBcWhAt+0/+Ub7VKF+xUghBoLC6zQ9shouHnFoqng+Z4lFK8utB0cbX3oJBKyXSJ0X+qPGegNZc3kH1gJgV5R/ZamRGhBs92FncNj59SJU7VdZbSU2mPqU88rECt19025U6Tmgm5ZuQwexXkhoM0lJB4eeyfIhW9FtquLskKZnjEkRv2rjjxdAteOx4VHD7IuPC5SM0PPz9eGdXbz7LvWgFPU8m1ldp3AZDs19Asv73TM0lZOd6fszZnVgdE+I9+uYdZSTRfcWvqaKGxTzcXHRMigNKjGSoyMs1ybDngxhP59gAxSOk9at5dEJ/zX4BGX+y+Ry+6HHyr/AQ=='),
			this.addDataEntry(dt + 'bottom sheet menu items subtext', 358, 360, 'Bottom Sheet (menu items with subtext)',
				'7ZfdbtowFMefJtpVKycGNi4h3Sp1rVRtT2DiQ2LhxJnj8LGn3zl2AoW0Uy82ygWRguzz5eP/+QlExNNye29FXTwZCTriXyOeWmNcWJXbFLSOEqZkxO+iJGH4Rsm3N7yx97JaWKjcexKSkLAWuoVgCYbG7XRnkKIpgMJZxOdCq7zCdYb1waJhaSr3U/2m2DjBfVOImjYWMkdupXVqtLG+Fl/6h8KcNSvoPZWpIORKs+lOwgKtbdQafkAT6pO1axesg+2bV/am7r73YEpwdochGyVdESL4+EtIK0DlRZfGJ0ErJppgyPe5BwVx0Yn4uqB8IGgqrFosQFTenAmnDC4nmuSRao3L3PmbBRMJejSAya/W9I6bIMUMA+Kk3h6caMj2Mh+MfOqfl6Zw2qzN24bOibFhdoMvtR06wCuGJo4bQ/NRuyeY9IMvtznRfJuXUt+qUuQwGDf2xfzzF0B60DQs6TgtFqCfTaO8eohXGNucSFCZ0I8n/lJJSZ3tA2Zdvb2jqUWmqvzR17+L2QnLI9wXrtS0fi93yevc9QnjkLHrgrvtCypHbAjl6B8wORow+SwW2lBVQsAVgJ9IaFbQ4aZt4MP5fGg1SRdPezpHVzrPSef0fHSOB3R2wx854nEDsIJK9rA+GNh9ai6FT99iSnwyEvBK6PkIjSfnQ3QyQPQJcqKQzZV1hRS7CwCyom/xZHrl8YN+z/n5ePw85FGtaPw4TVHWAZ/vVjVOVR7TDUiJ4lwKpfwK6cdAytl/gxS3h7+t3nf0r/YP'),
			this.addDataEntry(dt + 'deep linked modal bottom sheet', 358, 642, 'Deep-linked modal bottom sheet',
				'3Vrbbts4EP0ao08JZMtxnMfETYoFtsBiW6CPC9qiJMKUqJKUbfXrd2ZI6uJL6zR2CzRFYomXIeecmdGh3FG8KHYfNKvyjyrhchQ/j+KFVsq6q2K34FKOJpFIRvH70WQSwe9o8nKid0y9UcU0L+05EyZuwobJmrsW12BsI31DwkzOcXg0ip+YFFkJ1yuwzzU0pKq0n8Q3HDuewL3JWYU3mq8sdgspF0oqTbbilH5wmNVqzUNPqUqY8+T3wrXlu5P+UJN35gNXBbe6gSFbkdjcjYjv5m5azkWW+2mzqfeMGdeQtXM7eODCI3QcrfgALfT5MY4uC1oYr93290GcvI8f5rNTIKLt3uAX+sHBFVuJMvvXQzLtmj6rCjcS9uWdiPb2GcO95gbuvniox+dSNvk5yiZT16a5ZFZs+MD+W2icvjLoc1tI729gqthlmLO3WZHIW6uq/5ZMv5aps7CLj2M3nND4VL+9c/c9ZKezQ2DHrwXWr/+PErCtdvGbh8lg+Zv7oQWVpobbA2JaL87i6u6Aq4+MEMhZAn+lWHP8tApvlFrj+pb81fC3UNZdpFoV2AW/iTCWlSuOtyXOBaZbezZXNeIUDAA7uFilubVwAduNlrV1ToaZ65Jvu6FSWCuxWaWtFTdupWpJ662YXnHpnNhgz5LzEj74roIC0PeHep0NpUNzIYzZ32BRr3IkPidDbr0t7TGDYLuFz0/Ulgi0Xiq7b4dAYwg9+ijQSsqgGtGtw6nnsjONaBou0xu2NEovaeOrXMgO1Iz1PICYFpoPQCZ/oBet+KW6RRwjTG5Zg42Jd+SvdG+ER0/JpAf21oNdKppaL+0B3B46Vu6Eqk3AYMmhJCL4PHWQYLJ6RKw3rdF0Fwt9TLzRRtVo5Sh4e3753Vi2pk8IjhA9i3aKqatKGd4B284Ofi4Jmy856zbUwey2ZvudYR4mUCBiXSoMZJGO9kPIQUKDSkGpU3FVYZgvKOrUYCfYrSAPWsM+xAiITPRCwof2tqS1moCTa35sWN5Oc9CHdC5d3cLw0xtWWtPC6qMEql48jqjI9i59EviEHeJBC7vEGPgLxaIJseE28VxmUhjc2kpynTUFK9/RBiCKuEtCorBvOLBLZlKhjT2ek1tW2v7KOOrzqVVb65VSHcC9GEsdSJSTmtYvOdNUeSjVvUOGFRRTWVcToaNxoe48YctlQ0sjA6YdtnWettH4tWYanioOPl9dgSvYgAeURvlizBnVLOIU/WwLuy+B8MhCr2ooG0lDyVZmkI7bbnWXVJThwrBMc86Wso06MFB0NLPUUug4l4kCnEfkutq6pfBWS5U0vXCuJHNixeYuMnGrT00HHl8p2o0z5YFz+GOsl138u+xZlw7ubS7I/4IlXUKktcZidHsgSPYk4nHpN1Qfi5fF8+L5qGyDtS3/BPIPTW5ByXRqEEdgtqAuESsmH70YtagSW2lK1fG68i++j94mU5qhjLyoLJkdyJIU+FtMRk/3G4ymmUR4ErGBy8wh5ZpQUmMitTTNvtbKDYjnEf7rN/UiIDSigRtDovwRBoxn1a4/I6z28g6q+IwVlTM9i5B2vTnShjD4zcGl299wz9A88OScs44PkN4JYjI9POmcE8YvL4txdH80jH3I/k1rvR/fHZxp9tT7W8K1GUz4UfCOx5cJ3ps4nl8hfO8vfALaKFkX/ExC53ezu2h6Lh2zNx6A/AuQ4cnyjeSEA9A8Gh6AAukX5Wp+Ya5AVuhTTA0b+1z1ORwMDvk4+Z2EjueXIXS6R+jDFfh8OMLnlZ4NU3g2UBnfezyUcDr5Qc0fPrp6avroE+FgDsDKS9PpyYoZIxRIQRJfnCTi7dnWOg/cwYZJd+r3oqyvZeExTA9gd/wmyUViH0QaxuUAi7MXf7X7v5xR00BSNoVxwzza/vypEwTEHeuRFRHeZHzjzJ/3Nxy0Mmh5ei2CDbxQtrWwZbpAoKmD6ZIbC7/Gm9+IpLXI4Qyhu741HG27O6gAeW0EM4W/361AhRZYGPxBWRSsW3UjsrBvXuKJx12n9A6BjsaV0MIGV4y/wgAAP5pfomnGP6lp2vfgJzWNEzDRUJffndTlvaJ/TNv/QuEzv5DwaR98Fy2+4Ql9tS88zmE/op+Lv09/HVHTNz4yA0/Tq9A0vrDoWbLV+pi+aRPxFEU/KXJcnJ1UOdFteLH9HaETXtNf49X9/VDnXOPN/XjyYw4DVzBTVOaoAv1tDP35BB1+nXmSoKPV7Xeyc/+n0QO33df+bnj/fwX8Dw=='),
			this.addDataEntry(dt + 'long list', 358, 642, 'Long list',
				'7Zpfb5swEMA/TR4bGQMhPOZP001rtWqdtMeKgAOoBiNwt2SffjaGFGJonQZnU1aiSNg+G/t+vrM5MzIXyfYm97LojgQIj8zrkbnICaHiLtkuEMYjCOJgZC5HEAL2H8FVT6lRloLMy1FKVSpAUeGnh5+RyBEZBd3hKiPwighxcTAy5x6Ow5Td+6x9lLOMDUnpQ/ybyxqQpYvIy3giRz7lxTHGC4JJXrZlbsqLi9GcPKG6JCUpqzOv+oJyira94ymzqsHcIJIgmu+YyK84oJGQMO2pqBahOIyqahOrGplXiIxwX/dFPeym0lC3tkxJW3zMMxMMq7RaPhfdP1QicB1zdt2nRN52Q3hVXlw48/w4Db9VKrFesr6TjHek7lc1CHDQT5Olc1Sw1I9K1YYqMvg+ZNASeTnCHo1/olb7p2C0jpz0EU1wNd6aVLINuc2OwyTAY0qyx7WXH0tKSXdmt+7aFXaVqY9tkW5o1prIijWOVWz1/HsSs27tH37lwtbjr5x2C2SzKRCVwOxHocTK1uygum3oEON0uZidff5PwGmYdm0zGhTLZGATynK0QUxjPipUoUwtewJUEdhvIqjV1DKUySCGUjdTAwEagDgDAymQl/uRxKKp+CaQipEQrg0EnkinXaHByuhyasOwunJM/bCmA8PivuysdtNPpsOPDUXGtPSTcSUyXzOUcoFUQnTsSlJl1SsURhsq79emgP8O1i1ruJUGAiATgieuNHWHQAuQ62oAVD+jQegLQlkvnJadPHFJNTNZWXMHzGVc2FsjfE+KmMakuUfnYGLfw7cH5UkcBLxPe4FZ1d6+oNqF35btL6FW9udCb1g6Nh2GIbH/nK7JVg1+XIr+x/Th2ei7WujLsYpPXhqSZ7b0KU2ASEirrpMr17HtC5sCXQ4A6pgCUI8DkAMwd6goUBqyVz2lOZDsxT8cgX5HAPU4Ajl+c0NIyLQI52qzICzFHzP8rLprZgDYS/qFzYOzbQdMPd5Ajg09RAipLgeFkFXjD42ZNbEui3/XW/RQ/GGbvx4/IAehlsRXpB9wSTX21mp6vbow2z8fe0uP7cvxrgccB0jV9oWs4h7AnrsG+OD/Tv56bF8Ood1HhBJF/pmQvSik51vObT0mLcfeJJj6j3rKa/Cjnl2rwlsHP9b0NGr1eVzdzqCYoByAex3TW8Hrtec/dZ0z7L8V6EP0zsMGMc96Y9pgXJ85vnKqWr+C6DhVdVpP13KoCuVAWq/fZDXjrED/FKHLByTHunoBdXq3v0nHuTQ8LPnyRZYQb36w9Qc=')
   		];
		  
		this.addPalette('gmdlBottom Sheets', 'GMDL / Bottom Sheets', expand || false, mxUtils.bind(this, function(content)
		{
			for (var i = 0; i < fns.length; i++)
			{
				content.appendChild(fns[i](content));
			}
		}));
	};

	Sidebar.prototype.addGMDLButtonsPalette = function(expand)
	{
		var s = "dashed=0;align=center;fontSize=12;shape=";
		var s2 = "dashed=0;html=1;shape=mxgraph.gmdl.";
		var anc = "shape=rect;fillColor=none;strokeColor=none;";
		var fac = 'shape=ellipse;dashed=0;fillColor=#ffffff;strokeColor=none;shadow=1;fontSize=13;fontColor=#000000;align=center;verticalAlign=top;labelPosition=center;verticalLabelPosition=bottom;html=1;aspect=fixed;';
		var gn = 'mxgraph.gmdl';
		var dt = 'gmdl google media design library button ';
		var sb = this;
		
		var fns = [
			this.createVertexTemplateEntry(s + 'rect;fillColor=#e0e0e0;strokeColor=none;fontStyle=1;shadow=1;fontColor=#000000;',
					100, 36, 'NORMAL', 'Raised Button (Normal)', null, null, this.getTagsForStencil(gn, 'button', dt).join(' ')),
			this.createVertexTemplateEntry(s + 'rect;fillColor=#e0e0e0;strokeColor=none;fontStyle=1;shadow=1;fontColor=#000000;',
					100, 36, 'HOVER', 'Raised Button (Hover)', null, null, this.getTagsForStencil(gn, 'button', dt).join(' ')),
			this.createVertexTemplateEntry(s + 'rect;fillColor=#e0e0e0;strokeColor=none;fontStyle=1;shadow=1;',
					100, 36, 'FOCUSED', 'Raised Button (Focused)', null, null, this.getTagsForStencil(gn, 'button', dt).join(' ')),
			this.createVertexTemplateEntry(s + 'rect;fillColor=#e0e0e0;strokeColor=none;fontStyle=1;shadow=1;fontColor=#000000;',
					100, 36, 'PRESSED', 'Raised Button (Pressed)', null, null, this.getTagsForStencil(gn, 'button', dt).join(' ')),
			this.createVertexTemplateEntry(s + 'rect;fillColor=#000000;strokeColor=none;fontStyle=1;opacity=12;fontColor=#BDBDBD;',
					100, 36, 'DISABLED', 'Raised Button (Pressed)', null, null, this.getTagsForStencil(gn, 'button', dt).join(' ')),
			this.createVertexTemplateEntry(s + 'rect;fillColor=#2196F3;strokeColor=none;fontStyle=1;shadow=1;fontColor=#ffffff;',
					100, 36, 'NORMAL', 'Raised Button (Normal)', null, null, this.getTagsForStencil(gn, 'button', dt).join(' ')),
			this.createVertexTemplateEntry(s + 'rect;fillColor=#2196F3;strokeColor=none;fontStyle=1;shadow=1;fontColor=#ffffff;',
					100, 36, 'HOVER', 'Raised Button (Hover)', null, null, this.getTagsForStencil(gn, 'button', dt).join(' ')),
			this.createVertexTemplateEntry(s + 'rect;fillColor=#2196F3;strokeColor=none;fontStyle=1;shadow=1;fontColor=#ffffff;',
					100, 36, 'FOCUSED', 'Raised Button (Focused)', null, null, this.getTagsForStencil(gn, 'button', dt).join(' ')),
			this.createVertexTemplateEntry(s + 'rect;fillColor=#2196F3;strokeColor=none;fontStyle=1;shadow=1;fontColor=#ffffff;',
					100, 36, 'PRESSED', 'Raised Button (Pressed)', null, null, this.getTagsForStencil(gn, 'button', dt).join(' ')),
			this.createVertexTemplateEntry(s + 'rect;fillColor=#ffffff;strokeColor=none;fontStyle=1;opacity=12;fontColor=#BDBDBD;shadow=0;',
					100, 36, 'DISABLED', 'Raised Button (Pressed)', null, null, this.getTagsForStencil(gn, 'button', dt).join(' ')),
			this.createVertexTemplateEntry(s + 'rect;fillColor=none;strokeColor=none;fontStyle=1;fontColor=#000000;shadow=0;',
					100, 36, 'NORMAL', 'Raised Button (Normal)', null, null, this.getTagsForStencil(gn, 'button', dt).join(' ')),
			this.createVertexTemplateEntry(s + 'rect;fillColor=#999999;opacity=20;strokeColor=none;fontStyle=1;fontColor=#000000;shadow=0;',
					100, 36, 'HOVER', 'Raised Button (Hover)', null, null, this.getTagsForStencil(gn, 'button', dt).join(' ')),
			this.createVertexTemplateEntry(s + 'rect;fillColor=#999999;opacity=20;strokeColor=none;fontStyle=1;fontColor=#000000;shadow=0;',
					100, 36, 'FOCUSED', 'Raised Button (Focused)', null, null, this.getTagsForStencil(gn, 'button', dt).join(' ')),
			this.createVertexTemplateEntry(s + 'rect;fillColor=#999999;opacity=40;strokeColor=none;fontStyle=1;',
					100, 36, 'PRESSED', 'Raised Button (Pressed)', null, null, this.getTagsForStencil(gn, 'button', dt).join(' ')),
			this.createVertexTemplateEntry(s + 'rect;fillColor=#ffffff;opacity=26;strokeColor=none;fontStyle=1;opacity=12;fontColor=#BDBDBD;shadow=0;',
					100, 36, 'DISABLED', 'Raised Button (Pressed)', null, null, this.getTagsForStencil(gn, 'button', dt).join(' ')),
			this.createVertexTemplateEntry(s + 'rect;fillColor=none;strokeColor=none;fontStyle=1;fontColor=#ffffff;shadow=0;',
					100, 36, 'NORMAL', 'Raised Button (Normal)', null, null, this.getTagsForStencil(gn, 'button', dt).join(' ')),
			this.createVertexTemplateEntry(s + 'rect;fillColor=#cccccc;opacity=15;strokeColor=none;fontStyle=1;fontColor=#ffffff;shadow=0;',
					100, 36, 'HOVER', 'Raised Button (Hover)', null, null, this.getTagsForStencil(gn, 'button', dt).join(' ')),
			this.createVertexTemplateEntry(s + 'rect;fillColor=#cccccc;opacity=15;strokeColor=none;fontStyle=1;fontColor=#ffffff;shadow=0;',
					100, 36, 'FOCUSED', 'Raised Button (Focused)', null, null, this.getTagsForStencil(gn, 'button', dt).join(' ')),
			this.createVertexTemplateEntry(s + 'rect;fillColor=#cccccc;opacity=25;strokeColor=none;fontStyle=1;fontColor=#ffffff;shadow=0;',
					100, 36, 'PRESSED', 'Raised Button (Pressed)', null, null, this.getTagsForStencil(gn, 'button', dt).join(' ')),
			this.createVertexTemplateEntry(s + 'rect;fillColor=none;strokeColor=none;fontStyle=1;opacity=12;fontColor=#BDBDBD;shadow=1;',
					100, 36, 'DISABLED', 'Raised Button (Pressed)', null, null, this.getTagsForStencil(gn, 'button', dt).join(' ')),
			this.addDataEntry(dt + 'dropdown menu', 100, 180, 'Dropdown Menu',
				'7ZVLT8QgEMc/DXcKXbMetdq9aGKyB8+kTFsiLQ3Fffjp5bXPbuPGVaOJJE2YYWZgfn8aEM2a1Uyzrn5UHCSi94hmWikTZs0qAykRwYIjeocIwfZDJB9ZTfwq7piG1pyTQELCgslXCJ7g6M1aRgdnfQ0uHCN6y6SoWjsvbH3Q1lGq1szFm4tNiLX7mnXO0FAYtyykzJRU2teipR8uzGj1Ansr4EcowNXSlbNGPB1oA6vRDr0rtjcD1YDRaxuyFNzUMQIHCrgGUdWbtGl0sj44qm3uDpidRGan+dEBv7lhBqwrGYC0PZhIbK/xPE/x1PXquhQFkzcRcSM4l55IxwrRVg9QupMn9Ih6am0NvbWeY8dnkyOfI5dOgk+DZEYs4KD+JTTTUZrDa3maJvbjQppHl3Z7NX855bjFkxJ2Z4LXh2U2GaosezADVbYHO0uoyahQ9CeF+pOCXONvEORqVJD0X5APBEnoF/wi1ty92iF8/1F/Bw=='),
			this.addDataEntry(dt + 'dropdown button', 100, 30, 'Dropdown Button',
				'xZTdTsMgFICfhksXBvMBtqq70cTEJyDlFIhQGoqz9emFQrt23RKNF5I04fxyztcDiBamOzrWyBfLQSP6iGjhrPVpZ7oCtEYEK47oAyIEhw+RpxvW7WDFDXNQ+58EkBRwYvoDkiYpWt/rrOCslRDdMaIHppWow74M+cEFRWVr/6a+ou+WBLmVrImCg9JHs9K6sNq6IRethhXdvLPvMLOUwwqWXBA4D93NpgZV7ugI1oB3fXD5VNzL7IFT41iCEjKH7bKOtUkWU+gZUdhkSteJ0RWxvVNMr7CF8n3mM2sTDyvoY4OqZHqfgRrFeQw9tA0rVS2eoYpFb+kF491PEZH/Q7T75VBJb3TsbTY+phPxTmyE4XrjA+BaDHQu5mmamuU81baGP3JaBvT5Lm3uk7yguIaYvRxo5tUJFqmugc3Hv1oVqprOvhvz9KM8Hj/msFXVgl/9mqmNa38riOfnJbnPX59v'),
			this.addDataEntry(dt + 'dropdown button editable', 100, 40, 'Dropdown Button (Editable)',
				'xZT9boMgEMCfhj/bINgHaN3W/bElS/YERE8lQzDIOrunHyi1frTOpU1GYsJ9yd3vDhCNinqvWZm/qgQEoo+IRlop0+6KOgIhEME8QfQBEYLth8jTFWvQWHHJNEizJIC0AQcmPqHVtIrKHIVXJKzKwbljRHdM8EzafWz/D9oqUiXNO/92vgGxcpWz0gkaYuPMXIhICaWbf9G0Wc7NaPUBPUvcLGvxCYE2UF8tqlH5ivagCjD6aF2+eGJy74HbwnEOPMt9WOh1rGrlrAs9I7IbT+kyMTohttWciQk2m77xfHpl4mZZvSuQx0xsPdCCJ4kL3VUli7nMXiB1SQd0xDhcioj8H6Lw96GaGROpJMxOiIbKwng+JR3cSGQY0OMTzuDRIJjhBxjEXmLmz3tT3KbRHbYaY1ZpWoGZQO7SXMR988fLnJtCeICnfhR15t6idVYkYm3sYMusmcrRPe56MeySb92iboSz3cBrX8xxJA/md9qfzX3aMzx8RU6n39IuK57f9da9/+z/AA=='),
			this.addDataEntry(dt + 'dropdown button selected', 100, 150, 'Dropdown Button (Selected)',
				'7ZbbTsMwDIafppdMbbMBt1uB3YCEhATXoXHbiLSZ0uzE0+McukPL2AYbEhKRJtVO7MTfH3cNSFIuxopOigfJQATkNiCJklK7p3KRgBBBHHIWkJsgjkP8BfHdjtnIzoYTqqDShwTELmBGxRScxzlqvRTewWhdgFkeBmREBc8rfE4xPyh0ZLLST/zdrI1itOuCToyhINVmmguRSCGVzUUyO8wyreQbbMykdrgETM5NOjT86UBpWOys0Lp8eWOQJWi1xCVzznThV4SOQlgAz4smbOCdtHaOfBW7BoYPntnn/EiH31BxKjoQ21iQ2kbxoR3oN5XylIqhx1xyxkyKUT2hKa/ye8jM6SPSIt//EmkjmrDRIwU1hr14PAdjjr+Hue99CgTVfAZb+X+Cvn/k1S10KXy9jRrlIjed18tLJnoahatyS7t1a9d3cwtxJSs4FB75HN52wNJ3bG/g7C20XbKDI8H67R8lx1Ot9r5o8iwbu9m+ySGzrAbdkWZVxkFqDTpqJXgtXxXf1yqty3uOzmnJDXbskvt3u4cc2z0tkb2o7VfdSSS97Eoqp4rj30JbUgRzLu3+pBzX55DjqiPHMyhGK/ovxx45ougEeqC5/mxzyze/6j4A'),
			this.addDataEntry(dt + 'dropdown button selected editable', 100, 150, 'Dropdown Button (Selected, Editable)',
				'7ZZRT4MwEMc/DY8uQJn66lDngyYmJvpc6QGNhS6l6uan90rLNkARFX1aE5L2endtf/9y4JG4WC8VXeU3koHwyIVHYiWltr1iHYMQXuhz5pFzLwx9fLzw8pPZoJ71V1RBqccEhDbghYpnsBZrqPRGOAOjVQ7G3ffIggqeldhPMD8oNKSy1Hf8zfgGIY6rnK7MQEGizTQXIpZCqjoXSetm3LSST7A3k9TNJmDy1aTDgdsdKA3rT09Ym9zxliAL0GqDLq+c6dx5+JaCnwPP8iZs7oy0soZsG7sDhh3H7GN+pMfvTHEqehC7WJDa3uH9uqHdnJQnVJw5zAVnzKRYVCua8DK7htTsPiAd8tEg0kY0UUcvFFQY9uDwjMYc/gxz5GwKBNX8BVr5f4M++vrqDlzGUpYwCM1SumpOMhoT+RhTO2APWjQFM7fereS4je1iR1Hnhss0rUD3IG+3OYr7/JslI9eFcAAbPYp1ZireLCuYmGl8YcqsvuWdarGrCS2VnHSj1IgG1fBn7jCbzrh1qfv6zKeRp734UdisPqlcxz25YqwHj4r3VEOOf1Wb/rfkkF++Pk6Q7vdhEjlO+nLIZ8XxW3qQY1iO07+Q47Qnxz0oRkt6kOMLOYJgAj1wuPvXte77v8Lv'),
			this.addDataEntry(dt + 'persistent footer button', 300, 40, 'Persistent Footer Buttons',
				'3ZXRTsMgFIafhnsK64y3q25X6oXzAYicDSLtaQBd59NLAbdVXabJ3EVJSM75f/4WvpBAeFV3CytadYcSDOG3hFcW0aeq7iowhjCqJeE3hDEaJmHzI24RXdoKC43/TYClwJswr5CUJDi/NVlwSrR9aeE5fHK20sZUaNBGl6/iCLrzFl/gwIE4ekcJiZsg0tDk/4H10B3dc5TyhheANXi7DUs2WnqVVnCazkUV6LXKsUnWhEv9ehfdEwhFhvAzEP4NyOxpuXy4P4VlePwGG/jC6lPCxj/q9z5ZsNwfQGPF9XTOgy6FUyD/Ao2dhHZV/g+zydiYdUNeF0BYjhRhUdKLMZyOlOHudpyfYWj3b030Bk/RBw=='),
			this.addDataEntry(dt + 'persistent footer button fixed', 300, 40, 'Persistent Footer Buttons (fixed)',
				'7ZXfboMgFMafhnuEtstu69buZn+SdQ9A5rGQoRhgrd3TDwWtrjN1aXcniQnnO5wD/D4TEI2zcq1ZwR9VAhLRe0RjrZT1s6yMQUpEsEgQvUOEYPchshrIRnUWF0xDbscUEF+wY/ITvOIFYw8yCIazoppqeHctl6mQMlZS6TpL03o43VitPqCTgXpUGc4StXcidkHYD7SFcvDMtRQOvAaVgdUHt2QvEsv9Cor9vTAHseWhbBY0Zny8bUuPBNwkQPgdCD0BsnzbbJ6fzmHpXz9XOfxg1Ugqt6/iq6qMSIg70Eh0u1hRpyfMcEgCNA3GlTw0V43GciRnOd7MhzFqkMyKHfTaX8J2NrH9M9uww4sSbmOCy37rpkKlqQF74kV7rlH2zCd7rmRPNMf/4M9i8udK/rT/+iX+uPD4Tvvl3Wf8Gw=='),
			
			this.addEntry(dt + 'floating action button', function()
			{
				var bg1 = new mxCell('', new mxGeometry(0, 0, 56, 56), 'shape=ellipse;fillColor=#FF4081;strokeColor=none;shadow=1;aspect=fixed;');
				bg1.vertex = true;
				var part1 = new mxCell('', new mxGeometry(20, 20, 16, 16), s2 + 'plus;strokeColor=#ffffff;strokeWidth=2;shadow=0;');
				part1.vertex = true;
				bg1.insert(part1);
			   	return sb.createVertexTemplateFromCells([bg1], 56, 56, 'Floating Action Button');
			}),
			
			this.addEntry(dt + 'floating action button', function()
			{
				var bg1 = new mxCell('', new mxGeometry(0, 0, 56, 56), fac);
				bg1.vertex = true;
				var part1 = new mxCell('', new mxGeometry(18, 18, 20, 20), s2 + 'edit;strokeColor=none;fillColor=#737373;shadow=0;');
				part1.vertex = true;
				bg1.insert(part1);
			   	return sb.createVertexTemplateFromCells([bg1], 56, 56, 'Floating Action Button');
			}),
			this.addEntry(dt + 'floating action button', function()
			{
				var bg1 = new mxCell('', new mxGeometry(0, 0, 56, 56), fac);
				bg1.vertex = true;
				var part1 = new mxCell('', new mxGeometry(18, 18, 20, 20), s2 + 'star;strokeColor=none;fillColor=#737373;shadow=0;');
				part1.vertex = true;
				bg1.insert(part1);
			   	return sb.createVertexTemplateFromCells([bg1], 56, 56, 'Floating Action Button');
			}),
			this.addEntry(dt + 'floating action button', function()
			{
				var bg1 = new mxCell('', new mxGeometry(0, 0, 56, 56), fac);
				bg1.vertex = true;
				var part1 = new mxCell('', new mxGeometry(18, 19, 20, 18), s2 + 'heart;strokeColor=none;fillColor=#737373;shadow=0;');
				part1.vertex = true;
				bg1.insert(part1);
			   	return sb.createVertexTemplateFromCells([bg1], 56, 56, 'Floating Action Button');
			}),
			this.addEntry(dt + 'floating action button', function()
			{
				var bg1 = new mxCell('', new mxGeometry(0, 0, 56, 56), fac);
				bg1.vertex = true;
				var part1 = new mxCell('', new mxGeometry(18, 19, 20, 18), s2 + 'reply;strokeColor=none;fillColor=#737373;shadow=0;');
				part1.vertex = true;
				bg1.insert(part1);
			   	return sb.createVertexTemplateFromCells([bg1], 56, 56, 'Floating Action Button');
			}),
			this.addEntry(dt + 'floating action button', function()
			{
				var bg1 = new mxCell('', new mxGeometry(0, 0, 56, 56), fac);
				bg1.vertex = true;
				var part1 = new mxCell('', new mxGeometry(18, 20, 24, 16), s2 + 'users;strokeColor=#ffffff;fillColor=#737373;strokeWidth=2;shadow=0;');
				part1.vertex = true;
				bg1.insert(part1);
			   	return sb.createVertexTemplateFromCells([bg1], 56, 56, 'Floating Action Button');
			}),
			this.addEntry(dt + 'floating action button', function()
			{
				var bg1 = new mxCell('', new mxGeometry(0, 0, 56, 56), fac);
				bg1.vertex = true;
				var part1 = new mxCell('', new mxGeometry(18, 18, 20, 20), s2 + 'gps;strokeColor=#737373;fillColor=#737373;strokeWidth=2;shadow=0;');
				part1.vertex = true;
				bg1.insert(part1);
			   	return sb.createVertexTemplateFromCells([bg1], 56, 56, 'Floating Action Button');
			}),
			this.addEntry(dt + 'floating action button', function()
			{
				var bg1 = new mxCell('', new mxGeometry(0, 0, 56, 56), fac);
				bg1.vertex = true;
				var part1 = new mxCell('', new mxGeometry(18, 18, 20, 20), s2 + 'share2;strokeColor=none;fillColor=#737373;shadow=0;');
				part1.vertex = true;
				bg1.insert(part1);
			   	return sb.createVertexTemplateFromCells([bg1], 56, 56, 'Floating Action Button');
			}),
			this.addEntry(dt + 'floating action button', function()
			{
				var bg1 = new mxCell('', new mxGeometry(0, 0, 56, 56), fac);
				bg1.vertex = true;
				var part1 = new mxCell('', new mxGeometry(18, 18, 20, 20), s2 + 'navigate;strokeColor=none;fillColor=#737373;shadow=0;');
				part1.vertex = true;
				bg1.insert(part1);
			   	return sb.createVertexTemplateFromCells([bg1], 56, 56, 'Floating Action Button');
			}),
			this.addEntry(dt + 'floating action button', function()
			{
				var bg1 = new mxCell('', new mxGeometry(0, 0, 56, 56), fac);
				bg1.vertex = true;
				var part1 = new mxCell('', new mxGeometry(18, 18, 20, 20), s2 + 'chat;strokeColor=#737373;fillColor=#737373;shadow=0;');
				part1.vertex = true;
				bg1.insert(part1);
			   	return sb.createVertexTemplateFromCells([bg1], 56, 56, 'Floating Action Button');
			}),
			this.addEntry(dt + 'floating action button', function()
			{
				var bg1 = new mxCell('', new mxGeometry(0, 0, 56, 56), fac);
				bg1.vertex = true;
				var part1 = new mxCell('', new mxGeometry(22, 18, 12, 20), s2 + 'voice;strokeColor=#737373;fillColor=#737373;strokeWidth=2;shadow=0;');
				part1.vertex = true;
				bg1.insert(part1);
			   	return sb.createVertexTemplateFromCells([bg1], 56, 56, 'Floating Action Button');
			}),
			this.addEntry(dt + 'floating action button', function()
			{
				var bg1 = new mxCell('', new mxGeometry(0, 0, 56, 56), fac);
				bg1.vertex = true;
				var part1 = new mxCell('', new mxGeometry(20, 16, 16, 24), s2 + 'google;strokeColor=none;fillColor=#737373;shadow=0;');
				part1.vertex = true;
				bg1.insert(part1);
			   	return sb.createVertexTemplateFromCells([bg1], 56, 56, 'Floating Action Button');
			}),
			this.addEntry(dt + 'floating action button', function()
			{
				var bg1 = new mxCell('', new mxGeometry(0, 0, 56, 56), fac);
				bg1.vertex = true;
				var part1 = new mxCell('', new mxGeometry(16, 20, 24, 16), s2 + 'video;strokeColor=none;fillColor=#737373;shadow=0;');
				part1.vertex = true;
				bg1.insert(part1);
			   	return sb.createVertexTemplateFromCells([bg1], 56, 56, 'Floating Action Button');
			}),
			this.addEntry(dt + 'floating action button', function()
			{
				var bg1 = new mxCell('', new mxGeometry(0, 0, 56, 56), fac);
				bg1.vertex = true;
				var part1 = new mxCell('', new mxGeometry(16, 17, 24, 22), s2 + 'gallery;strokeColor=none;fillColor=#737373;shadow=0;');
				part1.vertex = true;
				bg1.insert(part1);
			   	return sb.createVertexTemplateFromCells([bg1], 56, 56, 'Floating Action Button');
			}),
			this.addEntry(dt + 'floating action button', function()
			{
				var bg1 = new mxCell('', new mxGeometry(0, 0, 56, 56), fac);
				bg1.vertex = true;
				var part1 = new mxCell('', new mxGeometry(16, 17, 24, 22), s2 + 'birthday;strokeColor=none;fillColor=#737373;shadow=0;');
				part1.vertex = true;
				bg1.insert(part1);
			   	return sb.createVertexTemplateFromCells([bg1], 56, 56, 'Floating Action Button');
			}),
			this.addEntry(dt + 'floating action button', function()
			{
				var bg1 = new mxCell('', new mxGeometry(0, 0, 56, 56), fac);
				bg1.vertex = true;
				var part1 = new mxCell('', new mxGeometry(16, 20, 24, 16), s2 + 'cloud;strokeColor=none;fillColor=#737373;shadow=0;');
				part1.vertex = true;
				bg1.insert(part1);
			   	return sb.createVertexTemplateFromCells([bg1], 56, 56, 'Floating Action Button');
			}),
			this.addEntry(dt + 'floating action button', function()
			{
				var bg1 = new mxCell('', new mxGeometry(0, 0, 56, 56), fac);
				bg1.vertex = true;
				var part1 = new mxCell('', new mxGeometry(20, 20, 16, 16), s2 + 'x;strokeColor=#737373;strokeWidth=2;shadow=0;');
				part1.vertex = true;
				bg1.insert(part1);
			   	return sb.createVertexTemplateFromCells([bg1], 56, 56, 'Floating Action Button');
			}),
			this.addEntry(dt + 'floating action button', function()
			{
				var bg1 = new mxCell('', new mxGeometry(0, 0, 56, 56), fac);
				bg1.vertex = true;
				var part1 = new mxCell('', new mxGeometry(22, 18, 12, 20), s2 + 'bookmark;strokeColor=none;fillColor=#737373;shadow=0;');
				part1.vertex = true;
				bg1.insert(part1);
			   	return sb.createVertexTemplateFromCells([bg1], 56, 56, 'Floating Action Button');
			}),
			this.addEntry(dt + 'floating action button', function()
			{
				var bg1 = new mxCell('', new mxGeometry(0, 0, 56, 56), fac);
				bg1.vertex = true;
				var part1 = new mxCell('', new mxGeometry(18, 18, 20, 20), s2 + 'calendar;strokeColor=none;fillColor=#737373;shadow=0;');
				part1.vertex = true;
				bg1.insert(part1);
			   	return sb.createVertexTemplateFromCells([bg1], 56, 56, 'Floating Action Button');
			}),
			this.addEntry(dt + 'floating action button', function()
			{
				var bg1 = new mxCell('', new mxGeometry(0, 0, 56, 56), fac);
				bg1.vertex = true;
				var part1 = new mxCell('', new mxGeometry(17, 20, 22, 16), s2 + 'attractions;strokeColor=#ffffff;fillColor=#737373;strokeWidth=1;shadow=0;');
				part1.vertex = true;
				bg1.insert(part1);
			   	return sb.createVertexTemplateFromCells([bg1], 56, 56, 'Floating Action Button');
			}),
			this.addEntry(dt + 'floating action button', function()
			{
				var bg1 = new mxCell('', new mxGeometry(0, 0, 56, 56), fac);
				bg1.vertex = true;
				var part1 = new mxCell('', new mxGeometry(20, 18, 16, 20), s2 + 'dining;strokeColor=none;fillColor=#737373;shadow=0;');
				part1.vertex = true;
				bg1.insert(part1);
			   	return sb.createVertexTemplateFromCells([bg1], 56, 56, 'Floating Action Button');
			}),
			this.addEntry(dt + 'floating action button', function()
			{
				var bg1 = new mxCell('', new mxGeometry(0, 0, 56, 56), fac);
				bg1.vertex = true;
				var part1 = new mxCell('', new mxGeometry(18, 18, 20, 20), s2 + 'education;strokeColor=none;fillColor=#737373;shadow=0;');
				part1.vertex = true;
				bg1.insert(part1);
			   	return sb.createVertexTemplateFromCells([bg1], 56, 56, 'Floating Action Button');
			}),
			this.addEntry(dt + 'floating action button', function()
			{
				var bg1 = new mxCell('', new mxGeometry(0, 0, 56, 56), fac);
				bg1.vertex = true;
				var part1 = new mxCell('', new mxGeometry(18, 18, 20, 20), s2 + 'family;strokeColor=none;fillColor=#737373;shadow=0;');
				part1.vertex = true;
				bg1.insert(part1);
			   	return sb.createVertexTemplateFromCells([bg1], 56, 56, 'Floating Action Button');
			}),
			this.addEntry(dt + 'floating action button', function()
			{
				var bg1 = new mxCell('', new mxGeometry(0, 0, 56, 56), fac);
				bg1.vertex = true;
				var part1 = new mxCell('', new mxGeometry(18, 19, 20, 18), s2 + 'health;strokeColor=none;fillColor=#737373;shadow=0;');
				part1.vertex = true;
				bg1.insert(part1);
			   	return sb.createVertexTemplateFromCells([bg1], 56, 56, 'Floating Action Button');
			}),
			this.addEntry(dt + 'floating action button', function()
			{
				var bg1 = new mxCell('', new mxGeometry(0, 0, 56, 56), fac);
				bg1.vertex = true;
				var part1 = new mxCell('', new mxGeometry(18, 18, 20, 20), s2 + 'office;strokeColor=none;fillColor=#737373;shadow=0;');
				part1.vertex = true;
				bg1.insert(part1);
			   	return sb.createVertexTemplateFromCells([bg1], 56, 56, 'Floating Action Button');
			}),
			this.addEntry(dt + 'floating action button', function()
			{
				var bg1 = new mxCell('', new mxGeometry(0, 0, 56, 56), fac);
				bg1.vertex = true;
				var part1 = new mxCell('', new mxGeometry(18, 18, 20, 20), s2 + 'promotions;strokeColor=none;fillColor=#737373;shadow=0;');
				part1.vertex = true;
				bg1.insert(part1);
			   	return sb.createVertexTemplateFromCells([bg1], 56, 56, 'Floating Action Button');
			}),
			this.addEntry(dt + 'floating action button', function()
			{
				var bg1 = new mxCell('', new mxGeometry(0, 0, 56, 56), fac);
				bg1.vertex = true;
				var part1 = new mxCell('', new mxGeometry(18, 18, 20, 20), s2 + 'radio;strokeColor=none;fillColor=#737373;shadow=0;');
				part1.vertex = true;
				bg1.insert(part1);
			   	return sb.createVertexTemplateFromCells([bg1], 56, 56, 'Floating Action Button');
			}),
			this.addEntry(dt + 'floating action button', function()
			{
				var bg1 = new mxCell('', new mxGeometry(0, 0, 56, 56), fac);
				bg1.vertex = true;
				var part1 = new mxCell('', new mxGeometry(18, 18, 20, 20), s2 + 'recipes;strokeColor=none;fillColor=#737373;shadow=0;');
				part1.vertex = true;
				bg1.insert(part1);
			   	return sb.createVertexTemplateFromCells([bg1], 56, 56, 'Floating Action Button');
			}),
			this.addEntry(dt + 'floating action button', function()
			{
				var bg1 = new mxCell('', new mxGeometry(0, 0, 56, 56), fac);
				bg1.vertex = true;
				var part1 = new mxCell('', new mxGeometry(18, 18, 20, 20), s2 + 'sports;strokeColor=none;fillColor=#737373;shadow=0;');
				part1.vertex = true;
				bg1.insert(part1);
			   	return sb.createVertexTemplateFromCells([bg1], 56, 56, 'Floating Action Button');
			}),
			this.addEntry(dt + 'floating action button', function()
			{
				var bg1 = new mxCell('', new mxGeometry(0, 0, 56, 56), fac);
				bg1.vertex = true;
				var part1 = new mxCell('', new mxGeometry(18, 18, 20, 20), s2 + 'travel;strokeColor=none;fillColor=#737373;direction=south;shadow=0;');
				part1.vertex = true;
				bg1.insert(part1);
			   	return sb.createVertexTemplateFromCells([bg1], 56, 56, 'Floating Action Button');
			}),
			this.addEntry(dt + 'floating action button mini', function()
			{
				var bg1 = new mxCell('', new mxGeometry(0, 0, 40, 40), fac);
				bg1.vertex = true;
				var part1 = new mxCell('', new mxGeometry(12, 12, 16, 16), s2 + 'plus;strokeColor=#737373;strokeWidth=2;shadow=0;');
				part1.vertex = true;
				bg1.insert(part1);
			   	return sb.createVertexTemplateFromCells([bg1], 40, 40, 'Floating Action Button (Mini)');
			}),
			this.addDataEntry(dt + 'toolbar',  358, 64, 'Toolbar',
				'3ZXRboMgFIafhssaBLtut7Vbr5bsbtekHoUMxCDr7NsPhdpaa2bSZlmmMYHD+TmH7zcB0VQ1W8Mq/qozkIg+I5oara0fqSYFKRHBIkN0gwjB7kPkZWI17lZxxQyUdo6AeMGeyU/wER+o7UGGQM1Z1Q4N7NyW61xImWqpTbdK8+5x8doa/QHHlVKXTrMuDBOuk4toqAnGQjPZdxcKTW9BK7Dm4FK+RGa5z6DLRy/jIAoeZA+Jj7Haz4teeqLgBgHEdSj0ZygZqzm06didh1vlttrELYUASzVF62lUqExGO6bAsBGjc3oXVFfd2yvew6HJXHjkOrwgwBFZes3hGAjzM7okGcONA3ADklmxh0H9a8RDC29auM76+ouYDMovnoY76DyvwY4c6w8yy8TkzibuRQZ66j//Zfv+v3vLO7tXMCmhLf4n/FvNMBCPDTxCuNlAPDQwjm930E1Pt5ZPP7/UvgE='),
			this.addDataEntry(dt + 'floating action button', 50, 156, 'Floating action buttons',
				'3ZZPb4MgGMY/Dcc2iH/mrtO1pyW77UwmChkWg6zVbz8Uamu1m5m2h5KYwCMv8P54IAA3yqutxAV9EwnhwH0FbiSFUKaWVxHhHCDIEuDGACGoP4A2V/467V9YYEl2akoAMgF7zL+JUYxQqppboaS4aKo6kBWlrr2USoovEgkupNZ3YteIKeP8KAHkxk7sxl7TmeJEHLTo6EYmccL00i5i7SKIVKS6mkgr2Sy2ROREyVp3sQGhCTiwRFGjeCZzSAnLqOpruDTtrBvnxEhXLKZxZO7fyBJcUtJ0hzo5qnJu0z+izKus2fF1lid8/SmKegBVEwzaMiTb6Sbiw2aMpnJEv3KEa9+E1BftM7IOGpJ1AqNJwrFie9Kbfgy3XcG7YHph3fSroDf7KuwPINK0JGqwW10akzbQezDPW1Y+vNsR8Bc+AoVsTDAN8lz7e/PtH97O/s+3t39wK/tvNh4MnTvY39Jx4NDxfjDcm6M2x/FPCzu+Grvx07b839rBfGuP4FvK2v3baglr6+bppWS6nz+kfgA='),
			this.addDataEntry(dt + 'related actions', 200, 40, 'Related actions',
				'3VbRboMgFP0aHtsgWtu9zm19WrK3PZNxFTIsBlhr/34o1NbqMpO1zTaNyb2He4R77nkAxVlZrzWt+LNiIFH8iOJMK2V9VNYZSIkIFgzFD4gQ7D5Enr5YjdpVXFENGzuFQDxhS+UHeMQDxu5lAAynVRM6oqiMi+6N1eodMiWVdvhGbRowF1IeIETivH2aYk6Z2jkwckmhKRPuaGfccAjQFuovG2mh0MUaVAlW713JTjDLfUXie8UcRMFtH6PG50XHPKrigiDMuEjx9yIxajg05di1w20pQ8MH8cq6aGY8L0om50y9DVQ8lexMymX7dozX0DCZKhwZFy4Q8HzhKfuz/ETYKBkKG6Ue0yCpFVvobT+mdjjBixLuYN32s2Vv99mq/wOV5wbsYFhdG5Pml/x5kwfCCg9Gcy3PLy7seVNpoMwR3DRv6P3k595Pr+f9u+t7P/0v3o/S25l/eWnzj9p+XNfO8ZM0S3+1v1cX97dLj5cjX356d/oE'),
			this.addDataEntry(dt + 'floating action button', 50, 456, 'Floating action buttons',
				'5ZZNj4MgEIZ/DcdtEPp1ru32tMne9mzCKGSxGKCt/vtFQVtXu9tkN16UmDAvM8PwMAcQjfPyqJOCvykGEtEDorFWyvpZXsYgJSJYMET3iBDsfkReH6xGzSouEg0n+0wA8QGXRJ7BK14wtpJBYInhULtjRHfc5q7GfeSmhidF7ZKXWV3+IsuZXJwN6HrNavUJsZLKWfuTOjnHXSqkbCVE6BbXwydi6hqyulxMuOK/xYYyQVsoHx61kcI5j6BysLpyLiFg6wOuglnulaVngzmIjNu+lhhvZ12eG0U3CSDHodLZQa2ChSdjvJwr42g9HeTVXCF39CaAvJ4rZEqmg7z5HXIL0wWKwsCTCNPmmwBh1cIYQluth9Ba7S/Qtv/cmeWAqQO4aUa38hGORZ7Ftfmx4/Bi1eu5zr7DF43gazUNMrHiAr3tx5iGCt6VcIV127/0O7412wQqTQ3YwZV0xxi7JWfenofe/f71+AU=')
   		];
		  
		this.addPalette('gmdlButtons', 'GMDL / Buttons', expand || false, mxUtils.bind(this, function(content)
		{
			for (var i = 0; i < fns.length; i++)
			{
				content.appendChild(fns[i](content));
			}
		}));
	};

	Sidebar.prototype.addGMDLCardsPalette = function(expand)
	{
		var s = "dashed=0;shape=";
		var s2 = "dashed=0;shape=mxgraph.gmdl.";
		var anc = "shape=rect;fillColor=none;strokeColor=none;";
		var gn = 'mxgraph.gmdl';
		var dt = 'gmdl google media design library card ';
		var sb = this;
		
		var fns = [
			this.addDataEntry(dt + 'card', 342, 356, 'Card',
				'5VZdb5swFP01PDbiu91jPhtp2VY107pXDy7BmrGRcUqyX7/r4ISkQEsXtD0sURT7+Nr3+pzDFZY3zXb3kuTpJxEDs7y55U2lEKoaZbspMGa5No0tb2a5ro0/y110rDqHVTsnErjqs8GtNjwTtoUKqYBC7ZkBipTkeighwiMnCWVsKpiQh1UvOXwQL5QUP+G4wgUHDaYkFiXOHZyYVCAV7DrLPUCm1nsQGSi5x5CSxiqtIjzf1JgC3aRmmxeEFUiKCtic9ta3x4EhoJ0M791ktF76BUOTmf4iXqZUwTonkT6gRMn7cuL+GSfOhwE48RucfCR8Q9ChiH4jjIEuZU0SImmDLbyUZklfj0aEjRndcFz5IZQSmWZKcLWmv3Q0ko90IjmUb1aQ6Cs4YQ3h1K5nE3PA7CZAUEKBZzwZNno7rYPVvXlsRkFgG/7eItoPKkwCI4o+w0XKa8gPGuSvREQUxAiqUiuQiq0sNOliiyW6tki0GvuYH2ShXAemoDEdAFIDS6ycER4Xx/jPUJoI/HsiDHAFa7NHo1GXpG1e7lbv0XDVouiZBRy/VcwKWR75/gf63obv1NdkfRCUqzplYF/uEElSgGr44VRrL4uEVzXwY5tua2MDkDxIV75t3HC9HD/Ou5x5bijXzM+68WIxDjy/tuFXkRsnvmJpE/Gyj2U0jnX2CTFAhLyAPBZhSutt2PBVLm98v+HWO7ulGfmDmPWUblC33jW0nH9/WH35j9TcXSr3l8V9I/s1WuO0fm2tws/fan8D'),
			this.addDataEntry(dt + 'card collection', 358, 642, 'Card Collection',
				'7Zlbb5swFIB/DY+JbG4hj7n0Mq3dqrZa9zY5wQRUgyNDmmS/fjaYBGLISAJrVY0oUnywsX0+nwsnmjEJNzcMLf176mKiGVeaMWGUJtmvcDPBhGg6CFzNmGq6DvhX069r7sL0LlgihqOkyQA9G/CGyApnkkwQJ1siBS6KfSy6A80Yxz5aCjnDc/78sRcQMqGEsrSr4aWX6JYw+orzOxGN+JixnAqzBG9ql5uK5FpvMA1xwra8yzpwEz/rYVhONszHwcKXw2xTLhzFmWCxG7vfPf8hFVCtDENRBuRrGRngJJ0gEiwi0cxWd6gj07JGtlmnI49GSaHzdXqJzks0D6LFo9yxuRc90yUXQDn2Sa4R5O3gt2hCg7cZjnnrRWoSNiWin0dENzMZwwQlwRsuPf8SSuaZRzbcLISZ9RehS/oJXf6aIabi0afG0LEvOsJGtcLKA7bSOvtW1i6o07RVbcJTtSnnf6ABX9Zu8t5QL03fG5SfQD0vxolCY7eLRoAsBdAzQ2+YpIwYRuFJ5lRtJmVoNhhMnXHlES8YgdDK3wwss6aeMBdBOZgjMpL2HAauKxacd73DnoAz0As2T1JZp3ZlDS47CduyebZK3m7DNJcMe5iraY7jhvh3YaeR3q1qvR8xyFxXJYO0WzHI/DG5PTodUBm0QSXGiM19BUhR+0UqElTWObdH/UJEjT0orPKg7QDr5dlAl8ScNoiFiC2C6DHzosKZ3qcC3s05NXPjz3fpWnpU1cdmkttc2V1nFoZ9IUqJzoEdoBuqwY+HFB1AfmzAaMXVy2MFinhjhtHc5z6ubbJ7wZgmCQ1FPHMaetLxVHy4fO0HCX7igU5MvuZTHwmdh4FyJqc9jIrFUFxIYMWJsZseGee8I6MDs/50NE08IVDYfluFM8wk3gOOfBvJsTSimJ4X1CHTigMNgX1rT9VSoQzT6/xkv0a/e19rqd622ki7Sv8hVCi8iMPqY55jCrsaC7vSRC5iQKE2cTdeRS4SG/kSExS5ms6nARU3VGuUFKvsoR5Y/pqWnusyxEPq783JAq34UqOLdBKq1Ymn29HjVR2kom4rc/2RZShvzuA4Xdmj1opzHzfnaDA7eAtvCSdUUDpAJWm284rolNMbS+8CrFppufr5cPf9P9pu0f4Ttmp95iuKFohRyqU/ECFY7P8JeYgFrSc/Hz3JOYzhenUMaDmj3oUFe9gwLEDn1LjQOH6r5aFmp+CEehBIr9ZLnrU2W6lC02klsvbMLt4wYSulmhmavzYuCRS5nFkXgMcLA6Cf1x6P1QaqijktVVcHZf/aRXEVNqjm5Kz4yGAZ4w9F6PMDalC8OerS3pPO4LPh4c39n6lZ9+J/rX8A'),
			this.addDataEntry(dt + 'card collection', 358, 642, 'Card Collection',
				'3Vpdb6M4FP01eUyE+e5jk6adlaazo+ms5nFFwQloDEbGaZL99WuDnQAGhgToV6oq+MbG5hzfc69tZsYqPjwQLw0fcQDRzFjPjBXBmBZX8WEFEZrpWhTMjLuZrmvsf6bft/wK8l+11CMwoX0a6EWDFw/tYGEpDBk9ImEIvCyEvLo2M5ZZ6KXcTqDP7r/cRAitMMIkr2ps8g+vRgn+DeUvCU5Ym6XoChIKD63DzU1irA8Qx5CSI6uyjwIaFjUMyy2ahTDahqKZbYqBe1lh2J7anp+eXQgAmsEwFDAAG8utoV2EiYeibcKLxejqGK104FrLNow2OKGlyvf5h1dOPT9Ktj/EE5tn00+cMgMQbZ/EGDVZjv7jRWCwMoEZK/0SSIK+jOjXMaKbhY1A5NHoBVbuP4Ql88opGx+23M0W2zhAC4rTf589MmiqGs3AVBschRcurKJcgs20VdTApaiJ/r/jiA3r1Pn8Rq90P3eqd8CbTQapgvrpKXoRYSlEPPLnj3dZ5F/kMc2eUHWb9Q1Y282zuDTPOSB/8qHCYeb8XpzgyPfQrXDZOAoCPmBZ9SvccF4cveTWKLdN6jqWM2wSHKseOCrp9hjelxK4gQwmH2Y96bfvtTUfdT/crWbcO3xRYlXxRXsUX5S3ka7oTsCKMwYrGfSIHyqEMPT1O8u2lzVWBFFFZemP+kCKeosnaBLPcQiby4A/JWPuGIzFHtlGyY9CRbmYPuYGVs2tGJaYUhxz1TNV1zqR2+iHrN8A74XSqtpbWL5IEqZOKoCjjyKNLpiA0huF0n8SFMURZSSewqKWMDTrTDOkOIP7kNV9YqGHm/eM5o5gVg9dz4LiepwqB8dS1si5ss/F8wRxr08U3T9zKrP0SuquXUhp30QRaAohX6OMwoTZKOaTAe8I+9p4L5gw5Hl3DNSMZvwq4aR56HkX8+I+hAlkz19cEnGJGb8JPNVms4iXF5fwW800ypzIXL9sa8jszY5J8rpEWpcS2eybljWBbwKgzoW/nn6uvzHbt79/tTHWmiDW11ZVGjWFsbqfaR2sSQ/2GSGQDCTtWGlQDqBiZ6BK4UB5PVSCm4yf8q7jMnrt1sVVEVQsGswLwqruWK7dK6wOiZgy17fUFKk5glr2CMqq7pQ87VJI4nwL651Ht15ogx4JSlcwG4SuusNxjzOaRxwa8nDzHeKUoftewswgRGuq3zfIDAJY3bkYVTr0qkxIhF1VJJZ3/G/YhmkLrrLFjalKv9202u0ShpaFEqhP93GUfZQ9humU3XXA2r59LWU3gRq7J1R2dSfhi4f8I+ZJ8513zD6HuttvqO7qyn+NUMRl/QHvUMAf8GMJewuYbyHs6hL8Awt7C64fV9h1dUH+roT9dgls69VSdst2+gm7YbXz19czdHX9+3E9o5hHwz2jC9jXdYxr17IXHKBp+ef6TaHuydwzRzGFbeAW0dycYku+4fz/Ch959vzfTWcop3cj2ni58iCljRjRQlvIc9quw5SmsDHSSbRT6X2Sg+g+rwRIrljLKM3gu2Lo8xPUY8HdKWlvyY7z2ehhxfMLZkX18vtn/wM='),
			this.addDataEntry(dt + 'card collection varied layouts', 358, 642, 'Card collection with varied layouts',
				'7Vtdb5swFP01PKbCGEjyuLRL97BK1TZpj5MTnGCVxMiwNt2vnw12woeTEWIoTUdVKVxsMPfce3x841jwdrO7ZygOH2iAIwt+tuAtozTNP212tziKLMcmgQXvLMex+b/lzI9cBdlVO0YMb9MmHZy8wzOKfuPckhuS9DWShgAlIRbNbQvOkhDFws7wkt9/tiJRdEsjyrKmcJUdolnK6BNWV7Z0y/vM5KMwS/Hu6HAzkxzrPaYbnLJX3uSFBGmYt4DeJO8WYrIOZTfflQNHSW5Y7/se3p5/kA7QOwPWnAH4WD5B+yyfoIist+I0H13VR9CG8+n8mI9WdJsWGs+zQzSO0ZJs19/kG7sH0w8acwOQfb/LMdrqnPwRpwDyc4YTfvZTehI0RcRph4jj5jaGI5SSZ1y6/yUouS1DdrNbizS7WW+C6Cal8a8FYheFKtQ7ptzhVWbhjZefF9zm+nWvgXO9Jp//SAkf1v7ho6lTevxoXL4DXa0SnNa8vn+LRkB4NSDuSLKk3Gtn5Ys+DypJM/fAzBPA6MK4EOjCI/9KojxjRiIlBMJkiaJPMmc3JAjEmFXTr3glgBk7hbyOMlunueONL4uC13IKGkXdN5F+McMrzN20xEnDCNhPLY387un9fiIZla9KyegbSUZ1G5WLkw5QGZtAJcGILcMaIEXvF1GRQOWNVT46F0LUmD2Bjj3NADZSM36XiE1qiD0yPFqhhXgnfqOkBYAbxNZk+y3nVUGvD5mBN/NLhhlNU7pRJFjJtNmd+DuWlvy5AX0pEK+OaIuE7GpodiGfr2h2Px6vIGwUm1d4t07/ueWLioPOhQ2ERth5AjqIqqkJHjASRqfXAi216OQkr4MaSehnV2AEv5HXBYDANoFgyJlcs/Y4ndrF9YMmu6fZUVlXNKb76aV0rwHSFN0Dz+ue7wEwAeyC0ieenk/Xha1mKpd1i8uxtSsrIZVgZsFtW0cp66+QO7UxssUrbeFtqd2GDLg77QPveqlojp4pIym2xAoJAgEyoyjgjVJGYrNqDpYMcpFqVModBH9Fyr2E/B2/c4UmLC98sCXBBvxTaq+i5Kriz530Ie/2YQl9z69H5niqCU2VzUNUfMBIPayd5DvYVWGyNyUIjlTfjkpBLbLDloL1AlsLZIcnBfOI/dBa0EgRbZBa8HJw378YNFOMey9icNCI96MG67W8GU7SghJEhEVka7imp5+B/8vARjJwV4nHq5OFb1gJrC1N+lOF5xYI358qdK60QAg+fIVQjesaVeGQK0b9qEIF5kdRhUNGvBdVqNlO1tsM3F4A9ld/Gzf8us6/EPQuVVbrzWhn7H2ys6O9JjqNQ0MQ3IkREEZuJxOnkULZAi2fdAyq3ftSxKUlQzqn1832jVNdmmhIUrdrydAWwnGZI7vYQdhkM5nCivckcYIHhdD1A9SglHWS0t4SnfG1wcNPD78MyJsXfzjwFw=='),
			this.addDataEntry(dt + 'card collection', 358, 642, 'Card collection',
				'5Vptk6I4EP41ftSCAKIfR+dmb6tu9652rbraT1dRoqQGCAVx1Pv110mAAQMzKLA7emztaJp0XvrpTvqJGVnL8PgpwbH/hXkkGFm/jaxlwhhX38LjkgTBCBnUG1mPI4QM+D9CTw1vTfnWiHFCIt5GASmFFxzsiZIoQcpPQSbwcOoTUd0YWYvUx7GQJ2QD7S+2NAiWLGCJrGpt5SOq8YQ9k/xNxCLQWWRdkYSTY+NwpSgb6yfCQsKTE1Q5UI/7qoblzJSaT+jOz9SmdjZwnCrBrtB9nT18yQxQbwxLM4YJY3mwjItsggO6i0RRje7cRobhzqeLJhttWcRLlZ/kIyrHeEOj3bdsxvaraMViEJiZ7vdsjEZepv+KomlBOSEplP7OLGm2RQRdhwiylSwhAeb0hVTa74KSfaXLhsedCLPJLvSCCWfxP2ucdHJVq94wVYVTFoUTR5VLZrOnutXMS62W9f8XozCsovPxHFW6H7vVFth2mxKuWb2YRSsgHA2IJwJWF4PHHkkuCpr6YDiPnPl0NhPo1PlyyduR8X4kqbAZi7gQMNMNDh6ywA2p54kx51X/IFuBjotKwR1I2aAB5LjdXOFUjcNeoZ/2EYNxQrYEzLQhaWsPsJGEv5XdnXq7vxGRua0qETntJSLzZvKAnA2AitsHKgAKBJevIVI2fxMsSiOPStQRqNYLqVm3kPYD23jqDI/brA/cYBgcFqufGkqtEXKGAyiP2SEBmvcBUIiTHY2+qf1ObHtfpACqzSqCBeOchWJzsltn2PCGyEd17rFDtiuqffL33O5m7dY55C6GXNTLNjYzB8DVNN4H9m3Gs3gU/zqlkfM2sVUys1uz2rk9BdO8uktl5LFno5ua0VcJfgHue256sBqvyc/WWYCc5WfIruE8Z1ngXD7XB0EDVuUUwjF0eGyjnxgYAg39BOArOYDgB0ue4WNJ+aktMA2J8zkwYn7nwBjyuVVgzg8f+kFGP454xCdFr+KYwOS9CZRWPoG/nIQxSbmEicpmEryTZOxAwQLI2EceDWlE5S6FjO1eDANsa6z3QovLVg40EluH6ILvk0jW5Kx4nbI998cEp1x0/FnoHWDKMG/RIn5h+wSvA1Fz4+NoJ77gyCvUVzh6FsRQyneYRpMmxzr4lBPhREJ8gC00l32vyjI/E44yPQt+u8Y/OSspFdusoZFCc1BHtHJvKTvibNaLI5rGIGuEfuTysFx9/vMryMyOi0PdQdXZ2mAvncfFQ4l8b8DaJKngXzSTjaMrXqeKQgm9eU2OY/cD3tgZZBnRj2kK8PRs5zLwZkOBNwhydet/R+SOVacYFsheDl3aspBsKbwFClLwThvpzLOelOSm+5CkpMUxzuCkRDnb/4mV6IcwECSQanHKorbL5C9kJk2A3TI10Y9dnvaR6OU1Y10QvPE77mI/g5/8YngGIShIPz0BMiLT+4P6SKE58QHmFzSBbTOuAJiEOY4RY1GZKKRCY002WKqGTDbkUaA10YarKRR8ZH+XFKKFr9weh0D6qc/dcIgmwO6HROQpyN2RiMuhu3EWUXPJRcOvK4u4Jc6Q56jvUYa+8qQhGMPVV2IuunzRLQF6Gwc9zupB6GmNtAfZ4fSDlisia403z3VxUkRQEy5X/vaufKeR6BkTVP0BvPb397prEz1dZHKra+IQ95ja3GbJsQJNGqfkQyF0/wBdfiLycdBx7w0eKL7eT1bVy9eX/wM='),
			this.addDataEntry(dt + 'card collection', 358, 642, 'Card collection',
				'7Vtbj5s4GP01eczINrfkcZJJulq1VdVWu+rTyiFOggKYBdLJ7K9fm9sANgkDdmZaTaLRBGPAfOe7HB/MxFgG5w8xjg6f6Jb4E2M1MZYxpWn+Kzgvie9PEPC2E+NhghBgfxO07tgLs70gwjEJ0z4HoPyAn9g/kbwlb0jSJ79o2OLkQHh3MDEWyQFHvD0mLjv/Yuf5/pL6NM66Gqsl//JuaUyPpNwT0pAdsyguReKUnDuHmzUVY/1AaEDS+Il1efS26SHvYViz/LAD8faH4jDbLAaOk7xhXx37fPfsR2EAuTEMwRiQjeXeAC+yCfa9fcg389G1bbQw+bfLRjsaprXO6+zDO0fY9cL91+KOzeem7zRiDbA49lsxRlBue//xTWiw7ZgkbOvvwpKwLyJoGCLIzNti4uPU+0ka5x+DkjnQZYPznofZ3T7Y+ncpjf7Z4HiUqxpywzQPeCqi8M7Kt2tmM23RavClViuu/4V6bFjVxadz1Lj81Gmege52CUkFq1d30QsISwDiM01JIqDBbJh2+nstOIom0U1rjoyAGCT5px0RU97CEfRc7N8XMRl42y0fVtn1I9lxwzuoFrd+1qY1NixnHMpPzRBTiqqtIryimOwIM5PL3KEH8nUQe9ndktv9QrCVtmoEm60k2MrTlLE204CKowKVhODYPQiA1K0vice8cxmPaCREvbMjlGVHNYBNy4quE7GZgNgS8w7sFgzIIfqThKHHomQAkAGO9174NecbnHZ8yhoKYvDckGfCZluR8kwxBAFYLB86mQkbyJY+1jKyjKa0cmg7/aZ8PI10bgq5GIncxqyqwh+lM0CdfAY6c1llBkqS9gxqcLb59fRQOpLv1aK6gf79amnWgQbDbTy7mJ+hJNgd0eJopMHPjUAsY93SUTQhEAD4hPkd87Kz5P8BdLqIUVcw9SQvWcDoQUUWB4rCYGpqwQGqqJMp8Ul0kNKUXfYZNW3oQEFaGEVMyqAYNdXqKotGM1QMWwdEouTwnbLtTcxcms22axWy9nPKerg4iHgfBPaMyLR2+jhMSRy2WpOAxnxG0mhkURdjfkV2zJGk7d0pfSR8wDuGLEPuFLX2P+I44Kem7rF96M6LE25QzG4WgaOXaqzt3XXcWFtwYd20jkNDnpaadfy5oGis4xWlRGXGvVrZ5yNppc7KDkVR6scpxDXHY8jkXgxo3f0TzHwOAba9LvPDjf3QBs7DbPEG+eRt/dBCPd3Qnr1hN+yhul1jmNbcMWdQEcOEHerb70sxRbmNBeDhNhyTTby14fLrkUwlEhkzOgm3mQStnmN2odCTZEKZnq8mVKYGapFMLRCJetk7yVRa3Nfr1cK4bXGXkMwsLzWKu62vkDuzmyYvPXVclCU/xNQlsSd5cKNXiKw/y2w5l2lZ9/YgJXKTfRTNYMDrKJHnijn28zdkvOX5iwJpUi1xfLk2qa8amjcgjkjUJrEf0JBXj8Dzj0O4y4G4xw09y8B6Zi91sLpqQK/nTT7eEP8LTbzUo/WVFWVQf2ztr0jslSTQRXZliydG+dYVagVHTvzOTaALbyrnnWqdSRRYXerS8JRmpCUd9Djr3Z1+AXea6RCDy2JQd6eTewo2av2oTRz6uhB/LDabzy3j3Y+U+REst9U6kiiT7mNCQn6dKPIHkdv3tPQruJMeziTKnUscRJuslxaFDYHbEtg3rbBJlhYOiF+fujiPFR0K27jHuKWe3phTICUBUj22rRQ2SwdEogi69AnmCXdLkiGTir5awgXdQMETp/bDpFZyvaYQTJF0ZirRDHp5WU+FoJKoDLunZmCP9DWdkoGaxY4K3GnxwL+93On1IC9XkV9Xid6wLClZLfmZPLIGcj54m5zxsEvyYTzgsKne/3viL8ss1pRyRSPlMv9Hym6v2lPrbt8h6w6aU/bfnvIcXO1xeEEEf/GHMq7Hhftv6d2NvE4gl+u1A8z2atx6ey/S2cpcdaoH5Jmsn386l+kH6umPEJjdrtf3XZCXLHxkR3pRIgqM8vXoq9V6bQqao4IIvsYMLMm6Z2ukwFsyA6eZPKYQ6Vj5bIiC44BIivyT+O4AA8axnRVcS2dQA6CaX8SqBVZPHgcVOLYxdCFj8RJaHxcH2Uf544tOz5a+CmOqWfQyNbV4sihPDfDkDXaPFzWELlwGvnlhdLxDWVEI1OYQEtJ4wa9HZ6FmEtLxapohykEvrguvidDvD9AL1pNJU9prouP8bvCwzedXzvPu9TfS/wc='),
		
			this.addEntry(dt + 'card', function()
			{
				var bg1 = new mxCell('', new mxGeometry(0, 0, 344, 254), 'shape=rect;fillColor=#BDBDBD;strokeColor=#BDBDBD;shadow=1;');
				bg1.vertex = true;
				var part1 = new mxCell('Greyhound divisively hello couldly wonderfully marginally far upon excluding.', 
						new mxGeometry(0, 172, 344, 82), 'shape=rect;strokeColor=none;fillColor=#ffffff;;whiteSpace=wrap;align=left;spacingLeft=16;fontColor=#666666;fontSize=14;');
				part1.vertex = true;
				bg1.insert(part1);
			   	return sb.createVertexTemplateFromCells([bg1], 300, 230, 'Card');
			}),
			
			this.addDataEntry(dt + 'card', 342, 378, 'Card',
				'3Zhtb5swEIB/DR9Tgc1bPzYkrSbtTWulfXaDAWsORsYkYb9+h3GaEohCG9JpIy9wZ59tnjt8NhaO1rsHSYrsi4gpt/DSwpEUQrVX611EObeQzWILLyyEbPhZ6P5EqaNL7YJImqsxBqg12BBe0VbTKkpVc6MoM1I0l5KuoMl5wjiPBBdSl+L5ovmAvlRS/KKvSqg+mpKMxGILSgcE0x+Viu5OjlmrzIAfqFhTJWuosmWxytoa2DUDzShLM2OGg7BVkrJVpC+2BwRwYSgME8FvJnL6zo9YJfoAvaQl+01/mtsZjQW9D0vQhoAtKSeKbWin/UtQueNRgSErStqjlYt8ANStPsZiwWexuHafivtWKqaH74JBx8jej8drLequuG9AJElJVQ/qyzBHcfZ6nJ+YAsLHsAGSmg4awl6fGpqGmv8B1PwetcfqOaMkPsUtEbm6YhB+IE98DZ5Bj+eDpHUmqhyI2jHbsBJugNf6DjkXcF6JisdasxV5TGVScS2tiUxZTlohIRL+q0LkcKK7Fa9ilqc308+68N1mTNHHgqyahraQdUFHOEtzEDlNdLtQCv1/1tLC8fuB4esD9E1IsBXhd6YFJYpDA0+NsHBsY/8IE34j40ONHyYMdB+XJADjdeSZYDqXEBw0QZ4MPyBPvstjbt9jL4uUaRNv3TE4R90NL3vUTW8z98h5kzzctxd6cziP36MgitBYyuEbKe/XH5351L1GVp/hazB37PPQY1JmtKlvtwtp7YH1Lm02DDfpOuY3kNHkWH/MPbwMvbH+uB32x66zTq47S8FX3nHCgYnHv3zecZzrhKo/ny+W/2Co+l1HXClUR+wTz4eqpAVk/LFbAG8Zjt8wntgx/u1Y7W8m76KnT9++Thqxx8uTO3Tvof2yw3ThDCxDLon0rsHJuA8GNl7YnyTuZ46HupG/T7rTRn5/kzuhC3GwiHDfhWHkeF70/7sw8Kb3IIiH12dt9ddv1/4A'),
			this.addDataEntry(dt + 'card', 344, 420, 'Card',
				'7Znvj5sgGMf/Gl9uQdRqX27edluyX0kv2WvufKxkVAxy13Z//ShibYfm7K69VDLaJvDgg/D9WB4BL0hXm1tBquIrz4B5wQcvSAXnssmtNikw5mFEMy+48TBG6ufhjwO1vq5FFRFQyjEOuHF4IuwRGktjqOWWGUNdkGqXFfCgmnyfU8ZSzrjQtUGuk7LXUvBfcFADOu1qCpLxtTL6qmDuB0LCZrDP2mQ6fAt8BVJs1SVrmsmiuSIIw8atALosjFtoBotI3RiWe99OApUxKvQrEoxXRDnSqgZr8CUvwVZqrtNYCfCzEoSoRwFjE8CIpE9w1HyfKuYOPzhVN8ao7U/UeGyPi20DPM9rkJao+26O0jm0dL6jUin8t9hKJHk+0XAQ2arh86g2ewXVIku1xeN9ASQb0i3npbzgQ/iKegaX0HN28vw35q8+00nZBdT0N/w0evl7y6dWrdFT4gAK44DeIt83Yzmgk/g2nNb2r3AMjRhdgEbsCg0cJfHkaSSu0IhQlEyextwVGnHUjmXCNHzkCo4ucGz3sxdq386mTMh3hVAXTBwjdPri80oJdQHGMUInLIavm1AXdBwjZC+jJ0qoJw6FKJz+e5tvL9knSqgnDrlByJlNgJ445AYhZzYGeuKQG4TszYJ36d3n799O43R4bDB00KC+64JKWFTkYdfQWpBK2Qijy1IVGeS6XVVLy+UXXbpRYdLaCo31x9gXpoN+W1b0Wz/76XjJo7A9cnj2SCM5C/M389kloNt7Ev+hXxH0tp2XQFfF7jSyufzwsPIP'),
			this.addDataEntry(dt + 'card', 344, 162, 'Card',
				'5ZfbjpswEIafhstKYAeSXCbOQZV220obqdduGIJVByPjZEOfvgYMIWtQQbtIVUsUYY9n8Mz3Y1s4mJxve0nT+FmEwB28dTCRQqiqdb4R4NxBLgsdvHEQcvXfQbueUa8cdVMqIVFDAlAVcKX8ApWlMmQq58aQxTQtmhKO+pHriHFOBBeyHMVReWl7pqT4Ca0RKK9iJKaheNVGT3fMfCAV3HpzLk0m4T2IMyiZa5dXFqq48sCzWRUWAzvFdVhgsqdZZTg1sXcEumEodBPBo4n0V97HSkLGfsF3U85gLKgbS/4Q8CdIs0Vlk8CpYld4CO4CZyb8JpjOo5ntU/2cOkREUQbKIt3kOQj+zIK/OiomkmIeCVTf8Mj3c4fnG4ItlRKRlAKJRLWct8RbLgNtFyk9MlWUil3j9qIVK8Rq+iYD7z3SmYBGlJZ4Oo9pXnDfYnxgSpfylqsuRz3WjlwbWVBeBd8CWXI6iLSmVCBhR8pXnJ0SbTyzMORwd32CSNW+H7siWhgbtA9rwB25BoayDSy2L5cfMdBwAF0PDaX7d8NFY+F2bzC1Rh+6v8wtffYS8lhcEq2QG7Iry3TGPC9L4lwMkQ3bsmFS/P5L2QJ/AtkW9rFADp+/fhl3Mtd7fs8B8UbDBfF8n1ibvb1kJzm6566tEA7ep9DtYf9vznE0gWDLKQUL1uvNtmOvXKGdj/5BwRYTKKa794+Myr39DfIb'),
			this.addDataEntry(dt + 'card', 344, 162, 'Card with UI controls',
				'7ZhNb6MwEIZ/DcdWgAlpji3d9tJIq7ZSz24YwFoTI+O2yf76HWNDiIAtKB9aaQOKZMYeGD/veExwSJRvHiUtsqWIgTvkh0MiKYQyrXwTAeeO77LYIfeO77v4c/yHgV6v6nULKmGtxjj4xuGT8g8wFmMo1ZZbQ5nRQjclrPCWdwnjPBJcyKqXJNWB9lJJ8QtaPVAduiejsfhCo4cX9nkgFWwGY65MNuBHEDkoucUhXyxWmRlBgsC4ZcDSrHYLbfS0NIa08d0hwIal0E+ETCYyPPMhVhJK9hve7HRGY/H7sWz3HL6DFNwYmwROFfuEPec+cPaBPwXDOJqnXdX3qV1EkpSgOqSbOEfBDw5Nx7t7ff5VlENQW4cGYgv2IjxRQs46TJ6pArSojJX63vz9I+9gwslVeMRavWCuoREz21y3oITVoXEVdMXW6asodEK6aNGA2IryW87SNRpzFsccdkOfINGz9MKj53MLagN6L4PdiRk8lnTYIb2kKzQsMcdAjkDs+WMR/9uE/amE+2tEXX6OWiLmHZGedIS++yAFLgP3BeHBGK16lgOJ9PlfahXOTqDVzfflPKZlBrGlXNf2fJPqN6LrNI/5damo7CvozcIa2mVPsqd6PRJ4B26pdXTWo95hCTmBJIuLJBMkCWZnkMRzL5pM0GS+OIcm3kWTSaWLnEOUEf9WL6LsRAnmxxcFL3dfJ8zw9seLPw=='),
			this.addDataEntry(dt + 'card ui controls user interface', 342, 522, 'Card with segmented buttons',
				'7Zldb9sgFIZ/TbTtIhHYztdl89FqUitV7bRdU5skqMREmDTJfv0ONnaSgpt0Mb2oaieSfQCD34eDOdAKx8vtjSSrxZ1IKG+F01Y4lkKo4mq5HVPOWwFiSSuctIIAwb8VXNek4jwVrYikqTqnQFAUeCF8TQtLYcjUjhtDtiArfSlpDI8czRjnY8GFzFPD0USfYM+UFM/0IIXmh05ZkERswIjhxtRHpaLb2jbnJtPgGyqWVMkdZNmwRC2KHGFkGrqgbL4wxbpl60lWGOZV2b0EcGFUcCsSXqrILD/eVGQmUnVg7+WHsT+yv/rZGJX3pl4tnqQZpP4xMpwtZ+CWc3dU4JS4YTAojJJyotgLPSrtUtzUeC8YNKSqrl09qCwjZrOMKotR1dKzsEUWthHJGGexsPCBVMqGgPLjGELQewVBp2uxWUz4FWfzFGxPQimx1LxXJGbpfGTuJ8HedktnqoT6nxDDkz4R9JDDJ9A7qZ3rJ11LcKhrpiy1E5ItaGK0Kz1nuZ3rIa8zXya8w0UMTROp5TKpSKntX+OBPm2Aw/wAOydPlN+LjBUPnchCjQrc7av0JUsS3doRMUR5TssCXeVzQL0E4XGBA6DYwRN3L/NCU1m7b1x8V7Lz4JO900Pp6d6RKSLP7BnXV+NRFDbnUDh06B82on+J1sjfwx7k73/JXyd/qY1P+Qdf8tfJH0X+5R9+yV8nf6m3T/nLAe5Lf1v//uAD9MeW/lEHRj30vYt/WCTcU+JqRlU7E2pI665johO8d+Ja96E9/tJ2fQQf2BVGR+UPteH/U8HskqRw9UChV68lSe258onIpBbDYdzY/eCowxksXgrPwBoiH7DsCH8sadHMQ04Jg9EpgwuolUoYp/Rrw1sDMZCfqLWkuVhAs6Xft0eWq1xWpO+leFpnKi+T6nyc5XcsNemx+AsvPtY5IR+L9WOpUkCtMec87BWh3St0bLtZMEUfwa4zbWDc3Wd7MDTzfB57j8P1e830Hoy9DKz2SoNFrPyWcZZ/qeoXgprV9X0LOrgZldu4G/mQ2V5f+CVS3fpv2ifJC2EQ5zPO1M7LMBp9xDD6PmBRU8AiL8AaifZjLuJnl8tUw93bq60lmcAXmcDjVKV3NFNpD71gslcFYMZwFaL7uw/68LgWtsuVtxi4UNm4n5kCqIPxceDvWnNzAG7M85AXpPZKQ78O6euti0uGSDfac2K1SX563+CosEdoGH1C7vYSB7jlFfocrnyKaR/hwedjGtjLJg/Tx+nD7+mZSINpf3AdeEZ6CcB6Wq7tjqihTceogbAfbvcb80X2w337fw=='),
			this.addDataEntry(dt + 'card slider', 342, 570, 'Card with slider',
				'7Vpdb5swFP01PLbyB5DksU2WvjRatHXa48TACdYMzoCsyX79DBiaYGelwV7UrlRV4PoDc871se8FB0+T3V0WbOIFjwhz8AcHTzPOi/os2U0JYw4CNHLwzEEIiH8HzU+UwqoUbIKMpEWfBqhu8CtgW1JbakNe7Jk05HGwKU8zEooub1eUsSlnPKtK8ao6hD0vMv6DHJSQ6ihL4iDij8IIxYW8H8kKsjs55sokB3xHeEKKbC+qPNKoiOsa2JUDjQldx7KZN6ofFgR5bVi3bZ8gECcSBT0iWEHkc5AKwzwL0pDmIVcAEk9SAcPT4uDxQXVI+2f6u6yMvOZati7LSyxoGLAbRtepsH3nRcGTErdNENJ0fSuvZ+jJdk9W5TPDsn1GctH7V4lNb4zReRg3EGeEBQX9RY76H4K7q+C+4AJ30Q5AMdAbLG4MlovasuB5wcrh5ts03Q9gBLo9GEloFDHSn5FAtmOVzSJBAKgEuS8lSN5iyam4MwL7Y56bFny1ykmhENoOrBfHnsKx7/ckb+SVf8fkTUAP8gq+OZs5WeOh7GJ2Bb2B1EloIZTYHlAJdVS2xiHzylcVfoqcWzAfALzbR8cGzho72INrOMEK+iMN+C8Wus482p3g0MhEGj2/bEdBHpNIctOs4cluXW41rtdJxK6TSkS/1RI6DN3jBi3W4uk9BeyxPbCvIEAW0B4raEOQbOIzIH+kadTulZoVAel2T0fT7pnp+LJFrDPPWPCdsCXPaUF5ac5qVjozFANT80/rE0infp4Rn2i67oqvUQ+ZKB4iRMY7f06GjG+jvdZT/l9/GFvxB8+GPzROdmZclfKUKKIgjWZ3ky0NHvLVdVEbAfgDtdos0NDESpiLeUH66XJYHb0DWfD39dLv+KLKANTMBGRgWwh7RP7PAxcHaS0inayAXx2nXNgEdOAa+153u6HBTwMfNhMhXTV0mXVoNf8gdA/cLBR29Nv1FvnD9aBPnKSsB6GggmSG6OpsDbHKlGfL0dXEQikarx7RMboYomoYX14uXzmg0PUuhqgapHtvAFEE/IshqkbI47eAqD+5GKJqFPywJXkU9E2/aiHFAyKVTg7Jt7U5hgrG2vgEmdpWTKxEJGqIKsLGKhPoIJ81fIkaYUuZ/3NbvocSGOJJdRya/HX9O/fQcTfCVPfU1DgR94jx0U2u2TzO57OxNzu1ebTtVafi36b9fae8m+Y8DJDjImEG/FCbXdN4pQWnbBNr8HhxtOSlSI2bv5IofZcZCzLjYhsEqvH4CJuRGfAuM/+hzNjxUjX58RBvs3eVMa4yE98GfWqOxHcvspd58Uu2dw0yo0HoH2qQHR9W01InlzBGNa8DDr+w+kdKoX0dAA0phWdF6NVU1fzL/b2wfPqw/PjpoafaS8X4+0s2+CrUXsuhO/DVWsNh088QDsXl0+ePdfXDryP/AA=='),
			this.addDataEntry(dt + 'card', 342, 236, 'Card',
				'5VbJbtswEP0aHgtQpOKkx1h2cslSpIecaXNkMaFEh2Jsq1/f4RIvVYMKtQMECAHJnDcLh++Zkggv6s21Fcvq1kjQhE8JL6wxLs7qTQFaE0aVJHxCGKN4EXb1jjcLXroUFho3JIHFhJXQrxCRCLSu0wloK7H0UwtzLDkuldaF0cYGLy/DQLx11jzDngfC8J5KSLNGMEMjrQfWwebdngOUGr4GU4OzHYaslXRVjOB5arQCtahSGuOjCIo2Aott7o4CnCQW/s4I7zHyaKxExJR4cxXgfSK6Hk24n0CPadweCd/DSPhP9csHZ/zNTtkUbc+Imgt9qdWiQWxmnDO1Z28p5qpZjJM9YTvsBkq/82yEkIUWqz8mhgYzzf6P6Tz+q6gFLZxawUH9Y9jPe+zPgBSMjM8bWMWJiT/a72GYCHkYhyL4bX81EdISP4zy1NEulckPM0xZtuB6om0bG6TjWU9HIZ/wAeLb/NInh59GtAv6AaKNeqKtY0ANokHW/HqNfxQ+q0Zq7A4TeEYDY6OXV//OGgt0zwAPq4kHlLa1Qqm2/iOO7CD1ayWlhs+q/omObMY/Qv7znvw308uHO4Ru7x+mxwiX/yFc9umE6w4S/injxUlk/PZW5xgZ0dx9Lsbw/a/J3w=='),
			this.addDataEntry(dt + 'card', 342, 530, 'Card',
				'5ZdZb+IwEIB/Sx8QT0U5gG0fC912K+0lFanaR5dMEgsnjhyHQH/9ztgORxMWtIV92VSUeMZzeD5f9MJptnpUrEi/yQhEL/zcC6dKSm3fstUUhOgFHo964X0vCDz89IKHA1rfaL2CKcj1KQaBNVgyUYGVWEGp18IJypQV9Kpgji4nMRdiKoVURhtO7ukP5aVWcgE7GjAPaVIWyRqFPjZcPFAaVgdzNiKX8CPIDLRaY5eaRzq1PcKhSzQFnqTObBTawXqstIJkY7stAb64KnRXJGxVZMY11iLwEgmliaigVaSIlSmQB88O+A8Vi83TqlgucypWLHP9zN/IHFNxbReHfFPl+JyJO8GTHGVaFuSqYHOeJxOptcyaLKzsK8RUHn+8Fc3IxkoUlBjsxRWWADHnWBi703gF3bzWewbH6IXhjRUqEEzzJexZdyF1EX9Kjolswl1vHDU2Mo5L0K1JsMn0pHkxbM2L5+pVu6nROSewYtoR3MF/a5590v4ppDMeRQJOh91GexLL8O/WnttnPgpv7F0A3aiF7m46e/rxHWX+se2ue5EeWNHvUA/N8w6t34H+TGBuRm0uw/Nw8b1LgBkfBnP0HPrfwaz2XV+U06fjt4TOAzBbJXSzGSRZJAZVsaHWbEpB171hs0F+pPj7Bjsomn1qF4V/HhTXDdKGhT+6AIubFounfkZB8KNTPAMG+DKpMAy68gRf0PmUyZISLaTgeKZwlpdWnZKyUDLjJcKjfnSOoR+WN9q5rASp8HKKpVHk/ZesqKgy75PTlC2NDc/oK0aMODEEQIG52CilFBEHZRu51IYIAsGkzdC0CfRqM2ALY+etZdU32ldSRtKNbJYCpVaDVSZy6wyzJtcR01QL3ArgCr+/wNoGXpusWRS5YtGOgW85tXVNft5ASbrhabn1ZoZTU8+aicWVHX1f2fugzdR0j+hfyslcsCqPCOcDNp76S9tXNz1jnjcp1GzdSKGc45oZHLpE1CnX8IyHPIlrXFTvNqvh9g7Qedm7Hv7zG4F/Oz7P0dM4/8gywub2R5Xtvvub6zc='),
			this.addDataEntry(dt + 'card', 342, 386, 'Card',
				'7Zddb5swFIZ/DZebAKdJe9nSLZq0LymVdu3hA1hzMDImhP36HYxJQgGFJHQX0xwl4Nffz3mxg0OC7X6taJZ8kQyEQz44JFBS6uZuuw9ACMd3OXPIs+P7Ln4d/+NIqWdK3YwqSPWUBn7TYEdFAY3SCLmuhBXyhGb1rYIQu3yKuBCBFFKZUvL0XH9Qz7WSv+CkBEyqSxLKZImihxk7HigN+9E5G8lOeA1yC1pVWKXkTCdNDbKwE02Ax4ltRu6XjUjzRogPbY8I8MZSGCZCzhNhNE+gru42qzvF08WQyhT6zCKTUFeQ89/wwy5rMh7/OjwrqykQVPMddPq/BdliuomwIc9ymAjqYK6ZsCzcPpVWm0zFjvBdchzYd9v5WOtV3WzbgYyiHHQP6mGakzjf9Ti/cI2EX8NGSMaKGQ15Gn+GqF6q576l4QbR+vOgvfsLaJc9tJviZwKUXQA3kqk+Me+DSf8IdPIW0Fc96GsFVSKLFLG7jO94jgsQlVmhEBKvoRTMCKVMGaioECa3pSrmKW0yEVX4W2QyxQvsQ1EwjNT7i7bxMuEaNhjjWivxeEaNCh6nmBUm5q8cMGCAhUnHmnXwl7baBh1R58mgP8bOi8E9s7YRD6l4tNPTMrvRYlWnwbljxWu3+2sdZ4d7d+hoVpPd90z2GLx8+vYVNW/0mLrmMB+Lvgm3HWLyw7+6MDKrgZ2A3BiXfQdgG6V2z5k1SA/jQTr7h/R/kOogLeePEmaPLyJN9dP3lD8='),
			this.addDataEntry(dt + 'card', 342, 356, 'Card',
				'7ZZdb4IwFIZ/DZdLgKrMy4mbWbKvRJNdd+MgzSolpSrs16/QoiASYOqSLasxad/2tOV5T5sayF0lM46j4JF5QA10ayCXMyZUbZW4QKlhm8Qz0NSwbVP+DfuuodfKe80IcwhFlwBbBWwwXYNSlBCLlGohDnCUVTm8yyknPqHUZZTxvBdNptlP6rHg7ANKPZCXrCfAHttK0ZINvR5wAUnjnnNJb3gGbAWCp3LIlngiUCPQQG80ALIMdBgajpSIYyUsd7F7BLKiKRwngtqJeDgOIBtuqq8r46liCFkIdWZ+XqTOISaf8Ko/qzMe+3t4HK1xoFiQDVTmPwXZoHsSyUASxdAR1C65zoRlYNapFFpnKnqFF0bkwrZZ7EenXlptFhMw349B1KDuttmJ87DGeUGEJHwIW0LKUzHC7yRcPoCffaplXjLhjqK1z4N2+ANoRzW08/VbANjrAddnoSgl7zgvfwQ6ugR059detWkloO3iHfe9eA8s0atdFfOc1YTrmgk37uL++UlqVuM1XrwFZMbPJdaMKOrryMFxGeSlmFQv2dknp6dPzpGTg060KakALUxzLnFyxs2mtT/g/k1rNa24WE8xTTb373g1vPzM/wI='),
			this.addDataEntry(dt + 'card', 342, 334, 'Card',
				'7ZZdb5swFIZ/DZepABPSXTa0jSrtS2qkXXvhANYMRsZJk/36+QvygVlQWHs1R5HgtY998j4+jj2UlPsVx3XxhaVAPfTkoYQzJsxTuU+AUi/0SeqhRy8Mffn1wueB3kD3+jXmUIkxAaEJ2GG6BaMYoREHaoWmwLV65LCRUy4zQmnCKOO6Fy0f1UfqjeDsF5z0gG6qp8Ape5NiIF/sesAF7Adz1pJNeAWsBMEPcsgbSUVhRqDIJloAyQsbhlBkRNwYIe9ijxbIB+uC2xHUc2RNhPQi9HMGjV6RQ8+kFDcFqBl884P/4limW8+xilXKrIxV4pX8VuEyFftu11FzK+fIBtMHSvJKaoLVaqoab0iVL5kQrGyzMNpnyJQ9QXyU1irGKBwaudgPa6wChO3EVMc5BowiGLoJHs4CrvEMWpEDxYLs4CzaBdmu+J0RmUi33KybqI1hWdaA6G2LLtNROyXq7ZTX7U9hN4tzl0jHhGV6siE+6XbOPhjDviRpSmE8/htZotuq0Z48U+HN798B3byH7iFZv3z7KrXg2gHoLtuBGr9AHel2gTZwoJ8CZrDIFr7jzJxYYjY7C6ktuMh/B2jxMLSr/1r/obmgxR9AbXH9huH88yz3uboV3eVlSu+2dcewPb6Q684R6zYRxXnAIJgg7oO5/ydcZuiinNrzagoY+Xq8Vprhp7fOPw=='),
			this.addDataEntry(dt + 'card', 300, 266, 'Card',
				'7VbJbtswEP2WHASfUmhxnOYYO80CdANioOiRMUcWYUojUJQV5es7Q9LxjhpNcisBW+LsfE8zUpRNyuc7I+riG0rQUfYlyiYG0fq78nkCWkdprGSU3URpGtMvSm+PaBOnjWthoLKnOKTeYSl0C14yVVYDieYIDV0KMOBtGtvrYNMUouZbAzPKMs6V1hPUaJw2y90ieWMNLmBDA26xphASOxIm7I6V3TCK3QryR/XCidJstQ9FsH4JxqqZ0NdazSuSWaw5dC1mqpqP0Vosg2WQfYWcQUlGa9GUfW5SNhIhjHZW4wAM5YDno+A6UUD2DrAEa3oy6ZS0hbeg43i3AtS8CG7paOSFovGC+avvmiu6CXQdpi7bo+6xfbKBvYO00UnsPt5Xbm3jnaQn4F0qKTWcDrmBhqL/Ctgkp2Kc/iPGQWZAC6uWsBX/EO4hxU9UlDmNe29xcbXtgXnegN3j6bWwk6gb7lH3MCg5Cf1sQbB9optxS2koVKzVgiktseG6atSKaFCiary6YGVtsFQNSGfH1FMcUa20M2w1q2jAEBKGo//GlkHEasBBC7F0PqrkS06PBj04GqCmWnyWBrVUYPymQusYIAKoaHc06xI9+QrEwvnFPbYDp31ipcRwsmkBXFoHXjnHdTCqmkNLYRkLGixwRtd76H3i3lUtpAxgYcWBRcV723GcFzDIc8viOpo7TseWndCLM3/6gfFTzlfqzCX/FYrdtWgryXTe0uZhsPS2dmWZq2pVQif6lRSaGc/FI23XFcrCI7UFizua+Dstl6275uCQOh8e7CEvuV89+R/dVsnw87v01WX8AX11sddX15Ppw4/vJEv+9hLbfllV/GQdf7PtjNChWzsj861M9FsOG7xcHqBl+MZpF6oL3IbU5yuu35Wk0XGS0v8knULS6P1Zou36o9Obb36T/gE='),
			this.addDataEntry(dt + 'card', 342, 246, 'Card',
				'zVVNj4IwEP01PWqgRVyvoutpk73tubsMlFgsKV2F/fVb2vqBQiQRE0tIypu+zvAeQxGJ8mojacE+RAwckTUikRRC2VleRcA5wl4WI7JCGHv6Rvi9J+qbqFdQCTs1hIAtYU/5L1jEAqWquQNKRotmKuFHb7lMMs4jwYU0UbJcNZfGSyXFFi4iYEYTYTQWBw36+sHlA6mg6q3ZQK7gDYgclKz1kkMWK2ZXkMAVyiBLmaPhILQgLS2QnrhnCfTEqdCtCHlUkcSMG0V2YteIIaHM/uDLvclgRXC3InWLcE+fWWAxCZyqbA8tcpdmLuGnyHQdp2yT4z5HikiSEtSNyKc6B+ke3Nc9piWDZrlnvypjQl6lTfdM0zzmUwZUqj7pr3wKzRhqAOk2oE3otcN1YcsN/+0xN1zqiR/MW9knJHyCPbMx7PkWYptTuX1Bh/yg43/ijePQAl8ZNH+CQeEYBkkoeP2C7jyzf4LF+O2jH89nuF1+ecT/Aw=='),
			this.addDataEntry(dt + 'card', 342, 342, 'Card',
				'7Zbfb5swEMf/Gh4rgZ1k3WMha1VpbSc10p69cAGrBiNzTZP99TuDIWE4Cm3WtxFFMt/7YXMfnyHgSbG7M6LKH3QKKuDfAp4YrbEdFbsElApYKNOALwPGQvoH7PaENWqsYSUMlDglgLUBW6FeoVVaoca9ckKdi8oODawpZbyRSiVaadNYeby0P9JrNPoFOkupS7DOusQj57C5nP4sf9u0Eevu3ZTWvgWDci3UjZJZSVoh09Qa47oSa1lmsUbUhXN22nfYYKfkItVvNjnduCekjLA7WaVGciW6A10Amj25vMkU89aDz1xpcpBZjn+Jom6FrI89FJ0Gru5+BnzEYCWRnpaFmYa6mdHAO7H0lfZi0bZiuCeBzceUbptrSIkWeZ4S6moSomhxkFY2Zhl9IUW4NKrxig3UNPdPR2AySeYnuR8EnOMa8etWNKAEyi0Mon2w3Yw/tKSF9NNd9Ym6GL3Z1ICj7dGvdNKOmY12zPPrL3SbxrtbqGI4jXQ0hfQ7+rGB/UGW/GNd6c68S+HNZ5+Abj5Cd5Os7p8eSYvO9bj/iD1qfP+pO6Tsskce6pcwOdlf16Hn2GSXAXKrc63V9dos/ARei9O8zr4q//Ma8vq6+PfA6PbwtdS6H39M/QE='),
			this.addDataEntry(dt + 'card', 342, 216, 'Card',
				'7VjBbqMwEP0ajqkwpiQ9bpJtL11ppa3UsxsGsGIwMm6a7NfXxkNSNtAiNYnoqkaR8PM8xszTOE94dJFv7xQrs18yBuHRnx5dKCm1u8u3CxDCC3wee3TpBYFvfl5w27NK6lW/ZAoKPYQQOMKGiWdwyAPXAhxa6Z1ANGZVBpbje3ReZay0uIKVSTJPuBALKaSqQ+l8aS8bppVcQ7NSyAJssCz0m+DbeiD+h/+1jzW5cY75bc4NKM1XTPwQPC0M9iS1lrnNUrIVL9I5zpfh7ADeQ6KRz5AnaqgJMACx2VLFYg6tnUW+vdzbxvLFRpoJlstsBra9Ja8hrPcdyBy02pmQFx7rDCOimaNlwNMMaQZ1IKsckO65BwXNDYrYLSg9EvRIy/flS+rRJ5+Cyoj0iG8yuCJBd0V2LcJH9QkRUyCY5htokbtqhgl/S272sc82aZ7TUGSSVKCPirzf56C6hx/XvbOH8m1qm/8qzWNxlQFTurdz2jpF9RgqAO0WoE3olQMPkZYa5JNqYOoJCaNW9gmlZ5Dn+hTyPEm5zplaj1AhEnacJ/5pFLoh/wgUnkGg6BQCKSjFboTqnLN/wuAC7TP9tgkXswkNYRoO+1s8iW2YjdI2TP9723AzbtswG+2xdxnbQPzR+4bPSfTlfQMh4zYO4+2gcxgHMz18u3Dhbz9tvAI='),
			this.addDataEntry(dt + 'card', 342, 146, 'Card',
				'7ZbZbsIwEEW/Jo+VHDsgeCzpokrdpPIDLpkQq04cOYZCv77eKAlmSUV560hIyZ0ZTziXQYlIWq7uJa2LJ5EBj8htRFIphHJX5SoFziOMWBaRmwhjpD8RvjuQjW0W1VRCpfo0YNewpHwBTpkyxUFLBUhwyUatuU9mtCnAtKKITJqC1kaXMNOzJjnjPBVcSFtKchumTEnxAa0M2HAHZOJTi7FpF5VqFSEbXn9jX2YQTjb3/olMfglSsRnl15zNK60pUZujazpj1XwilBLl5nmd9gi5QRMPt9LU9NzEA61Qfwy3VROPR8+A1UHEVvJ870GUoORal3yyTBWugiQedAFsXmzakqETaeOE+U/v1jF94U3bbyAJDHxbvKtjHupvokLeYxtd3jHpwbtkWcahP/JeRPFJongDr03U/9iRBE4VW0Ln/H2U/YhXwfRkjNauYjDudog8b0AFrvw8WC+jksCowJnjC/VuI1ioSlRwJtZuQwvyCIWMR2cy9sOuxt4/zzweXoD5IGB+nU4fXp61Fp+kv7MHe6kf+s/bWa7Exs4yxWe6tv6NawT/iWujjmdXCbqAacPDpp1emX/TQtN2Nu1PXNO325cUV95+h/kG'),
			this.addDataEntry(dt + 'card', 300, 176, 'Card',
				'7VbbbqMwEP0aHiv5Qmjz2NBtVKl7kZofcMMQrBqMjJsm+/XrW5oQhwZt07eOhITPzPGYcxhEQvN6M1esrX7KAkRCfyQ0V1Jqf1dvchAiIYgXCb1LCEHmSsj9QBa7LGqZgkaPIRBPWDPxCh5ZcC3AQBUo8MlOb0VIFqyrwFJRQmddxVqLK1iaXrOSC5FLIZUrpaULW6aVfIGDDLjwGxTyzYDY0mWjD4qQi4A/8b+2EUl363Aim1+D0nzJxK3gq8ZgWrZ265YtebOaSa1lvTuvxx6htNLgbA8tLOcOTwzCwjbCVc2CPKYHbAYldlDQdw6yBq22puSNF7ryFTQNQlfAV9WOdp15kHUeWL1z946Zm2DaaQNpZODT67P+yEPzJDrWe+qirzemI/SueVEIGC/5KEXJWUVJmsWKhpcdKRBM8zX09j+lcmjxR3LTmaCtr5hM+wxZlh3oyJX3g40yKo2Mipz5eKCeXUQD1cgGPilrn3AgMsanXtsd+L8qh3ZXmNx4TpAdZ18g+ySS/TZfPPz+ZTB81oCjUTgp/NBn72i+UhdH84Q/adx2yLgbFPtGL2Nb37OrFH2Badmwaeen5tu02LRpdnnXzHL/n+LLD39j/gE='),
			this.addDataEntry(dt + 'card', 300, 224, 'Card',
				'7VbbbqMwEP0aHiv5QlDz2NCLKnW3lZofcMMQrDUYGTdN9uvXtyYhhgb18rYjIcGZOR5zjgeR0Lze3inWVr9kASKhNwnNlZTa39XbHIRICOJFQq8TQpC5EnI7ksUui1qmoNFTCMQTNky8gkeWXAswUAUKfLLTOxGSBesqsFSU0EVXsdbiClam16LkQuRSSOVKaenClmkl/8BRBlz4BQr5ZkBs6bLRR0XIRcCf+V/biKTvz2FHNr8BpfmKiSvB143BtGzt0i1b8Wa9kFrL+n2/HnuA0kqDswO0tJxrPDMIC8sIV7UI8pgesB2V2EFB3zuQNWi1MyVvvNCVr6BpELoCvq4CjZBLD7LOA+s99+CYuQmmDRtIIwOfX1/0Rx6aN9Gx3nMXfb0xnaB3zYtCwHTJJylKzipK0mxAUX/YkQLBNN9Ab/0hlUOLJ8lNZ4J2vmI27zNkWXagI1f2G5tkVBoZFTnz8UC9uIgGqpENfFHWPuFIZDwbOLZ78LMqh3YXOAvnP8iOsx+QfRbJfpUv7x9/GwyfNeBkFAaFH/vsncxX6uJknvAXjduNGXeJYt/o99jW9+wiRT9gWjZu2vmp+W9abNo8+37XzOPhP8WXH//G/AM='),
			this.addDataEntry(dt + 'card', 342, 272, 'Card',
				'zVXbboMwDP2aPLaCBLo+j219mrRfSIchqAGjkLXw9wtJemGlaqXSqZaQkmM7ds7BCmFJ2a4Ur8UnpiAJeycsUYjarco2ASkJDYqUsDdCaWA+Qj8ueEPrDWquoNK3JFCXsOXyBxzigEZ30gON4HW/VPBtjnzNCikTlKisl2XWDN5ohRs48YC13iN4ijsDhmbj64HS0F7s2UK+4RVgCVp1JmRXpFq4CBb5RgUUufBp9MWDvHFAfsg9UmAWnoVxRti9jKytnTFSYQW33p9evT+NgpH770EFkutiC4MCY6T4Gl9YmNI02He0cBndcLs/ALOsAX3G6aHRm2iOrtOc8kZAHx64n8hyXrZ5PyzzvEzlXABX+hLTf2RZWLtTgWHCqR4jcoTLSdSYxWwgB1s+QI54CjnWiJuSq81TKBJGIwMyzXzM4nCgyPIRA7KYQhEFteyeQo5/HJCQxffrYbbHV9iFnz7Svw==')
   		];
		  
		this.addPalette('gmdlCards', 'GMDL / Cards', expand || false, mxUtils.bind(this, function(content)
		{
			for (var i = 0; i < fns.length; i++)
			{
				content.appendChild(fns[i](content));
			}
		}));
	};

	Sidebar.prototype.addGMDLChipsPalette = function(expand)
	{
		var s = "dashed=0;shape=";
		var s2 = "dashed=0;shape=mxgraph.gmdl.";
		var gn = 'mxgraph.gmdl';
		var dt = 'gmdl google media design library chip ';
		var sb = this;
		
		var fns = [
			this.addDataEntry(dt + 'chip', 170, 32, 'Chip with text and icon',
				'rZRfT4MwEMA/TR+3sHZMXx3T+aCJiSY+N3BAY2lJ203mp7cthY0wHWaWkPTuen/6uwNEkqrZKlqXzzIDjsg9IomS0rS7qkmAc4QjliGyQRhH9kX44QfrwlujmioQZooDbh32lO+g1bwp2EtldY9UaBCtXZsDD3Zd0tptFaQ2w5qq9JV9OUUcWVEbJT8gkdyGIBshhbWsc8Z5p0KYgF9Wr+ROZOAqWTjXmqZMFE+Qu8rx0jlKYUL0BXHJOCuEFVJ7O7DR1qF6UAaaHwl4Vbj+FmQFRh3skU+WmTKcuGkpRSWwogxuJLChupWL3vXI024C0vN4yQjviGdGdekZeHwBbtUUbiTmRZXx+U77u05Bu/JrKhh8EUzH4BwXBZwatodB+GtgLS/D6vhYR1ZrmEjlLnaPmx9d+6nd5KxxzK/CNHQ4hK9tHrfy6XStxhA73WSIIf+LZLasPvmsgxbSz26HEWSeazCjJvS3mNSX+D+GuBn1yjYm96u3vAdmeGpnlr92Jh6gGfflTFtWf55iKx7/1i3c05/5Nw=='),
			
            this.addEntry(dt + 'chip', function()
		    {
				var bg = new mxCell('ANZ Bank', new mxGeometry(0, 0, 170, 32), 'shape=rect;arcSize=50;strokeColor=none;fillColor=#eeeeee;rounded=1;spacingLeft=24;fontSize=13;align=center;');
				bg.vertex = true;
				var part1 = new mxCell('A', new mxGeometry(0, 0, 32, 32), 'shape=ellipse;strokeColor=none;fillColor=#009587;fontColor=#ffffff;fontSize=14;');
				part1.geometry.relative = true;
				part1.vertex = true;
				bg.insert(part1);
			   	return sb.createVertexTemplateFromCells([bg], bg.geometry.width, bg.geometry.height, 'Chip with text and icon');
		    }),
			this.addDataEntry(dt + 'list style', 358, 642, 'List Style',
				'5Vldj5s6EP01qE8b2YYk5HE3u+1WaquqrdTHKzcMwY2DETibpL++HgNJCCQhG6iqXqTVwthjhjnnjD/iuNPl5l3Kk+ijCkA67pPjTlOldH633ExBSocRETjuo8MYMX8Oe3uildpWkvAUYt3GgeUOL1yuILfkhkxvZWEIeBYBdieO+5BFPEF7CjMz/kMopJwqqVLb1Q3thd10qhZQtsQqNj4Pxasg1bA5Ga41FbG+A7UEnW5Nl7UIdJT3cId+7haBmEeF28grAudZbpjvfPdfb26KBDQnw60lg5pY7l1yXU5UrL+KX2ihrnnmUsxjbM6jPc7ZlFF/+HAqZzjYQee39sLOCZ+JeP6lyIC3N31TCb65DKSIGeNMITNhfS8ySdsiwl6HCPNyWwqSa/EClfFvQcl7JWWXmznKbDBfBnKgVfLfD57eRFW3OTFVh22hwsEwfz5ImzeqZ41em7Xi/Z+VMGHtXn43YZXX342rI6gwzEDXsr77ilZADGtATNUyURlcJZdm2lc18jShTyO3kcIHamPksmByddwd6lJCqPcdPtinxzHrWR7D8W1Ab6sq6xTYURcKK9Nagbc+R5RYts73sDnfZ3RGm3Q26kRnpQZKmfk9oDHuAo0M4qCl2HYA3QJH6yJYfk1l6mDdFEH3CB1Ke4DHr8HzTd1QAA0AYK8zwJytgobZtSo4sdf1VdCO1WsVvHG6K5D1+wB2Ugc2hReTUkaeeWwEVUP5CFiezgpMhqSl9nbQp2oVB5YxtIYK8xpWma1Q8q+vneXi9xA1txt9jsmRPEc9oEhJF+VzlcHJteIRhCN7IfxZYnnwGIoNjt4OosllITVUzNJ2y7q6rI4HmbqXJlJGPoHM1P+D7qw/ujPi/wm+v3ZH3zXfW232W+z2+2J7fbP/WZqybkyhrfE6AowEYIFLpwvcP6bn9XP65Xn4z27fO5qZabkG65bk9TOAZ+Ew42ck5VKk9XvT/HOVYShrHmskJNFmYUZmEcwWOFaMUSG0JAOEWoQYtlphInhgGzFRScEKHQn8t0pmammQ2XNjYG6/4wAm6Xm/eJF3UKFNKg/yx1VSxvCJJxzdPmAmyArHXcRqfRDEGwxAigWULnO1C3cNb2w2ltw2G15A+mJAUnE2uIaoXhuFF6Z1JDR8NaREz7UpFMaGxBMzLu8L6mpcVZ4g8mkS55bnknp989ojpBti+5M+iF0/U2lXva84TCH26rygbCsOF2HwO0Hhzutjx007OQD5wU2dOXcAcgqXVx6M0PNbcTI4OqxoXP94dai6OpIcV1c/fZxI0hZnJSVWxlMkGfxVCP37ANVPSy7NWH8POuN/DR7zuP+lMe9++EPkbw=='),
			this.addDataEntry(dt + 'list style', 358, 642, 'List Style',
				'5Vpdb6M4FP01aJ4aGUMIeWzSznSl2dnRzkjzWLnBCWwAI3CaZH/92gaSgE3Ch2k1XaSqibGdm3POvb73BsNaRocvKUr8P4mHQ8N6NKxlSgjNX0WHJQ5DA4LAM6wHA0LA/gz4ueGuKe6CBKU4pm0WwHzBKwp3OB/JBzJ6DIsBD2U+5tOBYS0yHyV8PMUrtv9iHYThkoQkFVOttbj4NJqSLS7vxCRmaxbFR+GU4kOjuWKosPULJhGm6ZFN2Qce9fMZ1tTNl/k42PjFMscuDEdZPrA5rT1/e/aiAEANhiWBYTJb7i3QDRMS0x/Bv3zEtNh7FAabmN/Ora1jtoSmO100YcY3u5j8WVx8coJWQbz5u0DAPg/9JAn/5NKQwmZuZ4ozZtavAkmzLSOwHyPQzsdSHCIavOLK/kNYsntKNjpsuJtNNpEXTihJnl9QOkiqlhqY6oJj4YWTaf7+AjbbkVEzu6JWfP53EjCzTh9+N4eVj7+bVXcg63WGqYT66Vu0ImIqEbEkUUIy3Mld1LKv+sjj3Hx0LKWEL7wNgtsOk3vH3aVfhnhNzxO+incPMziye0xnw4g+Vr1MK7GODg8rYa3QK58RJZet8Z6q8b7iZ6bKzxwtflb6QOlm7ghszHSwkeHYa+lsJ4KG0NE6CJbfpnJ0QD1B0KqxY5oj0ONK9PwkAwIgIwCL6woxV6MgU7YUBefi6h4FxV6jRsGBx13BrDsGsXOZ2BS/MkgheEIxcyiJ5RqxKF0VnExBS987UZ+SXewJxZgSK9BWZJmtWHK7x84y+b1kzdLjnzNQc09nBBZNoCN87jLcmCvWKHTExenPEqGDh3Vw4Lu3o2h+25EUEbMcG5JXl9HxAqn7kFkKwTccZuT/IXc4ntwhcN9C730ret16b1Xst6j2x1K7XOx/D1lYZ0NrEeOpj7klGG956nRD+3V5dj/Tb5/Db1u+azqZzTIH0ytyuQfwFBiQrWMuZZlc1n+w2//sMm7KHsWUCxJQlpiBlY9XW75XzK3i1IIMc6qDNTeb7DgQyBM3OVBJoQrqB/zfLlmRiDFz1saEvfzFN2Cg5/PibT6BrAWoyMvf7pLShm8oQXzZV44E2PF9tzHZXxjxiRsQBltcLtmQk7l7/EmgESFxm+kCp6+MJBJnky5Ctdt4eDG09wOKfzBR8pV7FijYGBdesELhfSFdyrPKBiE3izgfeSqlN7aubQD0CNudjyFsuafSLnp3aKacC3Amcya6SxpGiC5wbsssmK6ePtfUqRyp7hj1t9m3HdKBEwAWrmjitjs2G4ruW6jPdJybWtoRffKLdtA4nXM+S9EesvS0h8x6hTOKPuUOxJJFebTihsQoktuxDMD6WaBoGpzjhNQ0qEf+F0IpiaS0ZTrVRJstkabUd1mrDtK3XPZTUfY/+4YN8AFFSYgnLAdog6o9CNX8POXb/sXnUg6GA8ZD2XpDmGHfspxtEyQZHqWX2YRP+2amonqEA/ONUzMT1mJJjQUtsQTKPYAe0f2gqoBOR1zPvn+OYyM51UTAkahRpIJuMwetZfxu1fagROEsYevjnYeKn/HzCN4jgFtte+lAEb+jwPNCPCReX6fPVQSg0eK1ll/d30/orny2/fY6l2tFX/wu8Uw/mNBNG7yh0t+k3OOX9qr7WFlwsxPiDtN6KW57FHFrKTNf0Gp79RmEJl765ijXE0gwqT0voPwJQtUu0fRU0KwalsZ4KEjxe7hE3K1c/j0Z+vgEyQVuI0FNTyi8Gzuzj0YPe3t+2Deffvks8H8=')
   		];
		  
		this.addPalette('gmdlChips', 'GMDL / Chips', expand || false, mxUtils.bind(this, function(content)
		{
			for (var i = 0; i < fns.length; i++)
			{
				content.appendChild(fns[i](content));
			}
		}));
	};
	
	Sidebar.prototype.addGMDLDialogsPalette = function(expand)
	{
		var s = "dashed=0;shape=";
		var s2 = "dashed=0;shape=mxgraph.gmdl.";
		var gn = 'mxgraph.gmdl';
		var dt = 'gmdl google media design library dialog ';
		var sb = this;
		
		var fns = [
			this.addDataEntry(dt + 'dialog persistent footer', 280, 472, 'Dialog with persistent footer button',
				'5ZhdU6MwFIZ/DZd1QigfvVSsvem6ndEZr2NJS2ZTwoSo7f76TUJAaMCtCnXWxXGmnHzAed5zThIcL97tFxzl6Q+WYOp4c8eLOWOi/LXbx5hSBwKSON61AyGQ/w686Wl1dSvIEceZOGUALAc8I/qES0tpKMSBGkOCihSr7sDxrooU5crO8VrOf7UhlMaMMq67eht9qW6Cs1+40YL1VU6QsBdpdOWNeTjmAu97HdAm8/YLzHZY8IPs8kISkRonotJJkGKyTc2waWhcQUVp2NZjX3nIHwZJNx7PwrNgbCvJQPBAJjfEgiUdUVyUS2SN6CUl20y27EiSUO1+jtYk2yr/A8WPZeKO/FaDIajuzWwKEMeFbH0wrp6MDH4MWWBsHFMkyDNuzf8ZjFML453kgqhmJ197K1+rh6QBtsQb0YTWCK0IqL82TNd9HXrPcmkJzk7Tey9N84gVI/LJEBzaolQj2GZTYGHRr1/sJEF8S5D5fi27KJ97hGjS9VuRDPtl+rpYHoj+bAz6gZ0OeP3EiTicWk8emRBs183dmK5Ml2u/IzX6Uui8GvnDaOTCMUQKLZEiAC/cvbTNL1fvLFfNxPnavJgOxDwcg3lkMV+honhhPPnoQvvGugHALIiif7UwQXcMAWaWAE4Yf7Qo1RUI/DUx6s3P99HH80fQpxL9rf16tUWnJMP1Vryip9bqjC3RozpqaJbWVn0k7mYAuAB+aEY1pZhG40kxyhbKde1VPJUnGwWjp2YdHZ5sZajSZcUKIghTGcVLFnWmLY/a62qHTApSnV6fq4rq6oqLQF9HC9pUxQl7yhJ9QtTxZDJ6wDTtyFL4ydDYt6c5VAE3StLah2wTKSh5RtlaooOA5UrT4r+PmbroaKWHLPbniyJ/lHpjf4uIL2/j+bJveW4i9zr2nX3LbW8gDFD93RYoexkIfVukKRxEpIkbtGWaVBMPK5P9rSP+eXs7j++/k07RiDpVcw8pk7x9/aZadm9+cv0D'),
			this.addDataEntry(dt + 'scrollable dialog persistent footer', 280, 345, 'Scrollable dialog with persistent footer button',
				'3Zjfb6owFMf/Gh5dShHER2XOF6/XZEv23EmF5lZqSjf1/vW3hYKYwuYcdbnDmMBpz2nP50t/4XjR9jDnaJf+YjGmjjdzvIgzJsq77SHClDoQkNjx7h0Igfw78KGj1C1KwQ5xnIlLHGDp8IboKy4tpSEXR6oNMcpTrKoDx5vmKdopO8drGX+6IZRGjDJeVPU2xaWqCc7+4EYJLq4yQMz20ujKB9045gIfOhMoTLr3c8y2WPCjrLInsUh1EmGZJEgxSVLt5g390ojy0pDUvice8kYjacfjGXjmjCWSDATPZPBADFgyEcVFpUTWiE4oSTJZsiVxTIv0d2hNskTlHyh+LBOP5K9yhqB61tEUII5zWfqsU70YGbwOWaBtHFMkyBs+i/8VjEMD46PkgmjBTnY7kd3qIKmBLfBGNKE1Xq0QqN85TNc9uT6xnbQEN6fpfZambmLFiGwZguO5KJUH22xyLAz6dccuEsQ3BJkd1rKKyrlDiCZd/+xNht0yfd+73BP9sQ36gTkc8PqVE3G8dD55YUKwbTt3bZrqKvd+y9DoGkK31cjvRyMX2hBpZIgUAnjnHqRtNll9crpqDpzvHRfDnpiPbDAPDeYrlOd7xuNrF9p31g0AxkEY/q8TE3RtCDA2BHBG0bWTUj0DgQ8HRr35+Tn6eL4FfSrR39uvV1t0SjJcb8UremqtztgCvaijRsHS2Kpb4q4dwB3wR9qrKcUwtCeFlS2U69qXoj41WZfieBbjRsIM/MCGMOaZNposo9miax5rLtBeywLdNS91rj09aPORLCO/ZWmHX1NFNz1wq/FSyVQF7lcm82wd/V4uZ9HTT9IptKhTFbtPmeTj6eNTWb35beof'),
			this.addDataEntry(dt + 'message dialog', 480, 480, 'Message dialog',
				'1Zhdc6IwFIZ/DZc6gSjqZau2N91OZ9qZvY4QIbuBMBCr7q/fhCQoBC1WmNnFcUZOvsj7nJNzxIHL5PCcoyz+wUJMHbh24DJnjKtfyWGJKXU8QEIHrhzPA+LreE8XWt2yFWQoxynvMsBTAz4R3WFlUYaCH6k2hKiIsewOHPhYxCiT9hwHYv7HLaF0ySjLy65wW16yG8/Zb3zWgstLTRCyvTC64kYvjnOODxc3UJr00z9jlmCeH0WXPQl5rHpM5mqTIMYkinnDiApliKqxJz3EDy1JuzzQkucV74UhwUWBInyTVnKbJED0gZIoFeaEhCEtJclQQNJIauJLTVnK38kfOdKF5l4vIUXLcSFaf+rtuw0KKUvxVQBIL0/xlndF4H0XgbLlmCJOPnFt/nuwTL7ptckhkpE2jpKQjg+VTEZLr004v7y6KgXblaoPOOrIHE/V/ZmO7sSW0dg6y6jXf2NEPFa1+AhOasuPZvUZ2HZbYG5hqHbRiczUIvPBLDZCQH7y+5fSEU++f6b9HMhPS0zooR8sExa/NSiGdGwI7iOiCfhgAAK+ReB9t/klj6ALGC5oa+KhHZI5kMAVaP8BARdMB0Aw6+N40lmjfkK5V4/2ljzQb1wcawO+YuRPe2E08odgNLcYPViQGgn8q2ShJadog+kbKwgnTCbaQKiK87MC4KXRgctTrMrLVndTL2wY5yypB6wHTiH6qNtXI2gHZZXFGhVbUF4tQd3JTWY3uonXkt36SW4m8RifMdP26jOLPuIacY6COCk17L/+uJXIwgbSE5FZo9qYDEHEBX0gyeiu+BdgDFj8uUYpgwMuhsDh2sXH+nXVtfJo/tNpnGHeejZ/OqtJVPUHrv21sg7Ve7JfaxHfElIDpEJTwi8aFPtIjeL29L5BdT9/HfEX'),
			this.addDataEntry(dt + 'dialog', 280, 273, 'Dialog',
				'7ZZRb9owEMc/TbQnKifpgD4WCmzSJk2j056t+JJYc+zINgns0+8cmxAI1VC77WmWIPbd/e+s+12kROmy2m80rcvPioGI0lWULrVS1u+q/RKEiBLCWZQ+RUlC8Bcl6xe8ceclNdUg7S2CxAsaKnbgLd8MoGGjVCHgncGtUBm1XEncGtANzzBw7WXGHkSQMWpKcElJlC5MSWtn15DhLRY5F2KphNJdaJp3y4VZrX7A0SOVBK9lqsVz7JRK2i3/6XLFD+E8yES65UQ1zbgsnlWNjskULW3JLWzR7LQt9vcU5ZK5ECp4IfEgIHe3bEBbnlHxGMzWJVuE/qAP9i/2uDOFBm9AVWD1AUNazmwZ+jz3HEgJvCiDLJml3kiNNxS99oQMN4HadYLpiOAnsD3BrqKoXY26djQZWNAVlzAge4f755I7dwVUmo60ZK5VqEMuh0rtLkaBUUvxYdWgFN6VQAPO3ZbdQ6pTZewX/uudlJj4bjRA2F97QXw6Jv7QrdcS12Aw9feAJe4tH45Q4luJJ68jHk+DUYPATjZwVuDaGIQaXxSXjurBR8zIuULluXHUL8amv9lNk3Q/mqSnj9vHzdfV6hZY6RhWsprN18klLPJbVuTK21hxxlz1/q3NkAXo4yXC1d7K71xwODsN2F5Dez9/G9lQetKPSKg+OSb+o6zfj1j/B/2PQc//Amc8nr4dfPjw0+IX'),
			this.addDataEntry(dt + 'fullscreen dialog', 358, 642, 'Fullscreen dialog',
				'7Vtdk+ooEP01eXQKQhLj43zel5mtqZ2p3cctVFTukGDF7FzdX78kgWgEvajgfFI1NZFAQvr0aU7aNkDX2fJHgeezBz4mLEC3AbouOC+bo2x5TRgLQkDHAboJwhCIvyC823EW1mfBHBckL20mhM2EV8z+JU1P07EoV0x2jPFiRqrhIEBXixmeV/0FGYnrX00oY9ec8aIeiiZ1q4aVBX8h6kzOczHnSt6KFCVZ7lxu3SXX+oPwjJTFSgz5RcflrBmB4rSZNiN0OpPTkkguHC+ajmk7d/304kAawGwMpBkDirVcInCQTTCj07z62Kxu20YA9AfJ1S4bTXhebgy+q1s1eI5HNJ/+KZ84Wnc987nogHLuk1xjta6CLOh/5G9pOWiLQHgcAmHU9BWE4ZK+ks71T0ElOtJFs+W0otXFNBuzi5LP/xni4iTXRGbDdCesJOsu4ubzhtmiRLcaPNRq8v6PnIpltTfvDcLO7Xv97hX4ZLIgpWb19imsgIg1IP4gv0QHea1MdAhFzK6/zZNBkqbKrYUji+4Q/J4iDR961cwKTzrC7FIyMqPjcbW8lqKMTMr1zPv6001yfu7E/dO8YNWloFPUExf0W2qg67uFMnZoa+zYbOw9DFRs88BAuc+2BBx4gKKvQfF0+detBoewWdnlDUS2vAH7aCNHXvGy5JmCu8Od9ETsjLEUajgmQMdRCYBTI2nSvXlvW1g4QTLVkJyR1aTg2U+e43KG8yAC0wxTdjESlj4ktBojrICb1G1n7KucJNlymsgYB3d6h9cAmTgJkCn0gOXAiT4pKM6nDcssNsdB3WyNnp4oXKCBbrEbtqmY1rLNA0Bq+RsI3TaSBeQ4IxbxE0E9fg7rZhM/hzJeavEzNMbPNSPTswuR1A3PIPKhPyE8kmmM5jqxNmOiWyMvFZNABAcamZBy+Y4IAU7sHsLUh931JME9H4l18txGe0Rn4g4Eb0yeviMQVR7CLYh6cuNDksdgd1fkSb2QR09f3BUGTWcgjmHTSer22YgTOQJw4IU4etrjrqBBKCaCB1w9XhUfgfjXtwE11kEFdfvAoIbA9D7mBlTkJxo6yWp4Fe3746P+TuxRpEMlKxQmkY/3KKinNyKZfQePD++JWzq1uql3H/D2PVCsTR5vweuHcnrO45tytu/Fnhh3bOriy2jCVq44tXuoJySeuU2A+1aEB8KXeIFPz0N8K8IzKkIvMl+Fvu/t6RhFGKl7ucVEz1nEH0URekH0nCLQD8vcFHN8EZZtiUBPJNPzG3aQfBkRGIVeVMSxKYgvY/c48eLveprhkrHeDV4dEYlGMzJ6GXJjeUurzDfDkYxQesULw0PCHvmC1l+rrKsH1aZ0v3V+Vy3T74o35IaFgGGnPMVNNiOiqc7txC8Wl93LKGaqugC3HqJnKh6F7SZ0JDqfSpyPcTEWh8/U6stj8RawW4RYwlXXZpz3FQyeuIkpEiMvEL3/oov3qyNi5KM4DelJDTtIDqoJlbRxS4WddWbm3ETqhBi9yIeqQMfWSHSIMcSjF9OW1lZs7sLlyErOxnf2aA/FhLep7extFSn5KG5BFvkHhZWYSecLowh8M4Q+P0AWBRR7Q9pbotP/bPAEVRWF+pFUM3zzN1T/Aw=='),
			this.addDataEntry(dt + 'dialog scrollable list', 280, 270, 'Dialog with scrollable list',
				'7Vhdb9sgFP01fmyFce24j43b5aFpF62T9kzjGxsNmwiTJtmvHxjy4eAkrlpLWxWkSObA5cI5B3QVL0iK1UiQef7EU2Be8OAFieBcmq9ilQBjHkY09YJ7D2Okfh7+dmTUr0fRnAgoZZcAbALeCFuAQQxQyTWzQJWTuf4UMFVLDme8lC/0j0b8WPcpYwlnXNSzg1ndFF5JwX/D3gjUTY/kJOVLHa86Nj8ICaujZ6ghe4AR8AKkWKspS5rK3J4jNudEOdAst2F4YEFSGSDbxu4oUR+WlXaGAoehZ16Cw1JKqhx0CDInrCkrVplW9jorUnYtSEr560JKXh7QGNr+HlmobnqpOZnSMvvJ53btZU4lvChUhy7V8rtJCsB6CiOvwCa8opLqXPfCUDLULNMpYeOD8YKmqT7HkDCaaYDBbH/+nYW384y2vyz9uE3tqG5dBcbnBW7T12ICGJH0DRrLt2luM0w4VYkx2uwnMhFr0w3D5gJ8NqtAOpbZbrOTi24cFyWEMVpJfnHSl3WSj3APVgodK41IuS4gvTxKX9hK4aAHK0WOlcaLklxsdMZGCN1GcUvts8X/O3vhXl6qgWOvSV7XTuiHUlS2lVEnis3BKScdLTaPlacHdti5zI82ee2udJUqoFK72Jiic93aQeK2ujWM36lx11o2dgT5VwX4XMLXjYCz9OOPXTGb7Srs407duoXk3XPyMHaEVDQdChi0CWifrHe+xejUE7qRdqp0AdFynT6iZTPgqLJRD8La1Ff+DWpk70dpHzlSf3+8yNyUuY/7u5E57kFl1d39uWOm7//38xc='),
			this.addDataEntry(dt + 'dialog scrollable list', 280, 112, 'Dialog with scrollable list',
				'7VTLboMwEPwajpEMbl7HFJKoUltVTX/AwgtYNRgZNyT9+q7BISEQKZfcagnJO7vDrmfAHg3zw1azMntTHKRH1x4NtVKm3eWHEKT0AiK4RyMvCAg+XrC5kfWbLCmZhsLcQwhawp7JH2iRSFQx0xxBrlmCL9m0JZU5SldSZay0Ww0x5p8TVZid+LWIv7CxkDJUUummmibNQrwyWn3DRQaaZTMZ46q2/KvXzV18QZo1C3EmRVogJsFO+VyVLBZFalkj2T1oI2ImVw42qkTUHR5zcLgpYAM59bagcjD6iCW14CZzIi5akUkGIs1ONN9py6oWSDvu2Q/cOEvG7aEDe8LVe7h+HViCB7i2gg61I2RBN/5ZrC+rQkQQqDNhYIeopdb4OfYUJSMK5oJz271TOkbFQJ+GcKP596ocjKvcJxx70YUD8xEDpk5/DZIZsYced8wU1/1DCRyqaz3xZ6TXfTK9MlYlSQVmYGt3irucfhr+iC+7cPUZ/Vvdt3r5QKuXD3Aaw/N13pZf3vZ/'),
			this.addDataEntry(dt + 'simple dialog', 280, 250, 'Simple dialog',
				'7ZZdb9sgFIZ/jS8XYRx77WWbftxs0rRW6jUxJzYqGAtwmuzX92DIp50qm7pIk0YUCd7DOeD3wR9JNlOrR8Pa+rvmIJPsPslmRmsXemo1AykTSgRPsruEUoL/hD6ciKZ9lLTMQOPOSaAhYclkB0F5AofCnJWvXYsdVpa6w1r9NOvWMk6zNWt910CJC90uhJQzLbXpo9mib6hbZ/Qr7EWgbz5SM67fUEx9um7ck/jlC+KGw3gvifQNdSZF1aAmYeFXtS0rRVP5IgUOl2CcKJm8ibOcbje148bJLunZB+++5KjgNXTGiiX8BBs2QaItWBBWJ63tpejrI2gFzqxxypvgro72XsVKNYiqjmk0jyKzQai2uTtS2ImwxsFlA3CdBdMwBcmUVIoJOSm1GmDjzNbAN05EhmpV+QM4qRSXE1/mkEiafxoRJTj3Wzk+L/n99deHYnBeGt34yZLNQf7QVjihfRUTvNxW/3YU365yFkU6TnGTkIeMdRgWcbjHeDqCePoJhKejhAn9z/cv8k0zcjHA+QAw4/yMRy5WEa2Fi0Occ//7FyBeX+4uLQYQ/+CebGVnx16WR6/Rl3g59FzX8o9do4eu0YFpaTE0baP9hmk43H3R9LGDD553'),
			this.addDataEntry(dt + 'simple dialog', 280, 250, 'Simple dialog',
				'7Zldj6IwFIZ/DZdO+BhBL0dm1k3WnTGZTfa6yhGaLdSU+rW/fltaUCyOJsrFEpqYlHN62uN5H9pYLS9M91OG1slPGgGxvDfLCxmlXPXSfQiEWK6NI8t7tVzXFh/L/XbB6xRee40YZPyWAFcFbBHZgLLME5qBMDGcxbzoygE5PxA9IE/QWnYZLMUSkxUmJKSEssLrrYom7Dln9A+ceKBo0pOgiO6E0ZHhNOOf+K+cUKSqnk+C7KLJoDVaiox+0bVwDIKjpQwkaAFkTnPMMc2EcSkqAGKWCSI4lgYCK5nvFhjHS0RetJnLGSe6DMIH+4ulLEy6jlOgKXB2EEN2OOKJLudIldtOAMeJDhtqDWyUK0NcxR6VER0tTrNQniHUe5M4EcoTkCG2KnShVLqPJWBPcRqRJ4YiTBcbzmWVTsvv+LeW375efaa+flXt2Zk/xVEkc76mTjVO4fRbl9ptAswv2q1iutfFbNCytDEgiOMt1KZv0levMKdYLOzaZT6+ijiox+BsArpa5cANPKo0byLm2SAmRITgnNOemk5Q45S790OxGRrYvOJ+p+kMM4HXAjO+wcwUZYcUoh6bbmBTnSYPxSYwsPmOsphueC6s8rDq6ekGPcGwBXpGBj2zTYZ6ZGrJjv3RyPyRVtn/O5S88qx5KEpjA6WPBTAhSw9TF/YfLwhagMaxDWrmCV3QvKemE9Q8lyfMY6lxDGoMXs5v2E5wCL7C4eKN26U7ujOdj/gU2DHIxaqlus6dGh5qAdfvzO6TVK82KOd5rIbmrWn48h6+zQwlRZ3OFfSaFNTHsfFC7xLM4VNYZehO7Bc1leyv3s1S2+oetEhCp3avmPWAi9IGLSirlx44vl1bvSWpzXvXjx+9zHWZxy3KPG5BZfF4/IdFDT/9A+Yf')
   		];
		  
		this.addPalette('gmdlDialogs', 'GMDL / Dialogs', expand || false, mxUtils.bind(this, function(content)
		{
			for (var i = 0; i < fns.length; i++)
			{
				content.appendChild(fns[i](content));
			}
		}));
	};
	
	Sidebar.prototype.addGMDLDividersPalette = function(expand)
	{
		var s = "dashed=0;shape=";
		var s2 = "dashed=0;shape=mxgraph.gmdl.";
		var gn = 'mxgraph.gmdl';
		var dt = 'gmdl google media design library divider ';
		var sb = this;
		
		var fns = [
			this.addDataEntry(dt + 'email list full bleed divider', 358, 642, 'Full-bleed dividers',
				'7Vxtc6I6FP41zn6qAwSUfqz2defeuXu3O9OPO1GiZAqJG2Jb76+/SQALJlpQaAtTOlaICYTz5Jzz8Jg4ANP45YbBVfg3DVA0AFcDMGWU8nQvfpmiKBo4Fg4G4HLgOJZ4DZzrPZ/a6lNrBRkivEoDJ23wBKM1SkvSgoRvoqwggEmIZHVrACZJCFeynKG5OP9kgaNoSiPKVFWwUJusxhl9RPknhBLRZpJdCjGOXvZ2VxVlfb1BNEacbUSVZxzwMK0BPD9tFiK8DLNmIzfrOEzSguW27evdi53MAGZjAM0YtujLBbDq2YQSfo//kyU2EMcwwksiP057u2uzqWP73mSfzeTJCpWv1SYrr+Ack+XPzALua9EvupJXzjuS9Vn2k6FEdOshs6RdFRHnOEQcNy1jKIIcP6HS+U9ByT1yyMYvS+lmw2UcRENOV79nkJ00VIHZMOUGm8wLh156XDCbO9KtZte1Wnb9HxSLbm0vfnbulC5/Ni6fgS4WCeKa1bd3UQkITwPijszoSy1nMQ/6sodcndtXI2AcwAVfc6wD7iKRxHMYXWS+GOMgkN3bOmeEFvzVh/5SR5djZ9etztyWvcYbn4b/pux8jeI9asLxVgwtkDDTHCUa/HoGybF2qprdM5v9gBfmpip54agRL8xPkzuh3wIo4yZASRBk8/AgHkWfzNy0WYgqh03bFDabAexs7LePmP82YqIBXiWoYnzcYvQu5s8IZTnXW82YH4zL5retFux/3oTHzEM0fzQ5zDZZNecw/kHEvJLJRrq7ODpe/n5kqrKwHJqCGUVyFQVTSghliWbTAyx5ZDIkUtuB0b6TundTPJcJO8/e26uUkrn9/qzYPzFQZTD7Oy0acQzb1iCdsDURicGxeIgTeXsIPSIi6l9r+ApjmZ5+9jKvMtVS6BwJRToUD2NhtRC1MixAK1joD+Z331SNGZLViLw+XTPxRuQtzcR+iETMcqyAygHvWIgxSAKJ2nA4PBaukhcVsdph2udq6yyGXhuJxjboCSJaW7FE7204nDpw7IoMpUBXeIzJBYODGJ6EWLlFAT+/ReLgt4JfI0pDwg0yg7D2RP29qaHVZgu1cbHHOi5N8WlwXmIn7biZrkPEIkaKdtb9nHKe7n5HhGDx5PnFS9rkJfaoDaHJ1pWH+3UcSzCtyeTfz0RF9jxddZqK6BLDA04kKbwTrzldR4F6z51utpY9uvsWi/9U7dOFZJD0mbwSyS5Qko/Fsp1YqYsPqvt6WOwgIamkbHSakDQiXbw7IamLS9cJiaNLI/fiSYxBUXYRwPhLG2mVgzgeaANUXRz5Z41VisOfiIA4PdRC8ihXMP0lHSj9Q94FfJKKCCQb1X3BQ2JEAnETlCRKp7Ju0xodoBwfjF470VBXQUZ9oRz78OoP5WhmtsV7U47auHSecugayC+GnihT4Y8kSFccvzhHg5wD5CA3i6que0ww42EA5a0t8YJ/JubRQ+nDMLvitkg3cICgVDPgLBU6nkMo37hkJ0t5desW4UCyxIVyxS5QkB6qHoYpF3ZvZI9qEzo6zUE6KXvUxqXrHATosseEYc6l7HFLIz1XfTGQBhmIm1PAZjHVVY+faI5XKM9y+ayhz8FBQA/VD6CrHw/S/EmYffOCUs4hv1cBF5J4MMjVRJDkzxrK72nklzJzyoiiLUE3aMgHI9lOgDTMB/H7QkP2AdYfGgI6KYXUxqXzNESXQi7hE5Zx7wdkj18spE0W4tmtpEBdB7nBkHD56L2Ect7B52EgPVRBgK6CXKTyB+FI2IkPsgmpCULp1FMeSoayxWgVKcGKSFS6wT56KIIAw9QP0Bv20XsRBHRSBKmNS9fZh6uLIHsZR71VXrafL/0OYUCfG+AExiVfOiSeYb2d19J6OzvX+poFRVcxjvCdVbQ2Llm1fNcbWcf7iHuYoedRaVM+rLgg8qSF9rryUM1sNdZ2W2prnO7uHcxG8uv6jaTtM7eN5aKurhocMXhn0Lxc0bi+t4jLsYP6cMyxhjvrFo0LfU0rsxv6fYSdhaZtzFp3K+gFb6WCj0So/wDpSsFegIwh7SPRGfcNHnH4+rNHafXiryL9Dw=='),
			this.addDataEntry(dt + 'full bleed divider compose email', 358, 642, 'Full-bleed dividers (Compose email)',
				'7Zldj6IwFIZ/DZca2gLi5eo4c7OTbHYm2ctNlQrMFEpKZ1b312/Lh4pFRS1jdnabmMjhlB7Ow9seioWmyeqB4yx6ZAGhFppZaMoZE+W/ZDUllFrQjgML3VkQ2vJnwfsDZ0Fx1s4wJ6no0gGWHd4xfSOlpTTkYk0rQ4DziCh320KTPMKZsnOykNefLGNKp4wyXriiZdGUm+DsldRnUpbKPpNqKMIFWR0MtzBVsT4QlhDB19LlVxyIqPRArl92i0gcRlU3z6kCx3lpCDd9t3cv/1QJaE8G0pIBZCxfkH1eTlgqnuLfygKQPMY0DlN1uox2P2dTCHx3cihn6mI7zvdFU84ZXsRp+L3KgLM1PbNMjVwHUsWs4uQkl2H9qDIJuhKBlxGBTmnjhGIRv5PG9a+h5Fz4yCarUMlsGCYBHQqW/ZxjftWjitoT0+ywrlQ4dMvjnbQ5np41cG7WqvG/sViGtRl8MIaN4Qej5hXYcpkToWV9cxedQLgaiClLMpaTs+TS/tg3NTIbg5mHWh/hHbVB+7RgSnUMdnVJyVJsHb4WR3cj2LM83NF1oNdNlRkF65lQWJ3WBl59jahZds63257vIzoDbTrzjOis1kAtM78HGiMTNHKSBh3FtgF0DY7Ok2B9N42lA5qZBNEeHQB6wONreCKyXnKWvLAUiwinlmOHCY7pcMESjdzRyVDCIEU7Aql9FlOTo9dSi3xsCeBeuZhV3Pw+sI2NVBE8xmmo/Dspyyta16T7VyoL2C1EDAnLbgoL9QCoDn+H0DO7tX72qot50f5WXYF6fjTLDWjcnt7mL4rPf3gG4fnjPuDp+wGPJM9xqNf0MjXi30YAnV7mPX0XotvKdMb7lF0043lfNzqcouD4RigMnD6KbmBkl2GOF69H34EOcbnw3Qgc35Kwh3vvK61lg6OjMrUrMWqWDX1sSgB9V+LguiN7xlmuV2+3JPT5AXXYXThVGNyMzuiz4ZGH248Npfvut4g/'),
			this.addDataEntry(dt + 'image based content divider', 358, 642, 'Image based content dividers',
				'3Vpdj6IwFP01PGpoC+I8qrMzyWYn2exuso+bKhWaKUIAZ2V//VIoKLY4KB9+YEzk0tLLOfdce1s0tPB2ryEO3DffJkxDXzS0CH0/zn95uwVhTIM6tTX0rEGop18NvtRcBdlVPcAh2cRNOsC8wwdmW5JbckMUJ0wYbBy5hDfXNTSPXBxwe0hW6f3na8rYwmd+mDVF6+zgzeLQfyfFlY2/SfvMxVAkjMmu1t3MJHx9Jb5H4jBJm/ylduzmLZA5zbu5hDqu6DYxhOM4yg1O2Xf/9OkPAYAaDCSBAVJfZkg/DxN/E/+k/7gFoPQcM+ps+OXc22PMLJN/6jDjNzto/JIdvHGAV3Tj/BAIGHvTLz/gIxeOCJ+5nyGJUrd+CyRBU0bgZYxAI7eFhOGYfpDK/duwZFwYst7O4TIbO57NxrEf/FnisFWoIjUw1Q6JUOHYzM8PYDMmMmrgXNTE+N99mrpVDj56gpXhR1b1Dv56HZFYQr18ikZEmBIRM7bcetFZalFHfU1akSP4QGxQl/WiZ0dq51TSFWYzIUaP2jZ3r1QnI+t4L6Jv2dmzBY91NTJ6lo1ptQuApKq+TgmfdKG8AugK74d58JB8EQ9544J32JQCU03BCUkClSQnnUiyYKRQ5LQHgqwuCIoIDleuEvVaalQ8tqGocQ4V05vqP4/eTQ5FVpUxoPdA2VSi7A0nEmvnJk317KGk5mTSA3o1r4K2KU/gZ00l9tQZUK9nqukc4akLIVAPO8oQX2bHif+pNmjtKrOcpJiHyuABYCqSVWFsg14R6HcMHyhcvg6A4O4BhIZ+TQAvrUtvB8CqgKFhDQmfXMneG3zHAh4YwE6KzJsS8MAAysXh1206J3nEiQ2aQAnZ3mY2oJMi7IYyowFk9HqMy05KpJvKjAMDKBcs9wbgcWYcGMBHq01MBAaEDz5ebTIwgI9XmwwM4KW1yRkr3uW6dbd7Nkmlw2fTFUPYWi5Fj4w+ljoVm3UXhPESr95VUVxGax0vF65IfxLY+rjYVDm1Rm0oArujbaOjFc8+do2a7N8VXKU9aRAp88zVGHp8guTSrZYgZUq7JjvWo9GTnu7fBsmbH74s8h8='),
			this.addDataEntry(dt + 'full bleed divider', 358, 642, 'Full-bleed dividers',
				'7Vtdk+IoFP01PraVgJ+Po07Py07V1HRX7eMWGkxYk5ABHNv99XshSWsktjEm3Y52umwFgdzcw4XDETp4Gr18EyQJvnOPhh38tYOngnOVfopepjQMO8hhXgfPOgg58OqgxyPfuuZbJyGCxqpKBZRW+E3CNU1z0gyptmGW4REZUF3c6eCJDEii8wVdQPuTJQvDKQ+5MEXx0ly6mBJ8RfNvYh5DnUl2KyoUfTlqrsnKbP1GeUSV2EKRDfNUkJbA/VFaLaDMD7Jqg15mOJFphv9ad/f08CFzQLkzsOUMF2z5gp2zfEJC5sc6mVp36CPHGY4Hk2M+WvJY7RV+NJcunJAFi/2f2RP3dlnPPIEMN6v7lNno5Gn2n066GNKCSkj9nXnSrYoIqocI6qV5goZEsd+00P4lKPVqdtnoxddh1vUjL+wqnvwzJ8KGB83weDS4qAvjcocVK2yz6Oz20/SeO3sD25vuud7M7v+DMzDr9eYPY1S4/cOw2AJfLiVVFhqvT1EJoL4F0CMFNLTxxKPirGAqD5LDiBoPRqPSDr4XAsg5HV5pLD3oYNEYswUJv2TRHDHP0wa/hndIl2pX8y+Tmg1Ry1HVH17WD7bF4GwU90ETgZkIuqTgpgWVleHvITyp6vd+ud/fCMfcV4VwHDQSjnkzeTSOWkBl2AQqAAoEV2Ahsu/+Y7CkNfKorBwgR4CqPIq6ZaNoM7A9DPrt4zZqAjcwQ8Ho9K6hVBmhfnsA5THbJkDj0wDVYsvwDTVXCqrHNxnC78vfXAc3MtWM3BZ87zqW82dkm1KMJKHw9F4XUs8Bhf+KRgmVykDDTDOC+IaQbBi4ADnr2GMRi5mJpkMMwbUau03AFH2CyV5nbyDCbDbhmKuEOyhNKw6Jwz477++IhE4OdskJV4pHeYgXWIpem9TtE+OTfQL1Sqa9gXNml6jK6V3XwnPKRWxAmlO61OYLLhdsDe6AhC84gNbtds+Bq0jV9r2cL6v28zrli6hjmJ/Gq//ucKFz4SqP4F4bo6drKw86qB2Iw3fFFNmYjs1125gOURuY2gJKDc4SEeGz+Gc6ZeqZ87vJyMHa5WSgpwPhwdw6mem/i5bxRwB6OQBnn3Lmnbp0Hr1ofKwgenySDagwamNh69qKBjALobnFJn2T0Jx+gxlewjvXExaBF5CASH/UJsacnzW0/bnsIu2t10QvbGniOTDrImCHmk/Q+F++vQ8uURecqyYTtsjhavNtrfEmqcQHQ9oOl2hE/7gWLnEMoY8hE5/KRaV+jUZt/DqCbOnicR3riUjwRM/rejqSC3C/vBO2cG1iBLLFiFRIis3NwTKiicOCR/AY5tahtvfXmlGlVaenlAwaEqhMRUlYKHdskfiExXciXdRFt6G5Kf/tvtkQLtEu7olu3KB0UbL340+mG9ekXVTZsPFJN6DxcStjla1d/OBiBTkh11IrzE1rSXwzSwUkXgEiCBp1VoyGcyK1iDEnC61c5EK8YPM7YSbo2nSMki0WM7GOJPhRI6rWYkW3Bkm+Ds1WG0f+WsMT3c0vJXUhu2Z1o2QLB7ojuvHBkLZDN25K3TiG0MfQjZtXN9xmhqrxgbMb6djYVjemARXmyeYhl5JHeiFsmAekYbS4DyZxbRoHtjWOp0Rof0AZaaxIpYrYM7qF/mgaWMV8cz9s4gbFC2yLF/ie2MQNihf4psSLq9p4geueNjnr/EI2ljVLJLaFCqdoRb5yubB/P7SyAsK2iFGjg88JrJJLWN0r3zuGS80d7PhtWux0UXEbeeku9rLDBw2dBRoW7t7KUSBc4UxIjhXUZImkV4XQ7QNU4XjIm0PaR6IzvDV4ILk7+psW3z8Z/D8='),
			this.addDataEntry(dt + 'inset divider', 358, 642, 'Inset dividers',
				'7Zvvb9o4GMf/Gl5SOXZCwktKt52mbapuk+7lyQVDohobOV4P7q8/5xck2HQG7FtaSFUJO3YSnk++j51vzABNV5tPAq/Tr3xO6AB9GKCp4FxWn1abKaF0AEE2H6CHAYRA/Q/gxyN7g3IvWGNBmLTpAKsOL5j+JFVNVZHLLa0r5jhPSdEcDNB9nuJ1US/ITB3/fpFROuWUi7IpWpRb0UwK/kyaPYwz1ee+PhURkmyOXm5ZVV/rJ8JXRIqtavJPNpdp1QJFSdUtJdkyrbuNwvrCcV5VLHd9999efagDYA4G0oIRqGuZIHBSTDDNlqwoVld3GCP4gMbJ6FiMFpzJVuOP5VY0XuNZxpZ/1t843Ff94GtVEdR9v9fXCJpy9m9RDJAqC5Kr0l91JANbIvA8IjCs6gShWGYvpHP8SyiFZ96yq82ykNndcjWnd5Kv/37C4lQ8VgFD5oB1O2xrdd5FVbkVznCkRzM4NZr1+R95pi5rd/LhGHZOP4y7R+CLRU6kRmP3LawARRqgSbH/BAmZpdEFhcZhPI6Nt3Xrxofg16KqFDRELe1SspD7Bl/K0kMMPUsmii+DvO0qzynUkQvVrQVZEBWmGcktKe9GFKu4R+a4v6K1JlYdrY2caK05TCO1xAOV2EkuFBlmy6J9L5AEwKAMN0RA2EWCPCBJXCDJCRazVAPSjn6bSg2qatxkQutsdQSR9XgVmMYrNxoajiL/Ihq7ISalGir+17xmTSjyBwiG/gE1GaFF6DNmxWHBIxHPGcvtgL02u3h1FhGE+iwClJuqL9hlM0wn9dxhlc3nVTLVZw8H8wsr+OdOJi7MmTXQJPABNHAiOVlO4G3k9qCmi6MP1s+g4ORBq3l27DwBBW5GrYN5ROCFyLlGQIfIz5zYEklA8XcpEesMiAxjFHKUAiNwAMhLDtTNia+4jMFnnrKcs16mwN/8POUmBQbNjeIWqBMfw5/iLnUx3r7idB/jkUgVbgimWND8pjmfmht7GeWcuBj+NHfpPP/ta043NH4I8sIL0f2BWU5ukvMmuZ3v7JaoEz/En+Tiq5echf3RMKFZy2dqxZyUm+ZABc5fOm0aEBA0j0Hth7DEACNxIg4EfIgD6sbGBItiXgHuCWNEylu685XuUHPjuyWqOxsTjaEKijx4TWXgsPMsjnI4fOHbcJmpEJf50g7DGW6H4a3Jye97Ld0O6INSv92OY0SuZ1AyLMWYPD2RIgjTVGS5JLe5oNfkGPt4h+xm6YY/2V295WFcupEVouOMcdHP1yzvQnAh9DIb6bffcfF7zbcvON3vmFAVMQi+EXozGH0KLvEywvXb7YBX73YYFntMmEw5K8LwXZIX0tPFBO9CdBHyMcoh3UXplejG1y46dO5yjxOWA+8U5NZw3HY6/EomoRuzcRh6oeDE9HjCs2eTBWxcl9jmcubiRHTkByF7J7i7QtC4QNG0yNfRgvq4qx8f6+mRboZo4BpWqme2zkmvCL1/QBa+xqsp7XfSid8bHlXc/36uat7+ed1/')
   		];
		  
		this.addPalette('gmdlDividers', 'GMDL / Dividers', expand || false, mxUtils.bind(this, function(content)
		{
			for (var i = 0; i < fns.length; i++)
			{
				content.appendChild(fns[i](content));
			}
		}));
	};

	Sidebar.prototype.addGMDLGridListsPalette = function(expand)
	{
		var s = "dashed=0;shape=";
		var s2 = "dashed=0;shape=mxgraph.gmdl.";
		var gn = 'mxgraph.gmdl';
		var dt = 'gmdl google media design library grid list ';
		var sb = this;
		
		var fns = [
			this.addDataEntry(dt + 'grid titles', 358, 642, 'Grid titles',
				'7VtRb5swEP41PKbCNgTymKRrN2mVpm3SHieWOISVxAjcNdmvn41tAhhSmpi2oaOqFB82XO67u+98EAvNN7vbNEjWd2SJYwt9sNA8JYSKT5vdHMexBe1oaaFrC0Kb/VvwpuUsyM/aSZDiLe2yAIoFf4L4AQuJEGR0H0vBMsjWmE+3LTTL1kHC5SlesOvPVlEcz0lM0nwqWuUHn0ZTco/VmS3ZsjUzeSucUrxrVTcXSV1vMdlgmu7ZlMdoSddiBnJ9sWyNo3Atl40dqXiQCUFYrD18e/ZBGqDZGEgzBmC6TJH9LJsEcRRu+VBoV7eRDX3/GrTZaEW2tDT5Jj/45CRYRNvwq/zGzkH0nSRMAOTab1JHW42jv3wIEBunOGOjH9KSoCsi8DREoCNkKY4DGv3Bleufg5JzostudiEPs6tws4yvKEl+/grSBngmHpp+OMuFUbPBqgv2MjqvXDEumdMZ69YEz7WmvP8XEjG1ipuPJrBy+5FXvQJZrTJMNTSKb9EJIPe8nNIcFzWU0HRy47y4TwM4Pg+GfTU2jJp9bCIuYrzSMeAG9x13bBdnlMFhV4O7TxocNHn9meaW+iiPVNa3e7C+p1mfkszitxqHtLBSCQtmLVpN0lz/OgG43ty5cevZfsTTObd4tAjiqeSbTbRcxp2TVAsg+8qCEjxuAzzPTvHN0TBy+wDE1wCZ4WCxPhGHOhG/Gg5QGcskELsqxr3iMjGRpjIcpAzLY4mqzBiSRMzmrl0bRD1mspGH+k9lwDYB0QZvH7qyucKsHziaiNwQHMipwAH6KKcAMAJHkIbR9qsosXildZcLLLGXOAhmhFKy4bkNVuRq55GLa/jNrvlfG9hMnSV5lLrp9ZqQfFTgGCzhgDdpQF4JzyQt0EtyBPp+/NPd7U8HIPvqdxKaw/1zXufVsFcYw2aPgG0IP64jir8xYuR3f2T31vmz6Ay0sqXaNssKtLx5LdU/XA37MCx0K8kENdcpgKeZ/GBywidSDiR0T99DgJZWRSt1N/qjcqM3WUMBvSMSaT6o3I4tjZKsIb0v8uNYx0N1LYDuOJP8qDlEZ+oGLVmi8168Ty6vkcfI7wPBDt0SHcAupA2m17B7DfV0tnYa6lrnzOBQ+vhVlka9xMqpbY9Kuk7ih6yP/bfwg9ZAKFz/WCg4DaFgqC3lVSOhlzLKSH+kvYyqkqYgoeYS6o1XUHWXuPCKSm/MyIoK9FJRHamddE9wWoqnLo8GhlhRjYdfUeltqQurqLz3XlEZaWB15ZFSVnnDlFHADT3fHwJrQL0FJlkDmmWNY4D/Z4ZD1pkMnhmg3ua7LGYQMfOOmUERwcsww4XuJoZHFXqPTFIF+r/BeGM08kT9Mgga0Rt+F0Yj574+dfE0YqSRONANhut6446sYZsJ055Y40W7kSZrhQqmZl+/a29GDwV1vRnZDfXnvBqpKNMsNq0U2fiipOOboUinlwSr9+BOiL1fweK+6UlNUTa14XLiExx4vPHGCurBP8Lp8u7YUw8zXxOhwQOEOrw5djSlvSY63tDgYcPDD4nE9PLvjP4B'),
			this.addDataEntry(dt + 'grid style', 358, 642, 'Grid Style',
				'7VvRb+IgHP5rTHYPW1oorT6qO/dyu1xul9zjBRVts1oayjy9v/7Atmql3Wgtuk27LBGEFr6Pj6/8wA4cLlYPDMf+I52SsAO/duCQUcrTT4vVkIRhB1jBtAPvOwBY4r8DRhXf2ptvrRgzEnGdCiCtsMThC0lz0oyEr8MsY4oTn8jiVgcOEh/HMp+Ribj/YBaE4ZCGlG2KwtnmksU4o88k/yaikagzyB5FGCeryuZusrK2PhC6IJytRZG/wZT7aQmIumk1nwRzP6vmOlnDcZJmzLd1d70XHzIAysGAChi2aEsfWrUwwWEwj2Qybd0hRuAe9rpuFUYzGvG9wqPNJQvHeBJE859Zj51d1i8aiww7q/uUtdHK08E/mbShSDOSiNTvDElblxHQjBHgpHmMhJgHS1K4/zEsOQ2H7GI1lzK7my+m4R2n8Z8xZnXp0QIMlgNWrLDO1HmH0vQenI6romnXRTN7/g8aiGZtH37bA4XH33rFO9DZLCFcYWPbCy2CkELQCC8pCzhJagmpXCBFumDP8Xpe6eDeG/4Sj7ekleroVgpF8htMcNjPlLwIplPZ4K20QzLju5rfNql7DxhWFPKOGwProjBb5dxtQ5QxIzMiYJqIgaJH/9ZwtHBH5bi/IsUcq4IU3VakmN8mV2LXACteG6wkBLOJrxCyj/4+KxlRaeFcj9rSqKBIe+60y+bOdgi7dZF5xrrtMMa5mJdOKiJthpA5gnK1miSopxDUx4xGImtAokgAX8viVNfSIczaXCKfSgPisrvg8IXPUR1vW+29+htqxd+6tgHabettYebc4gmXkBvQXq++gQEV53w9c6TcwMF0aCMTuNuq3sZjIns99FmQcBIlJLpq7syas6FrgnyN6IR50dkVIYnPrDo1EiLGrdQcjSLK6i3jrnozoLeeEZPTCK2cQG8V8ZPPrDc1ZNIPBUTA+k7ChF797dx628bk2qVdI2pyAr01CIt8dL2pgZF+xH0ayX4/cbIUb5VXzZ1Zc9Ay4nEaEZYTaM67PM2VRE5O/E65i1deBba5twlTA4YiJYN7+actsMsLlQA1VFJLU7UUdNq9ZLedAe/YJhwlh/nIDWkSktjf3zt5Y+NzhOwB0sa9QQzDUnmovaevKQdgghY1hnHjIuuLyEIIiWdCR6FJQMhPYw9N9VOfx/LDGUfOazlzh1XaYU4NQzzScSCQ1eALqnwhyxk5o9f4Utloy+DPxZfuYZqSwxoNJi8fR3P6omsi9Zy8CkL9LWGv/fGf7zg61sFMZpnQQ9PDFZdj7J6RN1k1SnADAcwdxPW6PWMOYm5Gci/BQdRF/m/Knj+gf9Rny0ZlL27G/ENd1b83/6iA8HL8A2qsyI/1j+2M1q5/rAsV3pqTnG47c5Jj4uAQbLo8LyhljCfPCiVVR/H2eWl4Hi8dO5Xqse4O1nKlAio7RNnSeWavqB8Tx5mhxvo+50rUDOJEXcOfk6HPT5C60q8kqHRKOyc73mejRyR3P19Ki+//uuk/'),
			this.addDataEntry(dt + 'grid style', 358, 642, 'Grid Style',
				'7Vtdb6M4FP01kWYfWoHNR3hs0sm87Eij3ZXmceQQJ6AajIynm+yvXxM+CjE0JrHbNClVpdixwZxzz73cizOB82T7jaEs+k5XmEzg1wmcM0p5+SnZzjEhE2DFqwl8nABgif8JWAx8a++/tTLEcMpVJoBywjMiv3HZU3bkfEeqjhXKI1wMtyZwlkcoK/oZDsX5Z+uYkDkllO2HwvX+KIZxRp9w/U1KUzFnVl0KM463g8vdd1Vr/YZpgjnbiSH/xiselSOgOy2nRTjeRNU0z6kWjvKyY9PMfbl78aECoB8MKIFhi7U8QGsUJojEm7Rolqs7xAg8wmDqDWG0pilvDV7sj2JwhsI43fxV3bHz0vUPzUSHXc39u1qjVbfj/4qmDUWb4Vy0flZI2qqMgNMYAU7ZxzBBPH7GnfOfw5Jzoskm200hs/tNsiL3nGa/loiNpUcJMNgPWHfCrlLnvVu2W3A6noymPRbN6vo/aCyW1Vz8LgCdy9/53TPQ9TrHXGKjuQslglyJoAV6pizmOB8lpH6BdOmCgeMHfq9xt8y/wOOYtEod3RVCKfiNQ0QeKiUn8WpVLLiRNsFr/jLzz33r0QeGFeX659nAritMrZx7OkSZMbzGAqZQGIoa/U3AUcLd7cf9FSnWWHWk6GmRYn2aWolTA6z4OljJMWJhJBHSRr/NSkVUObjWo7I0BihS9p12n+/UQ9id55pnbKqHMc6FX3pTESkz5JojqFarSYICiaAHxGgqumY4TQXwo0KcHLVUCLP2h+inRQDixe2Cwwc+R454zbRLjW+ulvg2tQ3QblvHhVlzi0JeQG5Ae8H4AAZknOt85ky5gQN3aLsmcLdlvS2XuLjrecTinOM0x+kozZ2jsFefMm9Yczb0TJCvUJ0wLzp7oCRxzaqTKyHCbgvN0TSlTH8a1zDyKbABgQVGoppCLeUUgc0eiz9lgQ0UTK5ZYHKN5C01ZdLgPT0G31TB9OKupU7BMcFZ1M5zjxSpFq49c5XlcEKZwpJ5GF1/VZQDMEGLXKj44rnWH6LLdV1xTehINAkIuY7wIKtDU8A4gcf+QvqZfq1m7nCKHubkgsV3uowFsgp8QZkv13IWzuK2+FJ98WHLtYcTnFeE0g39rRpERkbys8t3vn77r6tDjnXgySwDegAKdYLbDuzQNuGHgFwn+AIBrCOI50+DjxdBSmO68ghSC6TF3E/Knj5e/Hg3tlTjR8/+hguLH0MQ3lD8GJGRk7gnA2l7rO47OFulnHlOANnWvACr9vHtHGXa82pOk2eCvolksWcjw2cs7+IeGMFdS5KeoJgov7RuJ+knvrm+rN0Fb/EqtGd7gQilYVUidiy8RUlG8H1IE5VofmHPXreQvfdsN/iBWU5TRFQYu7Dnr0vP33v2DnzGk46VO64JK4dyTi5M7te1OKrxmwI+nqOCcnr/QZPE92JLeQ+8nI5rd1KNWvQ6qV1nwjEEnakee3dMPFpBLan6EoVPYx6BBxJHZeOGRxPD7suk3gy+75lY0+Z3v3N1I3vf4Yj8XcyMs7w3hX83hq6fIIWk/lWX9p7s+NdGj2i+/NatHN7+Kdz/'),
			this.addDataEntry(dt + 'two line grid list', 358, 642, 'Two-line grid list',
				'7VvRcto4FP0aP8LYMtjmEUjTzm7SySSd6ey+7KhYYE1ki8oiQL++kiUDjgxriA2YqTtt0LVkyffcc3S5VSx3HK8+MziPHmmIiOV+stwxo5SrT/FqjAixgI1Dy72zALDFXwvc77nrZHftOWQo4VUGADXgDZIFUhZlSPmaaEMI0wjJ7rbljtIIzqWdoYl4/miKCRlTQlnW1bWzS3bjjL6i/E5CEzFmpKdCjKPV3uVmJr3Wz4jGiLO16LLEIY9UD7cfqGERwrNID/N6euEwVYbZZuz27cUH7YByZ7iGMxyxlqFrH+UTSPAskU21uuN8NKUJ3+k8zS7ZeQ4nOJk96zfubU3f6FwYHD32Ra/Rztv4l2w6rmgzlIrWd+1Jpyoi4DREQE/ZGCKQ4zdUeP5HUOqdGLLxaiZp1p3FIelyOv/vB2QfClW33DHFAWvNwm5ftXfc1vNMrznHek3P/0SxWNZm8s4AFKbv+MUn0Ok0Rdzw+uYtKgHRN4AYMbpM0VFsKWdBkTIgu0ojeCfGgW3y5z673pOlI9kgwcUTSIaarjEOQ7ngDX8JmvLtyIesdeeDhmnT9z8WAOsi+2oF3KuDeblbC7gXpC67k4Nc2d/9cn8f4J9Txj+vFv7l3MjpFzSAhl8HGjFkM5w8Ky5KSj5mBu34rUERp2jTlOgAk7GjO/lnH73FSkK61MsyOa0sX3JUatyoHH9QAnng1kK5wGkA5MAAWSIB7Aec8rQ+vBW8vYItzzUkvMsIc/QilFA+cCkedyBVeS+sXD77varu5ib9rcrKprdtjijnNM7fpyDh3oHMisqeXMIC+vti8MRkyD8txnynoWRoYMTHMOERTeSi7hlCMUwsIJ5i/4sSI1zEi/IjwS3uhhlWezfSXYydZl3umy7XX3w+ymrXa4DVjn1p7c7Jfe3ivTqwfbdOzB3HZCvhiCVqpY2quWbsucU8uGYxVzS8IjV3zHLMF9EjooskTJWO3yOCV+LndwminC4Jxb/dbrcBdQ/OoO6VMGibvJuFpAblvSVp+OaLGAgqa/mxPDunlptlqDuYTGpX8fJt+zpz8uBCMr6nEPd/8eUNmpJxszL2iBmMhOlx8hVhoqT8CS7kqK94Rduam1dyfdvUu5YyV1X1bmsifmtyblbTPhEBEqMJnjSr6ZKv15uaX0rTvWvT9JJKnAyO1UqJ+VC8PZQDntEbfpOf2pmOV/F72wTdLJI1KOhtS8f7nn8D+g3MitqTLJT/ScbPLdyDKxNuYBbdXha6KD6Csnjyl3j5BuT6LPl3FW+3TK5zdf6Tf1fKv29Ev82S2bMlo9SD8TxznT1qVs2vukB+ITHfF4yXE3Oz6jZilL6SdSJz8KzvC4dMF8v/FqPlettbHq+EQNsE3iyPPciVp1b+3xljGCMGFf9JTiDRnGxA8X4u5BFZ4UR3kF27ph2Yc6N8QGepHTQUXRLKYvktbTvKm8mf/ywSmM8qXkRNrG6doD9zAteImSHlZde7MHHztp7BMYWkJMWIeEwKW05dBzw3O47jgcKe4xj7jRAjMwT79YRgZ9DE4amTz7IdcWxxo9D14rIfhbLzhL2gHhR6jaBQyxm2H3DyakCyq9uHT2AffdIQ7KmRbAgDjBzNzNB6JQlaTWd//cLsjRz9LTmXZgCXYyVG4nmKrgqh2weoQs3roKRdEh3/1uARze2v9Kjuu7/x8xs='),
			this.addDataEntry(dt + 'two line grid list', 358, 642, 'Two-line grid list',
				'7Zttc6I6FMc/jS/bIQmCvlS0u/fOdm+n7cy+3EGNklkgTshtdT/9hoegkGARsGuZ4nRajgkP55f/OeGQDpAT7L4wd+vd0xX2B2g+QA6jlKd/BTsH+/4AGmQ1QLMBhIb4GcC7im9B8q2xdRkOeZ0OMO3w4vr/49SSGiK+9zPDyo08HDc3Bmgaee42tjO8FMefronvO9SnLGmK1skWN+OM/sLym5CGos80OxVmHO8qLzcxZdf6BdMAc7YXTV7JintpCzQcpd08TDZe1s0yswt3o9Swyfse7l78kTlA7wykOAOIa5kg4yyfuD7ZhPFuenVlH4Gxbc1glY/WNORah27dJQk3j9kdmwfTM90KA8j6PmXXaMh98jveBUjsMxyJvR+ZJ0FdIrAZEWimNoZ9l5MXXDh+G0pmwyEb7DaxzG43wcq/5XT7c+GyVkMV6R1T7LDPVHg7TPeP3GZaqtfAuV7Lzv9Aibis/OQ3Y1g4/Y1dPAJdryPMFa/nd1ELxLBd7NCP/6JYIBhbd+8/dgEw2mHYFzXQqdstxe1P2GVLT9geMN0K18cx33KDbeIl48F3lzhqoJHAZRsSPqa0Ymj3iUE0s2riy8NXKaxNk48mRJXC3NBojn7YMJGcS75u2LK7CFtRSrrsfeFSK9lKCDIqaWPpQVjXg5begyciGtBpadRJRIOlgDa+gLJGXSB6oWSJaxM6tneLqXYaAkCTvFvGP5mGbKNITcbVTrGNu1EW5yLyRDUjWw7tXRDpJgrdyOoGFc9+EV1J6scp62E+F7+N2T+Tbwot4crjifRS+BEzNYvcJZtm4hvTIEvXn2QHCMhq5eNSujE7Ty37QoeCwsYqQLMlQAlMHqdbYkAh9jh35t+fn/oCayfVhsRWkEAv+KnP9c5/358nTg8Bijhs9w+gWou4pwsST+5L+E5XZKaz+FOV1ETfFX3NOMoB4OM112BdUM5pcJijy2Sa7n1LOs2AdTBNsw6z0YnBpI6J1PJVgurwUQ/YuukpsjoZBgANLzEM1GKH4CEMDg1DyqLiox4a2wjl/lIl/uoRjp8Endj8KuY+bxecjrnWFrrHA79A82zNg4raSrXCdWzbzmJzhV/iMR6o5ZNPhTdReJ4INI82tibuX7ni1fLOZLHA8Y06HiMRx2GEw6vXfT2Vnz2R1vG8bpWrZZ9PlTdRef50LHRn1gv/Vy50tdp07ya3+i/1woj2ReN2/zO5WoD61HgXmfwtzX+45A7VQtiUEc5dYftKfd4TyY97n9ahWh+7nNjfL7ea0Br1IbdKGv3AUxkWK3B9vLCoFrs+MK4cj2UasJ6a7G5i3YXo1Fhw83HoVIqpgpZGTNdNq8aqHElL9CTbCFeBqVqLcwH3q3OCoead57BlEJPvPOWL/vyttJzBd0tCreQoJGoswqEMV68WrFhuU4/Q6RcrsPjqHmgyjQaRvMc2K2UaL5U5Y2GZkWzNC9SnY786nLVrja76DVQ3q2EW7vKXgqSwMqyCS8PFMLCi3JDHHViO+5qqsami6mpdZvFN5UWWZdZZD/NWBvibhHoPCKlVgEpA2pD2N+nYfcMjdg//bpE2P/5vjD8=')
   		];
		  
		this.addPalette('gmdlGrid Lists', 'GMDL / Grid Lists', expand || false, mxUtils.bind(this, function(content)
		{
			for (var i = 0; i < fns.length; i++)
			{
				content.appendChild(fns[i](content));
			}
		}));
	};
	
	Sidebar.prototype.addGMDLIconsPalette = function(expand)
	{
		var s2 = "dashed=0;aspect=fixed;verticalLabelPosition=bottom;verticalAlign=top;align=center;shape=mxgraph.gmdl.";
		var gn = 'mxgraph.gmdl';
		var dt = 'gmdl google media design library icon ';
		var sb = this;
		
		var fns = [
			this.createVertexTemplateEntry(s2 + 'edit;strokeColor=none;fillColor=#737373;shadow=0;',
					20, 20, '', 'Edit', null, null, this.getTagsForStencil(gn, 'edit', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'star;strokeColor=none;fillColor=#737373;shadow=0;',
					20, 20, '', 'Star', null, null, this.getTagsForStencil(gn, 'star', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'heart;strokeColor=none;fillColor=#737373;shadow=0;',
					20, 18, '', 'Heart', null, null, this.getTagsForStencil(gn, 'heart', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'reply;strokeColor=none;fillColor=#737373;shadow=0;',
					20, 18, '', 'Reply', null, null, this.getTagsForStencil(gn, 'reply', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'users;strokeColor=none;fillColor=#737373;shadow=0;',
					24, 16, '', 'Users', null, null, this.getTagsForStencil(gn, 'users', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'gps;strokeColor=#737373;fillColor=#737373;shadow=0;strokeWidth=2;',
					20, 20, '', 'GPS', null, null, this.getTagsForStencil(gn, 'gps', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'share2;strokeColor=none;fillColor=#737373;shadow=0;',
					20, 20, '', 'Share', null, null, this.getTagsForStencil(gn, 'share', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'navigate;strokeColor=none;fillColor=#737373;shadow=0;',
					20, 20, '', 'Navigate', null, null, this.getTagsForStencil(gn, 'navigate', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'chat;strokeColor=none;fillColor=#737373;shadow=0;',
					20, 20, '', 'Chat', null, null, this.getTagsForStencil(gn, 'chat', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'voice;strokeColor=#737373;fillColor=#737373;shadow=0;strokeWidth=2;',
					12, 20, '', 'Voice', null, null, this.getTagsForStencil(gn, 'voice', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'google;strokeColor=none;fillColor=#737373;shadow=0;',
					16, 24, '', 'Google', null, null, this.getTagsForStencil(gn, 'google', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'video;strokeColor=none;fillColor=#737373;shadow=0;',
					24, 16, '', 'Video', null, null, this.getTagsForStencil(gn, 'video', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'gallery;strokeColor=none;fillColor=#737373;shadow=0;',
					24, 22, '', 'Gallery', null, null, this.getTagsForStencil(gn, 'gallery', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'birthday;strokeColor=none;fillColor=#737373;shadow=0;',
					24, 22, '', 'Birthday', null, null, this.getTagsForStencil(gn, 'birthday', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'cloud;strokeColor=none;fillColor=#737373;shadow=0;',
					24, 16, '', 'Cloud', null, null, this.getTagsForStencil(gn, 'cloud', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'x;strokeColor=#737373;fillColor=#737373;shadow=0;strokeWidth=2;',
					16, 16, '', 'X', null, null, this.getTagsForStencil(gn, 'x', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'bookmark;strokeColor=none;fillColor=#737373;shadow=0;',
					12, 20, '', 'Bookmark', null, null, this.getTagsForStencil(gn, 'bookmark', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'calendar;strokeColor=none;fillColor=#737373;shadow=0;',
					20, 20, '', 'Calendar', null, null, this.getTagsForStencil(gn, 'calendar', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'attractions;strokeColor=#ffffff;fillColor=#737373;shadow=0;strokeWidth=1;',
					22, 18, '', 'Attraction', null, null, this.getTagsForStencil(gn, 'attraction', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'dining;strokeColor=none;fillColor=#737373;shadow=0;',
					18, 20, '', 'Dining', null, null, this.getTagsForStencil(gn, 'dining', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'education;strokeColor=none;fillColor=#737373;shadow=0;',
					20, 20, '', 'Education', null, null, this.getTagsForStencil(gn, 'education', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'family;strokeColor=none;fillColor=#737373;shadow=0;',
					20, 20, '', 'Family', null, null, this.getTagsForStencil(gn, 'family', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'health;strokeColor=none;fillColor=#737373;shadow=0;',
					20, 18, '', 'Health', null, null, this.getTagsForStencil(gn, 'health', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'office;strokeColor=none;fillColor=#737373;shadow=0;',
					20, 20, '', 'Office', null, null, this.getTagsForStencil(gn, 'office', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'promotions;strokeColor=none;fillColor=#737373;shadow=0;',
					20, 20, '', 'Promotion', null, null, this.getTagsForStencil(gn, 'promotion', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'radio;strokeColor=none;fillColor=#737373;shadow=0;',
					20, 20, '', 'Radio', null, null, this.getTagsForStencil(gn, 'radio', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'recipes;strokeColor=none;fillColor=#737373;shadow=0;',
					20, 20, '', 'Recipe', null, null, this.getTagsForStencil(gn, 'recipe', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'sports;strokeColor=none;fillColor=#737373;shadow=0;',
					20, 20, '', 'Sports', null, null, this.getTagsForStencil(gn, 'sports', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'travel;strokeColor=none;fillColor=#737373;shadow=0;direction=south;',
					20, 20, '', 'Travel', null, null, this.getTagsForStencil(gn, 'travel', dt).join(' '))
   		];
		  
		this.addPalette('gmdlIcons', 'GMDL / Icons', expand || false, mxUtils.bind(this, function(content)
		{
			for (var i = 0; i < fns.length; i++)
			{
				content.appendChild(fns[i](content));
			}
		}));
	};
	
	Sidebar.prototype.addGMDLListsPalette = function(expand)
	{
		var s = "dashed=0;shape=";
		var s2 = "dashed=0;shape=mxgraph.gmdl.";
		var gn = 'mxgraph.gmdl';
		var dt = 'gmdl google media design library list ';
		var sb = this;
		
		var fns = [
			this.addDataEntry(dt + 'scannable list', 358, 642, 'Scannable list',
				'7Vtdk+IoFP01PraVgJ+Po07Py07V1HRX7eMWGkxYk5ABHNv99XshSWsktjEm3Y52umwFgdzcw4XDETp4Gr18EyQJvnOPhh38tYOngnOVfopepjQMO8hhXgfPOgg58OqgxyPfuuZbJyGCxqpKBZRW+E3CNU1z0gyptmGW4REZUF3c6eCJDEii8wVdQPuTJQvDKQ+5MEXx0ly6mBJ8RfNvYh5DnUl2KyoUfTlqrsnKbP1GeUSV2EKRDfNUkJbA/VFaLaDMD7Jqg15mOJFphv9ad/f08CFzQLkzsOUMF2z5gp2zfEJC5sc6mVp36CPHGY4Hk2M+WvJY7RV+NJcunJAFi/2f2RP3dlnPPIEMN6v7lNno5Gn2n066GNKCSkj9nXnSrYoIqocI6qV5goZEsd+00P4lKPVqdtnoxddh1vUjL+wqnvwzJ8KGB83weDS4qAvjcocVK2yz6Oz20/SeO3sD25vuud7M7v+DMzDr9eYPY1S4/cOw2AJfLiVVFhqvT1EJoL4F0CMFNLTxxKPirGAqD5LDiBoPRqPSDr4XAsg5HV5pLD3oYNEYswUJv2TRHDHP0wa/hndIl2pX8y+Tmg1Ry1HVH17WD7bF4GwU90ETgZkIuqTgpgWVleHvITyp6vd+ud/fCMfcV4VwHDQSjnkzeTSOWkBl2AQqAAoEV2Ahsu/+Y7CkNfKorBwgR4CqPIq6ZaNoM7A9DPrt4zZqAjcwQ8Ho9K6hVBmhfnsA5THbJkDj0wDVYsvwDTVXCqrHNxnC78vfXAc3MtWM3BZ87zqW82dkm1KMJKHw9F4XUs8Bhf+KRgmVykDDTDOC+IaQbBi4ADnr2GMRi5mJpkMMwbUau03AFH2CyV5nbyDCbDbhmKuEOyhNKw6Jwz477++IhE4OdskJV4pHeYgXWIpem9TtE+OTfQL1Sqa9gXNml6jK6V3XwnPKRWxAmlO61OYLLhdsDe6AhC84gNbtds+Bq0jV9r2cL6v28zrli6hjmJ/Gq//ucKFz4SqP4F4bo6drKw86qB2Iw3fFFNmYjs1125gOURuY2gJKDc4SEeGz+Gc6ZeqZ87vJyMHa5WSgpwPhwdw6mem/i5bxRwB6OQBnn3Lmnbp0Hr1ofKwgenySDagwamNh69qKBjALobnFJn2T0Jx+gxlewjvXExaBF5CASH/UJsacnzW0/bnsIu2t10QvbGniOTDrImCHmk/Q+F++vQ8uURecqyYTtsjhavNtrfEmqcQHQ9oOl2hE/7gWLnEMoY8hE5/KRaV+jUZt/DqCbOnicR3riUjwRM/rejqSC3C/vBO2cG1iBLLFiFRIis3NwTKiicOCR/AY5tahtvfXmlGlVaenlAwaEqhMRUlYKHdskfiExXciXdRFt6G5Kf/tvtkQLtEu7olu3KB0UbL340+mG9ekXVTZsPFJN6DxcStjla1d/OBiBTkh11IrzE1rSXwzSwUkXgEiCBp1VoyGcyK1iDEnC61c5EK8YPM7YSbo2nSMki0WM7GOJPhRI6rWYkW3Bkm+Ds1WG0f+WsMT3c0vJXUhu2Z1o2QLB7ojuvHBkLZDN25K3TiG0MfQjZtXN9xmhqrxgbMb6djYVjemARXmyeYhl5JHeiFsmAekYbS4DyZxbRoHtjWOp0Rof0AZaaxIpYrYM7qF/mgaWMV8cz9s4gbFC2yLF/ie2MQNihf4psSLq9p4geueNjnr/EI2ljVLJLaFCqdoRb5yubB/P7SyAsK2iFGjg88JrJJLWN0r3zuGS80d7PhtWux0UXEbeeku9rLDBw2dBRoW7t7KUSBc4UxIjhXUZImkV4XQ7QNU4XjIm0PaR6IzvDV4ILk7+psW3z8Z/D8='),
			this.addDataEntry(dt + 'item list', 358, 642, 'Item list',
				'7Vtdb9owFP01PLZK7ISER0q7TdM6VWulPU4uXEhUYyPH7WC/fs4XJHVoDdgdGqSqhI3tOOfkXDsnlx4ezZefBVkkt3wCtIdvengkOJflp/lyBJT2kJdOevi6h5Cn/nvo05Zv/eJbb0EEMGnSAZUdXgh9hrKmrMjkilYVE5IlkDf3evgqS8girxcwVuNfTVNKR5xyUTTF0+LIm0nBn6D+hnGm+lxVpwIhYbl1ukVVNdfPwOcgxUo1+Z1OZFK2wGFcdksgnSVVt35QTZxkZcVs3Xdz9epDBUA3GFgDw1dzGWJvJ0wITWcsL5aze40RusaDuL8NoylnstH4U3HkjRdknLLZj+qKg03VA1+oCr/qe1/N0avL6Z+86GNVFpCp0s8KSd+UEbQfIygo6wRQItMXaI1/CEvBnrfsfDnLZXY5m0/opeSLX49E7EqPEWC4G7B2h1WlzsuwLDfgDPo6mv6uaFbnv+Opmtb65BcD1Dr9RdQegU+nGUiNjfVVGBEUHhZTunXRZgkPgmgQffg9HUaHsbBqS8Mq6n0bslgImIKCaQyZIRPrkG+Ee9iN+xtiqLFqiaFvRQz1MLUWYgesRDZYyYCIcaIR0kS/yUpFVNm4lgY6kCLj6OV3RS87hF30Q/eMxXYYk1KtzR8qImOGQncE1Wp1SdBAI+grYfmo3h2Ip5Rlh682+qrS3EsF+j7NKw5Vn1OXjgkdVpvAeTqZ5NNY7wopTOVm8/atKF1Hxurcd+EKrSxcse+AT9+zojhZ7OZM1Hattg/9G1PEB7svWVgnoB7Z8pLlOyHEt0HIcwamhMRe/ncgIcbhD3csUNhS/Au9V/y4CIC+/tB+SwoMvvKEZZydA6CrAOjXN4pdQnXj4ZgE52/B/IQUp3sOdyAV3MgbEUGzs+Zcam7gZJHb16X4IM0FJ6853dB4EPDCc9F9ISyDs+ScSW5tQdpl1IoZ4k5y/ZOXnIH3UXNC04bJ1MAcikOzn3zrXu2yJgJ59QNL8xks7iAjtiIO7DkRh25rDInI9xXeFTAGUp7Dnatwh2vwrTKKdF9jqHGoQJFtHlAHD2vHYisPr9/91byMFcRFvDQLgXuYHR3+/M6v/gzNDuSCpeM2O7YxcjqLUs1HU0aPj5CDMEpEmkk47wWdBsfIxdvKjlyLY5LdO5uOU5Cdbnmo+zsXHWeMi/NLFmeCC5CT3chx+x3o5P2OjgSOIVWIIe870LPB6FJwsZMV7rjdDnTybkdHpseQyYSzHIZ7CS9wTiVwJ7oQO1nldBflqEQXn7ro8L7JHjskh64VZNdwXLU6vCeTwI7ZeBE4YcGK6fFIxk9dFnBnUmKTlz0zE8t75y0nuJ0e2Jmd2JVOaim3Omrrx0VqNdbNEI24mivVM11kcFQM/f8EGfgab4a0f8lO9L/Ro4qbn1KVzZu/tPoL'),
			this.addDataEntry(dt + 'item list', 358, 642, 'Item list',
				'7Vttb9sqGP01+dgKg9/yMU33ommbqnXS/XhFkyexVcdYNu2S++svfiG1i92RBLposatKAYONz/F5wAeYkPlm+ymnWfSNLSGZkA8TMs8Z4/WvzXYOSTLBKF5OyO0EYyT+J/jjwFmnOosymkPKdSrgusIzTZ6gzqkzCr5LmowlLSIoi6MJuSkimpX5OSzE9W9WcZLMWcLyqihZVUdZjOfsEeSZlKWizk1zK8g5bAebW2U1bf0EbAM834kiv+Ilj+oSxAvrahHE66ip5rtNw2lRZ6z3dV+eXvxoAOgHgyhgOKItM4IOwoQm8Totk3XrXmOEb8k09IcwWrGUtwp/rI6ycEYXcbr+0Tyx+5L1k2Uiw2nq3jdtRDId/1cmHSLSORQi9U+DpKPLCD6OEezWeTkklMfP0Ln+KSy5R76ym+26lNn1erNMrjnL/n2g+aH0aAFG+gHrVtg16rz26nQLTtdX0XQORbO5/x2LRbP2N7+a4s7tr4LuFdhqVQBX2Ng/hRZB3mkxpV8XXZbI1A2mwbu/015wGgu7rjSMou6bkEWWwwoETAsoNJnYh3wt3L1+3N8Qg8SqIwbfiBjkZaQWQgusBCZYKYDmi0ghpI1+m5WGqLqwlAY+kSLt6OX0RS8zhF35nn3GQjOMcS765ncVkTZDnj2CpFptEjRVCPpC0/Kq6A7yxzgtTu9t1F6lPZZy1XEaqg6RX1IXL2gyawaBm3i5LJuxHxUmsOIvg7evVeo20FbnsR2XZ6TjCh0LfDrIiOJ4NZrTUdutGD74H3QRnx7eZRGVAHllw12WY4UQxwQhTwXoEhKi8u9EQrTDH+npoIih+OehV/zYCICO+tH+jVYYfGFRWrB0DIC2AqAjXxSzhKrGwzkJzhnA/IIUp3oOd8AF3BjNaZ4Uo+Zsam5qpZM71qV4J825F6851dD4mcMzK0X3maYFjJKzJrm9BWmWUSNmiD3J+RcvOQ3vQ3KSxC2TqYU5VIdiPznGvdqtJAIj+cHS/gYLe8gIjYiDICviUG2NGc3LcQW6gTQFzsdwZyvcEQm+UUax6mvMFA4FKLzLA+7hYe9YDPLweu5P8rIQEFfxUi8EHmF29PjzB0/9aZod2AZL5212DDFyOZ2S5KMto4cHKEGYR3lccBjHglaDY2BjtrJnrcU5ye43g45LkJ1qeYj3uxQdS1OWj5Ms1gTnYiujkfP2O/DF+x09CzhmiUAMo++QjAajTcGFVnq483Y78MW7HT0rPWYpj1hawnDP4RnGpQT2ROcRK72c6qKclejCSxcd0Vjs8aas2hbj4OrziC7Zr4kxj1G1Fx2/b8UzOtFglEw4QdihQoJmlgnV+PgBKxGuIoWQxqQaDEhNBJKS6sQjx38V8rzjneAahzdDVi8xHj6QF+0NA6o38RmSbFJafz7dZNWDoRXA8oEuHkdcB7oCbOP1Vg2Ge7koc+ShlwcH2RgHE9VIuC/xxYg9qXMaIxV1Bc/GHBN5h50Z++Gr2dm+XafC78aorpmZvivXyhDIyE6NqkPR3RHQ5uXIbQHk7VXn6Bp31+b3bg3o28thaGNT0Lm7lX1NROOLXnIlasZZAWfF0N9P0AHrF4Y+Lv4YO8HfRo9Ivuxjrou3tzn/Dw=='),
			this.addDataEntry(dt + 'item list', 152, 631, 'Item list',
				'7Zldb9sgFIZ/jS8nGWMn8WXjrt2kbZrWi13T+NhGwyYCmo/9+mGb5qPgKlvKLiocRYIDB/D7oBwOiXDR7u4FWTdfeQkswh8jXAjO1VhqdwUwFiUxLSN8GyVJrL9RcjfRiobWeE0EdOoSh2R02BD2BKNlNEi1Z8YgG7LuiwJWesilVIL/goIzLoZ2DMOjWyrK2Im9Gp7eoyEl32oj0hUzHwgFu8k1Dyaz4HvgLSix1122tFSN6ZGZhTZA68a4zbAZi8jRUB98jxLoglHBrQi2FPnBH7nili76BXo9+lehK8JuGK073dLSsuy7LOWarGhXa1N8rH2Bql8smvV68U490N/9cCjTdQFS136al7xYrOTfxMqy0SaAEUU3cDb+NQKml28pRjt4dUv9X0lQ/JeSmCm+c6pnTuK9UTY+9+BVJUFZEh4WdpGqmaXqjaCEvbddmS7eBkHmAcHMQlAQRh8FDRCcEFCMPVCYOyi0GgIJFNwUMuSBwsKmwFu66gGQTgYUbhR57gFF7kDRSc5IwODGkKRzDxieDw9nHISkm/DDNIEh9xGkEXJgeBIUhDZ+g22A4YSBUx+xGtnp5a3gujWJH0KYmGSR+4jYyE5sDyxA0CrAcMJIsY+YjewkWQ8g6nCKncKw8BKz7az6E7AN9EoP4UJbAw9ngo29BG87xf7cagVVoOCmsPASte0U29L/1Uvhjg/Xei/ug5fD50phzx1OZE4dIl95nWfm+vB8pDSiz99g5+vq8Y5/7H76F8Af'),
			this.addDataEntry(dt + 'list style', 358, 642, 'List Style',
				'7Vtbj5s4GP01ecwI21ySx4RMKlWtVG232scVA06CSmIEnjbZX782lwSwIQRsRh0N0UixYxv4js/5LjAz5B7PnxIvPnwlAY5m6HmG3IQQmn87nl0cRTNohMEMbWYQGuxvBrctv4LsVyP2EnyifSbAfMIvL3rFeU/ekdJLVHQEXnrAfLgxQ+v04MW8P8E+W3+9C6PIJRFJsqFolx18GE3IT1z+ciInNmddnAonFJ9bLzfrKq71EyZHTJMLG/I7DOghH4GsRT7tgMP9oZhmm8WFe2nesb/Ovd09+1IYQG4MJBgDsGtZIeMhm3hRuD/xZn51TRsZSwetnttstCMnWhm8zQ4+OPb88LT/q7hj89b1N4lZByjmfi+u0Sjb4X+8CRBrJzhlrX8KS4K+iMBhiEAz70tw5NHwF66tPwYlc+CWPZ73nGZP+2MQPVES//viJY/C08tgSG6w+oRLwc4nK29XzGnaojXBo9Yszv+NhOyyriefL2Ht9HOnvgLZ7VJMBTSud9ELIGucpsh50URpsXFXk+9pAO1xMFzq3FBqdlsFL+IE7zCzk4/TvlAsTMs2+hreumv40jY1u480+7m+TImCoQEFR0DhK7/BbRgxizbxYJaidaHm137PCeSKP+eSzq0d+l60KnzOMQwCvriEF6VbivCO3tb6krU2DlQHoBpvICeOrQOyhQripNhL/IPAmSpBqsQpuJQPLmEaC0J9QgUSIPMoajg1d5B+Ui1VIMTdy6Si1g6HzLUoggOZ+uEAhoDHlkQBTkSFG+3os4P1E65XlN8VNProW1MZKRfNuoLakhi5Ib12djRiayA9/1BBHRiKWJYSQQWWlg0C7hO23AxsZhinuOd+AKsN7K+T921rGqJpy76x0caixkSAtFh6aAJfj/qiV1EZqzI40E+Blmy+mHFNfjqSISALBxUlQ07t7FpyISDWFL4dCCVvqZRVzXNEzbsuJJfQ+3FkPUzVnZPZaoQQGpYO+MVixWfvxDpYRMMmG9AoR3RmBcAUYVpa/NOVAxQ4rAml5MhXEcCBOjMF0FIHuQcoGim/JaBa8OxR2xjm2K5wqrLtdJ5tqcPQSqoZuywqFY3tbt1nd1yRD3QH/X1cm7TSsVDj2sq4oPRtQEvwIRY7BoAUnnakgw9CUHIFrxm7j2LOm+TOjWSt9AVqQRLLG26CPYpbhasIOurI9ZCw69OfKjD2EM/V6YEyZzht3dccycrSJTlaWChWRzbEfz3ym1YdZF4h7o4qJaC3RpX9QNeeTyuCGJV0UwoxFAsuA4Q2IL6IqAkX1taU6eyt7Dww+VvKkehK9mSFMTUesVH7n+sIWqBY9vgeM60NGDL4g4zTk9G2daCspOSSVjaGmMtvlxtmFw2kbHu/4h2TUqzA5MXqDz5OzUdTS4Cr5oWQtlRxveEfLVRsyUS6Mkb4Z1PxgepJFFYekFas/pIdgtVBn8KnToooYoitowgteTXkRxwRL+C3XlSjDWZgNiIMsIba9Icy3sN9oSMzlLyMMkAZX/OtMqUy2o8ro75aGmg8JtKijGKR5keKWYfrHXHifRByakJaUEser+RFFj/fE1MScqGGkM4fQ0g0tOIy5Imt2kjlUpswEV/mpg6+oB7vkdzny4vn/5Sx4lavbsFlIFvyvdPxaAi++9ceUI8ayb3npG+J0PsHSKyKtAIklbS3RMd5b/Cw5u1fvvLh1f8I+x8='),
			this.addDataEntry(dt + 'avatar text icon', 358, 642, 'Avatar with text and icon',
				'7Vxdj+I2FP01PDKK43zxODCwUtuVVtuq+1hlgyHRhBgF7xb662sn9gzBDngTm68haKSJsR3nnNx7j29sBnCy2n4q43X6Gc9RPoDTAZyUGJP6v9V2gvJ84DrZfABfBq7r0L+BO2v5FlTfOuu4RAXRaeDWDX7G+Q9Ul9QFG7LLecE83qSIVXcGcLxJ4zUrL1FC+x8vsjyf4ByXVVW4qA5WjZT4FYlvClzQNmN+KVQStG0dblXEx/oJ4RUi5Y5W+Tebk7SuAf2obpaibJnyZoHHBx5v6oLlW9v3u6f/cADUYEAJDEDH8gydX8IkzrNlwU7r0R1i5LhR9ALaMFrgguxVnlUHq7yOk6xYfuV37L0X/YXXtADwtn/yMTriPPuPnQJIz0u0oWffOJJAlxG3GyOuV5eVKI9J9hM1+u/DktfxkV1tl8zMnparef5E8Pqf73GpoGcUwudpr0cYqgFrNthx63zy6/M9OL1ARhP8Kpr8+l9wRof1dvHhyG1cfhg2e8CLxQYRiY23u9AiyO/nU9R2ccASfB7NvLM/08AN+tGwa9qGUdgDE3axLtECUZwStNGlIvL8wNEF3j8JvMCmgXtP2LfNbgQLjgUWQomFz+wGZ1lOET3kgyJFmo6ajf1UEKg9/pC5dIZ2lsT5M485q2w+Z50r7EKEpRwtyHtff1RnL6FrjkAz0UBtOIENyiIThrNBcZmkks3sG8i+4XBbqisLmvqS0GywRwlQRRQzNjUMoX2jGplgiIWXszq1djpUocUQHdCzTwdwJD5mOJ+jUvZwvQI9Lzrpyw69IGEOsuktA4UePnCzQXUc6GigvH5X59lRdvi+EecJfCsPAzhtnIJ42jJbb5CmEYKIxz1D2HqODK0o66ssoobVAWgF6a6T9abCy3/IXpC5vHEYhEH3mARaZu68xdtE58jEB6ikn6GJT9i4upV5D5DzB19STPC5vOK+fwtl/+ZUR6u7PK0Pm/LT9lwrMOP0XMe3QbWchPgtLmgBVSq0seM6osZRtQ88maaRzz7HtD3nYYwJwSvWi0SOa3MGAFryG6cIhT1drSDUCp8aOYtuQWzsso9BbM8XxUY2gDaSpVhUatNO/vm4mNcJY8oMRmQmjAkNIOIYsCI05CRGB5KyYoGP2IMkQCazyXQyVej0XpZzkTnxwSRMxAKzJMlpi68oydaKNNNDbpxPboRWDFJOgNRyg1nq3euN6P70hitnUC6jN05je9t6w9XITlxUb9RPwsfWG4KTm9IbLZZzt3pDsTriGy5fH2LjcmIDQiuxqS23wV6U3bvYaFu8cdNi40qSGxrY3rjYuPbkxok3lR9DbNxgckNvSdk9iQ2NNRmClzwrZH9FIZ8G7NMzkvMGYla/Ey7JkQ0jUr3Vd9rh1V3vqFj9oF5N9HjXfj3v2j0rvgvKaYO/44SOEzN9lhFqCWXMn66HJr+IJvcCGxIOymkMrsmd+9fksCVFcsuaHGqkPLppcheMgpm2stDA9rY1OZTTFnrusSH35jjRFuT7HHRcSwOPqxGttTQqNWJIp48aVx9aoc3ILo/zqvQ2W7pblQ7lxMLvGUlSVFQ3sKo2tD20yMW0iG9lGSKUsxz8ZeRH0CId9z9ctRbRyIh00yKz0WQKXgxie+NaxMxOkxQhO3tv6wfhQ8sOIztNziw7rmk30Dlkh6exeKL3BlMhGMxuMN21caIMGl5PwxGWIvoxy4KRlRXf4+RVZRJv3qyNl44zK+/UcgtXw8fd9jYF8UsJfcL9JRm6f4I0UhZHXdol2QnvjR56+v5zLHX1/V9r+R8='),
			this.addDataEntry(dt + 'three line list', 358, 642, 'Three-line list',
				'7Vttc6o4FP41zn7S4R36Ue3b3dmdvXvtzP24EyUKU0i8IVbdX795AQsSKiqptls6FQgJhPPkPE9yPPbscbp5IGAZ/YlDmPTsu549JhhTeZRuxjBJepYRhz37tmdZBvvvWfcNV01x1VgCAhFt08CSDV5AsoKyRBZkdJvkBSHIIsirGz17lEVgycsJnLH7j+Zxkoxxgomoas/FxqtRgp9hcQVhxNqM8kdBQuGmsbuiKO/rA8QppGTLqqzjkEayhu0GslkE40WUN/OcvOMgkwWLXdvXt2cHuQHUxrBrxjBZX4a2cZxNMKKT+F9eYtrsHCTxAvHLsrf7NjOMG3/oN9mM36xU+V5svPISzGK0+JFbwHktesJL/uSiI3mfeT8JzFi3fuaWNNsiYp2GiOXIMgITQOMXWLn/OSg5Jw7ZdLPgbjZYpGEyoHj5zxSQs4aqrTZMtcE298KBK89LZnO8utXMY62WP/87jlm3dg/v31iVx/f96h3wfJ5BWrP67i1aAeHWgPiGpnhzlLOoB/2+h4yGt5ZyAJd8zTIOu4v0jX7ZKxM4p68V/hBnt76l2Tlc/zyYt1Uf6xRWrwv/WhI4h8xMM5ipAHUDz2lrYldt4jccqzBLxbG8ThyruE3hV4EGAPwuAMggILOo5mFl65dRyT1PVi48rLUXNEDUmglNFRN2A1jftvQjFtQQG5EVYua3DBrFGX9ZCJ8hYtXva1gyw+5PG7w6QXEE4hlIhnkx5VRW5TXXV3KkgtoUlfZHCRSbZho07TNBzkENTA2g3nThhqsMNk4y9lgxMPhfW4sHBy3uGHWDF2XdsqCnQ4ZMQ2F/LylchV2Z7Wzn/VrxBdNIsBvfykUlwIpCfoN+JpxtyCqYznJTbuEt+J55Grs2xghhkhWPZr2WT5d1WIU++//2m+j6FPL+I24YvCJsh7jpp5hEGIfsNGRWXLA9JASgMKuxw4Ad3mLZnJcC8ZqDwaANZ9gKkkjjMEygmgPWUUzhhJXz1ms2YuvTJ09srDyiaVJlk2LhYTqnLywOD2H1Uq8bzvANHYPWrA3aJxyCbROAVVwE7+dFufxWCD7Yg9x5A7L3Xeydyys6edysxzgmqzSF3EFHo797PEJymFduxFZnCaeRGbqX+b0hkq9m1A6aDylXPRYuI/dBN55rmTpWs2Y9+nNNem8etvn7CX5hq24BUAV23lPwKZfeYcJAsFhnjckMUyoPf4cIxXPOGG/NAn7GGZ/xfxM9XSWh2KdQ3mK6omKikLJPLI7xnE8A8Bqp5gGn6b1kC5Wy78u2107tW60mKnTUes3YYkDrlH9bi/zXQ2J/rfgsUnx+CYImQbANLXzUSSBMnyA0BF0+kSCoAmHvKQgTtkojgItCCNIDS8DSui0CL3wh+B0QQeoEMhVIGa0ze2OUiRCQ8SjryAbwRUxGpxCilgGiD0/+hwfvxyN/RRQwJjQSyz9jEc/plwTok4DgRgek1x0DNK8pCKhFAqxLBwGfCHzBRBA2yhg9v6kBOakDtBWvAAGnfzCV0/11BKiY8HMy4IYxHmEc8snhXDwgkhpQMMb/RAcuGwPUogNWPQb4A87iJSzQL/IdvpRAhxI4vqsD1HoQ8ZqUoEXa1EdXAlV47j2VYERiSvli4BEn9EAgiLt6FuUxICh5n0d4xO0fCKCQX5j8WgEeMeLhoTEmSEhHKFgiZXAkCSeLJzDDXEbO+BboIwnCyfl/1ywI9cDmQwwQ5bAuAA8QfomBJjFwPR3fKCky365KDJxPLwYtQnOFzVnLeJnBlpa+u7u/d0wJWYjXvfO/OlUmQeVnJURcRQqU21EKlB9UHt439dBcJ3lry2SVqVjHu/Vd82535egUNTlkGuHZZaVdKEttDyEdSWqKLLV2+ByVqiumW12nHzR6jToZIehEO/qOFhQ6CSlNwexZ5SW7H2A04XKq9zSs03feY7VwH1VWbkfp7n7VfXTkB9iqUNSRmnNJhD4/QPW4SyNASkq7JDr+Z4OHnb7+ik1WL//I7T8='),
			this.addDataEntry(dt + 'single line item avatar', 358, 642, 'Single-line item with avatar',
				'7Vtdj5s4FP01PGaEMQHymGR2WlVtNWor7ePKCU5AdTACz9f++rX5CsSmhYk9zQ5hNFLs2GDuuef45nKx4Prw/CFDafSFhphY8C8LrjNKWfnp8LzGhFiOHYcWvLUcx+b/lnPX8y0ovrVTlOGEDZnglBMeEXnAZU/ZkbMXUnWEKI+wGG5bcJVHKBX9Gd7y8692MSFrSmhWDIW74hDDWEZ/4vqbhCZ8zqq6FM4Yfu5dbtFVrfUDpgfMshc+5CkOWVSOgPOgnBbheB9V0zy3WjjKy459M/d49/xDZQC1MaBkDMDXsoT2KJsgEu8T0SxXd2oj2/YX3qrPRjuasNbgu+IQg1O0jZP9t+qO3WPXD5ryDlDN/V6t0a7b8b+iCSBvZzjnrb8rS4KhiDivQ8Rxy74ME8TiR9w5/zkoua902cPzXtDsZn8IyQ2j6T8blJ3lqlBtmO6El4qFN/Oy3TKb68lWA2OtVl3/nsZ8Wc3FZwunc/mZ3z0D3e1yzCSrN3cxCIi5BMRX/MQ7thFioxijZsIpbRZeECi9uOXnDvg9h0rCzAQjBMDxFpFlRdlDHIZiwQ2HCd6x48zPRevWdwxTZ+6f5wQvXQZqBd3Twb40wzvMzbTF+WD43cC1h9p9rrb7L7hY26rDRU8LF+vT1FQMDKDi60AlxyjbRhIgbeu3UamAKgfXfBxMjR6IBosnUImnHsBm0DWPWCAh9g1vcbEMpX5yWzLFnn6idV5xSIoFvFP5C07iBfDm8YFraxG5ABgAZ/F7Oo3dwqqut7Vx3XemjYFrwsjAlqy83GywuK91lMU5w0mOk1fo2EOOewO7k20lsMUf7ydog8k9zWMW03bwXkcIn0++74sUeiMKBSHbXPaGesJi9NZWE00n+Xq2turHpmY/ATo2NyGqzkCvcG9X3nJ9JiLDdzIFccGZEWCzky26AC1M4DMghzAptVwYsbKcnFgSbgPH/opJTq86eeIDoMcJ3rNQasmMmBPKPkimo5RyxmTSStkkOvRaWU5RfEHFbX2iUXKVSpmX49Ml/3up1JIwGSOVm1D8nQvJdKRSzo9MWiphvXfotbKc6LjHjEsd/wmOMpJfxVJmZnDJYglMiKUjJ2ouSyx7IJmMWDoDMiSTEksfmrCynOf4keFHKtTyI7rmKhVe0FPMcRlaaSSwVNSQXJRW9kEyHa0ckCSpMSFx6wlny+S4ON5cHYGeJ2Zu/Qxfr13l3MY9V8eYPuRW+Ugzl+x8fabZgxA08bxtSOnGlKIE1zeiL3JmYZXFjCERJVAysDBqQjGCN70Y4Zrb6BBxDk2kgRVFHN9REmaCiMsQHeTtaOpMvOjMhhEmwgGZjdoR+Mw4zRVIg6CuL1W5BZ8e0icNZFRG6ECCZK6oi5trqourf1Y32SYzoGip90jJg1xbKkoZ1/6df0RrdN1i6TK98DQs+UOli0EXIROVi1DOgwzDZ1S1tzi0b2i9rFFH83q2t5lrBAUtiYYN2v5UsaR5kacPl9ey59fiZt84A+ijKtXW9NqE36WPibgEjkhAHPecy0Ho/QN0bpXGn0THf2/w8ObxbchyePtlyf8A'),
			this.addDataEntry(dt + 'two line item list', 358, 642, 'Two-line item list',
				'7Vpbb5s6HP80PKbCQIA8NtnWHWnnqNqONu1pcsABqw7mYCdL9umPbUwImLSkhUbrgtQmvsGf38XXWO5ivbsrYJ7+TWNELPe95S4KSnn5bb1bIEIsx8ax5b6zHMcWf5bz4UQpUKV2DguU8T4NnLLBFpINKnPKDMb3RGfEkKVIVrctd85SmMv8AkXi/vMVJmRBCS1UVXelLlmNF/QBVSUZzUSbuX4UKjjanQxXZelY7xBdI17sRZWfOOZpWcOdhmWzFOEk1c18TwcOWZmRHNrWby++aAC6wXANMICI5da1z8IEEpxkMllG18bItoOZPz+F0Ypm/KjyB3XJyjmMcJZ81m/s1Vn/0lxkAN32i47RrtL4l0wCV6QLxETqm0YS9GXEeR4jjlfmFYhAjreocf+XsOQ9U7LrXSJtdpOsY3LDaf5jCYsXSdXtBqbZYK9deDMt00eweb6JGjgXNf38e4pFWIeHT2ZO4/GToHkHuloxxA3UD2/Ri4ipQcQXxLmQJDvLL90+aJtm5odhp4aPVO6Apx1U2mUi/SDpxREkt9qwaxzHMuCDgwla8brlJ5V6FzgjG2cavEwC+6b/BqXcH8J7eYFWSMAUIdabfi/07L64T7txf8SJFVYNJ/qDOLG6TWXEcARWAoOVO5ShAhKDHAEb7xgZWp7x1WUoH/htG4WtUQe8+ijj2YOYJQQj0BIatNwXVCgbyVdPKad96PE7BvYOWl4XdXcY1IE3BuwzA/ZFCrNEor6nm0J83FGaSBbmEo3zKfH6UdIy1UxdHcMOl1ZqDU+/L6XBGJQC25xqpPRnzSjjkG/Maccf5iejyTDgAwP8703UbSz/bTHDS+UkaSMbCaj2cjRXJIn/G4YUFAKJq8lexvN0FJ577AVU8zmC1TStOXcT+CN1vTquYCBcA38MXM1thY9iPKIb+eSMcrwSQuWYZr36r+t0TT59lPkaMHcW/mnSI+ThgnId4pOKmQZl/n8bWhVMmOLsVlQAXr6rC0VGdKCvzqx6r6MsP5Gft4Sowa4lljIE8VZlFGVdQ0NPr8eiFEUPSyrInqd8TbQMDG/XMlMllWSc1nJNr+AIXCJyTxmWwVr1bljVMX9qlZ9afD/akWulu47Rt4Ow5ZtgOGWDrn2bUVaL7jgdfcfGDd1k8cX0rbtDOYlYI8agnKtfxf3Wxe1V++3DitvcovqKYyRnpEyK/HK9+JHKtzoiQT25Sv0PkPpsOobUzX2/v7It5uiSMxVGq4mKQjtFmUIzQngrWJXRH0K8yv6Ny37qj3HsBMx91X6qOeu8SV6DL4/2jQZPLpbCQRZLE2+MMwdgbrM+w7tLGD10mfXwQ4JTvJgm7sVLqZ2TZ7b2TXWo+chhUbVMHOPYNmg8fZRTW8fcSzWIq7gSLXHOOnd6LsbQ2yfI3G89SVBnl3ZJdoK3Ro9I1r/GKqsf/1jrfw=='),
			this.addDataEntry(dt + 'three line list icon', 358, 642, 'Three-line list with icon',
				'7Vpdb6M4FP01eUyEgUD6mKTTaqWZUTXd1T6uHLgBVIMZ4zTJ/vq1DYQPk5a00Gqyg9Qm/jbn3HN9bWdirePDPcNp+I36QCbWl4m1ZpTy/Ft8WAMhE9OI/Il1OzFNQ/xNzLszpUiVGilmkPA+Dcy8wTMmO8hz8oyMH0mR4eMsBFndmFirLMSpzGfgif5X24iQNSWUqarWVj2yGmf0CcqShCaizaoYChiHw9npqqxirvdAY+DsKKrsI5+HeQ1rvsibhRAFYdHMsYuJ4yzPCE5tq7cXXwoAusGwNDCQmMvSMi7CBJMoSGQyn10bI3eF7pbmOYy2NOG1ynfqkZVT7EVJ8KN4Y7vK+pOmIgMVbR+LORplOvpXJpEl0gwykfq7QBL1ZcR8GyOmnecxIJhHz9Do/z0s2W802fgQSJnNgtgnM07TfzaYvctUrW5gmg2OhQpn8zxdg812dNTQpagV4z/QSEzrNPj0xmwMP3WbPdDtNgOuoX56i15EzDUiHoFzYZLZRXrp1kFTNDdr010ZnTZcs3ITva6gXC5TqQdJb+RhsiwEG0e+Lyd8UjCBLa9aflWpW9ccWThz930mcGzqb1DKnSG0lzLYgoDJg6wn/ad1pRfu827cX1BiiVVDic4gSiy7KYW4GIEVdwhWMsDMCzVC6ujXWSmIyiuXeuwtjTMU9XadqMt1DkPY1LLHZ2yhMfZXBkzkeMJ7MUp0DyrQ5B1resvbOerRfBZy2g5w0YoX0IfHB7YxiJtboBHoudHoWQusQI0rRMCBCSD7UOR0hGUd1Hws8tYwyCN7DOiR0RVViAweQqEPjQeDwDPITjhVryWcUuTJOjhNM9UUy5SHE/F/I7vx6T4hFPvCJfZg0e7HYkuLN+rpiDO4VGArHpF63IcRh0eRLcfYC8+sx/2/sLW45hjWgjRrecBZtqesF7HXLE8TzccAXD8w+AE/dxED9fIl9MaWytUs3YmQAmeyTKV3WataW7BVg/7L34iqdM6o8tc0CHuMHQHSD0008sp4k0S1mLHGCajnw3FFw+Bqlf0Mi6t+zHEPCTBMLtHG/zo0tMbxgPqxx3fKo63wJTyiiYg3xD5E2oTEyCElMw3KnJ87WhZMM8XZUlRAdnqoClW0U9JXZZYerJblBPJTzULCG0snizd0JwfdpT7mkJW+toiIlDcOcCwL8jluWNlPES39UQuTykoCm/xd8pqaJb6+y/RC8J42VJjMKuQxKYxJ8wiVsWr7y45NKMEbIA80iyQBk+rktXTxX1vl5w56XlwSCr1YprZKoEVLfe5w+hhxo9s6mbAWo7gx/cToke4S/9NUstxxOs1FUclBGTxOjjyKYSa+3mKOZcchZkGXRGJ8zBuT429pXL807HH2LvqxnTJO7Pv5iwbAP281kVOJseKcKGNXswqpWlwyjwEkjVn+FsGVi2DujCIC/SS0n9VccHlkqGfwKPbYaPBqTLsYJKad2mMcRyP9wPMN2t1g76n3/UGdlzdeIuS2c/YWwZiVN5QvXSR03fwMdAfrNkYf5QrW1E9LNeJKrkTLKM06N+CfxtD1E6QfUJ4lqNOlfSY77rXRI5LVT6vy6vVfXv0H'),
			this.addDataEntry(dt + 'three line list avatar icon', 358, 642, 'Three-line list with avatar and icons',
				'7Vxtc6o4GP01zv1UBwgo/aj25XZnd273tjP9uBMlClNI3BD7sr9+E14smqBYEytM6bSFmEB4Dic5OST2wCR5u6VwGf5FAhT3wHUPTCghLN9L3iYojnuOFQU9cNVzHIv/9pybmk/t7FNrCSnCrEkBJy/wAuMVylPyhJS9x0VCANMQiexWD4zTEC5FOkUzfv7xPIrjCYkJzbKCebaJbIySZ1R+ggnmZcbFpRBl6K22ullSUddbRBLE6DvP8hoFLMxzAM/Pi4UoWoRFsYFbVBymecJiXfbj7vlOEQB1MIAUDJvXZQSsw2JCMHuI/hMpNuDHMI4WWHyc13Y7ZhPH9r1xXczEySqZb7JNZF7CWYQXv4sIuB9Jj2QprlxWpKizqCdFKa/WUxFJuykizucQcdw8jaIYsugFbZz/GJTcTz6yydtC0Ky/SIK4z8jynymkRz2qQB2YzQLvBQv7Xn5cCZs7kKNmHxq14vr3JOLVWl/84tLZuPzFcPMMZD5PEZOivr6LRkB4EhB3eEreDiKL+qHfZMj1pX09AMoHuMI1x9pPl5wbF1VWxmjOPjL8mR1dDR3D5PCGx8H8vskxrbAOdPBrSdEc8TDNUCqhLHcUJaSNw+6pw76DbGWoNsg20EK28jQl13wDoAx1gJIiSGfhTjyq1CvYqBeixq2jrWod9QB2MfTNI+bvR4wXiJYpatgMrjE6SfgL3bjZpVt6wg+Gm+G3LQPxv9TBmFmIZs8qwqz7JH2E8XcitsZoF2UcGTNfD2RbTZyJfqd8CiqIjeKIJ0wIxoSmEnw7dPdAhRnKth3E2tIEAq9oBuNRkcyEeiiVQvnUVIWFpxYSp9Xd/pFtZAGxb5uA2NZBylWKaoX7FrS+JX4ajz2tvSF3Fc2iq6dZ3JIR5aFeAOTx/piuMBcFjsXCKBU3i9Azwjz/jQQNj51qgLvNkyQKAlFE8eBrUt0NgFKPSY9EqoAGGOGG7D7c/chyTJHIhsX1yYryf1jc0pTvh4gzxbECIhokx0KUQhwIEPv9/tHobY2lLrOtw6h6Rjo1LW5FyhRWBcdknP3s9eEOliJ1SGyWqCqPoQyLLrEOLjfaRceEWLRlLyPhrOPlrIcZYSzf/QNhHPFh7bcSOaUSsQcmzCtbi81hTorUjN86JEVkS+NhlSSCXdZ4/LcB8dG4qK7+bD+G7VMpsq3xFKVCPt7x3xlZxUH2v2w9pytRo7sfCf9Lsn0yF1qTvOLWypSvhdWMTNHilpxcpjQyuTokUxzZInngip9CnjYKYPLtkZxUmTgeMAHyeZskTudNkjLeFQB+raKsA4sMyBJdbyI76IkoZmRckV7mg4i7gC/CGbmHNDOueBNHuH7EAb8NglvrgnwxjkbkhZ45G6eWF3VIdFdeyC7II0UvRAzJfkKcItwOfSFz88TTOzTpC1CCrhfl83Y+6t5cd0hfyM7HLxpkxseM4HlEk6wHO2Op0UFjQzFf4zGE+HmtNuZZM1i8geHNHcqqRArg5pQkrVUc++F0gIHpIEYVRysNjWazdjqkOIBsaIxpxJgwNH6SmLVDb3TFz3BLAagX4/P2M0Dn/Qwg+xm/0SxaisEzE8PpcgL+WYqNBvi0TmwA2dd4EmikYfECBUFRhWxGDhjxPU4Elk31SP9dQfG6ZZKJRdralyhfjKoRzQFa6XLUIdFdzSG7HFfwJRLsuof0+VtynFJyeLaR9vW8LQ7QeYsDyBbHbQQxE678AorJAWcrNzrobQDZ2xhhcVP80ohHkvWK+aUpQvlMUhYKObKGbBnD99YqjQ5O1wCtdDfqkOis0nBld6NWXRy2Fsz2y4WtIQzIq4b+XrkwTIbEU6zK8wytyrNLE08vKFrsiGW8Ui5stXzXG1if54i7f1xkcGFkyQKjpJDdiGbxP2DFuJVt2jVxLSuUHYh75NK79Vo7E6tTXdmB+AQLplC9OlK5nLiKy2fZsbvxsvpOg0WSqoXgmr51YWtdq4l5624Dk2Ffn/KVCHUfINleqAVI2aR9JTrDrsHDDz++TCnPXv2upf8B'),
			this.addDataEntry(dt + 'line item primary checkbox', 358, 56, 'Line item with primary checkbox',
				'tVRNc4MgEP01HJMxUtPk2Jg2l3QmMz30TGRVJiAO0NT01xeEmC/T8ZA64wi777HLewjCqWhWitTlu6TAEX5FOFVSGj8STQqcozhiFOEliuPIvih+u5OdtNmoJgoqM4QQe8Ke8C/wkTWrwAEMCPvRwCEzQD1MmwMPMEp0CW6RCOGFLknt4spi7TRnnKeSS9VCcd4+DmaU3MExU0lbCC/2oAzLCF+TLfCN1MwwWdm0YJS6YgvCWeECHHJzhn8J4Q6Xy8p8sB/XxyRx1WqSsapYt7Tlc2xDYbN2BWjuCtaGglorkAKMOljIN6Om9AiczDytBFaUgZZMfYxoPy866kl+OwgO9LuBb9wYprtoCneCxoWgfJyVkO22srkn+JU70Ww+T3AH/gzbHCxX3C/XIZy+ceIpZ/JNetQ7xhRwYtgeLsr1SRoqbiSzjcTRsb9gQqg+ml8uIPNcg7lxpGt7kElPjzBJgNakgBuPzn+XK6Om7fNwoy4Jf9gWbpL/sG2EH++bnZ6uUQ8/v2V/AQ=='),
			this.addDataEntry(dt + 'line item primary checkbox', 358, 56, 'Line item with primary checkbox',
				'tZRBb8IgFMc/DUdNhdVtx1k3Ly4x2WFnLK8tEUoD6Oo+/aBg1VkXD46kaXn8Hw/+PwoimWwXmjbVu2IgEHlFJNNK2fAl2wyEQDjhDJE5wjhxD8JvV0Yn3WjSUA21vSUBh4QdFVsIkSWvwQssSPfa1gYE5BZYEBq7F1HIqKnAT5MgMjMVbXxcO63rFlyITAmlOykpuuZlVqsNHEZq5UqR2Q605TkVS7oGsVKGW65qNyw5Y77YjApe+oCAwp7oX2K41xWqth/8269jkvpqDc15XS67tPkjdqG4XTcDtFct60LRrwUoCVbvneSLM1sFBUmfQloFvKxiWjoNMWpCv+xTjwDcR2QwzINc8LjNd9mW/gyNS8nEOK8g36xVe2G4QzHt2i9EEUQQf8Zt3mwXHrZrH8/fOA0pJ/ZNBtw7xDQIavkOzsoNWRorrhR3C8HJYX0RQqw+ej6fQBWFAXtBpF/2TZAe7gFJgjG0hCFG/e/y6zfq2d0X1HnCH9jiXfIf2Ebk/txc93iRBvnpPfsD'),
			this.addDataEntry(dt + 'line item primary checkbox', 358, 56, 'Line item with primary checkbox',
				'rVTRboIwFP2aPmqwlU0fJ26+uMRkD3uu9AKNhZJSHe7r19KCOmEhcRACPffc3ss5N0UkyuuNomX2LhkIRF4RiZSU2n3ldQRCIBxwhsgaYRyYB+G3geisiQYlVVDoMQnYJZyoOIJDtrwAS9CQm1cFAmINzNEqfRaexmiVgd0kQGRVZbS0uDJcs0y4EJEUUjVUkjSXpWklD9BGCmkKkdUJlOYxFVu6B7GTFddcFiacc8ZssRUVPLWAgERf8V883PESWegP/m37mIW2WkljXqTbJm39jA3kf9bsAPWgYA3k1dqAzEGrs6F8caYzxyDhwqVlwNPMp4VPDqOVW6dd6kV+8+Ed6HeD3LkxTve8Tu0ETdOciemxAjUk9i9nFoG9xwqD+4U5+zmbhi7lSqh5cK9TiykQVPMT3JTrE89X3EluGsFB25+X21ef+DnvdpBJUoG+E7/re5Qf8//wI84gPuxlPdKTYLFchqQjf3o1R4/vgEu3CX94NuuZ7RZ70LMJ+WXa8nHPzPJyWjr69WH6Aw=='),
			this.addDataEntry(dt + 'line item primary checkbox', 358, 56, 'Line item with primary checkbox',
				'rVTRboIwFP2aPmqQinOPEzdfXGKyhz1XeoHGQklbHe7r19KCTmQhcSWE9txze8s5N0U4LuqNJFX+LihwhF8RjqUQ2s2KOgbOURgwivAahWFgXhS+DURnTTSoiIRSj0kIXcKJ8CM4ZMtKsAQNhfkcSwUcEg3UEZU+c0+kROVgtwkQXqmcVBaXhmuWKeM8FlzIhorTZlialuIAbaQUphRenUBqlhC+JXvgO6GYZqI04YJRaoutCGeZBTik+or/4uGOl4pSf7Bve45ZZKtVJGFltm3S1k+hgfzvmh2gHpSsgbxeGxAFaHk2lC9Gde4YOFq6tBxYlvu0aOEwotw661IvBpiJ9+C+H7jnxzjdizqzPTTNCsqnRwVySOwbZ5aBfcYKE94X5uw7bRq5lCuh5kFfpxaTwIlmJ/hV7p54vuJOMHOQMGjP5+X21Se+07sdRJoq0D3xu3OP8mP+H34kOSSHvah7nhgDFs24McZ75cifXs3R7Tvg0u+EPzyb3entFnvQswm+Me35cc/M8nJfOvr1dfoD'),
			this.addDataEntry(dt + 'item list', 358, 56, 'Item list',
				'rVTLboMwEPwajonADkl7LJDkkkqRcujZhQVWNRgZNyH9+trYeTSPCimxhGTP7njXM8YejatuKVlTvosMuEfnHo2lEMrOqi4Gzj3iY+bRxCPE159HFneiQR/1GyahVkMIxBK2jH+DRT5wtECLtmrPHZqxtgTD8T0atSVrDC4h1UWiHDmPBReyT6V5P0yakuILDpFa1JoTbUEqTBlfsU/ga9GiQlHrcIVZZopFjGNhAA65Ost/c/AxLxe12uCP6SMITbWGpVgXq56WzIiG3Nn0DtDd1aeHnDhLEBUoudcpO8xUaTNo+GJpJWBROlo4tRhr7bo4Uk9q64kT/Lb49Er8YbpXXWEuzLioMj7eYY73xL5wZtqPocKQ28Ls3bUah5ZyJhSZXOt0OJMEzhRu4U+5W+K5imuBuhHiH/pzcrvqo+BiB5HnLagr8Y99D/Jj8gw/2h2qtDQXuW36/yPJsTOUyEY2iilDMrd+kGv+/DUJZw+69pfwj4d0esND/ykejsLgwkT/cRP18vRa2vTzx/QX'),
			this.addDataEntry(dt + 'item list', 358, 56, 'Item list',
				'rVRdb4IwFP01PGqgHTofBzhfXGLiw54rXKBZoaR0ivv165f4gS4krglJe889vZdz2no4rrqVIE35wTNgHl56OBacSzuruhgY85BPMw8nHkK++jz0/gANDOo3REAtxxCQJewJ+wYbidRMqvqlRVp5ZA7JSFuC5vkejtqSNDouIFWFopwyFnPGhUnFuRk6TQr+BSek5rXiRHsQkqaErckO2Ia3VFJeK7iiWaaLRYTRQgcY5PIi/82F+7yc13JLf3QfQairNSSldbE2tGSOVMj9n9oBuocamZATaAW8AimOKuVAMyWDycDhq6WVQIvS0cKZjZHWroueelZcTZzo9w3AAwPG6V51hT4006LK2HTXe3aruPJiZkaPfLqfGi0Oui/O0R2vaWgpF2IF/lCrwOkngBFJ93BV7p6AruKGU9UI8l1/J4arPllcb8DzvAU50L9ve5QlL/9hSXugMtV+kLYxVyTJaacpkUW2kkhN4neuiTJtZ8bwYvnLRRLOn7TumvCHkXg2NNI9KM8aOQlvnDwdmmesVMvz02nTL1/WXw=='),
			this.addDataEntry(dt + 'item list', 358, 56, 'Item list',
				'jVNBbsMgEHwNx0YOyEmvtdPmkkqReuix2oa1jYqNBSR1+vqCwY6buFKQkGB2h11mgLC87rYa2upVcZSEPROWa6VsWNVdjlISmghO2IZQmrhJ6Ms/0WUfTVrQ2Nh7CDQQTiCPGJANWHDI0UCJIWjsWcYgB1OhpyaEZaaC1uMaD65WVggpcyWV7lNZ0Q+fZrX6wiHSqMZxshNqKw4gd/CJcq+MsEI1LlwLzn2xDKQoPSCxsJP8pwiPeYVq7Jv48X0sU1+thYNoyl1P26ypg+IV3QnY/StTD0WNtqhqtPrsUr4Ft1XIYOljoFUoyirS0lXAwIR9OVIvortF1H3eA3bjwX26113p382irLlccGfbRzDtWnJnxqofY+Q93ordqw6dV+ccn9giDZSJWsMlpmINmEYJVpzwT7k5BWPFvRKuEZoM/a0DI1Z/WF6doIrCoL1xYOx7zhS3vXy6kD79k78='),
			this.addDataEntry(dt + 'line item checkbox', 358, 56, 'Line item with primary checkbox',
				'rVTtboMgFH0afraxUrvu57Rbk6VLmuwJmF6VFMEA7eyefiBov+xi0kFM4Nx7uHjODQgnVbOWpC4/RAYM4VeEEymEdquqSYAxFAY0Q3iFwjAwHwrf7kRnbTSoiQSuxxBCRzgQtgeHvBMO2kBbkDvKlYsrfWQ+nhFVgmUHCMeqJLXFJaSmXJxTxhLBhGxTcd4Om6al2EEX4YIbTnwAqWlK2IZ8AdsKRTUV3IQrmmW2WEwYLSzAINdn+S8e7vNywfUn/bH3mEW2Wk1SyotNS1s9hQbyf2lOgOauUi3kZVqDqEDLo0n5ppkuXQaOlo5WAi1KT4sWDiPK7YueetLdLLz0wzbgGxvG6V41hW2daVFlbLpXIO+JfeXMMrBzrDDhsDBH32DTyFHOhJoHtzp1mARGND3ARbkh8XzFraDcNmR3Py+3rz7xDd6fIPJc2Qa+Er+/9yg/5v/hRy0hB6NiCmqkLYt2PGjLJeEPk2YDzdxhD5o0wVcuPT9uktme3kWXfv5s/gI='),
			this.addDataEntry(dt + 'item list', 358, 642, 'Item list',
				'7Zxdb6M4FIZ/TS5TYUyAXPZjOnsxq61mRruXKxdMYg2JkaHdZn/9AgYSMM5CYkMTkqpScDCY8573iXUwmcHHzcdXhqL179TH4Qx+mcFHRmnC320+HnEYzkyD+DP4NDNNI/2fmc+ST0H+qREhhrdJlw4m7/COwjfMW3hDnOzCosFH8Rpnuxsz+BCvUZS1M+ylx38ISBg+0pCyfFcY5K9st4TRX7j8ZEu3aZ+H4lSYJfhDOty8qRjrV0w3OGG7dJd/iJ+s+R5w4fJua0xW66KbbRUDRzFvWFV991efvikC0B4MKAQDpGO5h0avmKCQrLbZJh9dM0aG4SztB1mMArpNDnZ+zl/ZzhHyyHb1vbhia9/0k0ZpAyj6/ijGaJTb5N9sE8B0m+E43fqriCToqoh5miKmxdsYDlFC3nHt+OeoZJ2YspuPVWazu9XGD+8SGv39ithZqQrbA1PvsCtceLfg2wdhs2wxaqBv1Irzv1CSDqs6+Xxp1k4/d+pHoEEQ40SIenUVnYRYCEKkuUi8uJdb2l3QtMzSdt3WDD7IcRP8v3+4WeaZGzJxiYfC+8KuG+L72YAr/4Y4SPY9v+VbT46p2TYL57wE2NXdp1RwW4XzIoYDnIbJw3FH+atvlU5xX7TH/YgPy1jVfGgr8WF5mNKGrgZVHBWqpMNI0iwfVJLOoFxo02deaq9TIFcQ6D5JGPISQrfqYVlJI8KyRN439IrDFxqTbARH0CdFZAsT+dAkaAaOZmparhJqukCD/EsV/kQHGdPMg8PvuUYyOPlf1+C7atB5phYSdC41SAMMFdq8RW2SVKGvOyPzShCS6M8+U3CJMJ0BCkxRJkUAhY2JJtQhExBkeiLbFEDXAs8LRCUwtRjy1HpEzZA+T45ukvdDJJDUJ46Zr236ooaRRXFHLyPFqsinZKRMmclAUqyLfPHfPJRj6sbJ0Tjp6Ci9ALH2coIpcZUfWlBp9Ual2WLBS5pOKimQDIBKiTKTQaVYMnlGGxLubpwcjZNVlUet0mLt5QRHBjw5tEDS+VSQdAaApJJ6yACQlCgzFUiaYm3kN4zC9OpukBwNko4WpcXyygmOXPPk0AFJnopTgmQ5/M8OSZkyk4GkWBz5IwiIh2+QHA2SsNlFjdJKlp1QnhxaIClZjnIMkoYoQnlZ50LSrZsPaNFESRVkAEqeu1Lo0ikp1kVeGN3Qq7oBfomktLXMXZQsSIn2CaKFlnZ/Wrbc6+69yLFbcbL0u1pdlNRCBqClRJrJ0FIskHxHPqE3UI4GSgvouIkDlaw+YXluaGHksj8jW6ynipHNGaUORkIlpZABGCmRZiqMLM9xyEjskQjfppMjUtLWcQsHKll/wors0MFJKAn7Fc8loZJqiH5OyqSZDCfFCsmPiLLkhsnxMLkAWpRWsvYk5smhhZInPJjTNps01VCycRNHS30SKqmEDEDJcx/QuXRKipWRnwy94/BGyfEoaWtxpJLFJwlPjp6U9EmWKFzUmL7l98q72VPNcznl3R7V80tDg07WhTyYI5NmKuS0Tq2X9Hr6O3u1MvMcju1qHQai2rw8jloVTBVueUXerza/VN9ZMl1EH3XSxTr+wIZxV97ePWaftucPFf2EQmOGqKMCbHWobZRapT1JFONPpdD1C9ShznEUaWOq41ybPOnm/peR+O6HP5z0Hw=='),
			this.addDataEntry(dt + 'item list expanded', 358, 642, 'Item list (expanded)',
				'7Vtdj5s4FP01PGYEGAJ5nI9O96G7O2qr3ceVB0ywxmAEpJ3019dgIARDFoidaJIwGil2bDD33HN8fWNr4DF6/5zCJPyT+oho4JMGHlNKc/4pen9EhGimjn0NPGmmqbN/zXwe+NYov9UTmKI4H9PB5B1+QLJBvIZXZPmWVBU+zEJUNNc18JCFMCnqU+Sx+z8EmJBHSmhaNgVBeRXN8pS+ofqbmMasz0P1KJTm6H1wuGVVNdbPiEYoT7esyU/s5yFvAWyXdwsRXodVt6VVDRxmvGLd9N29PftQGaDfGEAwhsHGcg/0STaBBK/joshH17WRrjur5cOQjQIa563Gz+VVNE6gh+P11+qNrV3Vd5qwCqPq+60ao16X8a+iaABWTlHGSv9WljTGImLOQ8S0eF2KCMzxD7R3/2NQsma6bPS+Lmh2t458cpfT5L9XmB7lqqDfMPsdthUL72xebpnNWopWM6ZarXr+C8VsWM3DFytz7/ELZ/8ONAgylAtWb95iFBC2AATzRexlk9jSz4IuZVZL1+314JaPm8b/84eTZVGwoQAXe5DcV3SNsO8XA274S1CQ73p+KUtPjqmYNrZznANs99knFfClDOYlKQoQM5OHspHwN7PKKLvb/XY/wMPaVns8XErhYX2bmoauAlQcGaiwYeTMy08KyWihtJXhs6ixVwmQKwB0n+cp9HJMY/li2UAjimUteV/gKyIvNMPFCA5I36BE9mhiO9hwFGvk0pSika6hAOyVDDbCln90UW/Pah3onfKv6TE50nPlSKerRDpXCsAydBlobZI+kAbAKLlCcPKPBGBGC6hh9pBIjoCCTqAJVMBkzISJ4FIhBWxQeZ18SVS725G6ZQAVs1TtIy0jP+GYqfylzlCdpUKzyPgAM5dhKaGZmP+YoYY+d5qJK7tRRjcGrH5I+fpiRzkTVB14K52gpCQ7Jk9QR6FxNbOSmP9gigbfApgVQ9HMJYyS0pj6a7qJvVBAjll3ioh1c3rOyScw60jm1MkJ3VaBh5ie+Av9ZBX3EUqZfeOb/Wv720r4ICYivm2yEBf+D1NxoXut1ge6inWnIWYZxs0UlxkjA0tFAtQQV/ef/I0Hyyj1QsNklWBLCoeBpSL2MqUkB1DjH+NQb6KyUXbnDjktZdMTdclK2ZwgIjbn5gJOnLIZQuZaouMalhZOzzDCZHvTybNFHpa+VIG0lLRBwJ1DhUgOWf2CRfI8aYPJIjmEzNWIpJhC+ANBkoupgptInkwkbSUiKWXvRMidQ4lIztg38cFFUsrGiROI5LHbJz66SIqZjb+DAHvoJpJnE0lbN1UgLWXzBOXOoUQkZ+yQ0EUQ6tc6ViTdffIZKvKK4INskbj2PRJAzIu8pDSit01mZ1ZKW1eBtphdmcHKZOcgKtQSDJzlmLifbPJBggG17Ownq/kuFxcpuRD1ajkEzdWo5dwEyaRTC8Ul/Qe07V6HE6nYwlKx5QyI6Y8ZbHmF3lsfX5o5agiXmfteuO8Mcke/q7M6h+jTt29W0tGfztJZxckfMCKbUWPFeuIkE+PxcyJ0+QCNyG0clLRzouNcGjysuDvRy5u3D/z+Bg==')
   		];
		  
		this.addPalette('gmdlLists', 'GMDL / Lists', expand || false, mxUtils.bind(this, function(content)
		{
			for (var i = 0; i < fns.length; i++)
			{
				content.appendChild(fns[i](content));
			}
		}));
	};
	
	Sidebar.prototype.addGMDLMenusPalette = function(expand)
	{
		var s = "perimeter=none;dashed=0;shape=";
		var s2 = "perimeter=none;dashed=0;shape=mxgraph.gmdl.";
		var gn = 'mxgraph.gmdl';
		var dt = 'gmdl google media design library menu ';
		var sb = this;
		
		var fns = [
			this.addDataEntry(dt + 'menu simple', 170, 168, 'Menu',
				'7ZXLbsMgEEW/hr2DEzfbxm3TTaWqWXRNzdigYGMBefXrOxjykhPJ6mPVWLLkuXNnYA6WIGleb+eGteJFc1AkfSRpbrR24ave5qAUoYnkJH0glCb4Evp0JTvqsknLDDRuSAENBWumVhCUIFi3U1FowcgaHBgMG92gOuPMCvAdEgysYK23GihwyVkplcq10qarTsvu8TZn9BJOMtA9oQHXGxRHGMT9gHGwvTpTJ8WB5qBxd2aHlo3kTkTHXZg7ESArsS/LpkFkNgjVofaICD8ipcvE0h6xNygNWNEDhxN4IH4WWTB1r2TVYKaWnHvLrNSNW8hP7x5NPIeWFbKpfJhhiD0x+R5nGsyGfo/NOB68AcWcXMNZ/0u84hKvWuLKR4suSwuuB/Swk0GMxz3Gz6Ba4v/ljNVthyIpAfgHK5b/m/vuvM2vHsOkdwwLcA5R2RtzlKfjP2Ce9Zl7lDTRK3ej7gv2iH6CHcPjHRvsp1fwFw=='),
			this.addDataEntry(dt + 'menu simple', 170, 272, 'Menu',
				'7VhNb6MwEP01XCtjEmiPJd3mVClqD3t24wGsGIyMm4/++rWxSUkharQxpxSEhMf2jOe9NzYiiBblfilJXbwICjyI/gTRQgqh7Fu5XwDnAUaMBtFTgDHST4Cfz/SGbS+qiYRKXTIB2wlbwj/AWqyhUQfuDDVIVoICqZuVqLQ1paQpwHhAutEUpDZDJax1yDRjnC8EF7KdHWXtZYYpKTbQ64H2sg6o2GljqBtuPSAV7M/m1JpcQksQenXyoIfsGFWFG5HYvFEBLC/cNJy47EhjDflx7hdE+sWhNI5YNEBsJWHLYPffwJX73PB/l5eU39XOWZQaDNia8EfO8soMY5Qa1ylxBg6ZAZyTd+Ar0TDFhDFLm3CaiUq9sU8TIZybcDVZsyo3zVg3JTS686+DLBww5Fb8jc5kZu5LecI/8xQPaQodSxI4UWwLJ+7HqHMRVoLpwBh160nsjMNppM6ByLIG1ID54zIvEsNsIIa3QufvRwqNcRXdjBLuR5Qw86OE+EQJ82QCJcwHSlgan4izauNHDq2nWxYDmkIMIQonUEP887HacaxphVHcR0Ry/gz1hfvYsXkt8B3SeIodOBkg/UI2YKLoZy3qg5/iaz1dX3yWwI5lfH059muvX5MuMV+ywCOqiL2Uo/s+PYpkjiYQyf1AJE9iV3FBqB910M7brWzP0+nh+/b8gCfQw8Pv9jzYno+V6BXpbnE9qF+hFFtPn8jS+votO89lh2ceyk43v35k2OH9/xz/AA=='),
			this.addDataEntry(dt + 'simple menu', 280, 160, 'Simple menu',
				'3VVda8MgFP01vidxLXtts7V7GQz6sGeJN1FmNKjrx379rh9ru6aFMgqDGgJ6rkeP5yASWvfbpWWDeDUcFKHPhNbWGJ96/bYGpUhVSE7oE6mqAn9SLS5Uy1gtBmZB+2sIVSKsmfqEhCTA+Z3KgBNsCF0LDS45b6VStVHGxipdzMKHuPPWfMBRBWILFcG42SBY4iDvB9bD9qLmCGXBSzA9eLvDKRvJvci6H9O5CgGyEz+0aQaZS0C35x4swE524bwjdOTISqB6XDRO08bLVjbMS6Nx2Bjtg+xT0/B00Swsr+RXAEuax0cWFbEhzpTsNGIK2kBzA2uk7gJrOrZ8b2xwEaWoWWb3kvMgYG7B4abv2a6rba/+ZvskYxYU2rKGX+ufiyJv8WZkcK7YZcJJeKZtHfhRdHthV6X5MErzRXIIWYF2Mqr9n0zvK7vTi3eT7CaXsvu/m3hfqZW3uHI4PDxXafrxa/YN'),
			this.addDataEntry(dt + 'simple menu multi line', 280, 328, 'Simple menu (multi-line)',
				'3VZbT8IwFP41e+86uT0qKk8mJpj4XNnZ1tC1S1cY+Os9vXDRiQHkYiwhtN+57vt6yKJkWC5GmlXFk0pBRMlDlAy1UsbvysUQhIgo4WmU3EeUEvxG9HGHNXZWUjEN0uwTQH3AnIkZeMQDtVmKANQFq+xWwwRT3mVciKESSjtrkrmFeG20msKWBdyyloKlqkEwxkOoB9rAYmfPDgoNj0CVYPQSXRqemiL03ffPRQrgeRHCEtr3IKs9kK9jNxTgJrDwPSNJi5EXbpALSnIFtauooUUSPo0jR0kz5u8WjAfhvEUJcQtxJnguEROQ2bC6YhMucxvVxaNlh0+YuA1eJU9TW8inD0UtmRpqLPYaaNmbXnocvd3ArgbBDJ/Dp/y/ofymRfkY2XCcCy7tj6P3YAU6Ryvw5ZIDsZ+flLmsEh1yoBKhxLPi0vK4/CzoKkJlWQ2mpdy6sb3E7LTnp1EbJRv8q6sg3aEpKdnUyoDpTHC2njZeenef5pza79S4KbiBMTrbAq61S+veO43ucXwO4bt/bor/17TG/XOo1muPa6FhS7TTDCxh0qaYoI5czlwCoWQOeuX9Bte9Etcf7sFprglNTnBN8Lh5B/Xu26+oHw=='),
			this.addDataEntry(dt + 'menu items', 318, 126, 'Menu items',
				'3ZZLb8IwDIB/TY+gPihwHWzjhDRph50zatpoaVyl4dH9+jlNeIPoBkiDSIjasZ34s63Wi4b5cqRYkY0xAeFFL140VIjaPuXLIQjhhT5PvOjZC0Offl74emI3qHf9gimQuolDaB3mTMzAaqyi1JVwigIUz0GDIlGiJO0gYWUGJoJPQpmxwpgqmNCRgykXYogCVe0dTetlzLTCL9jagXrZAAkuSBmQ4O4DSsPyZE61yiU0AqTbqYpMFjzRmbWIgr51y4Cn2cot7FolK60iXftuENGDo3ScWHRAbAxyZgw05PRnCO0jpFwMGpMVnzDxJHgqaUdjYYCh1O/825gGscFRsAmXqRG7JCooafPDpdYYUfg3RB1XfwWCaT6HnfiXYOtcr9HyZWrmpZ3miWhrxZlMBRx0mIuw147depnI3PQrR1mbKgOlGdjoONhdh8rNXju28hb2+Ehf+r+E7o5/Q063Wp/dCnu7LjidlqAPqrS+daPCxWf6XS+wab/nPEnqSt13y+/Rr3bDXBV+91GmJv7/U+NOb8U3qGPv3BBlChq/Nj5Ra8wfdIz6nRvg7z/KGPXuZ4xWcS8pJImbT2Frvv2l/AM='),
			this.addDataEntry(dt + 'menu', 318, 126, 'Menu',
				'7ZbbboMwDIafhstNHHq6XdlBkza1WqXtOgNTooUEJdlW9vRzSEpLaSW0w0XVIrXCju3En/kFXhQXqztJyvxRpMC86MaLYimEtnfFKgbGvNCnqRdde2Ho488Lbw+sBvWqXxIJXPdJCG3CB2HvYD3WoXTFnKMESQvQINHkgqN3mhKVg6ngo6FyUppQCQluOc0oY7FgQtbZUVZfJkxL8QZbK1BftkAqPtEZoOHOA1LD6mBPtcs1dAcCTycrDPmkqc5tRBRMbFoOdJmv08KRdRJlHcsmd4MIbxyl/cSiDrFZCbxDDY9vaJhGaELYFaNLjisFTVNWN12ShPLlmqG1HiAzRw1GhqPgekG/TLlgiLYEhdaLa7E3qvBnqAbuOZDAiKYf0Kr/G3yDDr644KkXTmeHEDLyCmwuFNVUGIQJ9mYexobtw05Aw5g46NL2dXgYu6x7kY32k20nVE6El0Nrb3EP/FGXu5Nrf+7uAHNB8VzN7hfBulC1dvjtGiLLFOjO5JpGeg1z2BnmnCgNJoIbWowkcPLK2JlQ1S7zp/MYdeaxyGlmdkWB4f/zsWlseNbYuDPTJ1BAZJKflbVXWZPBP0xhsuetv9FVW2X2heaM+2OT3PjkJIfm5oPbhm9/j38D'),
			this.addDataEntry(dt + 'menu', 318, 126, 'Menu',
				'7VhRb5swEP41PBYBhpQ+LllXTeq0aJO2Zw8fYM3YyPaaZL9+NnZpAomasqaqlCAhuPPd+e777oxEgBbN+k7itv4iCLAA3QZoIYXQ7q1ZL4CxIIkoCdDHIEkicwfJpwOrcbcatVgC18c4JM7hAbM/4DROofSGeUULkjagQRqRC260c4JVDTZCZARV49aaSijMlvOSMrYQTMjOG5XdZc20FL9hawW6ywUgYmWUsRF8PiA1rA/W1Kl8QXcgTHZyY0xWlOjaWaA4d2410Kp+dEtmTomVU1S97xNE5sWjtB8xNELsawt8hJpJ36JhC6EFZh8YrbhZaSghrCu6xQXl1SOGTrqH0qYazyyOguvv9K8NF2dGlqCM9NOXeDRUyTSoUt8HEhjW9AF24v8PfOkYvskd16wrOzhh1RAWFqJpMDcmc4Z/AVsKRTUVFnPpyuq5uB+s95xgTxLraDjM3ZCao4hA+4nYddj4mQ0zJ2/RFCf7GvqFLPn9l4KatPrNr9Ld7a8GYyLKUoEesdxXcRTx2Yj4JVYarAW3UDFcwNlP0YCfzW6YV+VjNuLjx3kMYnbmg3j9/Cd/yCuWUqxU4p62Caj92DvSuJAWmTmxOUehHTpiy0nD/NICE1oguz59C+SjFvgGCrAs6ssJvPcEztMTsHAzYuHzeZzA+TseP4ROP35xdDmC33MPpDdv0APx8z0wafhFqy+kTyB9lr066UZ8+pPjzLd/9PwD'),
			this.addDataEntry(dt + 'cascading menu', 636, 632, 'Cascading menu',
				'7VxRb6M4EP41eWyEMSHZxya7tzqpu6oUne7ZCSZYNTgyZLe9X382hrRhoCUJVts1karGBhs8H9+M52OUCV6lj98l2Sc/RET5BH+b4JUUojDf0scV5Xzieyya4K8T3/fU38T/q+MoKo96eyJpVvQZ4JsBvwg/UNNjOvLiiVcdeypZSgsqVTMTmepdRiRPqJ7BU408IXt9qqRbdcllzDhfCS5kORrH5UefVkjxQF8coeXHTBCJ36oTqUZ1P1QW9LFzTWVXtaDvVKi7k0/qlN8sKhJzBkYLMyyhbJdUw2Z+YDpJbjp2x7HPJlJfKiu1WwwDiy0Fj4DV1O1ra+iFsC3ht5ztMnUkZVHEy0XvyZZlu9qGpnVHY32rKNR2FFmxZv/p6dBMtSXNVevfaonaVC3A9LKef5n1gurRkJSTgv2iJ/NfY9EAWvTihzB93GkuTXdpxKdbkaYkU6csOdlQfi9yVjChYZBmWUd47hrHjzCRCjdeItMNZxOtXkDgdiBOBzxVNJ7OTPsFTMiHKKFzUaqufy+Yuq3jxW+C08vfhKcziDjOaQFQPq6iF/AzAPzfhTL4diTTmzA9nU4zKCwhhMUNPs4c5+McAP9PFlHJmcJ3pGRPSi4CC8gsIDJuUHLuOCW/AODXhWQPagJx2CUjK/uyEvk20EEegOeWq0mX64TF+v+sC6Em27bKTtqk/enW5OebfLsUuC/XUtALIaxVWno1B1E9UU3CGpJhcUaQhgdlz3wr2b4YWdibheHCBjpQxJi6ER1RhxDiTHhEUI1ZHzYjLc+jpW/HaUJdZ+KvHCGm69IOgtoOQL5GtswvXxOI351n6MrdSs2zmQ25BkG95p5IUrKlNnh+tjNsPvbPzrF0he8OyVCuL7QCCVRShvF7Kvcj2Y5DulQzNF6+hOVHz8z02xnjATMhtWV7OrLwSkc2G55NtR/Di1M/NrOBJFReDFVGPrXyCXs25C8EZZDPyqeF23zyoWJyV8rL3roixMDEaiD4cfYUQxEusLF986Hg8UkJZx44hwkHxZGfh3RDpcLJ9+5Yfn6e7EooW9gQq1rqRz4rszrgcYZZUN8wdPLEXttzzLm6ihawDbmppZrksxIrcJxYUNAASDqnHQVzG0JFS8nHilMiVVcsZEqK4pItubNCerCwAhLUIPR0gzi3jy6kO18A0lIB0ukMqwrsbmfYWZv9sgL7Uuq9/i7ySLtm3voWNf1F2A1M76JtKDusWRnUB96jnTo75bMHdW4dpRjvVrmNoUyApqiz6MVto3aEDBsRA8Ok/6s4bMbH/d0LOTFM/1eHvBDpBN+qbjSF3n2EqBMiO1V9uK1wYZDNVkK3D40wXA02MbuGxG+L4sfEshcyuKMC4bWtUlv2ElwHVB39w5PgfzO3AdsfIwB0YeeKAIA/qABwobMbSAGwUzyJoQJwG0Xa1ipu6PdyGxoLSY0p6qISmxFqaKnzQtDqLdS1oM2tgNZSlXACGom1pUbMLsLMTjkkPiORd8ep2cl/ApjuV7tsQxH15E6nsEb8j+TElRu4IUsXVfP5lw3M6S9/+OB/'),
			this.addDataEntry(dt + 'cascading menu', 192, 146, 'Cascading menu',
				'7VZdb4IwFP01PM5AQXCPm9t82RIzH/bcwYU2FkpKVdyvX0vr10Dn5kwWYxOS9tx7295z0hMcf5jXI4FL8sITYI7/6PhDwbk0s7weAmMOcmni+A8OQq76HPS0J+o1UbfEAgp5TAEyBXPMZmAQA1RyySxQEVzqqYBYbXlfScGnMOSMiybuQzNUJKWMbeFpM3QFwQlfKNBTixIEzUGCTip4oevsFUBIqPe20UC2hxFwtYVYqpQFTSSxGbf27gRoRlZlQWhAXBkgW9duWFETS0w3SX6LpAlRDX0lSl1fE6QboTFmd4xmhYrkNElYww8v5IR+6Gyvr3kpcUyLTC/DzfIZUrmCBFQq/832eAp96Hf0BRYTwLCkc9jZ/xRKgxalI6FiyGW0gOqvqLVcRug/cOn/lEt7xJhTdTJyl7uSrCp4mlYgW9yvL3aUHP3vbaCDrQRXBPQOrnnljU3kdabdrJflCevFBOLpF2uwxcZHVnqgLmcJm3GsLEG3LJY2t2d73JZp0GUYp6lk7+db27Gn30RnEC1siTbGGSjkXQCeXh/RgUcUBWfQI2rp8TpjVzM7pIPnhmcQYnABbhZduJup5eYv16Rv/wR/Ag=='),
			this.addDataEntry(dt + 'menu disabled actions', 85, 190, 'Menu with disabled actions',
				'7VZdb4IwFP01PM5AQXCPm9t82RIzH/bcwYU2FkpKVdyvX0vr10Dn5kwWYxOS9tx7295z0hMcf5jXI4FL8sITYI7/6PhDwbk0s7weAmMOcmni+A8OQq76HPS0J+o1UbfEAgp5TAEyBXPMZmAQA1RyySxQEVzqqYBYbXlfScGnMOSMiybuQzNUJKWMbeFpM3QFwQlfKNBTixIEzUGCTip4oevsFUBIqPe20UC2hxFwtYVYqpQFTSSxGbf27gRoRlZlQWhAXBkgW9duWFETS0w3SX6LpAlRDX0lSl1fE6QboTFmd4xmhYrkNElYww8v5IR+6Gyvr3kpcUyLTC/DzfIZUrmCBFQq/832eAp96Hf0BRYTwLCkc9jZ/xRKgxalI6FiyGW0gOqvqLVcRug/cOn/lEt7xJhTdTJyl7uSrCp4mlYgW9yvL3aUHP3vbaCDrQRXBPQOrnnljU3kdabdrJflCevFBOLpF2uwxcZHVnqgLmcJm3GsLEG3LJY2t2d73JZp0GUYp6lk7+db27Gn30RnEC1siTbGGSjkXQCeXh/RgUcUBWfQI2rp8TpjVzM7pIPnhmcQYnABbhZduJup5eYv16Rv/wR/Ag=='),
			this.addDataEntry(dt + 'menu disabled actions', 170, 222, 'Menu with disabled actions',
				'7ZZLT4QwEMc/DXce+/Io6K4XE6MH47ELAzRbGFK6Lz+909J9hV3dqJiYACFhpvNvO78hQ50gKjYzyar8ERMQTnDvBJFEVM1bsYlACMd3eeIEd47vu/Q4/vTCqGdG3YpJKNU1Ar8RrJhYQuNpHLXaCuuoQPICFEgySyzJGyaszkHP4JJR56zSoRJiWjJMuRARCpRGHaTm0mFK4gKORsBczQQJrsnpkWH3A1LB5mJOxmUTmgHS7uSWQtY8UbmNGDd5uznwLLeyfbqsbhzZXntARC+W0nliQYvYA03Sokbb1zR0Ijxm4lbwrKSRgieJDglTLNULf9fR3lBDqFjMy0ybIzIl1DT4ahO6Goz/PTCB5SJBMMVXcDL/OVh2iSfktLLvbq3APVVgmtagWnD3G7uK96DFO2Txouet0fgd8B62eE9RrplMukeuBUcNYm7u/1GK8aCDUoy+bs675iu4acyXm+zffuC7TvDjhjLqAOu4hfUZYspY6MxigTX03/qnVfG6qMqkVZUZYib6P6sRDCYdIL9pIX/DpVrOe+ZGMPmF4wyZh8N8E3581v8A'),
			this.addDataEntry(dt + 'scrollable menu', 272, 420, 'Scrollable menu',
				'7ZhbT8MgFMc/TR9NoLS7PLqpe9Fo4oPPZD1dibQ0FHfx0wstuwmui7MxxpI0hQMHDv9fF3YIyDRfzyQtsweRAA/IbUCmUgjV1PL1FDgPQsSSgNwEYYj0E4R3X/TiuheVVEKhznEIG4cl5W/QWBpDpTbcGqqMlqYqYa6nnFRKileYCi5k3U+gLronZZwf2NO6GI+MJmKljVg37HogFay/jLk22YBnIHJQcqOHrFiiMhv30AaaAVtk1i2ym0W0agyLne9eAl2xKvgVIY4ij6ViojBDFOT6hR2J9F6MNGZXbE75NWeLQvfkLEnMkElV0jkrFtqE9q17SE3ceGCkE4V6Zu9mOhzrtoRKt17sfs/WLfyubo1NAqeKLeFo/ku0jFq1dD+3/6alXeJJML1yiDbH02w9RJpWoBztd4GdhSNuxUF6HF4co6gDHINWHFGPw4sDb7X7UR7DVh5xz8PPYzDqgMeolceg5+HlEWLUAY9xK49hz8PPI+7iON9CPgFk1APxAxl3caBj3Apk/BtAPiVmu4TtD4AipIuTHrtpr5Pkof6n4ycy7OKsx27a7eh/8iKiEIXnDiKpy4XCHjscyBy5IuMxukxlu9iVnXv3hze+XHTd3F8sNcMP750+AA=='),
			this.addDataEntry(dt + 'cascading menu', 604, 590, 'Cascading menu',
				'7VvRbqs4EP0aHoswTkjuY5O7e7VSd1VttNpnEpxg1eDIkHvb/fo12NDAQEoDTtVCpKrBYIPPmTP2zBALr6PnH8I/hn/ygDAL/2bhteA8Vd+i5zVhzHIdGlj4u+W6jvyz3N9bzqL8rHP0BYnTLh1c1eGnz05EtaiGJH1huuFIBI1ISoQ8jHksW1eBn4QkG8GRB0noH7NLBdnJW672lLE1Z1zkvfE+/2SXpYI/kbMzJP+oAQL+SzYieaCfh4iUPLfOKW/SE/pBuHw68SIvKTogT3X5RYM0VG0YLVVbSOgh1MPMsL7QT1TDoRzrFTL5RaPWjCAGCK44CwCKcjoZOtnE6M5n94weYnkmokHAchCO/o7GhwJTdfRA9tmjyvlIXHmcbuh/2XBoLo8FSeTRv3qKnaFzm6F7EyptF4IwP6U/SWX8PvDNIHxXW2D0fMiEZB+igNk7HkV+LC9ZMX9L2CNPaEp5hrlQ0yq5eKidLznxNUksp6Gduzo1nYjAl21YdXjRGrbnwKKRC1lC72VJ3/+RU/lY5c3vZtXb39Vkwvf7hKSA5XIWnYifA+L/SCXgu9Erp8bJS3WYQTnwIAfjEN985OJbAOL/iQMiGJX8Tvpr0t9yZoCGJaRhHPpbjFx/3wDxm1TQJzkAPx3CSYKNEkSuCSqQA7i4Z3LQ1Sak++z/vI2OurR2EqdMpt21VRfjMOL61ldcjgc51HFkb3WhYqBCXgX+w5KKoMBO0pMmO0GP6aSvZn15SxNUwBSDPY5FDr2RpvjyqxyCuZHNaTtp8IIGXTPuEGZZLHc9EhWOPdGCYKYFMF8wmweAl3K1txUV6rnpKEQ1N5E8QTB78ugLP5dGgW7ybjdXt/FXt5c7uc/p1Dwj+MMkxjAeTUZifnxgUAh6hFqFw8s/2cg0K4Eo3xZzkSHb0UV5PV3UfHjpFB4KL6seam6CSZgHecgzUU5h/S0qqjFReqlRqQs7JlJTCKYo/jpFWyKkdlyH0eT9O7gvCf7MxJLtwpzEQ464w4+Zg5mWlXzspYl41YWpA4D2194uzVwTMUgBYxdc9asE7bi2vmQw8KsE7tKrLH+lr32LirJjn9p4w7sFG5rvTAaWfzWaXrg9LPdWLqEzhjD0RTZqzemOCMEb1pkbiv3f+Wk7GXIrDUbKjQ31/vUpSXlk4XvZjGzokYfno23P/jl5MlOTaqjPA2auS9aFZPdUI0F3Vottgb/btPyWkW43Zlqi2kuptqZNzawfUfoBcXUhv1uYoA3GscPQdvOMRBt3Y8lINBToAZPGg4CPjQLMVANxQ7U9CCyV6ckyPluy54IoKIpcqsk1qVf4eyVDeKC1Z2GEIRj/Vhny95n3mgj6qGJe8XAj9k1mohQMw229PS4T0bYN3134/Nbec4dltMqGYfzeau0fnzYqg2gN8xn0ZUaoWkdetsPc+RcoMLruVj65wmRb3r240mIVuRcttsyF3yRbhGGEPGxUfIbf33o+OYD1NwJ7wVftcQam12CCfQPhYlvumQiEMQyEKzX2wr7LbePYDf2GST0Mo91JK+/TilF6YAjbLB29n5+Uc7M87AwGwcgesiQxGuUMQY88fP29tbr8/OfY/wM=')
   		];
		  
		this.addPalette('gmdlMenus', 'GMDL / Menus', expand || false, mxUtils.bind(this, function(content)
		{
			for (var i = 0; i < fns.length; i++)
			{
				content.appendChild(fns[i](content));
			}
		}));
	};
	
	Sidebar.prototype.addGMDLMiscPalette = function(expand)
	{
		var s = "dashed=0;shape=";
		var s2 = "dashed=0;shape=mxgraph.gmdl.";
		var gn = 'mxgraph.gmdl';
		var dt = 'gmdl google media design library misc ';
		var sb = this;
		
		var fns = [
			this.createVertexTemplateEntry('shape=rect;fillColor=#eeeeee;strokeColor=none;',
					358, 642, '', 'Background (Light)', null, null, this.getTagsForStencil(gn, 'background', dt).join(' ')),
			this.createVertexTemplateEntry('shape=rect;fillColor=#333333;strokeColor=none;',
					358, 642, '', 'Background (Dark)', null, null, this.getTagsForStencil(gn, 'background', dt).join(' ')),
			this.addDataEntry(dt + 'keyboard', 358, 224, 'Keyboard',
				'1dvLcpswFAbgp2GbQRLXpU2arLrqomsCsqHmViCJnaevuCi1OXhKYw9njmcyYwvkwGfQ0Y+xIYL8+FyHVfK9jGVmiG+GCOqybIdn+TGQWWZwM40N8Whwbqo/gz9dWcr6pWYV1rJol3TgQ4e3MHuVQ8vQ0LSnbGyIwyaR3eqmIbZNElZdey0j9f7bXZplQZmVdb+q4I7gwutWa+vyIPWSoixUn23YVH2vx1167N5wO/5vWbfyeHX7+6Zx459lmcu2PqlV3tO4TYY1hO0N3RKZ7pOxG+fW0Bg2Q8P+s+9fDvVkFJnXEUDnN+BR295LlEV7JvHSP8b2H+lHt7LaIrHt9jaNwmyTpftCNeZpHGe9ztgQqT2X9VIdPq+jO4yf5kmbDC/P7UxIp9tukbOA3DspOcvBkrOBnCQl55lYcg6Qq0nJMWZh0bmArqVFZ3lYdB6gO9Gi89CKhA/oXknRcYZWJZgJ7FJadjZanWAM2JW07Dy0QqFnlGd2FSk7wdAqBYNxIiRlp6cJI51rr0cH80RDis5haHQwUMSk6HwbjQ4mih0pOqanWAh2MFLsadk5As0OZoqElp2PVylgqPhFyk7NULDsOAwVB1p2Dlqt4DBUZLTsfLRaoefgZ3YfpOwmszumL0WuYQdDxZGU3WR6t6odTBURKbvp/G5VPJgr3mjhTSZ4q+LBZPFCC28yw1sVD0aLghTedIq3Kh7MFjktPAexYMBwwRbi+f3jEo+Zq+Pxid1qdAJmC06KznbQ6GC0EKTofBONDiYLixQd4xaaHUwWNi0720Ozg8nCoWXn41UKGCxcUnafnzWCHcwVHi07B69WwFjh07Lz8WoFTBUmKTvB8WoFDBWAbvYe7Py47+4bf9jncfbQJOmu052983pym/aGbdyNf6eDbhJlBbxsrPfn8vbs2+EsGCm+APcSRoemCiOJgCfYZLQT8LDTxeRcT39BeJMeTBWGeGKLo8Xc1QC2/nWoyWUo113tvLVgtjB4cIMewvcWk0mea62nB9PFAyk7cB3KNdfDg/EC2OnBTvVMq2bp6GYFW3uzvdPoZk5qqjNzcs6MbrrtJiEYIr5QG6JERgcgp5h2/eNzyc9xh/hSuOEDvD6q/XMSzOaqwj1qKgwQV4+s8TdgSw4rEViuFaj2unwt4h6ddV2Hk1fcqRaY0zMSDmdMHxgXkxH7v+HUy78/0uuXXfyG7w8='),
			
			this.addEntry(dt + 'snackbar', function()
			{
				var bg1 = new mxCell('Archived', new mxGeometry(0, 0, 358, 48), 'shape=rect;strokeColor=none;fillColor=#333333;fontColor=#FFFFFF;align=left;spacing=16;fontSize=13;spacingLeft=8;');
				bg1.vertex = true;
				var text1 = new mxCell('UNDO', new mxGeometry(1, 0, 88, 48), 'text;verticalAlign=middle;align=center;fontColor=#EEFF41;fontSize=14;resizeHeight=1;');
				text1.geometry.relative = true;
				text1.geometry.offset = new mxPoint(-88, 0);
				text1.vertex = true;
				bg1.insert(text1);
			   	return sb.createVertexTemplateFromCells([bg1], 358, 48, 'Snackbar');
			})
   		];
		  
		this.addPalette('gmdlMisc', 'GMDL / Misc', expand || false, mxUtils.bind(this, function(content)
		{
			for (var i = 0; i < fns.length; i++)
			{
				content.appendChild(fns[i](content));
			}
		}));
	};
	
	Sidebar.prototype.addGMDLPickersPalette = function(expand)
	{
		var s = "dashed=0;shape=";
		var s2 = "dashed=0;shape=mxgraph.gmdl.";
		var gn = 'mxgraph.gmdl';
		var dt = 'gmdl google media design library picker ';
		var sb = this;
		
		var fns = [
			this.addDataEntry(dt + 'date picker portrait', 328, 484, 'Date picker (portrait)',
				'7Zxdc6IwFIZ/DZfdSQgiXHbtx8VutzvTzvSa1SjMojCQ1rq/fhNBiz3YVsuJe5jVqSMhATyPoed9OeiI0fz5uojy+CabyNQRl44YFVmmqnfz55FMU8dlycQRF47rMv3nuFd71vL1WpZHhVyojwxwqwFPUfooq5aqoVSrtG4o4yg3bws51pv8Ok3SdJSlWbFeK6brh24vVZH9lo01cv0wa+Joki11I9cL9f5koeTz3mNeN9UHfC2zuVTFSndZJhMVVz2EG1TDYpnM4nqYF3hVY1RWDbPt2JcQ6Dd1FNojIkBE7uNHx9Xj2Hle6FcuDgwRY6EfBKY9W6j3Q7fIFiZqUZrMFnoxlVOzzTKPxsliZqLo15u6S/6YnQqhl01Ak3GUntejfmVKZXO9opCl7vZQR+7DBNzjCIR+1VbINFLJk9zZ/meoeICKBjEEIPRHUi3RmCeTienymsDV+vES3fss1yv8N8PNB3rZ7OfWdFEr3TRkxwdaHPlVZ0iBHrScEPxUbT/O8cH2LszzsGC7rDETxjpossD8TntdRLrew88s0Tt22Wp3ZmxGZNNpKRUgsz2uD8HyASx9ikpMjy5mxzHAuGgDtu5QHwfvHGA9gH3hnl+fmxtM9fyhBXXYNgNnfZ6BW4DBQAwBQGqTMgD87g4G1zqDGiQDZp6op8IQLep6miKEPQRhv6ES9rdPYJtokSHBGUBxTw6FG2xODqRRcIDigRwKzw3DHqCAUpverBgMGe8BCqjxr8ihGHLm9QAFFPZksqVG2spa/ldQS6A4lP68cxRbCWJJElpHE6CggULfpYrGDoetN9ItB6jNoRlMhMPJRAcSGii7PfJobIsQJDRQmg/Io7EtSnDQuFCq++TR2BYpSGigdD/c0X8Pzc6lSQtobIsWJDRQygfkZ43tTBkJDZT2IVU0ljj4KBygrt/YwvRAnC5VxmHTIvTpK33ruTIOG6j0N8YxYTbWk2UcNlD9v1ELpscmeWlo7CsHay37OprptprsNdNOCPoecyFB1j3Beo9nG2WCSxSaBpy+a2A9ycZhA10DTt82sJ5lo7AR0DbgZH0DOyAEQwEBTYIj6v7+ERAnS7OR2ECXgNO3CWyn2UhsoE3AyfoEJ0uzkdi01fqTZ2PblEZiA62DHhQJ2E6Ykdi0FAnQtw5sJ8xIbKB1QLdywBIIlCInARV/D+oErCfMOGyg4u9BoYD1hBmFjQcVfw8qBawnzDhsoAmAUCrQ+4QZhw00AXpQK2A9YcZhA00AusUCp0uYcdhAE0CQNQEsgUApPfeg4h+d/xhdft8H4/XN4PsqznbuQTY3ZyzjRMk73WqGLosod5r3JbODOXd8DbQesNpZapAdtlwMHXR0MZT7u1dDzzYb7hY1NBBuv/3HvIs5RMQcIlDWiy+/JlR1b/7Y0F8='),
			this.addDataEntry(dt + 'date picker portrait dark', 328, 484, 'Date picker (portrait, dark)',
				'7Zxdc5pAFIZ/DZfp7LKIcJnSJBdtms4kM7mmugpTFAZIjP313QVU9GCqlrPmOCWTDOwH4Puw5LycRUsEs7e7PMyi+3QsE0vcWCLI07Ss12ZvgUwSy2bx2BJfLNtm6teyb/fU8qqWZWEu5+UhHey6w2uYvMi6pC4oymXSFBRRmOnVXI7ULj9P4iQJ0iTNq1rh2PpHlRdlnv6SrRpZLbomCsfpQhVytdEcT+alfNt7zlVRc8J3Mp3JMl+qJot4XEZ1C2F7dbdIxtOo6eZ4Tl0YFnXBdN13I4FaaVToVkQARZ6iF8tW/dh1lqu/XBwp0aBadHk6L1vlk2oB0s3TuVYtTOLpXG0mcqL3WWThKJ5PtYpus6vH+Lc+qBBqWwsaj8Lkuun1My3LdKYqclmoZs+NcgcTsE8j4Lt1WS6TsIxf5db+/4WKA6goEEMAQn2kskONWTwe6ya7BG6rZaPuU5qpCvddubkmqY/zoJuUS1U0ZKcLLU681BmS0IOOG4KblOuPc7rYm8v9cLFt1hoJIyWazDGvaacPpZsj/EhjdWCbLbdHxqpHOpkUsgRk1ud1ECwXwFK3qFi36GN0nAKMiy5gVYPmPHjvAJsO7BN33Obe3GKqxg8tqMOuETi95BG4BugNxBAApDYoPcDv8WhwnSOoRXJULai3Qh9NdTVMEWT3gez3VGR//wa2UosMCc4AiidyKGxvdXMgjYIDFM/kUDi2718ACmi16Y2KwZDxC0ABPf4tORRDzpwLQAGNPZloqRW2so7/FdQCKA6tP+8dxdqCXAoKDwUFNPY2FRRmdF8/++hXd+i94cPeD6r72UwEEgpoox1yKEybCCQU0FoPyKEwbSJwUNjQWrvkUJg2EUgooLU+/on731B4LPgcOJdjIpBQQGvtkRsVpiNXJBTQWvtUUBjS3UXRHfro1WPYjy/8+UJXHBYdRpqekzYeu+KwgE569SCWEAvjwSsOC+iu35lLpfrGWaHV35lOtY6JOqdNncxwPZFtd7JCLwRdh9mQIOufYHPEq5VTwCUKTTqn59KNB8E4LKBL5/RsuvEoGIWFgDadk/HpZoQXDEV4aMpPmAd37kFgOgxGYgFdOadny02HwUgsoC3nZHz52cJgJBZdc9nJsTD9EBeJBbTqBJPepgNYJBYdSW96Vt10AIvEAlp1OplwQ8KjTMIR0FETzHsbD2BxWEBHTTDxbTyARWHhQEdNMPNtPIDFYQFNNkLq++ICWBwW0GQTzH0bD2BxWECTTSf5fb4AFocFNNmCjMk2JDzK1GUHOurg+ntw822f+LsvD++bAbX1zqp+KXURxaV8VKW66yIPM6v9His7mmvPOb+mw3Jrq0V22JH8G/SU/OPudvbvarXjflFDw/7w9T/mbcw+ImYfgbLa3Hz7TN28/eU0fwA='),
			this.addDataEntry(dt + 'date picker landscape', 512, 304, 'Date picker (landscape)',
				'7Zxbb9owFMc/TR47+ZLrY0cvD1vXSa205wgMiRYIStJS9ulnE0OBY1pgsdeTjaoScexc/r/EnPPnBI8Ppi+3VTrP7sqRKDx+7fFBVZZN+276MhBF4TGSjzx+5TFG5L/Hbg6spau1ZJ5WYtYcM4C1A57T4km0LW1D3SwL3VBn6Vy9rcRQbvLzOC+KQVmU1WotH69esr1uqvKn2FojVi+1JktH5UI2Urmg9yeqRrwcPOZVkz7gW1FORVMtZZdFPmqytkdA9YFmIp9kehgnftuY1m3DZDP2VQL5RqtgVoQDRR6zJ4/JcaE8KUrkOVzOK9mD8hOlIiQJ41i1l7PmfQln5Uyplxb5ZCYXCzFW26zn6TCfTZSaod7UQ/5L7ZRzuayEzYdpcalHNeX8ddCjWrii/rEY2LsYaBhbwuADDFLxCCguD78xnPY0H41Ul32pb1avfUXCN3WlgVxW+7lXXZqlbIrUVVCJWnb4ocU4+trm54nqt/cxqUSRNvmz2Nn+nwgdGGaAsGg2p3O+2P6V+jtNbEa2LvmhFE1U50t94PrVA8gnzkI9i2zPLMSh+CEQX84tuerRxdV+DgDKTQBWHfRxUHtAfJZEAAjzDVO9NSKR6XaY/BO3Q0LWH35/63aIgfgPJ6tuvHa3MMRE/bmeVEzRCjtRRb3T72Uuj4WRpd5MuDuiHI9r0QDVN4d6FIgEgLhDB8I4mfimeOUDg6AEkHhERyKQkx9+EhSQ+IGOREgjODmhIwGTVnz3RERJgp8ETJZv0JGIid+DzwmYL+MLneIkhp8T2EInChNq2jmJTS7hKDEzkvETa2TWDki3ZGC2zdCTMaYbFslQQmyggWk3dFexoTEnICE2NDAp99GjMWck6NDAND1Aj8acomBDw2DeHqJHY85Z0KGBifzpTvt7aHa+63MRoBmTGHRoYGYfo79rXMfOltDAVD9Bj8Z58LzeTrdoYO6/to0Rs3EePdthY3AD8NsBzsNnO2ygH7C2lhGzcR4/22EDDYE36q3k2HxeKxqHSq6MpVVnM91UbO0z7YRgFAQA4FrkLgHqHV6sfTG7QKGNQPH7CM7DbjtsoI9A8RsJzuNuK2w4NBIofifBeeAd+jbYQCfhjKK9j8bGeeBthw2DbPB7Cc4DbztsoJdA8ZsJzgNvO2xMhffo2Th3ru2wgWZCH2oLXMfQdtgYigsYfjauY2g7bKCZ0IPyAucxdGKjXIpDX6AH9QXOY2g7bKAv0IMCA+cxtBU2PvQFelBh4DyGtsMG+gIWSgx6H0PbYQN9gT7UGLiOoe2wgb5AD4oMnMfQdthAX4Dj9wVcx9CbuaZbNtAXGFx+G1x/PcRn/3nvQ8VrO08qqwc/FlneiAfZqoYuqnTrxyV0j9PQd/zdqR6w3FnaIhsZHmYOTn2Y+eC3qGRn7xeBjTIsH9oM91/+Y97FnFjEnFigLBdff/Gn7b79g0C/AQ=='),
			this.addDataEntry(dt + 'date picker landscape dark', 512, 304, 'Date picker (landscape, dark)',
				'7Zxdb5swFIZ/DZed/MFHuOzox8XWdVIr9RolTkAjIQLaNPv1s8FJkxynTTLs9nSjqgTGBvM+xpwXm3g8mT5fV+k8uylHovD4pceTqiybbm36nIii8BjJRx6/8Bgj8t9jV3v20nYvmaeVmDWHFGBdgae0eBRdSpdQN8tCJ9RZOlerlRjKQ34d50WRlEVZtXu5z9SfTK+bqvwlNvaIdlF7snRULmQilRv6fKJqxPPeOrdJusLXopyKplrKLIt81GRdjoDqimYin2S6GCd+l5jWXcJkXfZFArmiVTArwoEi99mjx2S5UF4UJfIazueVzEH5kVIF7aLSy1mzkT5uFyDhrJwp9dIin8zkZiHG6pj1PB3ms4lSM9SHust/q5NyLreVsPkwLc51qaacvxS6VxsX1D8UA3sTAw0HljD4AINUPAKKy+o3hsue5qORyrIr9VW77CoSvqorVcjUeW5VlmYpkyLVCipRywwPWoyD2zY/TVS/u49JJYq0yZ/E1vH/RujA0AOERbO+nNPFfmnXh4vNyEaTH0rRRHW61Hvary5AvnAW6l5ks2chDsUPgfiyb8lVjj5a+ykAKDcBaDPoelB7QHwWRwCIery4IxKZbofJP3E7xGT18Huv22EAxL87WnVj293AMGwX152KKVphR6qoT/qzzGVdGFnqw4TbJcrxuBYNUH1d1YNAxADEDToQxs7EN8UrHxgEJYDEPToSgbQJ+ElQQOIBHYmQRrBzQkcCmlZ890RESYyfBDTLV+hIDIj/CZ4T0C/jC50G8QA+J7CFThQaato7ibWXcEnCj62RWL3x6JcEdNcMHQmjnbBIghJiAwW01fDt6UdHYTYUITYU0GT76FCYHQU6FNBmB+hQmC0FNhQM+uwQHQqzp0CHAhrt49+Ev4ViQJKvie/aVKBDAZ32AN1d4TqWtYQCWu0YHQrnwezqOP2igF579ZoWEQvn0awdFga3jc9uOw9n7bCAfnv1qhYRC+fxrB0W0HC/Ml9Jls3ntVJ/Z8rSOkwyTk06meF60tjuvIJeCEZBAACuRO4ToD7h2eo9k12g0LZTfL7deVhshwX07RSfcXceF1thwaFxp/icu/PAOPRtsIDO/YRJbO/NwnlgbIcFgyzweXfngbEdFtC7U3zm3XlgbIeFaWI5OhbO3/TaYQHNO8axctcxrR0WhsFyho+F65jWDgto3hEOlzuPaWMb03k49N0Ix8udx7R2WEDfjXDA3HlMa4WFD303whFz5zGtHRbQd1sYMv90Ma0dFtB3Yxwzdx3T2mEBfTfCQXPnMa0dFtB3c3y+23VMu+47+mUBfXdy/iO5/L6Px+73wfsmU2192ao+XV1keSPuZKoquqjSjR8j0DmOQ93zWKEusNza2iAbGT5+DY79+HXvqCHZOvtZYGPakA9t/e23/5i3MccWMccWKMvNl1+I6bJv/oDMHw=='),
			this.addDataEntry(dt + 'time picker', 328, 484, 'Time picker',
				'7ZnbbqMwEIafhstWNuZ4maaHi2231XalvVyh4ASrECPwNsk+/drYCYchTdqGqEibKBKMPTZ8/3jwEItMs/VdEeXJA49papEbi0wLzoU+ytZTmqaWjVhskWvLtpH8WfbtnlZctaI8KuhSHONga4fXKP1DtUUbSrFJjaFMolwdFnQmh7yaszSd8pQXVSuZVx9pL0XBX2ijhVYf1ZJEMV9JI5YnUZlX41zP2ZrKi7gyF0ALQdd7b6IymTu4ozyjotjILisWi0T3IHag3RLKFolxcwJHG6NSGxY735qJPDBY+hERgIhYZELQO0EhFHpBoOx8KQ4DXPKlYhelbLGUpzOJghaqVx7N2HIhTciM9cz+qlldNbbCyGZROjFuGYvjlNZuV1wInikpUG28p3PFizjHqmF/TI3Q+7wYDhBj8gCEkNcu3oIBoO6TpIEX+9tzM48CqCZ6VBDFRlp8dCxA0g/QOMiw1S4bM4A5bfB1UE+wo8/jdQHepzPiHYCdY5+NnXd8KpWOLC8pTBJ1zuxLBp9ZnFsHrx1a2zTW4LNbp01AJ1m8fk8m7SKKozJRz4VqfW15ZeuFekJeLrI4vRQso79zNnvRsbUny4LH0a7lYNwW+rYPJOpfhphdJ9IfhhcmneB2jxXPe1s8x22rZ8PMsOtz6vAOgHj45JnBuVbfj8J7O/JthNrwHB+mhnAYdiFgB3PDl2bndNJGCNPGUOwwAvCcUcMjOITwelLuSeBhAM8dF7zOqiWedz54sDjyRgUPOx14ATkfPFg2+aOC57c3kmcNPFjlBKNiR8jhjDfU4wKWMOGo2OH2Hs92e6q/odjBEgbD1xxfGV4n8Hr3KUMtWljd4HHtkDsZr3eDPBS8nupiXFvk7rMWE+d89GB9MZ18n97c7yPYvH8COdVFtK5rf/Lc0gX5KmGCPkurcl3Jmhy8kXyfONuXafhEIrQlAAL4Pa9+XGMraBoJ9tqubftUMbM/cSYvajf1BfbaAXDhdpTl83lJBdB1dxdHSW3Daujx23+Z2zKHA8ocDqCyPK3/8dHdm38I/QM='),
			this.addDataEntry(dt + 'time picker dark', 328, 484, 'Time picker (dark)',
				'7Zldb5swFIZ/DZet8AdflwnterF2rdZJu5xQcIJViBF4TbJfPxs7CWCS0jWgIi1RJHzsg+F5jw8+xEJhtr0rojx5YDFJLXRrobBgjKujbBuSNLWgTWML3VgQ2uJnwS8nekHVa+dRQda8jwNUDq9R+psoizKUfJdqQ5lEuTwsyEKccr6kaRqylBVVL8JQfoW95AV7IfueNVsTaUyimG1EG4hGVObVKW6WdEvE/HM9Nyk42Z68/sqkL/6OsIzwYieGbGjMEzUCQV+5JYSuEu2GfayMUakMq4PvEYc40ES66SCDDrLQDNnvZORUH2lna16zL6vPKXZRSldr0VwIFKSQo/JoQdcrYbL1uZ7pHzmr44u2xEgXUTrTbhmN45Qc3eaMc5ZJKeyj8Z4sJS+E+6oB/02NwP24GNgQY/ZgCCGunZ+DYUA9JUkNL/D2bT2PBCgnepQQ+U5YPLsvQNQNUDuIsFUuO30C3azxxXZHsNsfx+sYeJ9GxDsAOwxHY+f2z6LCkeYlOZMkOpPBRxbn3sFthtY+jdX4HNZpHdBFFq/XkUnbiOKoTORzoVpfe17ZdiUfjterLE6vOc3Ir5wuXlRsNQH6djgPsQGw3vNm3Bbqtt9I1D81MXhMpN81L4Bawe30Fc89Lx52mupBMzMcxlw6vH1DPDBOZugN73zkQ9tuwsOemRqCYdgFBjszN3xqdriVNgIzbQzFDtgGPDxpeAgEJryOlHsReMCA50wLXmvVItcdD55ZF7mTggdwC56PxoNnlk3epOB5zY3kqIFnVjn+pNgh9HbGG+pxYZYwwaTYgeYeDzod1d9Q7MwSBpivOT4zvFbgde5Thlq0ZnUDprVDbmW8zg3yUPA6qotpbZHbz1qA8Hj0zPoinH0Lb+9PEazfPzI5HYtoVdf+YLmlCvJNQjl5FlbpuhE1ufFG8n3i7F+mgQuJ0JTAEMDrePXjaFtB0ojT12Zt26WKnv2JUXFRh6mvgNsMgCunpSxbLkvCDV0Pd9FLamhWQ49f/8vclDkYUOZgAJVF8/hnjxpe/y/oLw=='),
			this.addDataEntry(dt + 'time picker landscape light', 512, 304, 'Time picker (landscape, light)',
				'7Zldb5swFIZ/DZet/AEkXCZp14u1a7VO2uWEghOsQozAa5L9+tnghI/jNKlSsiKNKBIcc7D9vPaxDzh0lm7u8jCLH0TEEofeOnSWCyGrs3QzY0niEMQjh944hCD1d8iXA6W4LEVZmLOVPMWBVA6vYfKbVZbKUMhtYgxFHGb6NGdz9cjpgifJTCQiL0vpojyUvZC5eGGNElYeuiQOI7FWRqwuwiIrn3Oz4BumGjE1DWC5ZJuDnShNpgd3TKRM5lt1y5pHMq7u8LBpecz4MjZuFLmVMSwqw3LvWzNRJwaLHREFiKhDJxS9ExRCgT8ea7tYyeMAV2Kl2YUJX67U5VyhYLm+KwvnfLVUJmSe9cz/6Fo9BWiqMfJ5mEyMW8qjKGG121RIKVJV4KPaeM8Wmhf2T1WDHFUD++Oe1HCBGpMHoIRqvHyLBqB6SJMGXzzaXZt6NEFd0aOmKLfKMkKnEqR2glvj4PqVyzGiLjofqAeAPl0Q6EfQGqHL0fJPj5fKkWcFg5GgDoy2GX/ODDQOhJje7wjB4bSfSE1Ae+M5hEaWcNlFFIVFrIN/OYd2vNLNUi+D18s0Sq4lT9mvjM9fqtF0IJSCNWdfcnSk5lW3j0Tjn4YYqaPld8Mr6IxmrxMe8Kla+m9qiTFqa4ksox1Zo+35Wo6BlvjDQ4N7o38WmB8wEajnteBRyM4N+gkUAUAHI8WnRheQFjqfXgzdbsQ32LkDY+e256xnGXd+T/AwgOcNC57XWbzGcPXqDR5Mh/xhwcPtgEcsq0Vv8GCiNBoUPDLC/27kwbxmPCx41D8e8/paMGAOEwwLHumMvN2G7hLwYEqD4buNT02PtlcM21alr2kLsx08rC1yN+jZtsh9wbOkFwPbJHeWW0ui3Rs8mGDMJt9mt/eHADa7TyGmOqeu0twfInOq/Hwdc8melVW7rlWKDt5Cvk+bdyfIb2vQiZxAgN3boaYAu7UpZ0ko+Ws7t7WpYmp/Elw1al/1FfbbyfmV11FWLBYFk0DXfS9OkprAfOjx63+Z2zIHPcoc9KCyuqy/8lS3Nz8C/QU='),
			this.addDataEntry(dt + 'time picker landscape dark', 512, 304, 'Time picker (landscape, dark)',
				'7Zldb5swFIZ/DZet/AEkXCa068XatVon7XJCwQlWTYzAa5L9+tlgEsDOl1KyIi1RJHzMwfC8x8c+xMFhun7Ioyx54jFhDr53cJhzLqqjdB0SxhwEaOzgOwchIH8O+rKnF5a9IItyshSnOKDK4T1iv0llqQyF2DBtKJIoU4c5mclLTueUsZAznpe92EXqK+2FyPkbqXuWfEmUMYlivpJtKBtRkZWXuJvTNZHjT/XYJBdkvff+S5O++QfCUyLyjTxlRWORVGd4UN90Qugi0W4YuJUxKirDYuu7wyEPNBE7HWzQwQ6eYHAmI6/8KDtfioZ9Xn72sYsYXSxlcyZRkFydlUUzulxIE9DXeqV/1Kie4q8w0lnEJtotpXHMyM5tyoXgqezwwc74SOaKF/RPVQMdVQP6457UcA01Jk+GEvLmxSEaBtV9mjT4wlHd1uMogmqgZ0VRbKRlBE4liO0EN9rB9SuXY0RdcDlQzwD6ckWgH0FrBK5Hyz89VUpHmhXkQCawzvhLZqB2QEg/fU3IDKftRGoC2hovITSypMsuojgqEpX8yzlU80rXC7UC3i7SmN0KmpJfGZ29VdHUBjgG4TR0DYDNnqORmleP3Q3UjjY/NTG0y5bfNa+gE81eJz3AU7X0D2oJIWhrCSzRDqzZ9nItx4aW8DqpwfuYiSDlbMHDJjs36CdRBAY6M1N8anQBaqHz8dXQ1RHfYOcOjJ3bnrOeJe78nuBBA543LHheZ/Eam6tXb/DMSsgfFjzYTnjIslr0Bs8slEaDgodG8N9FnlnXjIcFD/vHc15fC4ZZwwTDgoc6kVdv6K4BzyxpoPlu41PTw+0Vw7ZV6WvamtUOHNYWuZv0bFvkvuBZyouBbZI7y62l0O4NnllghJNv4f3jPoDNx8cmpl1NXZW5P3jmVPX5KqGCvEqrcl3JEt14C3meNmcXyIc16GROQ4D67VBTgHptygmLBH1v17Y2VfToL5zKm9oOfQP9dnF+43WU5fN5QYSh6/YpTpIamfXQ89f/MrdlDnqUOehBZdnc/cFTnd78/+cv'),
			this.addDataEntry(dt + 'year picker light', 328, 484, 'Year picker (light)',
				'7Zhbc6owEMc/DY+dyQURHj308nAu7YydOc8ciZJpJExIq/bTnw2kKiVSsaVP4OiQ3Ww2/n9x1sWj8Xp7p5Ii+y1TJjx649FYSanru/U2ZkJ4BPHUo9ceIQjeHrk94cWVFxWJYrk+J4DUAS+JeGa1pTaUeiesocySwtwqtoAlfyy5ELEUUlVeuqwusJdaySd25GHVZTxZksoNGDEMbD6mNNue3HNlshu+Y3LNtNrBlA1PdVbPoCSswzLGV5kN80O/NiZlbVjtYw8SwI1Vwa0IbSnymD17BOLQrFDwiWlPiRCKgjA0dpnrj6XLZW5USwRf5TAUbGnWLItkwfOVUTGwS835q0lKKYyNoHyRiJmN+ie1lmtwKFbCtL9WubMJkMsIREFtU0wkmr+wxvqfoeK3qACIaQsEfCXtUGPN09RMeU/gtroO6j7KAhxBp9x4AmOT595M0TswTdHlQtMLjzoaSOiJS2i/t9Bvp3cBX5SptvL+tXk5lP3e8+qHPWW0KR4kh8wE7ZrH/i1CLpcl0y3Z9xs7i0TgIjEZSXSSwL4/AIqpC0UwouhGEZEBUIRfUwg+QtGo2RYFib4dxaRvPXWj2JeLL0URuVCE46+iG8UgtQIjF4toZNHJgg5SLDB2sLBt2MjiJItBqgVu97fx7E988+sUjWMtaUdZaDQM5u//JuOazcFqQjfQzzeaCNQb9Nxu7bP4mgG7xugI7RQ5ik/fHuMdWZv6Cgeokf1qMkQ1wu3G/f7niLmJORoQczQAZRgenoXV048flf0H'),
			this.addDataEntry(dt + 'year picker dark', 328, 484, 'Year picker (dark)',
				'7ZjLbuIwFIafJstKviQhWdK008VcOhKVZp0hhlhj4shxC8zTzzE2lDSXIS3pKiBQ/NvHdv7P6HDi0WSze1BpmX+XGRMevfdooqTU9mqzS5gQHkE88+idRwiCj0e+dPTiQy8qU8UKfUkAsQEvqXhmVrFCpffCCVWeluZSsSVMebviQiRSSHXopT4xb9ArreQfduwpZMGMmKeZ3EIbQ8MtxZRmu87tHiS31wcmN0yrPQzZ8kzndgQlkQ3LGV/nLsyPfCumlRXWp9jXu4cLZ0C7GbRhxlP+7BGIQ/NSwTemA90JDi+jy0Kf6avDq8u1VPB1AU3BVmbOqkyXvFgbF0M31YL/NYtSCm1jKF+mYu6ifkut5QY6wGb9aGL1HuQZAkmxCiJ/OTMvhkLeByUOraaYSDV/YbX5PwLKb4ACNrMGG2NAi0EbnmVmSDcUa/iTLKEj7CWAj3CvYzR95+lHIxkdtBntDzb6eKCXcKNM9Tj/1tnPPa9+NNBGt8RPyWFlgvb1Y3+MkKtVxXTD9tPGLiIRtpEIJhK9JLDvj4Bi1oYinFD0o4jJCCii6ySC/6GIUHKb+HUUJP50FMHQfNqO4pQurooibkMRTb+KfhSj5AqM2ljEE4teFnSUZIFxCwtXlE0sOlmMki1ws9pN5j+S+29dNM69pD1poVYwmL//25xrtgDVhG6huq8VEWgw6IXb2kfx1QP2tdYZ2hlqST5Da4w3ZN3SNzhEtdVvgjGyEW7W8o9fJ8x1zPGImOMRKEPz9cmYHX7+4Owf'),
			this.addDataEntry(dt + 'date picker landscape light', 512, 304, 'Date picker (landscape, light)',
				'7ZhNb6MwEIZ/DceubAwEjlnS9rDbdqVU2rMVnGCtg5Fxm2R//Y7BSSCQJrRB2gNEkZjxjD/exwYNDonX20dF8/RJJkw45N4hsZJSV3frbcyEcFzEE4fMHNdF8HfchzOtuGxFOVUs09ckuFXCOxVvrPJUjkLvhHUUKc3NrWIL6PL7kgsRSyFV2UqW5QX+Qiv5h9VaWHmZlpQmcgNODIYdjynNtmfnXLrshB+ZXDOtdhCy4YlOqwgf24mmjK9Sm0aQVzlpUTlWh9yjBHBjVehWhLQUeU3fHBfyAlgURrCGaa4gApOeUiEUBWFo/DLTlyXMZGbUo4KvMjAFW5o+i5wueLYyaga2qzn/awYlBGwjLF9QMbVZWubHpFdjzLB3LQb3IgYchANh8FoYQPFJS3GYvu5Y9poniQk5lfqhvE4VCT7UFftgm3FeTIjegWtidoFiBQT8tmJcvbfJ50T1qnOMFBNU83fW6P8rQvtdQnu9hd5v0wUslKm28t7M/DqU/aSMZ/amTUDfiBvarJqyxPM6tmswkLJBl7L+qOx5Ze2ovySHybho1+xmnyGXy4LpFonDXK+CM+mCE4xw+sKZuAPACW/z8L8Ep/FCtnDc6H+As/d9EQ5G4QB0oi464Xh0etPxhzg7GHXhiUY8vfGEQxwejDvw2CJtxNMDz6FEuC2edkEcT5/j+5/nANXlJR+8YhoFhykfNinXbA5ek7pRtFan2Yh+7Od2ajciahN2DauGdoLaZP2+NcoJWTv0HQ5QY/S7fce3Rd2u9F9+jJibmKMBMUcDUAbz+PGsCq9/W/sH'),
			this.addDataEntry(dt + 'date picker landscape dark', 512, 304, 'Date picker (landscape, dark)',
				'7ZhLb+IwEMc/TY5d+ZGEcKTp47CPrkSlPVvEEGtNHDlugf30O04MTUigpCVSDzFCiscz9vj/s0ETj8br7aNmefpTJVx69N6jsVbKVE/rbcyl9AgSiUfvPEIQfD3ycGIUl6MoZ5pn5pIAUgW8MvnCK0tlKMxOOkORstw+ar6AKW+XQspYSaXLUeoT+wF7YbT6y2sjvGx2JGWJ2oARQ8etx7Xh25M5lyaX8CNXa270Dlw2IjFp5RFgl2jKxSp1YRT5lZEVlWF1iH2TAB6cCt2K0JYiz+mLRyAuhE1hBHuY5Ro8MO0pVVA2a1eZqdmXZWtJmKnMqsekWGXQlXxp5yxythDZyqoZuqnm4p9dlFLoW2HFgsmZizIqfwt6tp077F+KgbyLAYfRQBj8FgZQfNJSHNI3HdteiySxLsdSP5TtWJHwrK7YIrPrPFkXswPTxJ4CzQtw+OPEuPhs04+J6lf3GGkumRGvvDH/Z4QOuoT2ewu9P6YL2CjXZw75sbIflPHE2XQB6BslkYuqKUt9v+O4hgMpG3YpG4zKnlbWrfpbCUiGoF1zmn2EWi4LblokDrleBGfSBScc4fSFMyEDwImu8+P/HpwIxbex34RDpl8Bzt72STgYRQPQmXbRicar05tOMMTdwagLz3TE0xtPNMTlwbgDjyvSRjw98BxKhOviaRfE8exXfP/jFKC6vPTMX0yj4LDlwyYVhs/BakM3mtXqNOfRj/3cpXYloi5g1+jV0E5Qm2zQt0Y5IuuWvsEhaqx+s5/4uqjblf7T9xFzE/N0QMzTAShD9+3lWeVef7f2Hw==')
   		];
		  
		this.addPalette('gmdlPickers', 'GMDL / Pickers', expand || false, mxUtils.bind(this, function(content)
		{
			for (var i = 0; i < fns.length; i++)
			{
				content.appendChild(fns[i](content));
			}
		}));
	};

	Sidebar.prototype.addGMDLSelectionControlsPalette = function(expand)
	{
		var s = "dashed=0;shape=";
		var s2 = "dashed=0;labelPosition=right;align=left;shape=mxgraph.gmdl.";
		var gn = 'mxgraph.gmdl';
		var dt = 'gmdl google media design library selection control ';
		var sb = this;
		
		var fns = [
			this.addEntry(dt + 'checkbox on hover light dark', function()
			{
				var bg1 = new mxCell('', new mxGeometry(0, 0, 16, 16), s2 + 'checkbox;strokeColor=none;fillColor=#009587;strokeWidth=2;aspect=fixed;');
				bg1.vertex = true;
				return sb.createVertexTemplateFromCells([bg1], 16, 16, 'Checkbox (on, hover))');
			}),
			this.addEntry(dt + 'checkbox on focused pressed light dark', function()
			{
				var bg1 = new mxCell('', new mxGeometry(0, 0, 48, 48), 'shape=ellipse;labelPosition=right;align=left;strokeColor=none;fillColor=#009587;opacity=10;');
				bg1.vertex = true;
				var part1 = new mxCell('', new mxGeometry(16, 16, 16, 16), s2 + 'checkbox;strokeColor=none;fillColor=#009587;strokeWidth=2;');
				part1.vertex = true;
				bg1.insert(part1);
				return sb.createVertexTemplateFromCells([bg1], 48, 48, 'Checkbox (on, focused or pressed))');
			}),
			this.addEntry(dt + 'checkbox on disabled light', function()
			{
				var bg1 = new mxCell('', new mxGeometry(0, 0, 16, 16), s2 + 'checkbox;strokeColor=none;fillColor=#B0B0B0;strokeWidth=2;aspect=fixed;');
				bg1.vertex = true;
				return sb.createVertexTemplateFromCells([bg1], 16, 16, 'Checkbox (on, disabled, light))');
			}),
			this.addEntry(dt + 'checkbox on disabled focused light', function()
			{
				var bg1 = new mxCell('', new mxGeometry(0, 0, 48, 48), 'shape=ellipse;labelPosition=right;align=left;strokeColor=none;fillColor=#B0B0B0;opacity=10;');
				bg1.vertex = true;
				var part1 = new mxCell('', new mxGeometry(16, 16, 16, 16), s2 + 'checkbox;strokeColor=none;fillColor=#B0B0B0;strokeWidth=2;');
				part1.vertex = true;
				bg1.insert(part1);
				return sb.createVertexTemplateFromCells([bg1], 48, 48, 'Checkbox (on, disabled, focused, light))');
			}),
			this.addEntry(dt + 'checkbox off hover light', function()
			{
				var bg1 = new mxCell('', new mxGeometry(0, 0, 16, 16), s2 + 'checkbox;strokeColor=#666666;fillColor=none;strokeWidth=2;aspect=fixed;');
				bg1.vertex = true;
				return sb.createVertexTemplateFromCells([bg1], 16, 16, 'Checkbox (off, hover, light))');
			}),
			this.addEntry(dt + 'checkbox off focused pressed light', function()
			{
				var bg1 = new mxCell('', new mxGeometry(0, 0, 48, 48), 'shape=ellipse;labelPosition=right;align=left;strokeColor=none;fillColor=#666666;opacity=10;');
				bg1.vertex = true;
				var part1 = new mxCell('', new mxGeometry(16, 16, 16, 16), s2 + 'checkbox;strokeColor=#666666;fillColor=none;strokeWidth=2;');
				part1.vertex = true;
				bg1.insert(part1);
				return sb.createVertexTemplateFromCells([bg1], 48, 48, 'Checkbox (off, focused or pressed, light))');
			}),
			this.addEntry(dt + 'checkbox off disabled light', function()
			{
				var bg1 = new mxCell('', new mxGeometry(0, 0, 16, 16), s2 + 'checkbox;strokeColor=#B0B0B0;fillColor=none;strokeWidth=2;aspect=fixed;');
				bg1.vertex = true;
				return sb.createVertexTemplateFromCells([bg1], 16, 16, 'Checkbox (off, disabled, light))');
			}),
			this.addEntry(dt + 'checkbox off disabled focused light', function()
			{
				var bg1 = new mxCell('', new mxGeometry(0, 0, 48, 48), 'shape=ellipse;labelPosition=right;align=left;strokeColor=none;fillColor=#666666;opacity=10;');
				bg1.vertex = true;
				var part1 = new mxCell('', new mxGeometry(16, 16, 16, 16), s2 + 'checkbox;strokeColor=#B0B0B0;fillColor=none;strokeWidth=2;');
				part1.vertex = true;
				bg1.insert(part1);
				return sb.createVertexTemplateFromCells([bg1], 48, 48, 'Checkbox (off, disabled, focused, light))');
			}),
			this.addEntry(dt + 'checkbox on disabled dark', function()
			{
				var bg1 = new mxCell('', new mxGeometry(0, 0, 16, 16), s2 + 'checkbox;strokeColor=none;fillColor=#676767;strokeWidth=2;aspect=fixed;');
				bg1.vertex = true;
				return sb.createVertexTemplateFromCells([bg1], 16, 16, 'Checkbox (on, disabled, dark))');
			}),
			this.addEntry(dt + 'checkbox on disabled focused dark', function()
			{
				var bg1 = new mxCell('', new mxGeometry(0, 0, 48, 48), 'shape=ellipse;labelPosition=right;align=left;strokeColor=none;fillColor=#B0B0B0;opacity=10;');
				bg1.vertex = true;
				var part1 = new mxCell('', new mxGeometry(16, 16, 16, 16), s2 + 'checkbox;strokeColor=none;fillColor=#676767;strokeWidth=2;');
				part1.vertex = true;
				bg1.insert(part1);
				return sb.createVertexTemplateFromCells([bg1], 48, 48, 'Checkbox (on, disabled, focused, dark))');
			}),
			this.addEntry(dt + 'checkbox off hover dark', function()
			{
				var bg1 = new mxCell('', new mxGeometry(0, 0, 16, 16), s2 + 'checkbox;strokeColor=#ffffff;fillColor=none;strokeWidth=2;aspect=fixed;');
				bg1.vertex = true;
				return sb.createVertexTemplateFromCells([bg1], 16, 16, 'Checkbox (off, hover, dark))');
			}),
			this.addEntry(dt + 'checkbox off focused pressed dark', function()
			{
				var bg1 = new mxCell('', new mxGeometry(0, 0, 48, 48), 'shape=ellipse;labelPosition=right;align=left;strokeColor=none;fillColor=#666666;opacity=10;');
				bg1.vertex = true;
				var part1 = new mxCell('', new mxGeometry(16, 16, 16, 16), s2 + 'checkbox;strokeColor=#ffffff;fillColor=none;strokeWidth=2;');
				part1.vertex = true;
				bg1.insert(part1);
				return sb.createVertexTemplateFromCells([bg1], 48, 48, 'Checkbox (off, focused or pressed, dark))');
			}),
			this.addEntry(dt + 'checkbox off disabled dark', function()
			{
				var bg1 = new mxCell('', new mxGeometry(0, 0, 16, 16), s2 + 'checkbox;strokeColor=#666666;fillColor=none;strokeWidth=2;aspect=fixed;');
				bg1.vertex = true;
				return sb.createVertexTemplateFromCells([bg1], 16, 16, 'Checkbox (off, disabled, dark))');
			}),
			this.addEntry(dt + 'checkbox off disabled focused dark', function()
			{
				var bg1 = new mxCell('', new mxGeometry(0, 0, 48, 48), 'shape=ellipse;labelPosition=right;align=left;strokeColor=none;fillColor=#666666;opacity=10;');
				bg1.vertex = true;
				var part1 = new mxCell('', new mxGeometry(16, 16, 16, 16), s2 + 'checkbox;strokeColor=#666666;fillColor=none;strokeWidth=2;');
				part1.vertex = true;
				bg1.insert(part1);
				return sb.createVertexTemplateFromCells([bg1], 48, 48, 'Checkbox (off, disabled, focused, dark))');
			}),
			this.addEntry(dt + 'radio button on hover light dark', function()
			{
				var bg1 = new mxCell('', new mxGeometry(0, 0, 16, 16), s2 + 'radiobutton;strokeColor=#009587;fillColor=#009587;strokeWidth=2;aspect=fixed;');
				bg1.vertex = true;
				return sb.createVertexTemplateFromCells([bg1], 16, 16, 'Radio button (on, hover))');
			}),
			this.addEntry(dt + 'radio button on focused pressed light dark', function()
			{
				var bg1 = new mxCell('', new mxGeometry(0, 0, 48, 48), 'shape=ellipse;labelPosition=right;align=left;strokeColor=none;fillColor=#009587;opacity=10;');
				bg1.vertex = true;
				var part1 = new mxCell('', new mxGeometry(16, 16, 16, 16), s2 + 'radiobutton;strokeColor=#009587;fillColor=#009587;strokeWidth=2;');
				part1.vertex = true;
				bg1.insert(part1);
				return sb.createVertexTemplateFromCells([bg1], 48, 48, 'Radio button (on, focused or pressed))');
			}),
			this.addEntry(dt + 'radio button on disabled light', function()
			{
				var bg1 = new mxCell('', new mxGeometry(0, 0, 16, 16), s2 + 'radiobutton;strokeColor=#B0B0B0;fillColor=#B0B0B0;strokeWidth=2;aspect=fixed;');
				bg1.vertex = true;
				return sb.createVertexTemplateFromCells([bg1], 16, 16, 'Radio button (on, disabled, light))');
			}),
			this.addEntry(dt + 'radio button on disabled focused light', function()
			{
				var bg1 = new mxCell('', new mxGeometry(0, 0, 48, 48), 'shape=ellipse;labelPosition=right;align=left;strokeColor=none;fillColor=#B0B0B0;opacity=10;');
				bg1.vertex = true;
				var part1 = new mxCell('', new mxGeometry(16, 16, 16, 16), s2 + 'radiobutton;strokeColor=#B0B0B0;fillColor=#B0B0B0;strokeWidth=2;');
				part1.vertex = true;
				bg1.insert(part1);
				return sb.createVertexTemplateFromCells([bg1], 48, 48, 'Radio button (on, disabled, focused, light))');
			}),
			this.addEntry(dt + 'radio button off hover light', function()
			{
				var bg1 = new mxCell('', new mxGeometry(0, 0, 16, 16), s2 + 'radiobutton;strokeColor=#666666;fillColor=none;strokeWidth=2;aspect=fixed;');
				bg1.vertex = true;
				return sb.createVertexTemplateFromCells([bg1], 16, 16, 'Radio button (off, hover, light))');
			}),
			this.addEntry(dt + 'radio button off focused pressed light', function()
			{
				var bg1 = new mxCell('', new mxGeometry(0, 0, 48, 48), 'shape=ellipse;labelPosition=right;align=left;strokeColor=none;fillColor=#666666;opacity=10;');
				bg1.vertex = true;
				var part1 = new mxCell('', new mxGeometry(16, 16, 16, 16), s2 + 'radiobutton;strokeColor=#666666;fillColor=none;strokeWidth=2;');
				part1.vertex = true;
				bg1.insert(part1);
				return sb.createVertexTemplateFromCells([bg1], 48, 48, 'Radio button (off, focused or pressed, light))');
			}),
			this.addEntry(dt + 'radio button off disabled light', function()
			{
				var bg1 = new mxCell('', new mxGeometry(0, 0, 16, 16), s2 + 'radiobutton;strokeColor=#B0B0B0;fillColor=none;strokeWidth=2;aspect=fixed;');
				bg1.vertex = true;
				return sb.createVertexTemplateFromCells([bg1], 16, 16, 'Radio button (off, disabled, light))');
			}),
			this.addEntry(dt + 'radio button off disabled focused light', function()
			{
				var bg1 = new mxCell('', new mxGeometry(0, 0, 48, 48), 'shape=ellipse;labelPosition=right;align=left;strokeColor=none;fillColor=#666666;opacity=10;');
				bg1.vertex = true;
				var part1 = new mxCell('', new mxGeometry(16, 16, 16, 16), s2 + 'radiobutton;strokeColor=#B0B0B0;fillColor=none;strokeWidth=2;');
				part1.vertex = true;
				bg1.insert(part1);
				return sb.createVertexTemplateFromCells([bg1], 48, 48, 'Radio button (off, disabled, focused, light))');
			}),
			this.addEntry(dt + 'radio button on disabled dark', function()
			{
				var bg1 = new mxCell('', new mxGeometry(0, 0, 16, 16), s2 + 'radiobutton;strokeColor=#676767;fillColor=#676767;strokeWidth=2;aspect=fixed;');
				bg1.vertex = true;
				return sb.createVertexTemplateFromCells([bg1], 16, 16, 'Radio button (on, disabled, dark))');
			}),
			this.addEntry(dt + 'radio button on disabled focused dark', function()
			{
				var bg1 = new mxCell('', new mxGeometry(0, 0, 48, 48), 'shape=ellipse;labelPosition=right;align=left;strokeColor=none;fillColor=#B0B0B0;opacity=10;');
				bg1.vertex = true;
				var part1 = new mxCell('', new mxGeometry(16, 16, 16, 16), s2 + 'radiobutton;strokeColor=#676767;fillColor=#676767;strokeWidth=2;');
				part1.vertex = true;
				bg1.insert(part1);
				return sb.createVertexTemplateFromCells([bg1], 48, 48, 'Radio button (on, disabled, focused, dark))');
			}),
			this.addEntry(dt + 'radio button off hover dark', function()
			{
				var bg1 = new mxCell('', new mxGeometry(0, 0, 16, 16), s2 + 'radiobutton;strokeColor=#ffffff;fillColor=none;strokeWidth=2;aspect=fixed;');
				bg1.vertex = true;
				return sb.createVertexTemplateFromCells([bg1], 16, 16, 'Radio button (off, hover, dark))');
			}),
			this.addEntry(dt + 'radio button off focused pressed dark', function()
			{
				var bg1 = new mxCell('', new mxGeometry(0, 0, 48, 48), 'shape=ellipse;labelPosition=right;align=left;strokeColor=none;fillColor=#666666;opacity=10;');
				bg1.vertex = true;
				var part1 = new mxCell('', new mxGeometry(16, 16, 16, 16), s2 + 'radiobutton;strokeColor=#ffffff;fillColor=none;strokeWidth=2;');
				part1.vertex = true;
				bg1.insert(part1);
				return sb.createVertexTemplateFromCells([bg1], 48, 48, 'Radio button (off, focused or pressed, dark))');
			}),
			this.addEntry(dt + 'radio button off disabled dark', function()
			{
				var bg1 = new mxCell('', new mxGeometry(0, 0, 16, 16), s2 + 'radiobutton;strokeColor=#666666;fillColor=none;strokeWidth=2;aspect=fixed;');
				bg1.vertex = true;
				return sb.createVertexTemplateFromCells([bg1], 16, 16, 'Radio button (off, disabled, dark))');
			}),
			this.addEntry(dt + 'radio button off disabled focused dark', function()
			{
				var bg1 = new mxCell('', new mxGeometry(0, 0, 48, 48), 'shape=ellipse;labelPosition=right;align=left;strokeColor=none;fillColor=#666666;opacity=10;');
				bg1.vertex = true;
				var part1 = new mxCell('', new mxGeometry(16, 16, 16, 16), s2 + 'radiobutton;strokeColor=#666666;fillColor=none;strokeWidth=2;');
				part1.vertex = true;
				bg1.insert(part1);
				return sb.createVertexTemplateFromCells([bg1], 48, 48, 'Radio button (off, disabled, focused, dark))');
			}),
			this.addEntry(dt + 'switch on light', function()
			{
				var bg1 = new mxCell('', new mxGeometry(0, 0, 36, 20), s2 + 'switch;aspect=fixed;switchState=on;strokeColor=none;fillColor=#0E9D57;');
				bg1.vertex = true;
			   	return sb.createVertexTemplateFromCells([bg1], 36, 20, 'Switch (on, light)');
			}),
			this.addEntry(dt + 'switch on dark', function()
			{
				var bg1 = new mxCell('', new mxGeometry(0, 0, 36, 20), s2 + 'switch;aspect=fixed;switchState=on;strokeColor=none;fillColor=#80CBC4;');
				bg1.vertex = true;
			   	return sb.createVertexTemplateFromCells([bg1], 36, 20, 'Switch (on, dark)');
			}),
			this.addEntry(dt + 'switch off light dark', function()
			{
				var bg1 = new mxCell('', new mxGeometry(0, 0, 36, 20), s2 + 'switch;aspect=fixed;switchState=off;strokeColor=none;fillColor=#0E9D57;');
				bg1.vertex = true;
			   	return sb.createVertexTemplateFromCells([bg1], 36, 20, 'Switch (off)');
			})
   		];
		  
		this.addPalette('gmdlSelection Controls', 'GMDL / Selection Controls', expand || false, mxUtils.bind(this, function(content)
		{
			for (var i = 0; i < fns.length; i++)
			{
				content.appendChild(fns[i](content));
			}
		}));
	};
	
	Sidebar.prototype.addGMDLSlidersPalette = function(expand)
	{
		var s = "dashed=0;shape=";
		var s2 = "dashed=0;verticalLabelPosition=bottom;verticalAlign=top;align=center;shape=mxgraph.gmdl.";
		var gn = 'mxgraph.gmdl';
		var dt = 'gmdl google media design library slider ';
		var sb = this;
		
		var fns = [
			this.createVertexTemplateEntry(s2 + 'slider2;barPos=0;strokeColor=#bbbbbb;opacity=100;strokeWidth=2;fillColor=#ffffff;handleSize=10;shadow=0;',
					200, 10, '', 'Slider (normal)', null, null, this.getTagsForStencil(gn, 'slider normal', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'slider2;barPos=50;strokeColor=#3F51B5;opacity=100;strokeWidth=2;fillColor=#3F51B5;handleSize=10;shadow=0;',
					200, 10, '', 'Slider (normal)', null, null, this.getTagsForStencil(gn, 'slider normal', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'slider2;barPos=100;strokeColor=#3F51B5;opacity=100;strokeWidth=2;fillColor=#3F51B5;handleSize=10;shadow=0;',
					200, 10, '', 'Slider (normal)', null, null, this.getTagsForStencil(gn, 'slider normal', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'sliderFocused;barPos=0;strokeColor=#bbbbbb;opacity=100;strokeWidth=2;fillColor=#ffffff;handleSize=30;shadow=0;',
					200, 30, '', 'Slider (focused)', null, null, this.getTagsForStencil(gn, 'slider focused', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'sliderFocused;barPos=50;strokeColor=#3F51B5;opacity=100;strokeWidth=2;fillColor=#3F51B5;handleSize=30;shadow=0;',
					200, 30, '', 'Slider (focused)', null, null, this.getTagsForStencil(gn, 'slider focused', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'sliderFocused;barPos=100;strokeColor=#3F51B5;opacity=100;strokeWidth=2;fillColor=#3F51B5;handleSize=30;shadow=0;',
					200, 30, '', 'Slider (focused)', null, null, this.getTagsForStencil(gn, 'slider focused', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'slider2;barPos=0;strokeColor=#bbbbbb;opacity=100;strokeWidth=2;fillColor=#ffffff;handleSize=20;shadow=0;',
					200, 20, '', 'Slider (click)', null, null, this.getTagsForStencil(gn, 'slider click', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'slider2;barPos=50;strokeColor=#3F51B5;opacity=100;strokeWidth=2;fillColor=#3F51B5;handleSize=20;shadow=0;',
					200, 20, '', 'Slider (click)', null, null, this.getTagsForStencil(gn, 'slider click', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'slider2;barPos=100;strokeColor=#3F51B5;opacity=100;strokeWidth=2;fillColor=#3F51B5;handleSize=20;shadow=0;',
					200, 20, '', 'Slider (click)', null, null, this.getTagsForStencil(gn, 'slider click', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'sliderDisabled2;strokeColor=#b0b0b0;strokeWidth=2;fillColor=none;handleSize=6;shadow=0;hPos=0;',
					210, 20, '', 'Slider (disabled)', null, null, this.getTagsForStencil(gn, 'slider disabled', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'sliderDisabled2;strokeColor=#b0b0b0;strokeWidth=2;fillColor=#b0b0b0;handleSize=6;shadow=0;hPos=50;',
					210, 20, '', 'Slider (disabled)', null, null, this.getTagsForStencil(gn, 'slider disabled', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'sliderDisabled2;strokeColor=#b0b0b0;strokeWidth=2;fillColor=#b0b0b0;handleSize=6;shadow=0;hPos=100;',
					210, 20, '', 'Slider (disabled)', null, null, this.getTagsForStencil(gn, 'slider disabled', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'slider2;barPos=0;strokeColor=#000000;opacity=100;strokeWidth=2;fillColor=#000000;handleSize=10;shadow=0;',
					200, 10, '', 'Discrete slider (normal, light)', null, null, this.getTagsForStencil(gn, 'discrete slider normal light', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'slider2;barPos=60;strokeColor=#0F9D58;opacity=100;strokeWidth=2;fillColor=#0F9D58;handleSize=10;shadow=0;',
					200, 10, '', 'Discrete slider (normal)', null, null, this.getTagsForStencil(gn, 'slider normal', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'slider2;barPos=100;strokeColor=#0F9D58;opacity=100;strokeWidth=2;fillColor=#0F9D58;handleSize=10;shadow=0;',
					200, 10, '', 'Discrete slider (normal)', null, null, this.getTagsForStencil(gn, 'slider normal', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'sliderDiscrete;barPos=1;strokeColor=#BEBEBE;opacity=100;strokeWidth=2;fillColor=#BEBEBE;handleSize=10;shadow=0;fontSize=12;fontColor=#ffffff;',
					200, 45, '', 'Discrete slider (focused)', null, null, this.getTagsForStencil(gn, 'slider focused', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'sliderDiscrete;barPos=60;strokeColor=#0F9D58;opacity=100;strokeWidth=2;fillColor=#0F9D58;handleSize=10;shadow=0;fontSize=12;fontColor=#ffffff;',
					200, 45, '', 'Discrete slider (focused)', null, null, this.getTagsForStencil(gn, 'slider focused', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'sliderDiscrete;barPos=100;strokeColor=#0F9D58;opacity=100;strokeWidth=2;fillColor=#0F9D58;handleSize=10;shadow=0;fontSize=12;fontColor=#ffffff;',
					200, 45, '', 'Discrete slider (focused)', null, null, this.getTagsForStencil(gn, 'slider focused', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'sliderDiscreteDots;barPos=0;bright=1;strokeColor=#0F9D58;opacity=100;strokeWidth=2;fillColor=#0F9D58;handleSize=10;shadow=0;fontSize=12;fontColor=#ffffff;',
					200, 45, '', 'Discrete slider (click)', null, null, this.getTagsForStencil(gn, 'slider click', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'sliderDiscreteDots;barPos=60;bright=1;strokeColor=#0F9D58;opacity=100;strokeWidth=2;fillColor=#0F9D58;handleSize=10;shadow=0;fontSize=12;fontColor=#ffffff;',
					200, 45, '', 'Discrete slider (click, light)', null, null, this.getTagsForStencil(gn, 'slider click light', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'sliderDiscreteDots;barPos=100;bright=1;strokeColor=#0F9D58;opacity=100;strokeWidth=2;fillColor=#0F9D58;handleSize=10;shadow=0;fontSize=12;fontColor=#ffffff;',
					200, 45, '', 'Discrete slider (click, light)', null, null, this.getTagsForStencil(gn, 'slider click light', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'sliderDisabled2;strokeColor=#b0b0b0;strokeWidth=2;fillColor=#b0b0b0;handleSize=6;shadow=0;hPos=0;',
					200, 20, '', 'Discrete slider (disabled)', null, null, this.getTagsForStencil(gn, 'discrete slider disabled', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'sliderDisabled2;strokeColor=#b0b0b0;strokeWidth=2;fillColor=#b0b0b0;handleSize=6;shadow=0;hPos=50;',
					200, 20, '', 'Discrete slider (disabled)', null, null, this.getTagsForStencil(gn, 'discrete slider disabled', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'sliderDisabled2;strokeColor=#b0b0b0;strokeWidth=2;fillColor=#b0b0b0;handleSize=6;shadow=0;hPos=100;',
					200, 20, '', 'Discrete slider (disabled)', null, null, this.getTagsForStencil(gn, 'discrete slider disabled', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'slider2;barPos=0;strokeColor=#ffffff;opacity=100;strokeWidth=2;fillColor=#ffffff;handleSize=10;shadow=0;',
					200, 10, '', 'Discrete slider (normal, dark)', null, null, this.getTagsForStencil(gn, 'discrete slider normal dark', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'sliderDiscreteDots;barPos=0;bright=0;strokeColor=#0F9D58;opacity=100;strokeWidth=2;fillColor=#0F9D58;handleSize=10;shadow=0;fontSize=12;fontColor=#ffffff;',
					200, 45, '', 'Discrete slider (click, dark)', null, null, this.getTagsForStencil(gn, 'discrete slider click dark', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'sliderDiscreteDots;barPos=60;bright=0;strokeColor=#0F9D58;opacity=100;strokeWidth=2;fillColor=#0F9D58;handleSize=10;shadow=0;fontSize=12;fontColor=#ffffff;',
					200, 45, '', 'Discrete slider (click, dark)', null, null, this.getTagsForStencil(gn, 'discrete slider click dark', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'sliderDiscreteDots;barPos=100;bright=0;strokeColor=#0F9D58;opacity=100;strokeWidth=2;fillColor=#0F9D58;handleSize=10;shadow=0;fontSize=12;fontColor=#ffffff;',
					200, 45, '', 'Discrete slider (click, dark)', null, null, this.getTagsForStencil(gn, 'discrete slider click dark', dt).join(' '))
   		];
		  
		this.addPalette('gmdlSliders', 'GMDL / Sliders', expand || false, mxUtils.bind(this, function(content)
		{
			for (var i = 0; i < fns.length; i++)
			{
				content.appendChild(fns[i](content));
			}
		}));
	};

	Sidebar.prototype.addGMDLSteppersPalette = function(expand)
	{
		var s = "dashed=0;shape=";
		var s2 = "dashed=0;shape=mxgraph.gmdl.";
		var gn = 'mxgraph.gmdl';
		var dt = 'gmdl google media design library tab ';
		var sb = this;
		
		var fns = [
			this.addDataEntry(dt + 'stepper', 704, 478, 'Stepper',
				'7Zhvj5sgHIA/je/5o619uXO9y5KtW7LtA3gTKxkVg+zWfvuhQK8W2dwOlt1ykqb6U1CeBxBMcHE43omya97xirAEbxNcCM6l3jscC8JYggCtEvw6QQioX4JuPWfheBZ0pSCtXJIB6QwPJftGdEQHenliJtA3ZTfsCvJFFXnTS8G/koIzLlSw5a06d1NTxmwoQbgeNxU3pRMhydH7hGPIPN4d4QcixUld8p1WstFXrEGqszWE7huTLV3nOlj2OrA/532ssNoxdZ6vP3bqD70AVE7a9WQhgxTl2W06xHkr/5gN+iUbNIPGxgRhpaQP05rN4TJ3+MCpujECx2kxp+mhLYDXdU+kQ/v8mIsEpI6AXXkgKsLr0QLp1J/fydJGaUIlo/tWHTJSS6PmoykUBlQCQDQn2Sq+k2z5oMDoyLWigwjK2xG1GEBcOVEt/35M4TDDOcqbVRDMGE4wZzEwr6KMvffVkMJRzizRS8xwA4JgXoEp5jwC5rWDuXi/+/Rm93kbAvcwzNd/YZiHALkacJjGfmUBrVEEDbmr4dWu2L4NIeEM+0pCDob0PCRASz2qhY1jwT/o/N58Z0OG9D/Nd7B91wY1YN9aP5/xPP1V4J/xXMgpx+1Zznwi2YGOHfzSQTwdJLWDR1gF7pp0poP4rbx0kKh23BWz18Q/tzjIgnC+WhtgOxd+Cmd1+PjRR19++U3oBw=='),
			this.addDataEntry(dt + 'editable steps', 704, 72, 'Editable Steps',
				'5VfRbpswFP0aHhcZm5DkNcnal1aq1Ic9u3ABqwYj43bk72djk4ZBVqpgbdKwEtnH9uX6HPsAATmU7b2kdfEoUuAB+R6QgxRC2VrZHoDzACOWBuQYYIz0L8B3V3rDrhfVVEKl5kzAdsI75W9gEQs06sQd0BS0NlUJiQ65b5QUr3AQXEgNVqLSffuMcd5DASZZd2ncRQepoL2aYQe59O5BlKDkSQ/5yVJV2BEbFNlpBbC8cNM2LlXa2HZ+nvqxXl1xS55ePhkt/xm4WSdGCS1ryvLKkAFKsSpvrlKjg7K6gZnsRHi7vosMLip1gaPu0jinL8CfRMMUE5Vh3i56T7nJhxw5ZJ0SNU10Wg9d6xgiF/HZ5RfO5R9/yj+eoL/HJHCq2DsMwk9p4u7wJFhl+G2HYU7DZh9AZJlmfyTpOc1ZKkefb/KUNgWY4YbFXtayzc3BXOVlyleQMj/bn0zT7yag1XpA0Ll9IU+IxvL02I3yfBvevW8uKs96vgdxVo1PmWb8pSvLbfidP0YxigeUktADpfGI0oMEqsDcxzgaTfVfLsVbvZCn7cAUL57273sY+U1SLya2WcLEkgKS16kDdLYs2/PD8Ybn8h/fbmLYn4kN5fFiYtv/ysSiGPk3sd2IUuLZrb724P6rnrOOt/49p98tf3yO3Pi54KB577YXWm2RKctpFU69RS0l1g4vLpZufnwm2uGXX5G/AA=='),
			this.addDataEntry(dt + 'noneditable non editable steps', 704, 72, 'Non-editable Steps',
				'5VdNb5wwEP01HLMyNuzHdXebXFIpUg49OzCAFYORcVL239fGZgMFukQFVVWwdoXHnvHMe/az8Mgprx8kLbPvIgbukW8eOUkhlH3L6xNw7mHEYo+cPYyR/nn4fmLUb0ZRSSUUao4Dtg7vlL+BtVhDpS7cGaqMluZVQqRDHislxSucBBdSGwtR6LFjwjhvTR4mSfNou4sOUkE9mWFjcuk9gMhByYue8pPFKrMzdiiwbhmwNHNuO5cqrWw/vbp+1KtfXMnj5ZNB+c/ATZ0YRTQvKUsLAwYoxYq0moRGB2VlBTPRCfA+vA+MXRSqY0fNo+2cvgB/EhVTTBQGeVv0kXKTDzlzSBomShrptB6b3tlHc/HGN/HGI3C3NgmcKvYOvfBjHLgVngQrDJ51P8yl320DiCTRaA8ovKY5i9Xg9qaOaZWBmW5Qa2nM69QcxE2ax3wTZRC9Dhjtbm478sPBhufCT8bhdw5oE/YAuvY79Ph4SI+PFqHnbttb/S5cgZ5wvuZwVgxPlebgpWnLbfgDWg1RjPqQEn8FSLcDSKcxXUasPifx/1RyyG8MrKI5uwEDJwlUgVnH3CE01n+pFG/lX1+wrWni9rh9SxjPZ7e+vyCFaOQULcUhQetzuP9SwhRs+5CuIkyHAaRkIWE6gGn/tTCF2/36m7rdLX9UpmUUaZ7ydLjaI9OW48r311Og8IAXJ0t3Pz717PTul+Av'),
			this.addDataEntry(dt + 'mobile step text', 358, 642, 'Mobile step (text)',
				'3Zhdj6IwFIZ/DZeaQvnQS8VxLvYjm51Jdu82HSkfmUJJ6c7q/vottCAIjKiwMxmMxh562vI+ffWABt14f89QGn6hHiYavNOgyyjl8lu8dzEhmgEiT4MbzTCAeGvGtuesXpwFKWI44UMSDJnwgshvLCMykPEDUQEPZSHOuwMNrrMQpXmc4Z0Yf+1HhLiUUFZ0hetN/sq7cUafcXkmoYnIWaupMON437vcIqTWeo9pjDk7iC5/Io+Hsge0FjItxFEQqjTbVAtHmQwEVe7x6sUXJUC3GLAlhi7WsoLgIk0QiYIkb8rVnWoEoe1s7D6NfJrwWudtceSdU7SLkuC7umLzGHqkqQjoKvdBrRGU7ehv3tShaDOcidYPpaQ+lIhxHRHDlDGGCeLRC26Mfwsl88otG++D3GbzIPbInNP01xNiN21V2C1MM+GgXDi3ZLsmm2m3VdMvVU3N/41GYlnV5LOl0Zh+5jRHoL6fYd5SvbqKQSCsFgiXYcTxRW7pdkHTMqaxsLZm5w6u7XEDnPePNMtSBHK20Q6RlXIrz89U3iXY58esz0Vr4xgTW8ayb4N/aDpvVNj2GK5LGfaxkGmHs4Ho/eIYqrt1VvdSm4bnbpR93xympAAmoOC0KDxwnIqIuCxAffFhj+4+38pf59xX/MOcuA8Ux0ju0+2J3WcuRnHfYgruiw732YQXioj5wHrlfnpH4O3i6OAcR56XL29i1IdGwn8CP1vaE5Bftsh/vfv5KKmLPRDwSqqxyKvQhNDLyvikqB2OfTGk8qph1wEYH3tZalWDj8pdB1f+4V5g8Or3edw7g7dxXznOuBT0McqeJ7R7biGpFzd9XGRGyWVw+Sn3Tq8/wLws3V+5OdG7CqWRbk6cxuyT3JvoAx5slKxEZpRm+F0R+viA2g9begF1/qS9JR3no+ERzeMzR9m9/kjyHw=='),
			this.addDataEntry(dt + 'mobile step dots', 358, 642, 'Mobile step (dots)',
				'7Vlbb5swFP41PKayMZfkMZemD7to2iptb5MbDEF1YmS8Ltmvn8GGQCANSUwitXUUCR98bPN9/ozPwULT1eaB42T5hQWEWujeQlPOmFBXq82UUGrZIA4sNLNsG8i/Zc8P3IX5XZBgTtaii4OtHF4w/UOURRlSsaXaEOB0SbLmwEKTdImTzM7JQvY/CWNKp4wynjdFk1n2y5oJzp5JcWfN1tJnoociXJDNwenmJj3XB8JWRPCtbPI3DsRStUDuULktSRwttZvn6InjVBmi0nf39PJCA9AOBmqAAeVcxgichAmmcbTOqmp2+xgh5Pkz7xBGIVuLSuN5XrLGCV7E6+i7fmJnZ3pkiTRA7ftDzxEU9fhfVoVI1jlJZe2nRhJ2ZcQ+jxHbUTZOKBbxC6n1fwlLzplLdrWJMpndRauA3gmW/H7C/KKlitqBqTtstQrvXFWvwOZ4TdTgqajp8b+xWE6rHHwwsmvDD/x6DywMUyIaqJdP0YkIt0HElBMsyElqaVdBXTKOPXTnTusKrqxxGxzXjxLLSBoybuMFpmOtVpHdKbVLSSh2Xp/z2sy3e5aM611G/rauPKNkeyZUl3ASEgnTgqQdqQ/z0hV39yjuBTY1zV0I+6beTcEC6IEFv4UFj4ocHzkemIynn4zLL3Sz3zH55a+YPfl5eWlR2yoOgmx6rwsOehcKbltzOCY/Z2hEfoOR1wPzwwbzX+9/PSrW5RqIRAmVKeYrJxIjFBfnob2jTHeS/S7v2wrJEADzJBcv2LJzoyyPju+yBY3SMU5S0lHDOC9mkG47y7QcZczsqgMH1bdV2APsEHzgvo97seP0ijv8wL2xsVxjvXcI+8/DvTyq94R7y2vbzIZeD9d6ObzBZn7hva926F9hsXdIGLwz2JF9Bdib6YEG7JdGJiAvxlNbtwkbin7MsmAkbn/Ci+cGJdXo/BAvyqPgpXP+BB4I5EutFLmnV7JrsC3SN5Rdq+9avSTXYFuof+KudUuG3j5BzYj8IEGtW9ot2fHfGj2yuvtopppXv6n9Bw=='),
			this.addDataEntry(dt + 'mobile step progress bar', 358, 642, 'Mobile step (progress bar)',
				'3Vhdj6IwFP01PGpKy4c+Ko7zsB/Z7E6y+7bpSEEy1ZLSndX99dvSgqCoqDUzGYwJvb23vZzT015wULTaPHKcL7+wmFAHPTgo4owJfbfaRIRSB4IsdtDMgRDIvwPnR3rdshfkmJO16BMAdcArpn+ItmhDIbbUGGJcLIlyBw6aFkucKzsnCzn+NMkojRhlvHRF05n6KTfB2QupetZsLWOmZirCBdkcTbc0mVwfCVsRwbfS5W8Wi6X2QP5Ihy1Jli5NWOCZxHGhDWkdu3t6eWMA6AYDHYDhylwmCFyECaZZulZNnd0+RggF4Sw4hlHC1qLhPC8v5ZzjRbZOv5sn9namJ5ZLg2tif5gcQdXO/qmmi2Sbk0K2fhok3b6MwOsYgZ62cUKxyF5Ja/xbWPKuXLKrTapkNkxXMR0Klv9+xvympYq6gWkHbI0Kh75uN2DzgkPU3EtRM/N/Y5lMq558MIat6QdhewSWJAURB6jXT9GLCP+AiIgTLMhFaulWQVsyHhz5c69zBTfWOATn9aPFMpYGxW22wHRi1CpUT61dShKxi/pctmYhvLNk/OA28rdt5VklO7ChupyThEiYFqToSX1SXn1x98/iXmHT0tyNsG/aw1QsgDuwEHawEFBR4iPnA9NJ9Mm6/BJf/c7Jrzxi9uQXlFeH2lZZHKv0TgvODW4U3LYVcE5+3siK/Abj4A7Mjw6Y//rw60mzLtdAKmqobDHfqEisUFzVQ3ulTH+Swz7nbYNkFwD7JFcHbD24VZbHdnZZlkqpFtOO+qZ5muqeSs6K23jjqoGHoR1K6qLnRBHkurBjRwZ2SAraW/LAvwNlVa7XvkL12YFBeVkv4d9me6zGscuCa0M5z3jx0iWZugo5xktbSr3rRL12TugH9hBQV0Vj6S0ibMvnHi8RlfxPEVdxJSOzvCDviqGPT9DhV5GjBHVuaW/JTvjR6JHN3cdB7d78dvgf'),
			this.addDataEntry(dt + 'editable steps optional', 704, 72, 'Editable Steps (with optional steps)',
				'5VfBjpswFPwajhsZOyHJsUm6e2nVlfbQsxceYK3B1Dgp6dfXxoaEQrpUAVVVgxLZY/v5vRkzAY/ss+pJ0iL9LCLgHvnokb0UQtlWVu2Bcw8jFnnk4GGM9NfDjzdG/XoUFVRCrsYswHbBifIjWMQCpTpzB5QpLUxTQqhD7kolxRvsBRdSg7nI9dguZpw3kIdJXH807qKDVFDdzLCGXHpPIDJQ8qynfGeRSu2MNVraZSmwJHXL1i5VWtp+0i691KsbruTh8kmv/Bfgpk6MQpoVlCW5IQOUYnlS3qRGB2VFCSPZWeLN6nFpcJGrKxzVH41z+gr8WZRMMZEb5m3RO8pNPuTAIa6VKGio0/pU9w4+chFfXH7+WP7xu/zjAfobTAKnip2gE35IE7fDs2C54bfqhjl3u00AEcea/Z6kbZqjVF6+f8gjWqZgphsWG1mzKjE35iLJIr6AiM1z/Mkw/W4BWqw6BLX9K3l81Jenwe6U56G7e9OdVJ7VeA/iLO/fZZrx1/qa7sBv52MUo6BDKfFnoDToUbqXQBWYfYyj0Uj/JFIcCw8H3JzriJ10M1E1hxYyZtKRIfh2FM3AQ8l+aPSDnuD7RXUZNNbZCnMBG4muILvbl8K4HOXNrro0u3E3GQ13UpzEibdgrlmcOFUZ/2dMmPxyJmdx4fUULhymEL4NOUDruXbkq+MNj+U/uN+F8Xwu3JVnFhfe/FcuvAzQ/C687VFKZjauP3vy+Kueswo283tOc1p++0d45/uOg8Y9nF9ptUHmmk4rf+gxcCqxtnhysXT38p5rp1+/Bv8E'),
			this.addDataEntry(dt + 'noneditable non editable steps optional', 704, 72, 'Non-editable Steps (with optional steps)',
				'5VfBjpswEP0ajomMHUhybJLuXlp1pT307IUJWGswNU6W9OtrY5OFQhqqgqqqQYnsZ88w894wDh7ZZ9WjpEX6WcTAPfLRI3sphLKjrNoD5x5GLPbIwcMY6a+HH26s+vUqKqiEXI0xwNbgTPkJLGKBUl24A8qUFmYoIdIud6WS4hX2ggupwVzkem13ZJw3kIfJsf5o3HkHqaC6GWENufAeQWSg5EVveWOxSu2ONVpZsxRYkjqztQuVlnaeXE3f89UDl/Jw+qSX/jNwkydGEc0KypLckAFKsTwpb1KjnbKihJHsrPAmeFgZXOSqhaP6o3FOX4A/iZIpJnLDvE16R7mJhxw4HGslChrpsD7Vs4OPxvKN7/KNB+huMAmcKnaGjvshDdwdngTLDZ9V182lO20ciONRs92T8BrmKFVX94s6pmUKZrthrZExqxLzIC6TLObLKIXotadou7jtyldHGx5LPxmm3xmgZdAh6DpvyePjvjw+mkSeRdi5+yKYQZ5gfM/hLO8/VVqDl/qaruC3aDZGMepSSvwZKA17lN7mdJpm9Xst/q+2HPKTArP0nHVPgb0EqsDcx5whNNY/iRSnwsMhN+07Zmc9TFTNoYUMx+boudIcfjsJu6Ep+RbUErcBjYPFm6Pwg96SC5lRE6e1qNdL9h3squ8XVdujjeZLYc4dY2Wj0qnbwLrBariTwh/+bWigG2fi/bPPWD67+/t6nqqMu+FUNYoG2sRURUrQ/EW6+a867yrsUjpL5932KCUTdd4tmOuf7rxBuJm/qJtq+WXrnaY5jWtCLa02yFzTaeX783WgYIsnF0tP399l7fb2q+4P'),
			this.addDataEntry(dt + 'mobile vertical stepper', 358, 642, 'Mobile vertical stepper',
				'7VrZcpswFP0aHpMREov9mDhJpzNt2mm6PHYUI4ymYinIrd2vr4SAgAUxDqJNM4WJg65WztHR1YKFVvHuVY6z6G0aEGahawut8jTl6inerQhjFgQ0sNCVBSEQfxa8GYi1y1iQ4ZwkfEwGqDL8wGxLlEUZCr5nlSHARURkcmChyyLCmbTnZC3KvwwpY6uUpXmZFIXlJZPxPP1G6pgkTUSey6oqknOyG2xuaara+oqkMeH5XiT5SQMeqRTIXahsEaGbqMrmOVXDcaEMmybvw9uLhwqAfjCQBoYt2nKBwEmYYEY3iQyq1h1ihJDnX3lDGIVpwluJb8pLJs7wmiabD9UbOw+mj2kmDHaV965qI6jD9JcM2kiEc1KI0JcKSXssI/BpjEBH2XLCMKc/SKf8KSw5T+yy8W4jZXa+iQN2ztPs6z3OJ3VV1A9MN8O+UuG5q8It2BxPR80+FbWq/vcpFc1qKj9bwk71Z363hDQMC8I11Ju3GEWEqxGxygnm5CS19KugKxkHLtwbp7cHt/o4BMf1o8SyFAbJLV1jdlGplcuYRruMhPwh15sydOXDmSXjetPI33eVZ5Rsz4TqspyERMC0JsVI6huPMgp39yjuNTYdzU2EfdctpmYBzMCCr7FwR5gUkqgnkT9ZZkmqkA1KzDzGK1GIyHUDq/d9KycYIgFallfb5G3k/7ttHONcKkvUHoqfhJBAsFsVKRqqSlWptb5Q0y+aT7OCnCr0AxmD8hJ2hu8Je58WlNO07WMf1W2JRcRjZtbr9XWlk51ef1eqi6m6kg3gDH1pYULR64isv2ns6lPBeswePYT6jzrXxp0+4l5t2CN1YMa9dqV+5s5Az/I4PTUjjJZiCqj0qUoYSZpLHHRe7svbnApqRNsoIzMoo+4UykZz+LW6/S2ch4E2M5qd5tOe1UDkzzEQ2bZGwSpNQrrZ5qR0bJjtxVytEM+hwBACHtGidnYDTI2dXVamA//RXkmZ9BigRyyGmHK9P8HUiO2C5zooQX8xx6gEwSyjkr4VMbmrS5wDeRvs0H7fEtYQ0B44AHoxB9D6bsLq3e3H17efrk0ALl1A+AdcQDND7LhhM+uaAx4cMMfCxu7ZTLi4XV2/McFCg/YBCwsg73+DhWZAn5cGfZmPBhk4bTa0JPJ+SbMhZzHLiHR0jR+oiVCMlUkGExyTOmqbUD5ZNcPzovboFsj7n5wfzcSdvqZ2/stnQD7u4ZGNGQr0dfNnSn5KCgjfZjJlIvDelnPS4r9OjuhkHpKgvugeZOLZrSNm2dxwa89rFmd9Za3hPPVwptmbNXu8uO9kOHZy4kxcctQbec4cXqEGfdpO6z0+stE6xMsTN2CHTuKbHVg4Ygu277TF0Amn36l9lgPOng8CTvbmf5Ohl0/QiG8BHh3S/iY7/kujRwQfPlxSydvfNf0G'),
			this.addDataEntry(dt + 'stepper alternative label placing', 404, 50, 'Stepper with alternative label placing',
				'1ZbfboIwFMafpvelxamXyqZXu9oTdPYozQolpTrd0+8A9Q8pJCY6dDRo+x1O0/OjXyjhSbZfWlGk70aCJvyN8MQa45petk9Aa8KokoS/EsYo3oQteqJRHaWFsJC7axJYk7ATegutKUp30F4pU1FUXcxURYm9+drk7kP9VGLEcFw6a74gMdpYlHKT1w8prY8SYTxmk9Ei9skX+rq+UBdabXLUVrh0wOB8B9apldAzH8iUlNWa5n7NGIZ9b9215ItegsnA2QM+4hP4pMn4VtKlHkXcSCmoTeramiib8eY00ZkpdjzWbsQ8QDyTON7myuGfBCeULnuhW1i5EFosq6Yv3wO/5j146RaAB18VDQBGlHYQpLcTjAOCvbi0qgtsg0Bgn3W7z94Z+5I8iXEIIuoAEd0BxCgA0U/iNrdOoWrP4tZoGu62v7LrS7ddSwT4j1x6TBix1l4d0rXj53LtySvD23YSkOCPsu09Pp0xG8yM04BcYkE4qKbNqx85rCWHPaPQeCjz4vB85qxjrSPpLw=='),
			this.addDataEntry(dt + 'stepper alternative label placing optional', 404, 50, 'Stepper with alternative optional label placing',
				'zZbNcoMgEMefxmNnFMzXMTFtTz21L0CFKFMEi6RN+vRdFJM46DSdJE7CROG/gOwPdocAJ8XuWZMyf1GUiQA/BjjRSpmmVuwSJkSAQk4DvA4QCuEfoKcBa1Rbw5JoJs05A1Az4IuILetMUZm9cEqVk9JWYSQvK6itKqPVB0uUUBp0qaQVN1yIVgoQjtF88hRbXUlzom/qn9Nf+Y+dOULQJoJnEhopLJ1B59UX04anRCydoeCU2jWt3JrBzHaDfteSc/qZqYIZvYcubgCeNyO+OTW5QxE3Us54lpuuRqqmnR0mOjKFisPajxh7iJcU2lvJDbwoM4SLahC6ZqnxIcbUFnGKEJ+zL066BODeeRV6AKMw7CEYXk4w9ggO4hJc+gcUgL3X5TpnZ+ZcciRmPoioB0R0BRATD8Qwif9F64LZcq/RGi3803arcJ32h2sFvkOUghXDTlqvpqINzM4GTD+3qjU8VDWxJXSIonJ3NIKQHiAfxfaYnkjTzL5VabiSRLRfBSeaDzfmv7LHuXkhN4WwG9yznUaV56ehkqRcZm92yPohvtIZmKBO2I2ZgGb3lYAOYT9+Bpp7JPAtMtBpphnKSNe4BcRotLyy8MglmhHD7LTSPui4d4Bxr1thPFbwQvN4fa5tndv1Lw==')
   		];
		  
		this.addPalette('gmdlSteppers', 'GMDL / Steppers', expand || false, mxUtils.bind(this, function(content)
		{
			for (var i = 0; i < fns.length; i++)
			{
				content.appendChild(fns[i](content));
			}
		}));
	};

	Sidebar.prototype.addGMDLTabsPalette = function(expand)
	{
		var s = "dashed=0;shape=";
		var s2 = "dashed=0;shape=mxgraph.gmdl.";
		var gn = 'mxgraph.gmdl';
		var dt = 'gmdl google media design library tab ';
		var sb = this;
		
		var fns = [
			this.addDataEntry(dt + 'fixed tab bar', 358, 642, 'Fixed tab bar',
				'3Zlbb9owFMc/TR5Bdhxuj4VCN2kdVVepj5ObOBfVkMjxOtinnx07kJCkDeDQSyQkfOLjOOfnv304WGi22twwnIS3sUeoheYWmrE45urbajMjlFo2iDwLXVu2DcTHshcNd2F2FySYkTVv42ArhxdM/xBlUYaUb6k2eDgNiewOLDRNQ5xIOyOuGH/qR5TOYhqzrCvys0t24yx+JvmddbwWPlP9KMI42TRONzPpud6QeEU424oufyOPh6oHGoyVW0iiINRuQ0dPHKfKEOx8928vvugA1AcDVYIBxVyuEDgqJphGwVo21ewOYwTAFZg6TTHy4zUvdF5kl+ycYDdaB/f6jZ296SFOhAFq3196jiBvR/9kEyLRZiQVrUcdSdiWiH0aEdtRNkYo5tELKY1/DiXnxCW72gRSZv1g5dE+j5PfT5idtVRRfWDKDlutwv5AtQthc4bVqMFjo6affxdHYlq7h/cmdunxvVF5hNj3U8IrUd+9RSsQgwqIOxwQYeERFySO0Uy9Fg6FM51lC7+6jgsr3QZvq0hJZiIMknDkYnqlNcvlnZ2CKfH53utH1roe2R0LB4Iz18C2LECjzIcmxJcw4hMRJ5ekLdnvDpZWgR+8Gfg8NqW4D41ILx8mpwA6oDCqUPj+ML8VluXPeYWHiBSvOQ2aNHIoiVXkeXKonSpcEWfCTj9PGuhsSw4FVhBOqrCcsRGN9PJxjOIZN+F5eFxeDo8ceCm3Li5fdgyME9vkRxtCpSVfgzBXwadBOGlE+O1+fkGNXQ7icPQWxE+nQwhOPK2OyEoWcDEdL957NzQDAXXBAJrIGFKCmRtWkBQzgyIXjUp1zpG0ztteV0oNkro83kwy0RsOus8m4KlFgANEnIss+aIZXSOSQXdEcrF1SqRaiTC+cYHsMl4WaNy4an/rfOzjw0il4Qm7z603riKXE3cv+HpZAvTt8pZSV5mAdT+PDFUmymlGJ4UJWK1MVMDlrIRnlKTkQxH6+oBalBFe3dLek87oq+ERzf0fDqp78f+I/w=='),
			this.addDataEntry(dt + 'fixed tab bar', 358, 642, 'Fixed tab bar',
				'3Zlbb9owFMc/TR5Bdhxuj4VCN2kdVVepj5ObOBfVkMjxOtinnx07kJCkBOrQSyQkfOLjOOfnv304WGi22twwnIS3sUeoheYWmrE45urbajMjlFo2iDwLXVu2DcTHshcNd2F2FySYkTVv42ArhxdM/xBlUYaUb6k2eDgNiewOLDRNQ5xIOyOuGH/qR5TOYhqzrCvys0t24yx+JvmddbwWPlP9KMI42TRONzPpud6QeEU424oufyOPh6oHGoyVW0iiINRuQ0dPHKfKEOx8928vvugA1AcDVYIBxVyuEDgpJphGwVo21ewOYwTAFZg6TTHy4zUvdF5kl+ycYDdaB/f6jZ296SFOhAFq3196jiBvR/9kEyLRZiQVrUcdSdiWiH0eEdtRNkYo5tELKY3/FkrOmUt2tQmkzPrByqN9Hie/nzB701JF9YEpO2y1CvsD1S6EzRlWowZPjZp+/l0ciWntHt6b2KXH90blEWLfTwmvRH33Fq1ADCog7nBAhIVHXJA4RTP1WjgUznSWLfzqOi6sdOQcV5GSTA/KrpJx5GJ6pVW7ijxPzngnY0p8vnf9kbWuR3bH6oFD8LaFsC2r0Cj4oQkFJoz4RMTJJWnLBbA7XVoFfnA08HlsynE3or98mJwC6IDCqELh+8P8VliWP+cVHiJSvOZIaBLKUVW4Is6EnX+oNNDZlhwKrCCcVGE5YyMa6eXjGMUzbsLz8Li8HB458FJuXVy+7BgYJ7bJzzeESku+BmGugk+DcNKI8Nv9/IIauxzE4egYxE+nQwjOPK1OSE0WcDEdL957NzQDAXXBAJrIGFKCmRtWkBQzgyIXjUp1zpG0ztteV0oNkrpk3kwy0RsOus8m4LmVgANEnIss+aIZXSOSQXdEcrF1SqRajjC+cYHsMl4baNy4an/rfOzjw0i54Qm7z603riKXM3cv+HptAvTt8pZSV56AdT+PDJUnymlGJ9UJWC1PVMDlrIRnlKTkQxH6+oBalBFe3dLek87oq+ERzf2/Dqp78U+J/w=='),
			this.addDataEntry(dt + 'fixed tab bar', 358, 642, 'Fixed tab bar',
				'3ZdNb6MwEIZ/DcdGgElCjwsNbQ/drLqVevbCBKwajIzbTfbX18YmTZagoITSD0uR8HjG9rxPxgYLhfn6muMyu2MJUAstLBRyxoR+ytchUGq5NkksdGW5ri1/lht1jDr1qF1iDoXoE+DqgBdMn0FbtKESG2oMCa4yUO62hYIqw6Wyc4jl/MGKUBoyynjtilZ1U26CsydoRgpWyJjALAVcwLpzu7XJ7PUaWA6Cb6TLX5KITHugqa/DMiBpZsJmntk4rrQh3ca+ZS8fjACHxUDniXEw6f8Usu0gvPKknUNF/sGjScvpK497mjyesXGgWJAX2Jv/HMm8lmS3D4s7aVn+XLTEk4nVfxpWiN8yeZU3Mv0diaK6SbuSgsSY/qAkLeRYTpJETRVgY4ilLMBPFxMdFnOzF7AjreNcDiCtWfAXI3If29UumnmaELZaVSBaLLb77IVn2oXn4XE5Hh418bLEMREqWd8enJgJsCfIlHA3QnMefh2Es06EN/eLEWtsPIiz+TGIX64O5+9/s0ROFPjRRx+GwzBA74DAH+NyV23wy70TwTBX/Zh1cHkihHydqlfkSZondPIHx08tIrtvn11YdESDxe2LxT9yXjW37KYxTNvF4rVBOWcWi1n/Yv+0bLqDYnPs49waVDKSlBV8JkDfn4/Tn8/B8+wD4cy/Gx3Zfft+1+67n/ev'),
			this.addDataEntry(dt + 'fixed tab bar', 358, 642, 'Fixed tab bar',
				'3Zldb5swFIZ/DZeJbEwIvUzSpJu0rlVbqZeTCw5YNRgZr03262fzkUCAjiaQdiWKFB/OAfM+PsfGMdAi3FwJHAfX3CPMQEsDLQTnMvsVbhaEMcME1DPQpWGaQH0Nc9VyFqZnQYwFiWSXADMLeMHsN8ksmSGRW5YbPJwERLsDA82TAMfaLoirrj9fU8YWnHGRuqJ1emg3KfgzKc5EPFIx8/xWREiyae1uasr7ekV4SKTYKpdX6skg80ATJwsLCPWDPMy28o7jJDP4u9j906sfuQDNYqCaGFD1ZYbAuzTBjPqRbma9O9QIgBmYW20arXkkS86r9NDOMXZp5N/lT2ztTQ88VgaYx97nfQRFm/7RTYhUW5BEtR5zJWFXIuZxREwrswnCsKQvpHL9UyhZRw7ZcOPrNBv7ocfGkse/nrA4aaiiZmGqAds8C8eTrF2SzbLrqsH3qpbf/5ZT1a3dzUcXZuX2o2n1Cny9Toisqb57ik4gJqfVjubxf5gs80U62M87diE4EcO2mgO9ym7XZL8nWLiBst0SHivpdc23cRinKoFbhl2SHJEjIRY+je4yWhradWpQbk5HfPv5IMAefy3VqZLTIj0O6pVVKqSMrOW+3v1IW5dT8/hRMTl2jhmook37qGhJNggOwSiBZ5f6c0AnB5Y5FwqaXRW0mxV8o9jBpmJn91LsTKda65wBks7pA9ELpy7pTKhs7xdT5xkKgsGgjSwwPLWLGrXvD8trZbn5uazxU0LKhlVT24pMS09dzGZ5lQqp5+lL7cqWqzAQ0XuV2lYCyrDgRZ2W5fQykY2sIfAUw6vO5+Hx5nx89IVv9OQi9dM6oHdkmyLDEKqM+QaGZkPGfW6GsJXht7vlGbPsfBTt6b8o/n+ZeOI+QJfF4Aqu5s7qo+thPxDQEAzq2w+9MwDp0fv7VCuDxnX0586EXrYXnrD73LTQ270QtXE5cqEH396LAOPiZf2txZ5VR9XXdkS1Yg6yGwE7bEcUrFQkjZPGpfiHEfr6gOobF62AGkvaR9KZfjU8qrn/lyFzL/8J8Rc='),
			this.addDataEntry(dt + 'scrollable tab bar', 358, 642, 'Scrollable tab bar',
				'3ZnbbqMwEIafhstENpADl02atJW2m6obqZeVC+agkhgZbzfZp18bmwRq2BICbRWkSPHgMWY+//bYGNZ8s7uhKAnviYdjw1oY1pwSwuS/zW6O49gwQeQZ1rVhmoD/DHNZcxdmd0GCKN6yJg6mdHhD8W8sLdKQsn2sDB5KQyyqA8OapSFKhJ1il7c/86M4npOY0Kyq5WeXqMYoecX5nS3Zcp+ZehSmDO9qu5uZVF9vMNlgRve8yp/IY6GsYY2m0i3EURAqt7GtOo5SaQgOvse3539UAKqDYWnBgLwvVxY4KSYojoKtKMrevY8RAFdgZtfFyCdbVqi8zC5ROUFutA0e1RvbR9OaJNwAle8v1UeQl6O/oggtXqY45aUnFUnYlIjZjohpSxvFMWLRGy61fw4lu+WQ3ewCIbNhsPHiISPJ8wuiZw1VqzowZYe9UuFwJMuFsNljPWrw1Kip5z+QiHfr8PCBY5YeP5iUWyC+n2KmRf3wFo1AjDQQDyjA3MIixkmcoplqLbwXzmyeDXx9HBdGugk+VpGUjMMNgnDkovhKaZaJOwcFx9hnR68fWel6YvYsHAjOHAP7sgA7ZT7uQnwJxT7mcXJx2pD9YWFpFPjRh4HPY1OK+7gT6eXN5BRADxQmGoW79eKeW1Y/FxoPHilWsRrUaeS9JDaR54mmDqpweZwxbb+e1NDZ5RMlnDpOKYRQmzkdoOOzp52oZpC30ymwaR2w9dPq84CJhldiMmPiZaegP4a2Da1LY+hoDNe3C4Hw9u7x+hIhjp18orkciBBoFJdfq8AOUMEPKJk9UMoTzbztfqlBjZrG7Nz0cgmXs+ny+y1r3YjJ6oNK28ODUjKYYkTdUINUTPqKpBQ8WTmH1Dglb6SjAhFYtUXrJk8cjEel4dBLogj1I41WiBjjG6BPTdZrkYz6I5KLrVcibY8vTtopi6vzE5/aeatyG/u90wD97KKFLl6Q+9p44ipyaTl7ybHznzXGLE8pVYdOsGrn29GhUzlb7OXMCTY4gMhZcc8oSfG3InT5gPSziVpAlVPaV9KZXBoeXjx+S5LVi5+a/gE='),
			this.addDataEntry(dt + 'scrollable tab bar', 358, 642, 'Scrollable tab bar',
				'3Zldb5swFIZ/DZeJbBzycdmkaTdpXauuUi8rFwxYdQIyXpfs188GQyBAS6hZP4gi4YOPMefxa5uDhVab3SXHcXgVeYRZaG2hFY8ikZ1tdivCmGUD6lno3LJtIP+WfdFyFaZXQYw52YouDnbm8IzZb5JZMkMi9kwbPJyERFUHFlomIY6VnRNXtr/0KWOriEU8rYr89FDVBI+eSH5lG22lz1LfinBBdq3dTU26r5ck2hDB97LKH+qJMKuBnHnmFhIahNptOtEdx0lmCArfw9PLEx2A5mCgWjCg7MsZAifFBDMabFUx691xjGaO+rXFyI+2olT5Ij1U5Ri7dBvc6ieeHEx3USwNUPv+0n0EeZn+VUWIZJmTRJbudSRhVyJ2PyL2JLNxwrCgz6TS/lsoTXoO2c0uUDIbBxuPjUUUPzxi/qahipoDU3XYaxWOnaxcCttkWo8aPDVq+v43EZXdKm4+WtiV249m1RYi30+IqEW9eIpOIJwaiBscEGkRVEgSp2imWQtV4VycqV/jOC6NdBvUVQTS41gyC2lQhKmL2ZnWrFBXCgUz4ouD14+0dD6zBxYOBG8cA/uqAI0yn5oQX8yJT2ScXJJ0ZF9Mmp0C77wa+Dw2lbhPjUgvbyanAAagMKtR+H63vpKW65/rGg8ZKdGwGhxrBC5X6bJyLIkN9TzVVKEKV8aZ8P7rSQudfcWhxArCRR3WZG5EI6O8HaN45m147u6ve+IpBNAdj2r4Wk1dQj3sHBgntsuXNoQqQ74BYa6CT4Nw0Yrw2+26r8Y+NMTp7DWIn06HEPRcrU7YlRTz5rvOhmYgoCEYQBM7hoRg7oY1JGVNlbloVFnlHEnnfdvLSmlA0rSPN7OZGE2d4XcTsG8S4AiREHKX/F93dK1InOGI5GIblEg9E2F+4spfisymBVonrsZ3nY+9fBjJNDxi96lp4ipyZW1ces5e8OW0BBjb1SmlKTMBm16PDGUmqtuMQRITsJ6ZqIHLWUlPGifkQxH6+oA6pBFenNLek87sq+GRxcMHh6x6+XvEPw=='),
			this.addDataEntry(dt + 'fixed tab bar icons', 358, 642, 'Fixed tab bar with icons',
				'3Vlbb5swFP41PDayuYU8hjSpJnVtlVab9jQ5xIBVJ0bgdcl+/cw1EENKuKxTkSLFh3OMOd/3HV9QtMXucBeiwP/Ktpgq2lLRFiFjPP23OywwpYoKyFbRbhVVBeKnqKuGuzC5CwIU4j1vE6CmAW+I/sKpJTVE/EgzwxZFPo7dgaLZkY+C2B5iR/Rvu4TSBaMsTFw1N7liNx6yV5zf2bO9iLGzR+GQ40PjcBNTNtY7zHaYh0fh8ptsuZ96aIaVhvmYeH4WZurZwFGUGrwi9vT24k+WgPpkaFIyoBjLXANX5QRR4u3jZjq68xwBMAe23pQjl+15yXmVXLFzgByy99bZG+sn0wsLhAFmsc/ZGEHeJn/iJtREO8SRaH3PMgnbIqJ2Q0TVU1uIKeLkDVf674OS3pGyu4MXy2zi7bZ0wlnwc4PCXlTV6hNTDThmKpwYabuUNt2UswavzVr2/CdGxLCKh9/M1Mrjb6bVHpjrRphLWS/eohUQhgTEE/KwsHDCBRLXaKZeC+fCsRcJ8WUel5iugvdVlEpmJgwxwsRBdJ5plsd3CgVT7PJT1H3Sup2qIwsHqlY/DhyrAhwUc3MI8QUhdrHIk4OjltgXE0urxBvvJj7PTSXv5iDSy7vJUQAjoDCVUFgvF8uHl+culRBTHPin2ac8YzTp6LJsHAEEbiytFG0wfWIR4YRVvPNO788cNoxztuuJ/SEvw9DUrQpAUKrLsE6UPTVZ1OVqWc7HMig7LIkdq/m3x/WXl2UXfvgYhfyMG2p/bggM+WNcWHmcCwsMTxdW9D4FQ7HH6EKdYeqKRJ0xpvSZRJ2H5Xxt/+jAG8dHH0ibM/A/uOhYqtml6ORzx8DMMeAIzIGg48rgihXgCq5sa9V9J9MAUzMmcCaD0nOBnoOgjYEB7IhBRbiRKPiOL0FSXoWVccmgSp1zSFqvkS8rpwaSuj3TQAXWrFb3UVZusOuByxlEnIsdyT9dPTdCYoyHSC62URGRT30GL1wguQY/gmksXLX7Sn2YbeU4a1Y4yKnOBjmvrQtXGZeO1QtePgICE7VaUupOgWDdVnSgU6BpdeIfY8UI5VMgCbgcKxFJggj/Vwh9foBaHNlcLGkfic70s8EjmqePO6l7+dvPXw=='),
			this.addDataEntry(dt + 'fixed tab bar icons', 358, 642, 'Fixed tab bar with icons',
				'3ZnbjpswEIafhstEtjkkucyh2ZtWWrWVell5iTloHYyMu0369DVgCMSwJcQ00hJFigcPmPn8D2PHsrfH0xPHafSFHQi17E+WveWMifLX8bQllFoIxAfL3lkIAfm10L7nLCzOghRzkoghDqh0eMP0FyktpSETZ6oMB5xFJO8OLHuTRTjN7Zz48vqbIKZ0yyjjRVc7KI68m+DslVRnEpZIn426FeGCnHqHW5jUWJ8IOxLBz7LL7/ggorKH7S5Lt4jEYaTcPEcNHGelIax9L08vf6gAdAfD1oIB5VjWNrgpJpjGYZI3y9Fdx2jh5p++GAUsEY3O++LIO6fYj5Pwq3pi52L6zlJpgMr3mxojqNrxn7wJbdnmJJOtHyqScCgRNI4IckobJxSL+I20rn8PJWfklD2ewlxm8/B4oHPB0p8vmN81Ve3uwLQdzkqFc7dsN8LmeHrU4K1RU/d/ZrEcVn3z2Qq1bj9btK/AgiAjQot6/RSDQLgaiGccEmkRsZAkbtFMtxbawtmv80/nPG7MdAR0FYHiuJbMShpywrGP6VppVuRnagVTEoiL1+eitVugiYUDwfK+OXBuC9Aoc8+E+FJOAiLj5JNsIHuvOIYG3v1n4KvYtOLuGZFedZmKApiAwsJICiSUpFEZ7iEMANisdoMnfw+DU5UOoecsW4GCWn6EXeK4Uxt1fmynR7ScgNLSBKWIYD40QxpRSU3IHYPHjIY0PFO8vlYm8PgRfgydJfLG6KdKR4YB2XACQBCMJHRDUVEntZHFcQ+mfiZwpUO5s+arIUzBAJpQSSaTmB9pSJqiaHJJmi+lComhN08Hkq4y3FAe89pJdJJiAI5dw18hEkIWuf+1IOtF4k5HpBLbpET0jYQJEpda05hd1fcmrs6limNmpTJzpii/oJGNghfsv3Ylrnqrq4/LyOwF399VAHPUTildGwuwa3VjaGNh0X7xT1GYQX1jQQNXsZKecZrpS5hHEvr4gAbsAryb0h5JZ/HR8Mjm5f+Csnvz74S/'),
			this.addDataEntry(dt + 'desktop tab bar', 758, 152, 'Desktop tab bar',
				'7Zhdb5swFIZ/DZepjEkCuQxJaCetS9Vl6rUFBqw5gIzXJfv1s/lKCKCSxDBtGlKkcOxzMO/jY/ugGav94ZGhJHyOPUw1Y6MZKxbHPP+3P6wwpRoExNOMtQYhED8NOh2tetYKEsRwxPs4wNzhHdEfOLfkhpQfaWHwUBpi2R1ohp2GKJF2hl0R3/YJpauYxizravjZJbtxFn/HZUsUR8LHLh6FGceHzuFmpmKsjzjeY86OostP4vEw72HOrNwtxCQIS7dZMXCU5oag8j29vfhTCNAuhqFUDACWwJ52icFwSn7ht+K19L7ywNvkMYo3YZgiTt5xLf49kk1vlGx/COScfwj2Hn04NEQS8i3ttbOZVy2lUrCvUka7UnWHM9102DKrrpWteN5LTMQwqodNoJm7HIsAFxFi308xb8hejboXidnHJC7m6zWSn8/ta9L5agpGCwWghsJsUadgDEBh3p8CJZmMf37iT5uSK5r3C72m+GUEJYqbDcVfUICFhRMuJL9mAW9dqBurur1aT1sX8NzyVMooTX4c8a/CKPmB4v4smJNd8skJckkU7OJENCyEQTImLqJLSoJI2LhssVFxR7HPT16fs7u12XuG3LiJ6PDORDzWNyOl08BSsRElDPtY6OTitOd0qE48vYQ3PxQetiSjPleSjWWYMhnBABQWDQqfdptnYdl+2TR4CKV4PUfEktydI5cpsSeeJ0NVWeEKnTG7k8Wx5nC+TIJ5E83UUoJmbtXQTMqwStmU22gTzu5tOx4cGXgrFy4u39YCfyMv3ZyOAUzvBPb0uhkxn/4FZNACYyBr1tMFMmf77fU/sWuIGdZ8DGJ3Fv19DgmO7tiWc3vRr4bKIDvVEDWUruSjQooRc8O2Aqs6s7UUtTfWXB2EumuuFkCKjnkTc1ZDNMg5T+/xtaEPIs5F/TLqWbsTyWw4ItBSTkTcnj4S593PvyH/Bg=='),
			this.addDataEntry(dt + 'desktop tab bar', 758, 152, 'Desktop tab bar',
				'3Zldj6IwFIZ/DZdOSgHBS1F0TNbR7Gx2rokUaLaCKd1Z3V+/5XPAQkQtbiKJiZz2lPI+Pf04KNpsf1xS9xCuYw8RRXMUbUbjmOX/9scZIkSBAHuKNlcgBPynwEVHqZqVgoNLUcT6OMDc4dMlv1FuyQ0JO5HC4LlJiNLqQNHsJHQPqZ2iHW/f9jEhs5jENKuq+dmVVmM0/oXKkiiOuI9dPApRho6d3c1MRV+XKN4jRk+8yh/ssTCvYRpW7hYiHISlm1F03E1yQ1D5fr09/1MI0C6GJlUMAKbA1rvEoCjBf9FH8VpqX3ngbfJoxZtQRFyGP1Gj/Xsk02+UbH8M0jH/Euw98nIUROLyTe35whlXJaVSsK9SWrtSTYeabipsGVXXylY8bxtj3o3qYSNo5i6nooGzFmLfTxATZK963YuEcZnE2Xi9RvL62L4mnK+moLVQAHIoGJMmBW0ACuP+FAjOZPz/A18XJZc07idqQ/HzFqQobgqKb90AcQvDjEt+zQTeOlELs7o9m+utE3hueS1lTE1+HLF3bkz5geK+1tgiu9InH9wdjoIf8YEXTLghZYx3LpkSHETcxtIS2y3uCPLZl9e37G5u9h4hNy4iKrwzEE/NxUjqMLBkLEQHinzEddqhpOdwqHY8vYQ3LwoPW4JRHUuJxrKZMhjBABQmAoUPxxZAcIlYMzj4XNwdHOexsMeelzZVhcOOC4zonRBODYd6LLQg0S0pSMZWA8mobFYqk3L5rEF5f91st6u35ePIpA1v0umKpe9qgaFgqaBl4pJES9XhI3CpAq6fq7mzeX8+WJPhWEEDPIKVeHxeradL5wlZDTgLavpDpkHxdP/mfDwhKWs8GCm93FUNS0pMKqw3353nIzVgTBngITHVI+lwedfNKHajgIiH4Qtb7rhCZPZGlI+tS6fjQjTwYgjMyt1UnZkhBdlIPVuyhshPqD0SFPcekRfqwrYWgwUNbAkaKQDOd+OD6C+mK26ImAS5dBe2JY+q4GhJ2N2YT+oA1J1Pall/JB1hR6bRQDTIGVaVkkrg/WA4Ch6aR+hEYgxHBFrSifDbrw9gefX697F/'),
			this.addDataEntry(dt + 'desktop tab bar overflow', 758, 152, 'Desktop tab bar with overflow',
				'7Zldb5swFIZ/DZetwIZALksS2krrUrVdu1sUDFhzMAK3S/brZ/PVEGCFxDBtaqRI4djnYN7nHGM7Clxsd9eJG4d31ENEgSsFLhJKWf5ru1sgQhSgYk+BSwUAlX8V4HS0almrGrsJilgfB5A7vLnkFeWW3JCyPSkMnpuGSHRXFWinoRsLe4I2PL7tY0IWlNAk6wr97CO6sYT+QGVLRCPuYxe3QglDu87hZqZirNeIbhFL9rzLT+yxMO9hGlbuFiIchKWbUQzcTXNDUPm+Pz3/UQjQLgaUKoaqXqm23iVGglL8C70Uj6X1lQecJg8sniRBxGX4DdXinyOZfqJk210gcv4y2HrkctcQict3ZS+d1axqKZUCfZWC7UrVHQ5000BLVg2VrbjfPcV8GNXNLoCZu+yLAEcRqO+niDVkr0bdi4TxMYmjfB0i+WFuDynnwRRgCwVVDgVjXqcAR6Aw60+B4EzGv5/4elNySXk/12qKH0eQorjZUPzeDRC3MMy45EMm8NaJujGr24ul3jqB55abUkZh8mnEHrlR8FOL64NgTvYRd47dDY6CJxrzhjk3CMZ445IrgoOI25hosd3iiiCfvXt9ya6WZu8MOfElooEzC3FffxlJTQNLxosoTpCPuE4blPZMh2rF00t480PhQUsxajMp1ViGKYtRHYHCvEHh9ml1xy3rr6sGD64Uq9cIn5K7a+S4JLbY80Soqio2XGeUnMliX3M4nCbVWRONbklBM7NqaC7KsFLZlK/RJpynl/V0cETgtZi4mHhaS/0XeWmmPgUwrRPYzcNqwnr6H5ABS50CWXM/XSBz1t8ePokNIQat2RTEmpv+ktjt82eNDSKmz8EUxJpnDgWxx9vvn8CGADPmkyw8ehxNfLw2f43bNsvV+tvDYhOHqWCU0leh3qkb6A5CdYdOXi20ZB0j6UflBcdYwms9jjDO3UQ7mmNbzrQVIwXB8UJ9jCMkrXmicUK5pMhNNuEfS6blTG/Mijkk1FYkcna5F6ZRQzTKNleTctrAx8FwFEx61NCJxBiPCLCkE+GX7/+R5d0P/0L7DQ=='),
			this.addDataEntry(dt + 'desktop tab bar overflow', 758, 152, 'Desktop tab bar with overflow',
				'7Zldb5swFIZ/DZetwIZALksS2krrUrVdu1sUDFhzMAK3S/brZ/PVEGCFxDBtaqRI4djnYN7nHGM7Clxsd9eJG4d31ENEgSsFLhJKWf5ru1sgQhSgYk+BSwUAlX8V4HS0almrGrsJilgfB5A7vLnkFeWW3JCyPSkMnpuGSHRXFWinoRsLe4I2PL7tY0IWlNAk6wr97CO6sYT+QGVLRCPuYxe3QglDu87hZqZirNeIbhFL9rzLT+yxMO9hGlbuFiIchKWbUQzcTXNDUPm+Pz3/UQjQLgaUKoaqXqm23iVGglL8C70Uj6X1lQecJg8sniRBxGX4DdXinyOZfqJk210gcv4y2HrkctcQict3ZS+d1axqKZUCfZWC7UrVHQ5000BLVg2VrbjfPcV8GNXNLoCZu+yLAEcRqO+niDVkr0bdi4TxMYmjfB0i+WFuDynnwRRgCwVVDgVjXqcAR6Aw60+B4EzGv5/4elNySXk/12qKH0eQorjZUPzeDRC3MMy45EMm8NaJujGr24ul3jqB55abUkZh8mnEHrlR8FOL64NgTvYRd47dDY6CJxrzhjk3CMZ445IrgoOI25hosd3iiiCfvXt9ya6WZu8MOfElooEzC3FffxlJTQNLxosoTpCPuE4blPZMh2rF00t480PhQUsxajMp1ViGKYtRHYHCvEHh9ml1xy3rr6sGD64Uq9cIn5K7a+S4JLbY80Soqio2XGeUnMliX3M4nCbVWRONbklBM7NqaC7KsFLZlK/RJpynl/V0cETgtZi4mHhaS/0XeWmmPgUwrRPYzcNqwnr6H5ABS50CWXM/XSBz1t8ePokNIQat2RTEmpv+ktjt82eNDSKmz8EUxJpnDgWxx9vvn8CGADPmkyw8ehxNfLw2f43bNsvV+tvDYhOHqWCU0leh3qkb6A5CdYdOXi20ZB0j6UflBcdYwms9jjDO3UQ7mmNbzrQVIwXB8UJ9jCMkrXmicUK5pMhNNuEfS6blTG/Mijkk1FYkcna5F6ZRQzTKNleTctrAx8FwFEx61NCJxBiPCLCkE+GX7/+R5d0P/0L7DQ==')
		];
		  
		this.addPalette('gmdlTabs', 'GMDL / Tabs', expand || false, mxUtils.bind(this, function(content)
		{
			for (var i = 0; i < fns.length; i++)
			{
				content.appendChild(fns[i](content));
			}
		}));
	};
	
	Sidebar.prototype.addGMDLTextFieldsPalette = function(expand)
	{
		var s = "dashed=0;shape=";
		var s2 = "dashed=0;shape=mxgraph.gmdl.";
		var gn = 'mxgraph.gmdl';
		var dt = 'gmdl google media design library text field ';
		var sb = this;
		
		var fns = [
			this.addDataEntry(dt + 'single line text field', 346, 360, 'Single-line text field',
				'7Zhbb5swFMc/yx54bORLSsnjcqsq9TJt1frsBgNWDI6M1yb79LPBJBCHNllCtVUBheBjH1/+Pzi28fAoXV5LskjuREi5hyceHkkhVHmXLkeUcw8BFnp47CEE9M9D05ZcWOSCBZE0U/s4oNLhhfBftLSUhlytuDWEJE+oKQ48PMwTsjB2SWe6/mHEOB8JLmRRFEfFYYopKea0lkOLo6wgFK/aCHXCNk6losvWARQm2/trKlKq5EoXeWWhSsoSuO+XbgllcWLdsF+OHJC8NMRr340e+sZKslse7MgzFGKeEjk3FYchDb84eumxGGnMqNiM8K+cxZnOSVkY8kKBBZmxLDYS+EZCkakf7LdxRrBK29pMWtJc5z7Z0e6tGvo71SrRJOVEsRfaqP8YJfuOkvckpW3iWY1uaaTqOtUeqACYs6kfxBvXR7HQFv/DBcSHCmib+CaYbhmBVVkiCJoeIopyqhzB1x3bi8GlwwAC3V0wJqtc/4lIX25mGgoYSUrSNjh1xf3GA43a0VWPNHBRguL4X0lBeNkBKv/9uFyFYs4yug65dfEycUuezZRSpNpD8mlltw6gB/q+7XSdBOy7JNCJSPRBBySuHBJTwUMqz6GrDYPvd4AhaJ2JTeh6Jq08ztGqAWeAO4AzeD9a7VxFpsvYrHx7cRrynpKMZDGnTqzKRBHgttaaV8Cc+6oevBmsoBOnIHARXB5HwLZ1UcX2ikgXQKruH0zkPJlYLAh2sQKD0OHyfXL38HOyT/TCO3YHW8EJ4mA6RdtTCXhrO0KsYaZZ6FntOF4rr+V9Gux4nw7ea+wmdbG90TsNKXdnPBnfPH4STk2HD6VWhUEYgEbrHWF0d/Djh/vP8rr9AxgHHVDUyc0XsLJ4/QPZHw=='),
			
			this.addEntry(dt + 'single line text field normal light dark', function()
			{
				var text1 = new mxCell('Hint text', new mxGeometry(0, 0, 346, 30), 'text;fontColor=#808080;fontSize=16;verticalAlign=middle;strokeColor=none;fillColor=none;');
				text1.vertex = true;
				var part1 = new mxCell('', new mxGeometry(0, 25, 346, 10), s + 'line;strokeWidth=1;noLabel=1;strokeColor=#eeeeee;opacity=50;');
				part1.vertex = true;
				return sb.createVertexTemplateFromCells([text1, part1], 346, 35, 'Single-line text field (normal)');
			}),
			this.addEntry(dt + 'single line text field hover light dark', function()
			{
				var text1 = new mxCell('Hint text', new mxGeometry(0, 0, 346, 30), 'text;fontColor=#808080;fontSize=16;verticalAlign=middle;strokeColor=none;fillColor=none;');
				text1.vertex = true;
				var part1 = new mxCell('', new mxGeometry(0, 25, 346, 10), s + 'line;strokeWidth=1;noLabel=1;strokeColor=#cccccc;opacity=50;');
				part1.vertex = true;
				return sb.createVertexTemplateFromCells([text1, part1], 346, 35, 'Single-line text field (hover)');
			}),
			this.addEntry(dt + 'single line text field press light dark', function()
			{
				var text1 = new mxCell('Input text', new mxGeometry(0, 0, 346, 30), 'text;fontColor=#808080;fontSize=16;verticalAlign=middle;strokeColor=none;fillColor=none;opacity=50;');
				text1.vertex = true;
				var part1 = new mxCell('', new mxGeometry(0, 25, 346, 10), s + 'line;strokeWidth=2;noLabel=1;strokeColor=#0C8CF2;opacity=50;');
				part1.vertex = true;
				return sb.createVertexTemplateFromCells([text1, part1], 346, 35, 'Single-line text field (press)');
			}),
			this.addEntry(dt + 'single line text field focus light', function()
			{
				var text1 = new mxCell('Input text', new mxGeometry(0, 0, 346, 30), 'text;fontColor=#000000;fontSize=16;verticalAlign=middle;strokeColor=none;fillColor=none;');
				text1.vertex = true;
				var part1 = new mxCell('', new mxGeometry(0, 25, 346, 10), s + 'line;strokeWidth=2;noLabel=1;strokeColor=#0C8CF2;opacity=50;');
				part1.vertex = true;
				return sb.createVertexTemplateFromCells([text1, part1], 346, 35, 'Single-line text field (focus, light)');
			}),
			this.addEntry(dt + 'single line text field normal light', function()
			{
				var text1 = new mxCell('Input text', new mxGeometry(0, 0, 346, 30), 'text;fontColor=#000000;fontSize=16;verticalAlign=middle;strokeColor=none;fillColor=none;');
				text1.vertex = true;
				var part1 = new mxCell('', new mxGeometry(0, 25, 346, 10), s + 'line;strokeWidth=1;noLabel=1;strokeColor=#eeeeee;');
				part1.vertex = true;
				return sb.createVertexTemplateFromCells([text1, part1], 346, 35, 'Single-line text field (normal, light)');
			}),
			this.addEntry(dt + 'single line text field error light', function()
			{
				var text1 = new mxCell('Input text', new mxGeometry(0, 0, 346, 30), 'text;fontColor=#000000;fontSize=16;verticalAlign=middle;strokeColor=none;fillColor=none;');
				text1.vertex = true;
				var part1 = new mxCell('', new mxGeometry(0, 25, 346, 10), s + 'line;strokeWidth=2;noLabel=1;strokeColor=#ff0000;');
				part1.vertex = true;
				var text2 = new mxCell('Username or Password is incorrect', new mxGeometry(0, 30, 346, 25), 'text;fontColor=#ff0000;fontSize=12;verticalAlign=middle;strokeColor=none;fillColor=none;');
				text2.vertex = true;
				return sb.createVertexTemplateFromCells([text1, part1, text2], 346, 55, 'Single-line text field (error, light)');
			}),
			this.addEntry(dt + 'single line text field disabled', function()
			{
				var text1 = new mxCell('Input text', new mxGeometry(0, 0, 346, 30), 'text;fontColor=#808080;fontSize=16;verticalAlign=middle;strokeColor=none;fillColor=none;');
				text1.vertex = true;
				var part1 = new mxCell('', new mxGeometry(0, 25, 346, 10), 'shape=line;strokeWidth=1;noLabel=1;strokeColor=#B3B3B3;dashed=1;dashPattern=1 4;');
				part1.vertex = true;
				return sb.createVertexTemplateFromCells([text1, part1], 346, 35, 'Single-line text field (disabled)');
			}),
			this.addEntry(dt + 'single line text field focus dark', function()
			{
				var text1 = new mxCell('Input text', new mxGeometry(0, 0, 346, 30), 'text;fontColor=#ffffff;fontSize=16;verticalAlign=middle;strokeColor=none;fillColor=none;');
				text1.vertex = true;
				var part1 = new mxCell('', new mxGeometry(0, 25, 346, 10), s + 'line;strokeWidth=2;noLabel=1;strokeColor=#0C8CF2;opacity=50;');
				part1.vertex = true;
				return sb.createVertexTemplateFromCells([text1, part1], 346, 35, 'Single-line text field (focus, dark)');
			}),
			this.addEntry(dt + 'single line text field normal dark', function()
			{
				var text1 = new mxCell('Input text', new mxGeometry(0, 0, 346, 30), 'text;fontColor=#999999;fontSize=16;verticalAlign=middle;strokeColor=none;fillColor=none;');
				text1.vertex = true;
				var part1 = new mxCell('', new mxGeometry(0, 25, 346, 10), s + 'line;strokeWidth=1;noLabel=1;strokeColor=#cccccc;opacity=50;');
				part1.vertex = true;
				return sb.createVertexTemplateFromCells([text1, part1], 346, 35, 'Single-line text field (normal, dark)');
			}),
			this.addEntry(dt + 'single line text field error dark', function()
			{
				var text1 = new mxCell('Input text', new mxGeometry(0, 0, 346, 30), 'text;fontColor=#ffffff;fontSize=16;verticalAlign=middle;strokeColor=none;fillColor=none;');
				text1.vertex = true;
				var part1 = new mxCell('', new mxGeometry(0, 25, 346, 10), s + 'line;strokeWidth=2;noLabel=1;strokeColor=#ff0000;');
				part1.vertex = true;
				var text2 = new mxCell('Username or Password is incorrect', new mxGeometry(0, 30, 346, 25), 'text;fontColor=#ff0000;fontSize=12;verticalAlign=middle;strokeColor=none;fillColor=none;');
				text2.vertex = true;
				return sb.createVertexTemplateFromCells([text1, part1, text2], 346, 55, 'Single-line text field (error, dark)');
			}),
			this.addDataEntry(dt + 'single line text field icon normal light', 346, 35, 'Single-line text field with icon (normal, light)',
				'1ZbfT4MwEMf/Gh5dSjtQH3X+eNFo4oPPddygsVBSqjL/enu0zjG6jUyNkYWkvfbo3ee+3IjYrGyvNa+LW5WBjNhlxGZaKeNGZTsDKSNKRBaxi4hSYu+IXm1ZjbtVUnMNlRnjQJ3DK5cv4CzO0Jil9Iam4DUONcztI88bo9UzzJRU2horVdm184WQcsPkHwzaQLs1uM7kI7sGVYLRS7vlTWSmcDvY1EdUgMgL78YSZ+ONm+cr169U7cBnG86c7c88400BuJ1g3h5D2eZYrUleZnJiQEJduIT3gokoS7trLB0aprP0hZ14Cmu04nQIyyuAaJDciFfoHRci6E+8V8IGsjruKCZ9F7VYNGAGyFeBjqrCdFCF+w7nZiksJhTfQlUmhBPtD+IdN8c4R7BizuWZFHmFRRNZJkcVyZvwvLuaz4XB9BPyzZJ5h2QaqNhJQN9ke3XG6js5UN9SrKn50QcaW0ulbvgTdqhu1gdpa3GZ4u9nOXnp0ZDQA9g2FXoItnSA7VY9Cfn3ilQ/rkaa0AHXU/I7ajw+UI1GC17lHahd+tvTbTOBf15CIfhGvWCy4wCmOwHGPZUG+3EAZ/K9dtx+tuP+O3LEfqE7n/zjHrJS9/YmEhL7AT3ETr8+2Bzl9e+5Dw=='),
			this.addDataEntry(dt + 'single line text field icon focus light', 342, 35, 'Single-line text field with icon (focus, light)',
				'zZZRb4IwEMc/DY+a0gpzj0OnLzNZsoc9d+OEZoWaUh3u06+lnVMpypxLBiEp1x69+92fg4BMinou6SpfiBR4QO4DMpFCKDsq6glwHmDE0oBMA4yRvgI865gNm1m0ohJK1ccBW4cN5WuwFmuo1JY7Q5XTlRlKeNWPTColxRtMBBdSG0tR6rlkyTg/MrkHg1RQdwbXmFxkcxAFKLnVS95ZqnK7goxcRDmwLHduJLI2Wtn7bOf6naoeuGz9mZPzmae0ysEsRyZvh6GoM1OtYVakfKiAwyq3CZ8FE2ASzm6T2bQvHeyns3WFHToKe7TCuA3LKQBJ4FSxDRxs5yPodnwUTAey224QokMXsVxWoFrId4H2qsKoVYU4Qq1CaEhGektRqj2YqDmc/Yl9mMUaAEkMVvZK+R1nWWlKxtKU9yrRT7TbUR3nEI08xRl7pIy6C9FXytGFUuZsT7jPLlCdU1KKB/pimtE0bFG7loqPODmVYZ+mPdiOxXgJtriFbSFemCbWT35Jc/5T+eEIt0Deor+R382F8lOS0TJryJwSnL+Txs2h7SkzHyYmDOlKrE2y/QDGJwGGB7L09loPzuh3rbb+arWHL8WA/EHnHV+zaYTnm8Z9bM4rq7u7a/jEfkHT0LffP2OW8v6/2ic='),
			this.addDataEntry(dt + 'single line text field icon normal light', 342, 35, 'Single-line text field with icon (normal, light)',
				'3ZZNU4MwEIZ/Dcd2QtKgHrV+XHTGGQ+e07KFjIF0Qlqpv96ExFoktFjtQWGYSTZZsvvs2y0RmRb1nWLL/EGmICJyE5GpklK7UVFPQYgII55G5DrCGJknwrc9q3GzipZMQamHOGDnsGZiBc7iDJXeCG+ocra0QwVz88qrSiv5AlMppDLGUpZm7WrBhfhi8i8GpaHuDa4x+cjuQBag1cZseeWpzt0OMvER5cCz3LsR6myscvNs6/qZqhn4bMOZk8OZp6zKwW5HNm+PoagzW61xVqRirEHAMncJHwQTYZI011A6OExn4ws79hR2aMVJF5ZXAFIgmOZraB0XIuhPfJTcBLI9bhSjtotcLCrQHeTbQAdVYdKpQkLRiFI6ik3pOxUxtKwGF7LUO1RRc3n7E3+zm2NL2fLlcyYuBc9KWzuepmJQrb4j4p4yeQc6CVTpPKBp1F+RoZqmR2pa8B0FP/tAY2Mp5T2b2a7UzNrUDPibxN6/y8nLDYfEHcD2VZXHYEs62B7kjBti/0B+mOIOyAt0GvmdHSk/rTgrs4bMPsEdaKkpt/9QXFrSlVzZZIcBTPYCjFuyDDbdAE76s55bf/Tc9o9iRE7Qgs//cNPYqru/a4TEfkTTMNPPrzJHefej7R0='),
			this.addDataEntry(dt + 'single line text field icon normal dark', 342, 35, 'Single-line text field with icon (normal, dark)',
				'1ZZRT8IwEMc/zR4lXcsAHwWVF01IfPC5sGNr7Nalqzr89LZrRcY6mAgxNiFpr7317nf/HQvILKvmkhbpo4iBB+QuIDMphLKzrJoB5wFGLA7IbYAx0r8A33fshvUuKqiEXPVxwNbhjfJXsBZrKNWGO0OZ0sJMJaz0I6elkuIFZoILqY25yPXedM043zO5B4NUUHUGV5tcZHMQGSi50UfeWaxSe4IMXUQpsCR1biSyNlradbJ1/U5VT1y2/szJ8cxjWqZgjiOTt8OQVYmp1iDJYj5QwKFIbcJHwQSYrOrRlw7209m4wg4chR1a4agNyykASeBUsTdoXOcj6G5cCKYD2V53FaKmi1ivS1At5NtAe1Vh2KrCosa5XwqNyYhvLXK1g3NcD2d/Yh/msEZApgYsW1F+w1mSm6KxOOa9ivQT9XbUxzlEQ095Jh4xo+5S9BVzdKKYOduR7rMLNNSWXDzQpWlH9apJTYOP6nFeTk5n2KdqD7Z9OZ6CbdTC9iiWjP+9/ERBV0wZIhE6D2Uc4RbXa3QZNY5PVKOSjOZJDeqQ/o601piZfyomDPhSvJpk+wEcHQQYNlTqbb4enNHvem/11Xub78gVuUArnvzjHrJVd3cT8Yn9hB6il99fZ5by7sfbJw=='),
			this.addDataEntry(dt + 'single line text field icon focus dark', 342, 35, 'Single-line text field with icon (focus, dark)',
				'zZZRb4IwEMc/DY+a0opuj0OnL1uyZA977uSAZoWaUjfcp19LO6dSlDlN1oSkXHv07nd/DgIyLeqFpKv8USTAA3IfkKkUQtlZUU+B8wAjlgRkFmCM9BXgecdq2KyiFZVQqj4O2Dq8U74Ga7GGSm24M1Q5XZmphKV+ZFwpKd5gKriQ2liKUq/FKeP8wOQeDFJB3RlcY3KRLUAUoORGb/lgicrtDjJyEeXAsty5kcjaaGXvs63rT6p64rL1Z05OZ57QKgezHZm8HYaizky1hlmR8KECDqvcJnwSTIBJOL+N57O+dLCfzsYVdugo7NAKx21YTgFIAqeKvcPecT6C7sQnwXQg2+MGIdp3EWlagWoh3wbaqwqjVhXGEWoVQkMy0ktFqXZgps1w9mf2aTZrACQ2WNmS8jvOstKUjCUJ71Wi32i3ozrOIRp5inPjkTLqLkRfKUdnSpmzHeG+uEB1TnEpHuiraUazsEXtUio+4ORUhn2a9mA7FOM52MYtbI/ilWli/eQ3acY/lR+OcAvkLbqO/CZnyk9JRsusIXNMcP5OumyGtifMfJiYMKQrsTbJ9gM4Pgow3JOlt9d6cEZ/a7X1d6vdfykG5Aqd9+aSTSM83TSiZlxY3d1dwyf2M5qGvv35GbOUd//VvgA='),
			this.addDataEntry(dt + 'single line text field icon normal dark', 342, 35, 'Single-line text field with icon (normal, dark)',
				'3ZZNU8MgEIZ/TY7tEChVj7Z+XHTGGQ+eabNJGEnoENTUXy8EbJuG2FjtQZnpDCxs2H32zTYRmRf1rWKr/F4mICJyHZG5klK7WVHPQYgII55E5CrCGJlfhG96duNmF62YglIPccDO4ZWJF3AWZ6j0WnhDlbOVnSpYmkfOKq3kM8ylkMoYS1mavVnKhdgz+QeD0lD3BteYfGS3IAvQam2OvPFE5+4EmfiIcuBZ7t0IdTZWuXW2cd2maiY+23Dm5HDmCatysMeRzdtjKOrMVmucFYkYaxCwyl3CB8FEmCybMZQODtNZ+8KOPYUdWvG0C8srACkQTPNXaF0XIuhvfJDcBLK5bhSjtotM0wp0B/km0EFVmHSqMKVoRCkdxab0nYoYWlaDqSz1DtW0Gd7+yN/tYUOCzCxfvmTiUvCstLXjSSIG1eo7Iu4pk3egk0CVzgOaRv0VGappeqSmBd9R8JMPNDaWUt6xhe1KzapNzYCnzfhdTl5uOCTuALZ9VR6DbdrBdi8X3BD7B/LDFHdAXqDTyO/sSPlpxVmZNWS+EtyBlppw+w/FpSVdyReb7DCA0y8Bxi1ZBptuACf9Wc+tP3tu+6UYkRO04PM/3DQ26u7vGiGxH9E0zHL7VeYo7360fQA='),

			this.addEntry(dt + 'single line text field normal light dark', function()
			{
				var text1 = new mxCell('Label text', new mxGeometry(0, 0, 346, 30), 'text;fontColor=#808080;fontSize=16;verticalAlign=middle;strokeColor=none;fillColor=none;');
				text1.vertex = true;
				var part1 = new mxCell('', new mxGeometry(0, 25, 346, 10), s + 'line;strokeWidth=1;noLabel=1;strokeColor=#999999;opacity=80;');
				part1.vertex = true;
				return sb.createVertexTemplateFromCells([text1, part1], 346, 35, 'Single-line text field (normal)');
			}),
			this.addEntry(dt + 'single line text field focus light', function()
			{
				var text1 = new mxCell('Label text', new mxGeometry(0, 0, 346, 30), 'text;fontColor=#1F9BFD;fontSize=12;verticalAlign=middle;strokeColor=none;fillColor=none;');
				text1.vertex = true;
				var text2 = new mxCell('Input text', new mxGeometry(0, 20, 346, 30), 'text;fontColor=#000000;fontSize=16;verticalAlign=middle;strokeColor=none;fillColor=none;');
				text2.vertex = true;
				var part1 = new mxCell('', new mxGeometry(0, 45, 346, 10), s + 'line;strokeWidth=2;noLabel=1;strokeColor=#1F9BFD;');
				part1.vertex = true;
				return sb.createVertexTemplateFromCells([text1, text2, part1], 346, 55, 'Single-line text field (normal, light)');
			}),
			this.addEntry(dt + 'single line text field focus light', function()
			{
				var text1 = new mxCell('Label text', new mxGeometry(0, 0, 346, 30), 'text;fontColor=#cccccc;fontSize=12;verticalAlign=middle;strokeColor=none;fillColor=none;');
				text1.vertex = true;
				var text2 = new mxCell('Input text', new mxGeometry(0, 20, 346, 30), 'text;fontColor=#000000;fontSize=16;verticalAlign=middle;strokeColor=none;fillColor=none;');
				text2.vertex = true;
				var part1 = new mxCell('', new mxGeometry(0, 45, 346, 10), s + 'line;strokeWidth=2;noLabel=1;strokeColor=#eeeeee;');
				part1.vertex = true;
				return sb.createVertexTemplateFromCells([text1, text2, part1], 346, 55, 'Single-line text field (normal, light)');
			}),
			this.addEntry(dt + 'single line text field focus light dark', function()
			{
				var text1 = new mxCell('Label text', new mxGeometry(0, 0, 346, 30), 'text;fontColor=#999999;fontSize=12;verticalAlign=middle;strokeColor=none;fillColor=none;textOpacity=80;');
				text1.vertex = true;
				var text2 = new mxCell('Input text', new mxGeometry(0, 20, 346, 30), 'text;fontColor=#999999;fontSize=16;verticalAlign=middle;strokeColor=none;fillColor=none;textOpacity=80;');
				text2.vertex = true;
				var part1 = new mxCell('', new mxGeometry(0, 45, 346, 10), 'shape=line;strokeWidth=1;noLabel=1;strokeColor=#999999;dashed=1;dashPattern=1 4;opacity=80;');
				part1.vertex = true;
				return sb.createVertexTemplateFromCells([text1, text2, part1], 346, 55, 'Single-line text field (normal)');
			}),
			this.addEntry(dt + 'single line text field focus dark', function()
			{
				var text1 = new mxCell('Label text', new mxGeometry(0, 0, 346, 30), 'text;fontColor=#1F9BFD;fontSize=12;verticalAlign=middle;strokeColor=none;fillColor=none;');
				text1.vertex = true;
				var text2 = new mxCell('Input text', new mxGeometry(0, 20, 346, 30), 'text;fontColor=#ffffff;fontSize=16;verticalAlign=middle;strokeColor=none;fillColor=none;');
				text2.vertex = true;
				var part1 = new mxCell('', new mxGeometry(0, 45, 346, 10), s + 'line;strokeWidth=2;noLabel=1;strokeColor=#1F9BFD;');
				part1.vertex = true;
				return sb.createVertexTemplateFromCells([text1, text2, part1], 346, 55, 'Single-line text field (normal, dark)');
			}),
			this.addEntry(dt + 'single line text field focus dark', function()
			{
				var text1 = new mxCell('Label text', new mxGeometry(0, 0, 346, 30), 'text;fontColor=#999999;fontSize=12;verticalAlign=middle;strokeColor=none;fillColor=none;');
				text1.vertex = true;
				var text2 = new mxCell('Input text', new mxGeometry(0, 20, 346, 30), 'text;fontColor=#cccccc;fontSize=16;verticalAlign=middle;strokeColor=none;fillColor=none;');
				text2.vertex = true;
				var part1 = new mxCell('', new mxGeometry(0, 45, 346, 10), s + 'line;strokeWidth=1;noLabel=1;strokeColor=#999999;');
				part1.vertex = true;
				return sb.createVertexTemplateFromCells([text1, text2, part1], 346, 55, 'Single-line text field (normal, dark)');
			}),
			this.addDataEntry(dt + 'full text field', 362, 56, 'Full text field',
				'vVTLboMwEPwaHxMRG2jPJW0urVQph56tsGCrBiPjJqRfX79CQJAKqVFXQvKOd9j1jGVEsqrbKdqwN5mDQOQZkUxJqf2q6jIQAuGI54hsEcaR+RB+ubG7cbtRQxXUegkBe8KRii/wyB6oOjAPt/osApzTloElRYg8tYw2Fldw0D7N5cnkG5toJT8hk0IqxyTgot/54LlmobbgQgwqCxcWl7Xe82/bwszh80Fd5sLgVPCyNpiAws3R0AOvy1eXbdPEQOF4oDR0NyVyUNBnB7ICrc6m5BQmNbskDUIx4CULtCT1GG19XvbUq+BmETSf159M9F+mfNWV9s6syyoX68vxR/riOS9SF0t1wfO6nMPFWieeMtBpk05lumAKBNX8CKN2c9qFju+Sm0FwFOa7KBO6rx7HP5BF0YKeSN+PvciN+B5udP9oxZjwmzHxjDHxXYxZkWTszMPfnTHp9Q305cMn8gc='),
			this.addDataEntry(dt + 'full text field', 362, 294, 'Full text field',
				'7VjRbpswFP0aHhsZQ2jzmCZbX7ap0ibt2Q0XsGZsZLsp2dfPGJPAICpdoarWWIrEPb4XO+fkXCv2gk1e3klSZF9FDMwLPnnBRgqh66e83ABjHkY09oKthzEyHw9/PjPr21lUEAlcjynAdcGesEeoEVIjSh+YQ2KiMqjykRfcqowUFS5hp+swFk8m9qtAS/ELNoIJaSsDsOM485PGOnO5CWWslZnYUeGC6+/0d7WE2Ucdt/KQHQYnjKbcYAwSu4+C7ChPv9hoGy0NVG37nmgNkts1MQoNugep6Y6wtavXojiV/6iCbWQAR4tJhvIstRZyvN6ByEHLg0l5cl/TzAaRIzgDmmauDK/CGiSqBtJj7Ukp8+DEGhYu6Ak3Tre8TKsf2yLNY7ZoyOuog4eUjOwYSwx+lhg/6vPSYBIY0XQPndcPceVWuBfULIyR20/DxMGFqPsCkSQKdI/q4zZHsR9OwX75htR3C9pChANChJMIcRUsu0rgGZRY/qMSjPLhxnS+iUlQpjG1cycyw2CX8NHrRHCkh6sZSI96pK+JFNxAt8A5aP2yM6TDOBdWmPb54KC/Wn7rpPCj4SMg0zlzUr2teNE04i3DGcS7nqJ3PSqQY6R7cf+KxvQvRw9aLHv9LER9NcJXqtH0s0ZVt/zVLEfLTd9bDw9QcbDJJFUauAJ+8dck/vL9OQy2etcGu/noBmsO1rbDGKOVwQTnQqqLuaYx1/Uc5vL9d+2u+sf1oe3Vv1JYM8MYRt+AKXE5uqZxFw5mcdck1wrzuWvUv9v/yF0mPN0F1untq8I/'),
			this.addDataEntry(dt + 'inset text field', 362, 56, 'Inset text field',
				'rVTBboMwDP2aHFtB0qKdR7deNmlSDztHYEi0QFDIWtjXLyQphUIrpNYSUvxsY/OeCSJx0ewVrdinTEEg8oZIrKTU7lQ0MQiBcMBTRHYI48A8CL/fiIY2GlRUQamXFGBXcKTiFxxyAKoS5uBat8LDKa0ZdEUBIq81o1WHK0i0c1N5Mn7YOVrJH4ilkMpWErDWR755qpnPzbgQg8zMWofLUh/4X9fCzOH8QV5szeBU8Lw0mIDMzlHRhJf5h/V20dZA/vNAaWhuUmQhz88eZAFatSbl5Cc1URJ5ohjwnPmybeQwWjs/70svhJuD53yefzLhfxnzRZN3O7POi1SsayfZNcN4To3I2lJm8DwzrV+t9daVDJgKoylRZ0yBoJofYdRujj3f8UtyMwgO/Hxnbnz31cv4BTLLatAT8vuxF+mxeYYeR8mT6cLfl+PqV3iKTOOCe6LNbLe/OB4VbUU2Y9XC4HHZjHu5Il368Ab9Bw=='),
			this.addDataEntry(dt + 'focus card suggestion', 362, 246, 'Focus card suggestions',
				'7VfBjpswEP0ajl0ZA25y7CbtXlpppVbq2Q0DWDWYGieb9Os72CaBhmijLqSXWIrCPM/Y5r1hBoJoVe6fNK+LLyoFGUQfg2illTLuqtyvQMqAEpEG0TqglOAvoJ8uzIZ2ltRcQ2WuCaAuYMflFhySQtOANg5vzEF2OG8KaKNIED02Ba9bXMPGODNVL2iHrWG0+gkrJZW2kRHYcZz5LlJTeN9MSNnzzOxocVWZr+J3uwWew9k9P2IH4lyKvEJMQmbPUfONqPLP1lqzBKH22M/cGNCV3ZOSGNEd3qHYcPnBxxtVn8K/tcaaIeDJQWfYXyTYQp7dJ1AlGH1Alxd/mzgbMU9zASIvfBiNmQN544D8GHvSCy+8ZOPyRWfyXadbuc/blHvIy1Q+dOQN1KFjSjI7riWGvkpMyM556TANkhuxg8HyY1z5HZ6VwI0p8efpmDh4kwwXUFnWgDmj+njMq9iPp2B/f0PqhwF9IeIRIeJJhHgXJUMl6AxKJP+ohBTVeGG6XMQ0NFiY+r4TPQyjVSIkbxPBkx4vZyCdTdM7BkxXygrS7wse+qvU9zpEyMZLf2FK2fWZYf9Y2nFzMePFJGIm8Qxivr8sJqYgkx3naG6ORLJf2/ZF5fHUknsQy9v/H1x34XgEt4KbuWfJrFkSkjkK7WKmNGkKfOm658n/yJNkjlej5Ux5ghQbvtXcpsc9W26fLcvF27MFzdMXrnPvfwD/AQ==')
   		];
		  
		this.addPalette('gmdlText Fields', 'GMDL / Text Fields', expand || false, mxUtils.bind(this, function(content)
		{
			for (var i = 0; i < fns.length; i++)
			{
				content.appendChild(fns[i](content));
			}
		}));
	};

})();

(function()
{
	// Adds P&ID shapes
	Sidebar.prototype.addPidInstrumentsPalette = function()
	{
		var s = 'html=1;outlineConnect=0;align=center;dashed=0;aspect=fixed;' + mxConstants.STYLE_SHAPE + "=mxgraph.pid2";
		var s2 = 'html=1;outlineConnect=0;align=center;dashed=0;' + mxConstants.STYLE_SHAPE + "=mxgraph.pid2";
		var gn = 'mxgraph.pid2inst';
		var dt = 'pid process instrumentation engineering instrument engineering ';

		this.addPaletteFunctions('pidInstruments', 'Proc. Eng. / Instruments', false,
		[
			this.createVertexTemplateEntry(s + 'inst.discInst;mounting=room',
					50, 50, '<table cellpadding="4" cellspacing="0" border="0" style="font-size:1em;width:100%;height:100%;">' +
		    		'<tr><td>TI</td></tr><tr><td>##</td></table> ', 'Discrete Instrument (control room)', null, null, this.getTagsForStencil(gn, 'discInst', dt + 'discrete control room').join(' ')),
			this.createVertexTemplateEntry(s + 'inst.discInst;mounting=field',
					50, 50, '<table cellpadding="4" cellspacing="0" border="0" style="font-size:1em;width:100%;height:100%;">' +
		    		'<tr><td>TI</td></tr><tr><td>##</td></table> ', 'Discrete Instrument (field)', null, null, this.getTagsForStencil(gn, 'discInst', dt + 'discrete field').join(' ')),
			this.createVertexTemplateEntry(s + 'inst.discInst;mounting=inaccessible',
					50, 50, '<table cellpadding="4" cellspacing="0" border="0" style="font-size:1em;width:100%;height:100%;">' +
		    		'<tr><td>TI</td></tr><tr><td>##</td></table> ', 'Discrete Instrument (inaccessible)', null, null, this.getTagsForStencil(gn, 'discInst', dt + 'discrete inaccessible').join(' ')),
			this.createVertexTemplateEntry(s + 'inst.discInst;mounting=local',
					50, 50, '<table cellpadding="4" cellspacing="0" border="0" style="font-size:1em;width:100%;height:100%;">' +
		    		'<tr><td>TI</td></tr><tr><td>##</td></table> ', 'Discrete Instrument (local panel)', null, null, this.getTagsForStencil(gn, 'discInst', dt + 'discrete local panel').join(' ')),

			this.createVertexTemplateEntry(s + 'inst.sharedCont;mounting=room',
					50, 50, '<table cellpadding="4" cellspacing="0" border="0" style="font-size:1em;width:100%;height:100%;">' +
		    		'<tr><td>TI</td></tr><tr><td>##</td></table> ', 'Shared Control/Display in DCS (control room)', null, null, this.getTagsForStencil(gn, 'sharedCont', dt + 'shared control display room').join(' ')),
			this.createVertexTemplateEntry(s + 'inst.sharedCont;mounting=field',
					50, 50, '<table cellpadding="4" cellspacing="0" border="0" style="font-size:1em;width:100%;height:100%;">' +
		    		'<tr><td>TI</td></tr><tr><td>##</td></table> ', 'Shared Control/Display in DCS (field)', null, null, this.getTagsForStencil(gn, 'sharedCont', dt + 'shared control display dcs field').join(' ')),
			this.createVertexTemplateEntry(s + 'inst.sharedCont;mounting=inaccessible',
					50, 50, '<table cellpadding="4" cellspacing="0" border="0" style="font-size:1em;width:100%;height:100%;">' +
		    		'<tr><td>TI</td></tr><tr><td>##</td></table> ', 'Shared Control/Display in DCS (inaccessible)', null, null, this.getTagsForStencil(gn, 'sharedCont', dt + 'shared control display dcs inaccessible').join(' ')),
			this.createVertexTemplateEntry(s + 'inst.sharedCont;mounting=local',
					50, 50, '<table cellpadding="4" cellspacing="0" border="0" style="font-size:1em;width:100%;height:100%;">' +
		    		'<tr><td>TI</td></tr><tr><td>##</td></table> ', 'Shared Control/Display in DCS (local panel)', null, null, this.getTagsForStencil(gn, 'sharedCont', dt + 'shared control display dcs local panel').join(' ')),

			this.createVertexTemplateEntry(s + 'inst.compFunc;mounting=room',
					50, 50, '<table cellpadding="4" cellspacing="0" border="0" style="font-size:1em;width:100%;height:100%;">' +
		    		'<tr><td>TI</td></tr><tr><td>##</td></table> ', 'Computer Function (control room)', null, null, this.getTagsForStencil(gn, 'compFunc', dt + 'computer function control room').join(' ')),
			this.createVertexTemplateEntry(s + 'inst.compFunc;mounting=field',
					50, 50, '<table cellpadding="4" cellspacing="0" border="0" style="font-size:1em;width:100%;height:100%;">' +
		    		'<tr><td>TI</td></tr><tr><td>##</td></table> ', 'Computer Function (field)', null, null, this.getTagsForStencil(gn, 'compFunc', dt + 'computer function field').join(' ')),
			this.createVertexTemplateEntry(s + 'inst.compFunc;mounting=inaccessible',
					50, 50, '<table cellpadding="4" cellspacing="0" border="0" style="font-size:1em;width:100%;height:100%;">' +
		    		'<tr><td>TI</td></tr><tr><td>##</td></table> ', 'Computer Function (inaccessible)', null, null, this.getTagsForStencil(gn, 'compFunc', dt + 'computer function inaccessible').join(' ')),
			this.createVertexTemplateEntry(s + 'inst.compFunc;mounting=local',
					50, 50, '<table cellpadding="4" cellspacing="0" border="0" style="font-size:1em;width:100%;height:100%;">' +
		    		'<tr><td>TI</td></tr><tr><td>##</td></table> ', 'Computer Function (local panel)', null, null, this.getTagsForStencil(gn, 'compFunc', dt + 'computer function local panel').join(' ')),

			this.createVertexTemplateEntry(s + 'inst.progLogCont;mounting=room',
					50, 50, '<table cellpadding="4" cellspacing="0" border="0" style="font-size:1em;width:100%;height:100%;">' +
		    		'<tr><td>TI</td></tr><tr><td>##</td></table> ', 'Programmable Logic Control (control room)', null, null, this.getTagsForStencil(gn, 'progLogCont', dt + 'programmable logic control plc room').join(' ')),
			this.createVertexTemplateEntry(s + 'inst.progLogCont;mounting=field',
					50, 50, '<table cellpadding="4" cellspacing="0" border="0" style="font-size:1em;width:100%;height:100%;">' +
		    		'<tr><td>TI</td></tr><tr><td>##</td></table> ', 'Programmable Logic Control (field)', null, null, this.getTagsForStencil(gn, 'progLogCont', dt + 'programmable logic control plc field').join(' ')),
			this.createVertexTemplateEntry(s + 'inst.progLogCont;mounting=inaccessible',
					50, 50, '<table cellpadding="4" cellspacing="0" border="0" style="font-size:1em;width:100%;height:100%;">' +
		    		'<tr><td>TI</td></tr><tr><td>##</td></table> ', 'Programmable Logic Control (inaccessible)', null, null, this.getTagsForStencil(gn, 'progLogCont', dt + 'programmable logic control plc inaccessible').join(' ')),
			this.createVertexTemplateEntry(s + 'inst.progLogCont;mounting=local',
					50, 50, '<table cellpadding="4" cellspacing="0" border="0" style="font-size:1em;width:100%;height:width;">' +
		    		'<tr><td>TI</td></tr><tr><td>##</td></table> ', 'Programmable Logic Control (local panel)', null, null, this.getTagsForStencil(gn, 'progLogCont', dt + 'programmable logic control plc local panel').join(' ')),

			this.createVertexTemplateEntry(s + 'inst.logic;mounting=room',
					50, 50, '<table cellpadding="4" cellspacing="0" border="0" style="font-size:1em;width:100%;height:100%;">' +
		    		'<tr><td>TI</td></tr><tr><td>##</td></table> ', 'Logic (control room)', null, null, this.getTagsForStencil(gn, 'logic', dt + 'control room').join(' ')),
			this.createVertexTemplateEntry(s + 'inst.logic;mounting=field',
					50, 50, '<table cellpadding="4" cellspacing="0" border="0" style="font-size:1em;width:100%;height:100%;">' +
		    		'<tr><td>TI</td></tr><tr><td>##</td></table> ', 'Logic (field)', null, null, this.getTagsForStencil(gn, 'logic', dt + 'field').join(' ')),
			this.createVertexTemplateEntry(s + 'inst.logic;mounting=inaccessible',
					50, 50, '<table cellpadding="4" cellspacing="0" border="0" style="font-size:1em;width:100%;height:100%;">' +
		    		'<tr><td>TI</td></tr><tr><td>##</td></table> ', 'Logic (inaccessible)', null, null, this.getTagsForStencil(gn, 'logic', dt + 'inaccessible').join(' ')),
			this.createVertexTemplateEntry(s + 'inst.logic;mounting=local',
					50, 50, '<table cellpadding="4" cellspacing="0" border="0" style="font-size:1em;width:100%;height:100%;">' +
		    		'<tr><td>TI</td></tr><tr><td>##</td></table> ', 'Logic (local panel)', null, null, this.getTagsForStencil(gn, 'logic', dt + 'local panel').join(' ')),

			this.createVertexTemplateEntry(s2 + 'inst.indicator;mounting=room;overflow=fill;indType=inst', 50, 100,  
					'<table cellpadding="0" cellspacing="0" style="font-size:1em;width:100%;height:100%;"><tr><td align="center" height="25">TI</td></tr><tr><td align="center" height="25">##</td></tr><tr><td align="center" valign="bottom"></td></tr></table>', 
					'Indicator (Instrument)', null, null, this.getTagsForStencil(gn, 'indicator', dt + 'indicator').join(' ')),
			this.createVertexTemplateEntry(s2 + 'inst.indicator;mounting=room;overflow=fill;indType=ctrl', 50, 100,  
					'<table cellpadding="0" cellspacing="0" style="font-size:1em;width:100%;height:100%;"><tr><td align="center" height="25">TI</td></tr><tr><td align="center" height="25">##</td></tr><tr><td align="center" valign="bottom"></td></tr></table>', 
					'Indicator (Control)', null, null, this.getTagsForStencil(gn, 'indicator', dt + 'indicator control').join(' ')),
			this.createVertexTemplateEntry(s2 + 'inst.indicator;mounting=room;overflow=fill;indType=func', 50, 100,  
					'<table cellpadding="0" cellspacing="0" style="font-size:1em;width:100%;height:100%;"><tr><td align="center" height="25">TI</td></tr><tr><td align="center" height="25">##</td></tr><tr><td align="center" valign="bottom"></td></tr></table>', 
					'Indicator (Function)', null, null, this.getTagsForStencil(gn, 'indicator', dt + 'indicator function').join(' ')),
			this.createVertexTemplateEntry(s2 + 'inst.indicator;mounting=room;overflow=fill;indType=plc', 50, 100,  
					'<table cellpadding="0" cellspacing="0" style="font-size:1em;width:100%;height:100%;"><tr><td align="center" height="25">TI</td></tr><tr><td align="center" height="25">##</td></tr><tr><td align="center" valign="bottom"></td></tr></table>', 
					'Indicator (PLC)', null, null, this.getTagsForStencil(gn, 'indicator', dt + 'indicator plc programmable logic control').join(' '))
		]);
	};
	
	Sidebar.prototype.addPidValvesPalette = function()
	{
		var s = 'dashed=0;outlineConnect=0;html=1;' + mxConstants.STYLE_SHAPE + "=mxgraph.pid2";
		var sv = mxConstants.STYLE_VERTICAL_LABEL_POSITION + '=bottom;align=center;html=1;' + mxConstants.STYLE_VERTICAL_ALIGN + '=top;pointerEvents=1;dashed=0;' + mxConstants.STYLE_SHAPE + "=mxgraph.pid2valves.valve;valveType=";
		var s = mxConstants.STYLE_VERTICAL_LABEL_POSITION + '=bottom;align=center;html=1;' + mxConstants.STYLE_VERTICAL_ALIGN + '=top;pointerEvents=1;dashed=0;' + mxConstants.STYLE_SHAPE + "=mxgraph.pid2valves.";
		var gn = 'mxgraph.pid2valves';
		var dt = 'pid process instrumentation engineering ';

		this.addPaletteFunctions('pidValves', 'Proc. Eng. / Valves', false,
		[
			this.createVertexTemplateEntry(sv + 'gate', 100, 60, '', 'Gate Valve', null, null, this.getTagsForStencil(gn, 'valve', dt + 'gate').join(' ')),
			this.createVertexTemplateEntry(sv + 'gate;defState=closed', 100, 60, '', 'Normally Closed Gate Valve', null, null, this.getTagsForStencil(gn, 'valve', dt + 'normally closed nc gate').join(' ')),
			this.createVertexTemplateEntry(sv + 'ball', 100, 60, '', 'Ball Valve', null, null, this.getTagsForStencil(gn, 'valve', dt + 'ball').join(' ')),
			this.createVertexTemplateEntry(sv + 'ball;defState=closed', 100, 60, '', 'Normally Closed Ball Valve', null, null, this.getTagsForStencil(gn, 'valve', dt + 'normally closed nc ball').join(' ')),
			this.createVertexTemplateEntry(sv + 'globe', 100, 60, '', 'Globe Valve', null, null, this.getTagsForStencil(gn, 'valve', dt + 'globe').join(' ')),
			this.createVertexTemplateEntry(sv + 'butterfly', 100, 60, '', 'Butterfly Valve', null, null, this.getTagsForStencil(gn, 'valve', dt + 'butterfly').join(' ')),
			this.createVertexTemplateEntry(sv + 'check;', 100, 60, '', 'Check Valve', null, null, this.getTagsForStencil(gn, 'valve', dt + 'check').join(' ')),
			this.createVertexTemplateEntry(sv + 'plug', 100, 60, '', 'Plug Valve', null, null, this.getTagsForStencil(gn, 'valve', dt + 'plug').join(' ')),
			this.createVertexTemplateEntry(sv + 'needle', 100, 60, '', 'Needle Valve', null, null, this.getTagsForStencil(gn, 'valve', dt + 'needle').join(' ')),
			this.createVertexTemplateEntry(sv + 'selfDrain', 100, 60, '', 'Self Draining Valve', null, null, this.getTagsForStencil(gn, 'valve', dt + 'self draining').join(' ')),
			this.createVertexTemplateEntry(sv + 'gate;actuator=man', 100, 100, '', 'Gate Valve (Manual)', null, null, this.getTagsForStencil(gn, 'valve', dt + 'gate manual').join(' ')),
			this.createVertexTemplateEntry(sv + 'gate;actuator=diaph', 100, 100, '', 'Gate Valve (Diaphragm)', null, null, this.getTagsForStencil(gn, 'valve', dt + 'gate diaphragm').join(' ')),
			this.createVertexTemplateEntry(sv + 'gate;actuator=balDiaph', 100, 100, '', 'Gate Valve (Balanced Diaphragm)', null, null, this.getTagsForStencil(gn, 'valve', dt + 'gate balanced diaphragm').join(' ')),
			
			this.addEntry(dt + 'valve gate powered', function()
			{
				var bg1 = new mxCell('', new mxGeometry(0, 0, 100, 100), sv + 'gate;actuator=powered');
				bg1.vertex = true;
				var item1 = new mxCell('', new mxGeometry(32.5, 0, 35, 35), 'part=1;strokeColor=none;fillColor=none;fontStyle=1;fontSize=14;');
				item1.vertex = true;
				bg1.insert(item1);
			    
			   	return sb.createVertexTemplateFromCells([bg1], 100, 100, 'Gate Valve (Powered)');
			}),

			this.createVertexTemplateEntry(sv + 'gate;actuator=digital', 100, 100, '', 'Gate Valve (Digital)', null, null, this.getTagsForStencil(gn, 'valve', dt + 'gate digital').join(' ')),
			this.createVertexTemplateEntry(sv + 'gate;actuator=elHyd', 100, 100, '', 'Gate Valve (Electro-Hydraulic)', null, null, this.getTagsForStencil(gn, 'valve', dt + 'gate electro hydraulic').join(' ')),
			this.createVertexTemplateEntry(sv + 'gate;actuator=key', 100, 100, '', 'Gate Valve (Key)', null, null, this.getTagsForStencil(gn, 'valve', dt + 'gate key').join(' ')),
			this.createVertexTemplateEntry(sv + 'gate;actuator=motor', 100, 100, '', 'Gate Valve (Motor)', null, null, this.getTagsForStencil(gn, 'valve', dt + 'gate motor').join(' ')),
			this.createVertexTemplateEntry(sv + 'gate;actuator=pilot', 100, 100, '', 'Gate Valve (Pilot)', null, null, this.getTagsForStencil(gn, 'valve', dt + 'gate pilot').join(' ')),
			this.createVertexTemplateEntry(sv + 'gate;actuator=solenoid', 100, 100, '', 'Gate Valve (Solenoid)', null, null, this.getTagsForStencil(gn, 'valve', dt + 'gate solenoid').join(' ')),
			this.createVertexTemplateEntry(sv + 'gate;actuator=solenoidManRes', 100, 100, '', 'Gate Valve (Solenoid With Manual Reset)', null, null, this.getTagsForStencil(gn, 'valve', dt + 'gate solenoid manual reset').join(' ')),
			this.createVertexTemplateEntry(sv + 'gate;actuator=spring', 100, 100, '', 'Gate Valve (Spring)', null, null, this.getTagsForStencil(gn, 'valve', dt + 'gate spring').join(' ')),
			this.createVertexTemplateEntry(sv + 'gate;actuator=weight', 100, 100, '', 'Gate Valve (Weight)', null, null, this.getTagsForStencil(gn, 'valve', dt + 'gate weight').join(' ')),
			this.createVertexTemplateEntry(sv + 'gate;actuator=singActing', 100, 100, '', 'Gate Valve (Single Acting Cylinder)', null, null, this.getTagsForStencil(gn, 'valve', dt + 'gate single acting cylinder').join(' ')),
			this.createVertexTemplateEntry(sv + 'gate;actuator=dblActing', 100, 100, '', 'Gate Valve (Double Acting Cylinder)', null, null, this.getTagsForStencil(gn, 'valve', dt + 'gate double acting cylinder').join(' ')),
			this.createVertexTemplateEntry(sv + 'gate;actuator=angBlow', 100, 100, '', 'Angle Blowdown Valve', null, null, this.getTagsForStencil(gn, 'valve', dt + 'angle blowdown').join(' ')),
			this.createVertexTemplateEntry(s + 'blockBleedValve;actuator=none', 100, 130, '', 'Integrated Block and Bleed Valve', null, null, this.getTagsForStencil(gn, 'blockBleedValve', dt + 'integrated block bleed').join(' ')),
			this.createVertexTemplateEntry(s + 'blockBleedValve;actuator=man', 100, 170, '', 'Integrated Block and Bleed Valve (Manual)', null, null, this.getTagsForStencil(gn, 'blockBleedValve', dt + 'integrated block bleed manual').join(' ')),
			this.createVertexTemplateEntry(sv + 'angle;actuator=none', 100, 80, '', 'Angle Valve', null, null, this.getTagsForStencil(gn, 'valve', dt + 'angle').join(' ')),
			this.createVertexTemplateEntry(sv + 'angle;actuator=man', 100, 120, '', 'Angle Valve (Manual)', null, null, this.getTagsForStencil(gn, 'valve', dt + 'angle manual').join(' ')),
			this.createVertexTemplateEntry(sv + 'angleGlobe;actuator=none', 100, 80, '', 'Angle Globe Valve', null, null, this.getTagsForStencil(gn, 'valve', dt + 'angle globe').join(' ')),
			this.createVertexTemplateEntry(sv + 'angleGlobe;actuator=man', 100, 120, '', 'Angle Globe Valve (Manual)', null, null, this.getTagsForStencil(gn, 'valve', dt + 'angle globe manual').join(' ')),
			this.createVertexTemplateEntry(sv + 'threeWay;actuator=none', 100, 80, '', '3 Way Valve', null, null, this.getTagsForStencil(gn, 'valve', dt + 'three way').join(' ')),
			this.createVertexTemplateEntry(sv + 'threeWay;actuator=man', 100, 120, '', '3 Way Valve (Manual)', null, null, this.getTagsForStencil(gn, 'valve', dt + 'three way manual').join(' ')),
			this.createVertexTemplateEntry(s + 'autoRecircValve', 100, 60, '', 'Auto Recirculation Valve', null, null, this.getTagsForStencil(gn, 'blockBleedValve', dt + 'auto recirculation').join(' '))
		]);
	};
	
	Sidebar.prototype.addPidCompressorsPalette = function()
	{
		var s = mxConstants.STYLE_VERTICAL_LABEL_POSITION + '=bottom;outlineConnect=0;align=center;dashed=0;html=1;' + mxConstants.STYLE_VERTICAL_ALIGN + '=top;' + mxConstants.STYLE_SHAPE + "=mxgraph.pid.compressors.";
		var gn = 'mxgraph.pid.compressors';
		var dt = 'pid process instrumentation engineering ';
		
		this.addPaletteFunctions('pidCompressors', 'Proc. Eng. / Compressors', false,
		[
			this.createVertexTemplateEntry(s + 'ac_air_compressor', 100, 65, '', 'AC Air Compressor', null, null, this.getTagsForStencil(gn, 'ac_air_compressor', dt + '').join(' ')),
			this.createVertexTemplateEntry(s + 'centrifugal_compressor', 70, 70, '', 'Centrifugal Compressor', null, null, this.getTagsForStencil(gn, 'centrifugal_compressor', dt + '').join(' ')),
			this.createVertexTemplateEntry(mxConstants.STYLE_SHAPE + '=mxgraph.pid.compressors.centrifugal_compressor_-_turbine_driven;dashed=0;fontSize=8;html=1;overflow=fill;', 100, 70, 
				    '<table cellpadding="0" cellspacing="0" style="width:100%;height:100%;">' +
					'<tr style="height:25%;">' +
					'<td></td>' +
					'</tr>' +
					'<tr style="height:75%;">' +
					'<td align="left" style="padding-left:11%;width:100%">T</td>' +
					'</tr>' +
					'</table>',
					'Centrifugal Compressor - Turbine Driven', null, null, this.getTagsForStencil(gn, 'centrifugal_compressor_-_turbine_driven', dt + '').join(' ')),
			this.createVertexTemplateEntry(s + 'compressor', 100, 100, '', 'Compressor', null, null, this.getTagsForStencil(gn, 'compressor', dt + '').join(' ')),
			this.createVertexTemplateEntry(s + 'compressor_and_silencers;pointerEvents=1', 90, 80, '', 'Compressor and Silencers', null, null, this.getTagsForStencil(gn, 'compressor_and_silencers', dt + 'silencer').join(' ')),
			this.createVertexTemplateEntry(s + 'liquid_ring_compressor', 90, 90, '', 'Liquid Ring Compressor', null, null, this.getTagsForStencil(gn, 'liquid_ring_compressor', dt + '').join(' ')),
			this.createVertexTemplateEntry(s + 'reciprocating_compressor', 100, 40, '', 'Reciprocating Compressor', null, null, this.getTagsForStencil(gn, 'reciprocating_compressor', dt + '').join(' ')),
			this.createVertexTemplateEntry(s + 'reciprocating_compressor_2', 50, 65, '', 'Reciprocating Compressor 2', null, null, this.getTagsForStencil(gn, 'reciprocating_compressor_2', dt + '').join(' ')),
			this.createVertexTemplateEntry(s + 'rotary_compressor', 42, 91, '', 'Rotary Compressor', null, null, this.getTagsForStencil(gn, 'rotary_compressor', dt + '').join(' '))
		]);
	};
			
	Sidebar.prototype.addPidEnginesPalette = function()
	{
		var s = "dashed=0;outlineConnect=0;align=center;html=1;" + mxConstants.STYLE_SHAPE + "=mxgraph.pid.engines.";
		var sb = mxConstants.STYLE_VERTICAL_LABEL_POSITION + '=bottom;align=center;dashed=0;html=1;' + mxConstants.STYLE_VERTICAL_ALIGN + '=top;' + mxConstants.STYLE_SHAPE + "=mxgraph.pid.engines.";
		var gn = 'mxgraph.pid.engines';
		var dt = 'pid process instrumentation engine motor ';
		
		this.addPaletteFunctions('pidEngines', 'Proc. Eng. / Engines', false,
		[
			this.createVertexTemplateEntry(s + 'electric_motor;fontSize=45;', 100, 100, 'M', 'Electric Motor', null, null, this.getTagsForStencil(gn, 'electric_motor', dt).join(' ')),
			this.createVertexTemplateEntry(s + 'electric_motor_(ac);fontSize=45;', 100, 100, 'M', 'Electric Motor (AC)', null, null, this.getTagsForStencil(gn, 'electric_motor_(ac)', dt).join(' ')),
			this.createVertexTemplateEntry(s + 'electric_motor_(dc);fontSize=45;', 100, 100, 'M', 'Electric Motor (DC)', null, null, this.getTagsForStencil(gn, 'electric_motor_(dc)', dt).join(' ')),
			this.createVertexTemplateEntry(s + 'gear;fontSize=45;', 100, 100, 'G', 'Gear', null, null, this.getTagsForStencil(gn, 'gear', dt).join(' ')),
			this.createVertexTemplateEntry(s + 'generator;fontSize=45;', 100, 100, 'G', 'Generator', null, null, this.getTagsForStencil(gn, 'generator', dt).join(' ')),
			this.createVertexTemplateEntry(s + 'generator_(ac);fontSize=45;', 100, 100, 'G', 'Generator (AC)', null, null, this.getTagsForStencil(gn, 'generator_(ac)', dt).join(' ')),
			this.createVertexTemplateEntry(s + 'generator_(dc);fontSize=45;', 100, 100, 'G', 'Generator (DC)', null, null, this.getTagsForStencil(gn, 'generator_(dc)', dt).join(' ')),
			this.createVertexTemplateEntry(sb + 'turbine', 70, 100, '', 'Turbine', null, null, this.getTagsForStencil(gn, 'turbine', dt).join(' '))
		]);
	};
			
	Sidebar.prototype.addPidFiltersPalette = function()
	{
		var s = "html=1;dashed=0;outlineConnect=0;align=center;" + mxConstants.STYLE_SHAPE + "=mxgraph.pid.filters.";
		var sb = mxConstants.STYLE_VERTICAL_LABEL_POSITION + '=bottom;align=center;dashed=0;html=1;' + mxConstants.STYLE_VERTICAL_ALIGN + '=top;' + mxConstants.STYLE_SHAPE + "=mxgraph.pid.filters.";
		var gn = 'mxgraph.pid.filters';
		var dt = 'pid process instrumentation filter ';
		
		this.addPaletteFunctions('pidFilters', 'Proc. Eng. / Filters', false,
		[
			this.createVertexTemplateEntry(sb + 'filter;', 
					50, 50, '', 'Filter', null, null, this.getTagsForStencil(gn, 'filter', dt).join(' ')),
			this.createVertexTemplateEntry(sb + 'gas_filter;', 
					50, 100, '', 'Gas Filter', null, null, this.getTagsForStencil(gn, 'gas_filter', dt).join(' ')),
			this.createVertexTemplateEntry(sb + 'gas_filter_(bag,_candle,_cartridge);', 
					50, 100, '', 'Gas Filter (Bag, Candle, Cartridge)', null, null, this.getTagsForStencil(gn, 'gas_filter_(bag,_candle,_cartridge)', dt).join(' ')),
			this.createVertexTemplateEntry(sb + 'gas_filter_(belt,_roll);', 
					50, 100, '', 'Gas Filter (Belt, Roll)', null, null, this.getTagsForStencil(gn, 'gas_filter_(belt,_roll)', dt).join(' ')),
			this.createVertexTemplateEntry(sb + 'gas_filter_(fixed_bed);', 
					50, 100, '', 'Gas Filter (Fixed Bed)', null, null, this.getTagsForStencil(gn, 'gas_filter_(fixed_bed)', dt).join(' ')),
			this.createVertexTemplateEntry(s + 'gas_filter_(hepa);', 
					50, 100, 'HEPA', 'Gas Filter (HEPA)', null, null, this.getTagsForStencil(gn, 'gas_filter_(hepa)', dt).join(' ')),
			this.createVertexTemplateEntry(sb + 'liquid_filter;', 
					50, 100, '', 'Liquid Filter', null, null, this.getTagsForStencil(gn, 'liquid_filter', dt).join(' ')),
			this.createVertexTemplateEntry(sb + 'liquid_Filter_(bag,_candle,_cartridge);', 
					50, 100, '', 'Liquid Filter (Bag, Candle, Cartridge)', null, null, this.getTagsForStencil(gn, 'liquid_Filter_(bag,_candle,_cartridge)', dt).join(' ')),
			this.createVertexTemplateEntry(sb + 'liquid_filter_(belt,_roll);', 
					50, 100, '', 'Liquid Filter (Belt, Roll)', null, null, this.getTagsForStencil(gn, 'liquid_filter_(belt,_roll)', dt).join(' ')),
			this.createVertexTemplateEntry(s + 'liquid_filter_(biological);', 
					50, 100, 'BIO', 'Liquid Filter (Biological)', null, null, this.getTagsForStencil(gn, 'liquid_filter_(biological)', dt).join(' ')),
			this.createVertexTemplateEntry(sb + 'liquid_filter_(fixed_bed);', 
					50, 100, '', 'Liquid Filter (Fixed Bed)', null, null, this.getTagsForStencil(gn, 'liquid_filter_(fixed_bed)', dt).join(' ')),
			this.createVertexTemplateEntry(s + 'liquid_filter_(ion_exchanger);', 
					50, 100, 'ION', 'Liquid Filter (Ion Exchanger)', null, null, this.getTagsForStencil(gn, 'liquid_filter_(ion_exchanger)', dt).join(' ')),
			this.createVertexTemplateEntry(sb + 'liquid_filter_(rotary,_drum_or_disc);', 
					50, 100, '', 'Liquid Filter (Rotary, Drum or Disc)', null, null, this.getTagsForStencil(gn, 'liquid_filter_(rotary,_drum_or_disc)', dt).join(' ')),
			this.createVertexTemplateEntry(sb + 'liquid_filter_(rotary,_drum_or_disc,_scraper);', 
					55, 100, '', 'Liquid Filter (Rotary, Drum or Disc, Scraper)', null, null, this.getTagsForStencil(gn, 'liquid_filter_(rotary,_drum_or_disc,_scraper)', dt).join(' ')),
			this.createVertexTemplateEntry(sb + 'press_filter;', 
					100, 50, '', 'Press Filter', null, null, this.getTagsForStencil(gn, 'press_filter', dt).join(' ')),
			this.createVertexTemplateEntry(sb + 'suction_filter;', 
					50, 100, '', 'Suction Filter', null, null, this.getTagsForStencil(gn, 'suction_filter', dt).join(' '))
		]);
	};
			
	Sidebar.prototype.addPidFlowSensorsPalette = function()
	{
		var s = mxConstants.STYLE_VERTICAL_LABEL_POSITION + '=bottom;align=center;outlineConnect=0;dashed=0;html=1;' + mxConstants.STYLE_VERTICAL_ALIGN + '=top;' + mxConstants.STYLE_SHAPE + "=mxgraph.pid.flow_sensors.";
		var gn = 'mxgraph.pid.flow_sensors';
		var dt = 'process instrumentation sensor ';
		
		this.addPaletteFunctions('pidFlow Sensors', 'Proc. Eng. / Flow Sensors', false,
		[
			this.createVertexTemplateEntry(s + 'averging_pitot_tube;', 
					50, 50, '', 'Averging Pitot Tube', null, null, this.getTagsForStencil(gn, 'averging_pitot_tube', dt).join(' ')),
			this.createVertexTemplateEntry(s + 'coriolis;', 
					50, 50, '', 'Coriolis', null, null, this.getTagsForStencil(gn, 'coriolis', dt).join(' ')),
			this.createVertexTemplateEntry(s + 'flow_nozzle;', 
					50, 25, '', 'Flow Nozzle', null, null, this.getTagsForStencil(gn, 'flow_nozzle', dt).join(' ')),
			this.createVertexTemplateEntry(s + 'flume;pointerEvents=1;', 
					50, 50, '', 'Flume', null, null, this.getTagsForStencil(gn, 'flume', dt).join(' ')),
			this.createVertexTemplateEntry(mxConstants.STYLE_SHAPE + '=mxgraph.pid.flow_sensors.magnetic;dashed=0;align=center;html=1;fontSize=25;', 
					50, 50, 'M', 'Magnetic', null, null, this.getTagsForStencil(gn, 'magnetic', dt).join(' ')),
			this.createVertexTemplateEntry(s + 'pitot_tube;', 
					50, 50, '', 'Pitot Tube', null, null, this.getTagsForStencil(gn, 'pitot_tube', dt).join(' ')),
			this.createVertexTemplateEntry(s + 'positive_displacement;', 
					50, 30, '', 'Positive Displacement', null, null, this.getTagsForStencil(gn, 'positive_displacement', dt).join(' ')),
			this.createVertexTemplateEntry(s + 'rotameter;', 
					75, 50, '', 'Rotameter', null, null, this.getTagsForStencil(gn, 'rotameter', dt).join(' ')),
			this.createVertexTemplateEntry(s + 'target;', 
					50, 50, '', 'Target', null, null, this.getTagsForStencil(gn, 'target', dt).join(' ')),
			this.createVertexTemplateEntry(s + 'turbine;', 
					50, 50, '', 'Turbine', null, null, this.getTagsForStencil(gn, 'turbine', dt).join(' ')),
			this.createVertexTemplateEntry(s + 'ultrasonic;', 
					50, 50, '', 'Ultrasonic', null, null, this.getTagsForStencil(gn, 'ultrasonic', dt).join(' ')),
			this.createVertexTemplateEntry(s + 'v-cone;', 
					50, 50, '', 'V-cone', null, null, this.getTagsForStencil(gn, 'v-cone', dt).join(' ')),
			this.createVertexTemplateEntry(s + 'venturi;', 
					50, 40, '', 'Venturi', null, null, this.getTagsForStencil(gn, 'venturi', dt).join(' ')),
			this.createVertexTemplateEntry(s + 'vortex;', 
					50, 50, '', 'Vortex', null, null, this.getTagsForStencil(gn, 'vortex', dt).join(' ')),
			this.createVertexTemplateEntry(s + 'wedge;', 
					50, 50, '', 'Wedge', null, null, this.getTagsForStencil(gn, 'wedge', dt).join(' ')),
			this.createVertexTemplateEntry(s + 'weir;', 
					50, 50, '', 'Weir', null, null, this.getTagsForStencil(gn, 'weir', dt).join(' '))
		]);
	};
			
	Sidebar.prototype.addPidPipingPalette = function()
	{
		var s = "html=1;dashed=0;outlineConnect=0;align=center;" + mxConstants.STYLE_SHAPE + "=mxgraph.pid.piping.";
		var sb = mxConstants.STYLE_VERTICAL_LABEL_POSITION + '=bottom;align=center;dashed=0;html=1;' + mxConstants.STYLE_VERTICAL_ALIGN + '=top;' + mxConstants.STYLE_SHAPE + "=mxgraph.pid.piping.";
		var gn = 'mxgraph.pid.piping';
		var dt = 'process instrumentation piping ';
		
		this.addPaletteFunctions('pidPiping', 'Proc. Eng. / Piping', false,
		[
			this.createVertexTemplateEntry(sb + 'basket_strainer;', 50, 45, '', 'Basket Strainer', null, null, this.getTagsForStencil(gn, 'basket_strainer', dt).join(' ')),
			this.createVertexTemplateEntry(sb + 'blank;', 20, 60, '', 'Blank', null, null, this.getTagsForStencil(gn, 'blank', dt).join(' ')),
			this.createVertexTemplateEntry(sb + 'breather;', 50, 30, '', 'Breather', null, null, this.getTagsForStencil(gn, 'breather', dt).join(' ')),
			this.createVertexTemplateEntry(sb + 'cap;', 10, 20, '', 'Cap', null, null, this.getTagsForStencil(gn, 'cap', dt).join(' ')),
			this.createVertexTemplateEntry(sb + 'closed_figure_8_blind;', 20, 80, '', 'Closed Figure 8 Blind', null, null, this.getTagsForStencil(gn, 'closed_figure_8_blind', dt).join(' ')),
			this.createVertexTemplateEntry(sb + 'concentric_reducer;', 20, 20, '', 'Concentric Reducer', null, null, this.getTagsForStencil(gn, 'concentric_reducer', dt).join(' ')),
			this.createVertexTemplateEntry(sb + 'cone_strainer;', 30, 30, '', 'Cone Strainer', null, null, this.getTagsForStencil(gn, 'cone_strainer', dt).join(' ')),
			this.createVertexTemplateEntry(sb + 'damper;', 50, 20, '', 'Damper', null, null, this.getTagsForStencil(gn, 'damper', dt).join(' ')),
			this.createVertexTemplateEntry(s + 'desuper_heater;', 50, 50, 'DS', 'Desuper Heater', null, null, this.getTagsForStencil(gn, 'desuper_heater', dt).join(' ')),
			this.createVertexTemplateEntry(s + 'detonation_arrestor;', 50, 20, 'D', 'Detonation Arrestor', null, null, this.getTagsForStencil(gn, 'detonation_arrestor', dt).join(' ')),
			this.createVertexTemplateEntry(sb + 'diverter_valve;pointerEvents=1;', 50, 35, '', 'Diverter Valve', null, null, this.getTagsForStencil(gn, 'diverter_valve', dt).join(' ')),
			this.createVertexTemplateEntry(sb + 'double_flange;pointerEvents=1;', 5, 20, '', 'Double Flange', null, null, this.getTagsForStencil(gn, 'double_flange', dt).join(' ')),
			this.createVertexTemplateEntry(sb + 'duplex_strainer;', 50, 40, '', 'Duplex Strainer', null, null, this.getTagsForStencil(gn, 'duplex_strainer', dt).join(' ')),
			this.createVertexTemplateEntry(sb + 'eccentric_reducer;', 20, 15, '', 'Eccentric Reducer', null, null, this.getTagsForStencil(gn, 'eccentric_reducer', dt).join(' ')),
			this.createVertexTemplateEntry(sb + 'excess_flow_valve;', 50, 25, '', 'Excess Flow Valve', null, null, this.getTagsForStencil(gn, 'excess_flow_valve', dt).join(' ')),
			this.createVertexTemplateEntry(sb + 'exhaust_head;', 50, 40, '', 'Exhaust Head', null, null, this.getTagsForStencil(gn, 'exhaust_head', dt).join(' ')),
			this.createVertexTemplateEntry(sb + 'expansion_joint;', 50, 20, '', 'Expansion Joint', null, null, this.getTagsForStencil(gn, 'expansion_joint', dt).join(' ')),
			this.createVertexTemplateEntry(s + 'flame_arrestor;', 50, 20, 'F', 'Flame Arrestor', null, null, this.getTagsForStencil(gn, 'flame_arrestor', dt).join(' ')),
			this.createVertexTemplateEntry(sb + 'flange;pointerEvents=1;', 5, 20, '', 'Flange', null, null, this.getTagsForStencil(gn, 'flange', dt).join(' ')),
			this.createVertexTemplateEntry(sb + 'flange_in;pointerEvents=1;', 10, 20, '', 'Flange In', null, null, this.getTagsForStencil(gn, 'flange_in', dt).join(' ')),
			this.createVertexTemplateEntry(sb + 'flexible_hose;pointerEvents=1;', 50, 25, '', 'Flexible Hose', null, null, this.getTagsForStencil(gn, 'flexible_hose', dt).join(' ')),
			this.createVertexTemplateEntry(sb + 'hose_connection;pointerEvents=1;', 20, 20, '', 'Hose Connection', null, null, this.getTagsForStencil(gn, 'hose_connection', dt).join(' ')),
			this.createVertexTemplateEntry(sb + 'in-line_mixer;', 50, 10, '', 'In-Line Mixer', null, null, this.getTagsForStencil(gn, 'in-line_mixer', dt).join(' ')),
			this.createVertexTemplateEntry(s + 'in-line_silencer;', 50, 20, 'S', 'In-Line Silencer', null, null, this.getTagsForStencil(gn, 'in-line_silencer', dt).join(' ')),
			this.createVertexTemplateEntry(sb + 'open_figure_8_blind;', 20, 80, '', 'Open Figure 8 Blind', null, null, this.getTagsForStencil(gn, 'open_figure_8_blind', dt).join(' ')),
			this.createVertexTemplateEntry(sb + 'orifice_(quick_change);', 10, 50, '', 'Orifice (Quick Change)', null, null, this.getTagsForStencil(gn, 'orifice_(quick_change)', dt).join(' ')),
			this.createVertexTemplateEntry(sb + 'plug;', 10, 10, '', 'Plug', null, null, this.getTagsForStencil(gn, 'plug', dt).join(' ')),
			this.createVertexTemplateEntry(sb + 'pulsation_dampener;', 50, 150, '', 'Pulsation Dampener', null, null, this.getTagsForStencil(gn, 'pulsation_dampener', dt).join(' ')),
			this.createVertexTemplateEntry(mxConstants.STYLE_VERTICAL_ALIGN + '=bottom;pointerEvents=1;dashed=0;' + mxConstants.STYLE_SHAPE + '=mxgraph.pid.piping.removable_spool;html=1;overflow=fill;', 50, 30, 
					'<table cellpadding="0" cellspacing="0" style="width:100%;height:100%;">' +
					'<tr>' +
					'<td valign="bottom" align="center">RS</td>' +
					'</tr>' +
					'</table>',
					'Removable Spool', null, null, this.getTagsForStencil(gn, 'removable_spool', dt).join(' ')),
			this.createVertexTemplateEntry(sb + 'rotary_valve;pointerEvents=1;', 50, 20, '', 'Rotary Valve', null, null, this.getTagsForStencil(gn, 'rotary_valve', dt).join(' ')),
			this.createVertexTemplateEntry(sb + 'spacer;', 20, 60, '', 'Spacer', null, null, this.getTagsForStencil(gn, 'spacer', dt).join(' ')),
			this.createVertexTemplateEntry(s + 'steam_trap;', 50, 50, 'T', 'Steam Trap', null, null, this.getTagsForStencil(gn, 'steam_trap', dt).join(' ')),
			this.createVertexTemplateEntry(sb + 't-type_strainer;', 20, 35, '', 'T-Type Strainer', null, null, this.getTagsForStencil(gn, 't-type_strainer', dt).join(' ')),
			this.createVertexTemplateEntry(sb + 'temporary_strainer;', 30, 30, '', 'Temporary Strainer', null, null, this.getTagsForStencil(gn, 'temporary_strainer', dt).join(' ')),
			this.createVertexTemplateEntry(s + 'vent_silencer;', 20, 80, 'S', 'Vent Silencer', null, null, this.getTagsForStencil(gn, 'vent_silencer', dt).join(' ')),
			this.createVertexTemplateEntry(sb + 'welded_connection;', 50, 20, '', 'Welded Connection', null, null, this.getTagsForStencil(gn, 'welded_connection', dt).join(' ')),
			this.createVertexTemplateEntry(sb + 'y-type_strainer;pointerEvents=1;', 50, 35, '', 'Y-Type Strainer', null, null, this.getTagsForStencil(gn, 'y-type_strainer', dt).join(' '))
		]);
	};
			
	Sidebar.prototype.addPidMiscPalette = function()
	{
		var s = mxConstants.STYLE_VERTICAL_LABEL_POSITION + '=bottom;outlineConnect=0;align=center;dashed=0;html=1;' + mxConstants.STYLE_VERTICAL_ALIGN + '=top;' + mxConstants.STYLE_SHAPE + "=mxgraph.pid2";
		var s2 = mxConstants.STYLE_VERTICAL_LABEL_POSITION + '=bottom;outlineConnect=0;align=center;dashed=0;html=1;' + mxConstants.STYLE_VERTICAL_ALIGN + '=top;' + mxConstants.STYLE_SHAPE + "=mxgraph.pid.misc.";
		var gn = 'mxgraph.pid.misc';
		var dt = 'process instrumentation ';
		
		this.addPaletteFunctions('pidMisc', 'Proc. Eng. / Misc', false,
		[
			this.createVertexTemplateEntry(s + 'misc.fan;fanType=common', 
					50, 50, '', 'Fan', null, null, this.getTagsForStencil(gn, 'fan', dt).join(' ')),
			this.createVertexTemplateEntry(s + 'misc.column;columnType=common', 
					50, 120, '', 'Column', null, null, this.getTagsForStencil(gn, 'column', dt).join(' ')),
			this.createVertexTemplateEntry(s + 'misc.column;columnType=tray', 
					50, 120, '', 'Column (Tray)', null, null, this.getTagsForStencil(gn, 'column', dt + 'tray').join(' ')),
			this.createVertexTemplateEntry(s + 'misc.column;columnType=fixed', 
					50, 180, '', 'Column (Fixed Bed)', null, null, this.getTagsForStencil(gn, 'column', dt + 'fixed bed').join(' ')),
			this.createVertexTemplateEntry(s + 'misc.column;columnType=fluid', 
					50, 120, '', 'Column (Fluidized Bed)', null, null, this.getTagsForStencil(gn, 'column', dt + 'fluidized bed').join(' ')),
			this.createVertexTemplateEntry(s + 'misc.column;columnType=baffle', 
					50, 120, '', 'Column (Staggered Baffle Trays)', null, null, this.getTagsForStencil(gn, 'column', dt + 'staggered baffle tray').join(' ')),
			this.createVertexTemplateEntry(s + 'misc.column;columnType=bubble', 
					50, 120, '', 'Column (Bubble Cap Trays)', null, null, this.getTagsForStencil(gn, 'column', dt + 'bubble cap tray').join(' ')),
			this.createVertexTemplateEntry(s + 'misc.column;columnType=valve', 
					50, 120, '', 'Column (Valve Trays)', null, null, this.getTagsForStencil(gn, 'column', dt + 'valve tray').join(' ')),
			this.createVertexTemplateEntry(s + 'misc.column;columnType=nozzle', 
					50, 180, '', 'Column (Fixed Bed, Spray Nozzle)', null, null, this.getTagsForStencil(gn, 'column', dt + 'fixed bed spray nozzle').join(' ')),
			this.createVertexTemplateEntry(s + 'misc.conveyor', 
					200, 50, '', 'Conveyor', null, null, this.getTagsForStencil(gn, 'conveyor', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'aerator_with_sparger;', 
					35, 100, '', 'Aerator With Sparger', null, null, this.getTagsForStencil(gn, 'aerator_with_sparger', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'air_cooler;', 
					70, 20, '', 'Air Cooler', null, null, this.getTagsForStencil(gn, 'air_cooler', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'air_filter;', 
					40, 65, '', 'Air Filter', null, null, this.getTagsForStencil(gn, 'air_filter', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'air_separator;', 
					65.5, 106, '', 'Air Separator', null, null, this.getTagsForStencil(gn, 'air_separator', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'back_draft_damper;', 
					62, 32, '', 'Back Draft Damper', null, null, this.getTagsForStencil(gn, 'back_draft_damper', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'bag_filling_machine;', 
					80, 100, '', 'Bag Filling Machine', null, null, this.getTagsForStencil(gn, 'bag_filling_machine', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'belt_skimmer;', 
					70, 98, '', 'Belt Skimmer', null, null, this.getTagsForStencil(gn, 'belt_skimmer', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'bin;', 
					100, 65, '', 'Bin', null, null, this.getTagsForStencil(gn, 'bin', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'boiler_(dome);', 
					100, 120, '', 'Boiler (Dome)', null, null, this.getTagsForStencil(gn, 'boiler_(dome)', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'boiler_(dome,_hot_liquid);', 
					100, 120, '', 'Boiler (Dome, Hot Liquid)', null, null, this.getTagsForStencil(gn, 'boiler_(dome,_hot_liquid)', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'box_truck;', 
					120, 80, '', 'Box Truck', null, null, this.getTagsForStencil(gn, 'box_truck', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'bucket_elevator;', 
					65, 200, '', 'Bucket Elevator', null, null, this.getTagsForStencil(gn, 'bucket_elevator', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'chiller;', 
					155, 115, '', 'Chiller', null, null, this.getTagsForStencil(gn, 'chiller', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'combustion_chamber;', 
					130, 100, '', 'Combustion Chamber', null, null, this.getTagsForStencil(gn, 'combustion_chamber', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'conveyor;', 
					200, 60, '', 'Conveyor', null, null, this.getTagsForStencil(gn, 'conveyor', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'conveyor_(belt);', 
					200, 50, '', 'Conveyor (Belt)', null, null, this.getTagsForStencil(gn, 'conveyor_(belt)', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'conveyor_(belt,_closed);', 
					240, 80, '', 'Conveyor (Belt, Closed)', null, null, this.getTagsForStencil(gn, 'conveyor_(belt,_closed)', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'conveyor_(belt,_closed,_reversible);', 
					240, 80, '', 'Conveyor (Belt, Closed, Reversible)', null, null, this.getTagsForStencil(gn, 'conveyor_(belt,_closed,_reversible)', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'conveyor_(chain,_closed);', 
					240, 80, '', 'Conveyor (Chain, Closed)', null, null, this.getTagsForStencil(gn, 'conveyor_(chain,_closed)', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'conveyor_(screw,_closed);', 
					220, 80, '', 'Conveyor (Screw, Closed)', null, null, this.getTagsForStencil(gn, 'conveyor_(screw,_closed)', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'conveyor_(vibrating,_closed);', 
					240, 80, '', 'Conveyor (Vibrating, Closed)', null, null, this.getTagsForStencil(gn, 'conveyor_(vibrating,_closed)', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'cooler;', 
					85, 90, '', 'Cooler', null, null, this.getTagsForStencil(gn, 'cooler', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'cooling_tower', 
					100, 120, '', 'Cooling Tower', null, null, this.getTagsForStencil(gn, 'cooling_tower', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'cooling_tower_(dry,_forced_draught);', 
					100, 120, '', 'Cooling Tower (Dry, Forced Draught)', null, null, this.getTagsForStencil(gn, 'cooling_tower_(dry,_forced_draught)', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'cooling_tower_(dry,_induced_draught);', 
					100, 120, '', 'Cooling Tower (Dry, Induced Draught)', null, null, this.getTagsForStencil(gn, 'cooling_tower_(dry,_induced_draught)', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'cooling_tower_(dry,_natural_draught);', 
					100, 120, '', 'Cooling Tower (Dry, Natural Draught)', null, null, this.getTagsForStencil(gn, 'cooling_tower_(dry,_natural_draught)', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'cooling_tower_(wet,_forced_draught);', 
					100, 120, '', 'Cooling Tower (Wet, Forced Draught)', null, null, this.getTagsForStencil(gn, 'cooling_tower_(wet,_forced_draught)', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'cooling_tower_(wet,_induced_draught);', 
					100, 120, '', 'Cooling Tower (Wet, Induced Draught)', null, null, this.getTagsForStencil(gn, 'cooling_tower_(wet,_induced_draught)', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'cooling_tower_(wet,_natural_draught);', 
					100, 120, '', 'Cooling Tower (Wet, Natural Draught)', null, null, this.getTagsForStencil(gn, 'cooling_tower_(wet,_natural_draught)', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'cooling_tower_(wet-dry,_natural_draught);', 
					100, 120, '', 'Cooling Tower (Wet-Dry, Natural Draught)', null, null, this.getTagsForStencil(gn, 'cooling_tower_(wet-dry,_natural_draught)', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'covered_gas_vent;pointerEvents=1;', 
					80, 100, '', 'Covered Gas Vent', null, null, this.getTagsForStencil(gn, 'covered_gas_vent', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'crane;', 
					100, 100, '', 'Crane', null, null, this.getTagsForStencil(gn, 'crane', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'curved_gas_vent;pointerEvents=1;', 
					30, 70, '', 'Curved Gas Vent', null, null, this.getTagsForStencil(gn, 'curved_gas_vent', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'cyclone;', 
					100, 80, '', 'Cyclone', null, null, this.getTagsForStencil(gn, 'cyclone', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'dryer;', 
					80, 100, '', 'Dryer', null, null, this.getTagsForStencil(gn, 'dryer', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'elevator_(bucket);', 
					160, 250, '', 'Elevator (Bucket)', null, null, this.getTagsForStencil(gn, 'elevator_(bucket)', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'elevator_(bucket,_z-form);', 
					430, 250, '', 'Elevator (Bucket, Z-Form)', null, null, this.getTagsForStencil(gn, 'elevator_(bucket,_z-form)', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'fan;', 
					100, 100, '', 'Fan', null, null, this.getTagsForStencil(gn, 'fan', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'fan_2;', 
					58, 8, '', 'Fan 2', null, null, this.getTagsForStencil(gn, 'fan_2', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'filter;', 
					100, 100, '', 'Filter', null, null, this.getTagsForStencil(gn, 'filter', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'filter_2;', 
					100, 100, '', 'Filter 2', null, null, this.getTagsForStencil(gn, 'filter_2', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'firing_system,_burner;', 
					100, 100, '', 'Firing System, Burner', null, null, this.getTagsForStencil(gn, 'firing_system,_burner', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'flame_arrestor;', 
					100, 40, '', 'Flame Arrestor', null, null, this.getTagsForStencil(gn, 'flame_arrestor', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'flexible_pipe;pointerEvents=1;', 
					60, 16, '', 'Flexible Pipe', null, null, this.getTagsForStencil(gn, 'flexible_pipe', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'forced_flow_air_cooler;', 
					70, 30, '', 'Forced Flow Air Cooler', null, null, this.getTagsForStencil(gn, 'forced_flow_air_cooler', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'forklift_(manual);', 
					140, 100, '', 'Forklift (Manual)', null, null, this.getTagsForStencil(gn, 'forklift_(manual)', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'forklift_(truck);', 
					140, 100, '', 'Forklift (Truck)', null, null, this.getTagsForStencil(gn, 'forklift_(truck)', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'funnel;pointerEvents=1;', 
					40, 80, '', 'Funnel', null, null, this.getTagsForStencil(gn, 'funnel', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'gas_flare;', 
					60, 100, '', 'Gas Flare', null, null, this.getTagsForStencil(gn, 'gas_flare', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'induced_flow_air_cooler;', 
					93, 30, '', 'Induced Flow Air Cooler', null, null, this.getTagsForStencil(gn, 'induced_flow_air_cooler', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'industrial_truck;pointerEvents=1;', 
					120, 20, '', 'Industrial Truck', null, null, this.getTagsForStencil(gn, 'industrial_truck', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'lift;', 
					100, 100, '', 'Lift', null, null, this.getTagsForStencil(gn, 'lift', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'loading_arm;pointerEvents=1;', 
					120, 80, '', 'Loading Arm', null, null, this.getTagsForStencil(gn, 'loading_arm', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'mixer;', 
					80, 100, '', 'Mixer', null, null, this.getTagsForStencil(gn, 'mixer', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'palletizer;', 
					80, 100, '', 'Palletizer', null, null, this.getTagsForStencil(gn, 'palletizer', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'protective_palette_covering;', 
					80, 100, '', 'Protective Palette Covering', null, null, this.getTagsForStencil(gn, 'protective_palette_covering', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'roller_conveyor;', 
					160, 20, '', 'Roller Conveyor', null, null, this.getTagsForStencil(gn, 'roller_conveyor', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'rolling_bin;', 
					100, 65, '', 'Rolling Bin', null, null, this.getTagsForStencil(gn, 'rolling_bin', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'rotary_screen;', 
					100, 65, '', 'Rotary Screen', null, null, this.getTagsForStencil(gn, 'rotary_screen', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'screening_device,_sieve,_strainer;', 
					80, 120, '', 'Screening Device, Sieve, Strainer', null, null, this.getTagsForStencil(gn, 'screening_device,_sieve,_strainer', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'screening_device,_sieve,_strainer_(basket_reel);', 
					80, 180, '', 'Screening Device, Sieve, Strainer (Basket Reel)', null, null, this.getTagsForStencil(gn, 'screening_device,_sieve,_strainer_(basket_reel)', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'screening_device,_sieve,_strainer_(coarse_and_fine_screens);', 
					80, 120, '', 'Screening Device, Sieve, Strainer (Coarse and Fine Screens)', null, null, this.getTagsForStencil(gn, 'screening_device,_sieve,_strainer_(coarse_and_fine_screens)', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'screening_device,_sieve,_strainer_(coarse_rake);', 
					80, 120, '', 'Screening Device, Sieve, Strainer (Coarse Rake)', null, null, this.getTagsForStencil(gn, 'screening_device,_sieve,_strainer_(coarse_rake)', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'screening_device,_sieve,_strainer_(fine_rake);', 
					80, 120, '', 'Screening Device, Sieve, Strainer (Fine Rake)', null, null, this.getTagsForStencil(gn, 'screening_device,_sieve,_strainer_(fine_rake)', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'screening_device,_sieve,_strainer_(rotating_drum)', 
					80, 120, '', 'Screening Device, Sieve, Strainer (Rotating Drum)', null, null, this.getTagsForStencil(gn, 'screening_device,_sieve,_strainer_(rotating_drum)', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'screening_device,_sieve,_strainer_(vibrating);', 
					80, 120, '', 'Screening Device, Sieve, Strainer (Vibrating)', null, null, this.getTagsForStencil(gn, 'screening_device,_sieve,_strainer_(vibrating)', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'ship', 
					105, 60, '', 'Ship', null, null, this.getTagsForStencil(gn, 'ship', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'silencer;', 
					100, 30, '', 'Silencer', null, null, this.getTagsForStencil(gn, 'silencer', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'spraying_device;pointerEvents=1;', 
					60, 20, '', 'Spraying Device', null, null, this.getTagsForStencil(gn, 'spraying_device', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'spray_cooler;', 
					100, 120, '', 'Spray Cooler', null, null, this.getTagsForStencil(gn, 'spray_cooler', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'stack,_chimney;', 
					60, 100, '', 'Stack, Chimney', null, null, this.getTagsForStencil(gn, 'stack,_chimney', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'steam_trap;', 
					53, 53, '', 'Steam Trap', null, null, this.getTagsForStencil(gn, 'steam_trap', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'tank_car,_tank_wagon;', 
					127, 80, '', 'Tank Car, Tank Wagon', null, null, this.getTagsForStencil(gn, 'tank_car,_tank_wagon', dt).join(' ')),
			this.createVertexTemplateEntry(s2 + 'viewing_glass;', 
					80, 50, '', 'Viewing Glass', null, null, this.getTagsForStencil(gn, 'viewing_glass', dt).join(' '))
		]);
	};
	
})();

/**
 * mxJsCanvas
 *
 * Open Issues:
 *
 * - Canvas has no built-in dash-pattern for strokes
 *   - Use AS code for straight lines
 * - Must use proxy for cross domain images
 * - Use html2canvas for HTML rendering (Replaces complete page with
 *   canvas currently, needs API call to render elt to canvas)
 */

/**
 * Extends mxAbstractCanvas2D
 */
function mxJsCanvas(canvas) {
    mxAbstractCanvas2D.call(this);

    this.ctx = canvas.getContext('2d');
    this.ctx.textBaseline = 'top';
    this.ctx.fillStyle = 'rgba(255,255,255,0)';
    this.ctx.strokeStyle = 'rgba(0, 0, 0, 0)';

    //this.ctx.translate(0.5, 0.5);

    this.M_RAD_PER_DEG = Math.PI / 180;

    this.images = this.images == null ? [] : this.images;
    this.subCanvas = this.subCanvas == null ? [] : this.subCanvas;
};

/**
 * Extends mxAbstractCanvas2D
 */
mxUtils.extend(mxJsCanvas, mxAbstractCanvas2D);

/**
 * Variable: ctx
 *
 * Holds the current canvas context
 */
mxJsCanvas.prototype.ctx = null;

/**
 * Variable: ctx
 *
 * Holds the current canvas context
 */
mxJsCanvas.prototype.waitCounter = 0;

/**
 * Variable: ctx
 *
 * Holds the current canvas context
 */
mxJsCanvas.prototype.onComplete = null;

/**
 * Variable: images
 *
 * Ordered array of images used in this canvas
 */
mxJsCanvas.prototype.images = null;

/**
 * Variable: subCanvas
 *
 * Ordered array of sub canvas elements in this canvas
 */
mxJsCanvas.prototype.subCanvas = null;

/**
 * Variable: canvasIndex
 *
 * The current index into the canvas sub-canvas array being processed
 */
mxJsCanvas.prototype.canvasIndex = 0;

mxJsCanvas.prototype.hexToRgb = function (hex) {
    // Expand shorthand form (e.g. "03F") to full form (e.g. "0033FF")
    var shorthandRegex = /^#?([a-f\d])([a-f\d])([a-f\d])$/i;
    hex = hex.replace(shorthandRegex, function (m, r, g, b) {
        return r + r + g + g + b + b;
    });

    var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
    return result ? {
        r: parseInt(result[1], 16),
        g: parseInt(result[2], 16),
        b: parseInt(result[3], 16)
    } : null;
};

mxJsCanvas.prototype.incWaitCounter = function () {
    this.waitCounter++;
};

mxJsCanvas.prototype.decWaitCounter = function () {
    this.waitCounter--;

    if (this.waitCounter == 0 && this.onComplete != null) {
        this.onComplete();
        this.onComplete = null;
    }
};

mxJsCanvas.prototype.updateFont = function () {
    var style = '';

    if ((this.state.fontStyle & mxConstants.FONT_BOLD) == mxConstants.FONT_BOLD) {
        style += 'bold ';
    }

    if ((this.state.fontStyle & mxConstants.FONT_ITALIC) == mxConstants.FONT_ITALIC) {
        style += 'italic ';
    }

    this.ctx.font = style + this.state.fontSize + 'px ' + this.state.fontFamily;
};

mxJsCanvas.prototype.save = function () {
    this.states.push(this.state);
    this.state = mxUtils.clone(this.state);
    this.ctx.save();
};

mxJsCanvas.prototype.restore = function () {
    this.state = this.states.pop();
    this.ctx.restore();
};

mxJsCanvas.prototype.scale = function (s) {
    this.state.scale *= s;
    this.state.strokeWidth *= s;
    this.ctx.scale(s, s);
};

mxJsCanvas.prototype.translate = function (dx, dy) {
    this.state.dx += dx;
    this.state.dy += dy;
    this.ctx.translate(dx, dy);
};

mxJsCanvas.prototype.rotate = function (theta, flipH, flipV, cx, cy) {
    // This is a special case where the rotation center is scaled so dx/dy,
    // which are also scaled, must be applied after scaling the center.
    cx -= this.state.dx;
    cy -= this.state.dy;

    this.ctx.translate(cx, cy);

    if (flipH || flipV) {
        var sx = (flipH) ? -1 : 1;
        var sy = (flipV) ? -1 : 1;

        this.ctx.scale(sx, sy);
    }

    this.ctx.rotate(theta * this.M_RAD_PER_DEG);
    this.ctx.translate(-cx, -cy);
};

mxJsCanvas.prototype.setAlpha = function (alpha) {
    this.state.alpha = alpha;
    this.ctx.globalAlpha = alpha;
};

/**
 * Function: setFillColor
 *
 * Sets the current fill color.
 */
mxJsCanvas.prototype.setFillColor = function (value) {
    if (value == mxConstants.NONE) {
        value = null;
    }

    this.state.fillColor = value;
    this.state.gradientColor = null;
    this.ctx.fillStyle = value;
};

mxJsCanvas.prototype.setGradient = function (color1, color2, x, y, w, h, direction, alpha1, alpha2) {
    var gradient = this.ctx.createLinearGradient(0, y, 0, y + h);

    var s = this.state;
    s.fillColor = color1;
    s.fillAlpha = (alpha1 != null) ? alpha1 : 1;
    s.gradientColor = color2;
    s.gradientAlpha = (alpha2 != null) ? alpha2 : 1;
    s.gradientDirection = direction;

    var rgb1 = this.hexToRgb(color1);
    var rgb2 = this.hexToRgb(color2);

    if (rgb1 != null) {
        gradient.addColorStop(0, 'rgba(' + rgb1.r + ',' + rgb1.g + ',' + rgb1.b + ',' + s.fillAlpha + ')');
    }

    if (rgb2 != null) {
        gradient.addColorStop(1, 'rgba(' + rgb2.r + ',' + rgb2.g + ',' + rgb2.b + ',' + s.gradientAlpha + ')');
    }

    this.ctx.fillStyle = gradient;
};

mxJsCanvas.prototype.setStrokeColor = function (value) {
    if (value == null) {
        // null value ignored
    } else if (value == mxConstants.NONE) {
        this.state.strokeColor = null;
        this.ctx.strokeStyle = 'rgba(0, 0, 0, 0)';
    } else {
        this.ctx.strokeStyle = value;
        this.state.strokeColor = value;
    }
};

mxJsCanvas.prototype.setStrokeWidth = function (value) {
    this.ctx.lineWidth = value;
};

mxJsCanvas.prototype.setDashed = function (value) {
    this.state.dashed = value;

    if (value) {
        var dashArray = this.state.dashPattern.split(" ");

        for (var i = 0; i < dashArray.length; i++) {
            dashArray[i] = parseInt(dashArray[i], 10);
        }

        this.setLineDash(dashArray);
    } else {
        this.setLineDash([0]);
    }
};

mxJsCanvas.prototype.setLineDash = function (value) {
    try {
        if (typeof this.ctx.setLineDash === "function") {
            this.ctx.setLineDash(value);
        } else {
            // Line dash not supported IE 10-
        }
    } catch (e) {
        // ignore
    }
};

mxJsCanvas.prototype.setDashPattern = function (value) {
    this.state.dashPattern = value;

    if (this.state.dashed) {
        var dashArray = value.split(" ");

        for (var i = 0; i < dashArray.length; i++) {
            dashArray[i] = parseInt(dashArray[i], 10);
        }

        this.ctx.setLineDash(dashArray);
    }
};

mxJsCanvas.prototype.setLineCap = function (value) {
    this.ctx.lineCap = value;
};

mxJsCanvas.prototype.setLineJoin = function (value) {
    this.ctx.lineJoin = value;
};

mxJsCanvas.prototype.setMiterLimit = function (value) {
    this.ctx.lineJoin = value;
};

mxJsCanvas.prototype.setFontColor = function (value) {
    this.ctx.fillStyle = value;
};

mxJsCanvas.prototype.setFontBackgroundColor = function (value) {
    if (value == mxConstants.NONE) {
        value = null;
    }

    this.state.fontBackgroundColor = value;
};

mxJsCanvas.prototype.setFontBorderColor = function (value) {
    if (value == mxConstants.NONE) {
        value = null;
    }

    this.state.fontBorderColor = value;
};

mxJsCanvas.prototype.setFontSize = function (value) {
    this.state.fontSize = value;
};

mxJsCanvas.prototype.setFontFamily = function (value) {
    this.state.fontFamily = value;
};

mxJsCanvas.prototype.setFontStyle = function (value) {
    this.state.fontStyle = value;
};

/**
 * Function: setShadow
 *
 * Enables or disables and configures the current shadow.
 */
mxJsCanvas.prototype.setShadow = function (enabled) {
    this.state.shadow = enabled;

    if (enabled) {
        this.setShadowOffset(this.state.shadowDx, this.state.shadowDy);
        this.setShadowAlpha(this.state.shadowAlpha);
    } else {
        this.ctx.shadowColor = 'transparent';
        this.ctx.shadowBlur = 0;
        this.ctx.shadowOffsetX = 0;
        this.ctx.shadowOffsetY = 0;
    }
};

/**
 * Function: setShadowColor
 *
 * Enables or disables and configures the current shadow.
 */
mxJsCanvas.prototype.setShadowColor = function (value) {
    if (value == null || value == mxConstants.NONE) {
        value = null;
        this.ctx.shadowColor = 'transparent';
    }

    this.state.shadowColor = value;

    if (this.state.shadow && value != null) {
        var alpha = (this.state.shadowAlpha != null) ? this.state.shadowAlpha : 1;
        var rgb = this.hexToRgb(value);

        this.ctx.shadowColor = 'rgba(' + rgb.r + ',' + rgb.g + ',' + rgb.b + ',' + alpha + ')';
    }
};

/**
 * Function: setShadowAlpha
 *
 * Enables or disables and configures the current shadow.
 */
mxJsCanvas.prototype.setShadowAlpha = function (value) {
    this.state.shadowAlpha = value;
    this.setShadowColor(this.state.shadowColor);
};

/**
 * Function: setShadowOffset
 *
 * Enables or disables and configures the current shadow.
 */

mxJsCanvas.prototype.setShadowOffset = function (dx, dy) {
    this.state.shadowDx = dx;
    this.state.shadowDy = dy;

    if (this.state.shadow) {
        this.ctx.shadowOffsetX = dx;
        this.ctx.shadowOffsetY = dy;
    }
};

mxJsCanvas.prototype.moveTo = function (x, y) {
    this.ctx.moveTo(x, y);
    this.lastMoveX = x;
    this.lastMoveY = y;
};

mxJsCanvas.prototype.lineTo = function (x, y) {
    this.ctx.lineTo(x, y);
    this.lastMoveX = x;
    this.lastMoveY = y;
};

mxJsCanvas.prototype.quadTo = function (x1, y1, x2, y2) {
    this.ctx.quadraticCurveTo(x1, y1, x2, y2);
    this.lastMoveX = x2;
    this.lastMoveY = y2;
};

mxJsCanvas.prototype.arcTo = function (rx, ry, angle, largeArcFlag, sweepFlag, x, y) {
    var curves = mxUtils.arcToCurves(this.lastMoveX, this.lastMoveY, rx, ry, angle, largeArcFlag, sweepFlag, x, y);

    if (curves != null) {
        for (var i = 0; i < curves.length; i += 6) {
            this.curveTo(curves[i], curves[i + 1], curves[i + 2],
                curves[i + 3], curves[i + 4], curves[i + 5]);
        }
    }
};

mxJsCanvas.prototype.curveTo = function (x1, y1, x2, y2, x3, y3) {
    this.ctx.bezierCurveTo(x1, y1, x2, y2, x3, y3);
    this.lastMoveX = x3;
    this.lastMoveY = y3;
};

mxJsCanvas.prototype.rect = function (x, y, w, h) {
    // TODO: Check if fillRect/strokeRect is faster
    this.begin();
    this.moveTo(x, y);
    this.lineTo(x + w, y);
    this.lineTo(x + w, y + h);
    this.lineTo(x, y + h);
    this.close();
};

mxJsCanvas.prototype.roundrect = function (x, y, w, h, dx, dy) {
    this.begin();
    this.moveTo(x + dx, y);
    this.lineTo(x + w - dx, y);
    this.quadTo(x + w, y, x + w, y + dy);
    this.lineTo(x + w, y + h - dy);
    this.quadTo(x + w, y + h, x + w - dx, y + h);
    this.lineTo(x + dx, y + h);
    this.quadTo(x, y + h, x, y + h - dy);
    this.lineTo(x, y + dy);
    this.quadTo(x, y, x + dx, y);
};

mxJsCanvas.prototype.ellipse = function (x, y, w, h) {
    this.ctx.save();
    this.ctx.translate((x + w / 2), (y + h / 2));
    this.ctx.scale(w / 2, h / 2);
    this.ctx.beginPath();
    this.ctx.arc(0, 0, 1, 0, 2 * Math.PI, false);
    this.ctx.restore();
};

//Redirect can be implemented via a hook
mxJsCanvas.prototype.rewriteImageSource = function (src) {
    if (src.substring(0, 7) == 'http://' || src.substring(0, 8) == 'https://') {
        src = '/proxy?url=' + encodeURIComponent(src);
    }

    return src;
};

mxJsCanvas.prototype.image = function (x, y, w, h, src, aspect, flipH, flipV) {
    var scale = this.state.scale;

//	x = this.state.tx + x / scale;
//	y = this.state.ty + y / scale;
//	w /= scale;
//	h /= scale;

    src = this.rewriteImageSource(src);
    var image = this.images[src];

    function drawImage(ctx, image, x, y, w, h) {
        ctx.save();

        if (aspect) {
            var iw = image.width;
            var ih = image.height;

            var s = Math.min(w / iw, h / ih);
            var x0 = (w - iw * s) / 2;
            var y0 = (h - ih * s) / 2;

            x += x0;
            y += y0;
            w = iw * s;
            h = ih * s;
        }

        var s = this.state.scale;

        if (flipH) {
            ctx.translate(2 * x + w, 0);
            ctx.scale(-1, 1);
        }

        if (flipV) {
            ctx.translate(0, 2 * y + h);
            ctx.scale(1, -1);
        }

        ctx.drawImage(image, x, y, w, h);
        ctx.restore();
    };

    if (image != null && image.height > 0 && image.width > 0) {
        drawImage.call(this, this.ctx, image, x, y, w, h);
    } else {
        // TODO flag error that image wasn't obtaining in canvas preprocessing
    }
};

mxJsCanvas.prototype.begin = function () {
    this.ctx.beginPath();
};

mxJsCanvas.prototype.close = function () {
    this.ctx.closePath();
};

mxJsCanvas.prototype.fill = function () {
    this.ctx.fill();
};

mxJsCanvas.prototype.stroke = function () {
    this.ctx.stroke();
};

mxJsCanvas.prototype.fillAndStroke = function () {
    // If you fill then stroke, the shadow of the stroke appears over the fill
    // So stroke, fill, disable shadow, stroke, restore previous shadow
    if (!this.state.shadow) {
        this.ctx.fill();
        this.ctx.stroke();
    } else {
        this.ctx.stroke();
        this.ctx.fill();

        var shadowColor = this.ctx.shadowColor;
        var shadowOffsetX = this.ctx.shadowOffsetX;
        var shadowOffsetY = this.ctx.shadowOffsetY;

        this.ctx.shadowColor = 'transparent';
        this.ctx.shadowOffsetX = 0;
        this.ctx.shadowOffsetY = 0;

        this.ctx.stroke();

        this.ctx.shadowColor = shadowColor;
        this.ctx.shadowOffsetX = shadowOffsetX;
        this.ctx.shadowOffsetY = shadowOffsetY;
    }
};

mxJsCanvas.prototype.text = function (x, y, w, h, str, align, valign, wrap, format, overflow, clip, rotation) {
    if (str == null || str.length == 0) {
        return;
    }

    var sc = this.state.scale;
    w *= sc;
    h *= sc;

    if (rotation != 0) {
        this.ctx.translate(Math.round(x), Math.round(y));
        this.ctx.rotate(rotation * Math.PI / 180);
        this.ctx.translate(Math.round(-x), Math.round(-y));
    }

    if (format == 'html') {
        var subCanvas = this.subCanvas[this.canvasIndex++];
        var cavHeight = subCanvas.height;
        var cavWidth = subCanvas.width;

        switch (valign) {
            case mxConstants.ALIGN_MIDDLE:
                y -= cavHeight / 2 / sc;
                break;
            case mxConstants.ALIGN_BOTTOM:
                y -= cavHeight / sc;
                break;
        }

        switch (align) {
            case mxConstants.ALIGN_CENTER:
                x -= cavWidth / 2 / sc;
                break;
            case mxConstants.ALIGN_RIGHT:
                x -= cavWidth / sc;
                break;
        }

        this.ctx.save();

        if (this.state.fontBackgroundColor != null || this.state.fontBorderColor != null) {

            if (this.state.fontBackgroundColor != null) {
                this.ctx.fillStyle = this.state.fontBackgroundColor;
                this.ctx.fillRect(Math.round(x) - 0.5, Math.round(y) - 0.5, Math.round(subCanvas.width / sc), Math.round(subCanvas.height / sc));
            }
            if (this.state.fontBorderColor != null) {
                this.ctx.strokeStyle = this.state.fontBorderColor;
                this.ctx.lineWidth = 1;
                this.ctx.strokeRect(Math.round(x) - 0.5, Math.round(y) - 0.5, Math.round(subCanvas.width / sc), Math.round(subCanvas.height / sc));
            }
        }

        //if (sc < 1)
        //{
        this.ctx.scale(1 / sc, 1 / sc);
        //}

        this.ctx.drawImage(subCanvas, Math.round(x * sc), Math.round(y * sc));

        this.ctx.restore();

    } else {
        this.ctx.save();
        this.updateFont();

        var div = document.createElement("div");
        div.innerHTML = str;
        div.style.position = 'absolute';
        div.style.top = '-9999px';
        div.style.left = '-9999px';
        div.style.fontFamily = this.state.fontFamily;
        div.style.fontWeight = 'bold';
        div.style.fontSize = this.state.fontSize + 'pt';
        document.body.appendChild(div);
        var measuredFont = [div.offsetWidth, div.offsetHeight];
        document.body.removeChild(div);

        var lines = str.split('\n');
        var lineHeight = measuredFont[1];

        this.ctx.textBaseline = 'top';
        var backgroundY = y;

        switch (valign) {
            case mxConstants.ALIGN_MIDDLE:
                this.ctx.textBaseline = 'middle';
                y -= (lines.length - 1) * lineHeight / 2;
                backgroundY = y - this.state.fontSize / 2;
                break;
            case mxConstants.ALIGN_BOTTOM:
                this.ctx.textBaseline = 'alphabetic';
                y -= lineHeight * (lines.length - 1);
                backgroundY = y - this.state.fontSize;
                break;
        }

        var lineWidth = [];
        var lineX = [];

        for (var i = 0; i < lines.length; i++) {
            lineX[i] = x;
            lineWidth[i] = this.ctx.measureText(lines[i]).width;

            if (align != null && align != mxConstants.ALIGN_LEFT) {
                lineX[i] -= lineWidth[i];

                if (align == mxConstants.ALIGN_CENTER) {
                    lineX[i] += lineWidth[i] / 2;
                }
            }
        }

        if (this.state.fontBackgroundColor != null || this.state.fontBorderColor != null) {
            var startMostX = lineX[0];
            var maxWidth = lineWidth[0];

            for (var i = 1; i < lines.length; i++) {
                startMostX = Math.min(startMostX, lineX[i]);
                maxWidth = Math.max(maxWidth, lineWidth[i]);
            }

            this.ctx.save();

            startMostX = Math.round(startMostX) - 0.5;
            backgroundY = Math.round(backgroundY) - 0.5;

            if (this.state.fontBackgroundColor != null) {
                this.ctx.fillStyle = this.state.fontBackgroundColor;
                this.ctx.fillRect(startMostX, backgroundY, maxWidth, this.state.fontSize * mxConstants.LINE_HEIGHT * lines.length);
            }
            if (this.state.fontBorderColor != null) {
                this.ctx.strokeStyle = this.state.fontBorderColor;
                this.ctx.lineWidth = 1;
                this.ctx.strokeRect(startMostX, backgroundY, maxWidth, this.state.fontSize * mxConstants.LINE_HEIGHT * lines.length);
            }

            this.ctx.restore();
        }

        for (var i = 0; i < lines.length; i++) {
            this.ctx.fillText(lines[i], lineX[i], y);
            y += this.state.fontSize * mxConstants.LINE_HEIGHT;
        }

        this.ctx.restore();
    }
};

mxJsCanvas.prototype.getCanvas = function () {
    return canvas;
};

mxJsCanvas.prototype.finish = function (handler) {
    // TODO: Check if waitCounter updates need a monitor. Question is
    // if image load-handler can be executed in parallel leading to
    // race conditions when updating the "shared" waitCounter.
    if (this.waitCounter == 0) {
        handler();
    } else {
        this.onComplete = handler;
    }
};
/**
 * mxAsyncCanvas
 */

/**
 * Extends mxAbstractCanvas2D
 */
function mxAsyncCanvas(htmlCanvas) {
    mxAbstractCanvas2D.call(this);
    this.htmlCanvas = htmlCanvas;
    htmlCanvas.images = htmlCanvas.images || [];
    htmlCanvas.subCanvas = htmlCanvas.subCanvas || [];
};

/**
 * Extends mxAbstractCanvas2D
 */
mxUtils.extend(mxAsyncCanvas, mxAbstractCanvas2D);

/**
 * Variable: htmlCanvas
 *
 * The canvas instance this object is obtaining async resources for
 */
mxAsyncCanvas.prototype.htmlCanvas = null;

/**
 * Variable: canvasIndex
 *
 * The current index into the canvas sub-canvas array being processed
 */
mxAsyncCanvas.prototype.canvasIndex = 0;

/**
 * Variable: ctx
 *
 * Holds the current canvas context
 */
mxAsyncCanvas.prototype.waitCounter = 0;

/**
 * Variable: ctx
 *
 * Holds the current canvas context
 */
mxAsyncCanvas.prototype.onComplete = null;

mxAsyncCanvas.prototype.incWaitCounter = function () {
    this.waitCounter++;
};

mxAsyncCanvas.prototype.decWaitCounter = function () {
    this.waitCounter--;

    if (this.waitCounter == 0 && this.onComplete != null) {
        this.onComplete();
        this.onComplete = null;
    }
};

mxAsyncCanvas.prototype.updateFont = function () {
    var style = '';

    if ((this.state.fontStyle & mxConstants.FONT_BOLD) == mxConstants.FONT_BOLD) {
        style += 'bold ';
    }

    if ((this.state.fontStyle & mxConstants.FONT_ITALIC) == mxConstants.FONT_ITALIC) {
        style += 'italic ';
    }

    this.ctx.font = style + this.state.fontSize + 'px ' + this.state.fontFamily;
};

mxAsyncCanvas.prototype.rotate = function (theta, flipH, flipV, cx, cy) {
};

mxAsyncCanvas.prototype.setAlpha = function (alpha) {
    this.state.alpha = alpha;
};

mxAsyncCanvas.prototype.setFontColor = function (value) {
    this.state.fontColor = value;
};

mxAsyncCanvas.prototype.setFontBackgroundColor = function (value) {
    if (value == mxConstants.NONE) {
        value = null;
    }

    this.state.fontBackgroundColor = value;
};

mxAsyncCanvas.prototype.setFontBorderColor = function (value) {
    if (value == mxConstants.NONE) {
        value = null;
    }

    this.state.fontBorderColor = value;
};

mxAsyncCanvas.prototype.setFontSize = function (value) {
    this.state.fontSize = value;
};

mxAsyncCanvas.prototype.setFontFamily = function (value) {
    this.state.fontFamily = value;
};

mxAsyncCanvas.prototype.setFontStyle = function (value) {
    this.state.fontStyle = value;
};

mxAsyncCanvas.prototype.rect = function (x, y, w, h) {
};

mxAsyncCanvas.prototype.roundrect = function (x, y, w, h, dx, dy) {
};

mxAsyncCanvas.prototype.ellipse = function (x, y, w, h) {
};

//Redirect can be implemented via a hook
mxAsyncCanvas.prototype.rewriteImageSource = function (src) {
    if (src.substring(0, 7) == 'http://' || src.substring(0, 8) == 'https://') {
        src = '/proxy?url=' + encodeURIComponent(src);
    }

    return src;
};

mxAsyncCanvas.prototype.image = function (x, y, w, h, src, aspect, flipH, flipV) {
    src = this.rewriteImageSource(src);
    var image = this.htmlCanvas.images[src];

    if (image == null) {
        var image = new Image();

        image.onload = mxUtils.bind(this, function () {
            this.decWaitCounter();
        });

        image.onerror = mxUtils.bind(this, function () {
            this.decWaitCounter();
            // TODO null the image out? this.htmlCanvas.images[src] = null;
        });

        this.incWaitCounter();
        this.htmlCanvas.images[src] = image;
        image.src = src;
    }
};

mxAsyncCanvas.prototype.fill = function () {
};

mxAsyncCanvas.prototype.stroke = function () {
};

mxAsyncCanvas.prototype.fillAndStroke = function () {
};

mxAsyncCanvas.prototype.text = function (x, y, w, h, str, align, valign, wrap, format, overflow, clip, rotation) {
    if (str == null || str.length == 0) {
        return;
    }

    var sc = this.state.scale;

    if (format == 'html' && typeof html2canvas === 'function') {
        this.incWaitCounter();
        var canvasIndex = this.canvasIndex++;

        html2canvas(str,
            {
                onrendered: mxUtils.bind(this, function (canvas) {
                    this.htmlCanvas.subCanvas[canvasIndex] = canvas;
                    this.decWaitCounter();
                }),
                scale: sc,
                logging: true
            });
    }
};

mxAsyncCanvas.prototype.finish = function (handler) {
    // TODO: Check if waitCounter updates need a monitor. Question is
    // if image load-handler can be executed in parallel leading to
    // race conditions when updating the "shared" waitCounter.
    if (this.waitCounter == 0) {
        handler();
    } else {
        this.onComplete = handler;
    }
};
/**
 * Copyright (c) 2006-2017, JGraph Ltd
 * Copyright (c) 2006-2017, Gaudenz Alder
 */
DrawioFile = function (ui, data) {
    mxEventSource.call(this);

    /**
     * Holds the x-coordinate of the point.
     * @type number
     * @default 0
     */
    this.ui = ui;

    /**
     * Holds the x-coordinate of the point.
     * @type number
     * @default 0
     */
    this.data = data || '';
    this.shadowData = this.data;
    this.shadowPages = null;

    // Creates the stats object
    this.stats = {
        opened: 0, /* number of calls to open */
        merged: 0, /* number of calls to merge */
        fileMerged: 0, /* number of calls to mergeFile */
        fileReloaded: 0, /* number of calls to mergeFile */
        conflicts: 0, /* number of write conflicts when saving a file */
        timeouts: 0, /* number of time we have given up to retry after a write conflict */
        saved: 0, /* number of calls to fileSaved */
        closed: 0, /* number of calls to close */
        destroyed: 0, /* number of calls to close */
        joined: 0, /* number of join messages received */
        checksumErrors: 0, /* number of checksum errors */
        bytesSent: 0, /* number of bytes send in messages */
        bytesReceived: 0, /* number of bytes received in messages */
        msgSent: 0, /* number of messages sent */
        msgReceived: 0, /* number of messages received */
        cacheHits: 0, /* number of times the cache returned patches */
        cacheMiss: 0, /* number of times we have missed a cache entry */
        cacheFail: 0 /* number of times we have failed to read the cache */
    };
};

/**
 * Global switch for realtime collaboration type to use sync URL parameter
 * with the following possible values:
 *
 * - none: overwrite
 * - manual: manual sync
 * - auto: automatic sync
 */
DrawioFile.SYNC = urlParams['sync'] || 'auto';

/**
 * Specifies if last write wins should be used for values and styles.
 */
DrawioFile.LAST_WRITE_WINS = true;

// Extends mxEventSource
mxUtils.extend(DrawioFile, mxEventSource);

/**
 * Delay for last save in ms.
 */
DrawioFile.prototype.allChangesSavedKey = 'allChangesSaved';

/**
 * Specifies the delay between the last change and the autosave.
 */
DrawioFile.prototype.autosaveDelay = 1500;

/**
 * Specifies the maximum delay before an autosave is forced even if the graph
 * is being changed.
 */
DrawioFile.prototype.maxAutosaveDelay = 30000;

/**
 * Contains the thread for the next autosave.
 */
DrawioFile.prototype.autosaveThread = null;

/**
 * Stores the time stamp for the last autosave.
 */
DrawioFile.prototype.lastAutosave = null;

/**
 * Stores the time stamp for the last autosave.
 */
DrawioFile.prototype.lastSaved = null;

/**
 * Stores the time stamp for the last autosave.
 */
DrawioFile.prototype.lastChanged = null;

/**
 * Stores the time stamp when the file was opened.
 */
DrawioFile.prototype.opened = null;

/**
 * Stores the modified state.
 */
DrawioFile.prototype.modified = false;

/**
 * Holds a copy of the current file data.
 */
DrawioFile.prototype.data = null;

/**
 * Holds a copy of the last saved file data.
 */
DrawioFile.prototype.shadowData = null;

/**
 * Holds a copy of the parsed last saved file data.
 */
DrawioFile.prototype.shadowPages = null;

/**
 * Specifies if the graph change listener is enabled. Default is true.
 */
DrawioFile.prototype.changeListenerEnabled = true;

/**
 * Sets the delay for autosave in milliseconds. Default is 1500.
 */
DrawioFile.prototype.lastAutosaveRevision = null;

/**
 * Sets the delay between revisions when using autosave. Default is 300000
 * ie 5 mins. Set this to 0 to create a revision on every autosave.
 */
DrawioFile.prototype.maxAutosaveRevisionDelay = 300000;

/**
 * Specifies if notify events should be ignored.
 */
DrawioFile.prototype.inConflictState = false;

/**
 * Specifies if notify events should be ignored.
 */
DrawioFile.prototype.invalidChecksum = false;

/**
 * Specifies if error reports should be sent.
 */
DrawioFile.prototype.errorReportsEnabled = false;

/**
 * Specifies if stats should be sent.
 */
DrawioFile.prototype.reportEnabled = true;

/**
 * Specifies if stats should be sent.
 */
DrawioFile.prototype.ageStart = null;

/**
 * Specifies if notify events should be ignored.
 */
DrawioFile.prototype.getSize = function () {
    return (this.data != null) ? this.data.length : 0;
};

/**
 * Adds the listener for automatically saving the diagram for local changes.
 */
DrawioFile.prototype.synchronizeFile = function (success, error) {
    if (this.savingFile) {
        if (error != null) {
            error({message: mxResources.get('busy')});
        }
    } else {
        if (this.sync != null) {
            this.sync.fileChanged(success, error);
        } else {
            this.updateFile(success, error);
        }
    }
};

/**
 * Adds the listener for automatically saving the diagram for local changes.
 */
DrawioFile.prototype.updateFile = function (success, error, abort, shadow) {
    if (abort == null || !abort()) {
        if (this.ui.getCurrentFile() != this || this.invalidChecksum) {
            if (error != null) {
                error();
            }
        } else {
            this.getLatestVersion(mxUtils.bind(this, function (latestFile) {
                try {
                    if (abort == null || !abort()) {
                        if (this.ui.getCurrentFile() != this || this.invalidChecksum) {
                            if (error != null) {
                                error();
                            }
                        } else {
                            if (latestFile != null) {
                                this.mergeFile(latestFile, success, error, shadow);
                            } else {
                                this.reloadFile(success, error);
                            }
                        }
                    }
                } catch (e) {
                    if (error != null) {
                        error(e);
                    }
                }
            }), error);
        }
    }
};

/**
 * Adds the listener for automatically saving the diagram for local changes.
 */
DrawioFile.prototype.mergeFile = function (file, success, error, diffShadow) {
    var reportError = true;

    try {
        this.stats.fileMerged++;

        // Takes copy of current shadow document
        var shadow = (this.shadowPages != null) ? this.shadowPages :
            this.ui.getPagesForNode(mxUtils.parseXml(
                this.shadowData).documentElement);

        // Loads new document as shadow document
        var pages = this.ui.getPagesForNode(
            mxUtils.parseXml(file.data).documentElement)

        if (pages != null && pages.length > 0) {
            this.shadowPages = pages;

            // Creates a patch for backup if the checksum fails
            this.backupPatch = (this.isModified()) ?
                this.ui.diffPages(shadow,
                    this.ui.pages) : null;

            // Patches the current document
            var patches = [this.ui.diffPages((diffShadow != null) ?
                diffShadow : shadow, this.shadowPages)];
            var ignored = this.ignorePatches(patches);

            if (!ignored) {
                // Patching previous shadow to verify checksum
                var patched = this.ui.patchPages(shadow, patches[0]);

                var patchedDetails = {};
                var checksum = this.ui.getHashValueForPages(patched, patchedDetails);
                var currentDetails = {};
                var current = this.ui.getHashValueForPages(this.shadowPages, currentDetails);

                if (checksum != null && checksum != current) {
                    var fileData = this.compressReportData(this.getAnonymizedXmlForPages(pages));
                    var data = this.compressReportData(this.getAnonymizedXmlForPages(patched));
                    var from = this.ui.hashValue(file.getCurrentEtag());
                    var to = this.ui.hashValue(this.getCurrentEtag());

                    this.checksumError(error, patches,
                        'Shadow Details: ' + JSON.stringify(patchedDetails) +
                        '\nChecksum: ' + checksum +
                        '\nCurrent: ' + current +
                        '\nCurrent Details: ' + JSON.stringify(currentDetails) +
                        '\nFrom: ' + from +
                        '\nTo: ' + to +
                        '\n\nFile Data:\n' + fileData +
                        '\nPatched Shadow:\n' + data, null, 'mergeFile');

                    // Abnormal termination
                    return;
                } else {
                    // Patches the current document
                    this.patch(patches,
                        (DrawioFile.LAST_WRITE_WINS) ?
                            this.backupPatch : null);
                }
            }
        } else {
            reportError = false;
            throw new Error(mxResources.get('notADiagramFile'));
        }

        this.invalidChecksum = false;
        this.inConflictState = false;
        this.setDescriptor(file.getDescriptor());
        this.descriptorChanged();
        this.backupPatch = null;

        if (success != null) {
            success();
        }
    } catch (e) {
        this.inConflictState = true;
        this.invalidChecksum = true;
        this.descriptorChanged();

        if (error != null) {
            error(e);
        }

        try {
            if (reportError) {
                if (this.errorReportsEnabled) {
                    this.sendErrorReport('Error in mergeFile', null, e);
                } else {
                    var user = this.getCurrentUser();
                    var uid = (user != null) ? user.id : 'unknown';

                    EditorUi.logError('Error in mergeFile', null,
                        this.getMode() + '.' + this.getId(),
                        uid, e);
                }
            }
        } catch (e2) {
            // ignore
        }
    }
};

/**
 * Adds the listener for automatically saving the diagram for local changes.
 */
DrawioFile.prototype.getAnonymizedXmlForPages = function (pages) {
    var enc = new mxCodec(mxUtils.createXmlDocument());
    var file = enc.document.createElement('mxfile');

    if (pages != null) {
        for (var i = 0; i < pages.length; i++) {
            var temp = enc.encode(new mxGraphModel(pages[i].root));

            if (urlParams['dev'] != '1') {
                temp = this.ui.anonymizeNode(temp, true);
            }

            temp.setAttribute('id', pages[i].getId());

            if (pages[i].viewState) {
                this.ui.editor.graph.saveViewState(pages[i].viewState, temp, true);
            }

            file.appendChild(temp);
        }
    }

    return mxUtils.getPrettyXml(file);
};

/**
 * Adds the listener for automatically saving the diagram for local changes.
 */
DrawioFile.prototype.compressReportData = function (data, limit, max) {
    limit = (limit != null) ? limit : 10000;

    if (max != null && data != null && data.length > max) {
        data = data.substring(0, max) + '[...]';
    } else if (data != null && data.length > limit) {
        data = Graph.compress(data) + '\n';
    }

    return data;
};

/**
 * Adds the listener for automatically saving the diagram for local changes.
 */
DrawioFile.prototype.checksumError = function (error, patches, details, etag, functionName) {
    this.stats.checksumErrors++;
    this.inConflictState = true;
    this.invalidChecksum = true;
    this.descriptorChanged();

    if (this.sync != null) {
        this.sync.updateOnlineState();
    }

    if (error != null) {
        error();
    }

    try {
        if (this.errorReportsEnabled) {
            if (patches != null) {
                for (var i = 0; i < patches.length; i++) {
                    this.ui.anonymizePatch(patches[i]);
                }
            }

            var fn = mxUtils.bind(this, function (file) {
                var json = this.compressReportData(
                    JSON.stringify(patches, null, 2));
                var remote = (file != null) ? this.compressReportData(
                    this.getAnonymizedXmlForPages(
                        this.ui.getPagesForNode(
                            mxUtils.parseXml(file.data).documentElement)), 25000) : 'n/a';

                this.sendErrorReport('Checksum Error in ' + functionName + ' ' + this.getHash(),
                    ((details != null) ? (details) : '') + '\n\nPatches:\n' + json +
                    ((remote != null) ? ('\n\nRemote:\n' + remote) : ''), null, 70000);
            });

            if (etag == null) {
                fn(null);
            } else {
                this.getLatestVersion(mxUtils.bind(this, function (file) {
                    if (file != null && file.getCurrentEtag() == etag) {
                        fn(file);
                    } else {
                        fn(null);
                    }
                }), function () {
                });
            }
        } else {
            var user = this.getCurrentUser();
            var uid = (user != null) ? user.id : 'unknown';

            EditorUi.logError('Checksum Error in ' + functionName + ' ' + this.getId(),
                null, this.getMode() + '.' + this.getId(),
                'user_' + uid + ((this.sync != null) ?
                '-client_' + this.sync.clientId : '-nosync'));

            // Logs checksum error for file
            try {
                EditorUi.logEvent({
                    category: 'CHECKSUM-ERROR-SYNC-FILE-' + this.getHash(),
                    action: functionName, label: 'user_' + uid + ((this.sync != null) ?
                        '-client_' + this.sync.clientId : '-nosync')
                });
            } catch (e) {
                // ignore
            }
        }
    } catch (e) {
        // ignore
    }
};

/**
 * Adds the listener for automatically saving the diagram for local changes.
 */
DrawioFile.prototype.sendErrorReport = function (title, details, error, max) {
    try {
        var shadow = this.compressReportData(
            this.getAnonymizedXmlForPages(
                this.shadowPages), 25000);
        var data = this.compressReportData(
            this.getAnonymizedXmlForPages(
                this.ui.pages), 25000);
        var user = this.getCurrentUser();
        var uid = (user != null) ? this.ui.hashValue(user.id) : 'unknown';
        var cid = (this.sync != null) ? '-client_' + this.sync.clientId : '-nosync';
        var filename = this.getTitle();
        var dot = filename.lastIndexOf('.');
        var ext = 'xml';

        if (dot > 0) {
            ext = filename.substring(dot);
        }

        var stack = (error != null) ? error.stack : new Error().stack;

        EditorUi.sendReport(title + ' ' + new Date().toISOString() + ':' +
            '\n\nBrowser=' + navigator.userAgent +
            '\nFile=' + this.ui.hashValue(this.getId()) + ' (' + this.getMode() + ')' +
            ((this.isModified()) ? ' modified' : '') +
            '\nSize/Type=' + this.getSize() + ' (' + ext + ')' +
            '\nUser=' + uid + cid +
            '\nPrefix=' + this.ui.editor.graph.model.prefix +
            '\nSync=' + DrawioFile.SYNC +
            ((this.sync != null) ? (((this.sync.enabled) ? ' enabled' : '') +
                ((this.sync.isConnected()) ? ' connected' : '')) : '') +
            '\nPlugins=' + ((mxSettings.settings != null) ? mxSettings.getPlugins() : 'null') +
            '\n\nStats:\n' + JSON.stringify(this.stats, null, 2) +
            ((details != null) ? ('\n\n' + details) : '') +
            ((error != null) ? ('\n\nError: ' + error.message) : '') +
            '\n\nStack:\n' + stack +
            '\n\nShadow:\n' + shadow +
            '\n\nData:\n' + data, max);
    } catch (e) {
        // ignore
    }
};

/**
 * Adds the listener for automatically saving the diagram for local changes.
 */
DrawioFile.prototype.reloadFile = function (success, error) {
    try {
        this.ui.spinner.stop();

        var fn = mxUtils.bind(this, function () {
            this.stats.fileReloaded++;
            this.reportEnabled = false;

            // Restores view state and current page
            var viewState = this.ui.editor.graph.getViewState();
            var selection = this.ui.editor.graph.getSelectionCells();
            var page = this.ui.currentPage;

            this.ui.loadFile(this.getHash(), true, null, mxUtils.bind(this, function () {
                if (this.ui.fileLoadedError == null) {
                    this.ui.restoreViewState(page, viewState, selection);

                    if (this.backupPatch != null) {
                        this.patch([this.backupPatch]);
                    }

                    // Carry-over stats
                    var file = this.ui.getCurrentFile();

                    if (file != null) {
                        file.stats = this.stats;
                    }

                    if (success != null) {
                        success();
                    }
                }
            }), true);
        });

        if (this.isModified() && this.backupPatch == null) {
            this.ui.confirm(mxResources.get('allChangesLost'), mxUtils.bind(this, function () {
                this.handleFileSuccess(DrawioFile.SYNC == 'manual');
            }), fn, mxResources.get('cancel'), mxResources.get('discardChanges'));
        } else {
            fn();
        }
    } catch (e) {
        if (error != null) {
            error(e);
        }
    }
};

/**
 * Shows a conflict dialog to the user.
 */
DrawioFile.prototype.copyFile = function (success, error) {
    this.ui.editor.editAsNew(this.ui.getFileData(true),
        this.ui.getCopyFilename(this));
};

/**
 * Returns true if the patches in the given array are empty.
 */
DrawioFile.prototype.ignorePatches = function (patches) {
    var ignore = true;

    for (var i = 0; i < patches.length && ignore; i++) {
        ignore = ignore && Object.keys(patches[i]).length == 0;
    }

    return ignore;
};

/**
 * Applies the given patches to the file.
 */
DrawioFile.prototype.patch = function (patches, resolver) {
    // Saves state of undo history
    var undoMgr = this.ui.editor.undoManager;
    var history = undoMgr.history.slice();
    var nextAdd = undoMgr.indexOfNextAdd;

    // Hides graph during updates
    var graph = this.ui.editor.graph;
    graph.container.style.visibility = 'hidden';

    // Ignores change events
    var prev = this.changeListenerEnabled;
    this.changeListenerEnabled = false;

    // Folding and math change require special handling
    var fold = graph.foldingEnabled;
    var math = graph.mathEnabled;

    // Updates text editor if cell changes during validation
    var redraw = graph.cellRenderer.redraw;

    graph.cellRenderer.redraw = function (state) {
        if (state.view.graph.isEditing(state.cell)) {
            state.view.graph.scrollCellToVisible(state.cell);
            state.view.graph.cellEditor.resize();
        }

        redraw.apply(this, arguments);
    };

    graph.model.beginUpdate();
    try {
        // Applies patches
        for (var i = 0; i < patches.length; i++) {
            this.ui.pages = this.ui.patchPages(this.ui.pages,
                patches[i], true, resolver, this.isModified());
        }

        // Always needs at least one page
        if (this.ui.pages.length == 0) {
            this.ui.pages.push(this.ui.createPage());
        }

        // Checks if current page was removed
        if (mxUtils.indexOf(this.ui.pages, this.ui.currentPage) < 0) {
            this.ui.selectPage(this.ui.pages[0], true);
        }
    } finally {
        // Changes visibility before action states are updated via model event
        graph.container.style.visibility = '';
        graph.model.endUpdate();

        // Restores previous state
        graph.cellRenderer.redraw = redraw;
        this.changeListenerEnabled = prev;

        // Restores history state
        undoMgr.history = history;
        undoMgr.indexOfNextAdd = nextAdd;
        undoMgr.fireEvent(new mxEventObject(mxEvent.CLEAR));

        if (this.ui.currentPage == null || this.ui.currentPage.needsUpdate) {
            // Updates the graph and background
            if (math != graph.mathEnabled) {
                this.ui.editor.updateGraphComponents();
                graph.refresh();
            } else {
                if (fold != graph.foldingEnabled) {
                    graph.view.revalidate();
                } else {
                    graph.view.validate();
                }

                graph.sizeDidChange();
            }
        }

        this.ui.updateTabContainer();
    }
};

/**
 * Adds the listener for automatically saving the diagram for local changes.
 */
DrawioFile.prototype.save = function (revision, success, error, unloading, overwrite, manual) {
    try {
        if (!this.isEditable()) {
            if (error != null) {
                error({message: mxResources.get('readOnly')});
            } else {
                throw new Error(mxResources.get('readOnly'));
            }
        } else if (!overwrite && this.invalidChecksum) {
            if (error != null) {
                error({message: mxResources.get('checksum')});
            } else {
                throw new Error(mxResources.get('checksum'));
            }
        } else {
            this.updateFileData();
            this.saveToNeptune();
            this.clearAutosave();

            if (success != null) {
                success();
            }
        }
    } catch (e) {
        if (error != null) {
            error(e);
        } else {
            throw e;
        }
    }
};

DrawioFile.prototype.saveToNeptune = function () {
    /*Aric.chen。此处是保存数据，drawio提供了多种调用的方式，Neptune只需要一种即可*/
    var xml = encodeURIComponent(this.data);
    var url = 'monitor_developer/saveMonitor';

    var id = NeptuneUtils.findGetParameter('id');
    NeptuneHttp.post(url, {
        id: id,
        xml: xml
    }).done(function (result) {
    });
};

/**
 * Translates this point by the given vector.
 *
 * @param {number} dx X-coordinate of the translation.
 * @param {number} dy Y-coordinate of the translation.
 */
DrawioFile.prototype.updateFileData = function () {
    this.setData(this.ui.getFileData(null, null, null, null, null, null, null, null, this, !this.isCompressed()));
};

/**
 * Translates this point by the given vector.
 *
 * @param {number} dx X-coordinate of the translation.
 * @param {number} dy Y-coordinate of the translation.
 */
DrawioFile.prototype.isCompressed = function () {
    var compressed = (this.ui.fileNode != null) ? this.ui.fileNode.getAttribute('compressed') : null;

    if (compressed != null) {
        return compressed != 'false';
    } else {
        return Editor.compressXml;
    }
};

/**
 * Translates this point by the given vector.
 *
 * @param {number} dx X-coordinate of the translation.
 * @param {number} dy Y-coordinate of the translation.
 */
DrawioFile.prototype.saveAs = function (filename, success, error) {
};

/**
 * Translates this point by the given vector.
 *
 * @param {number} dx X-coordinate of the translation.
 * @param {number} dy Y-coordinate of the translation.
 */
DrawioFile.prototype.saveFile = function (title, revision, success, error) {
};

/**
 * Returns true if copy, export and print are not allowed for this file.
 */
DrawioFile.prototype.getPublicUrl = function (fn) {
    fn(null);
};

/**
 * Returns true if copy, export and print are not allowed for this file.
 */
DrawioFile.prototype.isRestricted = function () {
    return false;
};

/**
 * Translates this point by the given vector.
 *
 * @param {number} dx X-coordinate of the translation.
 * @param {number} dy Y-coordinate of the translation.
 */
DrawioFile.prototype.isModified = function () {
    return this.modified;
};

/**
 * Translates this point by the given vector.
 *
 * @param {number} dx X-coordinate of the translation.
 * @param {number} dy Y-coordinate of the translation.
 */
DrawioFile.prototype.setModified = function (value) {
    this.modified = value;
};

/**
 * Specifies if the autosave checkbox should be shown in the document
 * properties dialog. Default is false.
 */
DrawioFile.prototype.isAutosaveOptional = function () {
    return false;
};

/**
 * Translates this point by the given vector.
 *
 * @param {number} dx X-coordinate of the translation.
 * @param {number} dy Y-coordinate of the translation.
 */
DrawioFile.prototype.isAutosave = function () {
    return !this.inConflictState && this.ui.editor.autosave;
};

/**
 * Translates this point by the given vector.
 *
 * @param {number} dx X-coordinate of the translation.
 * @param {number} dy Y-coordinate of the translation.
 */
DrawioFile.prototype.isRenamable = function () {
    return false;
};

/**
 * Translates this point by the given vector.
 *
 * @param {number} dx X-coordinate of the translation.
 * @param {number} dy Y-coordinate of the translation.
 */
DrawioFile.prototype.rename = function (title, success, error) {
};

/**
 * Translates this point by the given vector.
 *
 * @param {number} dx X-coordinate of the translation.
 * @param {number} dy Y-coordinate of the translation.
 */
DrawioFile.prototype.isMovable = function () {
    return false;
};

/**
 * Translates this point by the given vector.
 *
 * @param {number} dx X-coordinate of the translation.
 * @param {number} dy Y-coordinate of the translation.
 */
DrawioFile.prototype.move = function (folderId, success, error) {
};

/**
 * Returns the hash of the file which consists of a prefix for the storage
 * type and the ID of the file.
 */
DrawioFile.prototype.getHash = function () {
    return '';
};

/**
 * Returns the ID of the file.
 */
DrawioFile.prototype.getId = function () {
    return '';
};

/**
 * Returns true if the file is editable.
 */
DrawioFile.prototype.isEditable = function () {
    return !this.ui.editor.isChromelessView() || this.ui.editor.editable;
};

/**
 * Returns the location as a new object.
 * @type mx.Point
 */
DrawioFile.prototype.getUi = function () {
    return this.ui;
};

/**
 * Returns the current title of the file.
 */
DrawioFile.prototype.getTitle = function () {
    return '';
};

/**
 * Sets the current data of the file.
 */
DrawioFile.prototype.setData = function (data) {
    this.data = data;
};

/**
 * Returns the current data of the file.
 */
DrawioFile.prototype.getData = function () {
    return this.data;
};

/**
 * Opens this file in the editor.
 */
DrawioFile.prototype.open = function () {
    this.stats.opened++;
    var data = this.getData();

    if (data != null) {
        this.ui.setFileData(data);

        // Updates shadow in case any page IDs have been updated
        // only if the file has not been modified and reopened
        if (!this.isModified()) {
            this.shadowData = mxUtils.getXml(this.ui.getXmlFileData());
            this.shadowPages = null;
        }
    }

    this.installListeners();

    if (this.isSyncSupported()) {
        this.startSync();
    }
};

/**
 * Hook for subclassers.
 */
DrawioFile.prototype.isSyncSupported = function () {
    return false;
};

/**
 * Hook for subclassers.
 */
DrawioFile.prototype.isRevisionHistorySupported = function () {
    return false;
};

/**
 * Hook for subclassers.
 */
DrawioFile.prototype.getRevisions = function (success, error) {
    success(null);
};

/**
 * Hook for subclassers to get the latest descriptor of this file
 * and return it in the success handler.
 */
DrawioFile.prototype.loadDescriptor = function (success, error) {
    success(null);
};

/**
 * Hook for subclassers to get the latest etag of this file
 * and return it in the success handler.
 */
DrawioFile.prototype.loadPatchDescriptor = function (success, error) {
    this.loadDescriptor(mxUtils.bind(this, function (desc) {
        success(desc);
    }), error);
};

/**
 * Adds the listener for automatically saving the diagram for local changes.
 */
DrawioFile.prototype.patchDescriptor = function (desc, patch) {
    this.setDescriptorEtag(desc, this.getDescriptorEtag(patch));
};

/**
 * Creates a starts the synchronization.
 */
DrawioFile.prototype.startSync = function () {
    if ((DrawioFile.SYNC == 'auto' && urlParams['stealth'] != '1') &&
        (urlParams['rt'] == '1' || !this.ui.editor.chromeless ||
            this.ui.editor.editable)) {
        if (this.sync == null) {
            this.sync = new DrawioFileSync(this);
        }

        this.sync.start();
    }
};

/**
 * Hook for subclassers to check if an error is a conflict.
 */
DrawioFile.prototype.isConflict = function () {
    return false;
};

/**
 * Gets the channel ID for sync messages.
 */
DrawioFile.prototype.getChannelId = function () {
    // Slash, space and plus replaced with underscore
    return Graph.compress(this.getHash()).replace(/[\/ +]/g, '_');
};

/**
 * Gets the channel ID from the given descriptor.
 */
DrawioFile.prototype.getChannelKey = function (desc) {
    return null;
};

/**
 * Returns the current etag.
 */
DrawioFile.prototype.getCurrentUser = function () {
    return null;
};

/**
 * Hook for subclassers to get the latest version of this file
 * and return it in the success handler.
 */
DrawioFile.prototype.getLatestVersion = function (success, error) {
    success(null);
};

/**
 * Returns the last modified date of this file.
 */
DrawioFile.prototype.getLastModifiedDate = function () {
    return new Date();
};

/**
 * Sets the current etag.
 */
DrawioFile.prototype.setCurrentEtag = function (etag) {
    this.setDescriptorEtag(this.getDescriptor(), etag);
};

/**
 * Returns the current etag.
 */
DrawioFile.prototype.getCurrentEtag = function () {
    return this.getDescriptorEtag(this.getDescriptor());
};

/**
 * Returns the descriptor from this file.
 */
DrawioFile.prototype.getDescriptor = function () {
    return null;
};

/**
 * Sets the descriptor for this file.
 */
DrawioFile.prototype.setDescriptor = function () {
};

/**
 * Updates the etag on the given descriptor.
 */
DrawioFile.prototype.setDescriptorEtag = function (desc, etag) {
};

/**
 * Returns the etag from the given descriptor.
 */
DrawioFile.prototype.getDescriptorEtag = function (desc) {
    return null;
};

/**
 * Returns the secret from the given descriptor.
 */
DrawioFile.prototype.getDescriptorSecret = function (desc) {
    return null;
};

/**
 * Installs the change listener.
 */
DrawioFile.prototype.installListeners = function () {
    if (this.changeListener == null) {
        this.changeListener = mxUtils.bind(this, function (sender, eventObject) {
            var edit = (eventObject != null) ? eventObject.getProperty('edit') : null;

            if (this.changeListenerEnabled && this.isEditable() && (edit == null || !edit.ignoreEdit)) {
                this.fileChanged();
            }
        });

        this.ui.editor.graph.model.addListener(mxEvent.CHANGE, this.changeListener);

        // Some options trigger autosave
        this.ui.editor.graph.addListener('gridSizeChanged', this.changeListener);
        this.ui.editor.graph.addListener('shadowVisibleChanged', this.changeListener);
        this.ui.addListener('pageFormatChanged', this.changeListener);
        this.ui.addListener('pageScaleChanged', this.changeListener);
        this.ui.addListener('backgroundColorChanged', this.changeListener);
        this.ui.addListener('backgroundImageChanged', this.changeListener);
        this.ui.addListener('foldingEnabledChanged', this.changeListener);
        this.ui.addListener('mathEnabledChanged', this.changeListener);
        this.ui.addListener('gridEnabledChanged', this.changeListener);
        this.ui.addListener('guidesEnabledChanged', this.changeListener);
        this.ui.addListener('pageViewChanged', this.changeListener);
        this.ui.addListener('connectionPointsChanged', this.changeListener);
        this.ui.addListener('connectionArrowsChanged', this.changeListener);
    }
};

/**
 * Returns the location as a new object.
 * @type mx.Point
 */
DrawioFile.prototype.addAllSavedStatus = function (status) {
    if (this.ui.statusContainer != null && this.ui.getCurrentFile() == this) {
        status = (status != null) ? status : mxUtils.htmlEntities(mxResources.get(this.allChangesSavedKey));
        this.ui.editor.setStatus('<div title="' + status + '">' + status + '</div>');
        var links = this.ui.statusContainer.getElementsByTagName('div');

        if (links.length > 0 && this.isRevisionHistorySupported()) {
            links[0].style.cursor = 'pointer';
            links[0].style.textDecoration = 'underline';

            mxEvent.addListener(links[0], 'click', mxUtils.bind(this, function () {
                this.ui.actions.get('revisionHistory').funct();
            }));
        }
    }
};

/**
 * Adds the listener for automatically saving the diagram for local changes.
 */
DrawioFile.prototype.addUnsavedStatus = function (err) {
    if (!this.inConflictState && this.ui.statusContainer != null && this.ui.getCurrentFile() == this) {
        if (err instanceof Error && err.message != null && err.message != '') {
            var status = mxUtils.htmlEntities(mxResources.get('unsavedChanges'));

            this.ui.editor.setStatus('<div title="' + status +
                '" class="geStatusAlert" style="overflow:hidden;">' + status +
                ' (' + mxUtils.htmlEntities(err.message) + ')</div>');
        } else {
            // FIXME: Handle multiple tabs
            //		if (this.ui.mode == null && urlParams['splash'] == '0')
            //		{
            //			try
            //			{
            //				this.ui.updateDraft();
            //				this.setModified(false);
            //			}
            //			catch (e)
            //			{
            //				// Keeps modified flag unchanged
            //			}
            //		}
            var msg = this.getErrorMessage(err);

            if (msg == null && this.lastSaved != null) {
                var str = this.ui.timeSince(new Date(this.lastSaved));

                // Only show if more than a minute ago
                if (str != null) {
                    msg = mxResources.get('lastSaved', [str]);
                }
            }

            if (msg != null && msg.length > 60) {
                msg = msg.substring(0, 60) + '...';
            }

            var status = mxUtils.htmlEntities(mxResources.get('unsavedChangesClickHereToSave')) +
                ((msg != null && msg != '') ? ' (' + mxUtils.htmlEntities(msg) + ')' : '');
            this.ui.editor.setStatus('<div title="' + status +
                '" class="geStatusAlert" style="cursor:pointer;overflow:hidden;">' +
                status + '</div>');

            // Installs click handler for saving
            var links = this.ui.statusContainer.getElementsByTagName('div');

            if (links != null && links.length > 0) {
                mxEvent.addListener(links[0], 'click', mxUtils.bind(this, function () {
                    this.ui.actions.get((this.ui.mode == null || !this.isEditable()) ?
                        'saveAs' : 'save').funct();
                }));
            } else {
                var status = mxUtils.htmlEntities(mxResources.get('unsavedChanges'));

                this.ui.editor.setStatus('<div title="' + status +
                    '" class="geStatusAlert" style="overflow:hidden;">' + status +
                    ' (' + mxUtils.htmlEntities(err.message) + ')</div>');
            }
        }
    }
};

/**
 * Halts all timers and shows a conflict status message. The optional error
 * handler is invoked first.
 */
DrawioFile.prototype.addConflictStatus = function (fn, message) {
    if (this.invalidChecksum && message == null) {
        message = mxResources.get('checksum');
    }

    this.setConflictStatus(mxUtils.htmlEntities(mxResources.get('fileChangedSync')) +
        ((message != null && message != '') ? ' (' + mxUtils.htmlEntities(message) + ')' : ''));
    this.ui.spinner.stop();
    this.clearAutosave();

    var links = (this.ui.statusContainer != null) ? this.ui.statusContainer.getElementsByTagName('div') : null;

    if (links != null && links.length > 0) {
        mxEvent.addListener(links[0], 'click', mxUtils.bind(this, function (evt) {
            if (mxEvent.getSource(evt).nodeName != 'IMG') {
                fn();
            }
        }));
    } else {
        this.ui.alert(mxUtils.htmlEntities(mxResources.get('fileChangedSync')), fn);
    }
};

/**
 * Halts all timers and shows a conflict status message. The optional error
 * handler is invoked first.
 */
DrawioFile.prototype.setConflictStatus = function (message) {
    this.ui.editor.setStatus('<div title="' + message + '" class="geStatusAlert geBlink" style="cursor:pointer;overflow:hidden;">' +
        message + ' <a href="https://desk.draw.io/support/solutions/articles/16000087947" target="_blank"><img border="0" ' +
        'style="margin-left:2px;cursor:help;opacity:0.5;width:16px;height:16px;" valign="bottom" src="' + Editor.helpImage +
        '" style=""/></a></div>');
};

/**
 * Shows a conflict dialog to the user.
 */
DrawioFile.prototype.showRefreshDialog = function (success, error, message) {
    if (message == null) {
        message = mxResources.get('checksum');
    }

    if (this.ui.editor.isChromelessView() && !this.ui.editor.editable) {
        this.ui.alert(mxResources.get('fileChangedSync'), mxUtils.bind(this, function () {
            this.reloadFile(success, error);
        }));
    } else {
        // Allows for escape key to be pressed while dialog is showing
        this.addConflictStatus(mxUtils.bind(this, function () {
            this.showRefreshDialog(success, error);
        }), message);

        this.ui.showError(mxResources.get('error') + ' (' + message + ')',
            mxResources.get('fileChangedSyncDialog'),
            mxResources.get('makeCopy'), mxUtils.bind(this, function () {
                this.copyFile(success, error);
            }), null, mxResources.get('synchronize'), mxUtils.bind(this, function () {
                this.reloadFile(success, error);
            }), mxResources.get('cancel'), mxUtils.bind(this, function () {
                this.ui.hideDialog();
            }), 360, 150);
    }
};

/**
 * Shows a dialog with no synchronize option.
 */
DrawioFile.prototype.showCopyDialog = function (success, error, overwrite) {
    this.inConflictState = false;
    this.invalidChecksum = false;
    this.addUnsavedStatus();

    this.ui.showError(mxResources.get('externalChanges'),
        mxResources.get('fileChangedOverwriteDialog'),
        mxResources.get('makeCopy'), mxUtils.bind(this, function () {
            this.copyFile(success, error);
        }), null, mxResources.get('overwrite'), overwrite,
        mxResources.get('cancel'), mxUtils.bind(this, function () {
            this.ui.hideDialog();
        }), 360, 150);
};

/**
 * Shows a conflict dialog to the user.
 */
DrawioFile.prototype.showConflictDialog = function (overwrite, synchronize) {
    this.ui.showError(mxResources.get('externalChanges'),
        mxResources.get('fileChangedSyncDialog'),
        mxResources.get('overwrite'), overwrite, null,
        mxResources.get('synchronize'), synchronize,
        mxResources.get('cancel'), mxUtils.bind(this, function () {
            this.ui.hideDialog();
            this.handleFileError(null, false);
        }), 340, 150);
};

/**
 * Checks if the client is authorized and calls the next step.
 */
DrawioFile.prototype.redirectToNewApp = function (error) {
    this.ui.spinner.stop();

    if (!this.redirectDialogShowing) {
        this.redirectDialogShowing = true;

        var url = window.location.protocol + '//' + window.location.host + '/' + this.ui.getSearch(
            ['create', 'title', 'mode', 'url', 'drive', 'splash', 'state']) + '#' + this.getHash();

        var redirect = mxUtils.bind(this, function () {
            var fn = mxUtils.bind(this, function () {
                this.redirectDialogShowing = false;

                if (window.location.href == url) {
                    window.location.reload();
                } else {
                    window.location.href = url;
                }
            });

            if (error == null && this.isModified()) {
                this.ui.confirm(mxResources.get('allChangesLost'), mxUtils.bind(this, function () {
                    this.redirectDialogShowing = false;
                }), fn, mxResources.get('cancel'), mxResources.get('discardChanges'));
            } else {
                fn();
            }
        });

        if (error != null) {
            if (this.isModified()) {
                this.ui.confirm(mxResources.get('redirectToNewApp'), mxUtils.bind(this, function () {
                    this.redirectDialogShowing = false;
                    error();
                }), redirect, mxResources.get('cancel'), mxResources.get('discardChanges'));
            } else {
                this.ui.confirm(mxResources.get('redirectToNewApp'), redirect, mxUtils.bind(this, function () {
                    this.redirectDialogShowing = false;
                    error();
                }));
            }
        } else {
            this.ui.alert(mxResources.get('redirectToNewApp'), redirect);
        }
    }
};

/**
 * Adds the listener for automatically saving the diagram for local changes.
 */
DrawioFile.prototype.handleFileSuccess = function (saved) {
    this.ui.spinner.stop();

    if (this.ui.getCurrentFile() == this) {
        if (this.isModified()) {
            this.fileChanged();
        } else if (saved) {
            this.addAllSavedStatus();

            if (this.sync != null) {
                this.sync.resetUpdateStatusThread();

                if (this.sync.remoteFileChanged) {
                    this.sync.remoteFileChanged = false;
                    this.sync.fileChangedNotify();
                }
            }
        } else {
            this.ui.editor.setStatus('');
        }
    }
};

/**
 * Adds the listener for automatically saving the diagram for local changes.
 */
DrawioFile.prototype.handleFileError = function (err, manual) {
    this.ui.spinner.stop();

    if (this.ui.getCurrentFile() == this) {
        if (this.inConflictState) {
            this.handleConflictError(err, manual);
        } else {
            if (this.isModified()) {
                this.addUnsavedStatus(err);
            }

            if (manual) {
                this.ui.handleError(err, (err != null) ? mxResources.get('errorSavingFile') : null);
            } else if (!this.isModified()) {
                var msg = (err != null) ? ((err.error != null) ? err.error.message : err.message) : null;

                if (msg != null && msg.length > 60) {
                    msg = msg.substring(0, 60) + '...';
                }

                this.ui.editor.setStatus('<div class="geStatusAlert" style="cursor:pointer;overflow:hidden;">' +
                    mxUtils.htmlEntities(mxResources.get('error')) +
                    ((msg != null) ? ' (' + mxUtils.htmlEntities(msg) + ')' : '') + '</div>');
            }
        }
    }
};

/**
 * Adds the listener for automatically saving the diagram for local changes.
 */
DrawioFile.prototype.handleConflictError = function (err, manual) {
    var success = mxUtils.bind(this, function () {
        this.handleFileSuccess(true);
    });

    var error = mxUtils.bind(this, function (err2) {
        this.handleFileError(err2, true);
    });

    var overwrite = mxUtils.bind(this, function () {
        if (this.ui.spinner.spin(document.body, mxResources.get('saving'))) {
            this.ui.editor.setStatus('');
            var isRepoFile = (this.constructor == GitHubFile) || (this.constructor == GitLabFile);
            this.save(true, success, error, null, true, (isRepoFile &&
                err != null) ? err.commitMessage : null);
        }
    });

    var synchronize = mxUtils.bind(this, function () {
        if (this.ui.spinner.spin(document.body, mxResources.get('updatingDocument'))) {
            this.synchronizeFile(mxUtils.bind(this, function () {
                this.ui.spinner.stop();

                if (this.ui.spinner.spin(document.body, mxResources.get('saving'))) {
                    var isRepoFile = (this.constructor == GitHubFile) || (this.constructor == GitLabFile);
                    this.save(true, success, error, null, null, (isRepoFile &&
                        err != null) ? err.commitMessage : null);
                }
            }), error);
        }
    })

    if (DrawioFile.SYNC == 'none') {
        this.showCopyDialog(success, error, overwrite);
    } else if (this.invalidChecksum) {
        this.showRefreshDialog(success, error, this.getErrorMessage(err));
    } else if (manual) {
        this.showConflictDialog(overwrite, synchronize);
    } else {
        this.addConflictStatus(mxUtils.bind(this, function () {
            this.ui.editor.setStatus(mxUtils.htmlEntities(
                mxResources.get('updatingDocument')));
            this.synchronizeFile(success, error);
        }), this.getErrorMessage(err));
    }
};

/**
 * Adds the listener for automatically saving the diagram for local changes.
 */
DrawioFile.prototype.getErrorMessage = function (err) {
    return (err != null) ? ((err.error != null) ? err.error.message : err.message) : null
};

/**
 * Returns true if the oldest unsaved change is older than <EditorUi.warnInterval>.
 */
DrawioFile.prototype.isOverdue = function () {
    return this.ageStart != null && (Date.now() - this.ageStart.getTime()) >= this.ui.warnInterval;
};

/**
 * Adds the listener for automatically saving the diagram for local changes.
 */
DrawioFile.prototype.fileChanged = function () {
    this.lastChanged = new Date();
    this.setModified(true);

    if (this.isAutosave()) {
        this.addAllSavedStatus(mxUtils.htmlEntities(mxResources.get('saving')) + '...');
        this.ui.scheduleSanityCheck();

        if (this.ageStart == null) {
            this.ageStart = new Date();
        }
        this.autosave(this.autosaveDelay, this.maxAutosaveDelay, mxUtils.bind(this, function (resp) {
            this.ui.stopSanityCheck();

            // Does not update status if another autosave was scheduled
            if (this.autosaveThread == null) {
                this.handleFileSuccess(true);
                this.ageStart = null;
            } else if (this.isModified()) {
                this.ui.scheduleSanityCheck();
                this.ageStart = this.lastChanged;
            }
        }), mxUtils.bind(this, function (err) {
            this.handleFileError(err);
        }));
    } else {
        this.ageStart = null;

        if ((!this.isAutosaveOptional() || !this.ui.editor.autosave) &&
            !this.inConflictState) {
            this.addUnsavedStatus();
        }
    }
};

/**
 * Invokes sync and updates shadow document.
 */
DrawioFile.prototype.fileSaved = function (savedData, lastDesc, success, error) {
    this.lastSaved = new Date();
    this.ageStart = null;

    try {
        this.stats.saved++;
        this.inConflictState = false;
        this.invalidChecksum = false;

        if (this.sync == null) {
            this.shadowData = savedData;
            this.shadowPages = null;

            if (success != null) {
                success();
            }
        } else {
            this.sync.fileSaved(this.ui.getPagesForNode(
                mxUtils.parseXml(savedData).documentElement),
                lastDesc, success, error, savedData);
        }
    } catch (e) {
        this.inConflictState = true;
        this.invalidChecksum = true;
        this.descriptorChanged();

        if (error != null) {
            error(e);
        }

        try {
            if (this.errorReportsEnabled) {
                this.sendErrorReport('Error in fileSaved', null, e);
            } else {
                var user = this.getCurrentUser();
                var uid = (user != null) ? user.id : 'unknown';

                EditorUi.logError('Error in fileSaved', null,
                    this.getMode() + '.' + this.getId(),
                    uid, e);
            }
        } catch (e2) {
            // ignore
        }
    }
};

/**
 * Adds the listener for automatically saving the diagram for local changes.
 */
DrawioFile.prototype.autosave = function (delay, maxDelay, success, error) {
    if (this.lastAutosave == null) {
        this.lastAutosave = Date.now();
    }

    var tmp = (Date.now() - this.lastAutosave < maxDelay) ? delay : 0;
    this.clearAutosave();

    // Starts new timer or executes immediately if not unsaved for maxDelay
    var thread = window.setTimeout(mxUtils.bind(this, function () {
        this.lastAutosave = null;

        if (this.autosaveThread == thread) {
            this.autosaveThread = null;
        }

        // Workaround for duplicate save if UI is blocking
        // after save while pending autosave triggers
        if (this.isModified() && this.isAutosaveNow()) {
            var rev = this.isAutosaveRevision();

            if (rev) {
                this.lastAutosaveRevision = new Date().getTime();
            }
            this.save(rev, mxUtils.bind(this, function (resp) {
                this.autosaveCompleted();

                if (success != null) {
                    success(resp);
                }
            }), mxUtils.bind(this, function (resp) {
                if (error != null) {
                    error(resp);
                }
            }));
        } else {
            if (!this.isModified()) {
                this.ui.editor.setStatus('');
            }

            if (success != null) {
                success(null);
            }
        }
    }), tmp);

    this.autosaveThread = thread;
};

/**
 * Returns true if an autosave is required at the time of execution.
 * This implementation returns true.
 */
DrawioFile.prototype.isAutosaveNow = function () {
    return true;
};

/**
 * Hooks for subclassers after the autosave has completed.
 */
DrawioFile.prototype.autosaveCompleted = function () {
};

/**
 * Adds the listener for automatically saving the diagram for local changes.
 */
DrawioFile.prototype.clearAutosave = function () {
    if (this.autosaveThread != null) {
        window.clearTimeout(this.autosaveThread);
        this.autosaveThread = null;
    }
};

/**
 * Returns the location as a new object.
 * @type mx.Point
 */
DrawioFile.prototype.isAutosaveRevision = function () {
    var now = new Date().getTime();

    return (this.lastAutosaveRevision == null) || (now - this.lastAutosaveRevision) > this.maxAutosaveRevisionDelay;
};

/**
 * Translates this point by the given vector.
 *
 * @param {number} dx X-coordinate of the translation.
 * @param {number} dy Y-coordinate of the translation.
 */
DrawioFile.prototype.descriptorChanged = function () {
    this.fireEvent(new mxEventObject('descriptorChanged'));
};

/**
 * Translates this point by the given vector.
 *
 * @param {number} dx X-coordinate of the translation.
 * @param {number} dy Y-coordinate of the translation.
 */
DrawioFile.prototype.contentChanged = function () {
    this.fireEvent(new mxEventObject('contentChanged'));
};

/**
 * Returns the location as a new object.
 */
DrawioFile.prototype.close = function (unloading) {
    this.updateFileData();
    this.stats.closed++;

    if (this.isAutosave() && this.isModified()) {
        this.save(this.isAutosaveRevision(), null, null, unloading);
    }

    this.destroy();
};

/**
 * Returns the location as a new object.
 */
DrawioFile.prototype.hasSameExtension = function (title, newTitle) {
    if (title != null && newTitle != null) {
        var dot = title.lastIndexOf('.');
        var ext = (dot > 0) ? title.substring(dot) : '';
        dot = newTitle.lastIndexOf('.');

        return ext === ((dot > 0) ? newTitle.substring(dot) : '');
    }

    return title == newTitle;
};

/**
 * Removes the change listener.
 */
DrawioFile.prototype.removeListeners = function () {
    if (this.changeListener != null) {
        this.ui.editor.graph.model.removeListener(this.changeListener);
        this.ui.editor.graph.removeListener(this.changeListener);
        this.ui.removeListener(this.changeListener);
        this.changeListener = null;
    }
};

/**
 * Stops any pending autosaves and removes all listeners.
 */
DrawioFile.prototype.destroy = function () {
    this.stats.destroyed++;

//	try
//	{
//		if (!this.ui.isOffline() && this.reportEnabled &&
//			(DrawioFile.SYNC == 'auto' ||
//			DrawioFile.SYNC == 'manual'))
//		{
//			var user = this.getCurrentUser();
//			var uid = (user != null) ? user.id : 'unknown';
//		
//			EditorUi.logEvent({category: DrawioFile.SYNC + '-DESTROY-FILE-' + DrawioFile.SYNC,
//				action: 'file-' + this.getId() +
//				'-mode-' + this.getMode() +
//				'-size-' + this.getSize() +
//				'-user-' + uid +
//				((this.sync != null) ? ('-client-' + this.sync.clientId ) : ''),
//				label: this.stats});
//		}
//	}
//	catch (e)
//	{
//		// ignore
//	}

    this.clearAutosave();
    this.removeListeners();

    if (this.sync != null) {
        this.sync.destroy();
        this.sync = null;
    }
};

/**
 * Are comments supported
 */
DrawioFile.prototype.commentsSupported = function () {
    return false; //The default is false and files that support it must explicitly state that
};

/**
 * Show refresh button?
 */
DrawioFile.prototype.commentsRefreshNeeded = function () {
    return true;
};

/**
 * Show save button?
 */
DrawioFile.prototype.commentsSaveNeeded = function () {
    return false;
};

/**
 * Get comments of the file
 */
DrawioFile.prototype.getComments = function (success, error) {
    success([]); //placeholder
};

/**
 * Add a comment to the file
 */
DrawioFile.prototype.addComment = function (comment, success, error) {
    success(Date.now()); //placeholder
};

/**
 * Can add a reply to a reply
 */
DrawioFile.prototype.canReplyToReplies = function () {
    return true;
};

/**
 * Can add comments (The permission to comment to this file)
 */
DrawioFile.prototype.canComment = function () {
    return true;
};

/**
 * Get a new comment object
 */
DrawioFile.prototype.newComment = function (content, user) {
    return new DrawioComment(this, null, content, Date.now(), Date.now(), false, user);
};

// $Id = LocalFile.js,v 1.12 2010-01-02 09 =45 =14 gaudenz Exp $
// Copyright (c) 2006-2014, JGraph Ltd
/**
 * Constructs a new point for the optional x and y coordinates. If no
 * coordinates are given, then the default values for <x> and <y> are used.
 * @constructor
 * @class Implements a basic 2D point. Known subclassers = {@link mxRectangle}.
 * @param {number} x X-coordinate of the point.
 * @param {number} y Y-coordinate of the point.
 */
LocalFile = function (ui, data, title, temp) {
    DrawioFile.call(this, ui, data);

    this.title = title;
    this.mode = (temp) ? null : App.MODE_DEVICE;
};

//Extends mxEventSource
mxUtils.extend(LocalFile, DrawioFile);

/**
 * Translates this point by the given vector.
 *
 * @param {number} dx X-coordinate of the translation.
 * @param {number} dy Y-coordinate of the translation.
 */
LocalFile.prototype.isAutosave = function () {
    return false;
};

/**
 * Translates this point by the given vector.
 *
 * @param {number} dx X-coordinate of the translation.
 * @param {number} dy Y-coordinate of the translation.
 */
LocalFile.prototype.getMode = function () {
    return this.mode;
};

/**
 * Translates this point by the given vector.
 *
 * @param {number} dx X-coordinate of the translation.
 * @param {number} dy Y-coordinate of the translation.
 */
LocalFile.prototype.getTitle = function () {
    return this.title;
};

/**
 * Translates this point by the given vector.
 *
 * @param {number} dx X-coordinate of the translation.
 * @param {number} dy Y-coordinate of the translation.
 */
LocalFile.prototype.isRenamable = function () {
    return true;
};

/**
 * Translates this point by the given vector.
 *
 * @param {number} dx X-coordinate of the translation.
 * @param {number} dy Y-coordinate of the translation.
 */
LocalFile.prototype.save = function (revision, success, error) {
    this.saveAs(this.title, success, error);
};

/**
 * Translates this point by the given vector.
 *
 * @param {number} dx X-coordinate of the translation.
 * @param {number} dy Y-coordinate of the translation.
 */
LocalFile.prototype.saveAs = function (title, success, error) {
    this.saveFile(title, false, success, error);
};

/**
 * Translates this point by the given vector.
 *
 * @param {number} dx X-coordinate of the translation.
 * @param {number} dy Y-coordinate of the translation.
 */
LocalFile.prototype.saveFile = function (title, revision, success, error) {
    this.title = title;

    // Updates data after changing file name
    this.updateFileData();
    var data = this.getData();
    var binary = this.ui.useCanvasForExport && /(\.png)$/i.test(this.getTitle());

    var doSave = mxUtils.bind(this, function (data) {
        if (this.ui.isOfflineApp() || this.ui.isLocalFileSave()) {
            this.ui.doSaveLocalFile(data, title, (binary) ?
                'image/png' : 'text/xml', binary);
        } else {
            if (data.length < MAX_REQUEST_SIZE) {
                var dot = title.lastIndexOf('.');
                var format = (dot > 0) ? title.substring(dot + 1) : 'xml';

                // Do not update modified flag
                new mxXmlRequest(SAVE_URL, 'format=' + format +
                    '&xml=' + encodeURIComponent(data) +
                    '&filename=' + encodeURIComponent(title) +
                    ((binary) ? '&binary=1' : '')).simulate(document, '_blank');
            } else {
                this.ui.handleError({message: mxResources.get('drawingTooLarge')}, mxResources.get('error'), mxUtils.bind(this, function () {
                    mxUtils.popup(data);
                }));
            }
        }

        this.setModified(false);
        this.contentChanged();

        if (success != null) {
            success();
        }
    });

    if (binary) {
        this.ui.getEmbeddedPng(mxUtils.bind(this, function (imageData) {
            doSave(imageData);
        }), error, (this.ui.getCurrentFile() != this) ? this.getData() : null);
    } else {
        doSave(data);
    }
};

/**
 * Translates this point by the given vector.
 *
 * @param {number} dx X-coordinate of the translation.
 * @param {number} dy Y-coordinate of the translation.
 */
LocalFile.prototype.rename = function (title, success, error) {
    this.title = title;
    this.descriptorChanged();

    if (success != null) {
        success();
    }
};

/**
 * Returns the location as a new object.
 * @type mx.Point
 */
LocalFile.prototype.open = function () {
    this.ui.setFileData(this.getData());
    this.installListeners();
};

// $Id = DriveFile.js,v 1.12 2010-01-02 09 =45 =14 gaudenz Exp $
// Copyright (c) 2006-2014, JGraph Ltd
/**
 * Constructs a new point for the optional x and y coordinates. If no
 * coordinates are given, then the default values for <x> and <y> are used.
 * @constructor
 * @class Implements a basic 2D point. Known subclassers = {@link mxRectangle}.
 * @param {number} x X-coordinate of the point.
 * @param {number} y Y-coordinate of the point.
 */
LocalLibrary = function (ui, data, title) {
    LocalFile.call(this, ui, data, title);
};

//Extends mxEventSource
mxUtils.extend(LocalLibrary, LocalFile);

/**
 * Translates this point by the given vector.
 *
 * @param {number} dx X-coordinate of the translation.
 * @param {number} dy Y-coordinate of the translation.
 */
LocalLibrary.prototype.getHash = function () {
    return 'F' + this.getTitle();
};

/**
 * Translates this point by the given vector.
 *
 * @param {number} dx X-coordinate of the translation.
 * @param {number} dy Y-coordinate of the translation.
 */
LocalLibrary.prototype.isAutosave = function () {
    return false;
};

/**
 * Translates this point by the given vector.
 *
 * @param {number} dx X-coordinate of the translation.
 * @param {number} dy Y-coordinate of the translation.
 */
LocalLibrary.prototype.saveAs = function (title, success, error) {
    this.saveFile(title, false, success, error);
};

/**
 * Translates this point by the given vector.
 *
 * @param {number} dx X-coordinate of the translation.
 * @param {number} dy Y-coordinate of the translation.
 */
LocalLibrary.prototype.updateFileData = function () {
    // Do nothing
};

/**
 * Returns the location as a new object.
 * @type mx.Point
 */
LocalLibrary.prototype.open = function () {
    // Do nothing - this should never be called
};

/**
 * Copyright (c) 2006-2017, JGraph Ltd
 * Copyright (c) 2006-2017, Gaudenz Alder
 */
/**
 * Constructs a new point for the optional x and y coordinates. If no
 * coordinates are given, then the default values for <x> and <y> are used.
 * @constructor
 * @class Implements a basic 2D point. Known subclassers = {@link mxRectangle}.
 * @param {number} x X-coordinate of the point.
 * @param {number} y Y-coordinate of the point.
 */
StorageFile = function (ui, data, title) {
    DrawioFile.call(this, ui, data);

    this.title = title;
};

//Extends mxEventSource
mxUtils.extend(StorageFile, DrawioFile);

/**
 * Sets the delay for autosave in milliseconds. Default is 2000.
 */
StorageFile.prototype.autosaveDelay = 2000;

/**
 * Sets the delay for autosave in milliseconds. Default is 20000.
 */
StorageFile.prototype.maxAutosaveDelay = 20000;

/**
 * Translates this point by the given vector.
 *
 * @param {number} dx X-coordinate of the translation.
 * @param {number} dy Y-coordinate of the translation.
 */
StorageFile.prototype.getMode = function () {
    return App.MODE_BROWSER;
};

/**
 * Overridden to enable the autosave option in the document properties dialog.
 */
StorageFile.prototype.isAutosaveOptional = function () {
    return true;
};

/**
 * Translates this point by the given vector.
 *
 * @param {number} dx X-coordinate of the translation.
 * @param {number} dy Y-coordinate of the translation.
 */
StorageFile.prototype.getHash = function () {
    return 'L' + encodeURIComponent(this.getTitle());
};

/**
 * Translates this point by the given vector.
 *
 * @param {number} dx X-coordinate of the translation.
 * @param {number} dy Y-coordinate of the translation.
 */
StorageFile.prototype.getTitle = function () {
    return this.title;
};

/**
 * Translates this point by the given vector.
 *
 * @param {number} dx X-coordinate of the translation.
 * @param {number} dy Y-coordinate of the translation.
 */
StorageFile.prototype.isRenamable = function () {
    return true;
};

/**
 * Translates this point by the given vector.
 *
 * @param {number} dx X-coordinate of the translation.
 * @param {number} dy Y-coordinate of the translation.
 */
StorageFile.prototype.save = function (revision, success, error) {
    this.saveAs(this.getTitle(), success, error);
};

/**
 * Translates this point by the given vector.
 *
 * @param {number} dx X-coordinate of the translation.
 * @param {number} dy Y-coordinate of the translation.
 */
StorageFile.prototype.saveAs = function (title, success, error) {
    DrawioFile.prototype.save.apply(this, arguments);
    this.saveFile(title, false, success, error);
};

/**
 * Translates this point by the given vector.
 *
 * @param {number} dx X-coordinate of the translation.
 * @param {number} dy Y-coordinate of the translation.
 */
StorageFile.prototype.saveFile = function (title, revision, success, error) {
    if (!this.isEditable()) {
        if (success != null) {
            success();
        }
    } else {
        var fn = mxUtils.bind(this, function () {
            if (this.isRenamable()) {
                this.title = title;
            }

            try {
                this.ui.setLocalData(this.title, this.getData(), mxUtils.bind(this, function () {
                    this.setModified(false);
                    this.contentChanged();

                    if (success != null) {
                        success();
                    }
                }));
            } catch (e) {
                if (error != null) {
                    error(e);
                }
            }
        });

        // Checks for trailing dots
        if (this.isRenamable() && title.charAt(0) == '.' && error != null) {
            error({message: mxResources.get('invalidName')});
        } else {
            this.ui.getLocalData(title, mxUtils.bind(this, function (data) {
                if (!this.isRenamable() || this.getTitle() == title || data == null) {
                    fn();
                } else {
                    this.ui.confirm(mxResources.get('replaceIt', [title]), fn, error);
                }
            }));
        }
    }
};

/**
 * Translates this point by the given vector.
 *
 * @param {number} dx X-coordinate of the translation.
 * @param {number} dy Y-coordinate of the translation.
 */
StorageFile.prototype.rename = function (title, success, error) {
    var oldTitle = this.getTitle();

    if (oldTitle != title) {
        this.ui.getLocalData(title, mxUtils.bind(this, function (data) {
            var fn = mxUtils.bind(this, function () {
                this.title = title;

                // Updates the data if the extension has changed
                if (!this.hasSameExtension(oldTitle, title)) {
                    this.setData(this.ui.getFileData());
                }

                this.saveFile(title, false, mxUtils.bind(this, function () {
                    this.ui.removeLocalData(oldTitle, success);
                }), error);
            });

            if (data != null) {
                this.ui.confirm(mxResources.get('replaceIt', [title]), fn, error);
            } else {
                fn();
            }
        }));
    } else {
        success();
    }
};

/**
 * Returns the location as a new object.
 * @type mx.Point
 */
StorageFile.prototype.open = function () {
    DrawioFile.prototype.open.apply(this, arguments);

    // Immediately creates the storage entry
    this.saveFile(this.getTitle());
};

/**
 * Adds the listener for automatically saving the diagram for local changes.
 */
StorageFile.prototype.getLatestVersion = function (success, error) {
    this.ui.getLocalData(this.title, mxUtils.bind(this, function (data) {
        success(new StorageFile(this.ui, data, this.title));
    }));
};

/**
 * Stops any pending autosaves and removes all listeners.
 */
StorageFile.prototype.destroy = function () {
    DrawioFile.prototype.destroy.apply(this, arguments);

    if (this.storageListener != null) {
        mxEvent.removeListener(window, 'storage', this.storageListener);
        this.storageListener = null;
    }
};

/**
 * Copyright (c) 2006-2017, JGraph Ltd
 * Copyright (c) 2006-2017, Gaudenz Alder
 */
/**
 * Constructs a new point for the optional x and y coordinates. If no
 * coordinates are given, then the default values for <x> and <y> are used.
 * @constructor
 * @class Implements a basic 2D point. Known subclassers = {@link mxRectangle}.
 * @param {number} x X-coordinate of the point.
 * @param {number} y Y-coordinate of the point.
 */
StorageLibrary = function (ui, data, title) {
    StorageFile.call(this, ui, data, title);
};

//Extends mxEventSource
mxUtils.extend(StorageLibrary, StorageFile);

/**
 * Translates this point by the given vector.
 *
 * @param {number} dx X-coordinate of the translation.
 * @param {number} dy Y-coordinate of the translation.
 */
StorageLibrary.prototype.isAutosave = function () {
    return true;
};

/**
 * Overridden to avoid updating data with current file.
 */
StorageLibrary.prototype.saveAs = function (title, success, error) {
    this.saveFile(title, false, success, error);
};

/**
 * Translates this point by the given vector.
 *
 * @param {number} dx X-coordinate of the translation.
 * @param {number} dy Y-coordinate of the translation.
 */
StorageLibrary.prototype.getHash = function () {
    return 'L' + encodeURIComponent(this.title);
};

/**
 * Translates this point by the given vector.
 *
 * @param {number} dx X-coordinate of the translation.
 * @param {number} dy Y-coordinate of the translation.
 */
StorageLibrary.prototype.getTitle = function () {
    return (this.title == '.scratchpad') ? mxResources.get('scratchpad') : this.title;
};

/**
 * Overridden to avoid updating data with current file.
 */
StorageLibrary.prototype.isRenamable = function (title, success, error) {
    return this.title != '.scratchpad';
};

/**
 * Returns the location as a new object.
 * @type mx.Point
 */
StorageLibrary.prototype.open = function () {
    // Do nothing - this should never be called
};

/**
 * Copyright (c) 2006-2019, JGraph Ltd
 * Copyright (c) 2006-2019, draw.io AG
 */

var StorageDialog = function (editorUi, fn, rowLimit) {
    rowLimit = (rowLimit != null) ? rowLimit : 2;

    var div = document.createElement('div');
    div.style.textAlign = 'center';
    div.style.whiteSpace = 'nowrap';
    div.style.paddingTop = '0px';
    div.style.paddingBottom = '20px';

    var elt = editorUi.addLanguageMenu(div, true);
    var bottom = '28px';

    if (elt != null) {
        elt.style.bottom = parseInt(bottom) - 3 + 'px';
    }

    if (!editorUi.isOffline() && editorUi.getServiceCount() > 1) {
        var help = document.createElement('a');
        help.setAttribute('href', 'https://about.draw.io/support/');
        help.setAttribute('title', mxResources.get('help'));
        help.setAttribute('target', '_blank');
        help.style.position = 'absolute';
        help.style.userSelect = 'none';
        help.style.textDecoration = 'none';
        help.style.cursor = 'pointer';
        help.style.fontSize = '12px';
        help.style.bottom = bottom;
        help.style.left = '26px';
        help.style.color = 'gray';

        var icon = document.createElement('img');
        mxUtils.setOpacity(icon, 50);
        icon.style.height = '16px';
        icon.style.width = '16px';
        icon.setAttribute('border', '0');
        icon.setAttribute('valign', 'bottom');
        icon.setAttribute('src', Editor.helpImage);
        icon.style.marginRight = '2px';
        help.appendChild(icon);

        mxUtils.write(help, mxResources.get('help'));

        div.appendChild(help);
    }

    var demo = document.createElement('div');
    demo.style.position = 'absolute';
    demo.style.cursor = 'pointer';
    demo.style.fontSize = '12px';
    demo.style.bottom = bottom;
    demo.style.color = 'gray';
    demo.style.userSelect = 'none';

    mxUtils.write(demo, mxResources.get('decideLater'));
    mxUtils.setPrefixedStyle(demo.style, 'transform', 'translate(-50%,0)');
    demo.style.left = '50%';

    if (editorUi.isOfflineApp()) {
        demo.style.bottom = '28px';
    }

    this.init = function () {
        if (mxClient.IS_QUIRKS || document.documentMode == 8) {
            demo.style.marginLeft = -Math.round(demo.clientWidth / 2) + 'px';
        }
    };

    div.appendChild(demo);

    mxEvent.addListener(demo, 'click', function () {
        editorUi.hideDialog();
        var prev = Editor.useLocalStorage;
        editorUi.createFile(editorUi.defaultFilename, null, null, null, null, null, null, true);
        Editor.useLocalStorage = prev;
    });

    var buttons = document.createElement('div');

    if (mxClient.IS_QUIRKS) {
        buttons.style.whiteSpace = 'nowrap';
        buttons.style.cssFloat = 'left';
    }

    buttons.style.border = '1px solid #d3d3d3';
    buttons.style.borderWidth = '1px 0px 1px 0px';
    buttons.style.padding = '12px 0px 12px 0px';

    var cb = document.createElement('input');
    cb.setAttribute('type', 'checkbox');
    cb.setAttribute('checked', 'checked');
    cb.defaultChecked = true;
    var count = 0;

    var container = document.createElement('div');
    container.style.paddingTop = '2px';
    buttons.appendChild(container);
    var p3 = document.createElement('p');

    function addLogo(img, title, mode, clientName, labels, clientFn) {
        if (++count > rowLimit) {
            mxUtils.br(container);
            count = 0;
        }

        var button = document.createElement('a');
        button.style.overflow = 'hidden';
        button.style.display = (mxClient.IS_QUIRKS) ? 'inline' : 'inline-block';
        button.className = 'geBaseButton';
        button.style.boxSizing = 'border-box';
        button.style.fontSize = '11px';
        button.style.position = 'relative';
        button.style.margin = '4px';
        button.style.marginTop = '2px';
        button.style.padding = '8px 10px 12px 10px';
        button.style.width = '88px';
        button.style.height = (StorageDialog.extended) ? '50px' : '100px';
        button.style.whiteSpace = 'nowrap';
        button.setAttribute('title', title);

        // Workaround for quirks is a vertical list (limited to max 2 items)
        if (mxClient.IS_QUIRKS) {
            button.style.cssFloat = 'left';
            button.style.zoom = '1';
        }

        var label = document.createElement('div');
        label.style.textOverflow = 'ellipsis';
        label.style.overflow = 'hidden';

        if (img != null) {
            var logo = document.createElement('img');
            logo.setAttribute('src', img);
            logo.setAttribute('border', '0');
            logo.setAttribute('align', 'absmiddle');
            logo.style.width = (StorageDialog.extended) ? '24px' : '60px';
            logo.style.height = (StorageDialog.extended) ? '24px' : '60px';
            logo.style.paddingBottom = (StorageDialog.extended) ? '4px' : '6px';

            button.appendChild(logo);
        } else {
            label.style.paddingTop = '5px';
            label.style.whiteSpace = 'normal';

            // Handles special case
            if (mxClient.IS_IOS) {
                button.style.padding = '0px 10px 20px 10px';
                button.style.top = '6px';
            } else if (mxClient.IS_FF) {
                label.style.paddingTop = '0px';
                label.style.marginTop = '-2px';
            }
        }

        if (StorageDialog.extended) {
            button.style.paddingTop = '4px';
            button.style.marginBottom = '0px';
            label.display = 'inline-block';

            if (rowLimit == 2) {
                logo.style.width = '38px';
                logo.style.height = '38px';
                button.style.width = '80px';
                button.style.height = '68px';
            }
        }

        button.appendChild(label);
        mxUtils.write(label, title);

        if (labels != null) {
            for (var i = 0; i < labels.length; i++) {
                mxUtils.br(label);
                mxUtils.write(label, labels[i]);
            }
        }

        function initButton() {
            mxEvent.addListener(button, 'click', (clientFn != null) ? clientFn : function () {
                // Special case: Redirect all drive users to draw.io pro
                editorUi.setMode(mode, cb.checked);
                fn();
            });
        };

        // Supports lazy loading
        if (clientName != null && editorUi[clientName] == null) {
            logo.style.visibility = 'hidden';
            mxUtils.setOpacity(label, 10);
            var size = 12;

            var spinner = new Spinner({
                lines: 12, // The number of lines to draw
                length: size, // The length of each line
                width: 5, // The line thickness
                radius: 10, // The radius of the inner circle
                rotate: 0, // The rotation offset
                color: (uiTheme == 'dark') ? '#c0c0c0' : '#000', // #rgb or #rrggbb
                speed: 1.5, // Rounds per second
                trail: 60, // Afterglow percentage
                shadow: false, // Whether to render a shadow
                hwaccel: false, // Whether to use hardware acceleration
                top: '40%',
                zIndex: 2e9 // The z-index (defaults to 2000000000)
            });
            spinner.spin(button);

            // Timeout after 30 secs
            var timeout = window.setTimeout(function () {
                if (editorUi[clientName] == null) {
                    spinner.stop();
                    button.style.display = 'none';
                }
            }, 30000);

            editorUi.addListener('clientLoaded', mxUtils.bind(this, function (sender, evt) {
                if (editorUi[clientName] != null && evt.getProperty('client') == editorUi[clientName]) {
                    window.clearTimeout(timeout);
                    mxUtils.setOpacity(label, 100);
                    logo.style.visibility = '';
                    spinner.stop();
                    initButton();

                    if (clientName == 'drive' && p3.parentNode != null) {
                        p3.parentNode.removeChild(p3);
                    }
                }
            }));
        } else {
            initButton();
        }

        container.appendChild(button);
    };

    var hd = document.createElement('p');
    hd.style.fontSize = '16pt';
    hd.style.padding = '0px';
    hd.style.paddingTop = '4px';
    hd.style.paddingBottom = '16px';
    hd.style.margin = '0px';
    hd.style.color = 'gray';
    mxUtils.write(hd, mxResources.get('saveDiagramsTo') + ':');
    div.appendChild(hd);

    var addButtons = function () {
        count = 0;

        addLogo(IMAGE_PATH + '/osa_drive-harddisk.png', mxResources.get('device'), App.MODE_DEVICE);

        if (isLocalStorage && (urlParams['browser'] == '1' || urlParams['offline'] == '1')) {
            addLogo(IMAGE_PATH + '/osa_database.png', mxResources.get('browser'), App.MODE_BROWSER);
        }

        if (StorageDialog.extended) {
        }
    };

    div.appendChild(buttons);
    addButtons();

    var p2 = document.createElement('p');
    p2.style.marginTop = '8px';
    p2.style.marginBottom = '6px';

    var temp = document.createElement('div');
    temp.style.marginBottom = '10px';

    if (!editorUi.isOfflineApp()) {
        var showMore = document.createElement('a');
        showMore.style.color = 'gray';
        showMore.style.fontSize = '12px';
        showMore.style.cursor = 'pointer';
        showMore.style.userSelect = 'none';
        mxUtils.write(showMore, ((StorageDialog.extended) ? mxResources.get('showLess') : mxResources.get('showMore')) + '...');

        temp.appendChild(showMore);
        p2.appendChild(temp);

        mxEvent.addListener(showMore, 'click', function (evt) {
            container.innerHTML = '';
            showMore.innerHTML = '';
            StorageDialog.extended = !StorageDialog.extended;
            addButtons();
            mxUtils.write(showMore, ((StorageDialog.extended) ? mxResources.get('showLess') : mxResources.get('showMore')) + '...');
            mxEvent.consume(evt);
        });
    }

    p2.appendChild(cb);

    var span = document.createElement('span');
    span.style.color = 'gray';
    span.style.fontSize = '12px';
    span.style.userSelect = 'none';
    mxUtils.write(span, ' ' + mxResources.get('rememberThisSetting'));
    p2.appendChild(span);
    mxUtils.br(p2);

    var recent = editorUi.getRecent();

    if (!editorUi.isOfflineApp() && recent != null && recent.length > 0) {
        var recentSelect = document.createElement('select');
        recentSelect.style.marginTop = '8px';
        recentSelect.style.maxWidth = '170px';

        var titleOption = document.createElement('option');
        titleOption.setAttribute('value', '');
        titleOption.setAttribute('selected', 'selected');
        titleOption.style.textAlign = 'center';
        mxUtils.write(titleOption, mxResources.get('openRecent') + '...');
        recentSelect.appendChild(titleOption);

        for (var i = 0; i < recent.length; i++) {
            (function (entry) {
                var modeKey = entry.mode;

                var entryOption = document.createElement('option');
                entryOption.setAttribute('value', entry.id);
                mxUtils.write(entryOption, entry.title + ' (' + mxResources.get(modeKey) + ')');
                recentSelect.appendChild(entryOption);
            })(recent[i]);
        }

        p2.appendChild(recentSelect);

        mxEvent.addListener(recentSelect, 'change', function (evt) {
            if (recentSelect.value != '') {
                editorUi.loadFile(recentSelect.value);
            }
        });
    } else {
        p2.style.marginTop = '20px';
        buttons.style.padding = '30px 0px 26px 0px';
    }

    if (Graph.fileSupport) {
        var temp = document.createElement('div');
        temp.style.marginBottom = '10px';
        temp.style.padding = '18px 0px 6px 0px';

        var link = document.createElement('a');
        link.style.cursor = 'pointer';
        link.style.fontSize = '12px';
        link.style.color = 'gray';
        link.style.userSelect = 'none';

        mxUtils.write(link, mxResources.get('import') + ': ' + mxResources.get('gliffy') + ', ' +
            mxResources.get('formatVssx') + ', ' + mxResources.get('formatVsdx') + ', ' +
            mxResources.get('lucidchart') + '...');

        mxEvent.addListener(link, 'click', function () {
            if (editorUi.storageFileInputElt == null) {
                var input = document.createElement('input');
                input.setAttribute('type', 'file');

                mxEvent.addListener(input, 'change', function () {
                    if (input.files != null) {
                        // Using null for position will disable crop of input file
                        editorUi.hideDialog();
                        editorUi.openFiles(input.files, true);

                        // Resets input to force change event for same file (type reset required for IE)
                        input.type = '';
                        input.type = 'file';
                        input.value = '';
                    }
                });

                input.style.display = 'none';
                document.body.appendChild(input);
                editorUi.storageFileInputElt = input;
            }

            editorUi.storageFileInputElt.click();
        });

        temp.appendChild(link);
        p2.appendChild(temp);
        buttons.style.paddingBottom = '4px';
    }

    buttons.appendChild(p2);

    mxEvent.addListener(span, 'click', function (evt) {
        cb.checked = !cb.checked;
        mxEvent.consume(evt);
    });

    // Checks if Google Drive is missing after a 5 sec delay
    if (mxClient.IS_SVG && isLocalStorage && urlParams['gapi'] != '0' &&
        (document.documentMode == null || document.documentMode >= 10)) {
        window.setTimeout(function () {
            if (editorUi.drive == null) {
                // To check for Disconnect plugin in chrome use mxClient.IS_GC and check for URL:
                // chrome-extension://jeoacafpbcihiomhlakheieifhpjdfeo/scripts/vendor/jquery/jquery-2.0.3.min.map
                p3.style.padding = '8px';
                p3.style.fontSize = '9pt';
                p3.style.marginTop = '-14px';
                p3.innerHTML = '<a style="background-color:#dcdcdc;padding:5px;color:black;text-decoration:none;" ' +
                    'href="https://desk.draw.io/a/solutions/articles/16000074659" target="_blank">' +
                    '<img border="0" src="' + mxGraph.prototype.warningImage.src + '" align="top"> ' +
                    mxResources.get('googleDriveMissingClickHere') + '</a>';
                div.appendChild(p3);
            }
        }, 5000);
    }

    this.container = div;
};

/**
 *
 */
StorageDialog.extended = false;

/**
 * Constructs a dialog for creating new files from templates.
 */
var SplashDialog = function (editorUi) {
    var div = document.createElement('div');
    div.style.textAlign = 'center';

    var elt = editorUi.addLanguageMenu(div, true);

    if (elt != null) {
        elt.style.bottom = '19px';
    }

    var help = null;
    var serviceCount = editorUi.getServiceCount();

    if (!editorUi.isOffline() && serviceCount > 1) {
        help = document.createElement('a');
        help.setAttribute('href', 'https://about.draw.io/support/');
        help.setAttribute('title', mxResources.get('help'));
        help.setAttribute('target', '_blank');
        help.style.position = 'absolute';
        help.style.fontSize = '12px';
        help.style.textDecoration = 'none';
        help.style.cursor = 'pointer';
        help.style.bottom = '22px';
        help.style.left = '26px';
        help.style.color = 'gray';

        var icon = document.createElement('img');
        mxUtils.setOpacity(icon, 50);
        icon.style.height = '16px';
        icon.style.width = '16px';
        icon.setAttribute('border', '0');
        icon.setAttribute('valign', 'bottom');
        icon.setAttribute('src', Editor.helpImage);
        icon.style.marginRight = '2px';
        help.appendChild(icon);

        mxUtils.write(help, mxResources.get('help'));

        div.appendChild(help);
    }

    var hd = document.createElement('p');
    hd.style.fontSize = '16pt';
    hd.style.padding = '0px';
    hd.style.paddingTop = '2px';
    hd.style.margin = '0px';
    hd.style.color = 'gray';

    var logo = document.createElement('img');
    logo.setAttribute('border', '0');
    logo.setAttribute('align', 'absmiddle');
    logo.style.width = '40px';
    logo.style.height = '40px';
    logo.style.marginRight = '12px';
    logo.style.paddingBottom = '4px';

    var service = '';

    logo.src = IMAGE_PATH + '/osa_drive-harddisk.png';
    service = mxResources.get('device');

    var buttons = document.createElement('div');
    buttons.style.margin = '4px 0px 0px 0px';

    var btn = document.createElement('button');
    btn.className = 'geBigButton';
    btn.style.fontSize = '18px';
    btn.style.padding = '10px';
    btn.style.width = '340px';

    if (!mxClient.IS_CHROMEAPP && !EditorUi.isElectronApp) {
        hd.appendChild(logo);
        mxUtils.write(hd, service);
        div.appendChild(hd);
        buttons.style.border = '1px solid #d3d3d3';
        buttons.style.borderWidth = '1px 0px 1px 0px';
        buttons.style.padding = '18px 0px 24px 0px';
        btn.style.marginBottom = '8px';
    } else {
        buttons.style.padding = '42px 0px 56px 0px';
        btn.style.marginBottom = '12px';
    }

    if (mxClient.IS_QUIRKS) {
        buttons.style.whiteSpace = 'nowrap';
        buttons.style.cssFloat = 'left';
    }

    if (mxClient.IS_QUIRKS) {
        btn.style.width = '340px';
    }

    mxUtils.write(btn, mxResources.get('createNewDiagram'));

    mxEvent.addListener(btn, 'click', function () {
        editorUi.hideDialog();
        editorUi.actions.get('new').funct();
    });

    buttons.appendChild(btn);
    mxUtils.br(buttons);

    var btn = document.createElement('button');
    btn.className = 'geBigButton';
    btn.style.marginBottom = '22px';
    btn.style.fontSize = '18px';
    btn.style.padding = '10px';
    btn.style.width = '340px';

    if (mxClient.IS_QUIRKS) {
        btn.style.width = '340px';
    }

    mxUtils.write(btn, mxResources.get('openExistingDiagram'));

    mxEvent.addListener(btn, 'click', function () {
        editorUi.actions.get('open').funct();
    });

    buttons.appendChild(btn);

    var storage = 'undefined';

    storage = mxResources.get('browser');

    if (!mxClient.IS_CHROMEAPP && !EditorUi.isElectronApp) {
        var driveUser = (editorUi.drive != null) ? editorUi.drive.getUser() : null;

        function addLogout(logout) {
            btn.style.marginBottom = '24px';

            var link = document.createElement('a');
            link.setAttribute('href', 'javascript:void(0)');
            link.style.display = 'inline-block';
            link.style.marginTop = '6px';
            mxUtils.write(link, mxResources.get('signOut'));

            // Makes room after last big buttons
            btn.style.marginBottom = '16px';
            buttons.style.paddingBottom = '18px';

            mxEvent.addListener(link, 'click', function () {
                editorUi.confirm(mxResources.get('areYouSure'), function () {
                    logout();
                });
            });

            buttons.appendChild(link);
        };

        mxUtils.br(buttons);
        var link = document.createElement('a');
        link.setAttribute('href', 'javascript:void(0)');
        link.style.display = 'inline-block';
        link.style.marginTop = '8px';
        mxUtils.write(link, mxResources.get('changeStorage'));

        mxEvent.addListener(link, 'click', function () {
            editorUi.hideDialog(false);
            editorUi.setMode(null);
            editorUi.clearMode();
            editorUi.showSplash(true);
        });

        buttons.appendChild(link);
    }

    div.appendChild(buttons);
    this.container = div;
};

/**
 * Constructs a new embed dialog
 */
var EmbedDialog = function (editorUi, result, timeout, ignoreSize, previewFn, title) {
    var div = document.createElement('div');
    var maxSize = 500000;
    var maxFbSize = 51200;
    var maxTwitterSize = 7168;

    // Checks if result is a link
    var validUrl = /^https?:\/\//.test(result) || /^mailto:\/\//.test(result);

    if (title != null) {
        mxUtils.write(div, title);
    } else {
        mxUtils.write(div, mxResources.get((result.length < maxSize) ?
            ((validUrl) ? 'link' : 'mainEmbedNotice') : 'preview') + ':');
    }
    mxUtils.br(div);

    var size = document.createElement('div');
    size.style.position = 'absolute';
    size.style.top = '30px';
    size.style.right = '30px';
    size.style.color = 'gray';
    mxUtils.write(size, editorUi.formatFileSize(result.length));

    div.appendChild(size);

    // Using DIV for faster rendering
    var text = document.createElement('textarea');
    text.setAttribute('autocomplete', 'off');
    text.setAttribute('autocorrect', 'off');
    text.setAttribute('autocapitalize', 'off');
    text.setAttribute('spellcheck', 'false');
    text.style.marginTop = '10px';
    text.style.resize = 'none';
    text.style.height = '150px';
    text.style.width = '440px';
    text.style.border = '1px solid gray';
    text.value = mxResources.get('updatingDocument');
    div.appendChild(text);
    mxUtils.br(div);

    this.init = function () {
        window.setTimeout(function () {
            if (result.length < maxSize) {
                text.value = result;
                text.focus();

                if (mxClient.IS_GC || mxClient.IS_FF || document.documentMode >= 5 || mxClient.IS_QUIRKS) {
                    text.select();
                } else {
                    document.execCommand('selectAll', false, null);
                }
            } else {
                text.setAttribute('readonly', 'true');
                text.value = result.substring(0, 340) + '... (' + mxResources.get('drawingTooLarge') + ')';
            }
        }, 0);
    };

    var buttons = document.createElement('div');
    buttons.style.position = 'absolute';
    buttons.style.bottom = '36px';
    buttons.style.right = '32px';

    var previewBtn = null;

    // Loads forever in IE9
    if (EmbedDialog.showPreviewOption && (!mxClient.IS_CHROMEAPP || validUrl) && !navigator.standalone && (validUrl ||
        (mxClient.IS_SVG && (document.documentMode == null || document.documentMode > 9)))) {
        previewBtn = mxUtils.button(mxResources.get((result.length < maxSize) ? 'preview' : 'openInNewWindow'), function () {
            var value = (result.length < maxSize) ? text.value : result;

            if (previewFn != null) {
                previewFn(value);
            } else {
                if (validUrl) {
                    try {
                        var win = editorUi.openLink(value);

                        if (win != null && (timeout == null || timeout > 0)) {
                            window.setTimeout(mxUtils.bind(this, function () {
                                if (win != null && win.location.href != null &&
                                    win.location.href.substring(0, 8) != value.substring(0, 8)) {
                                    win.close();
                                    editorUi.handleError({message: mxResources.get('drawingTooLarge')});
                                }
                            }), timeout || 500);
                        }
                    } catch (e) {
                        editorUi.handleError({message: e.message || mxResources.get('drawingTooLarge')});
                    }
                } else {
                    var wnd = window.open();
                    var doc = (wnd != null) ? wnd.document : null;

                    if (doc != null) {
                        doc.writeln('<html><head><title>' + encodeURIComponent(mxResources.get('preview')) +
                            '</title><meta charset="utf-8"></head>' +
                            '<body>' + result + '</body></html>');
                        doc.close();
                    } else {
                        editorUi.handleError({message: mxResources.get('errorUpdatingPreview')});
                    }
                }
            }
        });

        previewBtn.className = 'geBtn';
        buttons.appendChild(previewBtn);
    }

    if (!validUrl || result.length > 7500) {
        var downloadBtn = mxUtils.button(mxResources.get('download'), function () {
            editorUi.hideDialog();
            editorUi.saveData('embed.txt', 'txt', result, 'text/plain');
        });

        downloadBtn.className = 'geBtn';
        buttons.appendChild(downloadBtn);
    }

    // Twitter-intent does not allow more characters, must be pasted manually
    if (validUrl && (!editorUi.isOffline() || mxClient.IS_CHROMEAPP)) {
        if (result.length < maxFbSize) {
            var fbBtn = mxUtils.button('', function () {
                try {
                    var url = 'https://www.facebook.com/sharer.php?p[url]=' +
                        encodeURIComponent(text.value);
                    editorUi.openLink(url);
                } catch (e) {
                    editorUi.handleError({message: e.message || mxResources.get('drawingTooLarge')});
                }
            });

            var img = document.createElement('img');
            img.setAttribute('src', Editor.facebookImage);
            img.setAttribute('width', '18');
            img.setAttribute('height', '18');
            img.setAttribute('border', '0');

            fbBtn.appendChild(img);
            fbBtn.setAttribute('title', mxResources.get('facebook') + ' (' +
                editorUi.formatFileSize(maxFbSize) + ' max)');
            fbBtn.style.verticalAlign = 'bottom';
            fbBtn.style.paddingTop = '4px';
            fbBtn.style.minWidth = '46px'
            fbBtn.className = 'geBtn';
            buttons.appendChild(fbBtn);
        }

        if (result.length < maxTwitterSize) {
            var tweetBtn = mxUtils.button('', function () {
                try {
                    var url = 'https://twitter.com/intent/tweet?text=' +
                        encodeURIComponent('Check out the diagram I made using @drawio') +
                        '&url=' + encodeURIComponent(text.value);
                    editorUi.openLink(url);
                } catch (e) {
                    editorUi.handleError({message: e.message || mxResources.get('drawingTooLarge')});
                }
            });

            var img = document.createElement('img');
            img.setAttribute('src', Editor.tweetImage);
            img.setAttribute('width', '18');
            img.setAttribute('height', '18');
            img.setAttribute('border', '0');
            img.style.marginBottom = '5px'

            tweetBtn.appendChild(img);
            tweetBtn.setAttribute('title', mxResources.get('twitter') + ' (' +
                editorUi.formatFileSize(maxTwitterSize) + ' max)');
            tweetBtn.style.verticalAlign = 'bottom';
            tweetBtn.style.paddingTop = '4px';
            tweetBtn.style.minWidth = '46px'
            tweetBtn.className = 'geBtn';
            buttons.appendChild(tweetBtn);
        }
    }

    var closeBtn = mxUtils.button(mxResources.get('close'), function () {
        editorUi.hideDialog();
    });

    buttons.appendChild(closeBtn);

    var copyBtn = mxUtils.button(mxResources.get('copy'), function () {
        text.focus();

        if (mxClient.IS_GC || mxClient.IS_FF || document.documentMode >= 5 || mxClient.IS_QUIRKS) {
            text.select();
        } else {
            document.execCommand('selectAll', false, null);
        }

        document.execCommand('copy');
        editorUi.alert(mxResources.get('copiedToClipboard'));
    });

    if (result.length < maxSize) {
        // Does not work in Safari and shows annoying dialog for IE11-
        if (!mxClient.IS_SF && document.documentMode == null) {
            buttons.appendChild(copyBtn);
            copyBtn.className = 'geBtn gePrimaryBtn';
            closeBtn.className = 'geBtn';
        } else {
            closeBtn.className = 'geBtn gePrimaryBtn';
        }
    } else {
        buttons.appendChild(previewBtn);
        closeBtn.className = 'geBtn';
        previewBtn.className = 'geBtn gePrimaryBtn';
    }

    div.appendChild(buttons);
    this.container = div;
};

/**
 * Add embed dialog option.
 */
EmbedDialog.showPreviewOption = true;

/**
 * Constructs a dialog for embedding the diagram in Google Sites.
 */
var GoogleSitesDialog = function (editorUi, publicUrl) {
    var div = document.createElement('div');

    var graph = editorUi.editor.graph;
    var bounds = graph.getGraphBounds();
    var scale = graph.view.scale;
    var x0 = Math.floor(bounds.x / scale - graph.view.translate.x);
    var y0 = Math.floor(bounds.y / scale - graph.view.translate.y);

    mxUtils.write(div, mxResources.get('googleGadget') + ':');
    mxUtils.br(div);

    var gadgetInput = document.createElement('input');
    gadgetInput.setAttribute('type', 'text');
    gadgetInput.style.marginBottom = '8px';
    gadgetInput.style.marginTop = '2px';
    gadgetInput.style.width = '410px';
    div.appendChild(gadgetInput);
    mxUtils.br(div);

    this.init = function () {
        gadgetInput.focus();

        if (mxClient.IS_GC || mxClient.IS_FF || document.documentMode >= 5 || mxClient.IS_QUIRKS) {
            gadgetInput.select();
        } else {
            document.execCommand('selectAll', false, null);
        }
    };

    mxUtils.write(div, mxResources.get('top') + ':');
    var topInput = document.createElement('input');
    topInput.setAttribute('type', 'text');
    topInput.setAttribute('size', '4');
    topInput.style.marginRight = '16px';
    topInput.style.marginLeft = '4px';
    topInput.value = x0;
    div.appendChild(topInput);

    mxUtils.write(div, mxResources.get('height') + ':');
    var heightInput = document.createElement('input');
    heightInput.setAttribute('type', 'text');
    heightInput.setAttribute('size', '4');
    heightInput.style.marginLeft = '4px';
    heightInput.value = Math.ceil(bounds.height / scale);
    div.appendChild(heightInput);
    mxUtils.br(div);

    var hr = document.createElement('hr');
    hr.setAttribute('size', '1');
    hr.style.marginBottom = '16px';
    hr.style.marginTop = '16px';
    div.appendChild(hr);

    mxUtils.write(div, mxResources.get('publicDiagramUrl') + ':');
    mxUtils.br(div);

    var urlInput = document.createElement('input');
    urlInput.setAttribute('type', 'text');
    urlInput.setAttribute('size', '28');
    urlInput.style.marginBottom = '8px';
    urlInput.style.marginTop = '2px';
    urlInput.style.width = '410px';
    urlInput.value = publicUrl || '';
    div.appendChild(urlInput);
    mxUtils.br(div);

    mxUtils.write(div, mxResources.get('borderWidth') + ':');
    var borderInput = document.createElement('input');
    borderInput.setAttribute('type', 'text');
    borderInput.setAttribute('size', '3');
    borderInput.style.marginBottom = '8px';
    borderInput.style.marginLeft = '4px';
    borderInput.value = '0';
    div.appendChild(borderInput);
    mxUtils.br(div);

    var panCheckBox = document.createElement('input');
    panCheckBox.setAttribute('type', 'checkbox');
    panCheckBox.setAttribute('checked', 'checked');
    panCheckBox.defaultChecked = true;
    panCheckBox.style.marginLeft = '16px';
    div.appendChild(panCheckBox);
    mxUtils.write(div, mxResources.get('pan') + ' ');

    var zoomCheckBox = document.createElement('input');
    zoomCheckBox.setAttribute('type', 'checkbox');
    zoomCheckBox.setAttribute('checked', 'checked');
    zoomCheckBox.defaultChecked = true;
    zoomCheckBox.style.marginLeft = '8px';
    div.appendChild(zoomCheckBox);
    mxUtils.write(div, mxResources.get('zoom') + ' ');

    var editCheckBox = document.createElement('input');
    editCheckBox.setAttribute('type', 'checkbox');
    editCheckBox.style.marginLeft = '8px';
    editCheckBox.setAttribute('title', window.location.href);
    div.appendChild(editCheckBox);
    mxUtils.write(div, mxResources.get('edit') + ' ');

    var editBlankCheckBox = document.createElement('input');
    editBlankCheckBox.setAttribute('type', 'checkbox');
    editBlankCheckBox.style.marginLeft = '8px';
    div.appendChild(editBlankCheckBox);
    mxUtils.write(div, mxResources.get('asNew') + ' ');
    mxUtils.br(div);

    var resizeCheckBox = document.createElement('input');
    resizeCheckBox.setAttribute('type', 'checkbox');
    resizeCheckBox.setAttribute('checked', 'checked');
    resizeCheckBox.defaultChecked = true;
    resizeCheckBox.style.marginLeft = '16px';
    div.appendChild(resizeCheckBox);
    mxUtils.write(div, mxResources.get('resize') + ' ');

    var fitCheckBox = document.createElement('input');
    fitCheckBox.setAttribute('type', 'checkbox');
    fitCheckBox.style.marginLeft = '8px';
    div.appendChild(fitCheckBox);
    mxUtils.write(div, mxResources.get('fit') + ' ');

    var embedCheckBox = document.createElement('input');
    embedCheckBox.setAttribute('type', 'checkbox');
    embedCheckBox.style.marginLeft = '8px';
    div.appendChild(embedCheckBox);
    mxUtils.write(div, mxResources.get('embed') + ' ');

    var node = null;
    var s = editorUi.getBasenames().join(';');
    var file = editorUi.getCurrentFile();

    function update() {
        var title = (file != null && file.getTitle() != null) ? file.getTitle() : this.defaultFilename;

        if (embedCheckBox.checked && urlInput.value != '') {
            var encUrl = encodeURIComponent(mxUtils.htmlEntities(urlInput.value));
            var gurl = 'https://www.draw.io/gadget.xml?type=4&diagram=' + encUrl;

            if (title != null) {
                gurl += '&title=' + encodeURIComponent(title);
            }

            if (s.length > 0) {
                gurl += '&s=' + s;
            }

            if (borderInput.value != '' && borderInput.value != '0') {
                gurl += '&border=' + borderInput.value;
            }

            if (heightInput.value != '') {
                gurl += '&height=' + heightInput.value;
            }

            gurl += '&pan=' + ((panCheckBox.checked) ? '1' : '0');
            gurl += '&zoom=' + ((zoomCheckBox.checked) ? '1' : '0');
            gurl += '&fit=' + ((fitCheckBox.checked) ? '1' : '0');
            gurl += '&resize=' + ((resizeCheckBox.checked) ? '1' : '0');
            gurl += '&x0=' + Number(topInput.value);
            gurl += '&y0=' + y0;

            if (graph.mathEnabled) {
                gurl += '&math=1';
            }

            if (editBlankCheckBox.checked) {
                gurl += '&edit=_blank';
            } else if (editCheckBox.checked) {
                gurl += '&edit=' + encodeURIComponent(mxUtils.htmlEntities(window.location.href));
            }

            gadgetInput.value = gurl;
        } else if (file.constructor == DriveFile || file.constructor == DropboxFile) {
            var gurl = 'https://www.draw.io/gadget.xml?embed=0&diagram=';

            if (urlInput.value != '') {
                gurl += encodeURIComponent(mxUtils.htmlEntities(urlInput.value)) + '&type=3';
            } else {
                gurl += file.getHash().substring(1);

                if (file.constructor == DropboxFile) {
                    gurl += '&type=2';
                } else {
                    gurl += '&type=1';
                }
            }

            if (title != null) {
                gurl += '&title=' + encodeURIComponent(title);
            }

            if (heightInput.value != '') {
                var h = parseInt(heightInput.value) + parseInt(topInput.value);
                gurl += '&height=' + h;
            }

            gadgetInput.value = gurl;
        } else {
            gadgetInput.value = '';
        }
    };

    mxEvent.addListener(panCheckBox, 'change', update);
    mxEvent.addListener(zoomCheckBox, 'change', update);
    mxEvent.addListener(resizeCheckBox, 'change', update);
    mxEvent.addListener(fitCheckBox, 'change', update);
    mxEvent.addListener(editCheckBox, 'change', update);
    mxEvent.addListener(editBlankCheckBox, 'change', update);
    mxEvent.addListener(embedCheckBox, 'change', update);
    mxEvent.addListener(heightInput, 'change', update);
    mxEvent.addListener(topInput, 'change', update);
    mxEvent.addListener(borderInput, 'change', update);
    mxEvent.addListener(urlInput, 'change', update);
    update();

    mxEvent.addListener(gadgetInput, 'click', function () {
        gadgetInput.focus();

        if (mxClient.IS_GC || mxClient.IS_FF || document.documentMode >= 5 || mxClient.IS_QUIRKS) {
            gadgetInput.select();
        } else {
            document.execCommand('selectAll', false, null);
        }
    });

    var buttons = document.createElement('div');
    buttons.style.paddingTop = '12px';
    buttons.style.textAlign = 'right';

    var closeBtn = mxUtils.button(mxResources.get('close'), function () {
        editorUi.hideDialog();
    });
    closeBtn.className = 'geBtn gePrimaryBtn';
    buttons.appendChild(closeBtn);

    div.appendChild(buttons);

    this.container = div;
};

/**
 * Constructs a new parse dialog.
 */
var CreateGraphDialog = function (editorUi, title, type) {
    var div = document.createElement('div');
    div.style.textAlign = 'right';

    this.init = function () {
        var container = document.createElement('div');
        container.style.position = 'relative';
        container.style.border = '1px solid gray';
        container.style.width = '100%';
        container.style.height = '360px';
        container.style.overflow = 'hidden';
        container.style.marginBottom = '16px';
        mxEvent.disableContextMenu(container);
        div.appendChild(container);

        var graph = new Graph(container);

        graph.setCellsCloneable(true);
        graph.setPanning(true);
        graph.setAllowDanglingEdges(false);
        graph.connectionHandler.select = false;
        graph.view.setTranslate(20, 20);
        graph.border = 20;
        graph.panningHandler.useLeftButtonForPanning = true;

        var vertexStyle = 'rounded=1;';
        var edgeStyle = 'curved=1;';
        var startStyle = 'ellipse';

        // FIXME: Does not work in iPad
        var mxCellRendererInstallCellOverlayListeners = mxCellRenderer.prototype.installCellOverlayListeners;
        graph.cellRenderer.installCellOverlayListeners = function (state, overlay, shape) {
            mxCellRenderer.prototype.installCellOverlayListeners.apply(this, arguments);

            mxEvent.addListener(shape.node, (mxClient.IS_POINTER) ? 'pointerdown' : 'mousedown', function (evt) {
                overlay.fireEvent(new mxEventObject('pointerdown', 'event', evt, 'state', state));
            });

            if (!mxClient.IS_POINTER && mxClient.IS_TOUCH) {
                mxEvent.addListener(shape.node, 'touchstart', function (evt) {
                    overlay.fireEvent(new mxEventObject('pointerdown', 'event', evt, 'state', state));
                });
            }
        };

        graph.getAllConnectionConstraints = function () {
            return null;
        };

        // Keeps highlight behind overlays
        graph.connectionHandler.marker.highlight.keepOnTop = false;

        graph.connectionHandler.createEdgeState = function (me) {
            var edge = graph.createEdge(null, null, null, null, null, edgeStyle);

            return new mxCellState(this.graph.view, edge, this.graph.getCellStyle(edge));
        };

        // Gets the default parent for inserting new cells. This
        // is normally the first child of the root (ie. layer 0).
        var parent = graph.getDefaultParent();

        var addOverlay = mxUtils.bind(this, function (cell) {
            // Creates a new overlay with an image and a tooltip
            var overlay = new mxCellOverlay(this.connectImage, 'Add outgoing');
            overlay.cursor = 'hand';

            // Installs a handler for clicks on the overlay
            overlay.addListener(mxEvent.CLICK, function (sender, evt2) {
                // TODO: Add menu for picking next shape
                graph.connectionHandler.reset();
                graph.clearSelection();
                var geo = graph.getCellGeometry(cell);

                var v2;

                executeLayout(function () {
                    v2 = graph.insertVertex(parent, null, 'Entry', geo.x, geo.y, 80, 30, vertexStyle);
                    addOverlay(v2);
                    graph.view.refresh(v2);
                    var e1 = graph.insertEdge(parent, null, '', cell, v2, edgeStyle);
                }, function () {
                    graph.scrollCellToVisible(v2);
                });
            });

            // FIXME: Does not work in iPad (inserts loop)
            overlay.addListener('pointerdown', function (sender, eo) {
                var evt2 = eo.getProperty('event');
                var state = eo.getProperty('state');

                graph.popupMenuHandler.hideMenu();
                graph.stopEditing(false);

                var pt = mxUtils.convertPoint(graph.container,
                    mxEvent.getClientX(evt2), mxEvent.getClientY(evt2));
                graph.connectionHandler.start(state, pt.x, pt.y);
                graph.isMouseDown = true;
                graph.isMouseTrigger = mxEvent.isMouseEvent(evt2);
                mxEvent.consume(evt2);
            });

            // Sets the overlay for the cell in the graph
            graph.addCellOverlay(cell, overlay);
        });

        // Adds cells to the model in a single step
        graph.getModel().beginUpdate();
        var v1;
        try {
            v1 = graph.insertVertex(parent, null, 'Start', 0, 0, 80, 30, startStyle);
            addOverlay(v1);
        } finally {
            // Updates the display
            graph.getModel().endUpdate();
        }

        var layout;

        if (type == 'horizontalTree') {
            layout = new mxCompactTreeLayout(graph);
            layout.edgeRouting = false;
            layout.levelDistance = 30;
            edgeStyle = 'edgeStyle=elbowEdgeStyle;elbow=horizontal;';
        } else if (type == 'verticalTree') {
            layout = new mxCompactTreeLayout(graph, false);
            layout.edgeRouting = false;
            layout.levelDistance = 30;
            edgeStyle = 'edgeStyle=elbowEdgeStyle;elbow=vertical;';
        } else if (type == 'radialTree') {
            layout = new mxRadialTreeLayout(graph, false);
            layout.edgeRouting = false;
            layout.levelDistance = 80;
        } else if (type == 'verticalFlow') {
            layout = new mxHierarchicalLayout(graph, mxConstants.DIRECTION_NORTH);
        } else if (type == 'horizontalFlow') {
            layout = new mxHierarchicalLayout(graph, mxConstants.DIRECTION_WEST);
        } else if (type == 'organic') {
            layout = new mxFastOrganicLayout(graph, false);
            layout.forceConstant = 80;
        } else if (type == 'circle') {
            layout = new mxCircleLayout(graph);
        }

        if (layout != null) {
            var executeLayout = function (change, post) {
                graph.getModel().beginUpdate();
                try {
                    if (change != null) {
                        change();
                    }

                    layout.execute(graph.getDefaultParent(), v1);
                } catch (e) {
                    throw e;
                } finally {
                    // New API for animating graph layout results asynchronously
                    var morph = new mxMorphing(graph);
                    morph.addListener(mxEvent.DONE, mxUtils.bind(this, function () {
                        graph.getModel().endUpdate();

                        if (post != null) {
                            post();
                        }
                    }));

                    morph.startAnimation();
                }
            };

            var edgeHandleConnect = mxEdgeHandler.prototype.connect;
            mxEdgeHandler.prototype.connect = function (edge, terminal, isSource, isClone, me) {
                edgeHandleConnect.apply(this, arguments);
                executeLayout();
            };

            graph.resizeCell = function () {
                mxGraph.prototype.resizeCell.apply(this, arguments);

                executeLayout();
            };

            graph.connectionHandler.addListener(mxEvent.CONNECT, function () {
                executeLayout();
            });
        }

        var cancelBtn = mxUtils.button(mxResources.get('close'), function () {
            editorUi.confirm(mxResources.get('areYouSure'), function () {
                if (container.parentNode != null) {
                    graph.destroy();
                    container.parentNode.removeChild(container);
                }

                editorUi.hideDialog();
            });
        })

        cancelBtn.className = 'geBtn';

        if (editorUi.editor.cancelFirst) {
            div.appendChild(cancelBtn);
        }

        var okBtn = mxUtils.button(mxResources.get('insert'), function () {
            graph.clearCellOverlays();

            // Computes unscaled, untranslated graph bounds
            var pt = editorUi.editor.graph.getFreeInsertPoint();
            var cells = editorUi.editor.graph.importCells(
                graph.getModel().getChildren(graph.getDefaultParent()), pt.x, pt.y);
            var view = editorUi.editor.graph.view;
            var temp = view.getBounds(cells);
            temp.x -= view.translate.x;
            temp.y -= view.translate.y;
            editorUi.editor.graph.scrollRectToVisible(temp);
            editorUi.editor.graph.setSelectionCells(cells);

            if (container.parentNode != null) {
                graph.destroy();
                container.parentNode.removeChild(container);
            }

            editorUi.hideDialog();
        });

        div.appendChild(okBtn);
        okBtn.className = 'geBtn gePrimaryBtn';

        if (!editorUi.editor.cancelFirst) {
            div.appendChild(cancelBtn);
        }
    };

    this.container = div;
};

/**
 *
 */
CreateGraphDialog.prototype.connectImage = new mxImage((mxClient.IS_SVG) ? 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABoAAAAaCAYAAACpSkzOAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyJpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBNYWNpbnRvc2giIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6RjQ3OTk0QjMyRDcyMTFFNThGQThGNDVBMjNBMjFDMzkiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6RjQ3OTk0QjQyRDcyMTFFNThGQThGNDVBMjNBMjFDMzkiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDoyRjA0N0I2MjJENzExMUU1OEZBOEY0NUEyM0EyMUMzOSIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDpGNDc5OTRCMjJENzIxMUU1OEZBOEY0NUEyM0EyMUMzOSIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PjIf+MgAAATlSURBVHjanFZraFxFFD735u4ru3ls0yZG26ShgmJoKK1J2vhIYzBgRdtIURHyw1hQUH9IxIgI2h8iCEUF/1RRlNQYCsYfCTHVhiTtNolpZCEStqSC22xIsrs1bDfu7t37Gs/cO3Ozxs1DBw73zpk555vzmHNGgJ0NYatFgmNLYUHYUoHASMz5ijmgVLmxgfKCUiBxC4ACJAeSG8nb1dVVOTc3dyoSibwWDofPBIPBJzo7O8vpGtvjpDICGztxkciECpF2LS0tvZtOpwNkk5FKpcYXFxffwL1+JuPgllPj8nk1F6RoaGjoKCqZ5ApljZDZO4SMRA0SuG2QUJIQRV8HxMOM9vf3H0ZZH9Nhg20MMl2QkFwjIyNHWlpahtADnuUMwLcRHX5aNSBjCJYEsSSLUeLEbhGe3ytCmQtA1/XY+Pj46dbW1iDuyCJp9BC5ycBj4hoeHq5ra2sbw0Xn1ZgBZ+dVkA1Lc+6p0Ck2p0QS4Ox9EhwpEylYcmBg4LH29vYQLilIOt0u5FhDfevNZDI/u93uw6PLOrwTUtjxrbPYbhD42WgMrF8JmR894ICmCgnQjVe8Xu8pXEkzMJKbuo5oNPomBbm1ZsD7s2kwFA1JZ6QBUXWT1nmGNc/qoMgavDcrQzxjQGFh4aOYIJ0sFAXcEtui4uLiVjr5KpSBVFYDDZVrWUaKRRWSAYeK0fmKykgDXbVoNaPChRuyqdDv97czL5nXxQbq6empQmsaklkDBiNpSwFVrmr2P6UyicD5piI4f8wHh0oEm8/p4h8pyGiEWvVQd3e3nxtjAzU1NR2jP7NRBWQ8GbdEzzJAmc0V3RR4cI8Dvmwuhc8fKUFA0d6/ltHg5p+Kuaejo6OeY0jcNJ/PV00ZS0nFUoZRvvFS1bZFsKHCCQ2Pl8H0chY+C96B6ZUsrCQ1qKtwQVFRURW/QhIXMAzDPAZ6BgOr8tTa8dDxCmiYGApaJbJMxSzV+brE8pdgWkcpY5dbMF1AR9XH8/xu2ilef48bvn92n82ZwHh+8ssqTEXS9p7dHisiiURikd8PbpExNTU1UVNTA3V3Y7lC16n0gpB/NwpNcZjfa7dScC4Qh0kOQCwnlEgi3F/hMVl9fX0zvKrzSk2lfXjRhj0eT/2rvWG4+Pta3oJY7XfC3hInXAv/ldeFLx8shQ+eqQL0UAAz7ylkpej5eNZRVBWL6BU6ef14OYiY1oqyTtmsavr/5koaRucT1pzx+ZpL1+GV5nLutksUgIcmtwTRiuuVZXnU5XId7A2swJkfFsymRWC91hHg1Viw6x23+7vn9sPJ+j20BE1hCXqSWaNSQ8ScbknRZWxub1PGCw/fBV+c3AeijlUbY5bBjEqr9GuYZP4jP41WudGSC6erTRCqdGZm5i1WvXWeDHnbBCZGc2Nj4wBl/hZOwrmBBfgmlID1HmGJutHaF+tKoevp/XCgstDkjo2NtWKLuc6AVN4mNjY+s1XQxoenOoFuDPHGtnRbJj9ej5GvL0dI7+giuRyMk1giazc+DP6vgUDgOJVlOv7R+PJ12QIeL6SyeDz+Kfp8ZrNWjgDTsVjsQ7qXyTjztXJhm9ePxFLfMTg4eG9tbe1RTP9KFFYQfHliYmIS69kCC7jKYmKwxxD5P88tkVkqbPPcIps9t4T/+HjcuJ/s5BFJgf4WYABCtxGuxIZ90gAAAABJRU5ErkJggg==' :
    IMAGE_PATH + '/handle-connect.png', 26, 26);

/**
 * Constructs a new parse dialog.
 */
var BackgroundImageDialog = function (editorUi, applyFn) {
    var div = document.createElement('div');
    div.style.whiteSpace = 'nowrap';

    var h3 = document.createElement('h2');
    mxUtils.write(h3, mxResources.get('backgroundImage'));
    h3.style.marginTop = '0px';
    div.appendChild(h3);

    mxUtils.write(div, mxResources.get('image') + ' ' + mxResources.get('url') + ':');
    mxUtils.br(div);

    var img = editorUi.editor.graph.backgroundImage;

    var urlInput = document.createElement('input');
    urlInput.setAttribute('type', 'text');
    urlInput.style.marginTop = '4px';
    urlInput.style.marginBottom = '4px';
    urlInput.style.width = '350px';
    urlInput.value = (img != null) ? img.src : '';

    var resetting = false;

    var urlChanged = function () {
        if (!resetting && urlInput.value != '' && !editorUi.isOffline()) {
            editorUi.loadImage(mxUtils.trim(urlInput.value), function (img) {
                widthInput.value = img.width;
                heightInput.value = img.height;
            }, function () {
                editorUi.showError(mxResources.get('error'), mxResources.get('fileNotFound'), mxResources.get('ok'));
                urlInput.value = '';
                widthInput.value = '';
                heightInput.value = '';
            });
        } else {
            widthInput.value = '';
            heightInput.value = '';
        }
    };

    this.init = function () {
        urlInput.focus();

        // Installs drag and drop handler for local images and links
        if (Graph.fileSupport) {
            urlInput.setAttribute('placeholder', mxResources.get('dragImagesHere'));

            // Setup the dnd listeners
            var dlg = div.parentNode;
            var graph = editorUi.editor.graph;
            var dropElt = null;

            mxEvent.addListener(dlg, 'dragleave', function (evt) {
                if (dropElt != null) {
                    dropElt.parentNode.removeChild(dropElt);
                    dropElt = null;
                }

                evt.stopPropagation();
                evt.preventDefault();
            });

            mxEvent.addListener(dlg, 'dragover', mxUtils.bind(this, function (evt) {
                // IE 10 does not implement pointer-events so it can't have a drop highlight
                if (dropElt == null && (!mxClient.IS_IE || document.documentMode > 10)) {
                    dropElt = editorUi.highlightElement(dlg);
                }

                evt.stopPropagation();
                evt.preventDefault();
            }));

            mxEvent.addListener(dlg, 'drop', mxUtils.bind(this, function (evt) {
                if (dropElt != null) {
                    dropElt.parentNode.removeChild(dropElt);
                    dropElt = null;
                }

                if (evt.dataTransfer.files.length > 0) {
                    editorUi.importFiles(evt.dataTransfer.files, 0, 0, editorUi.maxBackgroundSize, function (data, mimeType, x, y, w, h) {
                        urlInput.value = data;
                        urlChanged();
                    }, function () {
                        // No post processing
                    }, function (file) {
                        // Handles only images
                        return file.type.substring(0, 6) == 'image/';
                    }, function (queue) {
                        // Invokes elements of queue in order
                        for (var i = 0; i < queue.length; i++) {
                            queue[i]();
                        }
                    }, true, editorUi.maxBackgroundBytes, editorUi.maxBackgroundBytes);
                } else if (mxUtils.indexOf(evt.dataTransfer.types, 'text/uri-list') >= 0) {
                    var uri = evt.dataTransfer.getData('text/uri-list');

                    if ((/\.(gif|jpg|jpeg|tiff|png|svg)$/i).test(uri)) {
                        urlInput.value = decodeURIComponent(uri);
                        urlChanged();
                    }
                }

                evt.stopPropagation();
                evt.preventDefault();
            }), false);
        }
    };

    div.appendChild(urlInput);
    mxUtils.br(div);
    mxUtils.br(div);

    mxUtils.write(div, mxResources.get('width') + ':');

    var widthInput = document.createElement('input');
    widthInput.setAttribute('type', 'text');
    widthInput.style.width = '60px';
    widthInput.style.marginLeft = '4px';
    widthInput.style.marginRight = '16px';
    widthInput.value = (img != null) ? img.width : '';

    div.appendChild(widthInput);

    mxUtils.write(div, mxResources.get('height') + ':');

    var heightInput = document.createElement('input');
    heightInput.setAttribute('type', 'text');
    heightInput.style.width = '60px';
    heightInput.style.marginLeft = '4px';
    heightInput.style.marginRight = '16px';
    heightInput.value = (img != null) ? img.height : '';

    div.appendChild(heightInput);

    var resetBtn = mxUtils.button(mxResources.get('reset'), function () {
        urlInput.value = '';
        widthInput.value = '';
        heightInput.value = '';
        resetting = false;
    });
    mxEvent.addListener(resetBtn, 'mousedown', function () {
        // Blocks processing a image URL while clicking reset
        resetting = true;
    });
    mxEvent.addListener(resetBtn, 'touchstart', function () {
        // Blocks processing a image URL while clicking reset
        resetting = true;
    });
    resetBtn.className = 'geBtn';
    resetBtn.width = '100';
    div.appendChild(resetBtn);
    mxUtils.br(div);

    mxEvent.addListener(urlInput, 'change', urlChanged);

    ImageDialog.filePicked = function (data) {
        if (data.action == google.picker.Action.PICKED) {
            if (data.docs[0].thumbnails != null) {
                var thumb = data.docs[0].thumbnails[data.docs[0].thumbnails.length - 1];

                if (thumb != null) {
                    urlInput.value = thumb.url;
                    urlChanged();
                }
            }
        }

        urlInput.focus();
    };

    var btns = document.createElement('div');
    btns.style.marginTop = '40px';
    btns.style.textAlign = 'right';

    var cancelBtn = mxUtils.button(mxResources.get('cancel'), function () {
        editorUi.hideDialog();
    });

    cancelBtn.className = 'geBtn';

    if (editorUi.editor.cancelFirst) {
        btns.appendChild(cancelBtn);
    }

    if (!editorUi.isOffline()) {
        // Dialogs not allowed inside iframes
        if (typeof (google) != 'undefined' && typeof (google.picker) != 'undefined' && window.self === window.top) {
            var searchBtn = mxUtils.button(mxResources.get('search'), function () {
                // Creates one picker and reuses it to avoid polluting the DOM
                if (editorUi.imageSearchPicker == null) {
                    var picker = new google.picker.PickerBuilder()
                        .setLocale(mxLanguage)
                        .addView(google.picker.ViewId.IMAGE_SEARCH)
                        .enableFeature(google.picker.Feature.NAV_HIDDEN);

                    editorUi.imageSearchPicker = picker.setCallback(function (data) {
                        ImageDialog.filePicked(data);
                    }).build();
                }

                editorUi.imageSearchPicker.setVisible(true);
            });

            searchBtn.className = 'geBtn';
            btns.appendChild(searchBtn);

            if (editorUi.drive != null && urlParams['photos'] == '1') {
                var gpBtn = mxUtils.button(mxResources.get('googlePlus'), function () {
                    if (editorUi.spinner.spin(document.body, mxResources.get('authorizing'))) {
                        editorUi.drive.checkToken(mxUtils.bind(this, function () {
                            editorUi.spinner.stop();

                            // Creates one picker and reuses it to avoid polluting the DOM
                            if (editorUi.photoPicker == null) {
                                var token = gapi.auth.getToken().access_token;
                                var picker = new google.picker.PickerBuilder()
                                    .setAppId(editorUi.drive.appId)
                                    .setLocale(mxLanguage)
                                    .setOAuthToken(token)
                                    .addView(google.picker.ViewId.PHOTO_UPLOAD);

                                editorUi.photoPicker = picker.setCallback(function (data) {
                                    ImageDialog.filePicked(data);
                                }).build();
                            }

                            editorUi.photoPicker.setVisible(true);
                        }));
                    }
                });

                gpBtn.className = 'geBtn';
                btns.appendChild(gpBtn);
            }
        }
    }

    var applyBtn = mxUtils.button(mxResources.get('apply'), function () {
        editorUi.hideDialog();
        applyFn((urlInput.value != '') ? new mxImage(mxUtils.trim(urlInput.value), widthInput.value, heightInput.value) : null);
    });
    applyBtn.className = 'geBtn gePrimaryBtn';
    btns.appendChild(applyBtn);

    if (!editorUi.editor.cancelFirst) {
        btns.appendChild(cancelBtn);
    }

    div.appendChild(btns);

    this.container = div;
};

/**
 * Constructs a new parse dialog.
 */
var ParseDialog = function (editorUi, title, defaultType) {
    var insertPoint = editorUi.editor.graph.getFreeInsertPoint();

    function parse(text, type) {
        var lines = text.split('\n');

        if (type == 'plantUmlPng' || type == 'plantUmlSvg' || type == 'plantUmlTxt') {
            var plantUmlServerUrl = (type == 'plantUmlTxt') ? PLANT_URL + '/txt/' :
                ((type == 'plantUmlPng') ? PLANT_URL + '/png/' : PLANT_URL + '/svg/');
            var graph = editorUi.editor.graph;

            // TODO: Change server to return base64 and accept POST request
            if (editorUi.spinner.spin(document.body, mxResources.get('inserting'))) {
                function encode64(data) {
                    r = "";

                    for (i = 0; i < data.length; i += 3) {
                        if (i + 2 == data.length) {
                            r += append3bytes(data.charCodeAt(i), data.charCodeAt(i + 1), 0);
                        } else if (i + 1 == data.length) {
                            r += append3bytes(data.charCodeAt(i), 0, 0);
                        } else {
                            r += append3bytes(data.charCodeAt(i), data.charCodeAt(i + 1),
                                data.charCodeAt(i + 2));
                        }
                    }

                    return r;
                }

                function append3bytes(b1, b2, b3) {
                    c1 = b1 >> 2;
                    c2 = ((b1 & 0x3) << 4) | (b2 >> 4);
                    c3 = ((b2 & 0xF) << 2) | (b3 >> 6);
                    c4 = b3 & 0x3F;
                    r = "";
                    r += encode6bit(c1 & 0x3F);
                    r += encode6bit(c2 & 0x3F);
                    r += encode6bit(c3 & 0x3F);
                    r += encode6bit(c4 & 0x3F);

                    return r;
                }

                function encode6bit(b) {
                    if (b < 10) {
                        return String.fromCharCode(48 + b);
                    }

                    b -= 10;

                    if (b < 26) {
                        return String.fromCharCode(65 + b);
                    }

                    b -= 26;

                    if (b < 26) {
                        return String.fromCharCode(97 + b);
                    }

                    b -= 26;

                    if (b == 0) {
                        return '-';
                    }

                    if (b == 1) {
                        return '_';
                    }

                    return '?';
                }

                // TODO: Remove unescape, use btoa for compatibility with graph.compress
                function compress(s) {
                    return encode64(Graph.bytesToString(
                        pako.deflateRaw(unescape(
                            encodeURIComponent(s)))));
                };

                var xhr = new XMLHttpRequest();
                xhr.open('GET', plantUmlServerUrl + compress(text), true);

                if (type != 'plantUmlTxt') {
                    xhr.responseType = 'blob';
                }

                xhr.onload = function (e) {
                    if (this.status >= 200 && this.status < 300) {
                        if (type == 'plantUmlTxt') {
                            editorUi.spinner.stop();
                            graph.setSelectionCell(editorUi.insertAsPreText(
                                this.response, insertPoint.x, insertPoint.y));
                            graph.scrollCellToVisible(graph.getSelectionCell());
                        } else {
                            var reader = new FileReader();
                            reader.readAsDataURL(this.response);

                            reader.onloadend = function (e) {
                                var img = new Image();

                                img.onload = function () {
                                    editorUi.spinner.stop();
                                    var w = img.width;
                                    var h = img.height;

                                    // Workaround for 0 image size in IE11
                                    if (w == 0 && h == 0) {
                                        var data = reader.result;
                                        var comma = data.indexOf(',');
                                        var svgText = decodeURIComponent(escape(atob(data.substring(comma + 1))));
                                        var root = mxUtils.parseXml(svgText);
                                        var svgs = root.getElementsByTagName('svg');

                                        if (svgs.length > 0) {
                                            w = parseFloat(svgs[0].getAttribute('width'));
                                            h = parseFloat(svgs[0].getAttribute('height'));
                                        }
                                    }

                                    graph.getModel().beginUpdate();
                                    try {
                                        cell = graph.insertVertex(null, null, text, insertPoint.x, insertPoint.y,
                                            w, h, 'shape=image;noLabel=1;verticalAlign=top;aspect=fixed;imageAspect=0;' +
                                            'image=' + editorUi.convertDataUri(reader.result) + ';');
                                    } finally {
                                        graph.getModel().endUpdate();
                                    }

                                    graph.setSelectionCell(cell);
                                    graph.scrollCellToVisible(graph.getSelectionCell());
                                };

                                img.src = reader.result;
                            };

                            reader.onerror = function (e) {
                                editorUi.handleError(e);
                            };
                        }
                    } else {
                        editorUi.spinner.stop();
                        editorUi.handleError(e);
                    }
                };

                xhr.onerror = function (e) {
                    editorUi.handleError(e);
                };

                xhr.send();
            }
        } else if (type == 'table') {
            var tableCell = null;
            var rows = null;
            var cells = [];
            var dx = 0;

            for (var i = 0; i < lines.length; i++) {
                var tmp = mxUtils.trim(lines[i]);

                if (tmp.substring(0, 12).toLowerCase() == 'create table') {
                    var name = mxUtils.trim(tmp.substring(12));

                    if (name.charAt(name.length - 1) == '(') {
                        name = name.substring(0, name.lastIndexOf(' '));
                    }

                    tableCell = new mxCell(name, new mxGeometry(dx, 0, 160, 26),
                        'swimlane;fontStyle=0;childLayout=stackLayout;horizontal=1;startSize=26;fillColor=#e0e0e0;horizontalStack=0;resizeParent=1;resizeLast=0;collapsible=1;marginBottom=0;swimlaneFillColor=#ffffff;align=center;');
                    tableCell.vertex = true;
                    cells.push(tableCell);

                    var size = editorUi.editor.graph.getPreferredSizeForCell(rowCell);

                    if (size != null) {
                        tableCell.geometry.width = size.width + 10;
                    }

                    // For primary key lookups
                    rows = {};
                } else if (tableCell != null && tmp.charAt(0) == ')') {
                    dx += tableCell.geometry.width + 40;
                    tableCell = null;
                } else if (tmp != '(' && tableCell != null) {
                    var name = tmp.substring(0, (tmp.charAt(tmp.length - 1) == ',') ? tmp.length - 1 : tmp.length);

                    if (name.substring(0, 11).toLowerCase() != 'primary key') {
                        var pk = name.toLowerCase().indexOf('primary key');
                        name = name.replace(/primary key/i, '');
                        var rowCell = new mxCell(name, new mxGeometry(0, 0, 90, 26),
                            'shape=partialRectangle;top=0;left=0;right=0;bottom=0;align=left;verticalAlign=top;spacingTop=-2;fillColor=none;spacingLeft=34;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;dropTarget=0;');
                        rowCell.vertex = true;

                        var left = sb.cloneCell(rowCell, (pk > 0) ? 'PK' : '');
                        left.connectable = false;
                        left.style = 'shape=partialRectangle;top=0;left=0;bottom=0;fillColor=none;align=left;verticalAlign=middle;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[];portConstraint=eastwest;part=1;'
                        left.geometry.width = 30;
                        left.geometry.height = 26;
                        rowCell.insert(left);

                        var size = editorUi.editor.graph.getPreferredSizeForCell(rowCell);

                        if (size != null && tableCell.geometry.width < size.width + 10) {
                            tableCell.geometry.width = Math.min(220, size.width + 10);
                        }

                        tableCell.insert(rowCell);
                        tableCell.geometry.height += 26;

                        rows[rowCell.value] = rowCell;
                    }
                }
            }

            if (cells.length > 0) {
                var graph = editorUi.editor.graph;
                var view = graph.view;
                var bds = graph.getGraphBounds();

                // Computes unscaled, untranslated graph bounds
                var x = Math.ceil(Math.max(0, bds.x / view.scale - view.translate.x) + 4 * graph.gridSize);
                var y = Math.ceil(Math.max(0, (bds.y + bds.height) / view.scale - view.translate.y) + 4 * graph.gridSize);

                graph.setSelectionCells(graph.importCells(cells, x, y));
                graph.scrollCellToVisible(graph.getSelectionCell());
            }
        } else if (type == 'list') {
            if (lines.length > 0) {
                var graph = editorUi.editor.graph;
                var listCell = null;
                var cells = [];
                var x0 = 0;

                for (var i = 0; i < lines.length; i++) {
                    if (lines[i].charAt(0) != ';') {
                        if (lines[i].length == 0) {
                            listCell = null;
                        } else {
                            if (listCell == null) {
                                listCell = new mxCell(lines[i], new mxGeometry(x0, 0, 160, 26 + 4),
                                    'swimlane;fontStyle=1;childLayout=stackLayout;horizontal=1;startSize=26;horizontalStack=0;resizeParent=1;resizeLast=0;collapsible=1;marginBottom=0;swimlaneFillColor=#ffffff;');
                                listCell.vertex = true;
                                cells.push(listCell);

                                var size = graph.getPreferredSizeForCell(listCell);

                                if (size != null && listCell.geometry.width < size.width + 10) {
                                    listCell.geometry.width = size.width + 10;
                                }

                                x0 += listCell.geometry.width + 40;
                            } else if (lines[i] == '--') {
                                var divider = new mxCell('', new mxGeometry(0, 0, 40, 8), 'line;strokeWidth=1;fillColor=none;align=left;verticalAlign=middle;spacingTop=-1;spacingLeft=3;spacingRight=3;rotatable=0;labelPosition=right;points=[];portConstraint=eastwest;');
                                divider.vertex = true;
                                listCell.geometry.height += divider.geometry.height;
                                listCell.insert(divider);
                            } else if (lines[i].length > 0) {
                                var field = new mxCell(lines[i], new mxGeometry(0, 0, 60, 26), 'text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;');
                                field.vertex = true;

                                var size = graph.getPreferredSizeForCell(field);

                                if (size != null && field.geometry.width < size.width) {
                                    field.geometry.width = size.width;
                                }

                                listCell.geometry.width = Math.max(listCell.geometry.width, field.geometry.width);
                                listCell.geometry.height += field.geometry.height;
                                listCell.insert(field);
                            }
                        }
                    }
                }

                if (cells.length > 0) {
                    graph.getModel().beginUpdate();
                    try {
                        cells = graph.importCells(cells, insertPoint.x, insertPoint.y);
                        var inserted = [];

                        for (var i = 0; i < cells.length; i++) {
                            inserted.push(cells[i]);
                            inserted = inserted.concat(cells[i].children);
                        }

                        graph.fireEvent(new mxEventObject('cellsInserted', 'cells', inserted));
                    } finally {
                        graph.getModel().endUpdate();
                    }

                    graph.setSelectionCells(cells);
                    graph.scrollCellToVisible(graph.getSelectionCell());
                }
            }
        } else {
            var vertices = new Object();
            var cells = [];

            function getOrCreateVertex(id) {
                var vertex = vertices[id];

                if (vertex == null) {
                    vertex = new mxCell(id, new mxGeometry(0, 0, 80, 30), 'whiteSpace=wrap;html=1;');
                    vertex.vertex = true;
                    vertices[id] = vertex;
                    cells.push(vertex);
                }

                return vertex;
            };

            for (var i = 0; i < lines.length; i++) {
                if (lines[i].charAt(0) != ';') {
                    var values = lines[i].split('->');

                    if (values.length >= 2) {
                        var source = getOrCreateVertex(values[0]);
                        var target = getOrCreateVertex(values[values.length - 1]);

                        var edge = new mxCell((values.length > 2) ? values[1] : '', new mxGeometry());
                        edge.edge = true;
                        source.insertEdge(edge, true);
                        target.insertEdge(edge, false);
                        cells.push(edge);
                    }
                }
            }

            if (cells.length > 0) {
                var container = document.createElement('div');
                container.style.visibility = 'hidden';
                document.body.appendChild(container);

                // Temporary graph for running the layout
                var graph = new Graph(container);

                graph.getModel().beginUpdate();
                try {
                    cells = graph.importCells(cells);

                    for (var i = 0; i < cells.length; i++) {
                        if (graph.getModel().isVertex(cells[i])) {
                            var size = graph.getPreferredSizeForCell(cells[i]);
                            cells[i].geometry.width = Math.max(cells[i].geometry.width, size.width);
                            cells[i].geometry.height = Math.max(cells[i].geometry.height, size.height);
                        }
                    }

                    var layout = new mxFastOrganicLayout(graph);
                    layout.disableEdgeStyle = false;
                    layout.forceConstant = 120;
                    layout.execute(graph.getDefaultParent());

                    var edgeLayout = new mxParallelEdgeLayout(graph);
                    edgeLayout.spacing = 20;
                    edgeLayout.execute(graph.getDefaultParent());
                } finally {
                    graph.getModel().endUpdate();
                }

                graph.clearCellOverlays();

                // Copy to actual graph
                var inserted = [];

                editorUi.editor.graph.getModel().beginUpdate();
                try {
                    inserted = editorUi.editor.graph.importCells(graph.getModel().getChildren(
                        graph.getDefaultParent()), insertPoint.x, insertPoint.y)
                    editorUi.editor.graph.fireEvent(new mxEventObject('cellsInserted', 'cells', inserted));
                } finally {
                    editorUi.editor.graph.getModel().endUpdate();
                }

                editorUi.editor.graph.setSelectionCells(inserted);
                editorUi.editor.graph.scrollCellToVisible(editorUi.editor.graph.getSelectionCell());
                graph.destroy();
                container.parentNode.removeChild(container);
            }
        }
    };

    var div = document.createElement('div');
    div.style.textAlign = 'right';

    var textarea = document.createElement('textarea');
    textarea.style.resize = 'none';
    textarea.style.width = '100%';
    textarea.style.height = '354px';
    textarea.style.marginBottom = '16px';

    var typeSelect = document.createElement('select');

    if (defaultType == 'formatSql') {
        typeSelect.style.display = 'none';
    }

    var listOption = document.createElement('option');
    listOption.setAttribute('value', 'list');
    mxUtils.write(listOption, mxResources.get('list'));

    if (defaultType != 'plantUml') {
        typeSelect.appendChild(listOption);
    }

    if (defaultType == null || defaultType == 'fromText') {
        listOption.setAttribute('selected', 'selected');
    }

    var tableOption = document.createElement('option');
    tableOption.setAttribute('value', 'table');
    mxUtils.write(tableOption, mxResources.get('formatSql'));

    if (defaultType == 'formatSql') {
        typeSelect.appendChild(tableOption);
        tableOption.setAttribute('selected', 'selected');
    }

    var diagramOption = document.createElement('option');
    diagramOption.setAttribute('value', 'diagram');
    mxUtils.write(diagramOption, mxResources.get('diagram'));

    if (defaultType != 'plantUml') {
        typeSelect.appendChild(diagramOption);
    }

    var plantUmlSvgOption = document.createElement('option');
    plantUmlSvgOption.setAttribute('value', 'plantUmlSvg');
    mxUtils.write(plantUmlSvgOption, mxResources.get('plantUml') + ' (' + mxResources.get('formatSvg') + ')');

    if (defaultType == 'plantUml') {
        plantUmlSvgOption.setAttribute('selected', 'selected');
    }

    var plantUmlPngOption = document.createElement('option');
    plantUmlPngOption.setAttribute('value', 'plantUmlPng');
    mxUtils.write(plantUmlPngOption, mxResources.get('plantUml') + ' (' + mxResources.get('formatPng') + ')');

    var plantUmlTxtOption = document.createElement('option');
    plantUmlTxtOption.setAttribute('value', 'plantUmlTxt');
    mxUtils.write(plantUmlTxtOption, mxResources.get('plantUml') + ' (' + mxResources.get('text') + ')');

    // Disabled for invalid hosts via CORS headers
    if (EditorUi.enablePlantUml && Graph.fileSupport &&
        !editorUi.isOffline() && defaultType == 'plantUml') {
        typeSelect.appendChild(plantUmlSvgOption);
        typeSelect.appendChild(plantUmlPngOption);
        typeSelect.appendChild(plantUmlTxtOption);
    }

    function getDefaultValue() {
        if (typeSelect.value == 'list') {
            return 'Person\n-name: String\n-birthDate: Date\n--\n+getName(): String\n+setName(String): void\n+isBirthday(): boolean\n\n' +
                'Address\n-street: String\n-city: String\n-state: String';
        } else if (typeSelect.value == 'table') {
            return 'CREATE TABLE Suppliers\n(\nsupplier_id int NOT NULL PRIMARY KEY,\n' +
                'supplier_name char(50) NOT NULL,\ncontact_name char(50),\n);\n' +
                'CREATE TABLE Customers\n(\ncustomer_id int NOT NULL PRIMARY KEY,\n' +
                'customer_name char(50) NOT NULL,\naddress char(50),\n' +
                'city char(50),\nstate char(25),\nzip_code char(10)\n);\n';
        } else if (typeSelect.value == 'plantUmlPng') {
            return '@startuml\nskinparam backgroundcolor transparent\nskinparam shadowing false\nAlice -> Bob: Authentication Request\nBob --> Alice: Authentication Response\n\nAlice -> Bob: Another authentication Request\nAlice <-- Bob: another authentication Response\n@enduml';
        } else if (typeSelect.value == 'plantUmlSvg' || typeSelect.value == 'plantUmlTxt') {
            return '@startuml\nskinparam shadowing false\nAlice -> Bob: Authentication Request\nBob --> Alice: Authentication Response\n\nAlice -> Bob: Another authentication Request\nAlice <-- Bob: another authentication Response\n@enduml';
        } else {
            return ';Example:\na->b\nb->edge label->c\nc->a\n';
        }
    };

    var defaultValue = getDefaultValue();
    textarea.value = defaultValue;
    div.appendChild(textarea);

    this.init = function () {
        textarea.focus();
    };

    // Enables dropping files
    if (Graph.fileSupport) {
        function handleDrop(evt) {
            evt.stopPropagation();
            evt.preventDefault();

            if (evt.dataTransfer.files.length > 0) {
                var file = evt.dataTransfer.files[0];

                var reader = new FileReader();
                reader.onload = function (e) {
                    textarea.value = e.target.result;
                };
                reader.readAsText(file);
            }
        };

        function handleDragOver(evt) {
            evt.stopPropagation();
            evt.preventDefault();
        };

        // Setup the dnd listeners.
        textarea.addEventListener('dragover', handleDragOver, false);
        textarea.addEventListener('drop', handleDrop, false);
    }

    div.appendChild(typeSelect);

    mxEvent.addListener(typeSelect, 'change', function () {
        var newDefaultValue = getDefaultValue();

        if (textarea.value.length == 0 || textarea.value == defaultValue) {
            defaultValue = newDefaultValue;
            textarea.value = defaultValue;
        }
    });

    var cancelBtn = mxUtils.button(mxResources.get('close'), function () {
        if (textarea.value == defaultValue) {
            editorUi.hideDialog();
        } else {
            editorUi.confirm(mxResources.get('areYouSure'), function () {
                editorUi.hideDialog();
            });
        }
    });

    cancelBtn.className = 'geBtn';

    if (editorUi.editor.cancelFirst) {
        div.appendChild(cancelBtn);
    }

    var okBtn = mxUtils.button(mxResources.get('insert'), function () {
        editorUi.hideDialog();
        parse(textarea.value, typeSelect.value);
    });
    div.appendChild(okBtn);

    okBtn.className = 'geBtn gePrimaryBtn';

    if (!editorUi.editor.cancelFirst) {
        div.appendChild(cancelBtn);
    }

    this.container = div;
};
/**
 * Constructs a dialog for creating new files from a template URL.
 * Also used for dialog choosing where to save or export resources
 */
var CreateDialog = function (editorUi, title, createFn, cancelFn, dlgTitle, btnLabel, overrideExtension,
                             allowBrowser, allowTab, helpLink, showDeviceButton, rowLimit, data, mimeType, base64Encoded, hints) {
    overrideExtension = (overrideExtension != null) ? overrideExtension : true;
    allowBrowser = (allowBrowser != null) ? allowBrowser : true;
    rowLimit = (rowLimit != null) ? rowLimit : 4;

    var div = document.createElement('div');
    div.style.whiteSpace = 'nowrap';

    var showButtons = true;

    if (cancelFn == null) {
        editorUi.addLanguageMenu(div);
    }

    var h3 = document.createElement('h2');
    mxUtils.write(h3, dlgTitle || mxResources.get('create'));
    h3.style.marginTop = '0px';
    h3.style.marginBottom = '24px';
    div.appendChild(h3);

    mxUtils.write(div, mxResources.get('filename') + ':');

    var nameInput = document.createElement('input');
    nameInput.setAttribute('value', title);
    nameInput.style.width = '280px';
    nameInput.style.marginLeft = '10px';
    nameInput.style.marginBottom = '20px';
    nameInput.style.maxWidth = '70%';

    this.init = function () {
        nameInput.focus();

        if (mxClient.IS_GC || mxClient.IS_FF || document.documentMode >= 5 || mxClient.IS_QUIRKS) {
            nameInput.select();
        } else {
            document.execCommand('selectAll', false, null);
        }
    };

    div.appendChild(nameInput);

    if (hints != null) {
        div.appendChild(FilenameDialog.createTypeHint(editorUi, nameInput, hints));
    }

    if (data != null && mimeType != null && mimeType.substring(0, 6) == 'image/') {
        nameInput.style.width = '160px';
        var preview = null;

        // Workaround for broken images in SVG preview in Chrome
        if (mimeType == 'image/svg+xml' && mxClient.IS_SVG) {
            preview = document.createElement('div');
            preview.innerHTML = mxUtils.trim(data);
            var svg = preview.getElementsByTagName('svg')[0];
            var w = parseInt(svg.getAttribute('width'));
            var h = parseInt(svg.getAttribute('height'));
            svg.setAttribute('viewBox', '0 0 ' + w + ' ' + h);
            svg.setAttribute('width', '120px');
            svg.setAttribute('height', '80px');
        } else {
            preview = document.createElement('img');
            preview.setAttribute('src', 'data:' + mimeType + ((base64Encoded) ? ';base64,' : ';utf8,') + data);
        }

        preview.style.position = 'absolute';
        preview.style.top = '70px';
        preview.style.right = '100px';
        preview.style.maxWidth = '120px';
        preview.style.maxHeight = '80px';
        mxUtils.setPrefixedStyle(preview.style, 'transform', 'translate(50%,-50%)');
        div.appendChild(preview);

        if (allowTab && Editor.popupsAllowed) {
            preview.style.cursor = 'pointer';

            mxEvent.addListener(preview, 'click', function () {
                create('_blank');
            });
        }
    }

    mxUtils.br(div);

    var buttons = document.createElement('div');
    buttons.style.textAlign = 'center';
    var count = 0;

    function addLogo(img, title, mode, clientName) {
        var button = document.createElement('a');
        button.style.overflow = 'hidden';

        var logo = document.createElement('img');
        logo.src = img;
        logo.setAttribute('border', '0');
        logo.setAttribute('align', 'absmiddle');
        logo.style.width = '60px';
        logo.style.height = '60px';
        logo.style.paddingBottom = '6px';
        button.style.display = (mxClient.IS_QUIRKS) ? 'inline' : 'inline-block';
        button.className = 'geBaseButton';
        button.style.position = 'relative';
        button.style.margin = '4px';
        button.style.padding = '8px 8px 10px 8px';
        button.style.whiteSpace = 'nowrap';

        button.appendChild(logo);

        // Workaround for quirks is a vertical list (limited to max 2 items)
        if (mxClient.IS_QUIRKS) {
            button.style.cssFloat = 'left';
            button.style.zoom = '1';
        }

        button.style.color = 'gray';
        button.style.fontSize = '11px';

        var label = document.createElement('div');
        button.appendChild(label);
        mxUtils.write(label, title);

        function initButton() {
            mxEvent.addListener(button, 'click', function () {
                // Updates extension
                change(mode);
                create(mode);
            });
        };

        // Supports lazy loading
        if (clientName != null && editorUi[clientName] == null) {
            logo.style.visibility = 'hidden';
            mxUtils.setOpacity(label, 10);
            var size = 12;

            var spinner = new Spinner({
                lines: 12, // The number of lines to draw
                length: size, // The length of each line
                width: 5, // The line thickness
                radius: 10, // The radius of the inner circle
                rotate: 0, // The rotation offset
                color: '#000', // #rgb or #rrggbb
                speed: 1.5, // Rounds per second
                trail: 60, // Afterglow percentage
                shadow: false, // Whether to render a shadow
                hwaccel: false, // Whether to use hardware acceleration
                top: '40%',
                zIndex: 2e9 // The z-index (defaults to 2000000000)
            });
            spinner.spin(button);

            // Timeout after 30 secs
            var timeout = window.setTimeout(function () {
                if (editorUi[clientName] == null) {
                    spinner.stop();
                    button.style.display = 'none';
                }
            }, 30000);

            editorUi.addListener('clientLoaded', mxUtils.bind(this, function () {
                if (editorUi[clientName] != null) {
                    window.clearTimeout(timeout);
                    mxUtils.setOpacity(label, 100);
                    logo.style.visibility = '';
                    spinner.stop();
                    initButton();
                }
            }));
        } else {
            initButton();
        }

        buttons.appendChild(button);

        if (++count == rowLimit) {
            mxUtils.br(buttons);
            count = 0;
        }
    };

    if (!showButtons) {
        mxUtils.write(div, mxResources.get('chooseAnOption') + ':');
    } else {
        buttons.style.marginTop = '6px';
        div.appendChild(buttons);
    }

    // Adds all papersize options
    var serviceSelect = document.createElement('select');
    serviceSelect.style.marginLeft = '10px';

    if (!editorUi.isOfflineApp() && !editorUi.isOffline()) {
        if (typeof window.DriveClient === 'function') {
            var googleOption = document.createElement('option');
            googleOption.setAttribute('value', App.MODE_GOOGLE);
            mxUtils.write(googleOption, mxResources.get('googleDrive'));
            serviceSelect.appendChild(googleOption);

            addLogo(IMAGE_PATH + '/google-drive-logo.svg', mxResources.get('googleDrive'), App.MODE_GOOGLE, 'drive');
        }
    }

    if (!Editor.useLocalStorage || urlParams['storage'] == 'device' ||
        (editorUi.getCurrentFile() != null/* && !mxClient.IS_IOS*/)) {
        var deviceOption = document.createElement('option');
        deviceOption.setAttribute('value', App.MODE_DEVICE);
        mxUtils.write(deviceOption, mxResources.get('device'));
        serviceSelect.appendChild(deviceOption);

        if (editorUi.mode == App.MODE_DEVICE || !allowBrowser) {
            deviceOption.setAttribute('selected', 'selected');
        }

        if (showDeviceButton) {
            addLogo(IMAGE_PATH + '/osa_drive-harddisk.png', mxResources.get('device'), App.MODE_DEVICE);
        }
    }

    if (allowBrowser && isLocalStorage && urlParams['browser'] != '0') {
        var browserOption = document.createElement('option');
        browserOption.setAttribute('value', App.MODE_BROWSER);
        mxUtils.write(browserOption, mxResources.get('browser'));
        serviceSelect.appendChild(browserOption);

        if (editorUi.mode == App.MODE_BROWSER) {
            browserOption.setAttribute('selected', 'selected');
        }

        addLogo(IMAGE_PATH + '/osa_database.png', mxResources.get('browser'), App.MODE_BROWSER);
    }

    function change(newMode) {
        if (overrideExtension) {
            var fn = nameInput.value;
            var idx = fn.lastIndexOf('.');

            if (title.lastIndexOf('.') < 0 && (!showButtons || idx < 0)) {
                newMode = (newMode != null) ? newMode : serviceSelect.value;
                var ext = '';
                ext = '.drawio';

                if (idx >= 0) {
                    fn = fn.substring(0, idx);
                }

                nameInput.value = fn + ext;
            }
        }
    };

    var btns = document.createElement('div');
    btns.style.marginTop = (showButtons) ? '26px' : '38px';
    btns.style.textAlign = 'center';

    if (!showButtons) {
        div.appendChild(serviceSelect);
        mxEvent.addListener(serviceSelect, 'change', change);
        change();
    }

    if (helpLink != null) {
        var helpBtn = mxUtils.button(mxResources.get('help'), function () {
            editorUi.openLink(helpLink);
        });

        helpBtn.className = 'geBtn';
        btns.appendChild(helpBtn);
    }

    var cancelBtn = mxUtils.button(mxResources.get('cancel'), function () {
        if (cancelFn != null) {
            cancelFn();
        } else {
            editorUi.fileLoaded(null);
            editorUi.hideDialog();
            window.close();
            window.location.href = editorUi.getUrl();
        }
    });

    cancelBtn.className = 'geBtn';

    if (editorUi.editor.cancelFirst) {
        btns.appendChild(cancelBtn);
    }

    function create(mode) {
        var title = nameInput.value;

        if (mode == null || (title != null && title.length > 0)) {
            editorUi.hideDialog();
            createFn(title, mode);
        }
        ;
    }

    if (cancelFn == null) {
        var laterBtn = mxUtils.button(mxResources.get('decideLater'), function () {
            create(null);
        });

        laterBtn.className = 'geBtn';
        btns.appendChild(laterBtn);
    }

    if (allowTab && Editor.popupsAllowed) {
        var openBtn = mxUtils.button(mxResources.get('openInNewWindow'), function () {
            create('_blank');
        });

        openBtn.className = 'geBtn';
        btns.appendChild(openBtn);
    }

    if (CreateDialog.showDownloadButton) {
        var downloadButton = mxUtils.button(mxResources.get('download'), function () {
            create('download');
        });

        downloadButton.className = 'geBtn';
        btns.appendChild(downloadButton);
    }

    if (/*!mxClient.IS_IOS || */!showButtons) {
        var createBtn = mxUtils.button(btnLabel || mxResources.get('create'), function () {
            create((showDeviceButton) ? 'download' : ((showButtons) ? App.MODE_DEVICE : serviceSelect.value));
        });

        createBtn.className = 'geBtn gePrimaryBtn';
        btns.appendChild(createBtn);
    }

    if (!editorUi.editor.cancelFirst) {
        btns.appendChild(cancelBtn);
    }

    mxEvent.addListener(nameInput, 'keypress', function (e) {
        if (e.keyCode == 13) {
            create((showButtons) ? App.MODE_DEVICE : serviceSelect.value);
        } else if (e.keyCode == 27) {
            editorUi.fileLoaded(null);
            editorUi.hideDialog();
            window.close();
        }
    });

    div.appendChild(btns);

    this.container = div;
};

/**
 *
 */
CreateDialog.showDownloadButton = true;

/**
 * Constructs a new popup dialog.
 */
var PopupDialog = function (editorUi, url, pre, fallback, hideDialog) {
    hideDialog = (hideDialog != null) ? hideDialog : true;

    var div = document.createElement('div');
    div.style.textAlign = 'left';

    mxUtils.write(div, mxResources.get('fileOpenLocation'));
    mxUtils.br(div);
    mxUtils.br(div);

    var replaceBtn = mxUtils.button(mxResources.get('openInThisWindow'), function () {
        if (hideDialog) {
            editorUi.hideDialog();
        }

        if (fallback != null) {
            fallback();
        }
    });
    replaceBtn.className = 'geBtn';
    replaceBtn.style.marginBottom = '8px';
    replaceBtn.style.width = '280px';
    div.appendChild(replaceBtn);

    mxUtils.br(div);

    var wndBtn = mxUtils.button(mxResources.get('openInNewWindow'), function () {
        if (hideDialog) {
            editorUi.hideDialog();
        }

        if (pre != null) {
            pre();
        }

        editorUi.openLink(url, null, true);
    });
    wndBtn.className = 'geBtn gePrimaryBtn';
    wndBtn.style.width = replaceBtn.style.width;
    div.appendChild(wndBtn);

    mxUtils.br(div);
    mxUtils.br(div);
    mxUtils.write(div, mxResources.get('allowPopups'));

    this.container = div;
};

/**
 * Constructs a new image dialog.
 */
var ImageDialog = function (editorUi, title, initialValue, fn, ignoreExisting, convertDataUri) {
    convertDataUri = (convertDataUri != null) ? convertDataUri : true;

    var graph = editorUi.editor.graph;
    var div = document.createElement('div');
    mxUtils.write(div, title);

    var inner = document.createElement('div');
    inner.className = 'geTitle';
    inner.style.backgroundColor = 'transparent';
    inner.style.borderColor = 'transparent';
    inner.style.whiteSpace = 'nowrap';
    inner.style.textOverflow = 'clip';
    inner.style.cursor = 'default';

    if (!mxClient.IS_VML) {
        inner.style.paddingRight = '20px';
    }

    var linkInput = document.createElement('input');
    linkInput.setAttribute('value', initialValue);
    linkInput.setAttribute('type', 'text');
    linkInput.setAttribute('spellcheck', 'false');
    linkInput.setAttribute('autocorrect', 'off');
    linkInput.setAttribute('autocomplete', 'off');
    linkInput.setAttribute('autocapitalize', 'off');
    linkInput.style.marginTop = '6px';
    var realWidth = (Graph.fileSupport) ? 420 : 340;
    linkInput.style.width = realWidth + ((mxClient.IS_QUIRKS) ? 20 : -20) + 'px';
    linkInput.style.backgroundImage = 'url(\'' + Dialog.prototype.clearImage + '\')';
    linkInput.style.backgroundRepeat = 'no-repeat';
    linkInput.style.backgroundPosition = '100% 50%';
    linkInput.style.paddingRight = '14px';

    var cross = document.createElement('div');
    cross.setAttribute('title', mxResources.get('reset'));
    cross.style.position = 'relative';
    cross.style.left = '-16px';
    cross.style.width = '12px';
    cross.style.height = '14px';
    cross.style.cursor = 'pointer';

    // Workaround for inline-block not supported in IE
    cross.style.display = (mxClient.IS_VML) ? 'inline' : 'inline-block';
    cross.style.top = ((mxClient.IS_VML) ? 0 : 3) + 'px';

    // Needed to block event transparency in IE
    cross.style.background = 'url(\'' + editorUi.editor.transparentImage + '\')';

    mxEvent.addListener(cross, 'click', function () {
        linkInput.value = '';
        linkInput.focus();
    });

    inner.appendChild(linkInput);
    inner.appendChild(cross);
    div.appendChild(inner);

    var insertImage = function (newValue, w, h, resize) {
        var dataUri = newValue.substring(0, 5) == 'data:';

        if (!editorUi.isOffline() || (dataUri && typeof chrome === 'undefined')) {
            if (newValue.length > 0 && editorUi.spinner.spin(document.body, mxResources.get('inserting'))) {
                var maxSize = 520;

                editorUi.loadImage(newValue, function (img) {
                    editorUi.spinner.stop();
                    editorUi.hideDialog();
                    var s = (resize === false) ? 1 :
                        (w != null && h != null) ? Math.max(w / img.width, h / img.height) :
                            Math.min(1, Math.min(maxSize / img.width, maxSize / img.height));

                    // Handles special case of data URI which needs to be rewritten
                    // to be used in a cell style to remove the semicolon
                    if (convertDataUri) {
                        newValue = editorUi.convertDataUri(newValue);
                    }

                    fn(newValue, Math.round(Number(img.width) * s), Math.round(Number(img.height) * s));
                }, function () {
                    editorUi.spinner.stop();
                    fn(null);
                    editorUi.showError(mxResources.get('error'), mxResources.get('fileNotFound'), mxResources.get('ok'));
                });
            } else {
                editorUi.hideDialog();
                fn(newValue);
            }
        } else {
            newValue = editorUi.convertDataUri(newValue);
            w = (w == null) ? 120 : w;
            h = (h == null) ? 100 : h;

            editorUi.hideDialog();
            fn(newValue, w, h);
        }
    };

    var apply = function (newValue, resize) {
        if (newValue != null) {
            var geo = (ignoreExisting) ? null : graph.getModel().getGeometry(graph.getSelectionCell());

            // Reuses width and height of existing cell
            if (geo != null) {
                insertImage(newValue, geo.width, geo.height, resize);
            } else {
                insertImage(newValue, null, null, resize);
            }
        } else {
            editorUi.hideDialog();
            fn(null);
        }
    };

    this.init = function () {
        linkInput.focus();

        // Installs drag and drop handler for local images and links
        if (Graph.fileSupport) {
            linkInput.setAttribute('placeholder', mxResources.get('dragImagesHere'));

            // Setup the dnd listeners
            var dlg = div.parentNode;
            var graph = editorUi.editor.graph;
            var dropElt = null;

            mxEvent.addListener(dlg, 'dragleave', function (evt) {
                if (dropElt != null) {
                    dropElt.parentNode.removeChild(dropElt);
                    dropElt = null;
                }

                evt.stopPropagation();
                evt.preventDefault();
            });

            mxEvent.addListener(dlg, 'dragover', mxUtils.bind(this, function (evt) {
                // IE 10 does not implement pointer-events so it can't have a drop highlight
                if (dropElt == null && (!mxClient.IS_IE || document.documentMode > 10)) {
                    dropElt = editorUi.highlightElement(dlg);
                }

                evt.stopPropagation();
                evt.preventDefault();
            }));

            mxEvent.addListener(dlg, 'drop', mxUtils.bind(this, function (evt) {
                if (dropElt != null) {
                    dropElt.parentNode.removeChild(dropElt);
                    dropElt = null;
                }

                if (evt.dataTransfer.files.length > 0) {
                    editorUi.importFiles(evt.dataTransfer.files, 0, 0, editorUi.maxImageSize, function (data, mimeType, x, y, w, h, fileName, resize) {
                        apply(data, resize);
                    }, function () {
                        // No post processing
                    }, function (file) {
                        // Handles only images
                        return file.type.substring(0, 6) == 'image/';
                    }, function (queue) {
                        // Invokes elements of queue in order
                        for (var i = 0; i < queue.length; i++) {
                            queue[i]();
                        }
                    }, !mxEvent.isControlDown(evt));
                } else if (mxUtils.indexOf(evt.dataTransfer.types, 'text/uri-list') >= 0) {
                    var uri = evt.dataTransfer.getData('text/uri-list');

                    if ((/\.(gif|jpg|jpeg|tiff|png|svg)($|\?)/i).test(uri)) {
                        apply(decodeURIComponent(uri));
                    }
                }

                evt.stopPropagation();
                evt.preventDefault();
            }), false);
        }
    };

    var btns = document.createElement('div');
    btns.style.marginTop = (mxClient.IS_QUIRKS) ? '22px' : '14px';
    btns.style.textAlign = 'center';

    var cancelBtn = mxUtils.button(mxResources.get('cancel'), function () {
        // Just in case a spinner is spinning, has no effect otherwise
        editorUi.spinner.stop();
        editorUi.hideDialog();
    });

    cancelBtn.className = 'geBtn';

    if (editorUi.editor.cancelFirst) {
        btns.appendChild(cancelBtn);
    }

    ImageDialog.filePicked = function (data) {
        if (data.action == google.picker.Action.PICKED) {
            if (data.docs[0].thumbnails != null) {
                var thumb = data.docs[0].thumbnails[data.docs[0].thumbnails.length - 1];

                if (thumb != null) {
                    linkInput.value = thumb.url;
                }
            }
        }

        linkInput.focus();
    };

    if (Graph.fileSupport) {
        if (editorUi.imgDlgFileInputElt == null) {
            var fileInput = document.createElement('input');
            fileInput.setAttribute('multiple', 'multiple');
            fileInput.setAttribute('type', 'file');

            mxEvent.addListener(fileInput, 'change', function (evt) {
                if (fileInput.files != null) {
                    editorUi.importFiles(fileInput.files, 0, 0, editorUi.maxImageSize, function (data, mimeType, x, y, w, h) {
                        apply(data);
                    }, function () {
                        // No post processing
                    }, function (file) {
                        // Handles only images
                        return file.type.substring(0, 6) == 'image/';
                    }, function (queue) {
                        // Invokes elements of queue in order
                        for (var i = 0; i < queue.length; i++) {
                            queue[i]();
                        }
                    }, true);

                    // Resets input to force change event for same file (type reset required for IE)
                    fileInput.type = '';
                    fileInput.type = 'file';
                    fileInput.value = '';
                }
            });

            fileInput.style.display = 'none';
            document.body.appendChild(fileInput);
            editorUi.imgDlgFileInputElt = fileInput;
        }

        var btn = mxUtils.button(mxResources.get('open'), function () {
            editorUi.imgDlgFileInputElt.click();
        });

        btn.className = 'geBtn';
        btns.appendChild(btn);
    }

    // Image cropping (experimental)
    if (!!document.createElement('canvas').getContext && linkInput.value.substring(0, 11) == 'data:image/' &&
        linkInput.value.substring(0, 14) != 'data:image/svg') {
        var cropBtn = mxUtils.button(mxResources.get('crop'), function () {
            var dlg = new CropImageDialog(editorUi, linkInput.value, function (image) {
                linkInput.value = image;
            });

            editorUi.showDialog(dlg.container, 200, 200, true, true);
            dlg.init();
        });

        cropBtn.className = 'geBtn';
        btns.appendChild(cropBtn);
    }

    if (typeof (google) != 'undefined' && typeof (google.picker) != 'undefined' && window.self === window.top) {
        var searchBtn = mxUtils.button(mxResources.get('search'), function () {
            // Creates one picker and reuses it to avoid polluting the DOM
            if (editorUi.imageSearchPicker == null) {
                var picker = new google.picker.PickerBuilder()
                    .setLocale(mxLanguage)
                    .addView(google.picker.ViewId.IMAGE_SEARCH)
                    .enableFeature(google.picker.Feature.NAV_HIDDEN);

                editorUi.imageSearchPicker = picker.setCallback(function (data) {
                    ImageDialog.filePicked(data);
                }).build();
            }

            editorUi.imageSearchPicker.setVisible(true);
        });
        searchBtn.className = 'geBtn';
        btns.appendChild(searchBtn);

        if (editorUi.drive != null && urlParams['photos'] == '1') {
            var gpBtn = mxUtils.button(mxResources.get('googlePlus'), function () {
                if (editorUi.spinner.spin(document.body, mxResources.get('authorizing'))) {
                    editorUi.drive.checkToken(mxUtils.bind(this, function () {
                        editorUi.spinner.stop();

                        // Creates one picker and reuses it to avoid polluting the DOM
                        if (editorUi.photoPicker == null) {
                            var token = gapi.auth.getToken().access_token;
                            var picker = new google.picker.PickerBuilder()
                                .setAppId(editorUi.drive.appId)
                                .setLocale(mxLanguage)
                                .setOAuthToken(token)
                                .addView(google.picker.ViewId.PHOTO_UPLOAD);

                            editorUi.photoPicker = picker.setCallback(function (data) {
                                ImageDialog.filePicked(data);
                            }).build();
                        }

                        editorUi.photoPicker.setVisible(true);
                    }));
                }
            });
            gpBtn.className = 'geBtn';
            btns.appendChild(gpBtn);
        }
    }

    mxEvent.addListener(linkInput, 'keypress', function (e) {
        if (e.keyCode == 13) {
            apply(linkInput.value);
        }
    });

    var applyBtn = mxUtils.button(mxResources.get('apply'), function () {
        apply(linkInput.value);
    });

    applyBtn.className = 'geBtn gePrimaryBtn';
    btns.appendChild(applyBtn);

    if (!editorUi.editor.cancelFirst) {
        btns.appendChild(cancelBtn);
    }

    // Shows drop icon in dialog background
    if (Graph.fileSupport) {
        btns.style.marginTop = '120px';
        div.style.backgroundImage = 'url(\'' + IMAGE_PATH + '/droptarget.png\')';
        div.style.backgroundPosition = 'center 65%';
        div.style.backgroundRepeat = 'no-repeat';

        var bg = document.createElement('div');
        bg.style.position = 'absolute';
        bg.style.width = '420px';
        bg.style.top = '58%';
        bg.style.textAlign = 'center';
        bg.style.fontSize = '18px';
        bg.style.color = '#a0c3ff';
        mxUtils.write(bg, mxResources.get('dragImagesHere'));
        div.appendChild(bg);
    }

    div.appendChild(btns);

    this.container = div;
};

/**
 * Overrides link dialog to add Google Picker.
 */
var LinkDialog = function (editorUi, initialValue, btnLabel, fn, showPages) {
    var div = document.createElement('div');
    mxUtils.write(div, mxResources.get('editLink') + ':');

    var inner = document.createElement('div');
    inner.className = 'geTitle';
    inner.style.backgroundColor = 'transparent';
    inner.style.borderColor = 'transparent';
    inner.style.whiteSpace = 'nowrap';
    inner.style.textOverflow = 'clip';
    inner.style.cursor = 'default';

    if (!mxClient.IS_VML) {
        inner.style.paddingRight = '20px';
    }

    var linkInput = document.createElement('input');
    linkInput.setAttribute('placeholder', mxResources.get('dragUrlsHere'));
    linkInput.setAttribute('type', 'text');
    linkInput.style.marginTop = '6px';
    linkInput.style.width = '100%';
    linkInput.style.boxSizing = 'border-box';
    linkInput.style.backgroundImage = 'url(\'' + Dialog.prototype.clearImage + '\')';
    linkInput.style.backgroundRepeat = 'no-repeat';
    linkInput.style.backgroundPosition = '100% 50%';
    linkInput.style.paddingRight = '14px';

    var cross = document.createElement('div');
    cross.setAttribute('title', mxResources.get('reset'));
    cross.style.position = 'relative';
    cross.style.left = '-16px';
    cross.style.width = '12px';
    cross.style.height = '14px';
    cross.style.cursor = 'pointer';

    // Workaround for inline-block not supported in IE
    cross.style.display = (mxClient.IS_VML) ? 'inline' : 'inline-block';
    cross.style.top = ((mxClient.IS_VML) ? 0 : 3) + 'px';

    // Needed to block event transparency in IE
    cross.style.background = 'url(\'' + editorUi.editor.transparentImage + '\')';

    mxEvent.addListener(cross, 'click', function () {
        linkInput.value = '';
        linkInput.focus();
    });

    var urlRadio = document.createElement('input');
    urlRadio.style.cssText = 'margin-right:8px;margin-bottom:8px;';
    urlRadio.setAttribute('value', 'url');
    urlRadio.setAttribute('type', 'radio');
    urlRadio.setAttribute('name', 'current-linkdialog');

    var pageRadio = document.createElement('input');
    pageRadio.style.cssText = 'margin-right:8px;margin-bottom:8px;';
    pageRadio.setAttribute('value', 'url');
    pageRadio.setAttribute('type', 'radio');
    pageRadio.setAttribute('name', 'current-linkdialog');

    var pageSelect = document.createElement('select');
    pageSelect.style.width = '100%';

    if (showPages && editorUi.pages != null) {
        if (initialValue != null && initialValue.substring(0, 13) == 'data:page/id,') {
            pageRadio.setAttribute('checked', 'checked');
            pageRadio.defaultChecked = true;
        } else {
            linkInput.setAttribute('value', initialValue);
            urlRadio.setAttribute('checked', 'checked');
            urlRadio.defaultChecked = true;
        }

        inner.appendChild(urlRadio);
        inner.appendChild(linkInput);
        inner.appendChild(cross);
        mxUtils.br(inner);
        inner.appendChild(pageRadio);

        var pageFound = false;

        for (var i = 0; i < editorUi.pages.length; i++) {
            var pageOption = document.createElement('option');
            mxUtils.write(pageOption, editorUi.pages[i].getName() ||
                mxResources.get('pageWithNumber', [i + 1]));
            pageOption.setAttribute('value', 'data:page/id,' +
                editorUi.pages[i].getId());

            if (initialValue == pageOption.getAttribute('value')) {
                pageOption.setAttribute('selected', 'selected');
                pageFound = true;
            }

            pageSelect.appendChild(pageOption);
        }

        if (!pageFound && pageRadio.checked) {
            var notFoundOption = document.createElement('option');
            mxUtils.write(notFoundOption, mxResources.get('pageNotFound'));
            notFoundOption.setAttribute('disabled', 'disabled');
            notFoundOption.setAttribute('selected', 'selected');
            notFoundOption.setAttribute('value', 'pageNotFound');
            pageSelect.appendChild(notFoundOption);

            mxEvent.addListener(pageSelect, 'change', function () {
                if (notFoundOption.parentNode != null && !notFoundOption.selected) {
                    notFoundOption.parentNode.removeChild(notFoundOption);
                }
            });
        }

        inner.appendChild(pageSelect);
    } else {
        linkInput.setAttribute('value', initialValue);
        inner.appendChild(linkInput);
        inner.appendChild(cross);
    }

    div.appendChild(inner);

    var mainBtn = mxUtils.button(btnLabel, function () {
        editorUi.hideDialog();
        var value = (pageRadio.checked) ? ((pageSelect.value !== 'pageNotFound') ?
            pageSelect.value : initialValue) : linkInput.value;
        fn(value, LinkDialog.selectedDocs);
    });
    mainBtn.style.verticalAlign = 'middle';
    mainBtn.className = 'geBtn gePrimaryBtn';

    this.init = function () {
        if (pageRadio.checked) {
            pageSelect.focus();
        } else {
            linkInput.focus();

            if (mxClient.IS_GC || mxClient.IS_FF || document.documentMode >= 5 || mxClient.IS_QUIRKS) {
                linkInput.select();
            } else {
                document.execCommand('selectAll', false, null);
            }
        }

        mxEvent.addListener(pageSelect, 'focus', function () {
            urlRadio.removeAttribute('checked');
            pageRadio.setAttribute('checked', 'checked');
            pageRadio.checked = true;
        });

        mxEvent.addListener(linkInput, 'focus', function () {
            pageRadio.removeAttribute('checked');
            urlRadio.setAttribute('checked', 'checked');
            urlRadio.checked = true;
        });

        // Installs drag and drop handler for links
        if (Graph.fileSupport) {
            // Setup the dnd listeners
            var dlg = div.parentNode;
            var graph = editorUi.editor.graph;
            var dropElt = null;

            mxEvent.addListener(dlg, 'dragleave', function (evt) {
                if (dropElt != null) {
                    dropElt.parentNode.removeChild(dropElt);
                    dropElt = null;
                }

                evt.stopPropagation();
                evt.preventDefault();
            });

            mxEvent.addListener(dlg, 'dragover', mxUtils.bind(this, function (evt) {
                // IE 10 does not implement pointer-events so it can't have a drop highlight
                if (dropElt == null && (!mxClient.IS_IE || document.documentMode > 10)) {
                    dropElt = editorUi.highlightElement(dlg);
                }

                evt.stopPropagation();
                evt.preventDefault();
            }));

            mxEvent.addListener(dlg, 'drop', mxUtils.bind(this, function (evt) {
                if (dropElt != null) {
                    dropElt.parentNode.removeChild(dropElt);
                    dropElt = null;
                }

                if (mxUtils.indexOf(evt.dataTransfer.types, 'text/uri-list') >= 0) {
                    linkInput.value = decodeURIComponent(evt.dataTransfer.getData('text/uri-list'));
                    urlRadio.setAttribute('checked', 'checked');
                    urlRadio.checked = true;
                    mainBtn.click();
                }

                evt.stopPropagation();
                evt.preventDefault();
            }), false);
        }
    };

    var btns = document.createElement('div');
    btns.style.marginTop = '20px';
    btns.style.textAlign = 'center';

    var helpBtn = mxUtils.button(mxResources.get('help'), function () {
        editorUi.openLink('https://desk.draw.io/solution/articles/16000080137');
    });

    helpBtn.style.verticalAlign = 'middle';
    helpBtn.className = 'geBtn';
    btns.appendChild(helpBtn);

    if (editorUi.isOffline() && !mxClient.IS_CHROMEAPP) {
        helpBtn.style.display = 'none';
    }

    var cancelBtn = mxUtils.button(mxResources.get('cancel'), function () {
        editorUi.hideDialog();
    });
    cancelBtn.style.verticalAlign = 'middle';
    cancelBtn.className = 'geBtn';

    if (editorUi.editor.cancelFirst) {
        btns.appendChild(cancelBtn);
    }

    LinkDialog.selectedDocs = null;

    LinkDialog.filePicked = function (data) {
        if (data.action == google.picker.Action.PICKED) {
            LinkDialog.selectedDocs = data.docs;
            var href = data.docs[0].url;

            if (data.docs[0].mimeType == 'application/mxe' || (data.docs[0].mimeType != null &&
                data.docs[0].mimeType.substring(0, 23) == 'application/vnd.jgraph.')) {
                href = 'https://www.draw.io/#G' + data.docs[0].id;
            } else if (data.docs[0].mimeType == 'application/vnd.google-apps.folder') {
                // Do not use folderview in data.docs[0].url link to Google Drive instead
                href = 'https://drive.google.com/#folders/' + data.docs[0].id;
            }

            linkInput.value = href;
            linkInput.focus();
        } else {
            LinkDialog.selectedDocs = null;
        }

        linkInput.focus();
    };

    function addButton(src, tooltip, fn) {
        var btn = mxUtils.button('', fn);
        btn.className = 'geBtn';
        btn.setAttribute('title', tooltip);
        var img = document.createElement('img');
        img.style.height = '26px';
        img.style.width = '26px';
        img.setAttribute('src', src);
        btn.style.minWidth = '42px';
        btn.style.verticalAlign = 'middle';
        btn.appendChild(img);
        btns.appendChild(btn);
    };

    if (typeof (google) != 'undefined' && typeof (google.picker) != 'undefined' && editorUi.drive != null) {
        addButton(IMAGE_PATH + '/google-drive-logo.svg', mxResources.get('googlePlus'), function () {
            if (editorUi.spinner.spin(document.body, mxResources.get('authorizing'))) {
                editorUi.drive.checkToken(mxUtils.bind(this, function () {
                    editorUi.spinner.stop();

                    // Creates one picker and reuses it to avoid polluting the DOM
                    if (editorUi.linkPicker == null) {
                        var token = gapi.auth.getToken().access_token;
                        var view = new google.picker.DocsView(google.picker.ViewId.FOLDERS)
                            .setParent('root')
                            .setIncludeFolders(true)
                            .setSelectFolderEnabled(true);
                        var view2 = new google.picker.DocsView()
                            .setIncludeFolders(true)
                            .setSelectFolderEnabled(true);
                        var view21 = new google.picker.DocsView()
                            .setIncludeFolders(true)
                            .setEnableTeamDrives(true)
                            .setSelectFolderEnabled(true);
                        var picker = new google.picker.PickerBuilder()
                            .setAppId(editorUi.drive.appId)
                            .setLocale(mxLanguage)
                            .setOAuthToken(token)
                            .enableFeature(google.picker.Feature.SUPPORT_TEAM_DRIVES)
                            .addView(view)
                            .addView(view2)
                            .addView(view21)
                            .addView(google.picker.ViewId.RECENTLY_PICKED)
                            .addView(google.picker.ViewId.IMAGE_SEARCH)
                            .addView(google.picker.ViewId.VIDEO_SEARCH)
                            .addView(google.picker.ViewId.MAPS);

                        if (urlParams['photos'] == '1') {
                            picker.addView(google.picker.ViewId.PHOTO_UPLOAD)
                        }

                        editorUi.linkPicker = picker.setCallback(function (data) {
                            LinkDialog.filePicked(data);
                        }).build();
                    }

                    editorUi.linkPicker.setVisible(true);
                }));
            }
        });
    }

    if (typeof (Dropbox) != 'undefined' && typeof (Dropbox.choose) != 'undefined') {
        addButton(IMAGE_PATH + '/dropbox-logo.svg', mxResources.get('dropbox'), function () {
            // Authentication will be carried out on open to make sure the
            // autosave does not show an auth dialog. Showing it here will
            // block the second dialog (the file picker) so it's too early.
            Dropbox.choose(
                {
                    linkType: 'direct',
                    cancel: function () {
                        // do nothing
                    },
                    success: function (files) {
                        linkInput.value = files[0].link;
                        linkInput.focus();
                    }
                });
        });
    }

    if (editorUi.oneDrive != null) {
        addButton(IMAGE_PATH + '/onedrive-logo.svg', mxResources.get('oneDrive'), function () {
            editorUi.oneDrive.pickFile(function (id, files) {
                linkInput.value = files.value[0].webUrl;
                linkInput.focus();
            });
        });
    }

    if (editorUi.gitHub != null) {
        addButton(IMAGE_PATH + '/github-logo.svg', mxResources.get('github'), function () {
            editorUi.gitHub.pickFile(function (path) {
                if (path != null) {
                    var tokens = path.split('/');
                    var org = tokens[0];
                    var repo = tokens[1];
                    var ref = tokens[2];
                    var path = tokens.slice(3, tokens.length).join('/');

                    linkInput.value = 'https://github.com/' + org + '/' +
                        repo + '/blob/' + ref + '/' + path;
                    linkInput.focus();
                }
            });
        });
    }

    if (editorUi.gitLab != null) {
        addButton(IMAGE_PATH + '/gitlab-logo.svg', mxResources.get('gitlab'), function () {
            editorUi.gitLab.pickFile(function (path) {
                if (path != null) {
                    var tokens = path.split('/');
                    var org = tokens[0];
                    var repo = tokens[1];
                    var ref = tokens[2];
                    var path = tokens.slice(3, tokens.length).join('/');

                    linkInput.value = DRAWIO_GITLAB_URL + '/' + org + '/' +
                        repo + '/blob/' + ref + '/' + path;
                    linkInput.focus();
                }
            });
        });
    }
    //TODO should Trello support this?

    mxEvent.addListener(linkInput, 'keypress', function (e) {
        if (e.keyCode == 13) {
            editorUi.hideDialog();
            var value = (pageRadio.checked) ? pageSelect.value : linkInput.value;
            fn(value, LinkDialog.selectedDocs);
        }
    });

    btns.appendChild(mainBtn);

    if (!editorUi.editor.cancelFirst) {
        btns.appendChild(cancelBtn);
    }

    div.appendChild(btns);

    this.container = div;
};

/**
 * Constructs a new about dialog
 */
var FeedbackDialog = function (editorUi) {
    var div = document.createElement('div');

    var label = document.createElement('div');
    mxUtils.write(label, mxResources.get('sendYourFeedbackToDrawIo'));
    label.style.fontSize = '18px';
    label.style.marginBottom = '18px';

    div.appendChild(label);

    label = document.createElement('div');
    mxUtils.write(label, mxResources.get('yourEmailAddress') + ' (' + mxResources.get('required') + ')');

    div.appendChild(label);

    var email = document.createElement('input');
    email.setAttribute('type', 'text');
    email.style.marginTop = '6px';
    email.style.width = '600px';

    var sendButton = mxUtils.button(mxResources.get('sendMessage'), function () {
        var diagram = textarea.value +
            ((cb.checked) ? '\nDiagram:\n' + mxUtils.getXml(editorUi.getXmlFileData()) : '') +
            '\nBrowser:\n' + navigator.userAgent;

        if (diagram.length > FeedbackDialog.maxAttachmentSize) {
            editorUi.alert(mxResources.get('drawingTooLarge'));
        } else {
            editorUi.hideDialog();

            if (editorUi.spinner.spin(document.body)) {
                var postUrl = (FeedbackDialog.feedbackUrl != null) ? FeedbackDialog.feedbackUrl : '/email';
                mxUtils.post(postUrl, 'email=' + encodeURIComponent(email.value) +
                    '&version=' + encodeURIComponent(EditorUi.VERSION) +
                    '&url=' + encodeURIComponent(window.location.href) +
                    '&body=' + encodeURIComponent('Feedback:\n' + diagram),
                    function (req) {
                        editorUi.spinner.stop();

                        if (req.getStatus() >= 200 && req.getStatus() <= 299) {
                            editorUi.alert(mxResources.get('feedbackSent'));
                        } else {
                            editorUi.alert(mxResources.get('errorSendingFeedback'));
                        }
                    },
                    function () {
                        editorUi.spinner.stop();
                        editorUi.alert(mxResources.get('errorSendingFeedback'));
                    });
            }
        }
    });
    sendButton.className = 'geBtn gePrimaryBtn';

    sendButton.setAttribute('disabled', 'disabled');
    var re = /^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;

    mxEvent.addListener(email, 'change', function () {
        if (email.value.length > 0 && re.test(email.value) > 0) {
            sendButton.removeAttribute('disabled');
        } else {
            sendButton.setAttribute('disabled', 'disabled');
        }
    });

    mxEvent.addListener(email, 'keyup', function () {
        if (email.value.length > 0 && re.test(email.value)) {
            sendButton.removeAttribute('disabled');
        } else {
            sendButton.setAttribute('disabled', 'disabled');
        }
    });

    div.appendChild(email);

    this.init = function () {
        email.focus();
    };

    var cb = document.createElement('input');
    cb.setAttribute('type', 'checkbox');
    cb.setAttribute('checked', 'checked');
    cb.defaultChecked = true;

    var p2 = document.createElement('p');
    p2.style.marginTop = '14px';
    p2.appendChild(cb);

    var span = document.createElement('span');
    mxUtils.write(span, ' ' + mxResources.get('includeCopyOfMyDiagram'));
    p2.appendChild(span);

    mxEvent.addListener(span, 'click', function (evt) {
        cb.checked = !cb.checked;
        mxEvent.consume(evt);
    });

    div.appendChild(p2);

    label = document.createElement('div');
    mxUtils.write(label, mxResources.get('feedback'));

    div.appendChild(label);

    var textarea = document.createElement('textarea');
    textarea.style.resize = 'none';
    textarea.style.width = '600px';
    textarea.style.height = '140px';
    textarea.style.marginTop = '6px';

    textarea.setAttribute('placeholder', mxResources.get('comments'));

    div.appendChild(textarea);

    var buttons = document.createElement('div');
    buttons.style.marginTop = '26px';
    buttons.style.textAlign = 'right';

    var cancelBtn = mxUtils.button(mxResources.get('cancel'), function () {
        editorUi.hideDialog();
    });
    cancelBtn.className = 'geBtn';

    if (editorUi.editor.cancelFirst) {
        buttons.appendChild(cancelBtn);
        buttons.appendChild(sendButton);
    } else {
        buttons.appendChild(sendButton);
        buttons.appendChild(cancelBtn);
    }

    div.appendChild(buttons);
    this.container = div;
};

/**
 * Maximum size of attachments in bytes. Default is 1000000.
 */
FeedbackDialog.maxAttachmentSize = 1000000;

/**
 * Constructs a new revision dialog
 */
var DraftDialog = function (editorUi, title, xml, editFn, discardFn, editLabel, discardLabel, ignoreFn) {
    var div = document.createElement('div');

    var titleDiv = document.createElement('div');
    titleDiv.style.marginTop = '0px';
    titleDiv.style.whiteSpace = 'nowrap';
    titleDiv.style.overflow = 'auto';
    mxUtils.write(titleDiv, title);
    div.appendChild(titleDiv);

    var container = document.createElement('div');
    container.style.position = 'absolute';
    container.style.border = '1px solid lightGray';
    container.style.marginTop = '10px';
    container.style.width = '640px';
    container.style.top = '46px';
    container.style.bottom = '74px';
    container.style.overflow = 'hidden';

    mxEvent.disableContextMenu(container);
    div.appendChild(container);

    var graph = new Graph(container);
    graph.setEnabled(false);
    graph.setPanning(true);
    graph.panningHandler.ignoreCell = true;
    graph.panningHandler.useLeftButtonForPanning = true;
    graph.minFitScale = null;
    graph.maxFitScale = null;
    graph.centerZoom = true;

    // Handles placeholders for pages
    var doc = mxUtils.parseXml(xml);
    var node = editorUi.editor.extractGraphModel(doc.documentElement, true);
    var currentPage = 0;
    var diagrams = null;
    var graphGetGlobalVariable = graph.getGlobalVariable;

    graph.getGlobalVariable = function (name) {
        if (name == 'page' && diagrams != null && diagrams[currentPage] != null) {
            return diagrams[currentPage].getAttribute('name');
        } else if (name == 'pagenumber') {
            return currentPage + 1;
        } else if (name == 'pagecount') {
            return (diagrams != null) ? diagrams.length : 1;
        }

        return graphGetGlobalVariable.apply(this, arguments);
    };

    // Disables hyperlinks
    graph.getLinkForCell = function () {
        return null;
    };

    var zoomInBtn = mxUtils.button('', function () {
        graph.zoomIn();
    });
    zoomInBtn.className = 'geSprite geSprite-zoomin';
    zoomInBtn.setAttribute('title', mxResources.get('zoomIn'));
    zoomInBtn.style.outline = 'none';
    zoomInBtn.style.border = 'none';
    zoomInBtn.style.margin = '2px';
    mxUtils.setOpacity(zoomInBtn, 60);

    var zoomOutBtn = mxUtils.button('', function () {
        graph.zoomOut();
    });
    zoomOutBtn.className = 'geSprite geSprite-zoomout';
    zoomOutBtn.setAttribute('title', mxResources.get('zoomOut'));
    zoomOutBtn.style.outline = 'none';
    zoomOutBtn.style.border = 'none';
    zoomOutBtn.style.margin = '2px';
    mxUtils.setOpacity(zoomOutBtn, 60);

    var zoomFitBtn = mxUtils.button('', function () {
        graph.maxFitScale = 8;
        graph.fit(8);
        graph.center();
    });
    zoomFitBtn.className = 'geSprite geSprite-fit';
    zoomFitBtn.setAttribute('title', mxResources.get('fit'));
    zoomFitBtn.style.outline = 'none';
    zoomFitBtn.style.border = 'none';
    zoomFitBtn.style.margin = '2px';
    mxUtils.setOpacity(zoomFitBtn, 60);

    var zoomActualBtn = mxUtils.button('', function () {
        graph.zoomActual();
        graph.center();
    });
    zoomActualBtn.className = 'geSprite geSprite-actualsize';
    zoomActualBtn.setAttribute('title', mxResources.get('actualSize'));
    zoomActualBtn.style.outline = 'none';
    zoomActualBtn.style.border = 'none';
    zoomActualBtn.style.margin = '2px';
    mxUtils.setOpacity(zoomActualBtn, 60);

    var restoreBtn = mxUtils.button(discardLabel || mxResources.get('discard'), discardFn);
    restoreBtn.className = 'geBtn';

    var pageSelect = document.createElement('select');
    pageSelect.style.maxWidth = '80px';
    pageSelect.style.position = 'relative';
    pageSelect.style.top = '-2px';
    pageSelect.style.verticalAlign = 'bottom';
    pageSelect.style.marginRight = '6px';
    pageSelect.style.display = 'none';

    var showBtn = mxUtils.button(editLabel || mxResources.get('edit'), editFn);
    showBtn.className = 'geBtn gePrimaryBtn';

    var buttons = document.createElement('div');
    buttons.style.position = 'absolute';
    buttons.style.bottom = '30px';
    buttons.style.width = '640px';
    buttons.style.textAlign = 'right';

    var tb = document.createElement('div');
    tb.className = 'geToolbarContainer';
    tb.style.cssText = 'box-shadow:none !important;background-color:transparent;' +
        'padding:2px;border-style:none !important;bottom:30px;';

    this.init = function () {
        function parseGraphModel(dataNode) {
            if (dataNode != null) {
                var bg = dataNode.getAttribute('background');

                if (bg == null || bg == '' || bg == mxConstants.NONE) {
                    bg = '#ffffff';
                }

                container.style.backgroundColor = bg;

                var codec = new mxCodec(dataNode.ownerDocument);
                codec.decode(dataNode, graph.getModel());
                graph.maxFitScale = 1;
                graph.fit(8);
                graph.center();
            }
        };

        function parseDiagram(diagramNode) {
            if (diagramNode != null) {
                diagramNode = parseGraphModel(mxUtils.parseXml(Graph.decompress(
                    mxUtils.getTextContent(diagramNode))).documentElement);
            }

            return diagramNode;
        };

        mxEvent.addListener(pageSelect, 'change', function (evt) {
            currentPage = parseInt(pageSelect.value);
            parseDiagram(diagrams[currentPage]);
            mxEvent.consume(evt);
        });

        if (node.nodeName == 'mxfile') {
            // Workaround for "invalid calling object" error in IE
            var tmp = node.getElementsByTagName('diagram');
            diagrams = [];

            for (var i = 0; i < tmp.length; i++) {
                diagrams.push(tmp[i]);
            }

            if (diagrams.length > 0) {
                parseDiagram(diagrams[currentPage]);
            }

            if (diagrams.length > 1) {
                pageSelect.style.display = '';

                for (var i = 0; i < diagrams.length; i++) {
                    var pageOption = document.createElement('option');
                    mxUtils.write(pageOption, diagrams[i].getAttribute('name') ||
                        mxResources.get('pageWithNumber', [i + 1]));
                    pageOption.setAttribute('value', i);

                    if (i == currentPage) {
                        pageOption.setAttribute('selected', 'selected');
                    }

                    pageSelect.appendChild(pageOption);
                }
            }
        } else {
            parseGraphModel(node);
        }
    };

    tb.appendChild(pageSelect);
    tb.appendChild(zoomInBtn);
    tb.appendChild(zoomOutBtn);
    tb.appendChild(zoomActualBtn);
    tb.appendChild(zoomFitBtn);

    var cancelBtn = mxUtils.button(mxResources.get('cancel'), function () {
        editorUi.hideDialog(true);
    });

    cancelBtn.className = 'geBtn';

    var ignoreBtn = (ignoreFn != null) ? mxUtils.button(mxResources.get('ignore'), ignoreFn) : null;

    if (ignoreBtn != null) {
        ignoreBtn.className = 'geBtn';
    }

    if (editorUi.editor.cancelFirst) {
        buttons.appendChild(cancelBtn);

        if (ignoreBtn != null) {
            buttons.appendChild(ignoreBtn);
        }

        buttons.appendChild(restoreBtn);
        buttons.appendChild(showBtn);
    } else {
        buttons.appendChild(showBtn);
        buttons.appendChild(restoreBtn);

        if (ignoreBtn != null) {
            buttons.appendChild(ignoreBtn);
        }

        buttons.appendChild(cancelBtn);
    }

    div.appendChild(buttons);
    div.appendChild(tb);

    this.container = div;
};

/**
 *
 */
var FindWindow = function (ui, x, y, w, h) {
    var action = ui.actions.get('find');
    var graph = ui.editor.graph;
    var lastSearch = null;
    var lastFound = null;

    var div = document.createElement('div');
    div.style.userSelect = 'none';
    div.style.overflow = 'hidden';
    div.style.padding = '10px';
    div.style.height = '100%';

    var searchInput = document.createElement('input');
    searchInput.setAttribute('placeholder', mxResources.get('find'));
    searchInput.setAttribute('type', 'text');
    searchInput.style.marginTop = '4px';
    searchInput.style.marginBottom = '6px';
    searchInput.style.width = '200px';
    searchInput.style.fontSize = '12px';
    searchInput.style.borderRadius = '4px';
    searchInput.style.padding = '6px';
    div.appendChild(searchInput);
    mxUtils.br(div);

    var regexInput = document.createElement('input');
    regexInput.setAttribute('type', 'checkbox');
    regexInput.style.marginRight = '4px';
    div.appendChild(regexInput);

    mxUtils.write(div, mxResources.get('regularExpression'));

    var help = ui.menus.createHelpLink('https://desk.draw.io/support/solutions/articles/16000088250');
    help.style.position = 'relative';
    help.style.marginLeft = '6px';
    help.style.top = '-1px';
    div.appendChild(help);

    var tmp = document.createElement('div');

    function testMeta(re, cell, search) {
        if (typeof cell.value === 'object' && cell.value.attributes != null) {
            var attrs = cell.value.attributes;

            for (var i = 0; i < attrs.length; i++) {
                if (attrs[i].nodeName != 'label') {
                    var value = mxUtils.trim(attrs[i].nodeValue.replace(/[\x00-\x1F\x7F-\x9F]|\s+/g, ' ')).toLowerCase();

                    if ((re == null && value.substring(0, search.length) === search) ||
                        (re != null && re.test(value))) {
                        return true;
                    }
                }
            }
        }

        return false;
    };

    function search() {
        var cells = graph.model.getDescendants(graph.model.getRoot());
        var search = searchInput.value.toLowerCase();
        var re = (regexInput.checked) ? new RegExp(search) : null;
        var firstMatch = null;

        if (lastSearch != search) {
            lastSearch = search;
            lastFound = null;
        }

        var active = lastFound == null;

        if (search.length > 0) {
            for (var i = 0; i < cells.length; i++) {
                var state = graph.view.getState(cells[i]);

                if (state != null && state.cell.value != null && (active || firstMatch == null) &&
                    (graph.model.isVertex(state.cell) || graph.model.isEdge(state.cell))) {
                    if (graph.isHtmlLabel(state.cell)) {
                        tmp.innerHTML = graph.getLabel(state.cell);
                        label = mxUtils.extractTextWithWhitespace([tmp]);
                    } else {
                        label = graph.getLabel(state.cell);
                    }

                    label = mxUtils.trim(label.replace(/[\x00-\x1F\x7F-\x9F]|\s+/g, ' ')).toLowerCase();

                    if ((re == null && (label.substring(0, search.length) === search || testMeta(re, state.cell, search))) ||
                        (re != null && (re.test(label) || testMeta(re, state.cell, search)))) {
                        if (active) {
                            firstMatch = state;

                            break;
                        } else if (firstMatch == null) {
                            firstMatch = state;
                        }
                    }
                }

                active = active || state == lastFound;
            }
        }

        if (firstMatch != null) {
            lastFound = firstMatch;
            graph.scrollCellToVisible(lastFound.cell);

            if (graph.isEnabled()) {
                graph.setSelectionCell(lastFound.cell);
            } else {
                graph.highlightCell(lastFound.cell);
            }
        } else if (graph.isEnabled()) {
            graph.clearSelection();
        }

        return search.length == 0 || firstMatch != null;
    };

    mxUtils.br(div);

    var resetBtn = mxUtils.button(mxResources.get('reset'), function () {
        searchInput.value = '';
        searchInput.style.backgroundColor = '';
        lastFound = null;
        lastSearch = null;
        searchInput.focus();
    });

    resetBtn.setAttribute('title', mxResources.get('reset'));
    resetBtn.style.marginTop = '6px';
    resetBtn.style.marginRight = '4px';
    resetBtn.className = 'geBtn';

    div.appendChild(resetBtn);

    var btn = mxUtils.button(mxResources.get('find'), function () {
        try {
            searchInput.style.backgroundColor = search() ? '' : '#ffcfcf';
        } catch (e) {
            ui.handleError(e);
        }
    });

    btn.setAttribute('title', mxResources.get('find') + ' (Enter)');
    btn.style.marginTop = '6px';
    btn.className = 'geBtn gePrimaryBtn';

    div.appendChild(btn);

    mxEvent.addListener(searchInput, 'keyup', function (evt) {
        // Ctrl or Cmd keys
        if (evt.keyCode == 91 || evt.keyCode == 17) {
            // Workaround for lost focus on show
            mxEvent.consume(evt);
        } else if (evt.keyCode == 27) {
            action.funct();
        } else if (lastSearch != searchInput.value.toLowerCase() || evt.keyCode == 13) {
            try {
                searchInput.style.backgroundColor = search() ? '' : '#ffcfcf';
            } catch (e) {
                searchInput.style.backgroundColor = '#ffcfcf';
            }
        }
    });

    mxEvent.addListener(div, 'keydown', function (evt) {
        if (evt.keyCode == 70 && ui.keyHandler.isControlDown(evt) && !mxEvent.isShiftDown(evt)) {
            action.funct();
            mxEvent.consume(evt);
        }
    });

    this.window = new mxWindow(mxResources.get('find'), div, x, y, w, h, true, true);
    this.window.destroyOnClose = false;
    this.window.setMaximizable(false);
    this.window.setResizable(false);
    this.window.setClosable(true);

    this.window.addListener('show', mxUtils.bind(this, function () {
        this.window.fit();

        if (this.window.isVisible()) {
            searchInput.focus();

            if (mxClient.IS_GC || mxClient.IS_FF || document.documentMode >= 5 || mxClient.IS_QUIRKS) {
                searchInput.select();
            } else {
                document.execCommand('selectAll', false, null);
            }
        } else {
            graph.container.focus();
        }
    }));

    this.window.setLocation = function (x, y) {
        var iw = window.innerWidth || document.body.clientWidth || document.documentElement.clientWidth;
        var ih = window.innerHeight || document.body.clientHeight || document.documentElement.clientHeight;

        x = Math.max(0, Math.min(x, iw - this.table.clientWidth));
        y = Math.max(0, Math.min(y, ih - this.table.clientHeight - 48));

        if (this.getX() != x || this.getY() != y) {
            mxWindow.prototype.setLocation.apply(this, arguments);
        }
    };

    var resizeListener = mxUtils.bind(this, function () {
        var x = this.window.getX();
        var y = this.window.getY();

        this.window.setLocation(x, y);
    });

    mxEvent.addListener(window, 'resize', resizeListener);

    this.destroy = function () {
        mxEvent.removeListener(window, 'resize', resizeListener);
        this.window.destroy();
    }
};

/**
 *
 */
var FreehandWindow = function (editorUi, x, y, w, h) {
    var graph = editorUi.editor.graph;
    var propertyName = 'tags';

    var div = document.createElement('div');
    div.style.userSelect = 'none';
    div.style.overflow = 'hidden';
    div.style.height = '100%';

    var startBtn = mxUtils.button(mxResources.get('startDrawing'), function () {
        if (graph.freehand.isDrawing()) {
            graph.freehand.stopDrawing();
        }

        graph.freehand.startDrawing();
    });

    startBtn.setAttribute('title', mxResources.get('startDrawing'));
    startBtn.style.marginTop = '8px';
    startBtn.style.marginRight = '4px';
    startBtn.style.width = '160px';
    startBtn.style.overflow = 'hidden';
    startBtn.style.textOverflow = 'ellipsis';
    startBtn.style.textAlign = 'center';
    startBtn.className = 'geBtn gePrimaryBtn';

    div.appendChild(startBtn);

    var stopBtn = startBtn.cloneNode(false);
    mxUtils.write(stopBtn, mxResources.get('stopDrawing'));
    stopBtn.setAttribute('title', mxResources.get('stopDrawing'));
    stopBtn.style.marginTop = '4px';

    mxEvent.addListener(stopBtn, 'click', function () {
        graph.freehand.stopDrawing();
    });

    div.appendChild(stopBtn);

    this.window = new mxWindow(mxResources.get('freehand'), div, x, y, w, h, true, true);
    this.window.destroyOnClose = false;
    this.window.setMaximizable(false);
    this.window.setResizable(false);
    this.window.setClosable(true);

    graph.addListener('freehandStateChanged', mxUtils.bind(this, function () {
        stopBtn.className = 'geBtn' + (graph.freehand.isDrawing() ? ' gePrimaryBtn' : '');
    }));

    this.window.addListener('show', mxUtils.bind(this, function () {
        this.window.fit();
    }));

    this.window.addListener('hide', mxUtils.bind(this, function () {
        if (graph.freehand.isDrawing()) {
            graph.freehand.stopDrawing();
        }
    }));

    this.window.setLocation = function (x, y) {
        var iw = window.innerWidth || document.body.clientWidth || document.documentElement.clientWidth;
        var ih = window.innerHeight || document.body.clientHeight || document.documentElement.clientHeight;

        x = Math.max(0, Math.min(x, iw - this.table.clientWidth));
        y = Math.max(0, Math.min(y, ih - this.table.clientHeight - 48));

        if (this.getX() != x || this.getY() != y) {
            mxWindow.prototype.setLocation.apply(this, arguments);
        }
    };

    var resizeListener = mxUtils.bind(this, function () {
        var x = this.window.getX();
        var y = this.window.getY();

        this.window.setLocation(x, y);
    });

    mxEvent.addListener(window, 'resize', resizeListener);

    this.destroy = function () {
        mxEvent.removeListener(window, 'resize', resizeListener);
        this.window.destroy();
    }
};

/**
 *
 */
var TagsWindow = function (editorUi, x, y, w, h) {
    var graph = editorUi.editor.graph;
    var propertyName = 'tags';

    var div = document.createElement('div');
    div.style.userSelect = 'none';
    div.style.overflow = 'hidden';
    div.style.padding = '10px';
    div.style.height = '100%';

    var searchInput = document.createElement('input');
    searchInput.setAttribute('placeholder', mxResources.get('allTags'));
    searchInput.setAttribute('type', 'text');
    searchInput.style.marginTop = '4px';
    searchInput.style.width = '260px';
    searchInput.style.fontSize = '12px';
    searchInput.style.borderRadius = '4px';
    searchInput.style.padding = '6px';
    div.appendChild(searchInput);

    if (!editorUi.isOffline() || mxClient.IS_CHROMEAPP) {
        searchInput.style.width = '240px';
        var elt = editorUi.menus.createHelpLink('https://desk.draw.io/support/solutions/articles/16000046966');
        elt.firstChild.style.marginBottom = '6px';
        elt.style.marginLeft = '6px';
        div.appendChild(elt);
    }

    mxEvent.addListener(searchInput, 'dblclick', function () {
        var dlg = new FilenameDialog(editorUi, propertyName, mxResources.get('ok'), mxUtils.bind(this, function (name) {
            if (name != null && name.length > 0) {
                propertyName = name;
            }
        }), mxResources.get('enterPropertyName'));
        editorUi.showDialog(dlg.container, 300, 130, true, true);
        dlg.init();
    });

    searchInput.setAttribute('title', mxResources.get('doubleClickChangeProperty'));

    function searchCells(cells) {
        return graph.getCellsForTags(searchInput.value.split(' '), cells, propertyName, true);
    };

    function setCellsVisible(cells, visible) {
        graph.setCellsVisible(cells, visible);
    };

    mxUtils.br(div);

    var hideBtn = mxUtils.button(mxResources.get('hide'), function () {
        setCellsVisible(searchCells(), false);
    });

    hideBtn.setAttribute('title', mxResources.get('hide'));
    hideBtn.style.marginTop = '8px';
    hideBtn.style.marginRight = '4px';
    hideBtn.className = 'geBtn';

    div.appendChild(hideBtn);

    var showBtn = mxUtils.button(mxResources.get('show'), function () {
        var cells = searchCells();
        setCellsVisible(cells, true);

        if (graph.isEnabled()) {
            // Ignores layers for selection
            var temp = [];

            for (var i = 0; i < cells.length; i++) {
                if (graph.model.isVertex(cells[i]) || graph.model.isEdge(cells[i])) {
                    temp.push(cells[i]);
                }
            }

            graph.setSelectionCells(temp);
        } else {
            for (var i = 0; i < cells.length; i++) {
                graph.highlightCell(cells[i]);
            }
        }
    });

    showBtn.setAttribute('title', mxResources.get('show'));
    showBtn.style.marginTop = '8px';
    showBtn.style.marginRight = '4px';
    showBtn.className = 'geBtn';

    div.appendChild(showBtn);

    var action = editorUi.actions.get('tags');

    var btn = mxUtils.button(mxResources.get('close'), function () {
        action.funct();
    });

    btn.setAttribute('title', mxResources.get('close') + ' (Enter/Esc)');
    btn.style.marginTop = '8px';
    btn.className = 'geBtn gePrimaryBtn';

    div.appendChild(btn);

    mxEvent.addListener(searchInput, 'keyup', function (evt) {
        // Ctrl or Cmd keys
        if (evt.keyCode == 13 || evt.keyCode == 27) {
            action.funct();
        }
    });

    this.window = new mxWindow(mxResources.get('tags'), div, x, y, w, h, true, true);
    this.window.destroyOnClose = false;
    this.window.setMaximizable(false);
    this.window.setResizable(false);
    this.window.setClosable(true);

    this.window.addListener('show', mxUtils.bind(this, function () {
        this.window.fit();

        if (this.window.isVisible()) {
            searchInput.focus();

            if (mxClient.IS_GC || mxClient.IS_FF || document.documentMode >= 5 || mxClient.IS_QUIRKS) {
                searchInput.select();
            } else {
                document.execCommand('selectAll', false, null);
            }
        } else {
            graph.container.focus();
        }
    }));

    this.window.setLocation = function (x, y) {
        var iw = window.innerWidth || document.body.clientWidth || document.documentElement.clientWidth;
        var ih = window.innerHeight || document.body.clientHeight || document.documentElement.clientHeight;

        x = Math.max(0, Math.min(x, iw - this.table.clientWidth));
        y = Math.max(0, Math.min(y, ih - this.table.clientHeight - 48));

        if (this.getX() != x || this.getY() != y) {
            mxWindow.prototype.setLocation.apply(this, arguments);
        }
    };

    var resizeListener = mxUtils.bind(this, function () {
        var x = this.window.getX();
        var y = this.window.getY();

        this.window.setLocation(x, y);
    });

    mxEvent.addListener(window, 'resize', resizeListener);

    this.destroy = function () {
        mxEvent.removeListener(window, 'resize', resizeListener);
        this.window.destroy();
    }
};

/**
 * Constructs a new auth dialog.
 */
var AuthDialog = function (editorUi, peer, showRememberOption, fn) {
    var div = document.createElement('div');
    div.style.textAlign = 'center';

    var hd = document.createElement('p');
    hd.style.fontSize = '16pt';
    hd.style.padding = '10px 0';
    hd.style.margin = '0px';
    hd.style.color = 'gray';

    mxUtils.write(hd, mxResources.get('authorizationRequired'));

    var service = 'Unknown';

    var img = document.createElement('img');
    img.setAttribute('border', '0');
    img.setAttribute('align', 'absmiddle');
    img.style.marginRight = '10px';

    if (peer == editorUi.drive) {
        service = mxResources.get('googleDrive');
        img.src = IMAGE_PATH + '/google-drive-logo-white.svg';
    } else if (peer == editorUi.dropbox) {
        service = mxResources.get('dropbox');
        img.src = IMAGE_PATH + '/dropbox-logo-white.svg';
    } else if (peer == editorUi.oneDrive) {
        service = mxResources.get('oneDrive');
        img.src = IMAGE_PATH + '/onedrive-logo-white.svg';
    } else if (peer == editorUi.gitHub) {
        service = mxResources.get('github');
        img.src = IMAGE_PATH + '/github-logo-white.svg';
    } else if (peer == editorUi.gitLab) {
        service = mxResources.get('gitlab');
        img.src = IMAGE_PATH + '/gitlab-logo.svg';
        img.style.width = '32px';
    } else if (peer == editorUi.trello) {
        service = mxResources.get('trello');
        img.src = IMAGE_PATH + '/trello-logo-white.svg';
    }

    var p = document.createElement('p');
    mxUtils.write(p, mxResources.get('authorizeThisAppIn', [service]));

    var cb = document.createElement('input');
    cb.setAttribute('type', 'checkbox');

    var button = mxUtils.button(mxResources.get('authorize'), function () {
        fn(cb.checked);
    });

    button.insertBefore(img, button.firstChild);
    button.style.marginTop = '6px';
    button.className = 'geBigButton';
    button.style.fontSize = '18px';
    button.style.padding = '14px';

    div.appendChild(hd);
    div.appendChild(p);
    div.appendChild(button);

    if (showRememberOption) {
        var p2 = document.createElement('p');
        p2.style.marginTop = '20px';
        p2.appendChild(cb);
        var span = document.createElement('span');
        mxUtils.write(span, ' ' + mxResources.get('rememberMe'));
        p2.appendChild(span);
        div.appendChild(p2);
        cb.checked = true;
        cb.defaultChecked = true;

        mxEvent.addListener(span, 'click', function (evt) {
            cb.checked = !cb.checked;
            mxEvent.consume(evt);
        });
    }

    this.container = div;
};

var MoreShapesDialog = function (editorUi, expanded, entries) {
    entries = (entries != null) ? entries : editorUi.sidebar.entries;
    var div = document.createElement('div');
    var newEntries = [];

    // Adds custom sections first
    if (editorUi.sidebar.customEntries != null) {
        for (var i = 0; i < editorUi.sidebar.customEntries.length; i++) {
            var section = editorUi.sidebar.customEntries[i];
            var tmp = {title: editorUi.getResource(section.title), entries: []};

            for (var j = 0; j < section.entries.length; j++) {
                var entry = section.entries[j];
                tmp.entries.push({
                    id: entry.id, title:
                        editorUi.getResource(entry.title),
                    desc: editorUi.getResource(entry.desc),
                    image: entry.preview
                });
            }

            newEntries.push(tmp);
        }
    }

    // Adds built-in sections and filter entries
    for (var i = 0; i < entries.length; i++) {
        if (editorUi.sidebar.enabledLibraries == null) {
            newEntries.push(entries[i]);
        } else {
            var tmp = {title: entries[i].title, entries: []};

            for (var j = 0; j < entries[i].entries.length; j++) {
                if (mxUtils.indexOf(editorUi.sidebar.enabledLibraries,
                    entries[i].entries[j].id) >= 0) {
                    tmp.entries.push(entries[i].entries[j]);
                }
            }

            if (tmp.entries.length > 0) {
                newEntries.push(tmp);
            }
        }
    }

    entries = newEntries;

    if (expanded) {
        var addEntries = mxUtils.bind(this, function (e) {
            for (var i = 0; i < e.length; i++) {
                (function (section) {
                    var title = listEntry.cloneNode(false);
                    title.style.fontWeight = 'bold';
                    title.style.backgroundColor = (uiTheme == 'dark') ? '#505759' : '#e5e5e5';
                    title.style.padding = '6px 0px 6px 20px';
                    mxUtils.write(title, section.title);
                    list.appendChild(title);

                    for (var j = 0; j < section.entries.length; j++) {
                        (function (entry) {
                            var option = listEntry.cloneNode(false);
                            option.style.cursor = 'pointer';
                            option.style.padding = '4px 0px 4px 20px';
                            option.style.whiteSpace = 'nowrap';
                            option.style.overflow = 'hidden';
                            option.style.textOverflow = 'ellipsis';
                            option.setAttribute('title', entry.title + ' (' + entry.id + ')');

                            var checkbox = document.createElement('input');
                            checkbox.setAttribute('type', 'checkbox');
                            checkbox.checked = editorUi.sidebar.isEntryVisible(entry.id);
                            checkbox.defaultChecked = checkbox.checked;
                            option.appendChild(checkbox);
                            mxUtils.write(option, ' ' + entry.title);

                            list.appendChild(option);

                            var itemClicked = function (evt) {
                                if (evt == null || mxEvent.getSource(evt).nodeName != 'INPUT') {
                                    preview.style.textAlign = 'center';
                                    preview.style.padding = '0px';
                                    preview.style.color = '';
                                    preview.innerHTML = '';

                                    if (entry.desc != null) {
                                        var pre = document.createElement('pre');
                                        pre.style.boxSizing = 'border-box';
                                        pre.style.fontFamily = 'inherit';
                                        pre.style.margin = '20px';
                                        pre.style.right = '0px';
                                        pre.style.textAlign = 'left';
                                        mxUtils.write(pre, entry.desc);
                                        preview.appendChild(pre);
                                    }

                                    if (entry.imageCallback != null) {
                                        entry.imageCallback(preview);
                                    } else if (entry.image != null) {
                                        preview.innerHTML += '<img border="0" src="' + entry.image + '"/>';
                                    } else if (entry.desc == null) {
                                        preview.style.padding = '20px';
                                        preview.style.color = 'rgb(179, 179, 179)';
                                        mxUtils.write(preview, mxResources.get('noPreview'));
                                    }

                                    if (currentListItem != null) {
                                        currentListItem.style.backgroundColor = '';
                                    }

                                    currentListItem = option;
                                    currentListItem.style.backgroundColor = (uiTheme == 'dark') ? '#505759' : '#ebf2f9';

                                    if (evt != null) {
                                        mxEvent.consume(evt);
                                    }
                                }
                            };

                            mxEvent.addListener(option, 'click', itemClicked);
                            mxEvent.addListener(option, 'dblclick', function (evt) {
                                checkbox.checked = !checkbox.checked;
                                mxEvent.consume(evt);
                            });

                            applyFunctions.push(function () {
                                return (checkbox.checked) ? entry.id : null;
                            });

                            // Selects first entry
                            if (i == 0 && j == 0) {
                                itemClicked();
                            }
                        })(section.entries[j]);
                    }
                })(e[i]);
            }
        });

        var hd = document.createElement('div');
        hd.className = 'geDialogTitle';
        mxUtils.write(hd, mxResources.get('shapes'));
        hd.style.position = 'absolute';
        hd.style.top = '0px';
        hd.style.left = '0px';
        hd.style.lineHeight = '40px';
        hd.style.height = '40px';
        hd.style.right = '0px';

        if (mxClient.IS_QUIRKS) {
            hd.style.width = '718px';
        }

        var list = document.createElement('div');
        var preview = document.createElement('div');

        list.style.position = 'absolute';
        list.style.top = '40px';
        list.style.left = '0px';
        list.style.width = '202px';
        list.style.bottom = '60px';
        list.style.overflow = 'auto';

        if (mxClient.IS_QUIRKS) {
            list.style.height = '437px';
            list.style.marginTop = '1px';
        }

        preview.style.position = 'absolute';
        preview.style.left = '202px';
        preview.style.right = '0px';
        preview.style.top = '40px';
        preview.style.bottom = '60px';
        preview.style.overflow = 'auto';
        preview.style.borderLeft = '1px solid rgb(211, 211, 211)';
        preview.style.textAlign = 'center';

        if (mxClient.IS_QUIRKS) {
            preview.style.width = parseInt(hd.style.width) - 202 + 'px';
            preview.style.height = list.style.height;
            preview.style.marginTop = list.style.marginTop;
        }

        var currentListItem = null;
        var applyFunctions = [];

        var listEntry = document.createElement('div');
        listEntry.style.position = 'relative';
        listEntry.style.left = '0px';
        listEntry.style.right = '0px';

        addEntries(entries);
        div.style.padding = '30px';

        div.appendChild(hd);
        div.appendChild(list);
        div.appendChild(preview);

        var buttons = document.createElement('div');
        buttons.className = 'geDialogFooter';
        buttons.style.position = 'absolute';
        buttons.style.paddingRight = '16px';
        buttons.style.color = 'gray';
        buttons.style.left = '0px';
        buttons.style.right = '0px';
        buttons.style.bottom = '0px';
        buttons.style.height = '60px';
        buttons.style.lineHeight = '52px';

        if (mxClient.IS_QUIRKS) {
            buttons.style.width = hd.style.width;
            buttons.style.paddingTop = '12px';
        }

        var cb = document.createElement('input');
        cb.setAttribute('type', 'checkbox');

        if (isLocalStorage || mxClient.IS_CHROMEAPP) {
            var span = document.createElement('span');
            span.style.paddingRight = '20px';
            span.appendChild(cb);
            mxUtils.write(span, ' ' + mxResources.get('rememberThisSetting'));
            cb.checked = true;
            cb.defaultChecked = true;

            mxEvent.addListener(span, 'click', function (evt) {
                if (mxEvent.getSource(evt) != cb) {
                    cb.checked = !cb.checked;
                    mxEvent.consume(evt);
                }
            });

            if (mxClient.IS_QUIRKS) {
                span.style.position = 'relative';
                span.style.top = '-6px';
            }

            buttons.appendChild(span);
        }

        var cancelBtn = mxUtils.button(mxResources.get('cancel'), function () {
            editorUi.hideDialog();
        });
        cancelBtn.className = 'geBtn';

        var applyBtn = mxUtils.button(mxResources.get('apply'), function () {
            editorUi.hideDialog();
            var libs = [];

            for (var i = 0; i < applyFunctions.length; i++) {
                var lib = applyFunctions[i].apply(this, arguments);

                if (lib != null) {
                    libs.push(lib);
                }
            }

            editorUi.sidebar.showEntries(libs.join(';'), cb.checked, true);
        });
        applyBtn.className = 'geBtn gePrimaryBtn';

        if (editorUi.editor.cancelFirst) {
            buttons.appendChild(cancelBtn);
            buttons.appendChild(applyBtn);
        } else {
            buttons.appendChild(applyBtn);
            buttons.appendChild(cancelBtn);
        }

        div.appendChild(buttons);
    } else {
        var libFS = document.createElement('table');
        var tbody = document.createElement('tbody');
        div.style.height = '100%';
        div.style.overflow = 'auto';
        var row = document.createElement('tr');
        libFS.style.width = '100%';

        var leftDiv = document.createElement('td');
        var midDiv = document.createElement('td');
        var rightDiv = document.createElement('td');

        var addLibCB = mxUtils.bind(this, function (wrapperDiv, title, key) {
            var libCB = document.createElement('input');
            libCB.type = 'checkbox';
            libFS.appendChild(libCB);

            libCB.checked = editorUi.sidebar.isEntryVisible(key);

            var libSpan = document.createElement('span');
            mxUtils.write(libSpan, title);

            var label = document.createElement('div');
            label.style.display = 'block';
            label.appendChild(libCB);
            label.appendChild(libSpan);

            mxEvent.addListener(libSpan, 'click', function (evt) {
                libCB.checked = !libCB.checked;
                mxEvent.consume(evt);
            });

            wrapperDiv.appendChild(label);

            return function () {
                return (libCB.checked) ? key : null;
            };
        });

        row.appendChild(leftDiv);
        row.appendChild(midDiv);
        row.appendChild(rightDiv);

        tbody.appendChild(row);
        libFS.appendChild(tbody);

        var applyFunctions = [];
        var count = 0;

        // Counts total number of entries
        for (var i = 0; i < entries.length; i++) {
            for (var j = 0; j < entries[i].entries.length; j++) {
                count++;
            }
        }

        // Distributes entries on columns
        var cols = [leftDiv, midDiv, rightDiv];
        var counter = 0;

        for (var i = 0; i < entries.length; i++) {
            (function (section) {
                for (var j = 0; j < section.entries.length; j++) {
                    (function (entry) {
                        var index = Math.floor(counter / (count / 3));
                        applyFunctions.push(addLibCB(cols[index], entry.title, entry.id));
                        counter++;
                    })(section.entries[j]);
                }
            })(entries[i]);
        }

        div.appendChild(libFS);

        var remember = document.createElement('div');
        remember.style.marginTop = '18px';
        remember.style.textAlign = 'center';

        var cb = document.createElement('input');

        if (isLocalStorage) {
            cb.setAttribute('type', 'checkbox');
            cb.checked = true;
            cb.defaultChecked = true;
            remember.appendChild(cb);
            var span = document.createElement('span');
            mxUtils.write(span, ' ' + mxResources.get('rememberThisSetting'));
            remember.appendChild(span);

            mxEvent.addListener(span, 'click', function (evt) {
                cb.checked = !cb.checked;
                mxEvent.consume(evt);
            });
        }

        div.appendChild(remember);

        var cancelBtn = mxUtils.button(mxResources.get('cancel'), function () {
            editorUi.hideDialog();
        });
        cancelBtn.className = 'geBtn';

        var applyBtn = mxUtils.button(mxResources.get('apply'), function () {
            var libs = ['search'];

            for (var i = 0; i < applyFunctions.length; i++) {
                var lib = applyFunctions[i].apply(this, arguments);

                if (lib != null) {
                    libs.push(lib);
                }
            }

            editorUi.sidebar.showEntries((libs.length > 0) ? libs.join(';') : '', cb.checked);
            editorUi.hideDialog();
        });
        applyBtn.className = 'geBtn gePrimaryBtn';

        var buttons = document.createElement('div');
        buttons.style.marginTop = '26px';
        buttons.style.textAlign = 'right';

        if (editorUi.editor.cancelFirst) {
            buttons.appendChild(cancelBtn);
            buttons.appendChild(applyBtn);
        } else {
            buttons.appendChild(applyBtn);
            buttons.appendChild(cancelBtn);
        }

        div.appendChild(buttons);
    }

    this.container = div;
};

var PluginsDialog = function (editorUi) {
    var div = document.createElement('div');
    var inner = document.createElement('div');

    inner.style.height = '120px';
    inner.style.overflow = 'auto';

    var plugins = mxSettings.getPlugins().slice();

    function refresh() {
        if (plugins.length == 0) {
            inner.innerHTML = mxUtils.htmlEntities(mxResources.get('noPlugins'));
        } else {
            inner.innerHTML = '';

            for (var i = 0; i < plugins.length; i++) {
                var span = document.createElement('span');
                span.style.whiteSpace = 'nowrap';

                var img = document.createElement('span');
                img.className = 'geSprite geSprite-delete';
                img.style.position = 'relative';
                img.style.cursor = 'pointer';
                img.style.top = '5px';
                img.style.marginRight = '4px';
                img.style.display = 'inline-block';
                span.appendChild(img);

                mxUtils.write(span, plugins[i]);
                inner.appendChild(span);

                mxUtils.br(inner);

                mxEvent.addListener(img, 'click', (function (index) {
                    return function () {
                        editorUi.confirm(mxResources.get('delete') + ' "' + plugins[index] + '"?', function () {
                            plugins.splice(index, 1);
                            refresh();
                        });
                    };
                })(i));
            }
        }
    }

    div.appendChild(inner);
    refresh();

    var addBtn = mxUtils.button(mxResources.get('add'), function () {
        var tmp = '';
        var param = urlParams['p'];

        if (param != null && param.length > 0) {
            var tokens = param.split(';');

            for (var i = 0; i < tokens.length; i++) {
                var url = App.pluginRegistry[tokens[i]];

                if (url != null) {
                    tmp += url + ';';
                }
            }

            if (tmp.charAt(tmp.length - 1) == ';') {
                tmp = tmp.substring(0, tmp.length - 1);
            }
        }

        var dlg = new FilenameDialog(editorUi, tmp, mxResources.get('add'), function (newValue) {
            if (newValue != null && newValue.length > 0) {
                tokens = newValue.split(';');

                for (var i = 0; i < tokens.length; i++) {
                    var token = tokens[i];
                    var url = App.pluginRegistry[token];

                    if (url != null) {
                        token = url;
                    }

                    if (token.length > 0 && mxUtils.indexOf(plugins, token) < 0) {
                        plugins.push(token);
                    }
                }

                refresh();
            }
        }, mxResources.get('enterValue') + ' (' + mxResources.get('url') + ')');

        editorUi.showDialog(dlg.container, 350, 130, true, true);
        dlg.init();
    });

    addBtn.className = 'geBtn';

    var cancelBtn = mxUtils.button(mxResources.get('cancel'), function () {
        editorUi.hideDialog();
    });

    cancelBtn.className = 'geBtn';

    var applyBtn = mxUtils.button(mxResources.get('apply'), function () {
        mxSettings.setPlugins(plugins);
        mxSettings.save();
        editorUi.hideDialog();
        editorUi.alert(mxResources.get('restartForChangeRequired'));
    });

    applyBtn.className = 'geBtn gePrimaryBtn';

    var buttons = document.createElement('div');
    buttons.style.marginTop = '14px';
    buttons.style.textAlign = 'right';


    var helpBtn = mxUtils.button(mxResources.get('help'), function () {
        editorUi.openLink('https://desk.draw.io/support/solutions/articles/16000056430');
    });

    helpBtn.className = 'geBtn';

    if (editorUi.isOffline() && !mxClient.IS_CHROMEAPP) {
        helpBtn.style.display = 'none';
    }

    buttons.appendChild(helpBtn);

    if (editorUi.editor.cancelFirst) {
        buttons.appendChild(cancelBtn);
        buttons.appendChild(addBtn);
        buttons.appendChild(applyBtn);
    } else {
        buttons.appendChild(addBtn);
        buttons.appendChild(applyBtn);
        buttons.appendChild(cancelBtn);
    }

    div.appendChild(buttons);

    this.container = div;
};

var CropImageDialog = function (editorUi, image, fn) {
    var div = document.createElement('div');

    var table = document.createElement('table');
    var tbody = document.createElement('tbody');

    var row = document.createElement('tr');
    var size = document.createElement('td');
    size.style.whiteSpace = 'nowrap';
    size.setAttribute('colspan', '2');
    mxUtils.write(size, mxResources.get('loading') + '...');
    row.appendChild(size);
    tbody.appendChild(row);

    var row = document.createElement('tr');
    var left = document.createElement('td');
    var right = document.createElement('td');
    table.style.paddingLeft = '6px';

    mxUtils.write(left, mxResources.get('left') + ':');

    var xInput = document.createElement('input');
    xInput.setAttribute('type', 'text');
    xInput.style.width = '100px';
    xInput.value = '0';

    this.init = function () {
        xInput.focus();
        xInput.select();
    };

    right.appendChild(xInput);

    row.appendChild(left);
    row.appendChild(right);

    tbody.appendChild(row);

    row = document.createElement('tr');
    left = document.createElement('td');
    right = document.createElement('td');

    mxUtils.write(left, mxResources.get('top') + ':');

    var yInput = document.createElement('input');
    yInput.setAttribute('type', 'text');
    yInput.style.width = '100px';
    yInput.value = '0';

    right.appendChild(yInput);

    row.appendChild(left);
    row.appendChild(right);

    tbody.appendChild(row);

    row = document.createElement('tr');
    left = document.createElement('td');
    right = document.createElement('td');

    mxUtils.write(left, mxResources.get('right') + ':');

    var wInput = document.createElement('input');
    wInput.setAttribute('type', 'text');
    wInput.style.width = '100px';
    wInput.value = '0';

    right.appendChild(wInput);

    row.appendChild(left);
    row.appendChild(right);

    tbody.appendChild(row);

    row = document.createElement('tr');
    left = document.createElement('td');
    right = document.createElement('td');

    mxUtils.write(left, mxResources.get('bottom') + ':');

    var hInput = document.createElement('input');
    hInput.setAttribute('type', 'text');
    hInput.style.width = '100px';
    hInput.value = '0';

    right.appendChild(hInput);

    row.appendChild(left);
    row.appendChild(right);

    tbody.appendChild(row);

    row = document.createElement('tr');
    left = document.createElement('td');
    right = document.createElement('td');

    mxUtils.write(left, mxResources.get('circle') + ':');

    row.appendChild(left);

    var circleInput = document.createElement('input');
    circleInput.setAttribute('type', 'checkbox');

    right.appendChild(circleInput);
    row.appendChild(right);

    tbody.appendChild(row);

    table.appendChild(tbody);
    div.appendChild(table);

    var cancelBtn = mxUtils.button(mxResources.get('cancel'), function () {
        editorUi.hideDialog();
    });
    cancelBtn.className = 'geBtn';

    var imageObj = new Image();

    var applyBtn = mxUtils.button(mxResources.get('apply'), function () {
        editorUi.hideDialog();

        var canvas = document.createElement('canvas');
        var context = canvas.getContext('2d');
        var w = imageObj.width;
        var h = imageObj.height;

        // draw cropped image
        var sourceX = parseInt(xInput.value);
        var sourceY = parseInt(yInput.value);
        var sourceWidth = Math.max(1, w - sourceX - parseInt(wInput.value));
        var sourceHeight = Math.max(1, h - sourceY - parseInt(hInput.value));
        canvas.width = sourceWidth;
        canvas.height = sourceHeight;

        if (circleInput.checked) {
            context.fillStyle = '#000000';
            context.arc(sourceWidth / 2, sourceHeight / 2, Math.min(sourceWidth / 2,
                sourceHeight / 2), 0, 2 * Math.PI);
            context.fill();
            context.globalCompositeOperation = 'source-in';
        }

        context.drawImage(imageObj, sourceX, sourceY, sourceWidth, sourceHeight, 0, 0, sourceWidth, sourceHeight);
        fn(canvas.toDataURL());
    });

    applyBtn.className = 'geBtn gePrimaryBtn';
    applyBtn.setAttribute('disabled', 'disabled');

    imageObj.onload = function () {
        applyBtn.removeAttribute('disabled');
        size.innerHTML = '';
        mxUtils.write(size, mxResources.get('width') + ': ' + imageObj.width + ' ' +
            mxResources.get('height') + ': ' + imageObj.height);
    };

    imageObj.src = image;

    mxEvent.addListener(div, 'keypress', function (e) {
        if (e.keyCode == 13) {
            applyBtn.click();
        }
    });

    var buttons = document.createElement('div');
    buttons.style.marginTop = '20px';
    buttons.style.textAlign = 'right';

    if (editorUi.editor.cancelFirst) {
        buttons.appendChild(cancelBtn);
        buttons.appendChild(applyBtn);
    } else {
        buttons.appendChild(applyBtn);
        buttons.appendChild(cancelBtn);
    }

    div.appendChild(buttons);

    this.container = div;
};

var EditGeometryDialog = function (editorUi, vertices) {
    var graph = editorUi.editor.graph;
    var geo = (vertices.length == 1) ? graph.getCellGeometry(vertices[0]) : null;
    var div = document.createElement('div');

    var table = document.createElement('table');
    var tbody = document.createElement('tbody');
    var row = document.createElement('tr');
    var left = document.createElement('td');
    var right = document.createElement('td');
    table.style.paddingLeft = '6px';

    mxUtils.write(left, mxResources.get('relative') + ':');

    var relInput = document.createElement('input');
    relInput.setAttribute('type', 'checkbox');

    if (geo != null && geo.relative) {
        relInput.setAttribute('checked', 'checked');
        relInput.defaultChecked = true;
    }

    this.init = function () {
        relInput.focus();
    };

    right.appendChild(relInput);

    row.appendChild(left);
    row.appendChild(right);

    tbody.appendChild(row);

    row = document.createElement('tr');
    left = document.createElement('td');
    right = document.createElement('td');

    mxUtils.write(left, mxResources.get('left') + ':');

    var xInput = document.createElement('input');
    xInput.setAttribute('type', 'text');
    xInput.style.width = '100px';
    xInput.value = (geo != null) ? geo.x : '';

    right.appendChild(xInput);

    row.appendChild(left);
    row.appendChild(right);

    tbody.appendChild(row);

    row = document.createElement('tr');
    left = document.createElement('td');
    right = document.createElement('td');

    mxUtils.write(left, mxResources.get('top') + ':');

    var yInput = document.createElement('input');
    yInput.setAttribute('type', 'text');
    yInput.style.width = '100px';
    yInput.value = (geo != null) ? geo.y : '';

    right.appendChild(yInput);

    row.appendChild(left);
    row.appendChild(right);

    tbody.appendChild(row);

    row = document.createElement('tr');
    left = document.createElement('td');
    right = document.createElement('td');

    mxUtils.write(left, mxResources.get('dx') + ':');

    var dxInput = document.createElement('input');
    dxInput.setAttribute('type', 'text');
    dxInput.style.width = '100px';
    dxInput.value = (geo != null && geo.offset != null) ? geo.offset.x : '';

    right.appendChild(dxInput);

    row.appendChild(left);
    row.appendChild(right);

    tbody.appendChild(row);

    row = document.createElement('tr');
    left = document.createElement('td');
    right = document.createElement('td');

    mxUtils.write(left, mxResources.get('dy') + ':');

    var dyInput = document.createElement('input');
    dyInput.setAttribute('type', 'text');
    dyInput.style.width = '100px';
    dyInput.value = (geo != null && geo.offset != null) ? geo.offset.y : '';

    right.appendChild(dyInput);

    row.appendChild(left);
    row.appendChild(right);

    tbody.appendChild(row);

    row = document.createElement('tr');
    left = document.createElement('td');
    right = document.createElement('td');

    mxUtils.write(left, mxResources.get('width') + ':');

    var wInput = document.createElement('input');
    wInput.setAttribute('type', 'text');
    wInput.style.width = '100px';
    wInput.value = (geo != null) ? geo.width : '';

    right.appendChild(wInput);

    row.appendChild(left);
    row.appendChild(right);

    tbody.appendChild(row);

    row = document.createElement('tr');
    left = document.createElement('td');
    right = document.createElement('td');

    mxUtils.write(left, mxResources.get('height') + ':');

    var hInput = document.createElement('input');
    hInput.setAttribute('type', 'text');
    hInput.style.width = '100px';
    hInput.value = (geo != null) ? geo.height : '';

    right.appendChild(hInput);

    row.appendChild(left);
    row.appendChild(right);

    tbody.appendChild(row);

    row = document.createElement('tr');
    left = document.createElement('td');
    right = document.createElement('td');

    mxUtils.write(left, mxResources.get('rotation') + ':');

    var rotInput = document.createElement('input');
    rotInput.setAttribute('type', 'text');
    rotInput.style.width = '100px';
    rotInput.value = (vertices.length == 1) ? mxUtils.getValue(graph.getCellStyle(vertices[0]),
        mxConstants.STYLE_ROTATION, 0) : '';

    right.appendChild(rotInput);

    row.appendChild(left);
    row.appendChild(right);

    tbody.appendChild(row);

    table.appendChild(tbody);
    div.appendChild(table);

    var cancelBtn = mxUtils.button(mxResources.get('cancel'), function () {
        editorUi.hideDialog();
    });

    cancelBtn.className = 'geBtn';

    var applyBtn = mxUtils.button(mxResources.get('apply'), function () {
        editorUi.hideDialog();

        graph.getModel().beginUpdate();
        try {
            for (var i = 0; i < vertices.length; i++) {
                var g = graph.getCellGeometry(vertices[i]);

                if (g != null) {
                    g = g.clone();

                    if (graph.isCellMovable(vertices[i])) {
                        g.relative = relInput.checked;

                        if (mxUtils.trim(xInput.value).length > 0) {
                            g.x = Number(xInput.value);
                        }

                        if (mxUtils.trim(yInput.value).length > 0) {
                            g.y = Number(yInput.value);
                        }

                        if (mxUtils.trim(dxInput.value).length > 0) {
                            if (g.offset == null) {
                                g.offset = new mxPoint();
                            }

                            g.offset.x = Number(dxInput.value);
                        }

                        if (mxUtils.trim(dyInput.value).length > 0) {
                            if (g.offset == null) {
                                g.offset = new mxPoint();
                            }

                            g.offset.y = Number(dyInput.value);
                        }
                    }

                    if (graph.isCellResizable(vertices[i])) {
                        if (mxUtils.trim(wInput.value).length > 0) {
                            g.width = Number(wInput.value);
                        }

                        if (mxUtils.trim(hInput.value).length > 0) {
                            g.height = Number(hInput.value);
                        }
                    }

                    graph.getModel().setGeometry(vertices[i], g);
                }

                if (mxUtils.trim(rotInput.value).length > 0) {
                    graph.setCellStyles(mxConstants.STYLE_ROTATION, Number(rotInput.value), [vertices[i]]);
                }
            }
        } finally {
            graph.getModel().endUpdate();
        }
    });

    applyBtn.className = 'geBtn gePrimaryBtn';

    mxEvent.addListener(div, 'keypress', function (e) {
        if (e.keyCode == 13) {
            applyBtn.click();
        }
    });

    var buttons = document.createElement('div');
    buttons.style.marginTop = '20px';
    buttons.style.textAlign = 'right';

    if (editorUi.editor.cancelFirst) {
        buttons.appendChild(cancelBtn);
        buttons.appendChild(applyBtn);
    } else {
        buttons.appendChild(applyBtn);
        buttons.appendChild(cancelBtn);
    }

    div.appendChild(buttons);

    this.container = div;
};

/**
 * Constructs a new dialog for creating files from templates.
 */
var LibraryDialog = function (editorUi, name, library, initialImages, file, mode) {
    var images = [];
    var graph = editorUi.editor.graph;
    var outer = document.createElement('div');
    outer.style.height = '100%';

    var header = document.createElement('div');
    header.style.whiteSpace = 'nowrap';
    header.style.height = '40px';
    outer.appendChild(header);

    mxUtils.write(header, mxResources.get('filename') + ':');

    var nameValue = name;

    if (nameValue == null) {
        nameValue = editorUi.defaultLibraryName + '.xml';
    }

    var nameInput = document.createElement('input');
    nameInput.setAttribute('value', nameValue);
    nameInput.style.marginRight = '20px';
    nameInput.style.marginLeft = '10px';
    nameInput.style.width = '500px';

    if (file != null && !file.isRenamable()) {
        nameInput.setAttribute('disabled', 'true');
    }

    this.init = function () {
        if (file == null || file.isRenamable()) {
            nameInput.focus();

            if (mxClient.IS_GC || mxClient.IS_FF || document.documentMode >= 5 || mxClient.IS_QUIRKS) {
                nameInput.select();
            } else {
                document.execCommand('selectAll', false, null);
            }
        }
    };

    header.appendChild(nameInput);

    var div = document.createElement('div');
    div.style.borderWidth = '1px 0px 1px 0px';
    div.style.borderColor = '#d3d3d3';
    div.style.borderStyle = 'solid';
    div.style.marginTop = '6px';
    div.style.overflow = 'auto';
    div.style.height = '340px';
    div.style.backgroundPosition = 'center center';
    div.style.backgroundRepeat = 'no-repeat';

    if (images.length == 0 && Graph.fileSupport) {
        div.style.backgroundImage = 'url(\'' + IMAGE_PATH + '/droptarget.png\')';
    }

    var bg = document.createElement('div');
    bg.style.position = 'absolute';
    bg.style.width = '640px';
    bg.style.top = '260px';
    bg.style.textAlign = 'center';
    bg.style.fontSize = '22px';
    bg.style.color = '#a0c3ff';
    mxUtils.write(bg, mxResources.get('dragImagesHere'));
    outer.appendChild(bg);

    var entries = {};
    var ew = 100;
    var eh = 100;

    var dragSourceIndex = null;
    var dropTargetIndex = null;

    function getIndexForEvent(evt) {
        var dropTarget = document.elementFromPoint(evt.clientX, evt.clientY);

        while (dropTarget != null && dropTarget.parentNode != div) {
            dropTarget = dropTarget.parentNode;
        }

        var result = null;

        if (dropTarget != null) {
            var tmp = div.firstChild;
            result = 0;

            while (tmp != null && tmp != dropTarget) {
                tmp = tmp.nextSibling;
                result++;
            }
        }

        return result;
    };

    var stopEditing = null;
    var stopWrapper = function (evt) {
        var source = mxEvent.getSource(evt);

        if (source.getAttribute('contentEditable') != 'true' && stopEditing != null) {
            stopEditing();
            stopEditing = null;

            mxEvent.consume(evt);
        }
    };

    mxEvent.addListener(div, 'mousedown', stopWrapper);
    mxEvent.addListener(div, 'pointerdown', stopWrapper);
    mxEvent.addListener(div, 'touchstart', stopWrapper);

    // For converting image URLs
    var converter = new mxUrlConverter();
    var errorShowed = false;

    function addButton(data, mimeType, x, y, w, h, img, aspect, title) {
        // Ignores duplicates
        try {
            editorUi.spinner.stop();

            if (mimeType == null || mimeType.substring(0, 6) == 'image/') {
                if ((data == null && img != null) || entries[data] == null) {
                    div.style.backgroundImage = '';
                    bg.style.display = 'none';

                    var iw = w;
                    var ih = h;

                    if (w > editorUi.maxImageSize || h > editorUi.maxImageSize) {
                        var s = Math.min(1, Math.min(editorUi.maxImageSize / Math.max(1, w)),
                            editorUi.maxImageSize / Math.max(1, h));
                        w *= s;
                        h *= s;
                    }

                    if (iw > ih) {
                        ih = Math.round(ih * ew / iw);
                        iw = ew;
                    } else {
                        iw = Math.round(iw * eh / ih);
                        ih = eh;
                    }

                    var wrapper = document.createElement('div');
                    wrapper.setAttribute('draggable', 'true');
                    wrapper.style.display = (mxClient.IS_QUIRKS) ? 'inline' : 'inline-block';
                    wrapper.style.position = 'relative';
                    wrapper.style.cursor = 'move';
                    mxUtils.setPrefixedStyle(wrapper.style, 'transition', 'transform .1s ease-in-out');

                    if (data != null) {
                        var elt = document.createElement('img');
                        elt.setAttribute('src', converter.convert(data));
                        elt.style.width = iw + 'px';
                        elt.style.height = ih + 'px';
                        elt.style.margin = '10px';

                        elt.style.paddingBottom = Math.floor((eh - ih) / 2) + 'px';
                        elt.style.paddingLeft = Math.floor((ew - iw) / 2) + 'px';

                        wrapper.appendChild(elt);
                    } else if (img != null) {
                        var cells = editorUi.stringToCells(Graph.decompress(img.xml));

                        if (cells.length > 0) {
                            editorUi.sidebar.createThumb(cells, ew, eh, wrapper, null, true, false);

                            // Needs inline block on SVG for delete icon to appear on same line
                            wrapper.firstChild.style.display = (mxClient.IS_QUIRKS) ? 'inline' : 'inline-block';
                            wrapper.firstChild.style.cursor = '';
                        }
                    }

                    var rem = document.createElement('img');
                    rem.setAttribute('src', Editor.closeImage);
                    rem.setAttribute('border', '0');
                    rem.setAttribute('title', mxResources.get('delete'));
                    rem.setAttribute('align', 'top');
                    rem.style.paddingTop = '4px';
                    rem.style.position = 'absolute';
                    rem.style.marginLeft = '-12px';
                    rem.style.zIndex = '1';
                    rem.style.cursor = 'pointer';

                    // Blocks dragging of remove icon
                    mxEvent.addListener(rem, 'dragstart', function (evt) {
                        mxEvent.consume(evt);
                    });

                    (function (wrapperDiv, dataParam, imgParam) {
                        mxEvent.addListener(rem, 'click', function (evt) {
                            entries[dataParam] = null;

                            for (var i = 0; i < images.length; i++) {
                                if ((images[i].data != null && images[i].data == dataParam) ||
                                    (images[i].xml != null && imgParam != null &&
                                        images[i].xml == imgParam.xml)) {
                                    images.splice(i, 1);
                                    break;
                                }
                            }

                            wrapper.parentNode.removeChild(wrapperDiv);

                            if (images.length == 0) {
                                div.style.backgroundImage = 'url(\'' + IMAGE_PATH + '/droptarget.png\')';
                                bg.style.display = '';
                            }

                            mxEvent.consume(evt);
                        });
                        // Workaround for accidental select all
                        mxEvent.addListener(rem, 'dblclick', function (evt) {
                            mxEvent.consume(evt);
                        });
                    })(wrapper, data, img);

                    wrapper.appendChild(rem);
                    wrapper.style.marginBottom = '30px';

                    var label = document.createElement('div');
                    label.style.position = 'absolute';
                    label.style.boxSizing = 'border-box';
                    label.style.bottom = '-18px';
                    label.style.left = '10px';
                    label.style.right = '10px';
                    label.style.backgroundColor = '#ffffff';
                    label.style.overflow = 'hidden';
                    label.style.textAlign = 'center';

                    var entry = null;

                    if (data != null) {
                        entry = {data: data, w: w, h: h, title: title};

                        if (aspect != null) {
                            entry.aspect = aspect;
                        }

                        entries[data] = elt;
                        images.push(entry);
                    } else if (img != null) {
                        img.aspect = 'fixed';
                        images.push(img);
                        entry = img;
                    }

                    function updateLabel() {
                        label.innerHTML = '';
                        label.style.cursor = 'pointer';
                        label.style.whiteSpace = 'nowrap';
                        label.style.textOverflow = 'ellipsis';
                        mxUtils.write(label, (entry.title != null && entry.title.length > 0) ?
                            entry.title : mxResources.get('untitled'));

                        if (entry.title == null || entry.title.length == 0) {
                            label.style.color = '#d0d0d0';
                        } else {
                            label.style.color = '';
                        }
                    };

                    mxEvent.addListener(label, 'keydown', function (evt) {
                        if (evt.keyCode == 13 && stopEditing != null) {
                            stopEditing();
                            stopEditing = null;

                            mxEvent.consume(evt);
                        }
                    });

                    updateLabel();
                    wrapper.appendChild(label);

                    // Blocks dragging of label
                    mxEvent.addListener(label, 'mousedown', function (evt) {
                        if (label.getAttribute('contentEditable') != 'true') {
                            mxEvent.consume(evt);
                        }
                    });

                    var startEditing = function (evt) {
                        // Workaround for various issues in IE
                        if (!mxClient.IS_IOS && !mxClient.IS_QUIRKS && !mxClient.IS_FF &&
                            (document.documentMode == null || document.documentMode > 9)) {
                            if (label.getAttribute('contentEditable') != 'true') {
                                if (stopEditing != null) {
                                    stopEditing();
                                    stopEditing = null;
                                }

                                if (entry.title == null || entry.title.length == 0) {
                                    label.innerHTML = '';
                                }

                                label.style.textOverflow = '';
                                label.style.whiteSpace = '';
                                label.style.cursor = 'text';
                                label.style.color = '';
                                label.setAttribute('contentEditable', 'true');
                                label.focus();
                                document.execCommand('selectAll', false, null);

                                stopEditing = function () {
                                    label.removeAttribute('contentEditable');
                                    label.style.cursor = 'pointer';
                                    entry.title = label.innerHTML;
                                    updateLabel();
                                }

                                mxEvent.consume(evt);
                            }
                        } else {
                            var dlg = new FilenameDialog(editorUi, entry.title || '', mxResources.get('ok'), function (newTitle) {
                                if (newTitle != null) {
                                    entry.title = newTitle;
                                    updateLabel();
                                }
                            }, mxResources.get('enterValue'));
                            editorUi.showDialog(dlg.container, 300, 130, true, true);
                            dlg.init();

                            mxEvent.consume(evt);
                        }
                    };

                    mxEvent.addListener(label, 'click', startEditing);
                    mxEvent.addListener(wrapper, 'dblclick', startEditing);

                    div.appendChild(wrapper);

                    mxEvent.addListener(wrapper, 'dragstart', function (evt) {
                        if (data == null && img != null) {
                            rem.style.visibility = 'hidden';
                            label.style.visibility = 'hidden';
                        }

                        // Workaround for no DnD on DIV in FF
                        if (mxClient.IS_FF && img.xml != null) {
                            evt.dataTransfer.setData('Text', img.xml);
                        }

                        dragSourceIndex = getIndexForEvent(evt);

                        // Workaround for missing drag preview in Google Chrome
                        if (mxClient.IS_GC) {
                            wrapper.style.opacity = '0.9';
                        }

                        window.setTimeout(function () {
                            mxUtils.setPrefixedStyle(wrapper.style, 'transform', 'scale(0.5,0.5)');
                            mxUtils.setOpacity(wrapper, 30);
                            rem.style.visibility = '';
                            label.style.visibility = '';
                        }, 0);
                    });

                    mxEvent.addListener(wrapper, 'dragend', function (evt) {
                        if (rem.style.visibility == 'hidden') {
                            rem.style.visibility = '';
                            label.style.visibility = '';
                        }

                        dragSourceIndex = null;
                        mxUtils.setOpacity(wrapper, 100);
                        mxUtils.setPrefixedStyle(wrapper.style, 'transform', null);
                    });
                } else if (!errorShowed) {
                    errorShowed = true;
                    editorUi.handleError({message: mxResources.get('fileExists')})
                }
            } else {
                var done = false;

                try {
                    var doc = mxUtils.parseXml(data);

                    if (doc.documentElement.nodeName == 'mxlibrary') {
                        var temp = JSON.parse(mxUtils.getTextContent(doc.documentElement));

                        if (temp != null && temp.length > 0) {
                            for (var i = 0; i < temp.length; i++) {
                                if (temp[i].xml != null) {
                                    addButton(null, null, 0, 0, 0, 0, temp[i]);
                                } else {
                                    addButton(temp[i].data, null, 0, 0, temp[i].w, temp[i].h, null, 'fixed', temp[i].title);
                                }
                            }
                        }

                        done = true;
                    } else if (doc.documentElement.nodeName == 'mxfile') {
                        var pages = doc.documentElement.getElementsByTagName('diagram');

                        for (var i = 0; i < pages.length; i++) {
                            var temp = mxUtils.getTextContent(pages[i]);
                            var cells = editorUi.stringToCells(Graph.decompress(temp));
                            var size = editorUi.editor.graph.getBoundingBoxFromGeometry(cells);
                            addButton(null, null, 0, 0, 0, 0, {xml: temp, w: size.width, h: size.height});
                        }

                        done = true;
                    }
                } catch (e) {
                    // ignore
                }

                if (!done) {
                    editorUi.spinner.stop();
                    editorUi.handleError({message: mxResources.get('errorLoadingFile')})
                }
            }
        } catch (e) {
            // ignore
        }

        return null;
    };

    if (initialImages != null) {
        for (var i = 0; i < initialImages.length; i++) {
            var img = initialImages[i];
            addButton(img.data, null, 0, 0, img.w, img.h, img, img.aspect, img.title);
        }
    }

    // Setup the dnd listeners
    mxEvent.addListener(div, 'dragleave', function (evt) {
        bg.style.cursor = '';
        var source = mxEvent.getSource(evt);

        while (source != null) {
            if (source == div || source == bg) {
                evt.stopPropagation();
                evt.preventDefault();
                break;
            }

            source = source.parentNode;
        }
    });

    function dragOver(evt) {
        evt.dataTransfer.dropEffect = (dragSourceIndex != null) ? 'move' : 'copy';
        evt.stopPropagation();
        evt.preventDefault();
    };

    var createImportHandler = function (evt) {
        return function (data, mimeType, x, y, w, h, img, doneFn, file) {
            if (file != null && (/(\.vsdx)($|\?)/i.test(file.name) || /(\.vssx)($|\?)/i.test(file.name))) {
                editorUi.importVisio(file, mxUtils.bind(this, function (xml) {
                    addButton(xml, mimeType, x, y, w, h, img, 'fixed', (mxEvent.isAltDown(evt)) ?
                        null : img.substring(0, img.lastIndexOf('.')).replace(/_/g, ' '));
                }));
            } else if (file != null && !editorUi.isOffline() && new XMLHttpRequest().upload && editorUi.isRemoteFileFormat(data, file.name)) {
                editorUi.parseFile(file, mxUtils.bind(this, function (xhr) {
                    if (xhr.readyState == 4) {
                        editorUi.spinner.stop();

                        if (xhr.status >= 200 && xhr.status <= 299) {
                            var xml = xhr.responseText;
                            addButton(xml, mimeType, x, y, w, h, img, 'fixed', (mxEvent.isAltDown(evt)) ?
                                null : img.substring(0, img.lastIndexOf('.')).replace(/_/g, ' '));
                            div.scrollTop = div.scrollHeight;
                        }
                    }
                }));
            } else {
                addButton(data, mimeType, x, y, w, h, img, 'fixed', (mxEvent.isAltDown(evt)) ?
                    null : img.substring(0, img.lastIndexOf('.')).replace(/_/g, ' '));
                div.scrollTop = div.scrollHeight;
            }
        };
    };

    function dropHandler(evt) {
        evt.stopPropagation();
        evt.preventDefault();
        errorShowed = false;

        dropTargetIndex = getIndexForEvent(evt);

        if (dragSourceIndex != null) {
            if (dropTargetIndex != null && dropTargetIndex < div.children.length) {
                images.splice((dropTargetIndex > dragSourceIndex) ? dropTargetIndex - 1 : dropTargetIndex,
                    0, images.splice(dragSourceIndex, 1)[0]);
                div.insertBefore(div.children[dragSourceIndex], div.children[dropTargetIndex]);
            } else {
                images.push(images.splice(dragSourceIndex, 1)[0]);
                div.appendChild(div.children[dragSourceIndex]);
            }
        } else if (evt.dataTransfer.files.length > 0) {
            editorUi.importFiles(evt.dataTransfer.files, 0, 0, editorUi.maxImageSize, createImportHandler(evt));
        } else if (mxUtils.indexOf(evt.dataTransfer.types, 'text/uri-list') >= 0) {
            var uri = decodeURIComponent(evt.dataTransfer.getData('text/uri-list'));

            if (/(\.jpg)($|\?)/i.test(uri) || /(\.png)($|\?)/i.test(uri) ||
                /(\.gif)($|\?)/i.test(uri) || /(\.svg)($|\?)/i.test(uri)) {
                editorUi.loadImage(uri, function (img) {
                    addButton(uri, null, 0, 0, img.width, img.height);
                    div.scrollTop = div.scrollHeight;
                });
            }
        }

        evt.stopPropagation();
        evt.preventDefault();
    };

    mxEvent.addListener(div, 'dragover', dragOver);
    mxEvent.addListener(div, 'drop', dropHandler);
    mxEvent.addListener(bg, 'dragover', dragOver);
    mxEvent.addListener(bg, 'drop', dropHandler);

    outer.appendChild(div);

    var btns = document.createElement('div');
    btns.style.textAlign = 'right';
    btns.style.marginTop = '20px';

    var cancelBtn = mxUtils.button(mxResources.get('cancel'), function () {
        editorUi.hideDialog(true);
    });

    cancelBtn.setAttribute('id', 'btnCancel');
    cancelBtn.className = 'geBtn';

    if (editorUi.editor.cancelFirst) {
        btns.appendChild(cancelBtn);
    }

    var btn = mxUtils.button(mxResources.get('export'), function () {
        var data = editorUi.createLibraryDataFromImages(images);
        var filename = nameInput.value;

        if (!/(\.xml)$/i.test(filename)) {
            filename += '.xml';
        }

        if (editorUi.isLocalFileSave()) {
            editorUi.saveLocalFile(data, filename, 'text/xml', null, null, true);
        } else {
            new mxXmlRequest(SAVE_URL, 'filename=' + encodeURIComponent(filename) +
                '&format=xml&xml=' + encodeURIComponent(data)).simulate(document, '_blank');
        }
    });

    btn.setAttribute('id', 'btnDownload');
    btn.className = 'geBtn';
    btns.appendChild(btn);

    if (Graph.fileSupport) {
        if (editorUi.libDlgFileInputElt == null) {
            var fileInput = document.createElement('input');
            fileInput.setAttribute('multiple', 'multiple');
            fileInput.setAttribute('type', 'file');

            mxEvent.addListener(fileInput, 'change', function (evt) {
                errorShowed = false;

                editorUi.importFiles(fileInput.files, 0, 0, editorUi.maxImageSize, function (data, mimeType, x, y, w, h, img, doneFn, file) {
                    if (fileInput.files != null) {
                        createImportHandler(evt)(data, mimeType, x, y, w, h, img, doneFn, file);

                        // Resets input to force change event for same file (type reset required for IE)
                        fileInput.type = '';
                        fileInput.type = 'file';
                        fileInput.value = '';
                    }
                });

                div.scrollTop = div.scrollHeight;
            });

            fileInput.style.display = 'none';
            document.body.appendChild(fileInput);
            editorUi.libDlgFileInputElt = fileInput;
        }

        var btn = mxUtils.button(mxResources.get('import'), function () {
            if (stopEditing != null) {
                stopEditing();
                stopEditing = null;
            }

            editorUi.libDlgFileInputElt.click();
        });
        btn.setAttribute('id', 'btnAddImage');
        btn.className = 'geBtn';

        btns.appendChild(btn);
    }

    var btn = mxUtils.button(mxResources.get('addImageUrl'), function () {
        if (stopEditing != null) {
            stopEditing();
            stopEditing = null;
        }

        editorUi.showImageDialog(mxResources.get('addImageUrl'), '', function (url, w, h) {
            errorShowed = false;

            if (url != null) {
                // Image dialog returns modified data URLs which
                // must be converted back to real data URL
                if (url.substring(0, 11) == 'data:image/') {
                    var comma = url.indexOf(',');

                    if (comma > 0) {
                        url = url.substring(0, comma) + ';base64,' + url.substring(comma + 1);
                    }
                }

                addButton(url, null, 0, 0, w, h);
                div.scrollTop = div.scrollHeight;
            }
        });
    });

    btn.setAttribute('id', 'btnAddImageUrl');
    btn.className = 'geBtn';
    btns.appendChild(btn);

    // Indirection for overriding
    this.saveBtnClickHandler = function (name, images, file, mode) {
        editorUi.saveLibrary(name, images, file, mode);
    };

    var btn = mxUtils.button(mxResources.get('save'), mxUtils.bind(this, function () {
        if (stopEditing != null) {
            stopEditing();
            stopEditing = null;
        }

        this.saveBtnClickHandler(nameInput.value, images, file, mode);
    }));

    btn.setAttribute('id', 'btnSave');
    btn.className = 'geBtn gePrimaryBtn';
    btns.appendChild(btn);

    if (!editorUi.editor.cancelFirst) {
        btns.appendChild(cancelBtn);
    }

    outer.appendChild(btns);

    this.container = outer;
};

/**
 * Constructs a new textarea dialog.
 */
var EditShapeDialog = function (editorUi, cell, title, w, h) {
    w = (w != null) ? w : 300;
    h = (h != null) ? h : 120;
    var row, td;

    var table = document.createElement('table');
    var tbody = document.createElement('tbody');
    table.style.cellPadding = '4px';

    row = document.createElement('tr');

    td = document.createElement('td');
    td.setAttribute('colspan', '2');
    td.style.fontSize = '10pt';
    mxUtils.write(td, title);

    row.appendChild(td);
    tbody.appendChild(row);

    row = document.createElement('tr');
    td = document.createElement('td');

    var nameInput = document.createElement('textarea');
    nameInput.style.outline = 'none';
    nameInput.style.resize = 'none';
    nameInput.style.width = (w - 200) + 'px';
    nameInput.style.height = h + 'px';

    this.textarea = nameInput;

    this.init = function () {
        nameInput.focus();
        nameInput.scrollTop = 0;
    };

    td.appendChild(nameInput);
    row.appendChild(td);

    td = document.createElement('td');

    var container = document.createElement('div');
    container.style.position = 'relative';
    container.style.border = '1px solid gray';
    container.style.top = '6px';
    container.style.width = '200px';
    container.style.height = (h + 4) + 'px';
    container.style.overflow = 'hidden';
    container.style.marginBottom = '16px';
    mxEvent.disableContextMenu(container);
    td.appendChild(container);

    var graph = new Graph(container);
    graph.setEnabled(false);

    var clone = editorUi.editor.graph.cloneCell(cell);
    graph.addCells([clone]);

    var state = graph.view.getState(clone);
    var stencil = '';

    if (state.shape != null && state.shape.stencil != null) {
        stencil = mxUtils.getPrettyXml(state.shape.stencil.desc);
    }

    mxUtils.write(nameInput, stencil || '');

    var b = graph.getGraphBounds();
    var ns = Math.min((200 - 40) / b.width, (h - 40) / b.height);
    graph.view.scaleAndTranslate(ns, 20 / ns - b.x, 20 / ns - b.y);

    row.appendChild(td);
    tbody.appendChild(row);

    row = document.createElement('tr');
    td = document.createElement('td');
    td.setAttribute('colspan', '2');
    td.style.paddingTop = '2px';
    td.style.whiteSpace = 'nowrap';
    td.setAttribute('align', 'right');

    if (!editorUi.isOffline()) {
        var helpBtn = mxUtils.button(mxResources.get('help'), function () {
            editorUi.openLink('https://desk.draw.io/support/solutions/articles/16000052874');
        });

        helpBtn.className = 'geBtn';
        td.appendChild(helpBtn);
    }

    var cancelBtn = mxUtils.button(mxResources.get('cancel'), function () {
        editorUi.hideDialog();
    });
    cancelBtn.className = 'geBtn';

    if (editorUi.editor.cancelFirst) {
        td.appendChild(cancelBtn);
    }

    var updateShape = function (targetGraph, targetCell, hide) {
        var newValue = nameInput.value;

        // Checks if XML has changed (getPrettyXml "normalizes" DOM)
        var doc = mxUtils.parseXml(newValue);
        newValue = mxUtils.getPrettyXml(doc.documentElement);

        // Checks for validation errors
        // LATER: Validate against XSD
        var errors = doc.documentElement.getElementsByTagName('parsererror');

        if (errors != null && errors.length > 0) {
            editorUi.showError(mxResources.get('error'), mxResources.get('containsValidationErrors'), mxResources.get('ok'));
        } else {
            if (hide) {
                editorUi.hideDialog();
            }

            var isNew = !targetGraph.model.contains(targetCell);

            if (!hide || isNew || newValue != stencil) {
                // Transform XML value to be used in cell style
                newValue = Graph.compress(newValue);

                targetGraph.getModel().beginUpdate();
                try {
                    // Inserts cell if required
                    if (isNew) {
                        var pt = editorUi.editor.graph.getFreeInsertPoint();
                        targetCell.geometry.x = pt.x;
                        targetCell.geometry.y = pt.y;
                        targetGraph.addCell(targetCell)
                    }

                    targetGraph.setCellStyles(mxConstants.STYLE_SHAPE, 'stencil(' + newValue + ')', [targetCell]);
                } catch (e) {
                    throw e;
                } finally {
                    // Updates the display
                    targetGraph.getModel().endUpdate();
                }

                // Updates selection after stencil was created for rendering
                if (isNew) {
                    targetGraph.setSelectionCell(targetCell);
                    targetGraph.scrollCellToVisible(targetCell);
                }
            }
        }
    };

    var previewBtn = mxUtils.button(mxResources.get('preview'), function () {
        updateShape(graph, clone, false);
    });

    previewBtn.className = 'geBtn';
    td.appendChild(previewBtn);

    var applyBtn = mxUtils.button(mxResources.get('apply'), function () {
        updateShape(editorUi.editor.graph, cell, true);
    });

    applyBtn.className = 'geBtn gePrimaryBtn';
    td.appendChild(applyBtn);

    if (!editorUi.editor.cancelFirst) {
        td.appendChild(cancelBtn);
    }

    row.appendChild(td);
    tbody.appendChild(row);
    table.appendChild(tbody);
    this.container = table;
};

var CustomDialog = function (editorUi, content, okFn, cancelFn, okButtonText, helpLink, buttonsContent, hideCancel) {
    var div = document.createElement('div');
    div.appendChild(content);

    var btns = document.createElement('div');
    btns.style.marginTop = '16px';
    btns.style.textAlign = 'center';

    if (buttonsContent != null) {
        btns.appendChild(buttonsContent);
    }

    if (!editorUi.isOffline() && helpLink != null) {
        var helpBtn = mxUtils.button(mxResources.get('help'), function () {
            editorUi.openLink(helpLink);
        });

        helpBtn.className = 'geBtn';
        btns.appendChild(helpBtn);
    }

    var cancelBtn = mxUtils.button(mxResources.get('cancel'), function () {
        editorUi.hideDialog();

        if (cancelFn != null) {
            cancelFn();
        }
    });

    cancelBtn.className = 'geBtn';

    if (hideCancel) {
        cancelBtn.style.display = 'none';
    }

    if (editorUi.editor.cancelFirst) {
        btns.appendChild(cancelBtn);
    }

    var okBtn = mxUtils.button(okButtonText || mxResources.get('ok'), function () {
        editorUi.hideDialog();

        if (okFn != null) {
            okFn();
        }
    });
    btns.appendChild(okBtn);

    okBtn.className = 'geBtn gePrimaryBtn';

    if (!editorUi.editor.cancelFirst) {
        btns.appendChild(cancelBtn);
    }

    div.appendChild(btns);

    this.cancelBtn = cancelBtn;
    this.okButton = okBtn;
    this.container = div;
};

var TemplatesDialog = function () {
    var dialogSkeleton =
        '<div class="geTempDlgHeader">' +
        '<img src="/images/draw.io-logo.svg" class="geTempDlgHeaderLogo">' +
        '<input type="search" class="geTempDlgSearchBox" placeholder="' + mxResources.get('search', null, 'Search') + '">' +
        '</div>' +
        '<div class="geTemplatesList">' +
        '<div class="geTempDlgNewDiagramlbl">' + mxResources.get('newDiagram', null, 'New Diagram') + '</div>' +
        '<div class="geTempDlgHLine"></div>' +
        '<div class="geTemplatesLbl">' + mxResources.get('templates', null, 'Templates') + '</div>' +
        '</div>' +
        '<div class="geTempDlgContent">' +
        '<div class="geTempDlgNewDiagramCat">' +
        '<div class="geTempDlgNewDiagramCatLbl">' + mxResources.get('newDiagram', null, 'New Diagram') + '</div>' +
        '<div class="geTempDlgNewDiagramCatList">' +
        '</div>' +
        '<div class="geTempDlgNewDiagramCatFooter">' +
        '<div class="geTempDlgShowAllBtn">' + mxResources.get('showAll', null, '+ Show all') + '</div>' +
        '</div>' +
        '</div>' +
        '<div class="geTempDlgDiagramsList">' +
        '<div class="geTempDlgDiagramsListHeader">' +
        '<div class="geTempDlgDiagramsListTitle"></div>' +
        '<div class="geTempDlgDiagramsListBtns">' +
        '<div class="geTempDlgRadioBtn geTempDlgRadioBtnLarge" data-id="myDiagramsBtn">' +
        '<img src="/images/my-diagrams.svg" class="geTempDlgMyDiagramsBtnImg"> <span>' + mxResources.get('myDiagrams', null, 'My diagrams') + '</span>' +
        '</div><div class="geTempDlgRadioBtn geTempDlgRadioBtnLarge geTempDlgRadioBtnActive" data-id="allDiagramsBtn">' +
        '<img src="/images/all-diagrams-sel.svg" class="geTempDlgAllDiagramsBtnImg"> <span>' + mxResources.get('allDiagrams', null, 'All diagrams') + '</span>' +
        '</div><div class="geTempDlgSpacer"> </div><div class="geTempDlgRadioBtn geTempDlgRadioBtnSmall geTempDlgRadioBtnActive" data-id="tilesBtn">' +
        '<img src="/images/tiles-sel.svg" class="geTempDlgTilesBtnImg">' +
        '</div><div class="geTempDlgRadioBtn geTempDlgRadioBtnSmall" data-id="listBtn">' +
        '<img src="/images/list.svg" class="geTempDlgListBtnImg">' +
        '</div>' +
        '</div>' +
        '</div>' +
        '<div class="geTempDlgDiagramsTiles">' +
        '</div>' +
        '</div>' +
        '</div>' +
        '<br style="clear:both;"/>' +
        '<div class="geTempDlgFooter">' +
        '<span class="geTempDlgLinkToDiagram geTempDlgLinkToDiagramHint">&#x1F6C8; ' + mxResources.get('linkToDiagramHint', null, 'Add a link to this diagram. The diagram can only be edited from the page that owns it.') + '</span>' +
        '<button class="geTempDlgLinkToDiagram geTempDlgLinkToDiagramBtn">' + mxResources.get('linkToDiagram', null, 'Link to Diagram') + '</button>' +
        '<div class="geTempDlgCreateBtn">' + mxResources.get('create', null, 'Create') + '</div>' +
        '<div class="geTempDlgCancelBtn">' + mxResources.get('cancel', null, 'Cancel') + '</div>' +
        '</div>';

    var div = document.createElement('div');
    div.innerHTML = dialogSkeleton;
    div.className = "geTemplateDlg";
    //override default dialog size based on screen size if needed
    var ww = window.innerWidth;
    var wh = window.innerHeight;
    var dw = 987, dh = 712;

    if (ww * 0.9 < dw) {
        dw = Math.max(ww * 0.9, 600);
        div.style.width = dw + "px";
    }

    if (wh * 0.9 < dh) {
        dh = Math.max(wh * 0.9, 300);
        div.style.height = dh + "px";
    }

    this.width = dw;
    this.height = dh;
    this.container = div;
};

TemplatesDialog.prototype.init = function (editorUi, callback, cancelCallback,
                                           templateFile, newDiagramCatsFile, username, recentDocsCallback, searchDocsCallback,
                                           openExtDocCallback, linkToDiagramCallback) {
    templateFile = (templateFile != null) ? templateFile : (TEMPLATE_PATH + '/index.xml');
    newDiagramCatsFile = (newDiagramCatsFile != null) ? newDiagramCatsFile : NEW_DIAGRAM_CATS_PATH + '/index.xml';

    var dlgDiv = this.container;
    var callInitiated = false;
    var cancelPendingCall = false;
    var currentEntry = null;
    var currentItem = null;
    var currentItemInfo = null;
    var showingAll = false;
    var isGetAll = true;
    var showAsList = false;
    var curDiagList = [];
    var lastSearchStr;
    var categorySelected = true;
    var showAllBtn = dlgDiv.querySelector(".geTempDlgShowAllBtn");
    var diagramsTiles = dlgDiv.querySelector('.geTempDlgDiagramsTiles');
    var diagramsListTitle = dlgDiv.querySelector('.geTempDlgDiagramsListTitle');
    var diagramsListBtns = dlgDiv.querySelector('.geTempDlgDiagramsListBtns');
    var tempDlgContent = dlgDiv.querySelector('.geTempDlgContent');
    var diagramsList = dlgDiv.querySelector('.geTempDlgDiagramsList');
    var newDiagramCat = dlgDiv.querySelector('.geTempDlgNewDiagramCat');
    var newDiagramCatList = dlgDiv.querySelector(".geTempDlgNewDiagramCatList");
    var createBtn = dlgDiv.querySelector('.geTempDlgCreateBtn');
    var spinner = new Spinner({
        lines: 12, // The number of lines to draw
        length: 10, // The length of each line
        width: 5, // The line thickness
        radius: 10, // The radius of the inner circle
        rotate: 0, // The rotation offset
        color: '#000', // #rgb or #rrggbb
        speed: 1.5, // Rounds per second
        trail: 60, // Afterglow percentage
        shadow: false, // Whether to render a shadow
        hwaccel: false, // Whether to use hardware acceleration
        top: '50px',
        zIndex: 2e9 // The z-index (defaults to 2000000000)
    });

    function deselectTempCat() {
        if (currentEntry != null) {
            currentEntry.style.fontWeight = 'normal';
            currentEntry.style.textDecoration = 'none';
            currentEntry = null;
        }
    };

    mxEvent.addListener(dlgDiv.querySelector('.geTempDlgNewDiagramlbl'), 'click', function () {
        deselectTempCat();
        newDiagramCat.style.display = '';
        diagramsList.style.minHeight = 'calc(100% - 280px)';
        getRecentDocs(isGetAll);
    });

    function radioClick(btn, btnImgId, btnImgFile, otherBtnId, otherBtnImgId, otherBtnImgFile, isLarge) {
        if (btn.className.indexOf('geTempDlgRadioBtnActive') > -1) {
            return false;
        } else {
            btn.className += ' geTempDlgRadioBtnActive';
            dlgDiv.querySelector('.geTempDlgRadioBtn[data-id=' + otherBtnId + ']').className = "geTempDlgRadioBtn " +
                (isLarge ? "geTempDlgRadioBtnLarge" : "geTempDlgRadioBtnSmall");
            dlgDiv.querySelector('.' + btnImgId).src = "/images/" + btnImgFile + "-sel.svg";
            dlgDiv.querySelector('.' + otherBtnImgId).src = "/images/" + otherBtnImgFile + ".svg";
            return true;
        }
    };

    mxEvent.addListener(dlgDiv.querySelector('.geTempDlgRadioBtn[data-id=allDiagramsBtn]'), 'click', function () {
        if (radioClick(this, 'geTempDlgAllDiagramsBtnImg', 'all-diagrams', 'myDiagramsBtn', 'geTempDlgMyDiagramsBtnImg', 'my-diagrams', true)) {
            isGetAll = true;
            lastSearchStr == null ? getRecentDocs(isGetAll) : doSearch(lastSearchStr);
        }
    });

    mxEvent.addListener(dlgDiv.querySelector('.geTempDlgRadioBtn[data-id=myDiagramsBtn]'), 'click', function () {
        if (radioClick(this, 'geTempDlgMyDiagramsBtnImg', 'my-diagrams', 'allDiagramsBtn', 'geTempDlgAllDiagramsBtnImg', 'all-diagrams', true)) {
            isGetAll = false;
            lastSearchStr == null ? getRecentDocs(isGetAll) : doSearch(lastSearchStr);
        }
    });

    mxEvent.addListener(dlgDiv.querySelector('.geTempDlgRadioBtn[data-id=listBtn]'), 'click', function () {
        if (radioClick(this, 'geTempDlgListBtnImg', 'list', 'tilesBtn', 'geTempDlgTilesBtnImg', 'tiles', false)) {
            showAsList = true;
            fillDiagramsList(curDiagList, false, showAsList);
        }
    });

    mxEvent.addListener(dlgDiv.querySelector('.geTempDlgRadioBtn[data-id=tilesBtn]'), 'click', function () {
        if (radioClick(this, 'geTempDlgTilesBtnImg', 'tiles', 'listBtn', 'geTempDlgListBtnImg', 'list', false)) {
            showAsList = false;
            fillDiagramsList(curDiagList, false, showAsList);
        }
    });

    function createPreview(diagram) {
        var imgUrl = diagram.prevImgUrl || diagram.imgUrl || (TEMPLATE_PATH + '/' + diagram.url.substring(0, diagram.url.length - 4) + '.png');
        var mask = document.createElement('div');
        mask.className = "geTempDlgDialogMask";
        dlgDiv.appendChild(mask);
        var prevBox = document.createElement('div');
        prevBox.className = "geTempDlgDiagramPreviewBox";
        var img = document.createElement('img');
        img.src = imgUrl;
        prevBox.appendChild(img);
        var closeBtn = document.createElement('img');
        closeBtn.src = "/images/close.png";
        closeBtn.className = "geTempDlgPreviewCloseBtn";
        closeBtn.setAttribute('title', mxResources.get("close"));
        prevBox.appendChild(closeBtn);
        var scrollTop = tempDlgContent.scrollTop;

        function closeBox(evt) {
            tempDlgContent.removeChild(prevBox);
            dlgDiv.removeChild(mask);
            tempDlgContent.scrollTop = scrollTop;
        };

        mxEvent.addListener(closeBtn, 'click', closeBox);
        mxEvent.addListener(mask, 'click', closeBox);
        tempDlgContent.appendChild(prevBox);
        tempDlgContent.scrollTop = 0;
        //for centering the image
        prevBox.style.lineHeight = prevBox.clientHeight + "px";
    };

    function swapActiveItem(newItem, activeCls, itemInfo) {
        if (currentItem != null) {
            var classes = currentItem.className.split(" ");

            for (var i = 0; i < classes.length; i++) {
                if (classes[i].indexOf("Active") > -1) {
                    classes.splice(i, 1);
                    break;
                }
            }

            currentItem.className = classes.join(" ");
        }

        if (newItem != null) {
            currentItem = newItem;
            currentItem.className += " " + activeCls;
            currentItemInfo = itemInfo;
            categorySelected = itemInfo.isCategory;
            //activate create button
            createBtn.className = "geTempDlgCreateBtn";
        } else {
            currentItem = null;
            currentItemInfo = null;
            //disable create button
            createBtn.className = "geTempDlgCreateBtn geTempDlgCreateBtnDisabled";
        }
    };

    function handleDialogOK(linkToDiagram) {
        if (currentItemInfo != null) {
            var itemInfo = currentItemInfo;
            //disable create button
            currentItemInfo = null;
            createBtn.className = "geTempDlgCreateBtn geTempDlgCreateBtnDisabled geTempDlgCreateBtnBusy";

            if (itemInfo.isExternal) {
                if (linkToDiagram == true) {
                    linkToDiagramCallback(itemInfo.url, itemInfo, "nameInput.value");
                } else {
                    openExtDocCallback(itemInfo.url, itemInfo, "nameInput.value");
                }

                editorUi.hideDialog(true);
            } else {
                mxUtils.get(TEMPLATE_PATH + '/' + itemInfo.url, mxUtils.bind(this, function (req) {
                    if (req.getStatus() >= 200 && req.getStatus() <= 299) {
                        callback(req.getText(), "nameInput.value");
                        editorUi.hideDialog(true);
                    } else {
                        //TODO Handle errors
                    }
                }));
            }
        }
    };

    function showLinkToDiagram(isShown) {
        var linkDisplay = isShown ? '' : 'none';
        var elems = dlgDiv.querySelectorAll(".geTempDlgLinkToDiagram");

        for (var i = 0; i < elems.length; i++) {
            elems[i].style.display = linkDisplay;
        }
    };

    function fillDiagramsList(diagrams, isTemplate, asList) {
        function setSubmitBtnLbl() {
            if (isTemplate) {
                createBtn.innerHTML = mxUtils.htmlEntities(mxResources.get('create'));
            } else {
                createBtn.innerHTML = mxUtils.htmlEntities(mxResources.get('copy'));
            }

            showLinkToDiagram(!isTemplate);
        };

        diagramsTiles.innerHTML = '';
        swapActiveItem();
        curDiagList = diagrams;
        var grid = null;

        if (asList) {
            grid = document.createElement('table');
            grid.className = 'geTempDlgDiagramsListGrid';
            //create header row
            var hrow = document.createElement('tr');
            var th = document.createElement('th');
            th.style.width = "50%";
            th.innerHTML = mxUtils.htmlEntities(mxResources.get('diagram', null, 'Diagram'));
            hrow.appendChild(th);
            th = document.createElement('th');
            th.style.width = "25%";
            th.innerHTML = mxUtils.htmlEntities(mxResources.get('changedBy', null, 'Changed By'));
            hrow.appendChild(th);
            th = document.createElement('th');
            th.style.width = "25%";
            th.innerHTML = mxUtils.htmlEntities(mxResources.get('lastModifiedOn', null, 'Last modified on'));
            hrow.appendChild(th);
            grid.appendChild(hrow);
            diagramsTiles.appendChild(grid);
        }

        //TODO support paging
        for (var i = 0; i < diagrams.length; i++) {
            diagrams[i].isExternal = !isTemplate;
            var url = diagrams[i].url;
            var title = mxUtils.htmlEntities(diagrams[i].title);
            var tooltip = diagrams[i].tooltip || diagrams[i].title;
            var imgUrl = diagrams[i].imgUrl;
            var changedBy = mxUtils.htmlEntities(diagrams[i].changedBy || "");
            var lastModifiedOn = mxUtils.htmlEntities(diagrams[i].lastModifiedOn || "");

            if (!imgUrl) {
                imgUrl = TEMPLATE_PATH + '/' + url.substring(0, url.length - 4) + '.png';
            }

            var titleLimit = asList ? 50 : 15;

            if (title != null && title.length > titleLimit) {
                title = title.substring(0, titleLimit) + '&hellip;';
            }

            if (asList) {
                var row = document.createElement('tr');
                var td = document.createElement('td');
                var prevImg = document.createElement('img');
                prevImg.src = "/images/icon-search.svg";
                prevImg.className = "geTempDlgDiagramListPreviewBtn";
                prevImg.setAttribute('title', mxResources.get("preview"));
                td.appendChild(prevImg);
                var titleSpan = document.createElement('span');
                titleSpan.className = "geTempDlgDiagramTitle";
                titleSpan.innerHTML = title;
                td.appendChild(titleSpan);
                row.appendChild(td);
                td = document.createElement('td');
                td.innerHTML = changedBy;
                row.appendChild(td);
                td = document.createElement('td');
                td.innerHTML = lastModifiedOn;
                row.appendChild(td);
                grid.appendChild(row);

                if (currentItem == null) {
                    setSubmitBtnLbl();
                    swapActiveItem(row, "geTempDlgDiagramsListGridActive", diagrams[i]);
                }

                (function (diagram2, row2) {
                    mxEvent.addListener(row, 'click', function () {
                        if (currentItem != row2) {
                            setSubmitBtnLbl();
                            swapActiveItem(row2, "geTempDlgDiagramsListGridActive", diagram2);
                        }
                    });

                    mxEvent.addListener(row, 'dblclick', handleDialogOK);

                    mxEvent.addListener(prevImg, 'click', function () {
                        createPreview(diagram2);
                    });
                })(diagrams[i], row);
            } else {
                var tile = document.createElement('div');
                tile.className = "geTempDlgDiagramTile";
                tile.setAttribute('title', tooltip);

                if (currentItem == null) {
                    setSubmitBtnLbl();
                    swapActiveItem(tile, "geTempDlgDiagramTileActive", diagrams[i]);
                }

                var imgDiv = document.createElement('div');
                imgDiv.className = "geTempDlgDiagramTileImg geTempDlgDiagramTileImgLoading";
                var img = document.createElement('img');
                img.style.display = "none";

                (function (img2, imgDiv2) {
                    img.onload = function () {
                        imgDiv2.className = "geTempDlgDiagramTileImg";
                        img2.style.display = "";
                    }

                    img.onerror = function () {
                        imgDiv2.className = "geTempDlgDiagramTileImg geTempDlgDiagramTileImgError";
                    }
                })(img, imgDiv);

                img.src = imgUrl;
                imgDiv.appendChild(img);
                tile.appendChild(imgDiv);

                var lblDiv = document.createElement('div');
                lblDiv.className = "geTempDlgDiagramTileLbl";
                lblDiv.innerHTML = title != null ? title : "";
                tile.appendChild(lblDiv);

                var prevImg = document.createElement('img');
                prevImg.src = "/images/icon-search.svg";
                prevImg.className = "geTempDlgDiagramPreviewBtn";
                prevImg.setAttribute('title', mxResources.get("preview"));
                tile.appendChild(prevImg);

                (function (diagram2, tile2) {
                    mxEvent.addListener(tile, 'click', function () {
                        if (currentItem != tile2) {
                            setSubmitBtnLbl();
                            swapActiveItem(tile2, "geTempDlgDiagramTileActive", diagram2);
                        }
                    });

                    mxEvent.addListener(tile, 'dblclick', handleDialogOK);

                    mxEvent.addListener(prevImg, 'click', function () {
                        createPreview(diagram2);
                    });
                })(diagrams[i], tile);

                diagramsTiles.appendChild(tile);
            }
        }
    };

    function fillNewDiagramCats(newDiagramCats, showAll) {
        newDiagramCatList.innerHTML = "";
        swapActiveItem();
        var catCount = !showAll && newDiagramCats.length > 5 ? 5 : newDiagramCats.length;

        for (var i = 0; i < catCount; i++) {
            var cat = newDiagramCats[i];
            cat.isCategory = true;
            var entry = document.createElement('div');
            var label = mxResources.get(cat.title);

            if (label == null) {
                label = cat.title.substring(0, 1).toUpperCase() + cat.title.substring(1);
            }

            entry.className = 'geTempDlgNewDiagramCatItem';
            entry.setAttribute('title', label);

            label = mxUtils.htmlEntities(label);

            if (label.length > 15) {
                label = label.substring(0, 15) + '&hellip;';
            }

            if (currentItem == null) {
                createBtn.innerHTML = mxUtils.htmlEntities(mxResources.get('create'));
                showLinkToDiagram();
                swapActiveItem(entry, "geTempDlgNewDiagramCatItemActive", cat);
            }

            var imgDiv = document.createElement('div');
            imgDiv.className = "geTempDlgNewDiagramCatItemImg";
            var img = document.createElement('img');
            img.src = NEW_DIAGRAM_CATS_PATH + '/' + cat.img;
            imgDiv.appendChild(img);
            entry.appendChild(imgDiv);

            var lblDiv = document.createElement('div');
            lblDiv.className = "geTempDlgNewDiagramCatItemLbl";
            lblDiv.innerHTML = label;
            entry.appendChild(lblDiv);

            newDiagramCatList.appendChild(entry);

            (function (cat2, entry2) {
                mxEvent.addListener(entry, 'click', function () {
                    if (currentItem != entry2) {
                        createBtn.innerHTML = mxUtils.htmlEntities(mxResources.get('create'));
                        showLinkToDiagram();
                        swapActiveItem(entry2, "geTempDlgNewDiagramCatItemActive", cat2);
                    }
                });

                mxEvent.addListener(entry, 'dblclick', handleDialogOK);
            })(cat, entry);
        }

        showAllBtn.style.display = newDiagramCats.length < 5 ? "none" : "";
    };

    mxEvent.addListener(showAllBtn, 'click', function () {
        if (showingAll) {
            newDiagramCat.style.height = "280px";
            newDiagramCatList.style.height = "190px";
            showAllBtn.innerHTML = mxUtils.htmlEntities(mxResources.get('showAll', null, '+ Show all'));
            fillNewDiagramCats(newDiagramCats);
        } else {
            newDiagramCat.style.height = "440px";
            newDiagramCatList.style.height = "355px";
            showAllBtn.innerHTML = mxUtils.htmlEntities(mxResources.get('showLess', null, '- Show less'));
            fillNewDiagramCats(newDiagramCats, true);
        }

        showingAll = !showingAll;
    });

    function fillTemplatesList(categories) {
        var list = dlgDiv.querySelector(".geTemplatesList");

        for (var cat in categories) {
            var entry = document.createElement('div');
            var label = mxResources.get(cat);
            var templateList = categories[cat];

            if (label == null) {
                label = cat.substring(0, 1).toUpperCase() + cat.substring(1);
            }

            entry.className = 'geTemplateCatLink';
            entry.setAttribute('title', label + ' (' + templateList.length + ')');

            label = mxUtils.htmlEntities(label);

            if (label.length > 15) {
                label = label.substring(0, 15) + '&hellip;';
            }

            entry.innerHTML = label + ' (' + templateList.length + ')';

            list.appendChild(entry);

            (function (cat2, label2, entry2) {
                mxEvent.addListener(entry, 'click', function () {
                    if (currentEntry != entry2) {
                        if (currentEntry != null) {
                            currentEntry.style.fontWeight = 'normal';
                            currentEntry.style.textDecoration = 'none';
                        } else {
                            newDiagramCat.style.display = 'none';
                            diagramsList.style.minHeight = '100%';
                        }

                        currentEntry = entry2;
                        currentEntry.style.fontWeight = 'bold';
                        currentEntry.style.textDecoration = 'underline';

                        tempDlgContent.scrollTop = 0;

                        if (callInitiated) {
                            cancelPendingCall = true;
                        }

                        diagramsListTitle.innerHTML = label2;
                        diagramsListBtns.style.display = 'none';
                        fillDiagramsList(categories[cat2], true);
                    }
                });
            })(cat, label, entry);
        }
    };

    var indexLoaded = false, indexLoaded2 = false;
    var categories = {};
    var newDiagramCats = [];
    var categoryCount = 1;

    mxUtils.get(templateFile, function (req) {
        // Workaround for index loaded 3 times in iOS offline mode
        if (!indexLoaded) {
            indexLoaded = true;
            var tmpDoc = req.getXml();
            var node = tmpDoc.documentElement.firstChild;

            while (node != null) {
                if (typeof (node.getAttribute) !== 'undefined') {
                    var url = node.getAttribute('url');

                    if (url != null) {
                        var slash = url.indexOf('/');
                        var category = url.substring(0, slash);

                        var list = categories[category];

                        if (list == null) {
                            categoryCount++;
                            list = [];
                            categories[category] = list;
                        }

                        list.push({
                            url: node.getAttribute('url'), libs: node.getAttribute('libs'),
                            clibs: node.getAttribute('clibs'), title: node.getAttribute('title'),
                            tooltip: node.getAttribute('url'), imgUrl: node.getAttribute('imgUrl')
                        });
                    }
                }

                node = node.nextSibling;
            }

            fillTemplatesList(categories);
        }
    });

    mxUtils.get(newDiagramCatsFile, function (req) {
        // Workaround for index loaded 3 times in iOS offline mode
        if (!indexLoaded2) {
            indexLoaded2 = true;
            var tmpDoc = req.getXml();
            var node = tmpDoc.documentElement.firstChild;

            while (node != null) {
                if (typeof (node.getAttribute) !== 'undefined') {
                    var title = node.getAttribute('title');

                    if (title != null) {
                        newDiagramCats.push({
                            img: node.getAttribute('img'), libs: node.getAttribute('libs'),
                            clibs: node.getAttribute('clibs'), title: node.getAttribute('title')
                        });
                    }
                }

                node = node.nextSibling;
            }

            fillNewDiagramCats(newDiagramCats);
        }
    });

    var extDiagramsCallback = function (list, errorMsg) {
        diagramsListBtns.style.display = '';
        spinner.stop();

        callInitiated = false;

        if (cancelPendingCall) {
            cancelPendingCall = false;
            return;
        }

        if (errorMsg) {
            diagramsTiles.innerHTML = errorMsg;
        } else if (list.length == 0) {
            diagramsTiles.innerHTML = mxUtils.htmlEntities(mxResources.get('noDiagrams', null, 'No Diagrams Found'));
        } else {
            fillDiagramsList(list, false, showAsList);
        }
    };

    function getRecentDocs(getAll) {
        if (recentDocsCallback) {
            tempDlgContent.scrollTop = 0;
            diagramsTiles.innerHTML = '';
            spinner.spin(diagramsTiles);
            cancelPendingCall = false;
            callInitiated = true;
            diagramsListTitle.innerHTML = mxUtils.htmlEntities(mxResources.get('recentDiag', null, 'Recent Diagrams'));
            lastSearchStr = null;
            recentDocsCallback(extDiagramsCallback, getAll ? null : username);
        }
    };

    getRecentDocs(isGetAll);

    var delayTimer = null;

    function doSearch(searchStr) {
        deselectTempCat();
        tempDlgContent.scrollTop = 0;
        diagramsTiles.innerHTML = '';
        spinner.spin(diagramsTiles);
        cancelPendingCall = false;
        callInitiated = true;
        delayTimer = null;
        diagramsListTitle.innerHTML = mxUtils.htmlEntities(mxResources.get('searchResults', null, 'Search Results')) +
            ' "' + mxUtils.htmlEntities(searchStr) + '"';
        searchDocsCallback(searchStr, extDiagramsCallback, isGetAll ? null : username);
        lastSearchStr = searchStr;
    };

    //TODO use request id to allow only last request to show results
    if (searchDocsCallback) {
        //Use keyup to detect delete and backspace
        mxEvent.addListener(dlgDiv.querySelector(".geTempDlgSearchBox"), 'keyup', function (evt) {
            var searchInout = this;

            if (delayTimer != null) {
                clearTimeout(delayTimer);
            }

            if (evt.keyCode == 13) {
                doSearch(searchInout.value);
            } else {
                delayTimer = setTimeout(function () {
                    doSearch(searchInout.value);
                }, 500);
            }
        });
    }

    mxEvent.addListener(createBtn, 'click', handleDialogOK);

    mxEvent.addListener(dlgDiv.querySelector(".geTempDlgLinkToDiagramBtn"), 'click', function (evt) {
        handleDialogOK(true);
    });

    mxEvent.addListener(dlgDiv.querySelector('.geTempDlgCancelBtn'), 'click', function () {
        if (cancelCallback != null) {
            cancelCallback();
        }

        editorUi.hideDialog(true);
    });
};


/**
 * Constructs a new popup opener button dialog.
 */
var BtnDialog = function (editorUi, peer, btnLbl, fn) {
    var div = document.createElement('div');
    div.style.textAlign = 'center';

    var hd = document.createElement('p');
    hd.style.fontSize = '16pt';
    hd.style.padding = '0px';
    hd.style.margin = '0px';
    hd.style.color = 'gray';

    mxUtils.write(hd, mxResources.get('done'));

    var service = 'Unknown';

    var img = document.createElement('img');
    img.setAttribute('border', '0');
    img.setAttribute('align', 'absmiddle');
    img.style.marginRight = '10px';

    if (peer == editorUi.drive) {
        service = mxResources.get('googleDrive');
        img.src = IMAGE_PATH + '/google-drive-logo-white.svg';
    } else if (peer == editorUi.dropbox) {
        service = mxResources.get('dropbox');
        img.src = IMAGE_PATH + '/dropbox-logo-white.svg';
    } else if (peer == editorUi.oneDrive) {
        service = mxResources.get('oneDrive');
        img.src = IMAGE_PATH + '/onedrive-logo-white.svg';
    } else if (peer == editorUi.gitHub) {
        service = mxResources.get('github');
        img.src = IMAGE_PATH + '/github-logo-white.svg';
    } else if (peer == editorUi.gitLab) {
        service = mxResources.get('gitlab');
        img.src = IMAGE_PATH + '/gitlab-logo.svg';
    } else if (peer == editorUi.trello) {
        service = mxResources.get('trello');
        img.src = IMAGE_PATH + '/trello-logo-white.svg';
    }

    var p = document.createElement('p');
    mxUtils.write(p, mxResources.get('authorizedIn', [service], 'You are now authorized in {1}'));

    var button = mxUtils.button(btnLbl, fn);

    button.insertBefore(img, button.firstChild);
    button.style.marginTop = '6px';
    button.className = 'geBigButton';
    button.style.fontSize = '18px';
    button.style.padding = '14px';

    div.appendChild(hd);
    div.appendChild(p);
    div.appendChild(button);

    this.container = div;
};

/**
 * Copyright (c) 2006-2017, JGraph Ltd
 * Copyright (c) 2006-2017, Gaudenz Alder
 */
(function () {
    /**
     * Specifies the app name. Default is document.title.
     */
    Editor.prototype.appName = 'Janus监控平台';

    /**
     * Known extensions for own files.
     */
    Editor.prototype.fileExtensions = [
        {ext: 'html', title: 'filetypeHtml'},
        {ext: 'png', title: 'filetypePng'},
        {ext: 'svg', title: 'filetypeSvg'}];

    /**
     * Used in the GraphViewer lightbox.
     */
    Editor.closeImage = (!mxClient.IS_SVG) ? IMAGE_PATH + '/delete.png' : 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABkAAAAZCAMAAADzN3VRAAAApVBMVEUAAAD////k5OT///8AAAB1dXXMzMz9/f39/f37+/v5+fn+/v7///9iYmJaWlqFhYWnp6ejo6OHh4f////////////////7+/v5+fnx8fH///8AAAD///8bGxv7+/v5+fkoKCghISFDQ0MYGBjh4eHY2Njb29tQUFBvb29HR0c/Pz82NjYrKyu/v78SEhLu7u7s7OzV1dVVVVU7OzsVFRXAv78QEBBzqehMAAAAG3RSTlMAA/7p/vz5xZlrTiPL/v78+/v7+OXd2TYQDs8L70ZbAAABKUlEQVQoz3VS13LCMBBUXHChd8iukDslQChJ/v/TchaG4cXS+OSb1c7trU7V60OpdRz2ZtNZL4zXNlcN8BEtSG6+NxIXkeRPoBuQ1cjvZ31/VJFB10ISli6diYfH8iYO3WUNCcNlB0gTrXOtkxTo0O1aKKiBBMhhv2MNBQKoiA5wxlZo0JDzD3AYKbWacyj3fs01wxey0pyEP+R8pWKWXoqtIZ0DDg5pbki9krEKOa6LVDQsdoXEsi46Zqh69KFz7B1u7Hb2yDV8firXDKBlZ4UFiswKGRhXTS93/ECK7yxnJ3+S3y/ThpO+cfSD017nqa18aasabU0/t7d+tk0/1oMEJ1NaD67iwdF68OabFSLn+eHb0+vjy+uk8br9fdrftH0O2menfd7+AQfYM/lNjoDHAAAAAElFTkSuQmCC';

    /**
     *
     */
    Editor.plusImage = (!mxClient.IS_SVG) ? IMAGE_PATH + '/plus.png' : 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAYAAACNMs+9AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyJpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBNYWNpbnRvc2giIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6MDdCMTdENjVCOEM4MTFFNDlCRjVBNDdCODU5NjNBNUMiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6MDdCMTdENjZCOEM4MTFFNDlCRjVBNDdCODU5NjNBNUMiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDowN0IxN0Q2M0I4QzgxMUU0OUJGNUE0N0I4NTk2M0E1QyIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDowN0IxN0Q2NEI4QzgxMUU0OUJGNUE0N0I4NTk2M0E1QyIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PtjrjmgAAAAtSURBVHjaYvz//z8DMigvLwcLdHZ2MiKLMzEQCaivkLGsrOw/dU0cAr4GCDAARQsQbTFrv10AAAAASUVORK5CYII=';

    /**
     *
     */
    Editor.spinImage = (!mxClient.IS_SVG) ? IMAGE_PATH + '/spin.gif' : 'data:image/gif;base64,R0lGODlhDAAMAPUxAEVriVp7lmCAmmGBm2OCnGmHn3OPpneSqYKbr4OcsIScsI2kto6kt46lt5KnuZmtvpquvpuvv56ywaCzwqK1xKu7yay9yq+/zLHAzbfF0bjG0bzJ1LzK1MDN18jT28nT3M3X3tHa4dTc49Xd5Njf5dng5t3k6d/l6uDm6uru8e7x8/Dz9fT29/b4+Pj5+fj5+vr6+v///wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAkKADEAIf8LTkVUU0NBUEUyLjADAQAAACwAAAAADAAMAAAGR8CYcEgsOgYAIax4CCQuQldrCBEsiK8VS2hoFGOrlJDA+cZQwkLnqyoJFZKviSS0ICrE0ec0jDAwIiUeGyBFGhMPFBkhZo1BACH5BAkKAC4ALAAAAAAMAAwAhVB0kFR3k1V4k2CAmmWEnW6Lo3KOpXeSqH2XrIOcsISdsImhtIqhtJCmuJGnuZuwv52wwJ+ywZ+ywqm6yLHBzbLCzrXEz7fF0LnH0rrI0r7L1b/M1sXR2cfT28rV3czW3s/Z4Nfe5Nvi6ODm6uLn6+Ln7OLo7OXq7efs7+zw8u/y9PDy9PX3+Pr7+////wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAZDQJdwSCxGDAIAoVFkFBwYSyIwGE4OkCJxIdG6WkJEx8sSKj7elfBB0a5SQg1EQ0SVVMPKhDM6iUIkRR4ZFxsgJl6JQQAh+QQJCgAxACwAAAAADAAMAIVGa4lcfZdjgpxkg51nhp5ui6N3kqh5lKqFnbGHn7KIoLOQp7iRp7mSqLmTqbqarr6br7+fssGitcOitcSuvsuuv8uwwMyzw861xNC5x9K6x9K/zNbDztjE0NnG0drJ1NzQ2eDS2+LT2+LV3ePZ4Oba4ebb4ufc4+jm6+7t8PLt8PPt8fPx8/Xx9PX09vf19/j3+Pn///8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAGQ8CYcEgsUhQFggFSjCQmnE1jcBhqGBXiIuAQSi7FGEIgfIzCFoCXFCZiPO0hKBMiwl7ET6eUYqlWLkUnISImKC1xbUEAIfkECQoAMgAsAAAAAAwADACFTnKPT3KPVHaTYoKcb4yjcY6leZSpf5mtgZuvh5+yiqG0i6K1jqW3kae5nrHBnrLBn7LCoLPCobTDqbrIqrvIs8LOtMPPtcPPtcTPuMbRucfSvcrUvsvVwMzWxdHaydTcytXdzNbezdff0drh2ODl2+Ln3eTp4Obq4ujs5Ont5uvu6O3w6u7w6u7x7/L09vj5+vr7+vv7////AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABkdAmXBILHIcicOCUqxELKKPxKAYgiYd4oMAEWo8RVmjIMScwhmBcJMKXwLCECmMGAhPI1QRwBiaSixCMDFhLSorLi8wYYxCQQAh+QQJCgAxACwAAAAADAAMAIVZepVggJphgZtnhp5vjKN2kah3kqmBmq+KobSLorWNpLaRp7mWq7ybr7+gs8KitcSktsWnuManucexwM2ywc63xtG6yNO9ytS+ytW/zNbDz9jH0tvL1d3N197S2+LU3OPU3ePV3eTX3+Xa4efb4ufd5Onl6u7r7vHs7/Lt8PLw8/Xy9Pby9fb09ff2+Pn3+Pn6+vr///8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAGSMCYcEgseiwSR+RS7GA4JFGF8RiWNiEiJTERgkjFGAQh/KTCGoJwpApnBkITKrwoCFWnFlEhaAxXLC9CBwAGRS4wQgELYY1CQQAh+QQJCgAzACwAAAAADAAMAIVMcI5SdZFhgZtti6JwjaR4k6mAma6Cm6+KobSLorWLo7WNo7aPpredsMCescGitMOitcSmuMaqu8ixwc2zws63xdC4xtG5x9K9ytXAzdfCztjF0NnF0drK1d3M1t7P2N/P2eDT2+LX3+Xe5Onh5+vi5+vj6Ozk6e3n7O/o7O/q7vHs7/Lt8PPu8fPx8/X3+Pn6+vv7+/v8/Pz///8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAGRcCZcEgsmkIbTOZTLIlGqZNnchm2SCgiJ6IRqljFmQUiXIVnoITQde4chC9Y+LEQxmTFRkFSNFAqDAMIRQoCAAEEDmeLQQAh+QQJCgAwACwAAAAADAAMAIVXeZRefplff5lhgZtph59yjqV2kaeAmq6FnbGFnrGLorWNpLaQp7mRqLmYrb2essGgs8Klt8apusitvcquv8u2xNC7yNO8ydS8ytTAzdfBzdfM1t7N197Q2eDU3OPX3+XZ4ObZ4ebc4+jf5erg5erg5uvp7fDu8fPv8vTz9fb09vf19/j3+Pn4+fn5+vr6+/v///8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAGRUCYcEgspkwjEKhUVJ1QsBNp0xm2VixiSOMRvlxFGAcTJook5eEHIhQcwpWIkAFQECkNy9AQWFwyEAkPRQ4FAwQIE2llQQAh+QQJCgAvACwAAAAADAAMAIVNcY5SdZFigptph6BvjKN0kKd8lquAmq+EnbGGn7KHn7ONpLaOpbearr+csMCdscCescGhtMOnuMauvsuzws60w862xdC9ytW/y9a/zNbCztjG0drH0tvK1N3M1t7N19/U3ePb4uff5urj6Ozk6e3l6u7m6u7o7PDq7vDt8PPv8vTw8vTw8/X19vf6+vv///8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAGQ8CXcEgsvlytVUplJLJIpSEDUESFTELBwSgCCQEV42kjDFiMo4uQsDB2MkLHoEHUTD7DRAHC8VAiZ0QSCgYIDxhNiUEAOw==';

    /**
     *
     */
    Editor.globeImage = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0Ij48cGF0aCBkPSJNMTEuOTkgMkM2LjQ3IDIgMiA2LjQ4IDIgMTJzNC40NyAxMCA5Ljk5IDEwQzE3LjUyIDIyIDIyIDE3LjUyIDIyIDEyUzE3LjUyIDIgMTEuOTkgMnptNi45MyA2aC0yLjk1Yy0uMzItMS4yNS0uNzgtMi40NS0xLjM4LTMuNTYgMS44NC42MyAzLjM3IDEuOTEgNC4zMyAzLjU2ek0xMiA0LjA0Yy44MyAxLjIgMS40OCAyLjUzIDEuOTEgMy45NmgtMy44MmMuNDMtMS40MyAxLjA4LTIuNzYgMS45MS0zLjk2ek00LjI2IDE0QzQuMSAxMy4zNiA0IDEyLjY5IDQgMTJzLjEtMS4zNi4yNi0yaDMuMzhjLS4wOC42Ni0uMTQgMS4zMi0uMTQgMiAwIC42OC4wNiAxLjM0LjE0IDJINC4yNnptLjgyIDJoMi45NWMuMzIgMS4yNS43OCAyLjQ1IDEuMzggMy41Ni0xLjg0LS42My0zLjM3LTEuOS00LjMzLTMuNTZ6bTIuOTUtOEg1LjA4Yy45Ni0xLjY2IDIuNDktMi45MyA0LjMzLTMuNTZDOC44MSA1LjU1IDguMzUgNi43NSA4LjAzIDh6TTEyIDE5Ljk2Yy0uODMtMS4yLTEuNDgtMi41My0xLjkxLTMuOTZoMy44MmMtLjQzIDEuNDMtMS4wOCAyLjc2LTEuOTEgMy45NnpNMTQuMzQgMTRIOS42NmMtLjA5LS42Ni0uMTYtMS4zMi0uMTYtMiAwLS42OC4wNy0xLjM1LjE2LTJoNC42OGMuMDkuNjUuMTYgMS4zMi4xNiAyIDAgLjY4LS4wNyAxLjM0LS4xNiAyem0uMjUgNS41NmMuNi0xLjExIDEuMDYtMi4zMSAxLjM4LTMuNTZoMi45NWMtLjk2IDEuNjUtMi40OSAyLjkzLTQuMzMgMy41NnpNMTYuMzYgMTRjLjA4LS42Ni4xNC0xLjMyLjE0LTIgMC0uNjgtLjA2LTEuMzQtLjE0LTJoMy4zOGMuMTYuNjQuMjYgMS4zMS4yNiAycy0uMSAxLjM2LS4yNiAyaC0zLjM4eiIvPjwvc3ZnPg==';

    /**
     *
     */
    Editor.commentImage = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0Ij48cGF0aCBkPSJNMjEuOTkgNGMwLTEuMS0uODktMi0xLjk5LTJINGMtMS4xIDAtMiAuOS0yIDJ2MTJjMCAxLjEuOSAyIDIgMmgxNGw0IDQtLjAxLTE4ek0xOCAxNEg2di0yaDEydjJ6bTAtM0g2VjloMTJ2MnptMC0zSDZWNmgxMnYyeiIvPjxwYXRoIGQ9Ik0wIDBoMjR2MjRIMHoiIGZpbGw9Im5vbmUiLz48L3N2Zz4=';

    /**
     *
     */
    Editor.commentImageInverted = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABLElEQVRYR+2Wvy4FQRjFf4dINAq9XqtSaVRqXArPINEodUqlhxC5/pU6nYdQSHQeQTRHNtmVuXuXrIxv1k1sN5vMOb85c75kxMCfBvZnCsD2ErAGzAfAvUt6THUnAGwfAWfAQoB5I3kh6aBZfALYXgGeg80b31VJT9UiBRgB48CTp9Lbku7aAPvAZSGAHUm3swEgKWtUbbsj1f4JDA4AbGb24iErgUzzr7bvSrrpVcKgK5ghgKAO9E/gvwNBJRxJuu41BUEd+BFARA3+JsAWcB9x3A7NzgSqt+ALsFwAYhqgMrW9Ub8J14G5QJBugAhD2yfAaUt7T9LVxBhGmDeato/rZJtfZQHq600hygPUEIfAOTAMQALxWrQD7X7ZXpT0VqyE3xU868n9G5PzASPvpiHavBAUAAAAAElFTkSuQmCC';

    /**
     *
     */
    Editor.userImage = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0Ij48cGF0aCBkPSJNMTIgMTJjMi4yMSAwIDQtMS43OSA0LTRzLTEuNzktNC00LTQtNCAxLjc5LTQgNCAxLjc5IDQgNCA0em0wIDJjLTIuNjcgMC04IDEuMzQtOCA0djJoMTZ2LTJjMC0yLjY2LTUuMzMtNC04LTR6Ii8+PC9zdmc+';

    /**
     *
     */
    Editor.shareImage = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0Ij48cGF0aCBkPSJNMTggMTYuMDhjLS43NiAwLTEuNDQuMy0xLjk2Ljc3TDguOTEgMTIuN2MuMDUtLjIzLjA5LS40Ni4wOS0uN3MtLjA0LS40Ny0uMDktLjdsNy4wNS00LjExYy41NC41IDEuMjUuODEgMi4wNC44MSAxLjY2IDAgMy0xLjM0IDMtM3MtMS4zNC0zLTMtMy0zIDEuMzQtMyAzYzAgLjI0LjA0LjQ3LjA5LjdMOC4wNCA5LjgxQzcuNSA5LjMxIDYuNzkgOSA2IDljLTEuNjYgMC0zIDEuMzQtMyAzczEuMzQgMyAzIDNjLjc5IDAgMS41LS4zMSAyLjA0LS44MWw3LjEyIDQuMTZjLS4wNS4yMS0uMDguNDMtLjA4LjY1IDAgMS42MSAxLjMxIDIuOTIgMi45MiAyLjkyIDEuNjEgMCAyLjkyLTEuMzEgMi45Mi0yLjkycy0xLjMxLTIuOTItMi45Mi0yLjkyeiIvPjwvc3ZnPg==';

    /**
     *
     */
    Editor.syncImage = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0Ij48cGF0aCBkPSJNMTIgNFYxTDggNWw0IDRWNmMzLjMxIDAgNiAyLjY5IDYgNiAwIDEuMDEtLjI1IDEuOTctLjcgMi44bDEuNDYgMS40NkMxOS41NCAxNS4wMyAyMCAxMy41NyAyMCAxMmMwLTQuNDItMy41OC04LTgtOHptMCAxNGMtMy4zMSAwLTYtMi42OS02LTYgMC0xLjAxLjI1LTEuOTcuNy0yLjhMNS4yNCA3Ljc0QzQuNDYgOC45NyA0IDEwLjQzIDQgMTJjMCA0LjQyIDMuNTggOCA4IDh2M2w0LTQtNC00djN6Ii8+PC9zdmc+';

    /**
     *
     */
    Editor.syncDisabledImage = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0Ij48cGF0aCBkPSJNMTAgNi4zNVY0LjI2Yy0uOC4yMS0xLjU1LjU0LTIuMjMuOTZsMS40NiAxLjQ2Yy4yNS0uMTIuNS0uMjQuNzctLjMzem0tNy4xNC0uOTRsMi4zNiAyLjM2QzQuNDUgOC45OSA0IDEwLjQ0IDQgMTJjMCAyLjIxLjkxIDQuMiAyLjM2IDUuNjRMNCAyMGg2di02bC0yLjI0IDIuMjRDNi42OCAxNS4xNSA2IDEzLjY2IDYgMTJjMC0xIC4yNS0xLjk0LjY4LTIuNzdsOC4wOCA4LjA4Yy0uMjUuMTMtLjUuMjUtLjc3LjM0djIuMDljLjgtLjIxIDEuNTUtLjU0IDIuMjMtLjk2bDIuMzYgMi4zNiAxLjI3LTEuMjdMNC4xNCA0LjE0IDIuODYgNS40MXpNMjAgNGgtNnY2bDIuMjQtMi4yNEMxNy4zMiA4Ljg1IDE4IDEwLjM0IDE4IDEyYzAgMS0uMjUgMS45NC0uNjggMi43N2wxLjQ2IDEuNDZDMTkuNTUgMTUuMDEgMjAgMTMuNTYgMjAgMTJjMC0yLjIxLS45MS00LjItMi4zNi01LjY0TDIwIDR6Ii8+PC9zdmc+';

    /**
     *
     */
    Editor.syncProblemImage = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0Ij48cGF0aCBkPSJNMyAxMmMwIDIuMjEuOTEgNC4yIDIuMzYgNS42NEwzIDIwaDZ2LTZsLTIuMjQgMi4yNEM1LjY4IDE1LjE1IDUgMTMuNjYgNSAxMmMwLTIuNjEgMS42Ny00LjgzIDQtNS42NVY0LjI2QzUuNTUgNS4xNSAzIDguMjcgMyAxMnptOCA1aDJ2LTJoLTJ2MnpNMjEgNGgtNnY2bDIuMjQtMi4yNEMxOC4zMiA4Ljg1IDE5IDEwLjM0IDE5IDEyYzAgMi42MS0xLjY3IDQuODMtNCA1LjY1djIuMDljMy40NS0uODkgNi00LjAxIDYtNy43NCAwLTIuMjEtLjkxLTQuMi0yLjM2LTUuNjRMMjEgNHptLTEwIDloMlY3aC0ydjZ6Ii8+PC9zdmc+';

    /**
     * Used in the GraphViewer lightbox.
     */
    Editor.tweetImage = IMAGE_PATH + '/tweet.png';

    /**
     * Used in the GraphViewer lightbox.
     */
    Editor.facebookImage = IMAGE_PATH + '/facebook.png';

    /**
     * Blank 1x1 pixel transparent PNG image.
     */
    Editor.blankImage = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAACklEQVR4nGMAAQAABQABDQottAAAAABJRU5ErkJggg==';

    /**
     * Blank 1x1 pixel transparent PNG image.
     */
    Editor.hiResImage = (mxClient.IS_SVG) ? 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAAA+CAMAAACLMWy1AAAAh1BMVEUAAABMTExERERBQUFBQUFFRUVAQEBCQkJAQEA6OjpDQ0NKSkpBQUFBQUFERERERERBQUFCQkJCQkJCQkJJSUlBQUFCQkJDQ0NDQ0NCQkJDQ0NBQUFBQUFCQkJBQUFCQkJCQkJDQ0NCQkJHR0dBQUFCQkJCQkJAQEBCQkJDQ0NAQEBERERCQkIk1hS2AAAAKnRSTlMAAjj96BL7PgQFRwfu3TYazKuVjRXl1V1DPCn1uLGjnWNVIgy9hU40eGqPkM38AAACG0lEQVRYw+2X63KbMBCFzwZblgGDceN74muatpLe//m6MHV3gHGFAv2RjM94MAbxzdnVsQbBDKwH8AH8MDAyafzjqYeyOG04XE7RS8nIRDXg6BlT+rA0nmtAPh+NQRDxIASIMG44rAMrGunBgHwy3uUldxggIStGKp2f+DQc2O4h4eQsX3O2IFB/oEbsjOKbStnjAEA+zJ0ylZTbgvoDn8xNyn6Dbj5Kd4GsNpABa6duQPfSdEj88TgMAhKuCWjAkgmFXPLnsD0pWd3OFGdrMugQII/eOMPEiGOzqPMIeWrcSoMCg71W1pXBPvCP+gS/OdXqQ3uW23+93XGWLl/OaBb805bNcBPoEIcVJsnHzcxpZH86u5KZ9gDby5dQCcnKqdbke4ItI4Tzd7IW9hZQt4EO6GG9b9sYuuK9Wwn8TIr2xKbF2+3Nhr+qxChJ/AI6pIfCu4z4Zowp4ZUNihz79vewzctnHDwTvQO/hCdFBzrUGDOPn2Y/F8YKT4oOATLvlhOznzmBSdFBJWtc58y7r+UVFOCQczy3wpN6pegDqHtsCPTGvH9JuTO0Dyg8icldYPk+RB6g8Aofj4m2EKBvtTmUPD9xDd1pPcSReV2U5iD/ik2yrngtvvqBfPzOvKiDTKTsCdoHZJ7pLLffgTwlJ5vJdtJV2/jiAYaLvLGhMAEDO5QcDg2M/jOw/8Zn+K3ZwJvHT7ZffgC/NvA3zcybTeIfE4EAAAAASUVORK5CYII=' : IMAGE_PATH + '/img-hi-res.png';

    /**
     * Blank 1x1 pixel transparent PNG image.
     */
    Editor.loResImage = (mxClient.IS_SVG) ? 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAAA+CAMAAACLMWy1AAAAS1BMVEVAQEAAAAA1NTVBQUFDQ0NDQ0NFRUVERERBQUFBQUFBQUFAQEBBQUFBQUFCQkJCQkJCQkJBQUFCQkJDQ0NDQ0NCQkJCQkJCQkJGRkb5/XqTAAAAGXRSTlP+AAWODlASCsesX+Lc2LyWe3pwa1tCPjohjSJfoAAAAI1JREFUWMPt1MkKhTAMRuG0anvneXr/J71nUypKcdqI/N8yhLMKMZE1CahnClDQzMPB44ED3EgeCubgDWnWQMHpwTtKwTe+UHD4sJ94wbUEHHFGhILlYDeSnsQeabeCgsPBgB0MOZZ9oGA5GJFiJSfUULAfjLjARrhCwX7wh2YCDwVbwZkUBKqFFJRN+wOcwSgR2sREcgAAAABJRU5ErkJggg==' : IMAGE_PATH + '/img-lo-res.png';

    /**
     * Only needed in browsers with SVG support for export via lightbox toolbar.
     */
    Editor.cameraLargeImage = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAAlwSFlzAAALEwAACxMBAJqcGAAAAVlpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IlhNUCBDb3JlIDUuNC4wIj4KICAgPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4KICAgICAgPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIKICAgICAgICAgICAgeG1sbnM6dGlmZj0iaHR0cDovL25zLmFkb2JlLmNvbS90aWZmLzEuMC8iPgogICAgICAgICA8dGlmZjpPcmllbnRhdGlvbj4xPC90aWZmOk9yaWVudGF0aW9uPgogICAgICA8L3JkZjpEZXNjcmlwdGlvbj4KICAgPC9yZGY6UkRGPgo8L3g6eG1wbWV0YT4KTMInWQAAA/BJREFUWAnFl0uIjWEYx885buPSuGwmSYwtwsY1ikKSNYNclmQnadgrZSPlsnBLSlaGBdNYKY0Vdi4L4zYzIqxGxmXG//d+7//0+uY7nWMiT/2/53mf+3v7vnNKpf9M5UbrDw8Pj4m+wzmeT1FBUS6Xf+YNox6reMONukijMXUTM3NmI75PyXcJPwRWg5kS7xysDLNmfEUxpx2rceNE50IlYjyRklcLf0prY+x4BTqfmx3ZUHQaO9ISGngYq38V/1EH+ECPa+QaK1u1kVBQirDMChiS3CTeIkwWvghtwhKBpZ8g1CO2B99FynVU/KowSRgQ3mlrBsVZ1awmQlS0SGbfXglfBPbdRGMm5O8RXg2P835pDCvzWjghTHETcLpZLHwS8kTCtBEK1SN83Egam8YxyVZqc+Do5qkwS+gT9grNwkUBG6cbsG/gs3BTuC/0ChCxq4QtwgzBMdwUZBPyN4Ftfi4sYPZHktbOSRlIuutRP5jYj0ueZp88xyYcS/zZoiLyQT1IA/cTj7eSlwnrhI+JnkQbCwo2Sx/2M7VJt17wdhVtgxvrpoFnAuSAbJQ97biZAlKxBfD9wgOhV+BgIR/AZtJ4kwD5PGSj7OmmekjWEy0oAQHAS3+KpBpzXqYK3UItopHpSRMno2N+cm7gDYnfRCcr3QBqriMHLJDkeyhFfiG5aVbK+8rhtP9M6QcIEJHX5Fp9NMAyQlYiu+OOJNlODCIXyka/P23bncTdiC7OydC1+v1Bsb+5r84DK8S3Rdmf5cRUFW3bXtWUSt1Rdk6G4SyJV2o1YId+vNUxr+x5yCJiapFtcxQzLjrxboGcMxvFJwEOKnLwjIbkx/sdSmeSaUY++SwTAxV+4DJT7RVwkbk46gNCsifIItuy0e9PF33Cb4homhN5YRyzL5q5V2VNkv98kqgoGTo3YF9CnMM5Y5rItFfvBSi9JulVXOgI+VwIntkt+SaZ6weQfcovJf7zpTfl86P/wAF7Fz18NeKwmvAWCaX0Z/uMHQr42ZxvR/Rxcw5xM+9J/CJq8w2gduDhmDgso/QrBH47dEXQ1IqczyHpIOfIRtnTtV7SwO1oKXKkU3fbToFGSDHtMWcaH1WBuVYnDbRFi99iqSMySdzxXckrazUh23KBVYGIcfNBkTxca0e4ATJ0KukGYVBgr/MnlhPOtQq/ksUfCbzh+EFCjtnCUoHfjhA/OsiTv2HcEvJMELp0VakZDliTmriTdPivxU4VmEhtPrGV+KJhO7ZKt0doFZh1fgZSBWIW2AGEHwg3BUWOnKtH+suqdw07tYMfglCrWPD5mw9qVYuniaXkT0OtWaSuo5LJTY1RBf+roF9X5+y/5qU+DAAAAABJRU5ErkJggg==';

    /**
     * Default value for custom libraries in mxSettings.
     */
    Editor.defaultCustomLibraries = [];

    /**
     * Default value for custom libraries in mxSettings.
     */
    Editor.enableCustomLibraries = true;

    /**
     * Specifies if custom properties should be enabled.
     */
    Editor.enableCustomProperties = true;

    /**
     * Specifies if XML files should be compressed. Default is true.
     */
    Editor.compressXml = true;

    /**
     * Specifies global variables.
     */
    Editor.globalVars = null;

    /**
     * Disables the shadow option in the format panel.
     */
    Editor.shadowOptionEnabled = true;

    /**
     * Reference to the config object passed to <configure>.
     */
    Editor.config = null;

    /**
     * Reference to the version of the last config object in
     * <configure>. If this is different to the last version in
     * mxSettings.parse, then the settings are reset.
     */
    Editor.configVersion = null;

    /**
     * Common properties for all edges.
     */
    Editor.commonEdgeProperties = [
        {type: 'separator'},
        {name: 'arcSize', dispName: 'Arc Size', type: 'float', min: 0, defVal: mxConstants.LINE_ARCSIZE},
        {
            name: 'sourcePortConstraint', dispName: 'Source Constraint', type: 'enum', defVal: 'none',
            enumList: [{val: 'none', dispName: 'None'}, {val: 'north', dispName: 'North'}, {
                val: 'east',
                dispName: 'East'
            }, {
                val: 'south',
                dispName: 'South'
            }, {val: 'west', dispName: 'West'}]
        },
        {
            name: 'targetPortConstraint', dispName: 'Target Constraint', type: 'enum', defVal: 'none',
            enumList: [{val: 'none', dispName: 'None'}, {val: 'north', dispName: 'North'}, {
                val: 'east',
                dispName: 'East'
            }, {
                val: 'south',
                dispName: 'South'
            }, {val: 'west', dispName: 'West'}]
        },
        {
            name: 'jettySize',
            dispName: 'Jetty Size',
            type: 'int',
            min: 0,
            defVal: 'auto',
            allowAuto: true,
            isVisible: function (state) {
                return mxUtils.getValue(state.style, mxConstants.STYLE_EDGE, null) == 'orthogonalEdgeStyle';
            }
        },
        {name: 'fillOpacity', dispName: 'Fill Opacity', type: 'int', min: 0, max: 100, defVal: 100},
        {name: 'strokeOpacity', dispName: 'Stroke Opacity', type: 'int', min: 0, max: 100, defVal: 100},
        {name: 'startFill', dispName: 'Start Fill', type: 'bool', defVal: true},
        {name: 'endFill', dispName: 'End Fill', type: 'bool', defVal: true},
        {name: 'perimeterSpacing', dispName: 'Terminal Spacing', type: 'float', defVal: 0},
        {name: 'anchorPointDirection', dispName: 'Anchor Direction', type: 'bool', defVal: true},
        {name: 'snapToPoint', dispName: 'Snap to Anchor', type: 'bool', defVal: false},
        {name: 'fixDash', dispName: 'Fixed Dash', type: 'bool', defVal: false},
        {
            name: 'jiggle', dispName: 'Jiggle', type: 'float', min: 0, defVal: 1.5, isVisible: function (state) {
                return mxUtils.getValue(state.style, 'comic', '0') == '1';
            }
        },
        {name: 'editable', dispName: 'Editable', type: 'bool', defVal: true},
        {name: 'backgroundOutline', dispName: 'Background Outline', type: 'bool', defVal: false},
        {name: 'bendable', dispName: 'Bendable', type: 'bool', defVal: true},
        {name: 'movable', dispName: 'Movable', type: 'bool', defVal: true},
        {name: 'cloneable', dispName: 'Cloneable', type: 'bool', defVal: true},
        {name: 'deletable', dispName: 'Deletable', type: 'bool', defVal: true},
        {name: 'orthogonalLoop', dispName: 'Loop Routing', type: 'bool', defVal: false},
        {name: 'noJump', dispName: 'No Jumps', type: 'bool', defVal: false}
    ];

    /**
     * Common properties for all vertices.
     */
    Editor.commonVertexProperties = [
        {type: 'separator'},
        {name: 'fillOpacity', dispName: 'Fill Opacity', type: 'int', min: 0, max: 100, defVal: 100},
        {name: 'strokeOpacity', dispName: 'Stroke Opacity', type: 'int', min: 0, max: 100, defVal: 100},
        {
            name: 'overflow', dispName: 'Text Overflow', defVal: 'visible', type: 'enum',
            enumList: [{val: 'visible', dispName: 'Visible'}, {val: 'hidden', dispName: 'Hidden'}, {
                val: 'fill',
                dispName: 'Fill'
            }, {
                val: 'width',
                dispName: 'Width'
            }]
        },
        {name: 'noLabel', dispName: 'Hide Label', type: 'bool', defVal: false},
        {name: 'labelPadding', dispName: 'Label Padding', type: 'float', defVal: 0},
        {
            name: 'direction', dispName: 'Direction', type: 'enum', defVal: 'east',
            enumList: [{val: 'north', dispName: 'North'}, {val: 'east', dispName: 'East'}, {
                val: 'south',
                dispName: 'South'
            }, {
                val: 'west',
                dispName: 'West'
            }]
        },
        {
            name: 'portConstraint', dispName: 'Constraint', type: 'enum', defVal: 'none',
            enumList: [{val: 'none', dispName: 'None'}, {val: 'north', dispName: 'North'}, {
                val: 'east',
                dispName: 'East'
            }, {
                val: 'south',
                dispName: 'South'
            }, {val: 'west', dispName: 'West'}]
        },
        {name: 'portConstraintRotation', dispName: 'Rotate Constraint', type: 'bool', defVal: false},
        {name: 'connectable', dispName: 'Connectable', type: 'bool', defVal: true},
        {name: 'allowArrows', dispName: 'Allow Arrows', type: 'bool', defVal: true},
        {name: 'snapToPoint', dispName: 'Snap to Point', type: 'bool', defVal: false},
        {
            name: 'perimeter', dispName: 'Perimeter', defVal: 'none', type: 'enum',
            enumList: [{val: 'none', dispName: 'None'},
                {val: 'rectanglePerimeter', dispName: 'Rectangle'}, {val: 'ellipsePerimeter', dispName: 'Ellipse'},
                {val: 'rhombusPerimeter', dispName: 'Rhombus'}, {val: 'trianglePerimeter', dispName: 'Triangle'},
                {val: 'hexagonPerimeter2', dispName: 'Hexagon'}, {val: 'lifelinePerimeter', dispName: 'Lifeline'},
                {val: 'orthogonalPerimeter', dispName: 'Orthogonal'}, {val: 'backbonePerimeter', dispName: 'Backbone'},
                {val: 'calloutPerimeter', dispName: 'Callout'}, {
                    val: 'parallelogramPerimeter',
                    dispName: 'Parallelogram'
                },
                {val: 'trapezoidPerimeter', dispName: 'Trapezoid'}, {val: 'stepPerimeter', dispName: 'Step'}]
        },
        {name: 'fixDash', dispName: 'Fixed Dash', type: 'bool', defVal: false},
        {
            name: 'jiggle', dispName: 'Jiggle', type: 'float', min: 0, defVal: 1.5, isVisible: function (state) {
                return mxUtils.getValue(state.style, 'comic', '0') == '1';
            }
        },
        {name: 'autosize', dispName: 'Autosize', type: 'bool', defVal: false},
        {name: 'collapsible', dispName: 'Collapsible', type: 'bool', defVal: false},
        {name: 'container', dispName: 'Container', type: 'bool', defVal: false},
        {name: 'recursiveResize', dispName: 'Resize Children', type: 'bool', defVal: true},
        {name: 'part', dispName: 'Part', type: 'bool', defVal: false},
        {name: 'editable', dispName: 'Editable', type: 'bool', defVal: true},
        {name: 'backgroundOutline', dispName: 'Background Outline', type: 'bool', defVal: false},
        {name: 'movable', dispName: 'Movable', type: 'bool', defVal: true},
        {name: 'resizable', dispName: 'Resizable', type: 'bool', defVal: true},
        {name: 'resizeWidth', dispName: 'Resize Width', type: 'bool', defVal: false},
        {name: 'resizeHeight', dispName: 'Resize Height', type: 'bool', defVal: false},
        {name: 'rotatable', dispName: 'Rotatable', type: 'bool', defVal: true},
        {name: 'cloneable', dispName: 'Cloneable', type: 'bool', defVal: true},
        {name: 'deletable', dispName: 'Deletable', type: 'bool', defVal: true},
        {name: 'treeFolding', dispName: 'Tree Folding', type: 'bool', defVal: false},
        {name: 'treeMoving', dispName: 'Tree Moving', type: 'bool', defVal: false}
    ];
    /**
     * Default value for the CSV import dialog.
     */
    Editor.defaultCsvValue = '##\n' +
        '## Example CSV import. Use ## for comments and # for configuration. Paste CSV below.\n' +
        '## The following names are reserved and should not be used (or ignored):\n' +
        '## id, tooltip, placeholder(s), link and label (see below)\n' +
        '##\n' +
        '#\n' +
        '## Node label with placeholders and HTML.\n' +
        '## Default is \'%name_of_first_column%\'.\n' +
        '#\n' +
        '# label: %name%<br><i style="color:gray;">%position%</i><br><a href="mailto:%email%">Email</a>\n' +
        '#\n' +
        '## Node style (placeholders are replaced once).\n' +
        '## Default is the current style for nodes.\n' +
        '#\n' +
        '# style: label;image=%image%;whiteSpace=wrap;html=1;rounded=1;fillColor=%fill%;strokeColor=%stroke%;\n' +
        '#\n' +
        '## Parent style for nodes with child nodes (placeholders are replaced once).\n' +
        '#\n' +
        '# parentstyle: swimlane;whiteSpace=wrap;html=1;childLayout=stackLayout;horizontal=1;horizontalStack=0;resizeParent=1;resizeLast=0;collapsible=1;\n' +
        '#\n' +
        '## Optional column name that contains a reference to a named style in styles.\n' +
        '## Default is the current style for nodes.\n' +
        '#\n' +
        '# stylename: -\n' +
        '#\n' +
        '## JSON for named styles of the form {"name": "style", "name": "style"} where style is a cell style with\n' +
        '## placeholders that are replaced once.\n' +
        '#\n' +
        '# styles: -\n' +
        '#\n' +
        '## Optional column name that contains a reference to a named label in labels.\n' +
        '## Default is the current label.\n' +
        '#\n' +
        '# labelname: -\n' +
        '#\n' +
        '## JSON for named labels of the form {"name": "label", "name": "label"} where label is a cell label with\n' +
        '## placeholders.\n' +
        '#\n' +
        '# labels: -\n' +
        '#\n' +
        '## Uses the given column name as the identity for cells (updates existing cells).\n' +
        '## Default is no identity (empty value or -).\n' +
        '#\n' +
        '# identity: -\n' +
        '#\n' +
        '## Uses the given column name as the parent reference for cells. Default is no parent (empty or -).\n' +
        '## The identity above is used for resolving the reference so it must be specified.\n' +
        '#\n' +
        '# parent: -\n' +
        '#\n' +
        '## Adds a prefix to the identity of cells to make sure they do not collide with existing cells (whose\n' +
        '## IDs are numbers from 0..n, sometimes with a GUID prefix in the context of realtime collaboration).\n' +
        '## Default is csvimport-.\n' +
        '#\n' +
        '# namespace: csvimport-\n' +
        '#\n' +
        '## Connections between rows ("from": source colum, "to": target column).\n' +
        '## Label, style and invert are optional. Defaults are \'\', current style and false.\n' +
        '## In addition to label, an optional fromlabel and tolabel can be used to name the column\n' +
        '## that contains the text for the label in the edges source or target (invert ignored).\n' +
        '## The label is concatenated in the form fromlabel + label + tolabel if all are defined.\n' +
        '## The target column may contain a comma-separated list of values.\n' +
        '## Multiple connect entries are allowed.\n' +
        '#\n' +
        '# connect: {"from": "manager", "to": "name", "invert": true, "label": "manages", \\\n' +
        '#          "style": "curved=1;endArrow=blockThin;endFill=1;fontSize=11;"}\n' +
        '# connect: {"from": "refs", "to": "id", "style": "curved=1;fontSize=11;"}\n' +
        '#\n' +
        '## Node x-coordinate. Possible value is a column name. Default is empty. Layouts will\n' +
        '## override this value.\n' +
        '#\n' +
        '# left: \n' +
        '#\n' +
        '## Node y-coordinate. Possible value is a column name. Default is empty. Layouts will\n' +
        '## override this value.\n' +
        '#\n' +
        '# top: \n' +
        '#\n' +
        '## Node width. Possible value is a number (in px), auto or an @ sign followed by a column\n' +
        '## name that contains the value for the width. Default is auto.\n' +
        '#\n' +
        '# width: auto\n' +
        '#\n' +
        '## Node height. Possible value is a number (in px), auto or an @ sign followed by a column\n' +
        '## name that contains the value for the height. Default is auto.\n' +
        '#\n' +
        '# height: auto\n' +
        '#\n' +
        '## Padding for autosize. Default is 0.\n' +
        '#\n' +
        '# padding: -12\n' +
        '#\n' +
        '## Comma-separated list of ignored columns for metadata. (These can be\n' +
        '## used for connections and styles but will not be added as metadata.)\n' +
        '#\n' +
        '# ignore: id,image,fill,stroke,refs,manager\n' +
        '#\n' +
        '## Column to be renamed to link attribute (used as link).\n' +
        '#\n' +
        '# link: url\n' +
        '#\n' +
        '## Spacing between nodes. Default is 40.\n' +
        '#\n' +
        '# nodespacing: 40\n' +
        '#\n' +
        '## Spacing between levels of hierarchical layouts. Default is 100.\n' +
        '#\n' +
        '# levelspacing: 100\n' +
        '#\n' +
        '## Spacing between parallel edges. Default is 40. Use 0 to disable.\n' +
        '#\n' +
        '# edgespacing: 40\n' +
        '#\n' +
        '## Name or JSON of layout. Possible values are auto, none, verticaltree, horizontaltree,\n' +
        '## verticalflow, horizontalflow, organic, circle or a JSON string as used in Layout, Apply.\n' +
        '## Default is auto.\n' +
        '#\n' +
        '# layout: auto\n' +
        '#\n' +
        '## ---- CSV below this line. First line are column names. ----\n' +
        'name,position,id,location,manager,email,fill,stroke,refs,url,image\n' +
        'Evan Miller,CFO,emi,Office 1,,me@example.com,#dae8fc,#6c8ebf,,https://www.draw.io,https://cdn3.iconfinder.com/data/icons/user-avatars-1/512/users-9-2-128.png\n' +
        'Edward Morrison,Brand Manager,emo,Office 2,Evan Miller,me@example.com,#d5e8d4,#82b366,,https://www.draw.io,https://cdn3.iconfinder.com/data/icons/user-avatars-1/512/users-10-3-128.png\n' +
        'Ron Donovan,System Admin,rdo,Office 3,Evan Miller,me@example.com,#d5e8d4,#82b366,"emo,tva",https://www.draw.io,https://cdn3.iconfinder.com/data/icons/user-avatars-1/512/users-2-128.png\n' +
        'Tessa Valet,HR Director,tva,Office 4,Evan Miller,me@example.com,#d5e8d4,#82b366,,https://www.draw.io,https://cdn3.iconfinder.com/data/icons/user-avatars-1/512/users-3-128.png\n';

    /**
     * Helper function to extract the graph model XML node.
     */
    Editor.extractGraphModel = function (node, allowMxFile) {
        if (node != null && typeof (pako) !== 'undefined') {
            var tmp = node.ownerDocument.getElementsByTagName('div');
            var divs = [];

            if (tmp != null && tmp.length > 0) {
                for (var i = 0; i < tmp.length; i++) {
                    if (tmp[i].getAttribute('class') == 'mxgraph') {
                        divs.push(tmp[i]);
                        break;
                    }
                }
            }

            if (divs.length > 0) {
                var data = divs[0].getAttribute('data-mxgraph');

                if (data != null) {
                    var config = JSON.parse(data);

                    if (config != null && config.xml != null) {
                        var doc2 = mxUtils.parseXml(config.xml);
                        node = doc2.documentElement;
                    }
                } else {
                    var divs2 = divs[0].getElementsByTagName('div');

                    if (divs2.length > 0) {
                        var data = mxUtils.getTextContent(divs2[0]);
                        data = Graph.decompress(data);

                        if (data.length > 0) {
                            var doc2 = mxUtils.parseXml(data);
                            node = doc2.documentElement;
                        }
                    }
                }
            }
        }

        if (node != null && node.nodeName == 'svg') {
            var tmp = node.getAttribute('content');

            if (tmp != null && tmp.charAt(0) != '<' && tmp.charAt(0) != '%') {
                tmp = unescape((window.atob) ? atob(tmp) : Base64.decode(cont, tmp));
            }

            if (tmp != null && tmp.charAt(0) == '%') {
                tmp = decodeURIComponent(tmp);
            }

            if (tmp != null && tmp.length > 0) {
                node = mxUtils.parseXml(tmp).documentElement;
            } else {
                throw {message: mxResources.get('notADiagramFile')};
            }
        }

        if (node != null && !allowMxFile) {
            var diagramNode = null;

            if (node.nodeName == 'diagram') {
                diagramNode = node;
            } else if (node.nodeName == 'mxfile') {
                var diagrams = node.getElementsByTagName('diagram');

                if (diagrams.length > 0) {
                    diagramNode = diagrams[Math.max(0, Math.min(diagrams.length - 1, urlParams['page'] || 0))];
                }
            }

            if (diagramNode != null) {
                node = Editor.parseDiagramNode(diagramNode);
            }
        }

        if (node != null && node.nodeName != 'mxGraphModel' && (!allowMxFile || node.nodeName != 'mxfile')) {
            node = null;
        }

        return node;
    };

    /**
     * Extracts the XML from the compressed or non-compressed text chunk.
     */
    Editor.parseDiagramNode = function (diagramNode) {
        var text = mxUtils.trim(mxUtils.getTextContent(diagramNode));
        var node = null;

        if (text.length > 0) {
            var tmp = Graph.decompress(text);

            if (tmp != null && tmp.length > 0) {
                node = mxUtils.parseXml(tmp).documentElement;
            }
        } else {
            var temp = mxUtils.getChildNodes(diagramNode);

            if (temp.length > 0) {
                // Creates new document for unique IDs within mxGraphModel
                var doc = mxUtils.createXmlDocument();
                doc.appendChild(doc.importNode(temp[0], true));
                node = doc.documentElement;
            }
        }

        return node;
    };

    /**
     * Extracts the XML from the compressed or non-compressed text chunk.
     */
    Editor.getDiagramNodeXml = function (diagramNode) {
        var text = mxUtils.getTextContent(diagramNode);
        var xml = null;

        if (text.length > 0) {
            xml = Graph.decompress(text);
        } else if (diagramNode.firstChild != null) {
            xml = mxUtils.getXml(diagramNode.firstChild);
        }

        return xml;
    };

    /**
     * Extracts the XML from the compressed or non-compressed text chunk.
     */
    Editor.extractGraphModelFromPng = function (data) {
        var result = null;

        try {
            var base64 = data.substring(data.indexOf(',') + 1);

            // Workaround for invalid character error in Safari
            var binary = (window.atob && !mxClient.IS_SF) ? atob(base64) : Base64.decode(base64, true);

            EditorUi.parsePng(binary, mxUtils.bind(this, function (pos, type, length) {
                var value = binary.substring(pos + 8, pos + 8 + length);

                if (type == 'zTXt') {
                    var idx = value.indexOf(String.fromCharCode(0));

                    if (value.substring(0, idx) == 'mxGraphModel') {
                        // Workaround for Java URL Encoder using + for spaces, which isn't compatible with JS
                        var xmlData = Graph.bytesToString(pako.inflateRaw(
                            value.substring(idx + 2))).replace(/\+/g, ' ');

                        if (xmlData != null && xmlData.length > 0) {
                            result = xmlData;
                        }
                    }
                }
                // Uncompressed section is normally not used
                else if (type == 'tEXt') {
                    var vals = value.split(String.fromCharCode(0));

                    if (vals.length > 1 && (vals[0] == 'mxGraphModel' ||
                        vals[0] == 'mxfile')) {
                        result = vals[1];
                    }
                }

                if (result != null || type == 'IDAT') {
                    // Stops processing the file as our text chunks
                    // are always placed before the data section
                    return true;
                }
            }));
        } catch (e) {
            // ignores decoding errors
        }

        if (result != null && result.charAt(0) == '%') {
            result = decodeURIComponent(result);
        }

        // Workaround for double encoded content
        if (result != null && result.charAt(0) == '%') {
            result = decodeURIComponent(result);
        }

        return result;
    };

    /**
     * Extracts any parsers errors in the given XML.
     */
    Editor.extractParserError = function (node, defaultCause) {
        var cause = null;
        var errors = (node != null) ? node.getElementsByTagName('parsererror') : null;

        if (errors != null && errors.length > 0) {
            cause = defaultCause || mxResources.get('invalidChars');
            var divs = errors[0].getElementsByTagName('div');

            if (divs.length > 0) {
                cause = mxUtils.getTextContent(divs[0]);
            }
        }

        return cause;
    };

    /**
     * Global configuration of the Editor
     * see https://desk.draw.io/solution/articles/16000058316
     *
     * For defaultVertexStyle, defaultEdgeStyle and defaultLibraries, this must be called before
     * mxSettings.load via global config variable window.mxLoadSettings = false.
     */
    Editor.configure = function (config, untrusted) {
        if (config != null) {
            Editor.config = config;
            Editor.configVersion = config.version;
            Menus.prototype.defaultFonts = config.defaultFonts || Menus.prototype.defaultFonts;
            ColorDialog.prototype.presetColors = config.presetColors || ColorDialog.prototype.presetColors;
            ColorDialog.prototype.defaultColors = config.defaultColors || ColorDialog.prototype.defaultColors;
            StyleFormatPanel.prototype.defaultColorSchemes = config.defaultColorSchemes || StyleFormatPanel.prototype.defaultColorSchemes;
            Graph.prototype.defaultEdgeLength = config.defaultEdgeLength || Graph.prototype.defaultEdgeLength;
            DrawioFile.prototype.autosaveDelay = config.autosaveDelay || DrawioFile.prototype.autosaveDelay;

            if (config.templateFile != null) {
                EditorUi.templateFile = config.templateFile;
            }

            if (config.globalVars != null) {
                Editor.globalVars = config.globalVars;
            }

            if (config.compressXml != null) {
                Editor.compressXml = config.compressXml;
            }

            if (config.customFonts) {
                Menus.prototype.defaultFonts = config.customFonts.concat(Menus.prototype.defaultFonts);
            }

            if (config.customPresetColors) {
                ColorDialog.prototype.presetColors = config.customPresetColors.concat(ColorDialog.prototype.presetColors);
            }

            if (config.customColorSchemes != null) {
                StyleFormatPanel.prototype.defaultColorSchemes = config.customColorSchemes.concat(StyleFormatPanel.prototype.defaultColorSchemes);
            }

            // Custom CSS injected directly into the page
            if (config.css != null) {
                var s = document.createElement('style');
                s.setAttribute('type', 'text/css');
                s.appendChild(document.createTextNode(config.css));

                var t = document.getElementsByTagName('script')[0];
                t.parentNode.insertBefore(s, t);
            }

            // Configures the custom libraries
            if (config.libraries != null) {
                Sidebar.prototype.customEntries = config.libraries;
            }

            // Defines the enabled built-in libraries.
            if (config.enabledLibraries != null) {
                Sidebar.prototype.enabledLibraries = config.enabledLibraries;
            }

            // Overrides default libraries
            if (config.defaultLibraries != null) {
                Sidebar.prototype.defaultEntries = config.defaultLibraries;
            }

            // Overrides default custom libraries
            if (config.defaultCustomLibraries != null) {
                Editor.defaultCustomLibraries = config.defaultCustomLibraries;
            }

            // Disables custom libraries
            if (config.enableCustomLibraries != null) {
                Editor.enableCustomLibraries = config.enableCustomLibraries;
            }

            // Overrides default vertex style
            if (config.defaultVertexStyle != null) {
                Graph.prototype.defaultVertexStyle = config.defaultVertexStyle;
            }

            // Overrides default edge style
            if (config.defaultEdgeStyle != null) {
                Graph.prototype.defaultEdgeStyle = config.defaultEdgeStyle;
            }

            if (config.emptyDiagramXml) {
                EditorUi.prototype.emptyDiagramXml = config.emptyDiagramXml;
            }

            if (config.thumbWidth) {
                Sidebar.prototype.thumbWidth = config.thumbWidth;
            }

            if (config.thumbHeight) {
                Sidebar.prototype.thumbHeight = config.thumbHeight;
            }

            if (config.emptyLibraryXml) {
                EditorUi.prototype.emptyLibraryXml = config.emptyLibraryXml;
            }

            if (config.sidebarWidth) {
                EditorUi.prototype.hsplitPosition = config.sidebarWidth;
            }

            if (config.fontCss) {
                var s = document.createElement('style');
                s.setAttribute('type', 'text/css');
                s.appendChild(document.createTextNode(config.fontCss));

                var t = document.getElementsByTagName('script')[0];
                t.parentNode.insertBefore(s, t);

                Editor.prototype.fontCss = config.fontCss;
            }

            if (config.plugins != null && !untrusted) {
                // Required for callback
                App.initPluginCallback();

                for (var i = 0; i < config.plugins.length; i++) {
                    mxscript(config.plugins[i]);
                }
            }
        }
    };

    /**
     * Generates a unique ID of the given length
     */
    Editor.GUID_ALPHABET = '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ-_';

    /**
     * Generates a unique ID of the given length
     */
    Editor.GUID_LENGTH = 20;

    /**
     * Generates a unique ID of the given length
     */
    Editor.guid = function (length) {
        var len = (length != null) ? length : Editor.GUID_LENGTH;
        var rtn = [];

        for (var i = 0; i < len; i++) {
            rtn.push(Editor.GUID_ALPHABET.charAt(Math.floor(Math.random() * Editor.GUID_ALPHABET.length)));
        }

        return rtn.join('');
    };

    /**
     * General timeout is 25 seconds.
     */
    Editor.prototype.timeout = 25000;

    /**
     * This should not be enabled if reflows are required for math rendering.
     */
    Editor.prototype.useForeignObjectForMath = false;

    /**
     * Executes the first step for connecting to Google Drive.
     */
    Editor.prototype.editButtonLink = (urlParams['edit'] != null) ? decodeURIComponent(urlParams['edit']) : null;

    /**
     * Adds support for old stylesheets and compressed files
     */
    var editorSetGraphXml = Editor.prototype.setGraphXml;
    Editor.prototype.setGraphXml = function (node) {
        node = (node != null && node.nodeName != 'mxlibrary') ? this.extractGraphModel(node) : null;

        if (node != null) {
            // Checks input for parser errors
            var errs = node.getElementsByTagName('parsererror');

            if (errs != null && errs.length > 0) {
                var elt = errs[0];
                var divs = elt.getElementsByTagName('div');

                if (divs != null && divs.length > 0) {
                    elt = divs[0];
                }

                throw {message: mxUtils.getTextContent(elt)};
            } else if (node.nodeName == 'mxGraphModel') {
                var style = node.getAttribute('style') || 'default-style2';

                // Decodes the style if required
                if (urlParams['embed'] != '1' && (style == null || style == '')) {
                    var node2 = (this.graph.themes != null) ?
                        this.graph.themes['default-old'] :
                        mxUtils.load(STYLE_PATH + '/default-old.xml').getDocumentElement();

                    if (node2 != null) {
                        var dec2 = new mxCodec(node2.ownerDocument);
                        dec2.decode(node2, this.graph.getStylesheet());
                    }
                } else if (style != this.graph.currentStyle) {
                    var node2 = (this.graph.themes != null) ?
                        this.graph.themes[style] :
                        mxUtils.load(STYLE_PATH + '/' + style + '.xml').getDocumentElement()

                    if (node2 != null) {
                        var dec2 = new mxCodec(node2.ownerDocument);
                        dec2.decode(node2, this.graph.getStylesheet());
                    }
                }

                this.graph.currentStyle = style;
                this.graph.mathEnabled = (urlParams['math'] == '1' || node.getAttribute('math') == '1');

                var bgImg = node.getAttribute('backgroundImage');

                if (bgImg != null) {
                    bgImg = JSON.parse(bgImg);
                    this.graph.setBackgroundImage(new mxImage(bgImg.src, bgImg.width, bgImg.height));
                } else {
                    this.graph.setBackgroundImage(null);
                }

                mxClient.NO_FO = ((this.graph.mathEnabled && !this.useForeignObjectForMath)) ?
                    true : this.originalNoForeignObject;

                this.graph.useCssTransforms = !mxClient.NO_FO &&
                    this.isChromelessView() &&
                    this.graph.isCssTransformsSupported();
                this.graph.updateCssTransform();

                this.graph.setShadowVisible(node.getAttribute('shadow') == '1', false);
            }

            // Calls updateGraphComponents
            editorSetGraphXml.apply(this, arguments);
        } else {
            throw {
                message: mxResources.get('notADiagramFile') || 'Invalid data',
                toString: function () {
                    return this.message;
                }
            };
        }
    };

    /**
     * Adds persistent style to file
     */
    var editorGetGraphXml = Editor.prototype.getGraphXml;
    Editor.prototype.getGraphXml = function (ignoreSelection) {
        ignoreSelection = (ignoreSelection != null) ? ignoreSelection : true;
        var node = editorGetGraphXml.apply(this, arguments);

        // Adds the current style
        if (this.graph.currentStyle != null && this.graph.currentStyle != 'default-style2') {
            node.setAttribute('style', this.graph.currentStyle);
        }

        // Adds the background image
        if (this.graph.backgroundImage != null) {
            node.setAttribute('backgroundImage', JSON.stringify(this.graph.backgroundImage));
        }

        node.setAttribute('math', (this.graph.mathEnabled) ? '1' : '0');
        node.setAttribute('shadow', (this.graph.shadowVisible) ? '1' : '0');

        return node;
    };

    /**
     * Helper function to extract the graph model XML node.
     */
    Editor.prototype.isDataSvg = function (svg) {
        try {
            var svgRoot = mxUtils.parseXml(svg).documentElement;
            var tmp = svgRoot.getAttribute('content');

            if (tmp != null) {
                if (tmp != null && tmp.charAt(0) != '<' && tmp.charAt(0) != '%') {
                    tmp = unescape((window.atob) ? atob(tmp) : Base64.decode(cont, tmp));
                }

                if (tmp != null && tmp.charAt(0) == '%') {
                    tmp = decodeURIComponent(tmp);
                }

                if (tmp != null && tmp.length > 0) {
                    var node = mxUtils.parseXml(tmp).documentElement;


                    return node.nodeName == 'mxfile' || node.nodeName == 'mxGraphModel';
                }
            }
        } catch (e) {
            // ignore
        }

        return false;
    };

    /**
     * Helper function to extract the graph model XML node.
     */
    Editor.prototype.extractGraphModel = function (node, allowMxFile) {
        return Editor.extractGraphModel.apply(this, arguments);
    };

    /**
     * Overrides reset graph.
     */
    var editorResetGraph = Editor.prototype.resetGraph;
    Editor.prototype.resetGraph = function () {
        this.graph.mathEnabled = (urlParams['math'] == '1');
        this.graph.view.x0 = null;
        this.graph.view.y0 = null;
        mxClient.NO_FO = ((this.graph.mathEnabled && !this.useForeignObjectForMath)) ?
            true : this.originalNoForeignObject;

        this.graph.useCssTransforms = !mxClient.NO_FO &&
            this.isChromelessView() &&
            this.graph.isCssTransformsSupported();
        this.graph.updateCssTransform();

        editorResetGraph.apply(this, arguments);
    };

    /**
     * Return array of string values, or NULL if CSV string not well formed.
     */
    Editor.prototype.csvToArray = function (text) {
        var re_valid = /^\s*(?:'[^'\\]*(?:\\[\S\s][^'\\]*)*'|"[^"\\]*(?:\\[\S\s][^"\\]*)*"|[^,'"\s\\]*(?:\s+[^,'"\s\\]+)*)\s*(?:,\s*(?:'[^'\\]*(?:\\[\S\s][^'\\]*)*'|"[^"\\]*(?:\\[\S\s][^"\\]*)*"|[^,'"\s\\]*(?:\s+[^,'"\s\\]+)*)\s*)*$/;
        var re_value = /(?!\s*$)\s*(?:'([^'\\]*(?:\\[\S\s][^'\\]*)*)'|"([^"\\]*(?:\\[\S\s][^"\\]*)*)"|([^,'"\s\\]*(?:\s+[^,'"\s\\]+)*))\s*(?:,|$)/g;
        // Return NULL if input string is not well formed CSV string.
        if (!re_valid.test(text)) return null;
        var a = [];                     // Initialize array to receive values.
        text.replace(re_value, // "Walk" the string using replace with callback.
            function (m0, m1, m2, m3) {
                // Remove backslash from \' in single quoted values.
                if (m1 !== undefined) a.push(m1.replace(/\\'/g, "'"));
                // Remove backslash from \" in double quoted values.
                else if (m2 !== undefined) a.push(m2.replace(/\\"/g, '"'));
                else if (m3 !== undefined) a.push(m3);
                return ''; // Return empty string.
            });
        // Handle special case of empty last value.
        if (/,\s*$/.test(text)) a.push('');
        return a;
    };

    /**
     * Returns true if the given URL is known to have CORS headers.
     */
    Editor.prototype.isCorsEnabledForUrl = function (url) {
        if (urlParams['cors'] != null && this.corsRegExp == null) {
            this.corsRegExp = new RegExp(decodeURIComponent(urlParams['cors']));
        }

        return (this.corsRegExp != null && this.corsRegExp.test(url)) ||
            url.substring(0, 34) === 'https://raw.githubusercontent.com/' ||
            url.substring(0, 23) === 'https://cdn.rawgit.com/' ||
            url.substring(0, 19) === 'https://rawgit.com/' ||
            /^https?:\/\/[^\/]*\.blob.core.windows.net\//.test(url) ||
            /^https?:\/\/[^\/]*\.iconfinder.com\//.test(url) ||
            /^https?:\/\/[^\/]*\.draw\.io\/proxy/.test(url) ||
            /^https?:\/\/[^\/]*\.github\.io\//.test(url);
    };

    //TODO This function is a replica of EditorUi one, it is planned to replace all calls to EditorUi one to point to this one
    /**
     * Converts all images in the SVG output to data URIs for immediate rendering
     */
    Editor.prototype.createImageUrlConverter = function () {
        var converter = new mxUrlConverter();
        converter.updateBaseUrl();

        // Extends convert to avoid CORS using an image proxy server where needed
        var convert = converter.convert;
        var self = this;

        converter.convert = function (src) {
            if (src != null) {
                var remote = src.substring(0, 7) == 'http://' || src.substring(0, 8) == 'https://';

                if (remote && !navigator.onLine) {
                    src = EditorUi.prototype.svgBrokenImage.src; //TODO move it to Editor?
                } else if (remote && src.substring(0, converter.baseUrl.length) != converter.baseUrl &&
                    (!EditorUi.prototype.crossOriginImages || !self.isCorsEnabledForUrl(src))) //TODO move it to Editor?
                {
                    src = PROXY_URL + '?url=' + encodeURIComponent(src);
                } else if (src.substring(0, 19) != 'chrome-extension://' && !mxClient.IS_CHROMEAPP) {
                    src = convert.apply(this, arguments);
                }
            }

            return src;
        };

        return converter;
    };

    //TODO This function is a replica of EditorUi one, it is planned to replace all calls to EditorUi one to point to this one
    /**
     *
     */
    Editor.prototype.createSvgDataUri = function (svg) {
        return 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svg)));
    };

    //TODO This function is a replica of EditorUi one, it is planned to replace all calls to EditorUi one to point to this one
    /**
     *
     */
    Editor.prototype.convertImageToDataUri = function (url, callback) {
        if (/(\.svg)$/i.test(url)) {
            mxUtils.get(url, mxUtils.bind(this, function (req) {
                    callback(this.createSvgDataUri(req.getText()));
                }),
                function () {
                    callback(EditorUi.prototype.svgBrokenImage.src);
                });
        } else {
            var img = new Image();
            var self = this;

            if (EditorUi.prototype.crossOriginImages) {
                img.crossOrigin = 'anonymous';
            }

            img.onload = function () {
                var canvas = document.createElement('canvas');
                var ctx = canvas.getContext('2d');
                canvas.height = img.height;
                canvas.width = img.width;
                ctx.drawImage(img, 0, 0);

                try {
                    callback(canvas.toDataURL());
                } catch (e) {
                    callback(EditorUi.prototype.svgBrokenImage.src);
                }
            };

            img.onerror = function () {
                callback(EditorUi.prototype.svgBrokenImage.src);
            };

            img.src = url;
        }
    };

    //TODO This function is a replica of EditorUi one, it is planned to replace all calls to EditorUi one to point to this one
    /**
     * Converts all images in the SVG output to data URIs for immediate rendering
     */
    Editor.prototype.convertImages = function (svgRoot, callback, imageCache, converter) {
        // Converts images to data URLs for immediate painting
        if (converter == null) {
            converter = this.createImageUrlConverter();
        }

        // Barrier for asynchronous image loading
        var counter = 0;

        function inc() {
            counter++;
        };

        function dec() {
            counter--;

            if (counter == 0) {
                callback(svgRoot);
            }
        };

        var cache = imageCache || new Object();

        var convertImages = mxUtils.bind(this, function (tagName, srcAttr) {
            var images = svgRoot.getElementsByTagName(tagName);

            for (var i = 0; i < images.length; i++) {
                (mxUtils.bind(this, function (img) {
                    var src = converter.convert(img.getAttribute(srcAttr));

                    // Data URIs are pass-through
                    if (src != null && src.substring(0, 5) != 'data:') {
                        var tmp = cache[src];

                        if (tmp == null) {
                            inc();

                            this.convertImageToDataUri(src, function (uri) {
                                if (uri != null) {
                                    cache[src] = uri;
                                    img.setAttribute(srcAttr, uri);
                                }

                                dec();
                            });
                        } else {
                            img.setAttribute(srcAttr, tmp);
                        }
                    } else if (src != null) {
                        img.setAttribute(srcAttr, src);
                    }
                }))(images[i]);
            }
        });

        // Converts all known image tags in output
        // LATER: Add support for images in CSS
        convertImages('image', 'xlink:href');
        convertImages('img', 'src');

        // All from cache or no images
        if (counter == 0) {
            callback(svgRoot);
        }
    };

    //TODO This function is a replica of EditorUi one, it is planned to replace all calls to EditorUi one to point to this one
    /**
     * Base64 encodes the given string. This method seems to be more
     * robust for encoding PNG from binary AJAX responses.
     */
    Editor.prototype.base64Encode = function (str) {
        var CHARS = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";
        var out = "", i = 0, len = str.length, c1, c2, c3;

        while (i < len) {
            c1 = str.charCodeAt(i++) & 0xff;

            if (i == len) {
                out += CHARS.charAt(c1 >> 2);
                out += CHARS.charAt((c1 & 0x3) << 4);
                out += "==";
                break;
            }

            c2 = str.charCodeAt(i++);

            if (i == len) {
                out += CHARS.charAt(c1 >> 2);
                out += CHARS.charAt(((c1 & 0x3) << 4) | ((c2 & 0xF0) >> 4));
                out += CHARS.charAt((c2 & 0xF) << 2);
                out += "=";
                break;
            }

            c3 = str.charCodeAt(i++);
            out += CHARS.charAt(c1 >> 2);
            out += CHARS.charAt(((c1 & 0x3) << 4) | ((c2 & 0xF0) >> 4));
            out += CHARS.charAt(((c2 & 0xF) << 2) | ((c3 & 0xC0) >> 6));
            out += CHARS.charAt(c3 & 0x3F);
        }

        return out;
    };

    //TODO This function is a replica of EditorUi one, it is planned to replace all calls to EditorUi one to point to this one
    /**
     * Checks if the client is authorized and calls the next step.
     */
    Editor.prototype.loadUrl = function (url, success, error, forceBinary, retry, dataUriPrefix) {
        try {
            var binary = forceBinary || /(\.png)($|\?)/i.test(url) ||
                /(\.jpe?g)($|\?)/i.test(url) || /(\.gif)($|\?)/i.test(url);
            retry = (retry != null) ? retry : true;

            var fn = mxUtils.bind(this, function () {
                mxUtils.get(url, mxUtils.bind(this, function (req) {
                    if (req.getStatus() >= 200 && req.getStatus() <= 299) {
                        if (success != null) {
                            var data = req.getText();

                            // Returns PNG as base64 encoded data URI
                            if (binary) {
                                // NOTE: This requires BinaryToArray VB script in the page
                                if ((document.documentMode == 9 || document.documentMode == 10) &&
                                    typeof window.mxUtilsBinaryToArray !== 'undefined') {
                                    var bin = mxUtilsBinaryToArray(req.request.responseBody).toArray();
                                    var tmp = new Array(bin.length);

                                    for (var i = 0; i < bin.length; i++) {
                                        tmp[i] = String.fromCharCode(bin[i]);
                                    }

                                    data = tmp.join('');
                                }

                                // LATER: Could be JPG but modern browsers
                                // ignore the mime type in the data URI
                                dataUriPrefix = (dataUriPrefix != null) ? dataUriPrefix : 'data:image/png;base64,';
                                data = dataUriPrefix + this.base64Encode(data);
                            }

                            success(data);
                        }
                    } else if (error != null) {
                        error({code: App.ERROR_UNKNOWN}, req);
                    }
                }), function () {
                    if (error != null) {
                        error({code: App.ERROR_UNKNOWN});
                    }
                }, binary, this.timeout, function () {
                    if (retry && error != null) {
                        error({code: App.ERROR_TIMEOUT, retry: fn});
                    }
                });
            });

            fn();
        } catch (e) {
            if (error != null) {
                error(e);
            }
        }
    };

    //TODO This function is a replica of EditorUi one, it is planned to replace all calls to EditorUi one to point to this one
    /**
     * For the fontCSS to be applied when rendering images on canvas, the actual
     * font data must be made available via a data URI encoding of the file.
     */
    Editor.prototype.loadFonts = function (then) {
        if (this.fontCss != null && this.resolvedFontCss == null) {
            var parts = this.fontCss.split('url(');
            var waiting = 0;
            var fonts = {};

            // Strips leading and trailing quotes and spaces
            function trimString(str) {
                return str.replace(new RegExp("^[\\s\"']+", "g"), "").replace(new RegExp("[\\s\"']+$", "g"), "");
            };

            var finish = mxUtils.bind(this, function () {
                if (waiting == 0) {
                    // Constructs string
                    var result = [parts[0]];

                    for (var j = 1; j < parts.length; j++) {
                        var idx = parts[j].indexOf(')');
                        result.push('url("');
                        result.push(fonts[trimString(parts[j].substring(0, idx))]);
                        result.push('"' + parts[j].substring(idx));
                    }

                    this.resolvedFontCss = result.join('');
                    then();
                }
            });

            if (parts.length > 0) {
                for (var i = 1; i < parts.length; i++) {
                    var idx = parts[i].indexOf(')');
                    var format = null;

                    // Checks if there is a format directive
                    var fmtIdx = parts[i].indexOf('format(', idx);

                    if (fmtIdx > 0) {
                        format = trimString(parts[i].substring(fmtIdx + 7, parts[i].indexOf(')', fmtIdx)));
                    }

                    (mxUtils.bind(this, function (url) {
                        if (fonts[url] == null) {
                            // Mark font es being fetched and fetch it
                            fonts[url] = url;
                            waiting++;

                            var mime = 'application/x-font-ttf';

                            // See https://stackoverflow.com/questions/2871655/proper-mime-type-for-fonts
                            if (format == 'svg' || /(\.svg)($|\?)/i.test(url)) {
                                mime = 'image/svg+xml';
                            } else if (format == 'otf' || format == 'embedded-opentype' || /(\.otf)($|\?)/i.test(url)) {
                                mime = 'application/x-font-opentype';
                            } else if (format == 'woff' || /(\.woff)($|\?)/i.test(url)) {
                                mime = 'application/font-woff';
                            } else if (format == 'woff2' || /(\.woff2)($|\?)/i.test(url)) {
                                mime = 'application/font-woff2';
                            } else if (format == 'eot' || /(\.eot)($|\?)/i.test(url)) {
                                mime = 'application/vnd.ms-fontobject';
                            } else if (format == 'sfnt' || /(\.sfnt)($|\?)/i.test(url)) {
                                mime = 'application/font-sfnt';
                            }

                            var realUrl = url;

                            if ((/^https?:\/\//.test(realUrl)) && !this.isCorsEnabledForUrl(realUrl)) {
                                realUrl = PROXY_URL + '?url=' + encodeURIComponent(url);
                            }

                            // LATER: Remove cache-control header
                            this.loadUrl(realUrl, mxUtils.bind(this, function (uri) {
                                fonts[url] = uri;
                                waiting--;
                                finish();
                            }), mxUtils.bind(this, function (err) {
                                // LATER: handle error
                                waiting--;
                                finish();
                            }), true, null, 'data:' + mime + ';charset=utf-8;base64,');
                        }
                    }))(trimString(parts[i].substring(0, idx)), format);
                }
            }
        } else {
            then();
        }
    };

    //TODO This function is a replica of EditorUi one, it is planned to replace all calls to EditorUi one to point to this one
    /**
     * See fixme in convertMath for client-side image generation with math.
     */
    Editor.prototype.isExportToCanvas = function () {
        return mxClient.IS_CHROMEAPP || (!this.graph.mathEnabled && this.useCanvasForExport);
    };

    //TODO This function is a replica of EditorUi one, it is planned to replace all calls to EditorUi one to point to this one
    /**
     *
     */
    Editor.prototype.exportToCanvas = function (callback, width, imageCache, background, error, limitHeight,
                                                ignoreSelection, scale, transparentBackground, addShadow, converter, graph, border, noCrop) {
        limitHeight = (limitHeight != null) ? limitHeight : true;
        ignoreSelection = (ignoreSelection != null) ? ignoreSelection : true;
        graph = (graph != null) ? graph : this.graph;
        border = (border != null) ? border : 0;

        var bg = (transparentBackground) ? null : graph.background;

        if (bg == mxConstants.NONE) {
            bg = null;
        }

        if (bg == null) {
            bg = background;
        }

        // Handles special case where background is null but transparent is false
        if (bg == null && transparentBackground == false) {
            bg = this.graph.defaultPageBackgroundColor;
        }

        this.convertImages(graph.getSvg(bg, null, null, noCrop, null, ignoreSelection, null, null, null, addShadow),
            mxUtils.bind(this, function (svgRoot) {
                var img = new Image();

                img.onload = mxUtils.bind(this, function () {
                    try {
                        var canvas = document.createElement('canvas');
                        var w = parseInt(svgRoot.getAttribute('width'));
                        var h = parseInt(svgRoot.getAttribute('height'));
                        scale = (scale != null) ? scale : 1;

                        if (width != null) {
                            scale = (!limitHeight) ? width / w : Math.min(1, Math.min((width * 3) / (h * 4), width / w));
                        }

                        w = Math.ceil(scale * w) + 2 * border;
                        h = Math.ceil(scale * h) + 2 * border;

                        canvas.setAttribute('width', w);
                        canvas.setAttribute('height', h);
                        var ctx = canvas.getContext('2d');

                        if (bg != null) {
                            ctx.beginPath();
                            ctx.rect(0, 0, w, h);
                            ctx.fillStyle = bg;
                            ctx.fill();
                        }

                        ctx.scale(scale, scale);

                        // Workaround for broken data URI images in Safari on first export
                        if (mxClient.IS_SF) {
                            window.setTimeout(function () {
                                ctx.drawImage(img, border / scale, border / scale);
                                callback(canvas);
                            }, 0);
                        } else {
                            ctx.drawImage(img, border / scale, border / scale);
                            callback(canvas);
                        }
                    } catch (e) {
                        if (error != null) {
                            error(e);
                        }
                    }
                });

                img.onerror = function (e) {
                    //console.log('img', e, img.src);

                    if (error != null) {
                        error(e);
                    }
                };

                try {
                    if (addShadow) {
                        this.graph.addSvgShadow(svgRoot);
                    }

                    var done = mxUtils.bind(this, function () {
                        if (this.resolvedFontCss != null) {
                            var st = document.createElement('style');
                            st.setAttribute('type', 'text/css');
                            st.innerHTML = this.resolvedFontCss;

                            // Must be in defs section for FF to work
                            var defs = svgRoot.getElementsByTagName('defs');
                            defs[0].appendChild(st);
                        }

                        this.convertMath(graph, svgRoot, true, mxUtils.bind(this, function () {
                            img.src = this.createSvgDataUri(mxUtils.getXml(svgRoot));
                        }));
                    });

                    this.loadFonts(done);
                } catch (e) {
                    //console.log('src', e, img.src);

                    if (error != null) {
                        error(e);
                    }
                }
            }), imageCache, converter);
    };

    //TODO This function is a replica of EditorUi one, it is planned to replace all calls to EditorUi one to point to this one
    /**
     * Adds the given text to the compressed or non-compressed text chunk.
     */
    Editor.prototype.writeGraphModelToPng = function (data, type, key, value, error) {
        var base64 = data.substring(data.indexOf(',') + 1);
        var f = (window.atob) ? atob(base64) : Base64.decode(base64, true);
        var pos = 0;

        function fread(d, count) {
            var start = pos;
            pos += count;

            return d.substring(start, pos);
        };

        // Reads unsigned long 32 bit big endian
        function _freadint(d) {
            var bytes = fread(d, 4);

            return bytes.charCodeAt(3) + (bytes.charCodeAt(2) << 8) +
                (bytes.charCodeAt(1) << 16) + (bytes.charCodeAt(0) << 24);
        };

        function writeInt(num) {
            return String.fromCharCode((num >> 24) & 0x000000ff, (num >> 16) & 0x000000ff,
                (num >> 8) & 0x000000ff, num & 0x000000ff);
        };

        // Checks signature
        if (fread(f, 8) != String.fromCharCode(137) + 'PNG' + String.fromCharCode(13, 10, 26, 10)) {
            if (error != null) {
                error();
            }

            return;
        }

        // Reads header chunk
        fread(f, 4);

        if (fread(f, 4) != 'IHDR') {
            if (error != null) {
                error();
            }

            return;
        }

        fread(f, 17);
        var result = f.substring(0, pos);

        do {
            var n = _freadint(f);
            var chunk = fread(f, 4);

            if (chunk == 'IDAT') {
                result = f.substring(0, pos - 8);

                var chunkData = key + String.fromCharCode(0) +
                    ((type == 'zTXt') ? String.fromCharCode(0) : '') +
                    value;

                var crc = 0xffffffff;
                crc = EditorUi.prototype.updateCRC(crc, type, 0, 4); //TODO move code to Editor?
                crc = EditorUi.prototype.updateCRC(crc, chunkData, 0, chunkData.length);

                result += writeInt(chunkData.length) + type + chunkData + writeInt(crc ^ 0xffffffff);
                result += f.substring(pos - 8, f.length);

                break;
            }

            result += f.substring(pos - 8, pos - 4 + n);
            fread(f, n);
            fread(f, 4);
        }
        while (n);

        return 'data:image/png;base64,' + ((window.btoa) ? btoa(result) : Base64.encode(result, true));
    }

    /**
     * Adds persistence for recent colors
     */
    if (window.ColorDialog) {
        FilenameDialog.filenameHelpLink = 'https://desk.draw.io/support/solutions/articles/16000091426';

        var colorDialogAddRecentColor = ColorDialog.addRecentColor;

        ColorDialog.addRecentColor = function (color, max) {
            colorDialogAddRecentColor.apply(this, arguments);

            mxSettings.setRecentColors(ColorDialog.recentColors);
            mxSettings.save();
        };

        var colorDialogResetRecentColors = ColorDialog.resetRecentColors;

        ColorDialog.resetRecentColors = function () {
            colorDialogResetRecentColors.apply(this, arguments);

            mxSettings.setRecentColors(ColorDialog.recentColors);
            mxSettings.save();
        };
    }

    // Overrides ID for pages
    if (window.EditDataDialog) {
        EditDataDialog.getDisplayIdForCell = function (ui, cell) {
            var id = null;

            if (ui.editor.graph.getModel().getParent(cell) != null) {
                id = cell.getId();
            } else if (ui.currentPage != null) {
                id = ui.currentPage.getId();
            }

            return id;
        };
    }

    if (window.StyleFormatPanel != null) {
        var formatInit = Format.prototype.init;

        Format.prototype.init = function () {
            formatInit.apply(this, arguments);

            this.editorUi.editor.addListener('fileLoaded', this.update);
        };

        var formatRefresh = Format.prototype.refresh;

        Format.prototype.refresh = function () {
            if (this.editorUi.getCurrentFile() != null || urlParams['embed'] == '1' ||
                this.editorUi.editor.chromeless) {
                formatRefresh.apply(this, arguments);
            } else {
                this.clear();
            }
        };

        /**
         * Hook for subclassers.
         */
        DiagramFormatPanel.prototype.isShadowOptionVisible = function () {
            var file = this.editorUi.getCurrentFile();

            return urlParams['embed'] == '1' || (file != null && file.isEditable());
        };

        /**
         * Option is not visible in default theme.
         */
        DiagramFormatPanel.prototype.isMathOptionVisible = function (div) {
            return false;
        };

        /**
         * Add global shadow option.
         */
        var diagramFormatPanelAddView = DiagramFormatPanel.prototype.addView;

        DiagramFormatPanel.prototype.addView = function (div) {
            var div = diagramFormatPanelAddView.apply(this, arguments);
            var file = this.editorUi.getCurrentFile();

            if (mxClient.IS_SVG && this.isShadowOptionVisible()) {
                var ui = this.editorUi;
                var editor = ui.editor;
                var graph = editor.graph;

                var option = this.createOption(mxResources.get('shadow'), function () {
                        return graph.shadowVisible;
                    }, function (checked) {
                        var change = new ChangePageSetup(ui);
                        change.ignoreColor = true;
                        change.ignoreImage = true;
                        change.shadowVisible = checked;

                        graph.model.execute(change);
                    },
                    {
                        install: function (apply) {
                            this.listener = function () {
                                apply(graph.shadowVisible);
                            };

                            ui.addListener('shadowVisibleChanged', this.listener);
                        },
                        destroy: function () {
                            ui.removeListener(this.listener);
                        }
                    });

                if (!Editor.shadowOptionEnabled) {
                    option.getElementsByTagName('input')[0].setAttribute('disabled', 'disabled');
                    mxUtils.setOpacity(option, 60);
                }

                div.appendChild(option);
            }

            return div;
        };

        mxCellRenderer.prototype.defaultVertexShape.prototype.customProperties = [
            {name: 'arcSize', dispName: 'Arc Size', type: 'float', min: 0, defVal: mxConstants.LINE_ARCSIZE},
            {name: 'absoluteArcSize', dispName: 'Abs. Arc Size', type: 'bool', defVal: false}
        ];

        mxCellRenderer.defaultShapes['link'].prototype.customProperties = [
            {name: 'width', dispName: 'Width', type: 'float', min: 0, defVal: 4}
        ];

        mxCellRenderer.defaultShapes['flexArrow'].prototype.customProperties = [
            {name: 'width', dispName: 'Width', type: 'float', min: 0, defVal: 10},
            {name: 'startWidth', dispName: 'Start Width', type: 'float', min: 0, defVal: 20},
            {name: 'endWidth', dispName: 'End Width', type: 'float', min: 0, defVal: 20}
        ];

        mxCellRenderer.defaultShapes['process'].prototype.customProperties = [
            {name: 'size', dispName: 'Indent', type: 'float', min: 0, max: 0.5, defVal: 0.1}
        ];

        mxCellRenderer.defaultShapes['rhombus'].prototype.customProperties = [
            {name: 'arcSize', dispName: 'Arc Size', type: 'float', min: 0, max: 50, defVal: mxConstants.LINE_ARCSIZE},
            {name: 'double', dispName: 'Double', type: 'bool', defVal: false}
        ];

        mxCellRenderer.defaultShapes['partialRectangle'].prototype.customProperties = [
            {name: 'top', dispName: 'Top Line', type: 'bool', defVal: true},
            {name: 'bottom', dispName: 'Bottom Line', type: 'bool', defVal: true},
            {name: 'left', dispName: 'Left Line', type: 'bool', defVal: true},
            {name: 'right', dispName: 'Right Line', type: 'bool', defVal: true}
        ];

        mxCellRenderer.defaultShapes['parallelogram'].prototype.customProperties = [
            {name: 'arcSize', dispName: 'Arc Size', type: 'float', min: 0, defVal: mxConstants.LINE_ARCSIZE},
            {name: 'size', dispName: 'Slope Angle', type: 'float', min: 0, max: 1, defVal: 0.2}
        ];

        mxCellRenderer.defaultShapes['hexagon'].prototype.customProperties = [
            {name: 'arcSize', dispName: 'Arc Size', type: 'float', min: 0, defVal: mxConstants.LINE_ARCSIZE},
            {name: 'size', dispName: 'Slope Angle', type: 'float', min: 0, max: 1, defVal: 0.25}
        ];

        mxCellRenderer.defaultShapes['triangle'].prototype.customProperties = [
            {name: 'arcSize', dispName: 'Arc Size', type: 'float', min: 0, defVal: mxConstants.LINE_ARCSIZE}
        ];

        mxCellRenderer.defaultShapes['document'].prototype.customProperties = [
            {name: 'size', dispName: 'Size', type: 'float', defVal: 0.3, min: 0, max: 1}
        ];

        mxCellRenderer.defaultShapes['internalStorage'].prototype.customProperties = [
            {name: 'arcSize', dispName: 'Arc Size', type: 'float', min: 0, defVal: mxConstants.LINE_ARCSIZE},
            {name: 'dx', dispName: 'Left Line', type: 'float', min: 0, defVal: 20},
            {name: 'dy', dispName: 'Top Line', type: 'float', min: 0, defVal: 20}
        ];

        mxCellRenderer.defaultShapes['cube'].prototype.customProperties = [
            {name: 'size', dispName: 'Size', type: 'float', min: 0, defVal: 20},
            {name: 'darkOpacity', dispName: 'Dark Opacity', type: 'float', min: -1, max: 1, defVal: 0},
            {name: 'darkOpacity2', dispName: 'Dark Opacity 2', type: 'float', min: -1, max: 1, defVal: 0}
        ];

        mxCellRenderer.defaultShapes['step'].prototype.customProperties = [
            {name: 'size', dispName: 'Notch Size', type: 'float', min: 0, defVal: 20},
            {name: 'fixedSize', dispName: 'Fixed Size', type: 'bool', defVal: true}
        ];

        mxCellRenderer.defaultShapes['trapezoid'].prototype.customProperties = [
            {name: 'arcSize', dispName: 'Arc Size', type: 'float', min: 0, defVal: mxConstants.LINE_ARCSIZE},
            {name: 'size', dispName: 'Slope Angle', type: 'float', min: 0, max: 1, defVal: 0.2}
        ];

        mxCellRenderer.defaultShapes['tape'].prototype.customProperties = [
            {name: 'size', dispName: 'Size', type: 'float', min: 0, max: 1, defVal: 0.4}
        ];

        mxCellRenderer.defaultShapes['note'].prototype.customProperties = [
            {name: 'size', dispName: 'Fold Size', type: 'float', min: 0, defVal: 30},
            {name: 'darkOpacity', dispName: 'Dark Opacity', type: 'float', min: -1, max: 1, defVal: 0},
        ];

        mxCellRenderer.defaultShapes['card'].prototype.customProperties = [
            {name: 'arcSize', dispName: 'Arc Size', type: 'float', min: 0, defVal: mxConstants.LINE_ARCSIZE},
            {name: 'size', dispName: 'Cutoff Size', type: 'float', min: 0, defVal: 30}
        ];

        mxCellRenderer.defaultShapes['callout'].prototype.customProperties = [
            {name: 'arcSize', dispName: 'Arc Size', type: 'float', min: 0, defVal: mxConstants.LINE_ARCSIZE},
            {name: 'base', dispName: 'Callout Width', type: 'float', min: 0, defVal: 20},
            {name: 'size', dispName: 'Callout Length', type: 'float', min: 0, defVal: 30},
            {name: 'position', dispName: 'Callout Position', type: 'float', min: 0, max: 1, defVal: 0.5},
            {name: 'position2', dispName: 'Callout Tip Position', type: 'float', min: 0, max: 1, defVal: 0.5}
        ];

        mxCellRenderer.defaultShapes['folder'].prototype.customProperties = [
            {name: 'tabWidth', dispName: 'Tab Width', type: 'float'},
            {name: 'tabHeight', dispName: 'Tab Height', type: 'float'},
            {
                name: 'tabPosition', dispName: 'Tap Position', type: 'enum',
                enumList: [{val: 'left', dispName: 'Left'}, {val: 'right', dispName: 'Right'}]
            }
        ];

        mxCellRenderer.defaultShapes['swimlane'].prototype.customProperties = [
            {name: 'arcSize', dispName: 'Arc Size', type: 'float', min: 0, defVal: 15},
            {name: 'startSize', dispName: 'Header Size', type: 'float'},
            {name: 'horizontal', dispName: 'Horizontal', type: 'bool', defVal: true},
            {name: 'separatorColor', dispName: 'Separator Color', type: 'color', defVal: null},
        ];

        mxCellRenderer.defaultShapes['doubleEllipse'].prototype.customProperties = [
            {name: 'margin', dispName: 'Indent', type: 'float', min: 0, defVal: 4}
        ];

        mxCellRenderer.defaultShapes['ext'].prototype.customProperties = [
            {name: 'arcSize', dispName: 'Arc Size', type: 'float', min: 0, defVal: 15},
            {name: 'double', dispName: 'Double', type: 'bool', defVal: false},
            {name: 'margin', dispName: 'Indent', type: 'float', min: 0, defVal: 0}
        ];

        mxCellRenderer.defaultShapes['curlyBracket'].prototype.customProperties = [
            {name: 'rounded', dispName: 'Rounded', type: 'bool', defVal: true},
            {name: 'size', dispName: 'Size', type: 'float', min: 0, max: 1, defVal: 0.5}
        ];

        mxCellRenderer.defaultShapes['image'].prototype.customProperties = [
            {name: 'imageAspect', dispName: 'Fixed Image Aspect', type: 'bool', defVal: true}
        ];

        mxCellRenderer.defaultShapes['label'].prototype.customProperties = [
            {name: 'imageAspect', dispName: 'Fixed Image Aspect', type: 'bool', defVal: true},
            {
                name: 'imageAlign', dispName: 'Image Align', type: 'enum',
                enumList: [{val: 'left', dispName: 'Left'},
                    {val: 'center', dispName: 'Center'},
                    {val: 'right', dispName: 'Right'}], defVal: 'left'
            },
            {
                name: 'imageVerticalAlign', dispName: 'Image Vertical Align', type: 'enum',
                enumList: [{val: 'top', dispName: 'Top'},
                    {val: 'middle', dispName: 'Middle'},
                    {val: 'bottom', dispName: 'Bottom'}], defVal: 'middle'
            },
            {name: 'imageWidth', dispName: 'Image Width', type: 'float', min: 0, defVal: 24},
            {name: 'imageHeight', dispName: 'Image Height', type: 'float', min: 0, defVal: 24},
            {name: 'arcSize', dispName: 'Arc Size', type: 'float', min: 0, defVal: 12},
            {name: 'absoluteArcSize', dispName: 'Abs. Arc Size', type: 'bool', defVal: false}
        ];

        mxCellRenderer.defaultShapes['dataStorage'].prototype.customProperties = [
            {name: 'size', dispName: 'Size', type: 'float', min: 0, max: 1, defVal: 0.1}
        ];

        mxCellRenderer.defaultShapes['manualInput'].prototype.customProperties = [
            {name: 'size', dispName: 'Size', type: 'float', min: 0, defVal: 30},
            {name: 'arcSize', dispName: 'Arc Size', type: 'float', min: 0, defVal: 20}
        ];

        mxCellRenderer.defaultShapes['loopLimit'].prototype.customProperties = [
            {name: 'size', dispName: 'Size', type: 'float', min: 0, defVal: 20},
            {name: 'arcSize', dispName: 'Arc Size', type: 'float', min: 0, defVal: 20}
        ];

        mxCellRenderer.defaultShapes['offPageConnector'].prototype.customProperties = [
            {name: 'size', dispName: 'Size', type: 'float', min: 0, defVal: 38},
            {name: 'arcSize', dispName: 'Arc Size', type: 'float', min: 0, defVal: 20}
        ];

        mxCellRenderer.defaultShapes['display'].prototype.customProperties = [
            {name: 'size', dispName: 'Size', type: 'float', min: 0, max: 1, defVal: 0.25}
        ];

        mxCellRenderer.defaultShapes['singleArrow'].prototype.customProperties = [
            {name: 'arrowWidth', dispName: 'Arrow Width', type: 'float', min: 0, max: 1, defVal: 0.3},
            {name: 'arrowSize', dispName: 'Arrowhead Length', type: 'float', min: 0, max: 1, defVal: 0.2}
        ];

        mxCellRenderer.defaultShapes['doubleArrow'].prototype.customProperties = [
            {name: 'arrowWidth', dispName: 'Arrow Width', type: 'float', min: 0, max: 1, defVal: 0.3},
            {name: 'arrowSize', dispName: 'Arrowhead Length', type: 'float', min: 0, max: 1, defVal: 0.2}
        ];

        mxCellRenderer.defaultShapes['cross'].prototype.customProperties = [
            {name: 'size', dispName: 'Size', type: 'float', min: 0, max: 1, defVal: 0.2}
        ];

        mxCellRenderer.defaultShapes['corner'].prototype.customProperties = [
            {name: 'dx', dispName: 'Width1', type: 'float', min: 0, defVal: 20},
            {name: 'dy', dispName: 'Width2', type: 'float', min: 0, defVal: 20}
        ];

        mxCellRenderer.defaultShapes['tee'].prototype.customProperties = [
            {name: 'dx', dispName: 'Width1', type: 'float', min: 0, defVal: 20},
            {name: 'dy', dispName: 'Width2', type: 'float', min: 0, defVal: 20}
        ];

        mxCellRenderer.defaultShapes['umlLifeline'].prototype.customProperties = [
            {
                name: 'participant', dispName: 'Participant', type: 'enum', defVal: 'none', enumList: [
                    {val: 'none', dispName: 'Default'},
                    {val: 'umlActor', dispName: 'Actor'},
                    {val: 'umlBoundary', dispName: 'Boundary'},
                    {val: 'umlEntity', dispName: 'Entity'},
                    {val: 'umlControl', dispName: 'Control'},
                ]
            },
            {name: 'size', dispName: 'Height', type: 'float', defVal: 40, min: 0}
        ];

        mxCellRenderer.defaultShapes['umlFrame'].prototype.customProperties = [
            {name: 'width', dispName: 'Title Width', type: 'float', defVal: 60, min: 0},
            {name: 'height', dispName: 'Title Height', type: 'float', defVal: 30, min: 0}
        ];

        /**
         * Configures global color schemes.
         */
        StyleFormatPanel.prototype.defaultColorSchemes = [[{fill: '', stroke: ''}, {
            fill: '#f5f5f5',
            stroke: '#666666',
            font: '#333333'
        },
            {fill: '#dae8fc', stroke: '#6c8ebf'}, {fill: '#d5e8d4', stroke: '#82b366'},
            {fill: '#ffe6cc', stroke: '#d79b00'}, {fill: '#fff2cc', stroke: '#d6b656'},
            {fill: '#f8cecc', stroke: '#b85450'}, {fill: '#e1d5e7', stroke: '#9673a6'}],
            [{fill: '#60a917', stroke: '#2D7600', font: '#ffffff'}, {
                fill: '#008a00',
                stroke: '#005700',
                font: '#ffffff'
            },
                {fill: '#1ba1e2', stroke: '#006EAF', font: '#ffffff'}, {
                fill: '#0050ef',
                stroke: '#001DBC',
                font: '#ffffff'
            },
                {fill: '#6a00ff', stroke: '#3700CC', font: '#ffffff'}, {
                fill: '#aa00ff',
                stroke: '#7700CC',
                font: '#ffffff'
            },
                {fill: '#d80073', stroke: '#A50040', font: '#ffffff'}, {
                fill: '#a20025',
                stroke: '#6F0000',
                font: '#ffffff'
            }],
            [{fill: '#e51400', stroke: '#B20000', font: '#ffffff'}, {
                fill: '#fa6800',
                stroke: '#C73500',
                font: '#ffffff'
            },
                {fill: '#f0a30a', stroke: '#BD7000', font: '#ffffff'}, {
                fill: '#e3c800',
                stroke: '#B09500',
                font: '#ffffff'
            },
                {fill: '#6d8764', stroke: '#3A5431', font: '#ffffff'}, {
                fill: '#647687',
                stroke: '#314354',
                font: '#ffffff'
            },
                {fill: '#76608a', stroke: '#432D57', font: '#ffffff'}, {
                fill: '#a0522d',
                stroke: '#6D1F00',
                font: '#ffffff'
            }],
            [{fill: '', stroke: ''}, {fill: mxConstants.NONE, stroke: ''},
                {fill: '#fad7ac', stroke: '#b46504'}, {fill: '#fad9d5', stroke: '#ae4132'},
                {fill: '#b0e3e6', stroke: '#0e8088'}, {fill: '#b1ddf0', stroke: '#10739e'},
                {fill: '#d0cee2', stroke: '#56517e'}, {fill: '#bac8d3', stroke: '#23445d'}],
            [{fill: '', stroke: ''},
                {fill: '#f5f5f5', stroke: '#666666', gradient: '#b3b3b3'},
                {fill: '#dae8fc', stroke: '#6c8ebf', gradient: '#7ea6e0'},
                {fill: '#d5e8d4', stroke: '#82b366', gradient: '#97d077'},
                {fill: '#ffcd28', stroke: '#d79b00', gradient: '#ffa500'},
                {fill: '#fff2cc', stroke: '#d6b656', gradient: '#ffd966'},
                {fill: '#f8cecc', stroke: '#b85450', gradient: '#ea6b66'},
                {fill: '#e6d0de', stroke: '#996185', gradient: '#d5739d'}],
            [{fill: '', stroke: ''}, {fill: '#eeeeee', stroke: '#36393d'},
                {fill: '#f9f7ed', stroke: '#36393d'}, {fill: '#ffcc99', stroke: '#36393d'},
                {fill: '#cce5ff', stroke: '#36393d'}, {fill: '#ffff88', stroke: '#36393d'},
                {fill: '#cdeb8b', stroke: '#36393d'}, {fill: '#ffcccc', stroke: '#36393d'}]];

        /**
         * Configures custom color schemes.
         */
        StyleFormatPanel.prototype.customColorSchemes = null;

        StyleFormatPanel.prototype.findCommonProperties = function (cell, properties, addAll) {
            if (properties == null) return;

            var handleCustomProp = function (custProperties) {
                if (custProperties != null) {
                    if (addAll) {
                        for (var i = 0; i < custProperties.length; i++) {
                            properties[custProperties[i].name] = custProperties[i];
                        }
                    } else {
                        for (var key in properties) {
                            var found = false;

                            for (var i = 0; i < custProperties.length; i++) {
                                if (custProperties[i].name == key && custProperties[i].type == properties[key].type) {
                                    found = true;
                                    break;
                                }
                            }

                            if (!found) {
                                delete properties[key];
                            }
                        }
                    }
                }
            };

            var view = this.editorUi.editor.graph.view;
            var state = view.getState(cell);

            if (state != null && state.shape != null) {
                //Add common properties to all shapes
                if (!state.shape.commonCustomPropAdded) {
                    state.shape.commonCustomPropAdded = true;
                    state.shape.customProperties = state.shape.customProperties || [];

                    if (state.cell.vertex) {
                        Array.prototype.push.apply(state.shape.customProperties, Editor.commonVertexProperties);
                    } else {
                        Array.prototype.push.apply(state.shape.customProperties, Editor.commonEdgeProperties);
                    }
                }

                handleCustomProp(state.shape.customProperties);
            }

            //This currently is not needed but let's keep it in case we needed in the future
            var userCustomProp = cell.getAttribute('customProperties');

            if (userCustomProp != null) {
                try {
                    handleCustomProp(JSON.parse(userCustomProp));
                } catch (e) {
                }
            }
        };

        /**
         * Adds predefiend styles.
         */
        var styleFormatPanelInit = StyleFormatPanel.prototype.init;

        StyleFormatPanel.prototype.init = function () {
            // TODO: Update sstate in Format
            var sstate = this.format.createSelectionState();

            if (sstate.style.shape != 'image' && !sstate.containsLabel) {
                this.container.appendChild(this.addStyles(this.createPanel()));
            }

            styleFormatPanelInit.apply(this, arguments);

            if (Editor.enableCustomProperties) {
                var properties = {};
                var vertices = sstate.vertices;
                var edges = sstate.edges;

                for (var i = 0; i < vertices.length; i++) {
                    this.findCommonProperties(vertices[i], properties, i == 0);
                }

                for (var i = 0; i < edges.length; i++) {
                    this.findCommonProperties(edges[i], properties, vertices.length == 0 && i == 0);
                }
            }
        };

        /**
         * Overridden to add copy and paste style.
         */
        var styleFormatPanelAddStyleOps = StyleFormatPanel.prototype.addStyleOps;

        StyleFormatPanel.prototype.addStyleOps = function (div) {
            var graph = this.editorUi.editor.graph;

            var btn = mxUtils.button(mxResources.get('copyStyle'), mxUtils.bind(this, function (evt) {
                this.editorUi.actions.get('copyStyle').funct();
            }));

            btn.setAttribute('title', mxResources.get('copyStyle') + ' (' + this.editorUi.actions.get('copyStyle').shortcut + ')');
            btn.style.marginBottom = '2px';
            btn.style.width = '100px';
            btn.style.marginRight = '2px';

            div.appendChild(btn);

            var btn = mxUtils.button(mxResources.get('pasteStyle'), mxUtils.bind(this, function (evt) {
                this.editorUi.actions.get('pasteStyle').funct();
            }));

            btn.setAttribute('title', mxResources.get('pasteStyle') + ' (' + this.editorUi.actions.get('pasteStyle').shortcut + ')');
            btn.style.marginBottom = '2px';
            btn.style.width = '100px';

            div.appendChild(btn);
            mxUtils.br(div);

            return styleFormatPanelAddStyleOps.apply(this, arguments);
        };

        /**
         * Initial collapsed state of the properties panel.
         */
        EditorUi.prototype.propertiesCollapsed = true;
        /**
         * Creates the buttons for the predefined styles.
         */
        StyleFormatPanel.prototype.addStyles = function (div) {
            var graph = this.editorUi.editor.graph;
            var picker = document.createElement('div');
            picker.style.whiteSpace = 'nowrap';
            picker.style.paddingLeft = '24px';
            picker.style.paddingRight = '20px';
            div.style.paddingLeft = '16px';
            div.style.paddingBottom = '6px';
            div.style.position = 'relative';
            div.appendChild(picker);

            var stylenames = ['plain-gray', 'plain-blue', 'plain-green', 'plain-turquoise',
                'plain-orange', 'plain-yellow', 'plain-red', 'plain-pink', 'plain-purple', 'gray',
                'blue', 'green', 'turquoise', 'orange', 'yellow', 'red', 'pink', 'purple'];

            function updateScheme(colorsets) {
                function addButton(colorset) {
                    var btn = mxUtils.button('', function (evt) {
                        graph.getModel().beginUpdate();
                        try {
                            var cells = graph.getSelectionCells();
                            var cell = _.first(cells);

                            for (var i = 0; i < cells.length; i++) {
                                var style = graph.getModel().getStyle(cells[i]);

                                for (var j = 0; j < stylenames.length; j++) {
                                    style = mxUtils.removeStylename(style, stylenames[j]);
                                }

                                var defaults = (graph.getModel().isVertex(cells[i])) ? graph.defaultVertexStyle : graph.defaultEdgeStyle;

                                if (colorset != null) {
                                    style = mxUtils.setStyle(style, mxConstants.STYLE_GRADIENTCOLOR, colorset['gradient'] ||
                                        mxUtils.getValue(defaults, mxConstants.STYLE_GRADIENTCOLOR, null));

                                    if (colorset['fill'] == '') {
                                        style = mxUtils.setStyle(style, mxConstants.STYLE_FILLCOLOR, null);
                                    } else {
                                        style = mxUtils.setStyle(style, mxConstants.STYLE_FILLCOLOR, colorset['fill'] ||
                                            mxUtils.getValue(defaults, mxConstants.STYLE_FILLCOLOR, null));
                                    }

                                    if (colorset['stroke'] == '') {
                                        style = mxUtils.setStyle(style, mxConstants.STYLE_STROKECOLOR, null);
                                    } else {
                                        style = mxUtils.setStyle(style, mxConstants.STYLE_STROKECOLOR, colorset['stroke'] ||
                                            mxUtils.getValue(defaults, mxConstants.STYLE_STROKECOLOR, null));
                                    }

                                    if (graph.getModel().isVertex(cells[i])) {
                                        style = mxUtils.setStyle(style, mxConstants.STYLE_FONTCOLOR, colorset['font'] ||
                                            mxUtils.getValue(defaults, mxConstants.STYLE_FONTCOLOR, null));
                                    }
                                } else {
                                    style = mxUtils.setStyle(style, mxConstants.STYLE_FILLCOLOR,
                                        mxUtils.getValue(defaults, mxConstants.STYLE_FILLCOLOR, '#ffffff'));
                                    style = mxUtils.setStyle(style, mxConstants.STYLE_STROKECOLOR,
                                        mxUtils.getValue(defaults, mxConstants.STYLE_STROKECOLOR, '#000000'));
                                    style = mxUtils.setStyle(style, mxConstants.STYLE_GRADIENTCOLOR,
                                        mxUtils.getValue(defaults, mxConstants.STYLE_GRADIENTCOLOR, null));

                                    if (graph.getModel().isVertex(cells[i])) {
                                        style = mxUtils.setStyle(style, mxConstants.STYLE_FONTCOLOR,
                                            mxUtils.getValue(defaults, mxConstants.STYLE_FONTCOLOR, null));
                                    }
                                }

                                graph.getModel().setStyle(cells[i], style);
                            }

                            // 重新渲染组件
                            neptuneHandler.renderMxCell(cell);

                        } finally {
                            graph.getModel().endUpdate();
                        }
                    })

                    btn.className = 'geStyleButton';
                    btn.style.width = '36px';
                    btn.style.height = '30px';
                    btn.style.margin = '0px 6px 6px 0px';

                    if (colorset != null) {
                        if (colorset['gradient'] != null) {
                            if (mxClient.IS_IE && (mxClient.IS_QUIRKS || document.documentMode < 10)) {
                                btn.style.filter = 'progid:DXImageTransform.Microsoft.Gradient(' +
                                    'StartColorStr=\'' + colorset['fill'] +
                                    '\', EndColorStr=\'' + colorset['gradient'] + '\', GradientType=0)';
                            } else {
                                btn.style.backgroundImage = 'linear-gradient(' + colorset['fill'] + ' 0px,' +
                                    colorset['gradient'] + ' 100%)';
                            }
                        } else if (colorset['fill'] == mxConstants.NONE) {
                            btn.style.background = 'url(\'' + Dialog.prototype.noColorImage + '\')';
                        } else if (colorset['fill'] == '') {
                            btn.style.backgroundColor = mxUtils.getValue(graph.defaultVertexStyle,
                                mxConstants.STYLE_FILLCOLOR, (uiTheme == 'dark') ? '#2a2a2a' : '#ffffff');
                        } else {
                            btn.style.backgroundColor = colorset['fill'] || mxUtils.getValue(graph.defaultVertexStyle,
                                mxConstants.STYLE_FILLCOLOR, (uiTheme == 'dark') ? '#2a2a2a' : '#ffffff');
                        }

                        if (colorset['stroke'] == mxConstants.NONE) {
                            btn.style.border = '1px solid transparent';
                        } else if (colorset['stroke'] == '') {
                            btn.style.border = '1px solid ' + mxUtils.getValue(graph.defaultVertexStyle,
                                mxConstants.STYLE_STROKECOLOR, (uiTheme != 'dark') ? '#2a2a2a' : '#ffffff');
                        } else {
                            btn.style.border = '1px solid ' + (colorset['stroke'] || mxUtils.getValue(graph.defaultVertexStyle,
                                mxConstants.STYLE_STROKECOLOR, (uiTheme != 'dark') ? '#2a2a2a' : '#ffffff'));
                        }
                    } else {
                        var bg = mxUtils.getValue(graph.defaultVertexStyle, mxConstants.STYLE_FILLCOLOR, '#ffffff');
                        var bd = mxUtils.getValue(graph.defaultVertexStyle, mxConstants.STYLE_STROKECOLOR, '#000000');

                        btn.style.backgroundColor = bg;
                        btn.style.border = '1px solid ' + bd;
                    }

                    picker.appendChild(btn);
                };

                picker.innerHTML = '';

                for (var i = 0; i < colorsets.length; i++) {
                    if (i > 0 && mxUtils.mod(i, 4) == 0) {
                        mxUtils.br(picker);
                    }

                    addButton(colorsets[i]);
                }
            };

            if (this.editorUi.currentScheme == null) {
                this.editorUi.currentScheme = 0;
            }

            var left = document.createElement('div');
            left.style.cssText = 'position:absolute;left:10px;top:8px;bottom:8px;width:20px;margin:4px;opacity:0.5;' +
                'background-repeat:no-repeat;background-position:center center;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAwAAAAQBAMAAADQT4M0AAAAIVBMVEUAAAB2dnZ4eHh3d3d1dXVxcXF2dnZ2dnZ2dnZxcXF2dnYmb3w1AAAACnRSTlMAfCTkhhvb7cQSPH2JPgAAADRJREFUCNdjwACMAmBKaiGYs2oJmLPKAZ3DabU8AMRTXpUKopislqFyVzCAuUZgikkBZjoAcMYLnp53P/UAAAAASUVORK5CYII=);';

            mxEvent.addListener(left, 'click', mxUtils.bind(this, function () {
                this.editorUi.currentScheme = mxUtils.mod(this.editorUi.currentScheme - 1, this.defaultColorSchemes.length);
                updateScheme(this.defaultColorSchemes[this.editorUi.currentScheme]);
            }));

            var right = document.createElement('div');
            right.style.cssText = 'position:absolute;left:202px;top:8px;bottom:8px;width:20px;margin:4px;opacity:0.5;' +
                'background-repeat:no-repeat;background-position:center center;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAwAAAAQBAMAAADQT4M0AAAAIVBMVEUAAAB2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnYBuwCcAAAACnRSTlMAfCTkhhvb7cQSPH2JPgAAADZJREFUCNdjQAOMAmBKaiGY8loF5rKswsZlrVo8AUiFrTICcbIWK8A5DF1gDoMymMPApIAwHwCS0Qx/U7qCBQAAAABJRU5ErkJggg==);';

            if (this.defaultColorSchemes.length > 1) {
                div.appendChild(left);
                div.appendChild(right);
            }

            mxEvent.addListener(right, 'click', mxUtils.bind(this, function () {
                this.editorUi.currentScheme = mxUtils.mod(this.editorUi.currentScheme + 1, this.defaultColorSchemes.length);
                updateScheme(this.defaultColorSchemes[this.editorUi.currentScheme]);
            }));

            // Hover state
            function addHoverState(elt) {
                mxEvent.addListener(elt, 'mouseenter', function () {
                    elt.style.opacity = '1';
                });
                mxEvent.addListener(elt, 'mouseleave', function () {
                    elt.style.opacity = '0.5';
                });
            };

            addHoverState(left);
            addHoverState(right);

            updateScheme(this.defaultColorSchemes[this.editorUi.currentScheme]);

            return div;
        };

        StyleFormatPanel.prototype.addEditOps = function (div) {
            var ss = this.format.getSelectionState();
            var btn = null;

            /*if (this.editorUi.editor.graph.getSelectionCount() == 1) {
                btn = mxUtils.button(mxResources.get('editStyle'), mxUtils.bind(this, function (evt) {
                    this.editorUi.actions.get('editStyle').funct();
                }));

                btn.setAttribute('title', mxResources.get('editStyle') + ' (' + this.editorUi.actions.get('editStyle').shortcut + ')');
                btn.style.width = '202px';
                btn.style.marginBottom = '2px';

                div.appendChild(btn);
            }*/

            var graph = this.editorUi.editor.graph;
            var state = graph.view.getState(graph.getSelectionCell());

            if (graph.getSelectionCount() == 1 && state != null && state.shape != null && state.shape.stencil != null) {
                var btn2 = mxUtils.button(mxResources.get('editShape'), mxUtils.bind(this, function (evt) {
                    this.editorUi.actions.get('editShape').funct();
                }));

                btn2.setAttribute('title', mxResources.get('editShape'));
                btn2.style.marginBottom = '2px';

                if (btn == null) {
                    btn2.style.width = '202px';
                } else {
                    btn.style.width = '100px';
                    btn2.style.width = '100px';
                    btn2.style.marginLeft = '2px';
                }

                div.appendChild(btn2);
            } else if (ss.image) {
                var btn2 = mxUtils.button(mxResources.get('editImage'), mxUtils.bind(this, function (evt) {
                    this.editorUi.actions.get('image').funct();
                }));

                btn2.setAttribute('title', mxResources.get('editImage'));
                btn2.style.marginBottom = '2px';

                if (btn == null) {
                    btn2.style.width = '202px';
                } else {
                    btn.style.width = '100px';
                    btn2.style.width = '100px';
                    btn2.style.marginLeft = '2px';
                }

                div.appendChild(btn2);
            }

            return div;
        };
    }

    /**
     * Changes the default stylename so that it matches the old named style
     * if one was specified in the XML.
     */
    Graph.prototype.defaultThemeName = 'default-style2';

    /**
     * Contains the last XML that was pasted.
     */
    Graph.prototype.lastPasteXml = null;

    /**
     * Contains the number of times the last XML was pasted.
     */
    Graph.prototype.pasteCounter = 0;

    /**
     * Graph Overrides
     */
    Graph.prototype.defaultScrollbars = urlParams['sb'] != '0';

    /**
     * Specifies if the page should be visible for new files. Default is true.
     */
    Graph.prototype.defaultPageVisible = urlParams['pv'] != '0';

    /**
     * Specifies if the page should be visible for new files. Default is true.
     */
    Graph.prototype.shadowId = 'dropShadow';

    /**
     * Properties for the SVG shadow effect.
     */
    Graph.prototype.svgShadowColor = '#3D4574';

    /**
     * Properties for the SVG shadow effect.
     */
    Graph.prototype.svgShadowOpacity = '0.4';

    /**
     * Properties for the SVG shadow effect.
     */
    Graph.prototype.svgShadowBlur = '1.7';

    /**
     * Properties for the SVG shadow effect.
     */
    Graph.prototype.svgShadowSize = '3';

    /**
     * Enables move of bends/segments without selecting.
     */
    Graph.prototype.edgeMode = urlParams['edge'] != 'move';

    /**
     * Adds rack child layout style.
     */
    var graphInit = Graph.prototype.init;

    Graph.prototype.init = function () {
        graphInit.apply(this, arguments);

        //TODO initialize Freehand in the correct location!
        if (window.mxFreehand) {
            this.freehand = new mxFreehand(this);
        }

        // Override insert location for current mouse point
        var mouseEvent = null;

        function setMouseEvent(evt) {
            mouseEvent = evt;

            // Workaround for member not found in IE8-
            try {
                if (mxClient.IS_QUIRKS || document.documentMode == 7 || document.documentMode == 8) {
                    mouseEvent = document.createEventObject(evt);
                    mouseEvent.type = evt.type;
                    mouseEvent.canBubble = evt.canBubble;
                    mouseEvent.cancelable = evt.cancelable;
                    mouseEvent.view = evt.view;
                    mouseEvent.detail = evt.detail;
                    mouseEvent.screenX = evt.screenX;
                    mouseEvent.screenY = evt.screenY;
                    mouseEvent.clientX = evt.clientX;
                    mouseEvent.clientY = evt.clientY;
                    mouseEvent.ctrlKey = evt.ctrlKey;
                    mouseEvent.altKey = evt.altKey;
                    mouseEvent.shiftKey = evt.shiftKey;
                    mouseEvent.metaKey = evt.metaKey;
                    mouseEvent.button = evt.button;
                    mouseEvent.relatedTarget = evt.relatedTarget;
                }
            } catch (e) {
                // ignores possible event cloning errors
            }
        };

        mxEvent.addListener(this.container, 'mouseenter', setMouseEvent);
        mxEvent.addListener(this.container, 'mousemove', setMouseEvent);
        mxEvent.addListener(this.container, 'mouseleave', function (evt) {
            mouseEvent = null;
        });

        // Extends getInsertPoint to use the current mouse location
        this.isMouseInsertPoint = function () {
            return mouseEvent != null;
        };

        var getInsertPoint = this.getInsertPoint;

        this.getInsertPoint = function () {
            if (mouseEvent != null) {
                return this.getPointForEvent(mouseEvent);
            }

            return getInsertPoint.apply(this, arguments);
        };

        var layoutManagerGetLayout = this.layoutManager.getLayout;

        this.layoutManager.getLayout = function (cell) {
            // Workaround for possible invalid style after change and before view validation
            var style = this.graph.getCellStyle(cell);

            // mxRackContainer may be undefined as it is dynamically loaded at render time
            if (style != null) {
                if (style['childLayout'] == 'rack') {
                    var rackLayout = new mxStackLayout(this.graph, false);

                    var unitSize = 20;

                    if (style['rackUnitSize'] != null) {
                        rackLayout.gridSize = parseFloat(style['rackUnitSize']);
                    } else {
                        rackLayout.gridSize = (typeof mxRackContainer !== 'undefined') ? mxRackContainer.unitSize : unitSize;
                    }

                    rackLayout.fill = true;
                    rackLayout.marginLeft = style['marginLeft'] || 0;
                    rackLayout.marginRight = style['marginRight'] || 0;
                    rackLayout.marginTop = style['marginTop'] || 0;
                    rackLayout.marginBottom = style['marginBottom'] || 0;
                    rackLayout.allowGaps = style['allowGaps'] || 0;
                    rackLayout.resizeParent = false;

                    return rackLayout;
                } else if (typeof mxTableLayout !== 'undefined' && style['childLayout'] == 'tableLayout') {
                    var tableLayout = new mxTableLayout(this.graph);
                    tableLayout.rows = style['tableRows'] || 2;
                    tableLayout.columns = style['tableColumns'] || 2;
                    tableLayout.colPercentages = style['colPercentages'];
                    tableLayout.rowPercentages = style['rowPercentages'];
                    tableLayout.equalColumns = mxUtils.getValue(style, 'equalColumns', tableLayout.colPercentages ? '0' : '1') == '1';
                    tableLayout.equalRows = mxUtils.getValue(style, 'equalRows', tableLayout.rowPercentages ? '0' : '1') == '1';
                    tableLayout.resizeParent = mxUtils.getValue(style, 'resizeParent', '1') == '1';
                    tableLayout.border = style['tableBorder'] || tableLayout.border;
                    tableLayout.marginLeft = style['marginLeft'] || 0;
                    tableLayout.marginRight = style['marginRight'] || 0;
                    tableLayout.marginTop = style['marginTop'] || 0;
                    tableLayout.marginBottom = style['marginBottom'] || 0;
                    tableLayout.autoAddCol = mxUtils.getValue(style, 'autoAddCol', '0') == '1';
                    tableLayout.autoAddRow = mxUtils.getValue(style, 'autoAddRow', tableLayout.autoAddCol ? '0' : '1') == '1';
                    tableLayout.colWidths = style['colWidths'] || "100";
                    tableLayout.rowHeights = style['rowHeights'] || "50";

                    return tableLayout;
                }
            }

            return layoutManagerGetLayout.apply(this, arguments);
        }

        this.updateGlobalUrlVariables();
    };

    /**
     * Updates the global variables from the vars URL parameter.
     */
    Graph.prototype.updateGlobalUrlVariables = function () {
        this.globalVars = Editor.globalVars;

        if (urlParams['vars'] != null) {
            try {
                this.globalVars = (this.globalVars != null) ? mxUtils.clone(this.globalVars) : {};
                var vars = JSON.parse(decodeURIComponent(urlParams['vars']));

                if (vars != null) {
                    for (var key in vars) {
                        this.globalVars[key] = vars[key];
                    }
                }
            } catch (e) {
                if (window.console != null) {
                    console.log('Error in vars URL parameter: ' + e);
                }
            }
        }
    };

    /**
     * Returns all global variables used for export. This function never returns null.
     * This can be overridden by plugins to return global variables for export.
     */
    Graph.prototype.getExportVariables = function () {
        return (this.globalVars != null) ? mxUtils.clone(this.globalVars) : {};
    };

    /**
     * Adds support for vars URL parameter.
     */
    var graphGetGlobalVariable = Graph.prototype.getGlobalVariable;

    Graph.prototype.getGlobalVariable = function (name) {
        var val = graphGetGlobalVariable.apply(this, arguments);

        if (val == null && this.globalVars != null) {
            val = this.globalVars[name];
        }

        return val;
    };

    /**
     * Cached default stylesheet for image export in dark mode.
     */
    Graph.prototype.getDefaultStylesheet = function () {
        if (this.defaultStylesheet == null) {
            var node = this.themes['default-style2'];
            var dec = new mxCodec(node.ownerDocument);
            this.defaultStylesheet = dec.decode(node);
        }

        return this.defaultStylesheet;
    };

    /**
     * Overiddes function to use url parameter
     */
    Graph.prototype.isViewer = function () {
        return urlParams['viewer'];
    };

    /**
     * Temporarily overrides stylesheet during image export in dark mode.
     */
    var graphGetSvg = Graph.prototype.getSvg;

    Graph.prototype.getSvg = function () {
        var temp = null;

        if (this.themes != null && this.defaultThemeName == 'darkTheme') {
            temp = this.stylesheet;
            this.stylesheet = this.getDefaultStylesheet()
            this.refresh();
        }

        var result = graphGetSvg.apply(this, arguments);

        if (temp != null) {
            this.stylesheet = temp;
            this.refresh();
        }

        return result;
    };

    /**
     * Adds workaround for math rendering in Chrome.
     *
     * Workaround for https://bugs.webkit.org/show_bug.cgi?id=93358 in WebKit
     *
     * Adding an absolute position DIV before the SVG seems to mitigate the problem.
     */
    var graphViewValidateBackgroundPage = mxGraphView.prototype.validateBackgroundPage;

    mxGraphView.prototype.validateBackgroundPage = function () {
        graphViewValidateBackgroundPage.apply(this, arguments);

        if (mxClient.IS_GC && this.getDrawPane() != null) {
            var g = this.getDrawPane().parentNode;

            if (this.graph.mathEnabled && !mxClient.NO_FO &&
                (this.webKitForceRepaintNode == null ||
                    this.webKitForceRepaintNode.parentNode == null) &&
                this.graph.container.firstChild.nodeName == 'svg') {
                this.webKitForceRepaintNode = document.createElement('div');
                this.webKitForceRepaintNode.style.cssText = 'position:absolute;';
                g.ownerSVGElement.parentNode.insertBefore(this.webKitForceRepaintNode, g.ownerSVGElement);
            } else if (this.webKitForceRepaintNode != null && (!this.graph.mathEnabled ||
                (this.graph.container.firstChild.nodeName != 'svg' &&
                    this.graph.container.firstChild != this.webKitForceRepaintNode))) {
                if (this.webKitForceRepaintNode.parentNode != null) {
                    this.webKitForceRepaintNode.parentNode.removeChild(this.webKitForceRepaintNode);
                }

                this.webKitForceRepaintNode = null;
            }
        }
    };

    /**
     * Sets default style (used in editor.get/setGraphXml below)
     */
    var graphLoadStylesheet = Graph.prototype.loadStylesheet;

    Graph.prototype.loadStylesheet = function () {
        graphLoadStylesheet.apply(this, arguments);
        this.currentStyle = 'default-style2';
    };

    /**
     * Adds support for data:action/json,{"actions":[actions]} where actions is
     * a comma-separated list of JSON objects with the following possible keys:
     *
     * "open": string - opens a standard or custom link (including page links)
     * "toggle"/"show"/"hide"/"highlight": cellset - toggles, shows, hides or
     * highlights the given cells
     * "select": cellset - selects the given cells if the graph is editable
     * "scroll": cellset - scrolls to the first cell in the given celllset
     * If no scroll action is specified, then the first cell of the select
     * or highlight action is scrolled to visible (select has precedence).
     * A cellset is an array of cell IDs or tags or both, eg.
     * {"cells": ["id1", "id2"], "tags": ["tag1", "tag2"]}
     * To specify all cells, use "cells": ["*"], to specify all cells with
     * a tag, use "tags": [] (empty array).
     *
     * An example action is:
     *
     * data:action/json,{"actions":[{"toggle": {"cells": ["3", "4"]}}]}
     *
     * This toggles the visible state of the cells with ID 3 and 4.
     */
    Graph.prototype.handleCustomLink = function (href) {
        if (href.substring(0, 17) == 'data:action/json,') {
            // Some actions are stateless and must be handled before the transaction
            var link = JSON.parse(href.substring(17));

            // When adding new actions that reference cell IDs support for updating
            // those cell IDs must be handled in Graph.updateCustomLinkActions
            if (link.actions != null) {
                // Executes open actions before starting transaction
                for (var i = 0; i < link.actions.length; i++) {
                    var action = link.actions[i];

                    if (action.open != null) {
                        if (this.isCustomLink(action.open)) {
                            if (!this.customLinkClicked(action.open)) {
                                return;
                            }
                        } else {
                            this.openLink(action.open);
                        }
                    }
                }

                // Executes all actions that change cell states
                this.model.beginUpdate();
                try {
                    for (var i = 0; i < link.actions.length; i++) {
                        var action = link.actions[i];

                        if (action.toggle != null) {
                            this.toggleCells(this.getCellsForAction(action.toggle, true));
                        }

                        if (action.show != null) {
                            this.setCellsVisible(this.getCellsForAction(action.show, true), true);
                        }

                        if (action.hide != null) {
                            this.setCellsVisible(this.getCellsForAction(action.hide, true), false);
                        }
                    }
                } finally {
                    this.model.endUpdate();
                }

                // Executes stateless actions on cells
                for (var i = 0; i < link.actions.length; i++) {
                    var action = link.actions[i];
                    var cells = [];

                    if (action.select != null && this.isEnabled()) {
                        cells = this.getCellsForAction(action.select);
                        this.setSelectionCells(cells);
                    }

                    if (action.highlight != null) {
                        cells = this.getCellsForAction(action.highlight);
                        this.highlightCells(cells, action.highlight.color,
                            action.highlight.duration, action.highlight.opacity);
                    }

                    if (action.scroll != null) {
                        cells = this.getCellsForAction(action.scroll);
                    }

                    if (cells.length > 0) {
                        this.scrollCellToVisible(cells[0]);
                    }
                }
            }
        }
    };

    /**
     * Updates cell IDs in custom links on the given cell and its label.
     */
    Graph.prototype.updateCustomLinksForCell = function (mapping, cell) {
        var href = this.getLinkForCell(cell);

        if (href != null && href.substring(0, 17) == 'data:action/json,') {
            this.setLinkForCell(cell, this.updateCustomLink(mapping, href));
        }

        if (this.isHtmlLabel(cell)) {
            var temp = document.createElement('div');
            temp.innerHTML = this.getLabel(cell);
            var links = temp.getElementsByTagName('a');
            var changed = false;

            for (var i = 0; i < links.length; i++) {
                href = links[i].getAttribute('href');

                if (href != null && href.substring(0, 17) == 'data:action/json,') {
                    links[i].setAttribute('href', this.updateCustomLink(mapping, href));
                    changed = true;
                }
            }

            if (changed) {
                this.labelChanged(cell, temp.innerHTML);
            }
        }
    };

    /**
     * Updates cell IDs in the given custom link and returns the updated link.
     */
    Graph.prototype.updateCustomLink = function (mapping, href) {
        if (href.substring(0, 17) == 'data:action/json,') {
            try {
                // Some actions are stateless and must be handled before the transaction
                var link = JSON.parse(href.substring(17));

                if (link.actions != null) {
                    this.updateCustomLinkActions(mapping, link.actions);
                    href = 'data:action/json,' + JSON.stringify(link);
                }
            } catch (e) {
                // Ignore
            }
        }

        return href;
    };

    /**
     * Updates cell IDs in the given custom link actions.
     */
    Graph.prototype.updateCustomLinkActions = function (mapping, actions) {
        for (var i = 0; i < actions.length; i++) {
            var action = actions[i];

            this.updateCustomLinkAction(mapping, action.toggle);
            this.updateCustomLinkAction(mapping, action.show);
            this.updateCustomLinkAction(mapping, action.hide);
            this.updateCustomLinkAction(mapping, action.select);
            this.updateCustomLinkAction(mapping, action.highlight);
            this.updateCustomLinkAction(mapping, action.scroll);
        }
    };

    /**
     * Updates cell IDs in the given custom link action.
     */
    Graph.prototype.updateCustomLinkAction = function (mapping, action) {
        if (action != null && action.cells != null) {
            var result = [];

            for (var i = 0; i < action.cells.length; i++) {
                if (action.cells[i] == '*') {
                    result.push(action.cells[i]);
                } else {
                    var temp = mapping[action.cells[i]];

                    if (temp != null) {
                        if (temp != '') {
                            result.push(temp);
                        }
                    } else {
                        result.push(action.cells[i]);
                    }
                }
            }

            action.cells = result;
        }
    };

    /**
     * Handles each action in the action array of a custom link. This code
     * handles toggle actions for cell IDs.
     */
    Graph.prototype.getCellsForAction = function (action, includeLayers) {
        return this.getCellsById(action.cells).concat(
            this.getCellsForTags(action.tags, null, null, includeLayers));
    };

    /**
     * Returns the cells in the model (or given array) that have all of the
     * given tags in their tags property.
     */
    Graph.prototype.getCellsById = function (ids) {
        var result = [];

        if (ids != null) {
            for (var i = 0; i < ids.length; i++) {
                if (ids[i] == '*') {
                    var parent = this.getDefaultParent();

                    result = result.concat(this.model.filterDescendants(function (cell) {
                        return cell != parent;
                    }, parent));
                } else {
                    var cell = this.model.getCell(ids[i]);

                    if (cell != null) {
                        result.push(cell);
                    }
                }
            }
        }

        return result;
    };

    /**
     * Returns the cells in the model (or given array) that have all of the
     * given tags in their tags property.
     */
    Graph.prototype.getCellsForTags = function (tagList, cells, propertyName, includeLayers) {
        var result = [];

        if (tagList != null) {
            cells = (cells != null) ? cells : this.model.getDescendants(this.model.getRoot());
            propertyName = (propertyName != null) ? propertyName : 'tags';

            var tagCount = 0;
            var lookup = {};

            for (var i = 0; i < tagList.length; i++) {
                if (tagList[i].length > 0) {
                    lookup[tagList[i].toLowerCase()] = true;
                    tagCount++;
                }
            }

            for (var i = 0; i < cells.length; i++) {
                if ((includeLayers && this.model.getParent(cells[i]) == this.model.root) ||
                    this.model.isVertex(cells[i]) || this.model.isEdge(cells[i])) {
                    var tags = (cells[i].value != null && typeof (cells[i].value) == 'object') ?
                        mxUtils.trim(cells[i].value.getAttribute(propertyName) || '') : '';
                    var match = false;

                    if (tags.length > 0) {
                        var tmp = tags.toLowerCase().split(' ');

                        if (tmp.length >= tagList.length) {
                            var matchCount = 0;

                            for (var j = 0; j < tmp.length && (matchCount < tagCount); j++) {
                                if (lookup[tmp[j]] != null) {
                                    matchCount++;
                                }
                            }

                            match = matchCount == tagCount;
                        }
                    } else {
                        match = tagList.length == 0;
                    }

                    if (match) {
                        result.push(cells[i]);
                    }
                }
            }
        }

        return result;
    };

    /**
     * Shows or hides the given cells.
     */
    Graph.prototype.toggleCells = function (cells) {
        this.model.beginUpdate();
        try {
            for (var i = 0; i < cells.length; i++) {
                this.model.setVisible(cells[i], !this.model.isVisible(cells[i]))
            }
        } finally {
            this.model.endUpdate();
        }
    };

    /**
     * Shows or hides the given cells.
     */
    Graph.prototype.setCellsVisible = function (cells, visible) {
        this.model.beginUpdate();
        try {
            for (var i = 0; i < cells.length; i++) {
                this.model.setVisible(cells[i], visible);
            }
        } finally {
            this.model.endUpdate();
        }
    };

    /**
     * Highlights the given cell.
     */
    Graph.prototype.highlightCells = function (cells, color, duration, opacity) {
        for (var i = 0; i < cells.length; i++) {
            this.highlightCell(cells[i], color, duration, opacity);
        }
    };

    /**
     * Highlights the given cell.
     */
    Graph.prototype.highlightCell = function (cell, color, duration, opacity) {
        color = (color != null) ? color : mxConstants.DEFAULT_VALID_COLOR;
        duration = (duration != null) ? duration : 1000;
        var state = this.view.getState(cell);

        if (state != null) {
            var sw = Math.max(5, mxUtils.getValue(state.style, mxConstants.STYLE_STROKEWIDTH, 1) + 4);
            var hl = new mxCellHighlight(this, color, sw, false);

            if (opacity != null) {
                hl.opacity = opacity;
            }

            hl.highlight(state);

            // Fades out the highlight after a duration
            window.setTimeout(function () {
                if (hl.shape != null) {
                    mxUtils.setPrefixedStyle(hl.shape.node.style, 'transition', 'all 1200ms ease-in-out');
                    hl.shape.node.style.opacity = 0;
                }

                // Destroys the highlight after the fade
                window.setTimeout(function () {
                    hl.destroy();
                }, 1200);
            }, duration);
        }
    };

    /**
     * Adds a shadow filter to the given svg root.
     */
    Graph.prototype.addSvgShadow = function (svgRoot, group, createOnly) {
        createOnly = (createOnly != null) ? createOnly : false;

        var svgDoc = svgRoot.ownerDocument;

        var filter = (svgDoc.createElementNS != null) ?
            svgDoc.createElementNS(mxConstants.NS_SVG, 'filter') : svgDoc.createElement('filter');
        filter.setAttribute('id', this.shadowId);

        var blur = (svgDoc.createElementNS != null) ?
            svgDoc.createElementNS(mxConstants.NS_SVG, 'feGaussianBlur') : svgDoc.createElement('feGaussianBlur');
        blur.setAttribute('in', 'SourceAlpha');
        blur.setAttribute('stdDeviation', this.svgShadowBlur);
        blur.setAttribute('result', 'blur');
        filter.appendChild(blur);

        var offset = (svgDoc.createElementNS != null) ?
            svgDoc.createElementNS(mxConstants.NS_SVG, 'feOffset') : svgDoc.createElement('feOffset');
        offset.setAttribute('in', 'blur');
        offset.setAttribute('dx', this.svgShadowSize);
        offset.setAttribute('dy', this.svgShadowSize);
        offset.setAttribute('result', 'offsetBlur');
        filter.appendChild(offset);

        var flood = (svgDoc.createElementNS != null) ?
            svgDoc.createElementNS(mxConstants.NS_SVG, 'feFlood') : svgDoc.createElement('feFlood');
        flood.setAttribute('flood-color', this.svgShadowColor);
        flood.setAttribute('flood-opacity', this.svgShadowOpacity);
        flood.setAttribute('result', 'offsetColor');
        filter.appendChild(flood);

        var composite = (svgDoc.createElementNS != null) ?
            svgDoc.createElementNS(mxConstants.NS_SVG, 'feComposite') : svgDoc.createElement('feComposite');
        composite.setAttribute('in', 'offsetColor');
        composite.setAttribute('in2', 'offsetBlur');
        composite.setAttribute('operator', 'in');
        composite.setAttribute('result', 'offsetBlur');
        filter.appendChild(composite);

        var feBlend = (svgDoc.createElementNS != null) ?
            svgDoc.createElementNS(mxConstants.NS_SVG, 'feBlend') : svgDoc.createElement('feBlend');
        feBlend.setAttribute('in', 'SourceGraphic');
        feBlend.setAttribute('in2', 'offsetBlur');
        filter.appendChild(feBlend);

        // Creates defs element if not available
        var defs = svgRoot.getElementsByTagName('defs');
        var defsElt = null;

        if (defs.length == 0) {
            defsElt = (svgDoc.createElementNS != null) ?
                svgDoc.createElementNS(mxConstants.NS_SVG, 'defs') : svgDoc.createElement('defs');

            if (svgRoot.firstChild != null) {
                svgRoot.insertBefore(defsElt, svgRoot.firstChild);
            } else {
                svgRoot.appendChild(defsElt);
            }
        } else {
            defsElt = defs[0];
        }

        defsElt.appendChild(filter);

        if (!createOnly) {
            group = (group != null) ? group : svgRoot.getElementsByTagName('g')[0];

            if (group != null) {
                group.setAttribute('filter', 'url(#' + this.shadowId + ')');

                if (!isNaN(parseInt(svgRoot.getAttribute('width')))) {
                    svgRoot.setAttribute('width', parseInt(svgRoot.getAttribute('width')) + 6);
                    svgRoot.setAttribute('height', parseInt(svgRoot.getAttribute('height')) + 6);

                    // Updates viewbox if one exists
                    var vb = svgRoot.getAttribute('viewBox');

                    if (vb != null && vb.length > 0) {
                        var tokens = vb.split(' ');

                        if (tokens.length > 3) {
                            w = parseFloat(tokens[2]) + 6;
                            h = parseFloat(tokens[3]) + 6;

                            svgRoot.setAttribute('viewBox', tokens[0] + ' ' + tokens[1] + ' ' + w + ' ' + h);
                        }
                    }
                }
            }
        }

        return filter;
    };

    /**
     * Loads the stylesheet for this graph.
     */
    Graph.prototype.setShadowVisible = function (value, fireEvent) {
        if (mxClient.IS_SVG) {
            fireEvent = (fireEvent != null) ? fireEvent : true;
            this.shadowVisible = value;

            if (this.shadowVisible) {
                this.view.getDrawPane().setAttribute('filter', 'url(#' + this.shadowId + ')');
            } else {
                this.view.getDrawPane().removeAttribute('filter');
            }

            if (fireEvent) {
                this.fireEvent(new mxEventObject('shadowVisibleChanged'));
            }
        }
    };

    /**
     * Selects first unlocked layer if one exists
     */
    Graph.prototype.selectUnlockedLayer = function () {
        if (this.defaultParent == null) {
            var childCount = this.model.getChildCount(this.model.root);
            var cell = null;
            var index = 0;

            do {
                cell = this.model.getChildAt(this.model.root, index);
            } while (index++ < childCount && mxUtils.getValue(this.getCellStyle(cell), 'locked', '0') == '1')

            if (cell != null) {
                this.setDefaultParent(cell);
            }
        }
    };

    /**
     * Specifies special libraries that are loaded via dynamic JS. Add cases
     * where the filename cannot be worked out from the package name. The
     * standard scheme for this mapping is stencils/packagename.xml. If there
     * are multiple XML files, any JS files or any anomalies in the filename or
     * directory that contains the file, then an entry must be added here and
     * in EmbedServlet2 for the loading of the shapes to work.
     */
    // Required to avoid 404 for mockup.xml since naming of mxgraph.mockup.anchor does not contain
    // buttons even though it is defined in the mxMockupButtons.js file. This could only be fixed
    // with aliases for existing shapes or aliases for basenames, but this is essentially the same.

    mxStencilRegistry.libraries['arrows2'] = [SHAPES_PATH + '/mxArrows.js'];
    mxStencilRegistry.libraries['basic'] = [SHAPES_PATH + '/mxBasic.js', STENCIL_PATH + '/basic.xml'];
    mxStencilRegistry.libraries['ios7icons'] = [STENCIL_PATH + '/ios7/icons.xml'];
    mxStencilRegistry.libraries['ios7ui'] = [SHAPES_PATH + '/ios7/mxIOS7Ui.js', STENCIL_PATH + '/ios7/misc.xml'];
    mxStencilRegistry.libraries['android'] = [SHAPES_PATH + '/mxAndroid.js', STENCIL_PATH + '/android/android.xml'];
    mxStencilRegistry.libraries['electrical/miscellaneous'] = [SHAPES_PATH + '/mxElectrical.js', STENCIL_PATH + '/electrical/miscellaneous.xml'];
    mxStencilRegistry.libraries['electrical/transmission'] = [SHAPES_PATH + '/mxElectrical.js', STENCIL_PATH + '/electrical/transmission.xml'];
    mxStencilRegistry.libraries['electrical/logic_gates'] = [SHAPES_PATH + '/mxElectrical.js', STENCIL_PATH + '/electrical/logic_gates.xml'];
    mxStencilRegistry.libraries['electrical/abstract'] = [SHAPES_PATH + '/mxElectrical.js', STENCIL_PATH + '/electrical/abstract.xml'];
    mxStencilRegistry.libraries['bootstrap'] = [SHAPES_PATH + '/mxBootstrap.js', STENCIL_PATH + '/bootstrap.xml'];
    mxStencilRegistry.libraries['networks'] = [SHAPES_PATH + '/mxNetworks.js', STENCIL_PATH + '/networks.xml'];
    mxStencilRegistry.libraries['pid2inst'] = [SHAPES_PATH + '/pid2/mxPidInstruments.js'];
    mxStencilRegistry.libraries['pid2misc'] = [SHAPES_PATH + '/pid2/mxPidMisc.js', STENCIL_PATH + '/pid/misc.xml'];
    mxStencilRegistry.libraries['pid2valves'] = [SHAPES_PATH + '/pid2/mxPidValves.js'];
    mxStencilRegistry.libraries['pidFlowSensors'] = [STENCIL_PATH + '/pid/flow_sensors.xml'];
    mxStencilRegistry.libraries['gmdl'] = [SHAPES_PATH + '/mxGmdl.js', STENCIL_PATH + '/gmdl.xml'];

    // Triggers dynamic loading for markers
    mxMarker.getPackageForType = function (type) {
        var name = null;

        if (type != null && type.length > 0) {
            if (type.substring(0, 2) == 'ER') {
                name = 'mxgraph.er';
            } else if (type.substring(0, 5) == 'sysML') {
                name = 'mxgraph.sysml';
            }
        }

        return name;
    };

    var mxMarkerCreateMarker = mxMarker.createMarker;

    mxMarker.createMarker = function (canvas, shape, type, pe, unitX, unitY, size, source, sw, filled) {
        if (type != null) {
            var f = mxMarker.markers[type];

            if (f == null) {
                var name = this.getPackageForType(type);

                if (name != null) {
                    mxStencilRegistry.getStencil(name);
                }
            }
        }

        return mxMarkerCreateMarker.apply(this, arguments);
    };

    /**
     * Constructs a new print dialog.
     */
    PrintDialog.prototype.create = function (editorUi, titleText) {
        var graph = editorUi.editor.graph;
        var div = document.createElement('div');

        var title = document.createElement('h3');
        title.style.width = '100%';
        title.style.textAlign = 'center';
        title.style.marginTop = '0px';
        mxUtils.write(title, titleText || mxResources.get('print'));
        div.appendChild(title);

        var pageCount = 1;
        var currentPage = 1;

        // Pages
        var pagesSection = document.createElement('div');
        pagesSection.style.cssText = 'border-bottom:1px solid lightGray;padding-bottom:12px;margin-bottom:12px;';

        var allPagesRadio = document.createElement('input');
        allPagesRadio.style.cssText = 'margin-right:8px;margin-bottom:8px;';
        allPagesRadio.setAttribute('value', 'all');
        allPagesRadio.setAttribute('type', 'radio');
        allPagesRadio.setAttribute('name', 'pages-printdialog');

        pagesSection.appendChild(allPagesRadio);

        var span = document.createElement('span');
        mxUtils.write(span, mxResources.get('printAllPages'));
        pagesSection.appendChild(span);

        mxUtils.br(pagesSection);

        // Pages ... to ...
        var pagesRadio = allPagesRadio.cloneNode(true);
        allPagesRadio.setAttribute('checked', 'checked');
        pagesRadio.setAttribute('value', 'range');
        pagesSection.appendChild(pagesRadio);

        var span = document.createElement('span');
        mxUtils.write(span, mxResources.get('pages') + ':');
        pagesSection.appendChild(span);

        var pagesFromInput = document.createElement('input');
        pagesFromInput.style.cssText = 'margin:0 8px 0 8px;'
        pagesFromInput.setAttribute('value', '1');
        pagesFromInput.setAttribute('type', 'number');
        pagesFromInput.setAttribute('min', '1');
        pagesFromInput.style.width = '50px';
        pagesSection.appendChild(pagesFromInput);

        var span = document.createElement('span');
        mxUtils.write(span, mxResources.get('to'));
        pagesSection.appendChild(span);

        var pagesToInput = pagesFromInput.cloneNode(true);
        pagesSection.appendChild(pagesToInput);

        mxEvent.addListener(pagesFromInput, 'focus', function () {
            pagesRadio.checked = true;
        });

        mxEvent.addListener(pagesToInput, 'focus', function () {
            pagesRadio.checked = true;
        });

        function validatePageRange() {
            pagesToInput.value = Math.max(1, Math.min(pageCount, Math.max(parseInt(pagesToInput.value), parseInt(pagesFromInput.value))));
            pagesFromInput.value = Math.max(1, Math.min(pageCount, Math.min(parseInt(pagesToInput.value), parseInt(pagesFromInput.value))));
        };

        mxEvent.addListener(pagesFromInput, 'change', validatePageRange);
        mxEvent.addListener(pagesToInput, 'change', validatePageRange);

        if (editorUi.pages != null) {
            pageCount = editorUi.pages.length;

            if (editorUi.currentPage != null) {
                for (var i = 0; i < editorUi.pages.length; i++) {
                    if (editorUi.currentPage == editorUi.pages[i]) {
                        currentPage = i + 1;
                        pagesFromInput.value = currentPage;
                        pagesToInput.value = currentPage;
                        break;
                    }
                }
            }
        }

        pagesFromInput.setAttribute('max', pageCount);
        pagesToInput.setAttribute('max', pageCount);

        if (pageCount > 1) {
            div.appendChild(pagesSection);
        }

        // Adjust to ...
        var adjustSection = document.createElement('div');
        adjustSection.style.marginBottom = '10px';

        var adjustRadio = document.createElement('input');
        adjustRadio.style.marginRight = '8px';

        adjustRadio.setAttribute('value', 'adjust');
        adjustRadio.setAttribute('type', 'radio');
        adjustRadio.setAttribute('name', 'printZoom');
        adjustSection.appendChild(adjustRadio);

        var span = document.createElement('span');
        mxUtils.write(span, mxResources.get('adjustTo'));
        adjustSection.appendChild(span);

        var zoomInput = document.createElement('input');
        zoomInput.style.cssText = 'margin:0 8px 0 8px;';
        zoomInput.setAttribute('value', '100 %');
        zoomInput.style.width = '50px';
        adjustSection.appendChild(zoomInput);

        mxEvent.addListener(zoomInput, 'focus', function () {
            adjustRadio.checked = true;
        });

        div.appendChild(adjustSection);

        // Fit to ...
        var fitSection = pagesSection.cloneNode(false);

        var fitRadio = adjustRadio.cloneNode(true);
        fitRadio.setAttribute('value', 'fit');
        adjustRadio.setAttribute('checked', 'checked');

        var spanFitRadio = document.createElement('div');
        spanFitRadio.style.cssText = 'display:inline-block;height:100%;vertical-align:top;padding-top:2px;';
        spanFitRadio.appendChild(fitRadio);
        fitSection.appendChild(spanFitRadio);

        var table = document.createElement('table');
        table.style.display = 'inline-block';
        var tbody = document.createElement('tbody');

        var row1 = document.createElement('tr');
        var row2 = row1.cloneNode(true);

        var td1 = document.createElement('td');
        var td2 = td1.cloneNode(true);
        var td3 = td1.cloneNode(true);

        var td4 = td1.cloneNode(true);
        var td5 = td1.cloneNode(true);
        var td6 = td1.cloneNode(true);

        td1.style.textAlign = 'right';
        td4.style.textAlign = 'right';

        mxUtils.write(td1, mxResources.get('fitTo'));

        var sheetsAcrossInput = document.createElement('input');
        sheetsAcrossInput.style.cssText = 'margin:0 8px 0 8px;';
        sheetsAcrossInput.setAttribute('value', '1');
        sheetsAcrossInput.setAttribute('min', '1');
        sheetsAcrossInput.setAttribute('type', 'number');
        sheetsAcrossInput.style.width = '40px';
        td2.appendChild(sheetsAcrossInput);

        var span = document.createElement('span');
        mxUtils.write(span, mxResources.get('fitToSheetsAcross'));
        td3.appendChild(span);

        mxUtils.write(td4, mxResources.get('fitToBy'));

        var sheetsDownInput = sheetsAcrossInput.cloneNode(true);
        td5.appendChild(sheetsDownInput);

        mxEvent.addListener(sheetsAcrossInput, 'focus', function () {
            fitRadio.checked = true;
        });

        mxEvent.addListener(sheetsDownInput, 'focus', function () {
            fitRadio.checked = true;
        });

        var span = document.createElement('span');
        mxUtils.write(span, mxResources.get('fitToSheetsDown'));
        td6.appendChild(span);

        row1.appendChild(td1);
        row1.appendChild(td2);
        row1.appendChild(td3);

        row2.appendChild(td4);
        row2.appendChild(td5);
        row2.appendChild(td6);

        tbody.appendChild(row1);
        tbody.appendChild(row2);
        table.appendChild(tbody);
        fitSection.appendChild(table);

        div.appendChild(fitSection);

        // Page scale ...
        var pageScaleSection = document.createElement('div');

        var span = document.createElement('div');
        span.style.fontWeight = 'bold';
        span.style.marginBottom = '12px';
        mxUtils.write(span, mxResources.get('paperSize'));
        pageScaleSection.appendChild(span);

        var span = document.createElement('div');
        span.style.marginBottom = '12px';

        var accessor = PageSetupDialog.addPageFormatPanel(span, 'printdialog',
            editorUi.editor.graph.pageFormat || mxConstants.PAGE_FORMAT_A4_PORTRAIT);
        pageScaleSection.appendChild(span);

        var span = document.createElement('span');
        mxUtils.write(span, mxResources.get('pageScale'));
        pageScaleSection.appendChild(span);

        var pageScaleInput = document.createElement('input');
        pageScaleInput.style.cssText = 'margin:0 8px 0 8px;';
        pageScaleInput.setAttribute('value', '100 %');
        pageScaleInput.style.width = '60px';
        pageScaleSection.appendChild(pageScaleInput);

        div.appendChild(pageScaleSection);

        // Buttons
        var buttons = document.createElement('div');
        buttons.style.cssText = 'text-align:right;margin:48px 0 0 0;';

        // Overall scale for print-out to account for print borders in dialogs etc
        function preview(print) {
            var printScale = parseInt(pageScaleInput.value) / 100;

            if (isNaN(printScale)) {
                printScale = 1;
                pageScaleInput.value = '100 %';
            }

            // Workaround to match available paper size in actual print output
            printScale *= 0.75;

            function printGraph(thisGraph, pv, forcePageBreaks) {
                // Negative coordinates are cropped or shifted if page visible
                var gb = thisGraph.getGraphBounds();
                var border = 0;
                var x0 = 0;
                var y0 = 0;

                var pf = accessor.get();
                var scale = 1 / thisGraph.pageScale;
                var autoOrigin = fitRadio.checked;

                if (autoOrigin) {
                    var h = parseInt(sheetsAcrossInput.value);
                    var v = parseInt(sheetsDownInput.value);

                    scale = Math.min((pf.height * v) / (gb.height / thisGraph.view.scale),
                        (pf.width * h) / (gb.width / thisGraph.view.scale));
                } else {
                    scale = parseInt(zoomInput.value) / (100 * thisGraph.pageScale);

                    if (isNaN(scale)) {
                        printScale = 1 / thisGraph.pageScale;
                        zoomInput.value = '100 %';
                    }
                }

                // Applies print scale
                pf = mxRectangle.fromRectangle(pf);
                pf.width = Math.ceil(pf.width * printScale);
                pf.height = Math.ceil(pf.height * printScale);
                scale *= printScale;

                // Starts at first visible page
                if (!autoOrigin && thisGraph.pageVisible) {
                    var layout = thisGraph.getPageLayout();
                    x0 -= layout.x * pf.width;
                    y0 -= layout.y * pf.height;
                } else {
                    autoOrigin = true;
                }

                if (pv == null) {
                    pv = PrintDialog.createPrintPreview(thisGraph, scale, pf, border, x0, y0, autoOrigin);
                    pv.pageSelector = false;
                    pv.mathEnabled = false;

                    var file = editorUi.getCurrentFile();

                    if (file != null) {
                        pv.title = file.getTitle();
                    }

                    var writeHead = pv.writeHead;

                    // Overridden to add custom fonts
                    pv.writeHead = function (doc) {
                        writeHead.apply(this, arguments);

                        if (editorUi.editor.fontCss != null) {
                            doc.writeln('<style type="text/css">');
                            doc.writeln(editorUi.editor.fontCss);
                            doc.writeln('</style>');
                        }
                    };

                    // Switches stylesheet for print output in dark mode
                    var temp = null;

                    if (graph.themes != null && graph.defaultThemeName == 'darkTheme') {
                        temp = graph.stylesheet;
                        graph.stylesheet = graph.getDefaultStylesheet()
                        graph.refresh();
                    }

                    // Generates the print output
                    pv.open(null, null, forcePageBreaks, true);

                    // Restores the stylesheet
                    if (temp != null) {
                        graph.stylesheet = temp;
                        graph.refresh();
                    }
                } else {
                    var bg = thisGraph.background;

                    if (bg == null || bg == '' || bg == mxConstants.NONE) {
                        bg = '#ffffff';
                    }

                    pv.backgroundColor = bg;
                    pv.autoOrigin = autoOrigin;
                    pv.appendGraph(thisGraph, scale, x0, y0, forcePageBreaks, true);
                }

                return pv;
            };

            var pagesFrom = pagesFromInput.value;
            var pagesTo = pagesToInput.value;
            var ignorePages = !allPagesRadio.checked;
            var pv = null;

            if (ignorePages) {
                ignorePages = pagesFrom == currentPage && pagesTo == currentPage;
            }

            if (!ignorePages && editorUi.pages != null && editorUi.pages.length) {
                var i0 = 0;
                var imax = editorUi.pages.length - 1;

                if (!allPagesRadio.checked) {
                    i0 = parseInt(pagesFrom) - 1;
                    imax = parseInt(pagesTo) - 1;
                }

                for (var i = i0; i <= imax; i++) {
                    var page = editorUi.pages[i];
                    var tempGraph = (page == editorUi.currentPage) ? graph : null;

                    if (tempGraph == null) {
                        tempGraph = editorUi.createTemporaryGraph(graph.getStylesheet());

                        // Restores graph settings that are relevant for printing
                        var pageVisible = true;
                        var mathEnabled = false;
                        var bg = null;
                        var bgImage = null;

                        if (page.viewState == null) {
                            // Workaround to extract view state from XML node
                            // This changes the state of the page and parses
                            // the XML for the graph model even if not needed.
                            if (page.root == null) {
                                editorUi.updatePageRoot(page);
                            }
                        }

                        if (page.viewState != null) {
                            pageVisible = page.viewState.pageVisible;
                            mathEnabled = page.viewState.mathEnabled;
                            bg = page.viewState.background;
                            bgImage = page.viewState.backgroundImage;
                        }

                        tempGraph.background = bg;
                        tempGraph.backgroundImage = (bgImage != null) ? new mxImage(bgImage.src, bgImage.width, bgImage.height) : null;
                        tempGraph.pageVisible = pageVisible;
                        tempGraph.mathEnabled = mathEnabled;

                        // Redirects placeholders to current page
                        var graphGetGlobalVariable = tempGraph.getGlobalVariable;

                        tempGraph.getGlobalVariable = function (name) {
                            if (name == 'page') {
                                return page.getName();
                            } else if (name == 'pagenumber') {
                                return i + 1;
                            } else if (name == 'pagecount') {
                                return (editorUi.pages != null) ? editorUi.pages.length : 1;
                            }

                            return graphGetGlobalVariable.apply(this, arguments);
                        };

                        document.body.appendChild(tempGraph.container);
                        editorUi.updatePageRoot(page);
                        tempGraph.model.setRoot(page.root);
                    }

                    pv = printGraph(tempGraph, pv, i != imax);

                    if (tempGraph != graph) {
                        tempGraph.container.parentNode.removeChild(tempGraph.container);
                    }
                }
            } else {
                pv = printGraph(graph);
            }

            if (pv == null) {
                editorUi.handleError({message: mxResources.get('errorUpdatingPreview')});
            } else {

                pv.closeDocument();

                if (!pv.mathEnabled && print) {
                    PrintDialog.printPreview(pv);
                }
            }
        };

        var cancelBtn = mxUtils.button(mxResources.get('cancel'), function () {
            editorUi.hideDialog();
        });
        cancelBtn.className = 'geBtn';

        if (editorUi.editor.cancelFirst) {
            buttons.appendChild(cancelBtn);
        }

        if (!editorUi.isOffline()) {
            var helpBtn = mxUtils.button(mxResources.get('help'), function () {
                graph.openLink('https://desk.draw.io/support/solutions/articles/16000048947');
            });

            helpBtn.className = 'geBtn';
            buttons.appendChild(helpBtn);
        }

        if (!editorUi.editor.cancelFirst) {
            buttons.appendChild(cancelBtn);
        }

        div.appendChild(buttons);

        this.container = div;
    };

    // Execute fit page on page setup changes
    var changePageSetupExecute = ChangePageSetup.prototype.execute;

    ChangePageSetup.prototype.execute = function () {
        if (this.page == null) {
            this.page = this.ui.currentPage;
        }

        // Workaround for redo existing change with different current page
        if (this.page != this.ui.currentPage) {
            if (this.page.viewState != null) {
                if (!this.ignoreColor) {
                    this.page.viewState.background = this.color;
                }

                if (!this.ignoreImage) {
                    this.page.viewState.backgroundImage = this.image;
                }

                if (this.format != null) {
                    this.page.viewState.pageFormat = this.format;
                }

                if (this.mathEnabled != null) {
                    this.page.viewState.mathEnabled = this.mathEnabled;
                }

                if (this.shadowVisible != null) {
                    this.page.viewState.shadowVisible = this.shadowVisible;
                }
            }
        } else {
            changePageSetupExecute.apply(this, arguments);

            if (this.mathEnabled != null && this.mathEnabled != this.ui.isMathEnabled()) {
                this.ui.setMathEnabled(this.mathEnabled);
                this.mathEnabled = !this.mathEnabled;
            }

            if (this.shadowVisible != null && this.shadowVisible != this.ui.editor.graph.shadowVisible) {
                this.ui.editor.graph.setShadowVisible(this.shadowVisible);
                this.shadowVisible = !this.shadowVisible;
            }
        }
    };

    /**
     * Capability check for canvas export
     */
    Editor.prototype.useCanvasForExport = false;

    try {
        var canvas = document.createElement('canvas');
        var img = new Image();

        // LATER: Capability check should not be async
        img.onload = function () {
            try {
                var ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0);

                // Works in Chrome, Firefox, Edge, Safari and Opera
                var result = canvas.toDataURL('image/png');
                Editor.prototype.useCanvasForExport = result != null && result.length > 6;
            } catch (e) {
                // ignore
            }
        };

        // Checks if SVG with foreignObject can be exported
        var svg = '<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="1px" height="1px" version="1.1"><foreignObject pointer-events="all" width="1" height="1"><div xmlns="http://www.w3.org/1999/xhtml"></div></foreignObject></svg>';
        img.src = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svg)));
    } catch (e) {
        // ignore
    }

})();

// Extends codec for ChangePageSetup
(function () {
    var codec = new mxObjectCodec(new ChangePageSetup(), ['ui', 'previousColor', 'previousImage', 'previousFormat']);

    codec.beforeDecode = function (dec, node, obj) {
        obj.ui = dec.ui;

        return node;
    };

    codec.afterDecode = function (dec, node, obj) {
        obj.previousColor = obj.color;
        obj.previousImage = obj.image;
        obj.previousFormat = obj.format;

        if (obj.foldingEnabled != null) {
            obj.foldingEnabled = !obj.foldingEnabled;
        }

        if (obj.mathEnabled != null) {
            obj.mathEnabled = !obj.mathEnabled;
        }

        if (obj.shadowVisible != null) {
            obj.shadowVisible = !obj.shadowVisible;
        }

        return obj;
    };

    mxCodecRegistry.register(codec);
})();

/**
 * Copyright (c) 2006-2017, JGraph Ltd
 * Copyright (c) 2006-2017, Gaudenz Alder
 */
(function () {
    /**
     * Version
     */
    EditorUi.VERSION = '@DRAWIO-VERSION@';

    /**
     * Overrides compact UI setting.
     */
    EditorUi.compactUi = uiTheme != 'atlas';

    /**
     * Switch to disable logging for mode and search terms.
     */
    EditorUi.enableLogging = urlParams['stealth'] != '1' &&
        /.*\.draw\.io$/.test(window.location.hostname) &&
        window.location.hostname != 'support.draw.io';

    /**
     * Protocol and hostname to use for embedded files. Default is https://www.draw.io
     */
    EditorUi.drawHost = 'https://www.draw.io';

    /**
     * Switch to disable logging for mode and search terms.
     */
    EditorUi.lastErrorMessage = null;

    /**
     * Switch to disable logging for mode and search terms.
     */
    EditorUi.ignoredAnonymizedChars = '\n\t`~!@#$%^&*()_+{}|:"<>?-=[]\;\'.\/,\n\t';

    /**
     * Specifies the URL for the templates index file.
     */
    EditorUi.templateFile = TEMPLATE_PATH + '/index.xml';

    /**
     * Specifies the URL for the diffsync cache.
     */
    EditorUi.cacheUrl = '';

    /**
     * Switch to enable PlantUML in the insert from text dialog.
     * NOTE: This must also be enabled on the server-side.
     */
    EditorUi.enablePlantUml = EditorUi.enableLogging;

    /**
     * https://github.com/electron/electron/issues/2288
     */
    EditorUi.isElectronApp = window != null && window.process != null &&
        window.process.versions != null && window.process.versions['electron'] != null;

    /**
     * Updates action states depending on the selection.
     */
    EditorUi.logError = function (message, url, linenumber, colno, err) {
        if (urlParams['dev'] == '1') {
            EditorUi.debug('logError', message, url, linenumber, colno, err);
        } else if (EditorUi.enableLogging) {
            try {
                if (message == EditorUi.lastErrorMessage || (message != null && url != null &&
                    ((message.indexOf('Script error') != -1) || (message.indexOf('extension') != -1)))) {
                    // TODO log external domain script failure "Script error." is
                    // reported when the error occurs in a script that is hosted
                    // on a domain other than the domain of the current page
                }
                // DocumentClosedError seems to be an FF bug an can be ignored for now
                else if (message != null && message.indexOf('DocumentClosedError') < 0) {
                    EditorUi.lastErrorMessage = message;
                    var severity = (message.indexOf('NetworkError') >= 0 || message.indexOf('SecurityError') >= 0 ||
                        message.indexOf('NS_ERROR_FAILURE') >= 0 || message.indexOf('out of memory') >= 0) ?
                        'CONFIG' : 'SEVERE';
                    var logDomain = window.DRAWIO_LOG_URL != null ? window.DRAWIO_LOG_URL : '';
                    err = (err != null) ? err : new Error(message);

                    var img = new Image();
                    img.src = logDomain + '/log?severity=' + severity + '&v=' + encodeURIComponent(EditorUi.VERSION) +
                        '&msg=clientError:' + encodeURIComponent(message) + ':url:' + encodeURIComponent(window.location.href) +
                        ':lnum:' + encodeURIComponent(linenumber) + ((colno != null) ? ':colno:' + encodeURIComponent(colno) : '') +
                        ((err != null && err.stack != null) ? '&stack=' + encodeURIComponent(err.stack) : '');
                }
            } catch (err) {
                // do nothing
            }
        }
    };

    /**
     * Updates action states depending on the selection.
     */
    EditorUi.logEvent = function (data) {
        if (urlParams['dev'] == '1') {
            EditorUi.debug('logEvent', data);
        } else if (EditorUi.enableLogging) {
            try {
                var logDomain = window.DRAWIO_LOG_URL != null ? window.DRAWIO_LOG_URL : '';
                var img = new Image();
                img.src = logDomain + '/images/1x1.png?' +
                    'v=' + encodeURIComponent(EditorUi.VERSION) +
                    ((data != null) ? '&data=' + encodeURIComponent(JSON.stringify(data)) : '');
            } catch (e) {
                // ignore
            }
        }
    };

    /**
     * Sending error reports.
     */
    EditorUi.sendReport = function (data, maxLength) {
        if (urlParams['dev'] == '1') {
            EditorUi.debug('sendReport', data);
        } else if (EditorUi.enableLogging) {
            try {
                maxLength = (maxLength != null) ? maxLength : 50000;

                if (data.length > maxLength) {
                    data = data.substring(0, maxLength) + '\n...[SHORTENED]'
                }

                mxUtils.post('/email', 'version=' + encodeURIComponent(EditorUi.VERSION) +
                    '&url=' + encodeURIComponent(window.location.href) +
                    '&data=' + encodeURIComponent(data));
            } catch (e) {
                // ignore
            }
        }
    };

    /**
     * Adds the listener for automatically saving the diagram for local changes.
     */
    EditorUi.debug = function () {
        try {
            if (window.console != null && urlParams['dev'] == '1') {
                var args = [new Date().toISOString()];

                for (var i = 0; i < arguments.length; i++) {
                    args.push(arguments[i]);
                }

                console.log.apply(console, args);
            }
        } catch (e) {
            // ignore
        }
    };

    /**
     * Static method for pasing PNG files.
     */
    EditorUi.parsePng = function (f, fn, error) {
        var pos = 0;

        function fread(d, count) {
            var start = pos;
            pos += count;

            return d.substring(start, pos);
        };

        // Reads unsigned long 32 bit big endian
        function _freadint(d) {
            var bytes = fread(d, 4);

            return bytes.charCodeAt(3) + (bytes.charCodeAt(2) << 8) +
                (bytes.charCodeAt(1) << 16) + (bytes.charCodeAt(0) << 24);
        };

        // Checks signature
        if (fread(f, 8) != String.fromCharCode(137) + 'PNG' + String.fromCharCode(13, 10, 26, 10)) {
            if (error != null) {
                error();
            }

            return;
        }

        // Reads header chunk
        fread(f, 4);

        if (fread(f, 4) != 'IHDR') {
            if (error != null) {
                error();
            }

            return;
        }

        fread(f, 17);

        do {
            var n = _freadint(f);
            var type = fread(f, 4);

            if (fn != null) {
                if (fn(pos - 8, type, n)) {
                    break;
                }
            }

            value = fread(f, n);
            fread(f, 4);

            if (type == 'IEND') {
                break;
            }
        }
        while (n);
    };

    /**
     * Removes any values, styles and geometries from the given XML node.
     */
    EditorUi.removeChildNodes = function (node) {
        while (node.firstChild != null) {
            node.removeChild(node.firstChild);
        }
    };

    /**
     * Contains the default XML for an empty diagram.
     */
    EditorUi.prototype.emptyDiagramXml = '<mxGraphModel><root><mxCell id="0"/><mxCell id="1" parent="0"/></root></mxGraphModel>';

    /**
     *
     */
    EditorUi.prototype.emptyLibraryXml = '<mxlibrary>[]</mxlibrary>';

    /**
     * Sets the delay for autosave in milliseconds. Default is 2000.
     */
    EditorUi.prototype.mode = null;

    /**
     * General timeout is 25 seconds.
     * LATER: Move to Editor
     */
    EditorUi.prototype.timeout = Editor.prototype.timeout;

    /**
     * Allows for two buttons in the sidebar footer.
     */
    EditorUi.prototype.sidebarFooterHeight = 38;

    /**
     * Specifies the default custom shape style.
     */
    EditorUi.prototype.defaultCustomShapeStyle = 'shape=stencil(tZRtTsQgEEBPw1+DJR7AoN6DbWftpAgE0Ortd/jYRGq72R+YNE2YgTePloEJGWblgA18ZuKFDcMj5/Sm8boZq+BgjCX4pTyqk6ZlKROitwusOMXKQDODx5iy4pXxZ5qTHiFHawxB0JrQZH7lCabQ0Fr+XWC1/E8zcsT/gAi+Subo2/3Mh6d/oJb5nU1b5tW7r2knautaa3T+U32o7f7vZwpJkaNDLORJjcu7t59m2jXxqX9un+tt022acsfmoKaQZ+vhhswZtS6Ne/ThQGt0IV0N3Yyv6P3CeT9/tHO0XFI5cAE=);whiteSpace=wrap;html=1;';

    /**
     * Broken image symbol for offline SVG.
     */
    EditorUi.prototype.svgBrokenImage = Graph.createSvgImage(10, 10, '<rect x="0" y="0" width="10" height="10" stroke="#000" fill="transparent"/><path d="m 0 0 L 10 10 L 0 10 L 10 0" stroke="#000" fill="transparent"/>');

    /**
     * Specifies if img.crossOrigin is supported. This is true for all browsers except IE10 and earlier.
     */
    EditorUi.prototype.crossOriginImages = !mxClient.IS_IE;

    /**
     * Defines the maximum size for images.
     */
    EditorUi.prototype.maxBackgroundSize = 1600;

    /**
     * Defines the maximum size for images.
     */
    EditorUi.prototype.maxImageSize = 520;

    /**
     * Images above 100K should be resampled.
     */
    EditorUi.prototype.resampleThreshold = 100000;

    /**
     * Maximum allowed size for images is 1 MB.
     */
    EditorUi.prototype.maxImageBytes = 1000000;

    /**
     * Maximum size for background images is 2.5 MB.
     */
    EditorUi.prototype.maxBackgroundBytes = 2500000;

    /**
     * Maximum size for text files in labels is 0.5 MB.
     */
    EditorUi.prototype.maxTextBytes = 500000;

    /**
     * Holds the current file.
     */
    EditorUi.prototype.currentFile = null;

    /**
     * Specifies if PDF export should be done via print dialog. Default is
     * false which uses the PhantomJS backend to create the PDF.
     */
    EditorUi.prototype.printPdfExport = false;

    /**
     * Specifies if PDF export with pages is enabled.
     */
    EditorUi.prototype.pdfPageExport = true;

    /**
     * Restores app defaults for UI
     */
    EditorUi.prototype.formatEnabled = urlParams['format'] != '0';

    /**
     * Whether template action should be shown in insert menu.
     */
    EditorUi.prototype.insertTemplateEnabled = true;

    /**
     * Restores app defaults for UI
     */
    EditorUi.prototype.closableScratchpad = true;

    /**
     * Capability check for canvas export
     */
    (function () {
        EditorUi.prototype.useCanvasForExport = false;
        EditorUi.prototype.jpgSupported = false;

        // Checks if canvas is supported
        try {
            var cnv = document.createElement('canvas');
            EditorUi.prototype.canvasSupported = !!(cnv.getContext && cnv.getContext('2d'));
        } catch (e) {
            // ignore
        }

        try {
            var canvas = document.createElement('canvas');
            var img = new Image();

            // LATER: Capability check should not be async
            img.onload = function () {
                try {
                    var ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);

                    // Works in Chrome, Firefox, Edge, Safari and Opera
                    var result = canvas.toDataURL('image/png');
                    EditorUi.prototype.useCanvasForExport = result != null && result.length > 6;
                } catch (e) {
                    // ignore
                }
            };

            // Checks if SVG with foreignObject can be exported
            var svg = '<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="1px" height="1px" version="1.1"><foreignObject pointer-events="all" width="1" height="1"><div xmlns="http://www.w3.org/1999/xhtml"></div></foreignObject></svg>';
            img.src = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svg)));
        } catch (e) {
            // ignore
        }

        // Checks for client-side JPG support
        try {
            var canvas = document.createElement('canvas');
            canvas.width = canvas.height = 1;
            var uri = canvas.toDataURL('image/jpeg');

            EditorUi.prototype.jpgSupported = (uri.match('image/jpeg') !== null);
        } catch (e) {
            // ignore
        }
    })();

    /**
     * Hook for subclassers.
     */
    EditorUi.prototype.openLink = function (url, target, allowOpener) {
        // LATER: Replace this with direct calls to graph
        return this.editor.graph.openLink(url, target, allowOpener);
    };

    /**
     * Hook for subclassers.
     */
    EditorUi.prototype.showSplash = function (force) {
    };

    /**
     * Abstraction for local storage access.
     */
    EditorUi.prototype.getLocalData = function (key, fn) {
        fn(localStorage.getItem(key));
    };

    /**
     * Abstraction for local storage access.
     */
    EditorUi.prototype.setLocalData = function (key, data, fn) {
        localStorage.setItem(key, data);

        if (fn != null) {
            fn();
        }
    };

    /**
     * Abstraction for local storage access.
     */
    EditorUi.prototype.removeLocalData = function (key, fn) {
        localStorage.removeItem(key)
        fn();
    };

    EditorUi.prototype.setMathEnabled = function (value) {
        this.editor.graph.mathEnabled = value;
        this.editor.updateGraphComponents();
        this.editor.graph.refresh();

        this.fireEvent(new mxEventObject('mathEnabledChanged'));
    };

    EditorUi.prototype.isMathEnabled = function (value) {
        return this.editor.graph.mathEnabled;
    };

    /**
     * Returns true if using application cache
     */
    EditorUi.prototype.isAppCache = function () {
        return (urlParams['appcache'] == '1' || this.isOfflineApp());
    };

    /**
     * Returns true if offline app, which isn't a defined thing
     */
    EditorUi.prototype.isOfflineApp = function () {
        return (urlParams['offline'] == '1');
    };

    /**
     * Returns true if no external comms allowed or possible
     */
    EditorUi.prototype.isOffline = function (ignoreStealth) {
        return this.isOfflineApp() || !navigator.onLine || (!ignoreStealth && urlParams['stealth'] == '1');
    };

    /**
     * Translates this point by the given vector.
     *
     * @param {number} dx X-coordinate of the translation.
     * @param {number} dy Y-coordinate of the translation.
     */
    EditorUi.prototype.createSpinner = function (x, y, size) {
        size = (size != null) ? size : 24;

        var spinner = new Spinner({
            lines: 12, // The number of lines to draw
            length: size, // The length of each line
            width: Math.round(size / 3), // The line thickness
            radius: Math.round(size / 2), // The radius of the inner circle
            rotate: 0, // The rotation offset
            color: (uiTheme == 'dark') ? '#c0c0c0' : '#000', // #rgb or #rrggbb
            speed: 1.5, // Rounds per second
            trail: 60, // Afterglow percentage
            shadow: false, // Whether to render a shadow
            hwaccel: false, // Whether to use hardware acceleration
            zIndex: 2e9 // The z-index (defaults to 2000000000)
        });

        // Extends spin method to include an optional label
        var oldSpin = spinner.spin;

        spinner.spin = function (container, label) {
            var result = false;

            if (!this.active) {
                oldSpin.call(this, container);
                this.active = true;

                if (label != null) {
                    var status = document.createElement('div');
                    status.style.position = 'absolute';
                    status.style.whiteSpace = 'nowrap';
                    status.style.background = '#4B4243';
                    status.style.color = 'white';
                    status.style.fontFamily = 'Helvetica, Arial';
                    status.style.fontSize = '9pt';
                    status.style.padding = '6px';
                    status.style.paddingLeft = '10px';
                    status.style.paddingRight = '10px';
                    status.style.zIndex = 2e9;
                    status.style.left = Math.max(0, x) + 'px';
                    status.style.top = Math.max(0, y + 70) + 'px';

                    mxUtils.setPrefixedStyle(status.style, 'borderRadius', '6px');
                    mxUtils.setPrefixedStyle(status.style, 'transform', 'translate(-50%,-50%)');

                    if (uiTheme != 'dark') {
                        mxUtils.setPrefixedStyle(status.style, 'boxShadow', '2px 2px 3px 0px #ddd');
                    }

                    if (label.substring(label.length - 3, label.length) != '...' &&
                        label.charAt(label.length - 1) != '!') {
                        label = label + '...';
                    }

                    status.innerHTML = label;
                    container.appendChild(status);
                    spinner.status = status;

                    // Centers the label in older IE versions
                    if (mxClient.IS_VML && (document.documentMode == null || document.documentMode <= 8)) {
                        status.style.left = Math.round(Math.max(0, x - status.offsetWidth / 2)) + 'px';
                        status.style.top = Math.round(Math.max(0, y + 70 - status.offsetHeight / 2)) + 'px';
                    }
                }

                // Pause returns a function to resume the spinner
                this.pause = mxUtils.bind(this, function () {
                    var fn = function () {
                    };

                    if (this.active) {
                        fn = mxUtils.bind(this, function () {
                            this.spin(container, label);
                        });
                    }

                    this.stop();

                    return fn;
                });

                result = true;
            }

            return result;
        };

        // Extends stop method to remove the optional label
        var oldStop = spinner.stop;

        spinner.stop = function () {
            oldStop.call(this);
            this.active = false;

            if (spinner.status != null) {
                spinner.status.parentNode.removeChild(spinner.status);
                spinner.status = null;
            }
        };

        spinner.pause = function () {
            return function () {
            };
        };

        return spinner;
    };

    /**
     * Returns true if the given string contains a compatible graph model.
     */
    EditorUi.prototype.isCompatibleString = function (data) {
        try {
            var doc = mxUtils.parseXml(data);
            var node = this.editor.extractGraphModel(doc.documentElement, true);

            return node != null && node.getElementsByTagName('parsererror').length == 0;
        } catch (e) {
            // ignore
        }

        return false;
    };

    /**
     * Returns true if the given binary data is a Visio file.
     */
    EditorUi.prototype.isVisioData = function (data) {
        return data.length > 8 && (data.charCodeAt(0) == 0xD0 && data.charCodeAt(1) == 0xCF &&
            data.charCodeAt(2) == 0x11 && data.charCodeAt(3) == 0xE0 && data.charCodeAt(4) == 0xA1 && data.charCodeAt(5) == 0xB1 &&
            data.charCodeAt(6) == 0x1A && data.charCodeAt(7) == 0xE1) || (data.charCodeAt(0) == 0x50 && data.charCodeAt(1) == 0x4B &&
            data.charCodeAt(2) == 0x03 && data.charCodeAt(3) == 0x04) || (data.charCodeAt(0) == 0x50 && data.charCodeAt(1) == 0x4B &&
            data.charCodeAt(2) == 0x03 && data.charCodeAt(3) == 0x06);
    };

    /**
     * Returns true if the given binary data is a PNG file.
     */
    EditorUi.prototype.isPngData = function (data) {
        return data.length > 8 && data.charCodeAt(0) == 137 && data.charCodeAt(1) == 80 &&
            data.charCodeAt(2) == 78 && data.charCodeAt(3) == 71 && data.charCodeAt(4) == 13 &&
            data.charCodeAt(5) == 10 && data.charCodeAt(6) == 26 && data.charCodeAt(7) == 10;
    };

    /**
     * Extracts the mxfile from the given HTML data from a data transfer event.
     */
    var editorUiExtractGraphModelFromHtml = EditorUi.prototype.extractGraphModelFromHtml;
    EditorUi.prototype.extractGraphModelFromHtml = function (data) {
        var result = editorUiExtractGraphModelFromHtml.apply(this, arguments);

        if (result == null) {
            try {
                var idx = data.indexOf('&lt;mxfile ');

                if (idx >= 0) {
                    var idx2 = data.lastIndexOf('&lt;/mxfile&gt;');

                    if (idx2 > idx) {
                        result = data.substring(idx, idx2 + 15).replace(/&gt;/g, '>').replace(/&lt;/g, '<').replace(/\\&quot;/g, '"').replace(/\n/g, '');
                    }
                } else {
                    // Gets compressed data from mxgraph element in HTML document
                    var doc = mxUtils.parseXml(data);
                    var node = this.editor.extractGraphModel(doc.documentElement, this.pages != null ||
                        this.diagramContainer.style.visibility == 'hidden');
                    result = (node != null) ? mxUtils.getXml(node) : '';
                }
            } catch (e) {
                // ignore
            }
        }

        return result;
    };

    /**
     * Workaround for malformed xhtml meta element bug 07.08.16. The trailing slash was missing causing
     * reopen to fail trying to parse. Used in replaceFileData, setFileData and importFile.
     */
    EditorUi.prototype.validateFileData = function (data) {
        if (data != null && data.length > 0) {
            var index = data.indexOf('<meta charset="utf-8">');

            if (index >= 0) {
                var replaceString = '<meta charset="utf-8"/>';
                var replaceStrLen = replaceString.length;
                data = data.slice(0, index) + replaceString + data.slice(index + replaceStrLen - 1, data.length);
            }

            data = Graph.zapGremlins(data);
        }

        return data;
    };

    /**
     *
     */
    EditorUi.prototype.replaceFileData = function (data) {
        data = this.validateFileData(data);
        var node = (data != null && data.length > 0) ? mxUtils.parseXml(data).documentElement : null;

        // Some nodes must be extracted here to find the mxfile node
        // LATER: Remove duplicate call to extractGraphModel in overridden setGraphXml
        var tmp = (node != null) ? this.editor.extractGraphModel(node, true) : null;

        if (tmp != null) {
            node = tmp;
        }

        if (node != null) {
            var graph = this.editor.graph;

            graph.model.beginUpdate();
            try {
                var oldPages = (this.pages != null) ? this.pages.slice() : null;
                var nodes = node.getElementsByTagName('diagram');

                if (urlParams['pages'] != '0' || nodes.length > 1 ||
                    (nodes.length == 1 && nodes[0].hasAttribute('name'))) {
                    this.fileNode = node;
                    this.pages = (this.pages != null) ? this.pages : [];

                    // Wraps page nodes
                    for (var i = nodes.length - 1; i >= 0; i--) {
                        var page = this.updatePageRoot(new DiagramPage(nodes[i]));

                        // Checks for invalid page names
                        if (page.getName() == null) {
                            page.setName(mxResources.get('pageWithNumber', [i + 1]));
                        }

                        graph.model.execute(new ChangePage(this, page, (i == 0) ? page : null, 0));
                    }
                } else {
                    // Creates tabbed file structure if enforced by URL
                    if (urlParams['pages'] != '0' && this.fileNode == null) {
                        this.fileNode = node.ownerDocument.createElement('mxfile');
                        this.currentPage = new DiagramPage(node.ownerDocument.createElement('diagram'));
                        this.currentPage.setName(mxResources.get('pageWithNumber', [1]));
                        graph.model.execute(new ChangePage(this, this.currentPage, this.currentPage, 0));
                    }

                    // Avoids scroll offset when switching page
                    this.editor.setGraphXml(node);

                    // Avoids duplicate parsing of the XML stored in the node
                    if (this.currentPage != null) {
                        this.currentPage.root = this.editor.graph.model.root;
                    }
                }

                if (oldPages != null) {
                    for (var i = 0; i < oldPages.length; i++) {
                        graph.model.execute(new ChangePage(this, oldPages[i], null));
                    }
                }
            } finally {
                graph.model.endUpdate();
            }
        }
    };

    /**
     * Translates this point by the given vector.
     *
     * @param {number} dx X-coordinate of the translation.
     * @param {number} dy Y-coordinate of the translation.
     */
    EditorUi.prototype.createFileData = function (node, graph, file, url, forceXml, forceSvg, forceHtml,
                                                  embeddedCallback, ignoreSelection, compact, uncompressed) {
        graph = (graph != null) ? graph : this.editor.graph;
        forceXml = (forceXml != null) ? forceXml : false;
        ignoreSelection = (ignoreSelection != null) ? ignoreSelection : true;

        var editLink = null;
        var redirect = null;

        if (file == null || file.getMode() == App.MODE_DEVICE || file.getMode() == App.MODE_BROWSER) {
            editLink = '_blank';
        } else {
            editLink = url;
            redirect = editLink;
        }

        if (node == null) {
            return '';
        } else {
            var fileNode = node;

            // Ignores case for possible HTML or XML nodes
            if (fileNode.nodeName.toLowerCase() != 'mxfile') {
                if (uncompressed) {
                    var diagramNode = node.ownerDocument.createElement('diagram');
                    diagramNode.setAttribute('id', Editor.guid());
                    diagramNode.appendChild(node);

                    fileNode = node.ownerDocument.createElement('mxfile');
                    fileNode.appendChild(diagramNode);
                } else {
                    // Removes control chars in input for correct roundtrip check
                    var text = Graph.zapGremlins(mxUtils.getXml(node));
                    var data = Graph.compress(text);

                    // Fallback to plain XML for invalid compression
                    // TODO: Remove this fallback with active pages
                    if (Graph.decompress(data) != text) {
                        return text;
                    } else {
                        var diagramNode = node.ownerDocument.createElement('diagram');
                        diagramNode.setAttribute('id', Editor.guid());
                        mxUtils.setTextContent(diagramNode, data);

                        fileNode = node.ownerDocument.createElement('mxfile');
                        fileNode.appendChild(diagramNode);
                    }
                }
            }

            if (!compact) {
                // Removes old metadata
                fileNode.removeAttribute('userAgent');
                fileNode.removeAttribute('version');
                fileNode.removeAttribute('editor');
                fileNode.removeAttribute('pages');
                fileNode.removeAttribute('type');

                if (mxClient.IS_CHROMEAPP) {
                    fileNode.setAttribute('host', 'Chrome');
                } else if (EditorUi.isElectronApp) {
                    fileNode.setAttribute('host', 'Electron');
                } else {
                    fileNode.setAttribute('host', window.location.hostname);
                }

                // Adds new metadata
                fileNode.setAttribute('modified', new Date().toISOString());
                fileNode.setAttribute('agent', navigator.userAgent);
                fileNode.setAttribute('version', EditorUi.VERSION);
                fileNode.setAttribute('etag', Editor.guid());

                var md = (file != null) ? file.getMode() : this.mode;

                if (md != null) {
                    fileNode.setAttribute('type', md);
                }

                if (this.pages != null) {
                    fileNode.setAttribute('pages', this.pages.length);
                }
            } else {
                fileNode = fileNode.cloneNode(true);
                fileNode.removeAttribute('modified');
                fileNode.removeAttribute('host');
                fileNode.removeAttribute('agent');
                fileNode.removeAttribute('etag');
                fileNode.removeAttribute('userAgent');
                fileNode.removeAttribute('version');
                fileNode.removeAttribute('editor');
                fileNode.removeAttribute('type');
            }

            var xml = (uncompressed) ? mxUtils.getPrettyXml(fileNode) : mxUtils.getXml(fileNode);

            // Writes the file as an embedded HTML file
            if (!forceSvg && !forceXml && (forceHtml || (file != null && /(\.html)$/i.test(file.getTitle())))) {
                xml = this.getHtml2(mxUtils.getXml(fileNode), graph, (file != null) ? file.getTitle() : null, editLink, redirect);
            }
            // Maps the XML data to the content attribute in the SVG node
            else if (forceSvg || (!forceXml && file != null && /(\.svg)$/i.test(file.getTitle()))) {
                if (file != null && (file.getMode() == App.MODE_DEVICE || file.getMode() == App.MODE_BROWSER)) {
                    url = null;
                }

                xml = this.getEmbeddedSvg(xml, graph, url, null, embeddedCallback, ignoreSelection, redirect);
            }

            return xml;
        }
    };

    /**
     * Translates this point by the given vector.
     *
     * @param {number} dx X-coordinate of the translation.
     * @param {number} dy Y-coordinate of the translation.
     */
    EditorUi.prototype.getXmlFileData = function (ignoreSelection, currentPage, uncompressed) {
        ignoreSelection = (ignoreSelection != null) ? ignoreSelection : true;
        currentPage = (currentPage != null) ? currentPage : false;
        uncompressed = (uncompressed != null) ? uncompressed : !Editor.compressXml;

        var node = this.editor.getGraphXml(ignoreSelection);

        if (ignoreSelection && this.fileNode != null && this.currentPage != null) {
            if (uncompressed) {
                EditorUi.removeChildNodes(this.currentPage.node);
                this.currentPage.node.appendChild(node);
            } else {
                var data = Graph.compressNode(node);
                mxUtils.setTextContent(this.currentPage.node, data);
            }

            node = this.fileNode.cloneNode(false);

            if (currentPage) {
                node.appendChild(this.currentPage.node);
            } else {
                // Restores order of pages
                for (var i = 0; i < this.pages.length; i++) {
                    if (this.currentPage != this.pages[i]) {
                        if (this.pages[i].needsUpdate) {
                            var enc = new mxCodec(mxUtils.createXmlDocument());
                            var temp = enc.encode(new mxGraphModel(this.pages[i].root));
                            this.editor.graph.saveViewState(this.pages[i].viewState, temp);

                            if (uncompressed) {
                                EditorUi.removeChildNodes(this.pages[i].node);
                                this.pages[i].node.appendChild(temp);
                            } else {
                                mxUtils.setTextContent(this.pages[i].node, Graph.compressNode(temp));
                            }

                            // Marks the page as up-to-date
                            delete this.pages[i].needsUpdate;
                        } else if (uncompressed) {
                            var temp = Editor.parseDiagramNode(this.pages[i].node);
                            EditorUi.removeChildNodes(this.pages[i].node);
                            this.pages[i].node.appendChild(temp);
                        }
                    }

                    node.appendChild(this.pages[i].node);
                }
            }
        }

        return node;
    };

    /**
     * Removes any values, styles and geometries from the given XML node.
     */
    EditorUi.prototype.anonymizeString = function (text, zeros) {
        var result = [];

        for (var i = 0; i < text.length; i++) {
            var c = text.charAt(i);

            if (EditorUi.ignoredAnonymizedChars.indexOf(c) >= 0) {
                result.push(c);
            } else if (!isNaN(parseInt(c))) {
                result.push((zeros) ? '0' : Math.round(Math.random() * 9));
            } else if (c.toLowerCase() != c) {
                result.push(String.fromCharCode(65 + Math.round(Math.random() * 25)));
            } else if (c.toUpperCase() != c) {
                result.push(String.fromCharCode(97 + Math.round(Math.random() * 25)));
            } else if (/\s/.test(c)) {
                /* any whitespace */
                result.push(' ');
            } else {
                result.push('?');
            }
        }

        return result.join('');
    };

    /**
     * Removes any values, styles and geometries from the given XML node.
     */
    EditorUi.prototype.anonymizePatch = function (patch) {
        if (patch[EditorUi.DIFF_INSERT] != null) {
            for (var i = 0; i < patch[EditorUi.DIFF_INSERT].length; i++) {
                try {
                    var data = patch[EditorUi.DIFF_INSERT][i].data;
                    var doc = mxUtils.parseXml(data);
                    var clone = doc.documentElement.cloneNode(false);

                    if (clone.getAttribute('name') != null) {
                        clone.setAttribute('name', this.anonymizeString(clone.getAttribute('name')));
                    }

                    patch[EditorUi.DIFF_INSERT][i].data = mxUtils.getXml(clone);
                } catch (e) {
                    patch[EditorUi.DIFF_INSERT][i].data = e.message;
                }
            }
        }

        if (patch[EditorUi.DIFF_UPDATE] != null) {
            for (var pageId in patch[EditorUi.DIFF_UPDATE]) {
                var diff = patch[EditorUi.DIFF_UPDATE][pageId];

                if (diff.name != null) {
                    diff.name = this.anonymizeString(diff.name);
                }

                if (diff.cells != null) {
                    var anonymizeCellDiffs = mxUtils.bind(this, function (key) {
                        var cellDiffs = diff.cells[key];

                        if (cellDiffs != null) {
                            for (var cellId in cellDiffs) {
                                if (cellDiffs[cellId].value != null) {
                                    cellDiffs[cellId].value = '[' +
                                        cellDiffs[cellId].value.length + ']';
                                }

                                if (cellDiffs[cellId].xmlValue != null) {
                                    cellDiffs[cellId].xmlValue = '[' +
                                        cellDiffs[cellId].xmlValue.length + ']';
                                }

                                if (cellDiffs[cellId].style != null) {
                                    cellDiffs[cellId].style = '[' +
                                        cellDiffs[cellId].style.length + ']';
                                }

                                if (Object.keys(cellDiffs[cellId]).length == 0) {
                                    delete cellDiffs[cellId];
                                }
                            }

                            if (Object.keys(cellDiffs).length == 0) {
                                delete diff.cells[key];
                            }
                        }
                    });

                    anonymizeCellDiffs(EditorUi.DIFF_INSERT);
                    anonymizeCellDiffs(EditorUi.DIFF_UPDATE);

                    if (Object.keys(diff.cells).length == 0) {
                        delete diff.cells;
                    }
                }

                if (Object.keys(diff).length == 0) {
                    delete patch[EditorUi.DIFF_UPDATE][pageId];
                }
            }

            if (Object.keys(patch[EditorUi.DIFF_UPDATE]).length == 0) {
                delete patch[EditorUi.DIFF_UPDATE];
            }
        }

        return patch;
    };

    /**
     * Removes any values, styles and geometries from the given XML node.
     */
    EditorUi.prototype.anonymizeAttributes = function (node, zeros) {
        if (node.attributes != null) {
            for (var i = 0; i < node.attributes.length; i++) {
                if (node.attributes[i].name != 'as') {
                    node.setAttribute(node.attributes[i].name,
                        this.anonymizeString(node.attributes[i].value, zeros));
                }
            }
        }

        if (node.childNodes != null) {
            for (var i = 0; i < node.childNodes.length; i++) {
                this.anonymizeAttributes(node.childNodes[i], zeros);
            }
        }
    };

    /**
     * Removes any values, styles and geometries from the given XML node.
     */
    EditorUi.prototype.anonymizeNode = function (node, zeros) {
        var nodes = node.getElementsByTagName('mxCell');

        for (var i = 0; i < nodes.length; i++) {
            if (nodes[i].getAttribute('value') != null) {
                nodes[i].setAttribute('value', '[' + nodes[i].getAttribute('value').length + ']');
            }

            if (nodes[i].getAttribute('xmlValue') != null) {
                nodes[i].setAttribute('xmlValue', '[' + nodes[i].getAttribute('xmlValue').length + ']');
            }

            if (nodes[i].getAttribute('style') != null) {
                nodes[i].setAttribute('style', '[' + nodes[i].getAttribute('style').length + ']');
            }

            if (nodes[i].parentNode != null && nodes[i].parentNode.nodeName != 'root' &&
                nodes[i].parentNode.parentNode != null) {
                nodes[i].setAttribute('id', nodes[i].parentNode.getAttribute('id'));
                nodes[i].parentNode.parentNode.replaceChild(nodes[i], nodes[i].parentNode);
            }
        }

        return node;
    };

    /**
     * Translates this point by the given vector.
     *
     * @param {number} dx X-coordinate of the translation.
     * @param {number} dy Y-coordinate of the translation.
     */
    EditorUi.prototype.synchronizeCurrentFile = function (forceReload) {
        var currentFile = this.getCurrentFile();

        if (currentFile != null) {
            if (currentFile.savingFile) {
                this.handleError({message: mxResources.get('busy')});
            } else if (!forceReload && currentFile.invalidChecksum) {
                currentFile.handleFileError(null, true);
            } else if (this.spinner.spin(document.body, mxResources.get('updatingDocument'))) {
                currentFile.clearAutosave();
                this.editor.setStatus('');

                if (forceReload) {
                    currentFile.reloadFile(mxUtils.bind(this, function () {
                        currentFile.handleFileSuccess(DrawioFile.SYNC == 'manual');
                    }), mxUtils.bind(this, function (err) {
                        currentFile.handleFileError(err, true);
                    }));
                } else {
                    currentFile.synchronizeFile(mxUtils.bind(this, function () {
                        currentFile.handleFileSuccess(DrawioFile.SYNC == 'manual');
                    }), mxUtils.bind(this, function (err) {
                        currentFile.handleFileError(err, true);
                    }));
                }
            }
        }
    };

    /**
     * Translates this point by the given vector.
     *
     * @param {number} dx X-coordinate of the translation.
     * @param {number} dy Y-coordinate of the translation.
     */
    EditorUi.prototype.getFileData = function (forceXml, forceSvg, forceHtml, embeddedCallback, ignoreSelection,
                                               currentPage, node, compact, file, uncompressed) {
        ignoreSelection = (ignoreSelection != null) ? ignoreSelection : true;
        currentPage = (currentPage != null) ? currentPage : false;

        // Forces compression of embedded XML
        if (forceSvg || (!forceXml && file != null && /(\.svg)$/i.test(file.getTitle()))) {
            uncompressed = false;

            // Exports SVG for first page while other page is visible by creating a graph
            // LATER: Add caching for the graph or SVG while not on first page
            if (this.pages != null && this.currentPage != this.pages[0]) {
                var graphGetGlobalVariable = graph.getGlobalVariable;
                graph = this.createTemporaryGraph(graph.getStylesheet());
                var page = this.pages[0];

                graph.getGlobalVariable = function (name) {
                    if (name == 'page') {
                        return page.getName();
                    } else if (name == 'pagenumber') {
                        return 1;
                    }

                    return graphGetGlobalVariable.apply(this, arguments);
                };

                document.body.appendChild(graph.container);
                graph.model.setRoot(page.root);
            }
        }

        node = (node != null) ? node : this.getXmlFileData(ignoreSelection, currentPage, uncompressed);
        file = (file != null) ? file : this.getCurrentFile();
        var graph = this.editor.graph;

        var result = this.createFileData(node, graph, file, window.location.href,
            forceXml, forceSvg, forceHtml, embeddedCallback, ignoreSelection, compact,
            uncompressed);

        // Removes temporary graph from DOM
        if (graph != this.editor.graph) {
            graph.container.parentNode.removeChild(graph.container);
        }

        return result;
    };

    /**
     *
     */
    EditorUi.prototype.getHtml = function (node, graph, title, editLink, redirect, ignoreSelection) {
        ignoreSelection = (ignoreSelection != null) ? ignoreSelection : true;
        var bg = null;
        var js = EditorUi.drawHost + '/js/embed-static.min.js';

        // LATER: Merge common code with EmbedDialog
        if (graph != null) {
            var bounds = (ignoreSelection) ? graph.getGraphBounds() : graph.getBoundingBox(graph.getSelectionCells());
            var scale = graph.view.scale;
            var x0 = Math.floor(bounds.x / scale - graph.view.translate.x);
            var y0 = Math.floor(bounds.y / scale - graph.view.translate.y);
            bg = graph.background;

            // Embed script only used if no redirect
            if (redirect == null) {
                var s = this.getBasenames().join(';');

                if (s.length > 0) {
                    js = EditorUi.drawHost + '/embed.js?s=' + s;
                }
            }

            // Adds embed attributes
            node.setAttribute('x0', x0);
            node.setAttribute('y0', y0);
        }

        if (node != null) {
            node.setAttribute('pan', '1');
            node.setAttribute('zoom', '1');
            node.setAttribute('resize', '0');
            node.setAttribute('fit', '0');
            node.setAttribute('border', '20');

            // Hidden attributes
            node.setAttribute('links', '1');

            if (editLink != null) {
                node.setAttribute('edit', editLink);
            }
        }

        // Makes XHTML compatible
        if (redirect != null) {
            redirect = redirect.replace(/&/g, '&amp;');
        }

        // Removes control chars in input for correct roundtrip check
        var text = (node != null) ? Graph.zapGremlins(mxUtils.getXml(node)) : '';

        // Double compression for mxfile not fixed since it may cause imcompatibilites with
        // embed clients that rely on this format. HTML files and export use getHtml2.
        var data = Graph.compress(text);

        // Fallback to URI encoded XML for invalid compression
        if (Graph.decompress(data) != text) {
            data = encodeURIComponent(text);
        }

        var style = 'position:relative;overflow:auto;width:100%;';

        return ((redirect == null) ? '<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=5,IE=9" ><![endif]-->\n' : '') +
            '<!DOCTYPE html>\n<html' + ((redirect != null) ? ' xmlns="http://www.w3.org/1999/xhtml">' : '>') +
            '\n<head>\n' + ((redirect == null) ? ((title != null) ? '<title>' + mxUtils.htmlEntities(title) +
                '</title>\n' : '') : '<title>Draw.io Diagram</title>\n') +
            ((redirect != null) ? '<meta http-equiv="refresh" content="0;URL=\'' + redirect + '\'"/>\n' : '') +
            '</head>\n<body' +
            (((redirect == null && bg != null && bg != mxConstants.NONE) ? ' style="background-color:' + bg + ';">' : '>')) +
            '\n<div class="mxgraph" style="' + style + '">\n' +
            '<div style="width:1px;height:1px;overflow:hidden;">' + data + '</div>\n</div>\n' +
            ((redirect == null) ? '<script type="text/javascript" src="' + js + '"></script>' :
                '<a style="position:absolute;top:50%;left:50%;margin-top:-128px;margin-left:-64px;" ' +
                'href="' + redirect + '" target="_blank"><img border="0" ' +
                'src="' + EditorUi.drawHost + '/images/drawlogo128.png"/></a>') +
            '\n</body>\n</html>\n';
    };

    /**
     * Same as above but using the new embed code.
     */
    EditorUi.prototype.getHtml2 = function (xml, graph, title, editLink, redirect) {
        var bg = null;
        var js = EditorUi.drawHost + '/js/viewer.min.js';
        var s = '';

        // Makes XHTML compatible
        if (redirect != null) {
            redirect = redirect.replace(/&/g, '&amp;');
        }

        var data = {
            highlight: '#0000ff', nav: this.editor.graph.foldingEnabled, resize: true,
            xml: Graph.zapGremlins(xml), toolbar: 'pages zoom layers lightbox'
        };

        if (this.pages != null && this.currentPage != null) {
            data.page = mxUtils.indexOf(this.pages, this.currentPage);
        }

        var style = 'max-width:100%;border:1px solid transparent;';

        return ((redirect == null) ? '<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=5,IE=9" ><![endif]-->\n' : '') +
            '<!DOCTYPE html>\n<html' + ((redirect != null) ? ' xmlns="http://www.w3.org/1999/xhtml">' : '>') +
            '\n<head>\n' + ((redirect == null) ? ((title != null) ? '<title>' + mxUtils.htmlEntities(title) +
                '</title>\n' : '') : '<title>Draw.io Diagram</title>\n') +
            ((redirect != null) ? '<meta http-equiv="refresh" content="0;URL=\'' + redirect + '\'"/>\n' : '') +
            '<meta charset="utf-8"/>\n</head>\n<body>' +
            '\n<div class="mxgraph" style="' + style + '" data-mxgraph="' + mxUtils.htmlEntities(JSON.stringify(data)) + '"></div>\n' +
            ((redirect == null) ? '<script type="text/javascript" src="' + js + '"></script>' :
                '<a style="position:absolute;top:50%;left:50%;margin-top:-128px;margin-left:-64px;" ' +
                'href="' + redirect + '" target="_blank"><img border="0" ' +
                'src="' + EditorUi.drawHost + '/images/drawlogo128.png"/></a>') +
            '\n</body>\n</html>\n';
    };

    /**
     *
     */
    EditorUi.prototype.setFileData = function (data) {
        data = this.validateFileData(data);
        this.currentPage = null;
        this.fileNode = null;
        this.pages = null;

        var node = (data != null && data.length > 0) ? mxUtils.parseXml(data).documentElement : null;

        // Checks for parser errors
        var cause = Editor.extractParserError(node, mxResources.get('invalidOrMissingFile'));

        if (cause) {
            throw new Error(cause);
        } else {
            // Some nodes must be extracted here to find the mxfile node
            // LATER: Remove duplicate call to extractGraphModel in overridden setGraphXml
            var tmp = (node != null) ? this.editor.extractGraphModel(node, true) : null;

            if (tmp != null) {
                node = tmp;
            }

            if (node != null && node.nodeName == 'mxfile') {
                var nodes = node.getElementsByTagName('diagram');

                if (urlParams['pages'] != '0' || nodes.length > 1 ||
                    (nodes.length == 1 && nodes[0].hasAttribute('name'))) {
                    var selectedPage = null;
                    this.fileNode = node;
                    this.pages = [];

                    // Wraps page nodes
                    for (var i = 0; i < nodes.length; i++) {
                        // Adds page ID based on page order to match
                        // remote IDs given if IDs are missing here
                        if (nodes[i].getAttribute('id') == null) {
                            nodes[i].setAttribute('id', i);
                        }

                        var page = new DiagramPage(nodes[i]);

                        // Checks for invalid page names
                        if (page.getName() == null) {
                            page.setName(mxResources.get('pageWithNumber', [i + 1]));
                        }

                        this.pages.push(page);

                        if (urlParams['page-id'] != null && page.getId() == urlParams['page-id']) {
                            selectedPage = page;
                        }
                    }

                    this.currentPage = (selectedPage != null) ? selectedPage :
                        this.pages[Math.max(0, Math.min(this.pages.length - 1, urlParams['page'] || 0))];
                    node = this.currentPage.node;
                }
            }

            // Creates tabbed file structure if enforced by URL
            if (urlParams['pages'] != '0' && this.fileNode == null && node != null) {
                this.fileNode = node.ownerDocument.createElement('mxfile');
                this.currentPage = new DiagramPage(node.ownerDocument.createElement('diagram'));
                this.currentPage.setName(mxResources.get('pageWithNumber', [1]));
                this.pages = [this.currentPage];
            }

            // Avoids scroll offset when switching page
            this.editor.setGraphXml(node);

            // Avoids duplicate parsing of the XML stored in the node
            if (this.currentPage != null) {
                this.currentPage.root = this.editor.graph.model.root;
            }
        }
    };

    /**
     * Translates this point by the given vector.
     *
     * @param {number} dx X-coordinate of the translation.
     * @param {number} dy Y-coordinate of the translation.
     */
    EditorUi.prototype.getBaseFilename = function (ignorePageName) {
        var file = this.getCurrentFile();
        var basename = (file != null && file.getTitle() != null) ? file.getTitle() : this.defaultFilename;

        if (/(\.xml)$/i.test(basename) || /(\.html)$/i.test(basename) ||
            /(\.svg)$/i.test(basename) || /(\.png)$/i.test(basename) ||
            /(\.drawio)$/i.test(basename)) {
            basename = basename.substring(0, basename.lastIndexOf('.'));
        }

        if (!ignorePageName && this.pages != null && this.pages.length > 1 &&
            this.currentPage != null && this.currentPage.node.getAttribute('name') != null &&
            this.currentPage.getName().length > 0) {
            basename = basename + '-' + this.currentPage.getName();
        }

        return basename;
    };

    /**
     * Translates this point by the given vector.
     *
     * @param {number} dx X-coordinate of the translation.
     * @param {number} dy Y-coordinate of the translation.
     */
    EditorUi.prototype.downloadFile = function (format, uncompressed, addShadow, ignoreSelection, currentPage, pageVisible, transparent, scale, border, grid) {
        try {
            ignoreSelection = (ignoreSelection != null) ? ignoreSelection : this.editor.graph.isSelectionEmpty();
            var basename = this.getBaseFilename(!currentPage);
            var filename = basename + '.' + format;

            if (format == 'xml') {
                var data = '<?xml version="1.0" encoding="UTF-8"?>\n' +
                    this.getFileData(true, null, null, null, ignoreSelection, currentPage,
                        null, null, null, uncompressed);

                this.saveData(filename, format, data, 'text/xml');
            } else if (format == 'html') {
                var data = this.getHtml2(this.getFileData(true), this.editor.graph, basename);
                this.saveData(filename, format, data, 'text/html');
            } else if ((format == 'svg' || format == 'xmlsvg') && this.spinner.spin(document.body, mxResources.get('export'))) {
                var svg = null;

                var saveSvg = mxUtils.bind(this, function (data) {
                    if (data.length <= MAX_REQUEST_SIZE) {
                        this.saveData(filename, 'svg', data, 'image/svg+xml');
                    } else {
                        this.handleError({message: mxResources.get('drawingTooLarge')}, mxResources.get('error'), mxUtils.bind(this, function () {
                            mxUtils.popup(svg);
                        }));
                    }
                });

                if (format == 'svg') {
                    var bg = this.editor.graph.background;

                    if (transparent || bg == mxConstants.NONE) {
                        bg = null;
                    }

                    // Sets or disables alternate text for foreignObjects. Disabling is needed
                    // because PhantomJS seems to ignore switch statements and paint all text.
                    var svgRoot = this.editor.graph.getSvg(bg, null, null, null, null, ignoreSelection);

                    if (addShadow) {
                        this.editor.graph.addSvgShadow(svgRoot);
                    }

                    // Embeds the images in the SVG output (async)
                    this.convertImages(svgRoot, mxUtils.bind(this, mxUtils.bind(this, function (svgRoot2) {
                        this.spinner.stop();

                        saveSvg('<?xml version="1.0" encoding="UTF-8"?>\n' +
                            '<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">\n' +
                            mxUtils.getXml(svgRoot2));
                    })));
                } else {
                    filename = basename + '.svg';

                    svg = this.getFileData(false, true, null, mxUtils.bind(this, function (svg) {
                        this.spinner.stop();
                        saveSvg(svg);
                    }), ignoreSelection);
                }
            } else {
                if (format == 'xmlpng') {
                    filename = basename + '.png';
                } else if (format == 'jpeg') {
                    filename = basename + '.jpg';
                }

                this.saveRequest(filename, format, mxUtils.bind(this, function (newTitle, base64) {
                    try {
                        var prev = this.editor.graph.pageVisible;

                        if (pageVisible != null) {
                            this.editor.graph.pageVisible = pageVisible;
                        }

                        var req = this.createDownloadRequest(newTitle, format, ignoreSelection, base64, transparent, currentPage, scale, border, grid);
                        this.editor.graph.pageVisible = prev;

                        return req;
                    } catch (e) {
                        this.handleError(e);
                    }
                }));
            }
        } catch (e) {
            this.handleError(e);
        }
    };

    /**
     * Translates this point by the given vector.
     *
     * @param {number} dx X-coordinate of the translation.
     * @param {number} dy Y-coordinate of the translation.
     */
    EditorUi.prototype.createDownloadRequest = function (filename, format, ignoreSelection, base64, transparent, currentPage, scale, border, grid) {
        var graph = this.editor.graph;
        var bounds = graph.getGraphBounds();

        // Exports only current page for images that does not contain file data, but for
        // the other formats with XML included or pdf with all pages, we need to send the complete data and use
        // the from/to URL parameters to specify the page to be exported.
        var data = this.getFileData(true, null, null, null, ignoreSelection, currentPage == false ? false : format != 'xmlpng');
        var range = '';
        var allPages = '';

        if (bounds.width * bounds.height > MAX_AREA || data.length > MAX_REQUEST_SIZE) {
            throw {message: mxResources.get('drawingTooLarge')};
        }

        var embed = '0';

        if (format == 'pdf' && currentPage == false) {
            allPages = '&allPages=1';
        }

        if (format == 'xmlpng') {
            embed = '1';
            format = 'png';

            // Finds the current page number
            if (this.pages != null && this.currentPage != null) {
                for (var i = 0; i < this.pages.length; i++) {
                    if (this.pages[i] == this.currentPage) {
                        range = '&from=' + i;
                        break;
                    }
                }
            }
        }

        var bg = graph.background;

        if (format == 'png' && transparent) {
            bg = mxConstants.NONE;
        } else if (!transparent && (bg == null || bg == mxConstants.NONE)) {
            bg = '#ffffff';
        }

        var extras = {globalVars: graph.getExportVariables()};

        if (grid) {
            extras.grid = {
                size: graph.gridSize,
                steps: graph.view.gridSteps,
                color: graph.view.gridColor
            };
        }

        return new mxXmlRequest(EXPORT_URL, 'format=' + format + range + allPages +
            '&bg=' + ((bg != null) ? bg : mxConstants.NONE) +
            '&base64=' + base64 + '&embedXml=' + embed + '&xml=' +
            encodeURIComponent(data) + ((filename != null) ?
                '&filename=' + encodeURIComponent(filename) : '') +
            '&extras=' + encodeURIComponent(JSON.stringify(extras)) +
            (scale != null ? '&scale=' + scale : '') +
            (border != null ? '&border=' + border : ''));
    };

    /**
     * Translates this point by the given vector.
     *
     * @param {number} dx X-coordinate of the translation.
     * @param {number} dy Y-coordinate of the translation.
     */
    EditorUi.prototype.setMode = function (mode, remember) {
        this.mode = mode;
    };

    /**
     * Loads the given file descriptor. The descriptor may define the following properties:
     *
     * - url: The url to load the data from (proxy is used if CORS is not enabled)
     * - data: The data to be inserted. If both, data and url are defined, then the data
     * is preprendended to the data returned from the given URL.
     * - format: Currently, only 'csv' is supported as an optional value. Default is XML.
     * - update: Optional URL to fetch updates from (POST request with the page XML).
     * - interval: Optional interval for fetching updates. Default is 60000 (60 seconds).
     */
    EditorUi.prototype.loadDescriptor = function (desc, success, error) {
        var hash = window.location.hash;

        var loadData = mxUtils.bind(this, function (data) {
            var realData = (desc.data != null) ? desc.data : '';

            if (data != null && data.length > 0) {
                if (realData.length > 0) {
                    realData += '\n';
                }

                realData += data;
            }

            var xml = (desc.format != 'csv' && realData.length > 0) ? realData : this.emptyDiagramXml;
            var tempFile = new LocalFile(this, xml, (urlParams['title'] != null) ?
                decodeURIComponent(urlParams['title']) : this.defaultFilename, true);
            tempFile.getHash = function () {
                return hash;
            };
            this.fileLoaded(tempFile);

            if (desc.format == 'csv') {
                this.importCsv(realData, mxUtils.bind(this, function (cells) {
                    this.editor.undoManager.clear();
                    this.editor.setModified(false);
                    this.editor.setStatus('');
                }));
            }

            // Installs updates
            if (desc.update != null) {
                var interval = (desc.interval != null) ? parseInt(desc.interval) : 60000;
                var currentThread = null;

                var doUpdate = mxUtils.bind(this, function () {
                    var page = this.currentPage;

                    mxUtils.post(desc.update, 'xml=' + encodeURIComponent(
                        mxUtils.getXml(this.editor.getGraphXml())),
                        mxUtils.bind(this, function (req) {
                            if (page === this.currentPage) {
                                if (req.getStatus() >= 200 && req.getStatus() <= 300) {
                                    var doc = this.updateDiagram(req.getText());
                                    schedule();
                                } else {
                                    this.handleError({message: mxResources.get('error') + ' ' + req.getStatus()});
                                }
                            }
                        }), mxUtils.bind(this, function (err) {
                            this.handleError(err);
                        }));
                });

                var schedule = mxUtils.bind(this, function () {
                    window.clearTimeout(currentThread);
                    currentThread = window.setTimeout(doUpdate, interval);
                });

                this.editor.addListener('pageSelected', mxUtils.bind(this, function () {
                    schedule();
                    doUpdate();
                }));

                schedule();
                doUpdate();
            }

            if (success != null) {
                success();
            }
        });

        if (desc.url != null && desc.url.length > 0) {
            var realUrl = desc.url;

            if ((/^https?:\/\//.test(realUrl)) && !this.editor.isCorsEnabledForUrl(realUrl)) {
                realUrl = PROXY_URL + '?url=' + encodeURIComponent(realUrl);
            }

            // LATER: Remove cache-control header
            this.loadUrl(realUrl, mxUtils.bind(this, function (data) {
                loadData(data);
            }), mxUtils.bind(this, function (err) {
                if (error != null) {
                    error(err)
                }
            }));
        } else {
            loadData('');
        }
    };

    /**
     * Translates this point by the given vector.
     *
     * @param {number} dx X-coordinate of the translation.
     * @param {number} dy Y-coordinate of the translation.
     */
    EditorUi.prototype.updateDiagram = function (xml) {
        var doc = null;
        var ui = this;

        function createOverlay(desc) {
            var overlay = new mxCellOverlay(desc.image || graph.warningImage,
                desc.tooltip, desc.align, desc.valign, desc.offset);

            // Installs a handler for clicks on the overlay
            overlay.addListener(mxEvent.CLICK, function (sender, evt) {
                ui.alert(desc.tooltip);
            });

            return overlay;
        };

        if (xml != null && xml.length > 0) {
            doc = mxUtils.parseXml(xml);
            var node = (doc != null) ? doc.documentElement : null;

            if (node != null && node.nodeName == 'updates') {
                var graph = this.editor.graph;
                var model = graph.getModel();
                model.beginUpdate();
                var fit = null;

                try {
                    node = node.firstChild;

                    while (node != null) {
                        if (node.nodeName == 'update') {
                            // Resolves the cell ID
                            var cell = model.getCell(node.getAttribute('id'));

                            if (cell != null) {
                                // Changes the value
                                try {
                                    var value = node.getAttribute('value');

                                    if (value != null) {
                                        var valueNode = mxUtils.parseXml(value).documentElement;

                                        if (valueNode != null) {
                                            if (valueNode.getAttribute('replace-value') == '1') {
                                                model.setValue(cell, valueNode);
                                            } else {
                                                var attrs = valueNode.attributes;

                                                for (var j = 0; j < attrs.length; j++) {
                                                    graph.setAttributeForCell(cell, attrs[j].nodeName,
                                                        (attrs[j].nodeValue.length > 0) ? attrs[j].nodeValue : null);
                                                }
                                            }
                                        }
                                    }
                                } catch (e) {
                                    if (window.console != null) {
                                        console.log('Error in value for ' + cell.id + ': ' + e);
                                    }
                                }

                                // Changes the style
                                try {
                                    var style = node.getAttribute('style');

                                    if (style != null) {
                                        graph.model.setStyle(cell, style);
                                    }
                                } catch (e) {
                                    if (window.console != null) {
                                        console.log('Error in style for ' + cell.id + ': ' + e);
                                    }
                                }

                                // Adds or removes an overlay icon
                                try {
                                    var icon = node.getAttribute('icon');

                                    if (icon != null) {
                                        var desc = (icon.length > 0) ? JSON.parse(icon) : null;

                                        if (desc == null || !desc.append) {
                                            graph.removeCellOverlays(cell);
                                        }

                                        if (desc != null) {
                                            graph.addCellOverlay(cell, createOverlay(desc));
                                        }
                                    }
                                } catch (e) {
                                    if (window.console != null) {
                                        console.log('Error in icon for ' + cell.id + ': ' + e);
                                    }
                                }

                                // Replaces the geometry
                                try {
                                    var geo = node.getAttribute('geometry');

                                    if (geo != null) {
                                        geo = JSON.parse(geo);
                                        var curr = graph.getCellGeometry(cell);

                                        if (curr != null) {
                                            curr = curr.clone();

                                            // Partially overwrites geometry
                                            for (key in geo) {
                                                var val = parseFloat(geo[key]);

                                                if (key == 'dx') {
                                                    curr.x += val;
                                                } else if (key == 'dy') {
                                                    curr.y += val;
                                                } else if (key == 'dw') {
                                                    curr.width += val;
                                                } else if (key == 'dh') {
                                                    curr.height += val;
                                                } else {
                                                    curr[key] = parseFloat(geo[key]);
                                                }
                                            }

                                            graph.model.setGeometry(cell, curr);
                                        }
                                    }
                                } catch (e) {
                                    if (window.console != null) {
                                        console.log('Error in icon for ' + cell.id + ': ' + e);
                                    }
                                }
                            } // if cell != null
                        } // if node.nodeName == 'update
                        else if (node.nodeName == 'model') {
                            // Finds first child element
                            var dataNode = node.firstChild;

                            while (dataNode != null && dataNode.nodeType != mxConstants.NODETYPE_ELEMENT) {
                                dataNode = dataNode.nextSibling;
                            }

                            if (dataNode != null) {
                                var dec = new mxCodec(node.firstChild);
                                dec.decode(dataNode, model);
                            }
                        } else if (node.nodeName == 'view') {
                            if (node.hasAttribute('scale')) {
                                graph.view.scale = parseFloat(node.getAttribute('scale'));
                            }

                            if (node.hasAttribute('dx') || node.hasAttribute('dy')) {
                                graph.view.translate = new mxPoint(parseFloat(node.getAttribute('dx') || 0),
                                    parseFloat(node.getAttribute('dy') || 0));
                            }
                        } else if (node.nodeName == 'fit') {
                            if (node.hasAttribute('max-scale')) {
                                fit = parseFloat(node.getAttribute('max-scale'));
                            } else {
                                fit = 1;
                            }
                        }

                        node = node.nextSibling;
                    } // end of while
                } finally {
                    model.endUpdate();
                }

                if (fit != null && this.chromelessResize) {
                    this.chromelessResize(true, fit);
                }
            }
        }

        return doc;
    };

    /**
     * Constructs a filename for a copy of the given file.
     */
    EditorUi.prototype.getCopyFilename = function (file, timestamp) {
        var title = (file != null && file.getTitle() != null) ?
            file.getTitle() : this.defaultFilename;

        // Handles extension
        var extension = '';
        var dot = title.lastIndexOf('.');

        if (dot >= 0) {
            extension = title.substring(dot);
            title = title.substring(0, dot);
        }

        if (timestamp) {
            function getFormattedTime() {
                var today = new Date();
                var y = today.getFullYear();
                // JavaScript months are 0-based.
                var m = today.getMonth() + 1;
                var d = today.getDate();
                var h = today.getHours();
                var mi = today.getMinutes();
                var s = today.getSeconds();

                return y + "-" + m + "-" + d + "-" + h + "-" + mi + "-" + s;
            }

            var ts = new Date();
            title += ' ' + getFormattedTime();
        }

        title = mxResources.get('copyOf', [title]) + extension;

        return title;
    };

    /**
     * Translates this point by the given vector.
     *
     * @param {number} dx X-coordinate of the translation.
     * @param {number} dy Y-coordinate of the translation.
     */
    EditorUi.prototype.fileLoaded = function (file, noDialogs) {
        var oldFile = this.getCurrentFile();
        this.fileLoadedError = null;
        this.setCurrentFile(null);
        var result = false;
        this.hideDialog();

        if (oldFile != null) {
            oldFile.removeListener(this.descriptorChangedListener);
            oldFile.close();
        }

        this.editor.graph.model.clear();
        this.editor.undoManager.clear();

        var noFile = mxUtils.bind(this, function () {
            this.setGraphEnabled(false);
            this.setCurrentFile(null);

            // Keeps initial title if no file existed before
            if (oldFile != null) {
                this.updateDocumentTitle();
            }

            // File might have been loaded halfway
            this.editor.graph.model.clear();
            this.editor.undoManager.clear();
            this.setBackgroundImage(null);

            // Avoids empty hash with no value
            if (!noDialogs && window.location.hash != null && window.location.hash.length > 0) {
                window.location.hash = '';
            }

            if (this.fname != null) {
                this.fnameWrapper.style.display = 'none';
                this.fname.innerHTML = '';
                this.fname.setAttribute('title', mxResources.get('rename'));
            }

            this.editor.setStatus('');
            this.updateUi();

            if (!noDialogs) {
                this.showSplash();
            }
        });

        if (file != null) {
            try {
                // Workaround for delayed scroll repaint with min UI in Safari
                if (mxClient.IS_SF && uiTheme == 'min') {
                    this.diagramContainer.style.visibility = '';
                }
                // Order is significant, current file needed for correct
                // file format for initial save after starting realtime
                this.openingFile = true;
                this.setCurrentFile(file);
                file.addListener('descriptorChanged', this.descriptorChangedListener);
                file.addListener('contentChanged', this.descriptorChangedListener);
                file.open();
                delete this.openingFile;

                // DescriptorChanged updates the enabled state of the graph
                this.setGraphEnabled(true);
                this.setMode(file.getMode());
                this.editor.graph.model.prefix = Editor.guid() + '-';
                this.editor.undoManager.clear();
                this.descriptorChanged();

                this.updateUi();

                // Realtime files have a valid status message
                if (!file.isEditable()) {
                    this.editor.setStatus('<span class="geStatusAlert" style="margin-left:8px;">' +
                        mxUtils.htmlEntities(mxResources.get('readOnly')) + '</span>');
                }
                // Handles modified state after error of loading new file
                else if (file.isModified()) {
                    file.addUnsavedStatus();

                    // Restores unsaved data
                    if (file.backupPatch != null) {
                        file.patch([file.backupPatch]);
                    }
                } else {
                    this.editor.setStatus('');
                }

                if (!this.editor.isChromelessView() || this.editor.editable) {
                    this.editor.graph.selectUnlockedLayer();
                    this.showLayersDialog();
                    this.restoreLibraries();

                    // Workaround for no initial focus in FF
                    if (window.self !== window.top) {
                        window.focus();
                    }
                } else if (this.editor.graph.isLightboxView()) {
                    this.lightboxFit();
                }

                if (this.chromelessResize) {
                    this.chromelessResize();
                }

                this.editor.fireEvent(new mxEventObject('fileLoaded'));
                result = true;

                if (!this.isOffline() && file.getMode() != null) {
                    EditorUi.logEvent({
                        category: file.getMode().toUpperCase() + '-OPEN-FILE-' + file.getHash(),
                        action: 'size_' + file.getSize(),
                        label: 'autosave_' + ((this.editor.autosave) ? 'on' : 'off')
                    });
                }

                if (this.editor.editable && this.mode == file.getMode() &&
                    file.getMode() != App.MODE_DEVICE && file.getMode() != null) {
                    try {
                        this.addRecent({id: file.getHash(), title: file.getTitle(), mode: file.getMode()});
                    } catch (e) {
                        // ignore
                    }
                }

                try {
                    mxSettings.setOpenCounter(mxSettings.getOpenCounter() + 1);
                    mxSettings.save();
                } catch (e) {
                    // ignore
                }
            } catch (e) {
                this.fileLoadedError = e;

                // Makes sure the file does not save the invalid UI model and overwrites anything important
                if (window.console != null) {
                    console.error(e);
                    console.log('error in fileLoaded:', file, e);
                }

                if (EditorUi.enableLogging && !this.isOffline()) {
                    try {
                        var img = new Image();
                        var logDomain = window.DRAWIO_LOG_URL != null ? window.DRAWIO_LOG_URL : '';
                        img.src = logDomain + '/log?v=' + encodeURIComponent(EditorUi.VERSION) +
                            '&msg=errorInFileLoaded:url:' + encodeURIComponent(window.location.href) +
                            ((e != null && e.message != null) ? ':err:' + encodeURIComponent(e.message) : '') +
                            ((e != null && e.stack != null) ? '&stack=' + encodeURIComponent(e.stack) : '');
                    } catch (e) {
                        // ignore
                    }
                }

                // Asynchronous handling of errors
                var fn = mxUtils.bind(this, function () {
                    // Removes URL parameter and reloads the page
                    if (urlParams['url'] != null && this.spinner.spin(document.body, mxResources.get('reconnecting'))) {
                        window.location.search = this.getSearch(['url']);
                    } else if (oldFile != null) {
                        this.fileLoaded(oldFile);
                    } else {
                        noFile();
                    }
                });

                if (!noDialogs) {
                    this.handleError(e, mxResources.get('errorLoadingFile'), fn, true);
                } else {
                    fn();
                }
            }
        } else {
            noFile();
        }

        return result;
    };

    /**
     * Creates a hash value for the current file.
     */
    EditorUi.prototype.getHashValueForPages = function (pages, details) {
        // TODO: Avoid encoding to XML to make it faster
        var hash = 0;
        var model = new mxGraphModel();
        var codec = new mxCodec();

        if (details != null) {
            details.byteCount = 0;
            details.attrCount = 0;
            details.eltCount = 0;
            details.nodeCount = 0;
        }

        for (var i = 0; i < pages.length; i++) {
            this.updatePageRoot(pages[i]);
            var diagram = pages[i].node.cloneNode(false);

            // FIXME: Check why names can be null in newer files
            // ignore in hash and do not diff null names for now
            diagram.removeAttribute('name');

            // Model is only a holder for the root
            model.root = pages[i].root;
            var xmlNode = codec.encode(model);
            this.editor.graph.saveViewState(pages[i].viewState, xmlNode, true);

            // Local defaults may be different in files so ignore
            xmlNode.removeAttribute('pageWidth');
            xmlNode.removeAttribute('pageHeight');

            diagram.appendChild(xmlNode);

            if (details != null) {
                details.eltCount += diagram.getElementsByTagName('*').length;
                details.nodeCount += diagram.getElementsByTagName('mxCell').length;
            }

            hash = ((hash << 5) - hash + this.hashValue(diagram, function (obj, key, value, isXml) {
                // Ignores JS machine rounding errors in known numeric attributes
                // eg. 412.33333333333326 (Webkit/FF) == 412.33333333333325 (Edge/IE11)
                if (isXml && (obj.nodeName == 'mxGeometry' || obj.nodeName == 'mxPoint') &&
                    (key == 'x' || key == 'y' || key == 'width' || key == 'height')) {
                    return Math.round(value);
                }
                // Workaround for previous in patch written to mxCell in 10.0.23
                else if (isXml && obj.nodeName == 'mxCell' && key == 'previous') {
                    return null;
                } else {
                    return value;
                }
            }, details)) << 0;
        }

        return hash;
    };

    /**
     * Creates a hash value for the given object. Replacer returns the value of the
     * property or attribute for the given object or XML node.
     */
    EditorUi.prototype.hashValue = function (obj, replacer, details) {
        var hash = 0;

        // Checks for XML nodes
        if (obj != null && typeof obj === 'object' && typeof obj.nodeType === 'number' &&
            typeof obj.nodeName === 'string' && typeof obj.getAttribute === 'function') {
            if (obj.nodeName != null) {
                hash = hash ^ this.hashValue(obj.nodeName, replacer, details);
            }

            if (obj.attributes != null) {
                if (details != null) {
                    details.attrCount += obj.attributes.length;
                }

                for (var i = 0; i < obj.attributes.length; i++) {
                    var key = obj.attributes[i].name;
                    var value = (replacer != null) ? replacer(obj, key, obj.attributes[i].value, true) : obj.attributes[i].value;

                    if (value != null) {
                        hash = hash ^ (this.hashValue(key, replacer, details) +
                            this.hashValue(value, replacer, details));
                    }
                }
            }

            if (obj.childNodes != null) {
                for (var i = 0; i < obj.childNodes.length; i++) {
                    hash = ((hash << 5) - hash + this.hashValue(
                        obj.childNodes[i], replacer, details)) << 0;
                }
            }
        } else if (obj != null && typeof obj !== 'function') {
            var str = String(obj);
            var temp = 0;

            if (details != null) {
                details.byteCount += str.length;
            }

            for (var i = 0; i < str.length; i++) {
                temp = ((temp << 5) - temp + str.charCodeAt(i)) << 0;
            }

            hash = hash ^ temp;
        }

        return hash;
    };

    /**
     * Adds empty implementation
     */
    EditorUi.prototype.descriptorChanged = function () {
        // empty
    };

    /**
     * Hook for subclassers.
     */
    EditorUi.prototype.restoreLibraries = function () {
    };

    /**
     * Hook for subclassers.
     */
    EditorUi.prototype.saveLibrary = function (name, images, file, mode, noSpin, noReload, fn) {
    };

    /**
     * Translates this point by the given vector.
     *
     * @param {number} dx X-coordinate of the translation.
     * @param {number} dy Y-coordinate of the translation.
     */
    EditorUi.prototype.createLibraryDataFromImages = function (images) {
        var doc = mxUtils.createXmlDocument();
        var library = doc.createElement('mxlibrary');
        mxUtils.setTextContent(library, JSON.stringify(images));
        doc.appendChild(library);

        return mxUtils.getXml(doc);
    };

    /**
     * Translates this point by the given vector.
     *
     * @param {number} dx X-coordinate of the translation.
     * @param {number} dy Y-coordinate of the translation.
     */
    EditorUi.prototype.closeLibrary = function (file) {
        if (file != null) {
            this.removeLibrarySidebar(file.getHash());

            if (file.constructor != LocalLibrary) {
                mxSettings.removeCustomLibrary(file.getHash());
            }

            if (file.title == '.scratchpad') {
                this.scratchpad = null;
            }
        }
    };

    /**
     * Translates this point by the given vector.
     *
     * @param {number} dx X-coordinate of the translation.
     * @param {number} dy Y-coordinate of the translation.
     */
    EditorUi.prototype.removeLibrarySidebar = function (id) {
        var elts = this.sidebar.palettes[id];

        if (elts != null) {
            for (var i = 0; i < elts.length; i++) {
                elts[i].parentNode.removeChild(elts[i]);
            }

            delete this.sidebar.palettes[id];
        }
    };

    /**
     * Changes the position of the library in the sidebar
     */
    EditorUi.prototype.repositionLibrary = function (nextChild) {
        var c = this.sidebar.container;

        if (nextChild == null) {
            var elts = this.sidebar.palettes['L.scratchpad'];

            if (elts == null) {
                elts = this.sidebar.palettes['search'];
            }

            if (elts != null) {
                nextChild = elts[elts.length - 1].nextSibling;
            }
        }

        nextChild = (nextChild != null) ? nextChild : c.firstChild.nextSibling.nextSibling;

        var content = c.lastChild;
        var title = content.previousSibling;

        c.insertBefore(content, nextChild);
        c.insertBefore(title, content);
    }

    /**
     * Translates this point by the given vector.
     *
     * @param {number} dx X-coordinate of the translation.
     * @param {number} dy Y-coordinate of the translation.
     */
    EditorUi.prototype.loadLibrary = function (file) {
        var doc = mxUtils.parseXml(file.getData());

        if (doc.documentElement.nodeName == 'mxlibrary') {
            var images = JSON.parse(mxUtils.getTextContent(doc.documentElement));
            this.libraryLoaded(file, images, doc.documentElement.getAttribute('title'));
        } else {
            throw {message: mxResources.get('notALibraryFile')};
        }
    };

    /**
     * Translates this point by the given vector.
     *
     * @param {number} dx X-coordinate of the translation.
     * @param {number} dy Y-coordinate of the translation.
     */
    EditorUi.prototype.getLibraryStorageHint = function (file) {
        return '';
    };

    /**
     * Translates this point by the given vector.
     *
     * @param {number} dx X-coordinate of the translation.
     * @param {number} dy Y-coordinate of the translation.
     */
    EditorUi.prototype.libraryLoaded = function (file, images, optionalTitle) {
        if (this.sidebar == null) {
            return;
        }

        if (file.constructor != LocalLibrary) {
            mxSettings.addCustomLibrary(file.getHash());
        }

        if (file.title == '.scratchpad') {
            this.scratchpad = file;
        }

        var elts = this.sidebar.palettes[file.getHash()];
        var nextSibling = (elts != null) ? elts[elts.length - 1].nextSibling : null;

        // Removes existing sidebar entry for this library
        this.removeLibrarySidebar(file.getHash());

        // Adds entries to search index
        // KNOWN: Existing entries are not replaced after edit of custom library
        if (this.sidebar != null && images != null) {
            this.sidebar.addEntries(images);
        }

        // Adds new sidebar entry for this library
        var tmp = (optionalTitle != null && optionalTitle.length > 0) ? optionalTitle : file.getTitle();
        var contentDiv = this.sidebar.addPalette(file.getHash(), tmp, true, mxUtils.bind(this, function (content) {
            addImages(images, content);
        }));

        this.repositionLibrary(nextSibling);

        // Adds tooltip for backend
        var title = contentDiv.parentNode.previousSibling;
        var tip = title.getAttribute('title');

        if (tip != null && tip.length > 0 && file.title != '.scratchpad') {
            title.setAttribute('title', this.getLibraryStorageHint(file) + '\n' + tip);
        }

        var buttons = document.createElement('div');
        buttons.style.position = 'absolute';
        buttons.style.right = '0px';
        buttons.style.top = '0px';
        buttons.style.padding = '8px'

        // Workaround for CSS error in IE8 (standards and quirks)
        if (!mxClient.IS_QUIRKS && document.documentMode != 8) {
            buttons.style.backgroundColor = 'inherit';
        }

        title.style.position = 'relative';

        var btnWidth = 18;
        var btn = document.createElement('img');
        btn.setAttribute('src', Dialog.prototype.closeImage);
        btn.setAttribute('title', mxResources.get('close'));
        btn.setAttribute('valign', 'absmiddle');
        btn.setAttribute('border', '0');
        btn.style.margin = '0 3px';

        var saveBtn = null;

        if (file.title != '.scratchpad' || this.closableScratchpad) {
            buttons.appendChild(btn);

            mxEvent.addListener(btn, 'click', mxUtils.bind(this, function (evt) {
                // Workaround for close after any button click in IE8/quirks
                if (!mxEvent.isConsumed(evt)) {
                    var fn = mxUtils.bind(this, function () {
                        this.closeLibrary(file);
                    });

                    if (saveBtn != null) {
                        this.confirm(mxResources.get('allChangesLost'), null, fn,
                            mxResources.get('cancel'), mxResources.get('discardChanges'));
                    } else {
                        fn();
                    }

                    mxEvent.consume(evt);
                }
            }));
        }

        if (file.isEditable()) {
            var graph = this.editor.graph;
            var spinBtn = null;

            var editLibrary = mxUtils.bind(this, function (evt) {
                this.showLibraryDialog(file.getTitle(), contentDiv, images, file, file.getMode());
                mxEvent.consume(evt);
            });

            var saveLibrary = mxUtils.bind(this, function (evt) {
                file.setModified(true);

                if (file.isAutosave()) {
                    if (spinBtn != null && spinBtn.parentNode != null) {
                        spinBtn.parentNode.removeChild(spinBtn);
                    }

                    spinBtn = btn.cloneNode(false);
                    spinBtn.setAttribute('src', Editor.spinImage);
                    spinBtn.setAttribute('title', mxResources.get('saving'));
                    spinBtn.style.cursor = 'default';
                    spinBtn.style.marginRight = '2px';
                    spinBtn.style.marginTop = '-2px';
                    buttons.insertBefore(spinBtn, buttons.firstChild);
                    title.style.paddingRight = (buttons.childNodes.length * btnWidth) + 'px';

                    this.saveLibrary(file.getTitle(), images, file, file.getMode(), true, true, function () {
                        if (spinBtn != null && spinBtn.parentNode != null) {
                            spinBtn.parentNode.removeChild(spinBtn);
                            title.style.paddingRight = (buttons.childNodes.length * btnWidth) + 'px';
                        }
                    });
                } else if (saveBtn == null) {
                    saveBtn = btn.cloneNode(false);
                    saveBtn.setAttribute('src', IMAGE_PATH + '/download.png');
                    saveBtn.setAttribute('title', mxResources.get('save'));
                    buttons.insertBefore(saveBtn, buttons.firstChild);

                    mxEvent.addListener(saveBtn, 'click', mxUtils.bind(this, function (evt) {
                        this.saveLibrary(file.getTitle(), images, file, file.getMode(),
                            file.constructor == LocalLibrary, true, function () {
                                if (saveBtn != null && !file.isModified()) {
                                    title.style.paddingRight = (buttons.childNodes.length * btnWidth) + 'px';
                                    saveBtn.parentNode.removeChild(saveBtn);
                                    saveBtn = null;
                                }
                            });

                        mxEvent.consume(evt);
                    }));

                    title.style.paddingRight = (buttons.childNodes.length * btnWidth) + 'px';
                }
            });

            var addCells = mxUtils.bind(this, function (cells, bounds, evt, title) {
                cells = graph.cloneCells(mxUtils.sortCells(graph.model.getTopmostCells(cells)));

                // Translates cells to origin
                for (var i = 0; i < cells.length; i++) {
                    var geo = graph.getCellGeometry(cells[i]);

                    if (geo != null) {
                        geo.translate(-bounds.x, -bounds.y);
                    }
                }

                contentDiv.appendChild(this.sidebar.createVertexTemplateFromCells(
                    cells, bounds.width, bounds.height, title || '', true, false, false));

                var xml = Graph.compress(mxUtils.getXml(this.editor.graph.encodeCells(cells)));
                var entry = {xml: xml, w: bounds.width, h: bounds.height};

                if (title != null) {
                    entry.title = title;
                }

                images.push(entry);
                saveLibrary(evt);

                if (dropTarget != null && dropTarget.parentNode != null && images.length > 0) {
                    dropTarget.parentNode.removeChild(dropTarget);
                    dropTarget = null;
                }
            });

            var addSelection = mxUtils.bind(this, function (evt) {
                if (!graph.isSelectionEmpty()) {
                    var cells = graph.getSelectionCells();
                    var bounds = graph.view.getBounds(cells);

                    var s = graph.view.scale;

                    bounds.x /= s;
                    bounds.y /= s;
                    bounds.width /= s;
                    bounds.height /= s;

                    bounds.x -= graph.view.translate.x;
                    bounds.y -= graph.view.translate.y;

                    addCells(cells, bounds);
                } else if (graph.getRubberband().isActive()) {
                    graph.getRubberband().execute(evt);
                    graph.getRubberband().reset();
                } else {
                    this.showError(mxResources.get('error'), mxResources.get('nothingIsSelected'), mxResources.get('ok'));
                }

                mxEvent.consume(evt);
            });

            // Adds drop handler from graph
            mxEvent.addGestureListeners(contentDiv, function () {
            }, mxUtils.bind(this, function (evt) {
                if (graph.isMouseDown && graph.panningManager != null && graph.graphHandler.shape != null) {
                    graph.graphHandler.shape.node.style.visibility = 'hidden';
                    contentDiv.style.backgroundColor = '#f1f3f4';
                    contentDiv.style.cursor = 'copy';
                    graph.panningManager.stop();
                    graph.autoScroll = false;

                    if (graph.graphHandler.guide != null) {
                        graph.graphHandler.guide.setVisible(false);
                    }

                    if (graph.graphHandler.hint != null) {
                        graph.graphHandler.hint.style.visibility = 'hidden';
                    }

                    mxEvent.consume(evt);
                }
            }), mxUtils.bind(this, function (evt) {
                if (graph.isMouseDown && graph.panningManager != null && graph.graphHandler != null) {
                    contentDiv.style.backgroundColor = '';
                    contentDiv.style.cursor = 'default';
                    this.sidebar.showTooltips = true;
                    graph.panningManager.stop();
                    graph.graphHandler.reset();
                    graph.isMouseDown = false;
                    graph.autoScroll = true;
                    addSelection(evt);
                    mxEvent.consume(evt);
                }
            }));

            // Handles mouse leaving the library and restoring move
            mxEvent.addListener(contentDiv, 'mouseleave', mxUtils.bind(this, function (evt) {
                if (graph.isMouseDown && graph.graphHandler.shape != null) {
                    graph.graphHandler.shape.node.style.visibility = 'visible';
                    contentDiv.style.backgroundColor = '';
                    contentDiv.style.cursor = '';
                    graph.autoScroll = true;

                    if (graph.graphHandler.guide != null) {
                        graph.graphHandler.guide.setVisible(true);
                    }

                    if (graph.graphHandler.hint != null) {
                        graph.graphHandler.hint.style.visibility = 'visible';
                    }
                }
            }));

            // Adds drop handler from filesystem
            if (Graph.fileSupport) {
                mxEvent.addListener(contentDiv, 'dragover', mxUtils.bind(this, function (evt) {
                    contentDiv.style.backgroundColor = '#f1f3f4';
                    evt.dataTransfer.dropEffect = 'copy';
                    contentDiv.style.cursor = 'copy';
                    this.sidebar.hideTooltip();
                    evt.stopPropagation();
                    evt.preventDefault();
                }));

                mxEvent.addListener(contentDiv, 'drop', mxUtils.bind(this, function (evt) {
                    contentDiv.style.cursor = '';
                    contentDiv.style.backgroundColor = '';

                    if (evt.dataTransfer.files.length > 0) {
                        this.importFiles(evt.dataTransfer.files, 0, 0, this.maxImageSize, mxUtils.bind(this, function (data, mimeType, x, y, w, h, img, doneFn, file) {
                            if (data != null && mimeType.substring(0, 6) == 'image/') {
                                var style = 'shape=image;verticalLabelPosition=bottom;verticalAlign=top;aspect=fixed;image=' +
                                    this.convertDataUri(data);
                                var cells = [new mxCell('', new mxGeometry(0, 0, w, h), style)];
                                cells[0].vertex = true;

                                addCells(cells, new mxRectangle(0, 0, w, h), evt, (mxEvent.isAltDown(evt)) ? null : img.substring(0, img.lastIndexOf('.')).replace(/_/g, ' '));

                                if (dropTarget != null && dropTarget.parentNode != null && images.length > 0) {
                                    dropTarget.parentNode.removeChild(dropTarget);
                                    dropTarget = null;
                                }
                            } else {
                                var done = false;

                                var doImport = mxUtils.bind(this, function (theData, theMimeType) {
                                    if (theData != null && theMimeType == 'text/xml') {
                                        var doc = mxUtils.parseXml(theData);

                                        if (doc.documentElement.nodeName == 'mxlibrary') {
                                            try {
                                                var temp = JSON.parse(mxUtils.getTextContent(doc.documentElement));
                                                addImages(temp, contentDiv);
                                                images = images.concat(temp);
                                                saveLibrary(evt);
                                                this.spinner.stop();
                                                done = true;
                                            } catch (e) {
                                                // ignore
                                            }
                                        } else if (doc.documentElement.nodeName == 'mxfile') {
                                            try {
                                                var pages = doc.documentElement.getElementsByTagName('diagram');

                                                for (var i = 0; i < pages.length; i++) {
                                                    var cells = this.stringToCells(Editor.getDiagramNodeXml(pages[i]));
                                                    var size = this.editor.graph.getBoundingBoxFromGeometry(cells);
                                                    addCells(cells, new mxRectangle(0, 0, size.width, size.height), evt);
                                                }

                                                done = true;
                                            } catch (e) {
                                                if (window.console != null) {
                                                    console.log('error in drop handler:', e);
                                                }
                                            }
                                        }
                                    }

                                    if (!done) {
                                        this.spinner.stop();
                                        this.handleError({message: mxResources.get('errorLoadingFile')})
                                    }

                                    if (dropTarget != null && dropTarget.parentNode != null && images.length > 0) {
                                        dropTarget.parentNode.removeChild(dropTarget);
                                        dropTarget = null;
                                    }
                                });

                                if (file != null && img != null && ((/(\.v(dx|sdx?))($|\?)/i.test(img)) || /(\.vs(x|sx?))($|\?)/i.test(img))) {
                                    this.importVisio(file, function (xml) {
                                        doImport(xml, 'text/xml');
                                    }, null, img);
                                } else if (!this.isOffline() && new XMLHttpRequest().upload && this.isRemoteFileFormat(data, img) && file != null) {
                                    this.parseFile(file, mxUtils.bind(this, function (xhr) {
                                        if (xhr.readyState == 4) {
                                            this.spinner.stop();

                                            if (xhr.status >= 200 && xhr.status <= 299) {
                                                doImport(xhr.responseText, 'text/xml');
                                            } else {
                                                this.handleError({
                                                        message: mxResources.get((xhr.status == 413) ?
                                                            'drawingTooLarge' : 'invalidOrMissingFile')
                                                    },
                                                    mxResources.get('errorLoadingFile'));
                                            }
                                        }
                                    }));
                                } else {
                                    doImport(data, mimeType);
                                }
                            }
                        }));
                    }

                    evt.stopPropagation();
                    evt.preventDefault();
                }));

                mxEvent.addListener(contentDiv, 'dragleave', function (evt) {
                    contentDiv.style.cursor = '';
                    contentDiv.style.backgroundColor = '';
                    evt.stopPropagation();
                    evt.preventDefault();
                });
            }

            btn = btn.cloneNode(false);
            btn.setAttribute('src', Editor.editImage);
            btn.setAttribute('title', mxResources.get('edit'));
            buttons.insertBefore(btn, buttons.firstChild);

            mxEvent.addListener(btn, 'click', editLibrary);
            mxEvent.addListener(contentDiv, 'dblclick', function (evt) {
                if (mxEvent.getSource(evt) == contentDiv) {
                    editLibrary(evt);
                }
            });

            var btn2 = btn.cloneNode(false);
            btn2.setAttribute('src', Editor.plusImage);
            btn2.setAttribute('title', mxResources.get('add'));
            buttons.insertBefore(btn2, buttons.firstChild);
            mxEvent.addListener(btn2, 'click', addSelection);
        }

        title.appendChild(buttons);
        title.style.paddingRight = (buttons.childNodes.length * btnWidth) + 'px';
    };

    /**
     * Adds the library entries to the given DOM node.
     */
    EditorUi.prototype.addLibraryEntries = function (imgs, content) {
        for (var i = 0; i < imgs.length; i++) {
            var img = imgs[i];
            var data = img.data;

            if (data != null) {
                data = this.convertDataUri(data);
                var s = 'shape=image;verticalLabelPosition=bottom;verticalAlign=top;imageAspect=0;';

                if (img.aspect == 'fixed') {
                    s += 'aspect=fixed;'
                }

                content.appendChild(this.sidebar.createVertexTemplate(s + 'image=' +
                    data, img.w, img.h, '', img.title || '', false, false, true));
            } else if (img.xml != null) {
                var cells = this.stringToCells(Graph.decompress(img.xml));

                if (cells.length > 0) {
                    content.appendChild(this.sidebar.createVertexTemplateFromCells(
                        cells, img.w, img.h, img.title || '', true, false, true));
                }
            }
        }
    };

    /**
     * Extracts the resource for the current language from the given multi language
     * resource object of the form {es: "...", de: "...", main: "..."} where the keys
     * are country codes and main defines the fallback if no resource for the current
     * country code exists.
     */
    EditorUi.prototype.getResource = function (obj) {
        return (obj != null) ? (obj[mxLanguage] || obj.main) : null;
    };

    /**
     * EditorUi Overrides
     */
    EditorUi.prototype.footerHeight = 0;

    if (urlParams['offline'] == '1' || EditorUi.isElectronApp) {
        //EditorUi.prototype.footerHeight = 4;
    } else {
        if (urlParams['savesidebar'] == '1') {
            Sidebar.prototype.thumbWidth = 64;
            Sidebar.prototype.thumbHeight = 64;
        }

        //EditorUi.prototype.footerHeight = (screen.width >= 760 && screen.height >= 240) ? 46 : 0;

        // Fetches footer from page
        EditorUi.prototype.createFooter = function () {
            var footer = document.getElementById('geFooter');

            if (footer != null) {
//				footer.style.visibility = 'hidden';
//
//				// Adds button to hide the footer
//				var img = document.createElement('img');
//				img.setAttribute('border', '0');
//				img.setAttribute('src', Dialog.prototype.closeImage);
//				img.setAttribute('title', mxResources.get('hide'));
//				footer.appendChild(img)
//
//				if (mxClient.IS_QUIRKS)
//				{
//					img.style.position = 'relative';
//					img.style.styleFloat = 'right';
//					img.style.top = '-30px';
//					img.style.left = '164px';
//					img.style.cursor = 'pointer';
//				}
//
//				mxEvent.addListener(img, 'click', mxUtils.bind(this, function()
//				{
//					this.hideFooter();
//				}));
            }

            return footer;
        };
    }

    EditorUi.initTheme = function () {
        if (uiTheme == 'atlas') {
            mxClient.link('stylesheet', STYLE_PATH + '/atlas.css');

            if (typeof Toolbar !== 'undefined') {
                Toolbar.prototype.unselectedBackground = (mxClient.IS_QUIRKS) ? 'none' : 'linear-gradient(rgb(255, 255, 255) 0px, rgb(242, 242, 242) 100%)';
                Toolbar.prototype.selectedBackground = 'rgb(242, 242, 242)';
            }

            Editor.prototype.initialTopSpacing = 3;
            EditorUi.prototype.menubarHeight = 41;
            EditorUi.prototype.toolbarHeight = 38;
        } else if (uiTheme == 'dark') {
            mxClient.link('stylesheet', STYLE_PATH + '/dark.css');

            Dialog.backdropColor = '#2a2a2a';
            Graph.prototype.defaultThemeName = 'darkTheme';
            Graph.prototype.defaultPageBackgroundColor = '#2a2a2a';
            Graph.prototype.defaultPageBorderColor = '#505759';
            Format.prototype.inactiveTabBackgroundColor = 'black';
            BaseFormatPanel.prototype.buttonBackgroundColor = '#2a2a2a';
            Sidebar.prototype.dragPreviewBorder = '1px dashed #cccccc';
            mxGraphHandler.prototype.previewColor = '#cccccc';
            StyleFormatPanel.prototype.defaultStrokeColor = '#cccccc';

            if (mxClient.IS_SVG) {
                Editor.helpImage = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAMAAAAoLQ9TAAAAP1BMVEUAAAD///////////////////////////////////////////////////////////////////////////////9Du/pqAAAAFXRSTlMAT30qCJRBboyDZyCgRzUUdF46MJlgXETgAAAAeklEQVQY022O2w4DIQhEQUURda/9/28tUO2+7CQS5sgQ4F1RapX78YUwRqQjTU8ILqQfKerTKTvACJ4nLX3krt+8aS82oI8aQC4KavRgtvEW/mDvsICgA03PSGRr79MqX1YPNIxzjyqtw8ZnnRo4t5a5undtJYRywau+ds4Cyza3E6YAAAAASUVORK5CYII=';
                Editor.checkmarkImage = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABUAAAAVCAMAAACeyVWkAAAARVBMVEUAAACZmZkICAgEBASNjY2Dg4MYGBiTk5N5eXl1dXVmZmZQUFBCQkI3NzceHh4MDAykpKSJiYl+fn5sbGxaWlo/Pz8SEhK96uPlAAAAAXRSTlMAQObYZgAAAE5JREFUGNPFzTcSgDAQQ1HJGUfy/Y9K7V1qeOUfzQifCQZai1XHaz11LFysbDbzgDSSWMZiETz3+b8yNUc/MMsktxuC8XQBSncdLwz+8gCCggGXzBcozAAAAABJRU5ErkJggg==';
            }
        }
    };

    EditorUi.initTheme();

    /**
     * Hides the footer.
     */
    EditorUi.prototype.hideFooter = function () {
        var footer = document.getElementById('geFooter');

        if (footer != null) {
            this.footerHeight = 0;
            footer.style.display = 'none';
            this.refresh();
        }
    };

    /**
     * Shows the footer.
     */
    EditorUi.prototype.showFooter = function (height) {
        var footer = document.getElementById('geFooter');

        if (footer != null) {
            this.footerHeight = height;
            footer.style.display = 'inline';
            this.refresh();
        }
    };

    /**
     * Overrides image dialog to add image search and Google+.
     */
    EditorUi.prototype.showImageDialog = function (title, value, fn, ignoreExisting, convertDataUri) {
        // KNOWN: IE+FF don't return keyboard focus after image dialog (calling focus doesn't help)
        var dlg = new ImageDialog(this, title, value, fn, ignoreExisting, convertDataUri);
        this.showDialog(dlg.container, (Graph.fileSupport) ? 475 : 360, (Graph.fileSupport) ? 260 : 90, true, true);
        dlg.init();
    };

    /**
     * Hides the current menu.
     */
    EditorUi.prototype.showBackgroundImageDialog = function (apply) {
        apply = (apply != null) ? apply : mxUtils.bind(this, function (image) {
            var change = new ChangePageSetup(this, null, image);
            change.ignoreColor = true;

            this.editor.graph.model.execute(change);
        });
        var dlg = new BackgroundImageDialog(this, mxUtils.bind(this, function (image) {
            apply(image);
        }));
        this.showDialog(dlg.container, 430, 265, true, true);
        dlg.init();
    };

    /**
     * Hides the current menu.
     */
    EditorUi.prototype.showLibraryDialog = function (name, sidebar, images, file, mode) {
        var dlg = new LibraryDialog(this, name, sidebar, images, file, mode);

        this.showDialog(dlg.container, 640, 440, true, false, mxUtils.bind(this, function (cancel) {
            if (cancel && this.getCurrentFile() == null && urlParams['embed'] != '1') {
                this.showSplash();
            }
        }));

        dlg.init();
    };

    /**
     * Overridden to update after view state changes.
     */
    var editorUiCreateFormat = EditorUi.prototype.createFormat;

    EditorUi.prototype.createFormat = function (container) {
        var format = editorUiCreateFormat.apply(this, arguments);

        this.editor.graph.addListener('viewStateChanged', mxUtils.bind(this, function (evt) {
            if (this.editor.graph.isSelectionEmpty()) {
                format.refresh();
            }
        }));

        return format;
    };

    /**
     * Hook for sidebar footer container.
     */
    EditorUi.prototype.createSidebarFooterContainer = function () {
        var div = this.createDiv('geSidebarContainer geSidebarFooter');
        div.style.position = 'absolute';
        div.style.overflow = 'hidden';

        var elt2 = document.createElement('a');
        elt2.className = 'geTitle';
        elt2.style.color = '#DF6C0C';
        elt2.style.fontWeight = 'bold';
        elt2.style.height = '100%';
        elt2.style.paddingTop = '9px';
        elt2.innerHTML = '<span style="font-size:18px;margin-right:5px;">+</span>';

        mxUtils.write(elt2, mxResources.get('moreShapes') + '...');

        // Prevents focus
        mxEvent.addListener(elt2, (mxClient.IS_POINTER) ? 'pointerdown' : 'mousedown',
            mxUtils.bind(this, function (evt) {
                evt.preventDefault();
            }));

        mxEvent.addListener(elt2, 'click', mxUtils.bind(this, function (evt) {
            this.actions.get('shapes').funct();
            mxEvent.consume(evt);
        }));

        div.appendChild(elt2);

        return div;
    };

    /**
     * Translates this point by the given vector.
     *
     * @param {number} dx X-coordinate of the translation.
     * @param {number} dy Y-coordinate of the translation.
     */
    EditorUi.prototype.handleError = function (resp, title, fn, invokeFnOnClose, notFoundMessage) {
        var resume = (this.spinner != null && this.spinner.pause != null) ? this.spinner.pause() : function () {
        };
        var e = (resp != null && resp.error != null) ? resp.error : resp;

        if (e != null || title != null) {
            var msg = mxUtils.htmlEntities(mxResources.get('unknownError'));
            var btn = mxResources.get('ok');
            var retry = null;
            title = (title != null) ? title : mxResources.get('error');

            if (e != null) {
                if (e.retry != null) {
                    btn = mxResources.get('cancel');
                    retry = function () {
                        resume();
                        e.retry();
                    };
                }

                if (e.code == 404 || e.status == 404 || e.code == 403) {
                    if (e.code == 403) {
                        if (e.message != null) {
                            msg = mxUtils.htmlEntities(e.message);
                        } else {
                            msg = mxUtils.htmlEntities(mxResources.get('accessDenied'));
                        }
                    } else {
                        msg = (notFoundMessage != null) ? notFoundMessage :
                            mxUtils.htmlEntities(mxResources.get('fileNotFoundOrDenied') +
                                ((this.drive != null && this.drive.user != null) ? ' (' + this.drive.user.displayName +
                                    ', ' + this.drive.user.email + ')' : ''));
                    }

                    var id = window.location.hash;

                    // #U handles case where we tried to fallback to Google File and
                    // hash property still shows the public URL we tried to load
                    if (id != null && (id.substring(0, 2) == '#G' ||
                        id.substring(0, 45) == '#Uhttps%3A%2F%2Fdrive.google.com%2Fuc%3Fid%3D') &&
                        ((resp != null && resp.error != null && ((resp.error.errors != null &&
                            resp.error.errors.length > 0 && resp.error.errors[0].reason == 'fileAccess') ||
                            (resp.error.data != null && resp.error.data.length > 0 &&
                                resp.error.data[0].reason == 'fileAccess'))) ||
                            e.code == 404 || e.status == 404)) {
                        id = (id.substring(0, 2) == '#U') ? id.substring(45, id.lastIndexOf('%26ex')) : id.substring(2);

                        // Special case where the button must have a different label and function
                        this.showError(title, msg, mxResources.get('openInNewWindow'), mxUtils.bind(this, function () {
                            this.editor.graph.openLink('https://drive.google.com/open?id=' + id);
                            this.handleError(resp, title, fn, invokeFnOnClose, notFoundMessage)
                        }), retry, mxResources.get('changeUser'), mxUtils.bind(this, function () {
                            if (this.spinner.spin(document.body, mxResources.get('loading'))) {
                                this.drive.clearUserId();
                                gapi.auth.signOut();

                                // Reload page to reset client auth
                                window.location.reload();
                            }
                        }), mxResources.get('cancel'), mxUtils.bind(this, function () {
                            window.location.hash = '';
                        }), 480, 150);

                        return;
                    }
                } else if (e.message != null) {
                    msg = mxUtils.htmlEntities(e.message);
                } else if (e.response != null && e.response.error != null) {
                    msg = mxUtils.htmlEntities(e.response.error);
                } else if (typeof window.App !== 'undefined') {
                    if (e.code == App.ERROR_TIMEOUT) {
                        msg = mxUtils.htmlEntities(mxResources.get('timeout'));
                    } else if (e.code == App.ERROR_BUSY) {
                        msg = mxUtils.htmlEntities(mxResources.get('busy'));
                    }
                }
            }

            var btn3 = null;
            var fn3 = null;

            if (e != null && e.helpLink != null) {
                btn3 = mxResources.get('help');

                fn3 = mxUtils.bind(this, function () {
                    return this.editor.graph.openLink(e.helpLink);
                });
            }

            this.showError(title, msg, btn, fn, retry, null, null, btn3, fn3,
                null, null, null, (invokeFnOnClose) ? fn : null);
        } else if (fn != null) {
            fn();
        }
    };

    /**
     * Translates this point by the given vector.
     *
     * @param {number} dx X-coordinate of the translation.
     * @param {number} dy Y-coordinate of the translation.
     */
    EditorUi.prototype.alert = function (msg, fn) {
        var dlg = new ErrorDialog(this, null, msg, mxResources.get('ok'), fn);
        this.showDialog(dlg.container, 340, 135, true, false);
        dlg.init();
    };

    /**
     * Translates this point by the given vector.
     *
     * @param {number} dx X-coordinate of the translation.
     * @param {number} dy Y-coordinate of the translation.
     */
    EditorUi.prototype.confirm = function (msg, okFn, cancelFn, okLabel, cancelLabel, closable) {
        var resume = (this.spinner != null && this.spinner.pause != null) ? this.spinner.pause() : function () {
        };

        var dlg = new ConfirmDialog(this, msg, function () {
            resume();

            if (okFn != null) {
                okFn();
            }
        }, function () {
            resume();

            if (cancelFn != null) {
                cancelFn();
            }
        }, okLabel, cancelLabel);
        this.showDialog(dlg.container, 340, 135, true, closable);
        dlg.init();
    };

    /**
     * Translates this point by the given vector.
     *
     * @param {number} dx X-coordinate of the translation.
     * @param {number} dy Y-coordinate of the translation.
     */
    EditorUi.prototype.setCurrentFile = function (file) {
        if (file != null) {
            file.opened = new Date();
        }

        this.currentFile = file;
    };

    /**
     * Translates this point by the given vector.
     *
     * @param {number} dx X-coordinate of the translation.
     * @param {number} dy Y-coordinate of the translation.
     */
    EditorUi.prototype.getCurrentFile = function () {
        return this.currentFile;
    };

    /**
     * Handling for canvas export.
     */

    /**
     * See fixme in convertMath for client-side image generation with math.
     */
    EditorUi.prototype.isExportToCanvas = function () {
        return mxClient.IS_CHROMEAPP || (!this.editor.graph.mathEnabled && this.useCanvasForExport);
    };

    /**
     * Translates this point by the given vector.
     *
     * @param {number} dx X-coordinate of the translation.
     * @param {number} dy Y-coordinate of the translation.
     */
    EditorUi.prototype.createSvgDataUri = function (svg) {
        return 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svg)));
    };

    /**
     *
     */
    EditorUi.prototype.createImageDataUri = function (canvas, xml, format, dpi) {
        var data = canvas.toDataURL('image/' + format);

        // Checks if output is invalid or empty
        if (data.length <= 6 || data == canvas.cloneNode(false).toDataURL('image/' + format)) {
            throw {message: 'Invalid image'};
        }

        if (xml != null) {
            data = this.writeGraphModelToPng(data, 'tEXt', 'mxfile', encodeURIComponent(xml));
        }

        if (dpi > 0) {
            data = this.writeGraphModelToPng(data, 'pHYs', 'dpi', dpi);
        }

        return data;
    };

    /**
     *
     */
    EditorUi.prototype.saveCanvas = function (canvas, xml, format, ignorePageName, dpi) {
        var ext = ((format == 'jpeg') ? 'jpg' : format);
        var filename = this.getBaseFilename(ignorePageName) + '.' + ext;
        var data = this.createImageDataUri(canvas, xml, format, dpi);
        this.saveData(filename, ext, data.substring(data.lastIndexOf(',') + 1), 'image/' + format, true);
    };

    /**
     * Returns true if files should be saved using <saveLocalFile>.
     */
    EditorUi.prototype.isLocalFileSave = function () {
        return ((urlParams['save'] != 'remote' && (mxClient.IS_IE ||
            (typeof window.Blob !== 'undefined' && typeof window.URL !== 'undefined')) &&
            document.documentMode != 9 && document.documentMode != 8 &&
            document.documentMode != 7 && !mxClient.IS_QUIRKS) ||
            this.isOfflineApp() || mxClient.IS_IOS);
    };

    /**
     * Translates this point by the given vector.
     *
     * @param {number} dx X-coordinate of the translation.
     * @param {number} dy Y-coordinate of the translation.
     */
    EditorUi.prototype.showTextDialog = function (title, text) {
        var dlg = new TextareaDialog(this, title, text, null, null, mxResources.get('close'));
        dlg.textarea.style.width = '600px';
        dlg.textarea.style.height = '380px';
        this.showDialog(dlg.container, 620, 460, true, true, null, null, null, null, true);
        dlg.init();
        document.execCommand('selectall', false, null);
    };

    /**
     * Translates this point by the given vector.
     *
     * @param {number} dx X-coordinate of the translation.
     * @param {number} dy Y-coordinate of the translation.
     */
    EditorUi.prototype.doSaveLocalFile = function (data, filename, mimeType, base64Encoded, format) {
        // Newer versions of IE
        if (window.Blob && navigator.msSaveOrOpenBlob) {
            var blob = (base64Encoded) ?
                this.base64ToBlob(data, mimeType) :
                new Blob([data], {type: mimeType})
            navigator.msSaveOrOpenBlob(blob, filename);
        }
        // Older versions of IE (binary not supported)
        else if (mxClient.IS_IE) {
            var win = window.open('about:blank', '_blank');

            if (win == null) {
                mxUtils.popup(data, true);
            } else {
                win.document.write(data);
                win.document.close();
                win.document.execCommand('SaveAs', true, filename);
                win.close();
            }
        }
//		else if (mxClient.IS_IOS)
//		{
//			this.showTextDialog(filename + ':', data);
//		}
        else {
            var a = document.createElement('a');

            // Workaround for mxXmlRequest.simulate no longer working in Safari/PaleMoon
            // if this is used (ie PNG export broken after XML export in Safari/PaleMoon).
            var useDownload = !mxClient.IS_SF && navigator.userAgent.indexOf("PaleMoon/") < 0 &&
                typeof a.download !== 'undefined';

            // Workaround for Chromium 65 cross-domain anchor download issue
            if (mxClient.IS_GC) {
                var raw = navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./)
                var vers = raw ? parseInt(raw[2], 10) : false;
                useDownload = vers == 65 ? false : useDownload;
            }

            if (useDownload || this.isOffline()) {
                a.href = URL.createObjectURL((base64Encoded) ?
                    this.base64ToBlob(data, mimeType) :
                    new Blob([data], {type: mimeType}));

                if (useDownload) {
                    a.download = filename;
                } else {
                    // Workaround for same window in Safari
                    a.setAttribute('target', '_blank');
                }

                document.body.appendChild(a);

                try {
                    window.setTimeout(function () {
                        URL.revokeObjectURL(a.href);
                    }, 0);

                    a.click();
                    a.parentNode.removeChild(a);
                } catch (e) {
                    // ignore
                }
            } else {
                var req = this.createEchoRequest(data, filename, mimeType, base64Encoded, format);

                req.simulate(document, '_blank');
            }
        }
    };

    /**
     * Translates this point by the given vector.
     *
     * @param {number} dx X-coordinate of the translation.
     * @param {number} dy Y-coordinate of the translation.
     */
    EditorUi.prototype.createEchoRequest = function (data, filename, mimeType, base64Encoded, format, base64Response) {
        var param = (typeof (pako) === 'undefined' || true) ? 'xml=' + encodeURIComponent(data) :
            'data=' + encodeURIComponent(Graph.compress(data));

        return new mxXmlRequest(SAVE_URL, param +
            ((mimeType != null) ? '&mime=' + mimeType : '') +
            ((format != null) ? '&format=' + format : '') +
            ((base64Response != null) ? '&base64=' + base64Response : '') +
            ((filename != null) ? '&filename=' + encodeURIComponent(filename) : '') +
            ((base64Encoded) ? '&binary=1' : ''));
    };

    /**
     * Translates this point by the given vector.
     *
     * @param {number} dx X-coordinate of the translation.
     * @param {number} dy Y-coordinate of the translation.
     */
    EditorUi.prototype.base64ToBlob = function (base64Data, contentType) {
        contentType = contentType || '';
        var sliceSize = 1024;
        var byteCharacters = atob(base64Data);
        var bytesLength = byteCharacters.length;
        var slicesCount = Math.ceil(bytesLength / sliceSize);
        var byteArrays = new Array(slicesCount);

        for (var sliceIndex = 0; sliceIndex < slicesCount; ++sliceIndex) {
            var begin = sliceIndex * sliceSize;
            var end = Math.min(begin + sliceSize, bytesLength);

            var bytes = new Array(end - begin);

            for (var offset = begin, i = 0; offset < end; ++i, ++offset) {
                bytes[i] = byteCharacters[offset].charCodeAt(0);
            }

            byteArrays[sliceIndex] = new Uint8Array(bytes);
        }

        return new Blob(byteArrays, {type: contentType});
    };

    /**
     * Translates this point by the given vector.
     *
     * @param {number} dx X-coordinate of the translation.
     * @param {number} dy Y-coordinate of the translation.
     */
    EditorUi.prototype.saveLocalFile = function (data, filename, mimeType, base64Encoded, format, allowBrowser, allowTab) {
        allowBrowser = (allowBrowser != null) ? allowBrowser : false;
        allowTab = (allowTab != null) ? allowTab : (format != 'vsdx') && (!mxClient.IS_IOS || !navigator.standalone);
        var count = this.getServiceCount(allowBrowser);

        if (isLocalStorage) {
            count++;
        }

        var rowLimit = (count <= 4) ? 2 : (count > 6 ? 4 : 3);

        var dlg = new CreateDialog(this, filename, mxUtils.bind(this, function (newTitle, mode) {
                try {
                    // Opens a new window
                    if (mode == '_blank') {
                        if (mimeType != null && mimeType.substring(0, 6) == 'image/' &&
                            (mimeType.substring(0, 9) != 'image/svg' || mxClient.IS_SVG)) {
                            this.openInNewWindow(data, mimeType, base64Encoded);
                        } else {
                            var win = window.open('about:blank');

                            if (win == null) {
                                mxUtils.popup(data, true);
                            } else {
                                win.document.write('<pre>' + mxUtils.htmlEntities(data, false) + '<pre>');
                                win.document.close();
                            }
                        }
                    } else if (mode == App.MODE_DEVICE || mode == 'download') {
                        this.doSaveLocalFile(data, newTitle, mimeType, base64Encoded);
                    } else if (newTitle != null && newTitle.length > 0) {
                        this.pickFolder(mode, mxUtils.bind(this, function (folderId) {
                            try {
                                this.exportFile(data, newTitle, mimeType, base64Encoded, mode, folderId);
                            } catch (e) {
                                this.handleError(e);
                            }
                        }));
                    }
                } catch (e) {
                    this.handleError(e);
                }
            }), mxUtils.bind(this, function () {
                this.hideDialog();
            }), mxResources.get('saveAs'), mxResources.get('download'), false, allowBrowser, allowTab,
            null, count > 1, rowLimit, data, mimeType, base64Encoded);
        var height = (this.isServices(count)) ? ((count > rowLimit) ? 390 : 270) : 160;
        this.showDialog(dlg.container, 400, height, true, true);
        dlg.init();
    };

    /**
     *
     */
    EditorUi.prototype.openInNewWindow = function (data, mimeType, base64Encoded) {
        // In Google Chrome 60 the code from below produces a blank window
        if (mxClient.IS_GC || mxClient.IS_EDGE || document.documentMode == 11 || document.documentMode == 10) {
            var win = window.open('about:blank');

            if (win == null || win.document == null) {
                mxUtils.popup(data, true);
            } else {
                // Workaround for broken images in SVG output in Chrome
                if (mimeType == 'image/svg+xml') {
                    win.document.write('<html>' + data + '</html>');
                } else {
                    win.document.write('<html><img src="data:' +
                        mimeType + ((base64Encoded) ? ';base64,' +
                            data : ';charset=utf8,' + encodeURIComponent(data)) +
                        '"/></html>');
                }

                win.document.close();
            }
        } else {
            // win.open is workaround for cleared contents in Chrome after delay
            // when using location.replace
            var win = window.open('data:' + mimeType + ((base64Encoded) ? ';base64,' +
                data : ';charset=utf8,' + encodeURIComponent(data)));

            if (win == null || win.document == null) {
                mxUtils.popup(data, true);
            }
        }
    };

    var editoUiAddChromelessToolbarItems = EditorUi.prototype.addChromelessToolbarItems;

    /**
     * Creates a temporary graph instance for rendering off-screen content.
     */
    EditorUi.prototype.addChromelessToolbarItems = function (addButton) {
        if (this.isExportToCanvas()) {
            this.exportDialog = null;

            var exportButton = addButton(mxUtils.bind(this, function (evt) {
                var clickHandler = mxUtils.bind(this, function () {
                    mxEvent.removeListener(this.editor.graph.container, 'click', clickHandler);

                    if (this.exportDialog != null) {
                        this.exportDialog.parentNode.removeChild(this.exportDialog);
                        this.exportDialog = null;
                    }
                });

                if (this.exportDialog != null) {
                    clickHandler.apply(this);
                } else {
                    this.exportDialog = document.createElement('div');
                    var r = exportButton.getBoundingClientRect();

                    mxUtils.setPrefixedStyle(this.exportDialog.style, 'borderRadius', '5px');
                    this.exportDialog.style.position = 'fixed';
                    this.exportDialog.style.textAlign = 'center';
                    this.exportDialog.style.fontFamily = 'Helvetica,Arial';
                    this.exportDialog.style.backgroundColor = '#000000';
                    this.exportDialog.style.width = '50px';
                    this.exportDialog.style.height = '50px';
                    this.exportDialog.style.padding = '4px 2px 4px 2px';
                    this.exportDialog.style.color = '#ffffff';
                    mxUtils.setOpacity(this.exportDialog, 70);
                    this.exportDialog.style.left = r.left + 'px';
                    this.exportDialog.style.bottom = parseInt(this.chromelessToolbar.style.bottom) +
                        this.chromelessToolbar.offsetHeight + 4 + 'px';

                    // Puts the dialog on top of the container z-index
                    var style = mxUtils.getCurrentStyle(this.editor.graph.container);
                    this.exportDialog.style.zIndex = style.zIndex;

                    var spinner = new Spinner({
                        lines: 8, // The number of lines to draw
                        length: 6, // The length of each line
                        width: 5, // The line thickness
                        radius: 6, // The radius of the inner circle
                        rotate: 0, // The rotation offset
                        color: '#fff', // #rgb or #rrggbb
                        speed: 1.5, // Rounds per second
                        trail: 60, // Afterglow percentage
                        shadow: false, // Whether to render a shadow
                        hwaccel: false, // Whether to use hardware acceleration
                        top: '28px',
                        zIndex: 2e9 // The z-index (defaults to 2000000000)
                    });
                    spinner.spin(this.exportDialog);

                    this.exportToCanvas(mxUtils.bind(this, function (canvas) {
                        spinner.stop();

                        this.exportDialog.style.width = 'auto';
                        this.exportDialog.style.height = 'auto';
                        this.exportDialog.style.padding = '10px';

                        var data = this.createImageDataUri(canvas, null, 'png');
                        var img = document.createElement('img');

                        img.style.maxWidth = '140px';
                        img.style.maxHeight = '140px';
                        img.style.cursor = 'pointer';
                        img.style.backgroundColor = 'white';

                        img.setAttribute('title', mxResources.get('openInNewWindow'));
                        img.setAttribute('border', '0');
                        img.setAttribute('src', data);

                        this.exportDialog.appendChild(img);

                        mxEvent.addListener(img, 'click', mxUtils.bind(this, function () {
                            this.openInNewWindow(data.substring(data.indexOf(',') + 1), 'image/png', true);
                            clickHandler.apply(this, arguments);
                        }));
                    }), null, this.thumbImageCache, null, mxUtils.bind(this, function (e) {
                        this.spinner.stop();
                        this.handleError(e);
                    }));

                    mxEvent.addListener(this.editor.graph.container, 'click', clickHandler);
                    document.body.appendChild(this.exportDialog);
                }

                mxEvent.consume(evt);
            }), Editor.cameraLargeImage, mxResources.get('export'));
        }

        editoUiAddChromelessToolbarItems.apply(this, arguments);
    };


    /**
     * Translates this point by the given vector.
     *
     * @param {number} dx X-coordinate of the translation.
     * @param {number} dy Y-coordinate of the translation.
     */
    EditorUi.prototype.saveData = function (filename, format, data, mime, base64Encoded) {
        if (this.isLocalFileSave()) {
            this.saveLocalFile(data, filename, mime, base64Encoded, format);
        } else {
            this.saveRequest(filename, format, mxUtils.bind(this, function (newTitle, base64) {
                return this.createEchoRequest(data, newTitle, mime, base64Encoded, format, base64);
            }), data, base64Encoded, mime);
        }
    };

    /**
     * Translates this point by the given vector.
     *
     * Last 3 argument are optional and must only be used if the data can be stored as is on the client
     * side without requiring a server roundtrip.
     *
     * @param {number} dx X-coordinate of the translation.
     * @param {number} dy Y-coordinate of the translation.
     */
    EditorUi.prototype.saveRequest = function (filename, format, fn, data, base64Encoded, mimeType, allowTab) {
        allowTab = (allowTab != null) ? allowTab : !mxClient.IS_IOS || !navigator.standalone;
        var count = this.getServiceCount(false);

        if (isLocalStorage) {
            count++;
        }

        var rowLimit = (count <= 4) ? 2 : (count > 6 ? 4 : 3);

        var dlg = new CreateDialog(this, filename, mxUtils.bind(this, function (newTitle, mode) {
                if (mode == '_blank' || newTitle != null && newTitle.length > 0) {
                    var base64 = (mode == App.MODE_DEVICE || mode == 'download' || mode == null || mode == '_blank') ? '0' : '1';
                    var xhr = fn((mode == '_blank') ? null : newTitle, base64);

                    if (xhr != null) {
                        if (mode == App.MODE_DEVICE || mode == 'download' || mode == '_blank') {
                            xhr.simulate(document, '_blank');
                        } else {
                            this.pickFolder(mode, mxUtils.bind(this, function (folderId) {
                                mimeType = (mimeType != null) ? mimeType : ((format == 'pdf') ?
                                    'application/pdf' : 'image/' + format);

                                // Workaround for no roundtrip required if data is available on client-side
                                // TODO: Refactor the saveData/saveRequest call chain for local data
                                if (data != null) {
                                    try {
                                        this.exportFile(data, newTitle, mimeType, true, mode, folderId);
                                    } catch (e) {
                                        this.handleError(e);
                                    }
                                } else if (this.spinner.spin(document.body, mxResources.get('saving'))) {
                                    // LATER: Catch possible mixed content error
                                    // see http://stackoverflow.com/questions/30646417/catching-mixed-content-error
                                    xhr.send(mxUtils.bind(this, function () {
                                        this.spinner.stop();

                                        if (xhr.getStatus() >= 200 && xhr.getStatus() <= 299) {
                                            try {
                                                this.exportFile(xhr.getText(), newTitle, mimeType, true, mode, folderId);
                                            } catch (e) {
                                                this.handleError(e);
                                            }
                                        } else {
                                            this.handleError({message: mxResources.get('errorSavingFile')});
                                        }
                                    }), function (resp) {
                                        this.spinner.stop();
                                        this.handleError(resp);
                                    });
                                }
                            }));
                        }
                    }
                }
            }), mxUtils.bind(this, function () {
                this.hideDialog();
            }), mxResources.get('saveAs'), mxResources.get('download'), false, false, allowTab,
            null, count > 1, rowLimit, data, mimeType, base64Encoded);

        var height = (this.isServices(count)) ? ((count > 4) ? 390 : 270) : 160;
        this.showDialog(dlg.container, 380, height, true, true);
        dlg.init();
    };

    /**
     * Returns whether or not any services should be shown in dialogs
     */
    EditorUi.prototype.isServices = function (count) {
        var noServices = 1; //(mxClient.IS_IOS) ? 0 : 1;
        return count != noServices;
    };

    /**
     *
     */
    EditorUi.prototype.getEditBlankXml = function () {
        return this.getFileData(true);
    };

    /**
     * Hook for subclassers.
     */
    EditorUi.prototype.exportFile = function (data, filename, mimeType, base64Encoded, mode, folderId) {
        // do nothing
    };

    /**
     * Hook for subclassers.
     */
    EditorUi.prototype.pickFolder = function (mode, fn, enabled) {
        fn(null);
    };

    /**
     *
     */
    EditorUi.prototype.exportSvg = function (scale, transparentBackground, ignoreSelection, addShadow,
                                             editable, embedImages, border, noCrop, currentPage, linkTarget) {
        if (this.spinner.spin(document.body, mxResources.get('export'))) {
            var selectionEmpty = this.editor.graph.isSelectionEmpty();
            ignoreSelection = (ignoreSelection != null) ? ignoreSelection : selectionEmpty;
            var bg = (transparentBackground) ? null : this.editor.graph.background;

            if (bg == mxConstants.NONE) {
                bg = null;
            }

            // Handles special case where background is null but transparent is false
            if (bg == null && transparentBackground == false) {
                bg = '#ffffff';
            }

            // Sets or disables alternate text for foreignObjects. Disabling is needed
            // because PhantomJS seems to ignore switch statements and paint all text.
            var svgRoot = this.editor.graph.getSvg(bg, scale, border, noCrop, null,
                ignoreSelection, null, null, (linkTarget == 'blank') ? '_blank' :
                    ((linkTarget == 'self') ? '_top' : null));

            if (addShadow) {
                this.editor.graph.addSvgShadow(svgRoot);
            }

            var filename = this.getBaseFilename() + '.svg';

            var doSave = mxUtils.bind(this, function (svgRoot) {
                this.spinner.stop();

                if (editable) {
                    svgRoot.setAttribute('content', this.getFileData(true, null, null, null, ignoreSelection,
                        currentPage, null, null, null, false));
                }

                if (this.editor.fontCss != null) {
                    var svgDoc = svgRoot.ownerDocument;
                    var style = (svgDoc.createElementNS != null) ?
                        svgDoc.createElementNS(mxConstants.NS_SVG, 'style') : svgDoc.createElement('style');
                    style.setAttribute('type', 'text/css');
                    mxUtils.setTextContent(style, this.editor.fontCss);
                    svgRoot.getElementsByTagName('defs')[0].appendChild(style);
                }

                var svg = '<?xml version="1.0" encoding="UTF-8"?>\n' +
                    '<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">\n' +
                    mxUtils.getXml(svgRoot);

                if (this.isLocalFileSave() || svg.length <= MAX_REQUEST_SIZE) {
                    this.saveData(filename, 'svg', svg, 'image/svg+xml');
                } else {
                    this.handleError({message: mxResources.get('drawingTooLarge')}, mxResources.get('error'), mxUtils.bind(this, function () {
                        mxUtils.popup(svg);
                    }));
                }
            });

            this.convertMath(this.editor.graph, svgRoot, false, mxUtils.bind(this, function () {
                if (embedImages) {
                    // Caches images
                    if (this.thumbImageCache == null) {
                        this.thumbImageCache = new Object();
                    }

                    this.convertImages(svgRoot, doSave, this.thumbImageCache);
                } else {
                    doSave(svgRoot);
                }
            }));
        }
    };

    EditorUi.prototype.addRadiobox = function (div, radioGroupName, label, checked, disabled, disableNewline, visible) {
        return this.addCheckbox(div, label, checked, disabled, disableNewline, visible, true, radioGroupName);
    }

    /**
     *
     */
    EditorUi.prototype.addCheckbox = function (div, label, checked, disabled, disableNewline, visible, asRadio, radioGroupName) {
        visible = (visible != null) ? visible : true;

        var cb = document.createElement('input');
        cb.style.marginRight = '8px';
        cb.style.marginTop = '16px';
        cb.setAttribute('type', asRadio ? 'radio' : 'checkbox');
        var id = 'geCheckbox-' + Editor.guid();
        cb.id = id;

        if (radioGroupName != null) {
            cb.setAttribute('name', radioGroupName);
        }

        if (checked) {
            cb.setAttribute('checked', 'checked');
            cb.defaultChecked = true;
        }

        if (disabled) {
            cb.setAttribute('disabled', 'disabled');
        }

        if (visible) {
            div.appendChild(cb);

            var lbl = document.createElement('label');
            mxUtils.write(lbl, label);
            lbl.setAttribute('for', id);
            div.appendChild(lbl);

            if (!disableNewline) {
                mxUtils.br(div);
            }
        }

        return cb;
    };

    /**
     *
     */
    EditorUi.prototype.addEditButton = function (div, lightbox) {
        var edit = this.addCheckbox(div, mxResources.get('edit') + ':', true, null, true);
        edit.style.marginLeft = '24px';

        var file = this.getCurrentFile();
        var editUrl = '';

        if (file != null && file.getMode() != App.MODE_DEVICE && file.getMode() != App.MODE_BROWSER) {
            editUrl = window.location.href;
        }

        var editSelect = document.createElement('select');
        editSelect.style.width = '120px';
        editSelect.style.marginLeft = '8px';
        editSelect.style.marginRight = '10px';
        editSelect.className = 'geBtn';

        var blankOption = document.createElement('option');
        blankOption.setAttribute('value', 'blank');
        mxUtils.write(blankOption, mxResources.get('makeCopy'));
        editSelect.appendChild(blankOption);

        var customOption = document.createElement('option');
        customOption.setAttribute('value', 'custom');
        mxUtils.write(customOption, mxResources.get('custom') + '...');
        editSelect.appendChild(customOption);

        div.appendChild(editSelect);

        mxEvent.addListener(editSelect, 'change', mxUtils.bind(this, function () {
            if (editSelect.value == 'custom') {
                var dlg2 = new FilenameDialog(this, editUrl, mxResources.get('ok'), function (value) {
                    if (value != null) {
                        editUrl = value;
                    } else {
                        editSelect.value = 'blank';
                    }
                }, mxResources.get('url'), null, null, null, null, function () {
                    editSelect.value = 'blank';
                });
                this.showDialog(dlg2.container, 300, 80, true, false);
                dlg2.init();
            }
        }));

        mxEvent.addListener(edit, 'change', mxUtils.bind(this, function () {
            if (edit.checked && (lightbox == null || lightbox.checked)) {
                editSelect.removeAttribute('disabled');
            } else {
                editSelect.setAttribute('disabled', 'disabled');
            }
        }));

        mxUtils.br(div);

        return {
            getLink: function () {
                return (edit.checked) ? ((editSelect.value === 'blank') ? '_blank' : editUrl) : null;
            },
            getEditInput: function () {
                return edit;
            },
            getEditSelect: function () {
                return editSelect;
            }
        };
    }

    /**
     *
     */
    EditorUi.prototype.addLinkSection = function (div, showFrameOption) {
        mxUtils.write(div, mxResources.get('links') + ':');

        var linkSelect = document.createElement('select');
        linkSelect.style.width = '100px';
        linkSelect.style.marginLeft = '8px';
        linkSelect.style.marginRight = '10px';
        linkSelect.className = 'geBtn';

        var autoOption = document.createElement('option');
        autoOption.setAttribute('value', 'auto');
        mxUtils.write(autoOption, mxResources.get('automatic'));
        linkSelect.appendChild(autoOption);

        var blankOption = document.createElement('option');
        blankOption.setAttribute('value', 'blank');
        mxUtils.write(blankOption, mxResources.get('openInNewWindow'));
        linkSelect.appendChild(blankOption);

        var selfOption = document.createElement('option');
        selfOption.setAttribute('value', 'self');
        mxUtils.write(selfOption, mxResources.get('openInThisWindow'));
        linkSelect.appendChild(selfOption);

        if (showFrameOption) {
            var frameOption = document.createElement('option');
            frameOption.setAttribute('value', 'frame');
            mxUtils.write(frameOption, mxResources.get('openInThisWindow') +
                ' (' + mxResources.get('iframe') + ')');
            linkSelect.appendChild(frameOption);
        }

        div.appendChild(linkSelect);

        mxUtils.write(div, mxResources.get('borderColor') + ':');
        var linkColor = '#0000ff';
        var linkButton = null;

        function updateLinkColor() {
            linkButton.innerHTML = '<div style="width:100%;height:100%;box-sizing:border-box;' +
                ((linkColor != null && linkColor != mxConstants.NONE) ?
                    'border:1px solid black;background-color:' + linkColor :
                    'background-position:center center;background-repeat:no-repeat;' +
                    'background-image:url(\'' + Dialog.prototype.closeImage + '\')') + ';"></div>';
        };

        linkButton = mxUtils.button('', mxUtils.bind(this, function (evt) {
            this.pickColor(linkColor || 'none', function (color) {
                linkColor = color;
                updateLinkColor();
            });

            mxEvent.consume(evt);
        }));

        updateLinkColor();
        linkButton.style.padding = (mxClient.IS_FF) ? '4px 2px 4px 2px' : '4px';
        linkButton.style.marginLeft = '4px';
        linkButton.style.height = '22px';
        linkButton.style.width = '22px';
        linkButton.style.position = 'relative';
        linkButton.style.top = (mxClient.IS_IE || mxClient.IS_IE11 || mxClient.IS_EDGE) ? '6px' : '1px';
        linkButton.className = 'geColorBtn';
        div.appendChild(linkButton);
        mxUtils.br(div);

        return {
            getColor: function () {
                return linkColor;
            },
            getTarget: function () {
                return linkSelect.value;
            },
            focus: function () {
                linkSelect.focus();
            }
        };
    }

    /**
     *
     */
    EditorUi.prototype.createLink = function (linkTarget, linkColor, allPages, lightbox, editLink, layers, url, ignoreFile) {
        var file = this.getCurrentFile();
        var params = [];

        if (lightbox) {
            params.push('lightbox=1');

            if (linkTarget != 'auto') {
                params.push('target=' + linkTarget);
            }

            if (linkColor != null && linkColor != mxConstants.NONE) {
                params.push('highlight=' + ((linkColor.charAt(0) == '#') ? linkColor.substring(1) : linkColor));
            }

            if (editLink != null && editLink.length > 0) {
                params.push('edit=' + encodeURIComponent(editLink));
            }

            if (layers) {
                params.push('layers=1');
            }

            if (this.editor.graph.foldingEnabled) {
                params.push('nav=1');
            }
        }

        if (allPages && this.currentPage != null && this.pages != null &&
            this.currentPage != this.pages[0]) {
            params.push('page-id=' + this.currentPage.getId());
        }

        var data = '';
        var addTitle = true;

        if (url != null) {
            data = '#U' + encodeURIComponent(url);
        } else {
            var file = this.getCurrentFile();

            // Fallback to non-public URL for Drive files
            if (!ignoreFile && file != null && file.constructor == window.DriveFile) {
                data = '#' + file.getHash();
                addTitle = false;
            } else {
                data = '#R' + encodeURIComponent((allPages) ?
                    this.getFileData(true, null, null, null, null, null, null, true) :
                    Graph.compress(mxUtils.getXml(this.editor.getGraphXml())))
            }
        }

        if (addTitle && file != null && file.getTitle() != null && file.getTitle() != this.defaultFilename) {
            params.push('title=' + encodeURIComponent(file.getTitle()));
        }

        return ((mxClient.IS_CHROMEAPP || EditorUi.isElectronApp || !(/.*\.draw\.io$/.test(window.location.hostname))) ?
            EditorUi.drawHost : 'https://' + window.location.host + '/') +
            ((params.length > 0) ? '?' + params.join('&') : '') + data;
    };

    /**
     *
     */
    EditorUi.prototype.createHtml = function (publicUrl, zoomEnabled, initialZoom, linkTarget,
                                              linkColor, fit, allPages, layers, lightbox, editLink, fn) {
        var s = this.getBasenames();
        var data = {};

        if (linkColor != '' && linkColor != mxConstants.NONE) {
            data.highlight = linkColor;
        }

        if (linkTarget !== 'auto') {
            data.target = linkTarget;
        }

        if (!lightbox) {
            data.lightbox = false;
        }

        data.nav = this.editor.graph.foldingEnabled;
        var zoom = parseInt(initialZoom);

        if (!isNaN(zoom) && zoom != 100) {
            data.zoom = zoom / 100;
        }

        var tb = [];

        if (allPages) {
            tb.push('pages');
            data.resize = true;

            if (this.pages != null && this.currentPage != null) {
                data.page = mxUtils.indexOf(this.pages, this.currentPage);
            }
        }

        if (zoomEnabled) {
            tb.push('zoom');
            data.resize = true;
        }

        if (layers) {
            tb.push('layers');
        }

        if (tb.length > 0) {
            if (lightbox) {
                tb.push('lightbox');
            }

            data.toolbar = tb.join(' ');
        }

        if (editLink != null && editLink.length > 0) {
            data.edit = editLink;
        }

        if (publicUrl != null) {
            data.url = publicUrl;
        } else {
            data.xml = this.getFileData(true, null, null, null, null, !allPages);
        }

        var value = '<div class="mxgraph" style="' +
            ((fit) ? 'max-width:100%;' : '') +
            ((tb != '') ? 'border:1px solid transparent;' : '') +
            '" data-mxgraph="' + mxUtils.htmlEntities(JSON.stringify(data)) + '"></div>';

        var fetchParam = (publicUrl != null) ? '&fetch=' + encodeURIComponent(publicUrl) : '';
        var s2 = (fetchParam.length > 0) ?
            (((urlParams['dev'] == '1') ?
                'https://test.draw.io/embed2.js?dev=1' :
                EditorUi.drawHost + '/embed2.js?')) + fetchParam :
            (((urlParams['dev'] == '1') ?
                'https://test.draw.io/js/viewer.min.js' :
                window.VIEWER_URL ? window.VIEWER_URL : EditorUi.drawHost + '/js/viewer.min.js'));
        var scr = '<script type="text/javascript" src="' + s2 + '"></script>';

        fn(value, scr);
    };

    /**
     *
     */
    EditorUi.prototype.showHtmlDialog = function (btnLabel, helpLink, publicUrl, fn) {
        var div = document.createElement('div');
        div.style.whiteSpace = 'nowrap';
        var graph = this.editor.graph;

        var hd = document.createElement('h3');
        mxUtils.write(hd, mxResources.get('html'));
        hd.style.cssText = 'width:100%;text-align:center;margin-top:0px;margin-bottom:12px';
        div.appendChild(hd);

        var radioSection = document.createElement('div');
        radioSection.style.cssText = 'border-bottom:1px solid lightGray;padding-bottom:8px;margin-bottom:12px;';

        var publicUrlRadio = document.createElement('input');
        publicUrlRadio.style.cssText = 'margin-right:8px;margin-top:8px;margin-bottom:8px;';
        publicUrlRadio.setAttribute('value', 'url');
        publicUrlRadio.setAttribute('type', 'radio');
        publicUrlRadio.setAttribute('name', 'type-embedhtmldialog');

        var copyRadio = publicUrlRadio.cloneNode(true);
        copyRadio.setAttribute('value', 'copy');
        radioSection.appendChild(copyRadio);

        var span = document.createElement('span');
        mxUtils.write(span, mxResources.get('includeCopyOfMyDiagram'));
        radioSection.appendChild(span);

        mxUtils.br(radioSection);
        radioSection.appendChild(publicUrlRadio);

        var span = document.createElement('span');
        mxUtils.write(span, mxResources.get('publicDiagramUrl'));
        radioSection.appendChild(span);

        var file = this.getCurrentFile();

        if (publicUrl == null && file != null && file.constructor == window.DriveFile) {
            var testLink = document.createElement('a');
            testLink.style.paddingLeft = '12px';
            testLink.style.color = 'gray';
            testLink.setAttribute('href', 'javascript:void(0);');
            mxUtils.write(testLink, mxResources.get('share'));
            radioSection.appendChild(testLink);

            mxEvent.addListener(testLink, 'click', mxUtils.bind(this, function () {
                this.hideDialog();
                this.drive.showPermissions(file.getId());
            }));
        }

        copyRadio.setAttribute('checked', 'checked');

        if (publicUrl == null) {
            publicUrlRadio.setAttribute('disabled', 'disabled');
        }

        div.appendChild(radioSection);

        var linkSection = this.addLinkSection(div);
        var zoom = this.addCheckbox(div, mxResources.get('zoom'), true, null, true);
        mxUtils.write(div, ':');

        var zoomInput = document.createElement('input');
        zoomInput.setAttribute('type', 'text');
        zoomInput.style.marginRight = '16px';
        zoomInput.style.width = '60px';
        zoomInput.style.marginLeft = '4px';
        zoomInput.style.marginRight = '12px';
        zoomInput.value = '100%';

        div.appendChild(zoomInput);

        var fit = this.addCheckbox(div, mxResources.get('fit'), true);
        var hasPages = this.pages != null && this.pages.length > 1;
        var allPages = allPages = this.addCheckbox(div, mxResources.get('allPages'), hasPages, !hasPages);
        var layers = this.addCheckbox(div, mxResources.get('layers'), true);
        var lightbox = this.addCheckbox(div, mxResources.get('lightbox'), true);

        var editSection = this.addEditButton(div, lightbox);
        var edit = editSection.getEditInput();
        edit.style.marginBottom = '16px';

        mxEvent.addListener(lightbox, 'change', function () {
            if (lightbox.checked) {
                edit.removeAttribute('disabled');
            } else {
                edit.setAttribute('disabled', 'disabled');
            }

            if (edit.checked && lightbox.checked) {
                editSection.getEditSelect().removeAttribute('disabled');
            } else {
                editSection.getEditSelect().setAttribute('disabled', 'disabled');
            }
        });

        var dlg = new CustomDialog(this, div, mxUtils.bind(this, function () {
            fn((publicUrlRadio.checked) ? publicUrl : null, zoom.checked, zoomInput.value, linkSection.getTarget(),
                linkSection.getColor(), fit.checked, allPages.checked, layers.checked, lightbox.checked,
                editSection.getLink());
        }), null, btnLabel, helpLink);
        this.showDialog(dlg.container, 340, 384, true, true);
        copyRadio.focus();
    };

    /**
     *
     */
    EditorUi.prototype.showPublishLinkDialog = function (title, hideShare, width, height, fn, showFrameOption) {
        var div = document.createElement('div');
        div.style.whiteSpace = 'nowrap';
        var graph = this.editor.graph;

        var hd = document.createElement('h3');
        mxUtils.write(hd, title || mxResources.get('link'));
        hd.style.cssText = 'width:100%;text-align:center;margin-top:0px;margin-bottom:12px';
        div.appendChild(hd);

        var file = this.getCurrentFile();
        var helpLink = 'https://desk.draw.io/support/solutions/articles/16000051941';
        var dy = 0;

        if (file != null && file.constructor == window.DriveFile && !hideShare) {
            dy = 80;
            helpLink = 'https://desk.draw.io/support/solutions/articles/16000039384';
            var hintSection = document.createElement('div');
            hintSection.style.cssText = 'border-bottom:1px solid lightGray;padding-bottom:14px;padding-top:6px;margin-bottom:14px;text-align:center;';

            var text = document.createElement('div');
            text.style.whiteSpace = 'normal';
            mxUtils.write(text, mxResources.get('linkAccountRequired'));
            hintSection.appendChild(text);

            var shareBtn = mxUtils.button(mxResources.get('share'), mxUtils.bind(this, function () {
                this.drive.showPermissions(file.getId());
            }));
            shareBtn.style.marginTop = '12px';
            shareBtn.className = 'geBtn';
            hintSection.appendChild(shareBtn);
            div.appendChild(hintSection);

            var testLink = document.createElement('a');
            testLink.style.paddingLeft = '12px';
            testLink.style.color = 'gray';
            testLink.style.fontSize = '11px';
            testLink.setAttribute('href', 'javascript:void(0);');
            mxUtils.write(testLink, mxResources.get('check'));
            hintSection.appendChild(testLink);

            mxEvent.addListener(testLink, 'click', mxUtils.bind(this, function () {
                if (this.spinner.spin(document.body, mxResources.get('loading'))) {
                    this.getPublicUrl(this.getCurrentFile(), mxUtils.bind(this, function (url) {
                        this.spinner.stop();

                        var dlg = new ErrorDialog(this, null, mxResources.get((url != null) ?
                            'diagramIsPublic' : 'diagramIsNotPublic'), mxResources.get('ok'));
                        this.showDialog(dlg.container, 300, 80, true, false);
                        dlg.init();
                    }));
                }
            }));
        }

        var widthInput = null;
        var heightInput = null;

        if (width != null || height != null) {
            dy += 30;
            mxUtils.write(div, mxResources.get('width') + ':');

            widthInput = document.createElement('input');
            widthInput.setAttribute('type', 'text');
            widthInput.style.marginRight = '16px';
            widthInput.style.width = '50px';
            widthInput.style.marginLeft = '6px';
            widthInput.style.marginRight = '16px';
            widthInput.style.marginBottom = '10px';
            widthInput.value = '100%';

            div.appendChild(widthInput);

            mxUtils.write(div, mxResources.get('height') + ':');

            heightInput = document.createElement('input');
            heightInput.setAttribute('type', 'text');
            heightInput.style.width = '50px';
            heightInput.style.marginLeft = '6px';
            heightInput.style.marginBottom = '10px';
            heightInput.value = height + 'px';

            div.appendChild(heightInput);
            mxUtils.br(div);
        }

        var linkSection = this.addLinkSection(div, showFrameOption);
        var hasPages = this.pages != null && this.pages.length > 1;
        var allPages = null;

        if (file == null || file.constructor != window.DriveFile || hideShare) {
            allPages = this.addCheckbox(div, mxResources.get('allPages'), hasPages, !hasPages);
        }

        var lightbox = this.addCheckbox(div, mxResources.get('lightbox'), true);
        var editSection = this.addEditButton(div, lightbox);
        var edit = editSection.getEditInput();

        var layers = this.addCheckbox(div, mxResources.get('layers'), true);
        layers.style.marginLeft = edit.style.marginLeft;
        layers.style.marginBottom = '16px';
        layers.style.marginTop = '8px';

        mxEvent.addListener(lightbox, 'change', function () {
            if (lightbox.checked) {
                layers.removeAttribute('disabled');
                edit.removeAttribute('disabled');
            } else {
                layers.setAttribute('disabled', 'disabled');
                edit.setAttribute('disabled', 'disabled');
            }

            if (edit.checked && lightbox.checked) {
                editSection.getEditSelect().removeAttribute('disabled');
            } else {
                editSection.getEditSelect().setAttribute('disabled', 'disabled');
            }
        });

        var dlg = new CustomDialog(this, div, mxUtils.bind(this, function () {
            fn(linkSection.getTarget(), linkSection.getColor(),
                (allPages == null) ? true : allPages.checked,
                lightbox.checked, editSection.getLink(),
                layers.checked, (widthInput != null) ? widthInput.value : null,
                (heightInput != null) ? heightInput.value : null);
        }), null, mxResources.get('create'), helpLink);
        this.showDialog(dlg.container, 340, 254 + dy, true, true);

        if (widthInput != null) {
            widthInput.focus();

            if (mxClient.IS_GC || mxClient.IS_FF || document.documentMode >= 5 || mxClient.IS_QUIRKS) {
                widthInput.select();
            } else {
                document.execCommand('selectAll', false, null);
            }
        } else {
            linkSection.focus();
        }
    };

    /**
     *
     */
    EditorUi.prototype.showRemoteExportDialog = function (btnLabel, helpLink, callback, hideInclude, showZoomBorder) {
        var div = document.createElement('div');
        div.style.whiteSpace = 'nowrap';

        var hd = document.createElement('h3');
        mxUtils.write(hd, mxResources.get('image'));
        hd.style.cssText = 'width:100%;text-align:center;margin-top:0px;margin-bottom:' + (showZoomBorder ? '10' : '4') + 'px';
        div.appendChild(hd);

        if (showZoomBorder) {
            mxUtils.write(div, mxResources.get('zoom') + ':');
            var zoomInput = document.createElement('input');
            zoomInput.setAttribute('type', 'text');
            zoomInput.style.marginRight = '16px';
            zoomInput.style.width = '60px';
            zoomInput.style.marginLeft = '4px';
            zoomInput.style.marginRight = '12px';
            zoomInput.value = this.lastExportZoom || '100%';
            div.appendChild(zoomInput);

            mxUtils.write(div, mxResources.get('borderWidth') + ':');
            var borderInput = document.createElement('input');
            borderInput.setAttribute('type', 'text');
            borderInput.style.marginRight = '16px';
            borderInput.style.width = '60px';
            borderInput.style.marginLeft = '4px';
            borderInput.value = this.lastExportBorder || '0';
            div.appendChild(borderInput);
            mxUtils.br(div);
        }

        var selection = this.addCheckbox(div, mxResources.get('selectionOnly'), false,
            this.editor.graph.isSelectionEmpty());
        var include = (hideInclude) ? null : this.addCheckbox(div, mxResources.get('includeCopyOfMyDiagram'), true);

        var graph = this.editor.graph;
        var transparent = (hideInclude) ? null : this.addCheckbox(div, mxResources.get('transparentBackground'),
            graph.background == mxConstants.NONE || graph.background == null);

        if (transparent != null) {
            transparent.style.marginBottom = '16px';
        }

        var dlg = new CustomDialog(this, div, mxUtils.bind(this, function () {
            var scale = parseInt(zoomInput.value) / 100 || 1;
            var border = parseInt(borderInput.value) || 0;

            callback(!selection.checked, (include != null) ? include.checked : false,
                (transparent != null) ? transparent.checked : false, scale, border);
        }), null, btnLabel, helpLink);
        this.showDialog(dlg.container, 300, (showZoomBorder ? 25 : 0) + (hideInclude ? 125 : 210), true, true);
    };

    /**
     *
     */
    EditorUi.prototype.showExportDialog = function (title, embedOption, btnLabel, helpLink, callback,
                                                    cropOption, defaultInclude, format) {
        defaultInclude = (defaultInclude != null) ? defaultInclude : true;

        var div = document.createElement('div');
        div.style.whiteSpace = 'nowrap';
        var graph = this.editor.graph;
        var height = (format == 'jpeg') ? 196 : 300;

        var hd = document.createElement('h3');
        mxUtils.write(hd, title);
        hd.style.cssText = 'width:100%;text-align:center;margin-top:0px;margin-bottom:10px';
        div.appendChild(hd);

        mxUtils.write(div, mxResources.get('zoom') + ':');
        var zoomInput = document.createElement('input');
        zoomInput.setAttribute('type', 'text');
        zoomInput.style.marginRight = '16px';
        zoomInput.style.width = '60px';
        zoomInput.style.marginLeft = '4px';
        zoomInput.style.marginRight = '12px';
        zoomInput.value = this.lastExportZoom || '100%';
        div.appendChild(zoomInput);

        mxUtils.write(div, mxResources.get('borderWidth') + ':');
        var borderInput = document.createElement('input');
        borderInput.setAttribute('type', 'text');
        borderInput.style.marginRight = '16px';
        borderInput.style.width = '60px';
        borderInput.style.marginLeft = '4px';
        borderInput.value = this.lastExportBorder || '0';
        div.appendChild(borderInput);
        mxUtils.br(div);

        var defaultTransparent = false; /*graph.background == mxConstants.NONE || graph.background == null*/
        ;
        var transparent = this.addCheckbox(div, mxResources.get('transparentBackground'),
            defaultTransparent, null, null, format != 'jpeg');
        var selection = this.addCheckbox(div, mxResources.get('selectionOnly'),
            false, graph.isSelectionEmpty());

        var cb6 = document.createElement('input');
        cb6.style.marginTop = '16px';
        cb6.style.marginRight = '8px';
        cb6.style.marginLeft = '24px';
        cb6.setAttribute('disabled', 'disabled');
        cb6.setAttribute('type', 'checkbox');

        if (cropOption) {
            div.appendChild(cb6);
            mxUtils.write(div, mxResources.get('crop'));
            mxUtils.br(div);

            height += 26;

            mxEvent.addListener(selection, 'change', function () {
                if (selection.checked) {
                    cb6.removeAttribute('disabled');
                } else {
                    cb6.setAttribute('disabled', 'disabled');
                }
            });
        }

        if (!graph.isSelectionEmpty()) {
            cb6.setAttribute('checked', 'checked');
            cb6.defaultChecked = true;
        }

        var shadow = this.addCheckbox(div, mxResources.get('shadow'), graph.shadowVisible);

        var cb5 = document.createElement('input');
        cb5.style.marginTop = '16px';
        cb5.style.marginRight = '8px';
        cb5.setAttribute('type', 'checkbox');

        if (this.isOffline() || !this.canvasSupported) {
            cb5.setAttribute('disabled', 'disabled');
        }

        if (embedOption) {
            div.appendChild(cb5);
            mxUtils.write(div, mxResources.get('embedImages'));
            mxUtils.br(div);

            height += 26;
        }

        var grid = null;

        if (format == 'png' || format == 'jpeg') {
            grid = this.addCheckbox(div, mxResources.get('grid'), false, this.isOffline() || !this.canvasSupported, false, true);
            height += 26;
        }

        var include = this.addCheckbox(div, mxResources.get('includeCopyOfMyDiagram'), defaultInclude, null, null, format != 'jpeg');
        var hasPages = this.pages != null && this.pages.length > 1;
        var allPages = this.addCheckbox(div, (hasPages) ? mxResources.get('allPages') : '', hasPages, !hasPages, null, format != 'jpeg');
        allPages.style.marginLeft = '24px';
        allPages.style.marginBottom = '16px';

        if (!hasPages) {
            allPages.style.display = 'none';
        }

        mxEvent.addListener(include, 'change', function () {
            if (include.checked && hasPages) {
                allPages.removeAttribute('disabled');
            } else {
                allPages.setAttribute('disabled', 'disabled');
            }
        });

        if (!defaultInclude || !hasPages) {
            allPages.setAttribute('disabled', 'disabled');
        }

        var linkSelect = document.createElement('select');
        linkSelect.style.maxWidth = '260px';
        linkSelect.style.marginLeft = '8px';
        linkSelect.style.marginRight = '10px';
        linkSelect.className = 'geBtn';


        var autoOption = document.createElement('option');
        autoOption.setAttribute('value', 'auto');
        mxUtils.write(autoOption, mxResources.get('automatic'));
        linkSelect.appendChild(autoOption);

        var blankOption = document.createElement('option');
        blankOption.setAttribute('value', 'blank');
        mxUtils.write(blankOption, mxResources.get('openInNewWindow'));
        linkSelect.appendChild(blankOption);

        var selfOption = document.createElement('option');
        selfOption.setAttribute('value', 'self');
        mxUtils.write(selfOption, mxResources.get('openInThisWindow'));
        linkSelect.appendChild(selfOption);

        if (format == 'svg') {
            mxUtils.write(div, mxResources.get('links') + ':');
            div.appendChild(linkSelect);
            mxUtils.br(div);
            mxUtils.br(div);
            height += 26;
        }

        var dlg = new CustomDialog(this, div, mxUtils.bind(this, function () {
            this.lastExportBorder = borderInput.value;
            this.lastExportZoom = zoomInput.value;

            callback(zoomInput.value, transparent.checked, !selection.checked, shadow.checked,
                include.checked, cb5.checked, borderInput.value, cb6.checked, !allPages.checked,
                linkSelect.value, (grid != null ? grid.checked : null));
        }), null, btnLabel, helpLink);
        this.showDialog(dlg.container, 340, height, true, true, null, null, null, null, true);
        zoomInput.focus();

        if (mxClient.IS_GC || mxClient.IS_FF || document.documentMode >= 5 || mxClient.IS_QUIRKS) {
            zoomInput.select();
        } else {
            document.execCommand('selectAll', false, null);
        }
    };

    /**
     *
     */
    EditorUi.prototype.showEmbedImageDialog = function (fn, title, imageLabel, shadowEnabled, helpLink) {
        var div = document.createElement('div');
        div.style.whiteSpace = 'nowrap';
        var graph = this.editor.graph;

        if (title != null) {
            var hd = document.createElement('h3');
            mxUtils.write(hd, title);
            hd.style.cssText = 'width:100%;text-align:center;margin-top:0px;margin-bottom:4px';
            div.appendChild(hd);
        }

        var fit = this.addCheckbox(div, mxResources.get('fit'), true);
        var shadow = this.addCheckbox(div, mxResources.get('shadow'),
            graph.shadowVisible && shadowEnabled, !shadowEnabled);
        var image = this.addCheckbox(div, imageLabel);
        var lightbox = this.addCheckbox(div, mxResources.get('lightbox'), true);
        var editSection = this.addEditButton(div, lightbox);
        var edit = editSection.getEditInput();

        var hasLayers = graph.model.getChildCount(graph.model.getRoot()) > 1;
        var layers = this.addCheckbox(div, mxResources.get('layers'), hasLayers, !hasLayers);
        layers.style.marginLeft = edit.style.marginLeft;
        layers.style.marginBottom = '12px';
        layers.style.marginTop = '8px';

        mxEvent.addListener(lightbox, 'change', function () {
            if (lightbox.checked) {
                if (hasLayers) {
                    layers.removeAttribute('disabled');
                }

                edit.removeAttribute('disabled');
            } else {
                layers.setAttribute('disabled', 'disabled');
                edit.setAttribute('disabled', 'disabled');
            }

            if (edit.checked && lightbox.checked) {
                editSection.getEditSelect().removeAttribute('disabled');
            } else {
                editSection.getEditSelect().setAttribute('disabled', 'disabled');
            }
        });

        var dlg = new CustomDialog(this, div, mxUtils.bind(this, function () {
            fn(fit.checked, shadow.checked, image.checked, lightbox.checked,
                editSection.getLink(), layers.checked);
        }), null, mxResources.get('embed'), helpLink);
        this.showDialog(dlg.container, 280, 280, true, true);
    };

    /**
     *
     */
    EditorUi.prototype.createEmbedImage = function (fit, shadow, retina, lightbox, edit, layers, fn, err) {
        var bounds = this.editor.graph.getGraphBounds();

        function doUpdate(dataUri) {
            var onclick = ' ';
            var css = '';

            // Adds double click handling
            if (lightbox) {
                // KNOWN: Message passing does not seem to work in IE11
                onclick = " onclick=\"(function(img){if(img.wnd!=null&&!img.wnd.closed){img.wnd.focus();}else{var r=function(evt){if(evt.data=='ready'&&evt.source==img.wnd){img.wnd.postMessage(decodeURIComponent(" +
                    "img.getAttribute('src')),'*');window.removeEventListener('message',r);}};window.addEventListener('message',r);img.wnd=window.open('" + EditorUi.drawHost + "/?client=1&lightbox=1" +
                    ((edit) ? "&edit=_blank" : "") +
                    ((layers) ? '&layers=1' : '') + "');}})(this);\"";
                css += 'cursor:pointer;';
            }

            if (fit) {
                css += 'max-width:100%;';
            }

            var atts = '';

            if (retina) {
                atts = ' width="' + Math.round(bounds.width) + '" height="' + Math.round(bounds.height) + '"';
            }

            fn('<img src="' + dataUri + '"' + atts + ((css != '') ? ' style="' + css + '"' : '') + onclick + '/>');
        };

        if (this.isExportToCanvas()) {
            var scale = 1;
            var ignoreSelection = true;

            this.exportToCanvas(mxUtils.bind(this, function (canvas) {
                var xml = (lightbox) ? this.getFileData(true) : null;
                var data = this.createImageDataUri(canvas, xml, 'png');
                doUpdate(data);
            }), null, null, null, mxUtils.bind(this, function (e) {
                err({message: mxResources.get('unknownError')});
            }), null, true, (retina) ? 2 : 1, null, shadow);
        } else {
            var data = this.getFileData(true);

            if (bounds.width * bounds.height <= MAX_AREA && data.length <= MAX_REQUEST_SIZE) {
                var size = '';

                if (retina) {
                    size = '&w=' + Math.round(2 * bounds.width) +
                        '&h=' + Math.round(2 * bounds.height);
                }

                var embed = (lightbox) ? '1' : '0';
                var req = new mxXmlRequest(EXPORT_URL, 'format=png' +
                    '&base64=1&embedXml=' + embed + size + '&xml=' +
                    encodeURIComponent(data));

                // LATER: Updates on each change, add a delay
                req.send(mxUtils.bind(this, function () {
                    if (req.getStatus() >= 200 && req.getStatus() <= 299) {
                        // Fixes possible "incorrect function" for select() on
                        // DOM node which is no longer in document with IE11
                        doUpdate('data:image/png;base64,' + req.getText());
                    } else {
                        err({message: mxResources.get('unknownError')});
                    }
                }));
            } else {
                err({message: mxResources.get('drawingTooLarge')});
            }
        }
    };

    /**
     *
     */
    EditorUi.prototype.createEmbedSvg = function (fit, shadow, image, lightbox, edit, layers, fn) {
        var svgRoot = this.editor.graph.getSvg();

        // Keeps hashtag links on same page
        var links = svgRoot.getElementsByTagName('a');

        if (links != null) {
            for (var i = 0; i < links.length; i++) {
                var href = links[i].getAttribute('href');

                if (href != null && href.charAt(0) == '#' &&
                    links[i].getAttribute('target') == '_blank') {
                    links[i].removeAttribute('target');
                }
            }
        }

        if (lightbox) {
            svgRoot.setAttribute('content', this.getFileData(true));
        }

        // Adds shadow filter
        if (shadow) {
            this.editor.graph.addSvgShadow(svgRoot);
        }

        // SVG inside image tag
        if (image) {
            var onclick = ' ';
            var css = '';

            // Adds double click handling
            if (lightbox) {
                // KNOWN: Message passing does not seem to work in IE11
                onclick = "onclick=\"(function(img){if(img.wnd!=null&&!img.wnd.closed){img.wnd.focus();}else{var r=function(evt){if(evt.data=='ready'&&evt.source==img.wnd){img.wnd.postMessage(decodeURIComponent(" +
                    "img.getAttribute('src')),'*');window.removeEventListener('message',r);}};window.addEventListener('message',r);img.wnd=window.open('" + EditorUi.drawHost + "/?client=1&lightbox=1" +
                    ((edit) ? "&edit=_blank" : "") + ((layers) ? '&layers=1' : '') + "');}})(this);\"";
                css += 'cursor:pointer;';
            }

            if (fit) {
                css += 'max-width:100%;';
            }

            // Images inside IMG don't seem to work so embed them all
            this.convertImages(svgRoot, mxUtils.bind(this, function (svgRoot) {
                fn('<img src="' + this.createSvgDataUri(mxUtils.getXml(svgRoot)) + '"' +
                    ((css != '') ? ' style="' + css + '"' : '') + onclick + '/>');
            }));
        } else {
            var css = '';

            // Adds double click handling
            if (lightbox) {
                // KNOWN: Message passing does not seem to work in IE11
                var js = "(function(svg){var src=window.event.target||window.event.srcElement;" +
                    // Ignores link events
                    "while (src!=null&&src.nodeName.toLowerCase()!='a'){src=src.parentNode;}if(src==null)" +
                    // Focus existing lightbox
                    "{if(svg.wnd!=null&&!svg.wnd.closed){svg.wnd.focus();}else{var r=function(evt){" +
                    // Message handling
                    "if(evt.data=='ready'&&evt.source==svg.wnd){svg.wnd.postMessage(decodeURIComponent(" +
                    "svg.getAttribute('content')),'*');window.removeEventListener('message',r);}};" +
                    "window.addEventListener('message',r);" +
                    // Opens lightbox window
                    "svg.wnd=window.open('" + EditorUi.drawHost + "/?client=1&lightbox=1" +
                    ((edit) ? "&edit=_blank" : "") + ((layers) ? '&layers=1' : '') + "');}}})(this);";
                svgRoot.setAttribute('onclick', js);
                css += 'cursor:pointer;';
            }

            // Adds responsive size
            if (fit) {
                var w = parseInt(svgRoot.getAttribute('width'));
                var h = parseInt(svgRoot.getAttribute('height'));
                svgRoot.setAttribute('viewBox', '-0.5 -0.5 ' + w + ' ' + h);
                css += 'max-width:100%;max-height:' + h + 'px;';
                svgRoot.removeAttribute('height');
            }

            if (css != '') {
                svgRoot.setAttribute('style', css);
            }

            fn(mxUtils.getXml(svgRoot));
        }
    };

    /**
     * Translates this point by the given vector.
     *
     * @param {number} dx X-coordinate of the translation.
     * @param {number} dy Y-coordinate of the translation.
     */
    EditorUi.prototype.timeSince = function (date) {
        var seconds = Math.floor((new Date() - date) / 1000);
        var interval = Math.floor(seconds / 31536000);

        if (interval > 1) {
            return interval + ' ' + mxResources.get('years');
        }

        interval = Math.floor(seconds / 2592000);

        if (interval > 1) {
            return interval + ' ' + mxResources.get('months');
        }

        interval = Math.floor(seconds / 86400);

        if (interval > 1) {
            return interval + ' ' + mxResources.get('days');
        }

        interval = Math.floor(seconds / 3600);

        if (interval > 1) {
            return interval + ' ' + mxResources.get('hours');
        }

        interval = Math.floor(seconds / 60);

        if (interval > 1) {
            return interval + ' ' + mxResources.get('minutes');
        }

        if (interval == 1) {
            return interval + ' ' + mxResources.get('minute');
        }

        return null;
    };

    /**
     *
     */
    EditorUi.prototype.decodeNodeIntoGraph = function (node, graph) {
        if (node != null) {
            var diagramNode = null;

            if (node.nodeName == 'diagram') {
                diagramNode = node;
            } else if (node.nodeName == 'mxfile') {
                var diagrams = node.getElementsByTagName('diagram');

                if (diagrams.length > 0) {
                    diagramNode = diagrams[0];
                    var graphGetGlobalVariable = graph.getGlobalVariable;

                    graph.getGlobalVariable = function (name) {
                        if (name == 'page') {
                            return diagramNode.getAttribute('name') || mxResources.get('pageWithNumber', [1])
                        } else if (name == 'pagenumber') {
                            return 1;
                        }

                        return graphGetGlobalVariable.apply(this, arguments);
                    };
                }
            }

            if (diagramNode != null) {
                node = Editor.parseDiagramNode(diagramNode);
            }
        }

        // Hack to decode XML into temp graph via editor
        var prev = this.editor.graph;

        try {
            this.editor.graph = graph;
            this.editor.setGraphXml(node);
        } catch (e) {
            // ignore
        } finally {
            this.editor.graph = prev;
        }

        return node;
    };

    /**
     *
     */
    EditorUi.prototype.getEmbeddedPng = function (success, error, optionalData) {
        try {
            var graph = this.editor.graph;
            var diagramData = null;

            // Exports PNG for given optional data
            if (optionalData != null && optionalData.length > 0) {
                graph = this.createTemporaryGraph(this.editor.graph.getStylesheet());
                document.body.appendChild(graph.container);
                this.decodeNodeIntoGraph(this.editor.extractGraphModel(
                    mxUtils.parseXml(optionalData).documentElement, true), graph);
                diagramData = optionalData;
            }
            // Exports PNG for first page while other page is showing
            else if (this.pages != null && this.currentPage != this.pages[0]) {
                graph = this.createTemporaryGraph(graph.getStylesheet());
                var graphGetGlobalVariable = graph.getGlobalVariable;
                var page = this.pages[0];

                graph.getGlobalVariable = function (name) {
                    if (name == 'page') {
                        return page.getName();
                    } else if (name == 'pagenumber') {
                        return 1;
                    }

                    return graphGetGlobalVariable.apply(this, arguments);
                };

                document.body.appendChild(graph.container);
                graph.model.setRoot(page.root);
            }

            this.exportToCanvas(mxUtils.bind(this, function (canvas) {
                try {
                    if (diagramData == null) {
                        diagramData = this.getFileData(true, null, null, null, null,
                            null, null, null, null, false);
                    }

                    var data = canvas.toDataURL('image/png');
                    data = this.writeGraphModelToPng(data,
                        'tEXt', 'mxfile', encodeURIComponent(diagramData));
                    success(data.substring(data.lastIndexOf(',') + 1));

                    // Removes temporary graph from DOM
                    if (graph != this.editor.graph) {
                        graph.container.parentNode.removeChild(graph.container);
                    }
                } catch (e) {
                    if (error != null) {
                        error(e);
                    }
                }
            }), null, null, null, mxUtils.bind(this, function (e) {
                if (error != null) {
                    error(e);
                }
            }), null, null, null, null, graph.shadowVisible, null, graph);
        } catch (e) {
            if (error != null) {
                error(e);
            }
        }
    }

    /**
     * Returns the SVG of the diagram with embedded XML. If a callback function is
     * used, the images are converted to data URIs.
     */
    EditorUi.prototype.getEmbeddedSvg = function (xml, graph, url, noHeader, callback, ignoreSelection, redirect) {
        var bg = graph.background;

        if (bg == mxConstants.NONE) {
            bg = null;
        }

        // Sets or disables alternate text for foreignObjects. Disabling is needed
        // because PhantomJS seems to ignore switch statements and paint all text.
        var svgRoot = graph.getSvg(bg, null, null, null, null, ignoreSelection);

        if (graph.shadowVisible) {
            graph.addSvgShadow(svgRoot);
        }

        if (xml != null) {
            svgRoot.setAttribute('content', xml);
        }

        if (url != null) {
            svgRoot.setAttribute('resource', url);
        }

        // LATER: Click on SVG content to start editing
//		if (redirect != null)
//		{
//			// TODO: Ignore anchor tag source for click event
//			svgRoot.setAttribute('style', 'cursor:pointer;');
//			svgRoot.setAttribute('onclick', 'window.location.href=\'' + redirect + '\';');
//		}

        if (callback != null) {
            this.convertImages(svgRoot, mxUtils.bind(this, function (svgRoot) {
                callback(((!noHeader) ? '<?xml version="1.0" encoding="UTF-8"?>\n' +
                    '<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">\n' : '') +
                    mxUtils.getXml(svgRoot));
            }));
        } else {
            return ((!noHeader) ? '<?xml version="1.0" encoding="UTF-8"?>\n' +
                '<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">\n' : '') +
                mxUtils.getXml(svgRoot);
        }
    };

    /**
     *
     */
    EditorUi.prototype.exportImage = function (scale, transparentBackground, ignoreSelection, addShadow, editable, border, noCrop, currentPage, format, grid, dpi) {
        format = (format != null) ? format : 'png';

        if (this.spinner.spin(document.body, mxResources.get('exporting'))) {
            var selectionEmpty = this.editor.graph.isSelectionEmpty();
            ignoreSelection = (ignoreSelection != null) ? ignoreSelection : selectionEmpty;

            // Caches images
            if (this.thumbImageCache == null) {
                this.thumbImageCache = new Object();
            }

            try {
                this.exportToCanvas(mxUtils.bind(this, function (canvas) {
                        this.spinner.stop();

                        try {
                            this.saveCanvas(canvas, (editable) ? this.getFileData(true, null,
                                null, null, ignoreSelection, currentPage) : null,
                                format, !currentPage, dpi);
                        } catch (e) {
                            // Fallback to server-side image export
                            if (e.message == 'Invalid image') {
                                this.downloadFile(format);
                            } else {
                                this.handleError(e);
                            }
                        }
                    }), null, this.thumbImageCache, null, mxUtils.bind(this, function (e) {
                        this.spinner.stop();
                        this.handleError(e);
                    }), null, ignoreSelection, scale || 1, transparentBackground,
                    addShadow, null, null, border, noCrop, grid);
            } catch (e) {
                this.spinner.stop();
                this.handleError(e);
            }
        }
    };

    /**
     * For the fontCSS to be applied when rendering images on canvas, the actual
     * font data must be made available via a data URI encoding of the file.
     */
    EditorUi.prototype.loadFonts = function (then) {
        if (this.editor.fontCss != null && this.editor.resolvedFontCss == null) {
            var parts = this.editor.fontCss.split('url(');
            var waiting = 0;
            var fonts = {};

            // Strips leading and trailing quotes and spaces
            function trimString(str) {
                return str.replace(new RegExp("^[\\s\"']+", "g"), "").replace(new RegExp("[\\s\"']+$", "g"), "");
            };

            var finish = mxUtils.bind(this, function () {
                if (waiting == 0) {
                    // Constructs string
                    var result = [parts[0]];

                    for (var j = 1; j < parts.length; j++) {
                        var idx = parts[j].indexOf(')');
                        result.push('url("');
                        result.push(fonts[trimString(parts[j].substring(0, idx))]);
                        result.push('"' + parts[j].substring(idx));
                    }

                    this.editor.resolvedFontCss = result.join('');
                    then();
                }
            });

            if (parts.length > 0) {
                for (var i = 1; i < parts.length; i++) {
                    var idx = parts[i].indexOf(')');
                    var format = null;

                    // Checks if there is a format directive
                    var fmtIdx = parts[i].indexOf('format(', idx);

                    if (fmtIdx > 0) {
                        format = trimString(parts[i].substring(fmtIdx + 7, parts[i].indexOf(')', fmtIdx)));
                    }

                    (mxUtils.bind(this, function (url) {
                        if (fonts[url] == null) {
                            // Mark font es being fetched and fetch it
                            fonts[url] = url;
                            waiting++;

                            var mime = 'application/x-font-ttf';

                            // See https://stackoverflow.com/questions/2871655/proper-mime-type-for-fonts
                            if (format == 'svg' || /(\.svg)($|\?)/i.test(url)) {
                                mime = 'image/svg+xml';
                            } else if (format == 'otf' || format == 'embedded-opentype' || /(\.otf)($|\?)/i.test(url)) {
                                mime = 'application/x-font-opentype';
                            } else if (format == 'woff' || /(\.woff)($|\?)/i.test(url)) {
                                mime = 'application/font-woff';
                            } else if (format == 'woff2' || /(\.woff2)($|\?)/i.test(url)) {
                                mime = 'application/font-woff2';
                            } else if (format == 'eot' || /(\.eot)($|\?)/i.test(url)) {
                                mime = 'application/vnd.ms-fontobject';
                            } else if (format == 'sfnt' || /(\.sfnt)($|\?)/i.test(url)) {
                                mime = 'application/font-sfnt';
                            }

                            var realUrl = url;

                            if ((/^https?:\/\//.test(realUrl)) && !this.editor.isCorsEnabledForUrl(realUrl)) {
                                realUrl = PROXY_URL + '?url=' + encodeURIComponent(url);
                            }

                            // LATER: Remove cache-control header
                            this.loadUrl(realUrl, mxUtils.bind(this, function (uri) {
                                fonts[url] = uri;
                                waiting--;
                                finish();
                            }), mxUtils.bind(this, function (err) {
                                // LATER: handle error
                                waiting--;
                                finish();
                            }), true, null, 'data:' + mime + ';charset=utf-8;base64,');
                        }
                    }))(trimString(parts[i].substring(0, idx)), format);
                }
            }
        } else {
            then();
        }
    };

    /**
     *
     */
    EditorUi.prototype.exportToCanvas = function (callback, width, imageCache, background, error, limitHeight,
                                                  ignoreSelection, scale, transparentBackground, addShadow, converter, graph, border, noCrop, grid) {
        try {
            limitHeight = (limitHeight != null) ? limitHeight : true;
            ignoreSelection = (ignoreSelection != null) ? ignoreSelection : true;
            graph = (graph != null) ? graph : this.editor.graph;
            border = (border != null) ? border : 0;

            var bg = (transparentBackground) ? null : graph.background;

            if (bg == mxConstants.NONE) {
                bg = null;
            }

            if (bg == null) {
                bg = background;
            }

            // Handles special case where background is null but transparent is false
            if (bg == null && transparentBackground == false) {
                bg = '#ffffff';
            }

            this.convertImages(graph.getSvg(null, null, null, noCrop, null, ignoreSelection, null, null, null, addShadow),
                mxUtils.bind(this, function (svgRoot) {
                    var img = new Image();

                    img.onload = mxUtils.bind(this, function () {
                        try {
                            var canvas = document.createElement('canvas');
                            var w = parseInt(svgRoot.getAttribute('width'));
                            var h = parseInt(svgRoot.getAttribute('height'));
                            scale = (scale != null) ? scale : 1;

                            if (width != null) {
                                scale = (!limitHeight) ? width / w : Math.min(1, Math.min((width * 3) / (h * 4), width / w));
                            }

                            w = Math.ceil(scale * w) + 2 * border;
                            h = Math.ceil(scale * h) + 2 * border;

                            canvas.setAttribute('width', w);
                            canvas.setAttribute('height', h);
                            var ctx = canvas.getContext('2d');

                            if (bg != null) {
                                ctx.beginPath();
                                ctx.rect(0, 0, w, h);
                                ctx.fillStyle = bg;
                                ctx.fill();
                            }

                            ctx.scale(scale, scale);

                            function drawImage() {
                                // Workaround for broken data URI images in Safari on first export
                                if (mxClient.IS_SF) {
                                    window.setTimeout(function () {
                                        ctx.drawImage(img, border / scale, border / scale);
                                        callback(canvas);
                                    }, 0);
                                } else {
                                    ctx.drawImage(img, border / scale, border / scale);
                                    callback(canvas);
                                }
                            };

                            if (grid) {
                                var view = graph.view;
                                var gridImage = btoa(unescape(encodeURIComponent(view.createSvgGrid(view.gridColor))));
                                gridImage = 'data:image/svg+xml;base64,' + gridImage;
                                var phase = graph.gridSize * view.gridSteps * scale;

                                var b = graph.getGraphBounds();
                                var x0 = b.x * scale;
                                var y0 = b.y * scale;

                                var background = new Image();
                                background.src = gridImage;

                                background.onload = function () {
                                    var x = -Math.round(phase - mxUtils.mod(view.translate.x * scale - x0, phase));
                                    var y = -Math.round(phase - mxUtils.mod(view.translate.y * scale - y0, phase));

                                    for (var i = x; i < w; i += phase) {
                                        for (var j = y; j < h; j += phase) {
                                            ctx.drawImage(background, i / scale, j / scale);
                                        }
                                    }

                                    drawImage();
                                };
                            } else {
                                drawImage();
                            }
                        } catch (e) {
                            if (error != null) {
                                error(e);
                            }
                        }
                    });

                    img.onerror = function (e) {
                        //console.log('img', e, img.src);

                        if (error != null) {
                            error(e);
                        }
                    };

                    try {
                        if (addShadow) {
                            this.editor.graph.addSvgShadow(svgRoot);
                        }

                        var done = mxUtils.bind(this, function () {
                            if (this.editor.resolvedFontCss != null) {
                                var st = document.createElement('style');
                                st.setAttribute('type', 'text/css');
                                st.innerHTML = this.editor.resolvedFontCss;

                                // Must be in defs section for FF to work
                                var defs = svgRoot.getElementsByTagName('defs');
                                defs[0].appendChild(st);
                            }

                            this.convertMath(graph, svgRoot, true, mxUtils.bind(this, function () {
                                img.src = this.createSvgDataUri(mxUtils.getXml(svgRoot));
                            }));
                        });

                        this.loadFonts(done);
                    } catch (e) {
                        //console.log('src', e, img.src);

                        if (error != null) {
                            error(e);
                        }
                    }
                }), imageCache, converter);
        } catch (e) {
            if (error != null) {
                error(e);
            }
        }
    };

    /**
     * Converts all images in the SVG output to data URIs for immediate rendering
     */
    EditorUi.prototype.createImageUrlConverter = function () {
        var converter = new mxUrlConverter();
        converter.updateBaseUrl();

        // Extends convert to avoid CORS using an image proxy server where needed
        var convert = converter.convert;
        var self = this;

        converter.convert = function (src) {
            if (src != null) {
                var remote = src.substring(0, 7) == 'http://' || src.substring(0, 8) == 'https://';

                if (remote && !navigator.onLine) {
                    src = self.svgBrokenImage.src;
                } else if (remote && src.substring(0, converter.baseUrl.length) != converter.baseUrl &&
                    (!self.crossOriginImages || !self.editor.isCorsEnabledForUrl(src))) {
                    src = PROXY_URL + '?url=' + encodeURIComponent(src);
                } else if (src.substring(0, 19) != 'chrome-extension://' && !mxClient.IS_CHROMEAPP) {
                    src = convert.apply(this, arguments);
                }
            }

            return src;
        };

        return converter;
    };

    /**
     * Converts all images in the SVG output to data URIs for immediate rendering
     */
    EditorUi.prototype.convertImages = function (svgRoot, callback, imageCache, converter) {
        // Converts images to data URLs for immediate painting
        if (converter == null) {
            converter = this.createImageUrlConverter();
        }

        // Barrier for asynchronous image loading
        var counter = 0;

        function inc() {
            counter++;
        };

        function dec() {
            counter--;

            if (counter == 0) {
                callback(svgRoot);
            }
        };

        var cache = imageCache || new Object();

        var convertImages = mxUtils.bind(this, function (tagName, srcAttr) {
            var images = svgRoot.getElementsByTagName(tagName);

            for (var i = 0; i < images.length; i++) {
                (mxUtils.bind(this, function (img) {
                    try {
                        if (img != null) {
                            var src = converter.convert(img.getAttribute(srcAttr));

                            // Data URIs are pass-through
                            if (src != null && src.substring(0, 5) != 'data:') {
                                var tmp = cache[src];

                                if (tmp == null) {
                                    inc();

                                    this.convertImageToDataUri(src, function (uri) {
                                        if (uri != null) {
                                            cache[src] = uri;
                                            img.setAttribute(srcAttr, uri);
                                        }

                                        dec();
                                    });
                                } else {
                                    img.setAttribute(srcAttr, tmp);
                                }
                            } else if (src != null) {
                                img.setAttribute(srcAttr, src);
                            }
                        }
                    } catch (e) {
                        // ignore
                    }
                }))(images[i]);
            }
        });

        // Converts all known image tags in output
        // LATER: Add support for images in CSS
        convertImages('image', 'xlink:href');
        convertImages('img', 'src');

        // All from cache or no images
        if (counter == 0) {
            callback(svgRoot);
        }
    };

    /**
     * Checks if the client is authorized and calls the next step.
     */
    EditorUi.prototype.loadUrl = function (url, success, error, forceBinary, retry, dataUriPrefix, noBinary) {
        try {
            var binary = !noBinary && (forceBinary || /(\.png)($|\?)/i.test(url) ||
                /(\.jpe?g)($|\?)/i.test(url) || /(\.gif)($|\?)/i.test(url));
            retry = (retry != null) ? retry : true;

            var fn = mxUtils.bind(this, function () {
                mxUtils.get(url, mxUtils.bind(this, function (req) {
                    if (req.getStatus() >= 200 && req.getStatus() <= 299) {
                        if (success != null) {
                            var data = req.getText();

                            // Returns PNG as base64 encoded data URI
                            if (binary) {
                                // NOTE: This requires BinaryToArray VB script in the page
                                if ((document.documentMode == 9 || document.documentMode == 10) &&
                                    typeof window.mxUtilsBinaryToArray !== 'undefined') {
                                    var bin = mxUtilsBinaryToArray(req.request.responseBody).toArray();
                                    var tmp = new Array(bin.length);

                                    for (var i = 0; i < bin.length; i++) {
                                        tmp[i] = String.fromCharCode(bin[i]);
                                    }

                                    data = tmp.join('');
                                }

                                // LATER: Could be JPG but modern browsers
                                // ignore the mime type in the data URI
                                dataUriPrefix = (dataUriPrefix != null) ? dataUriPrefix : 'data:image/png;base64,';
                                data = dataUriPrefix + this.base64Encode(data);
                            }

                            success(data);
                        }
                    } else if (error != null) {
                        error({message: mxResources.get('error') + ' ' + req.getStatus()}, req);
                    }
                }), function (req) {
                    if (error != null) {
                        error({message: mxResources.get('error') + ' ' + req.getStatus()});
                    }
                }, binary, this.timeout, function () {
                    if (retry && error != null) {
                        error({code: App.ERROR_TIMEOUT, retry: fn});
                    }
                });
            });

            fn();
        } catch (e) {
            if (error != null) {
                error(e);
            }
        }
    };

    /**
     * Returns true if the given URL is known to have CORS headers.
     */
    EditorUi.prototype.isCorsEnabledForUrl = function (url) {
        return this.editor.isCorsEnabledForUrl(url);
    };

    /**
     * Translates this point by the given vector.
     *
     * @param {number} dx X-coordinate of the translation.
     * @param {number} dy Y-coordinate of the translation.
     */
    EditorUi.prototype.convertImageToDataUri = function (url, callback) {
        try {
            var acceptResponse = true;

            var timeoutThread = window.setTimeout(mxUtils.bind(this, function () {
                acceptResponse = false;
                callback(this.svgBrokenImage.src);
            }), this.timeout);

            if (/(\.svg)$/i.test(url)) {
                mxUtils.get(url, mxUtils.bind(this, function (req) {
                        window.clearTimeout(timeoutThread);

                        if (acceptResponse) {
                            callback(this.createSvgDataUri(req.getText()));
                        }
                    }),
                    function () {
                        window.clearTimeout(timeoutThread);

                        if (acceptResponse) {
                            callback(this.svgBrokenImage.src);
                        }
                    });
            } else {
                var img = new Image();
                var self = this;

                if (this.crossOriginImages) {
                    img.crossOrigin = 'anonymous';
                }

                img.onload = function () {
                    window.clearTimeout(timeoutThread);

                    if (acceptResponse) {
                        try {
                            var canvas = document.createElement('canvas');
                            var ctx = canvas.getContext('2d');
                            canvas.height = img.height;
                            canvas.width = img.width;
                            ctx.drawImage(img, 0, 0);

                            callback(canvas.toDataURL());
                        } catch (e) {
                            callback(self.svgBrokenImage.src);
                        }
                    }
                };

                img.onerror = function () {
                    window.clearTimeout(timeoutThread);

                    if (acceptResponse) {
                        callback(self.svgBrokenImage.src);
                    }
                };

                img.src = url;
            }
        } catch (e) {
            callback(this.svgBrokenImage.src);
        }
    };

    /**
     * Handling drag and drop and import.
     */

    /**
     * Imports the given XML into the existing diagram.
     */
    EditorUi.prototype.importXml = function (xml, dx, dy, crop, noErrorHandling) {
        dx = (dx != null) ? dx : 0;
        dy = (dy != null) ? dy : 0;
        var cells = []

        try {
            var graph = this.editor.graph;

            if (xml != null && xml.length > 0) {
                // Adds pages
                graph.model.beginUpdate();
                try {
                    var doc = mxUtils.parseXml(xml);

                    // Checks for mxfile with multiple pages
                    var node = this.editor.extractGraphModel(doc.documentElement, this.pages != null);

                    if (node != null && node.nodeName == 'mxfile' && this.pages != null) {
                        var diagrams = node.getElementsByTagName('diagram');

                        if (diagrams.length == 1) {
                            node = Editor.parseDiagramNode(diagrams[0]);
                        } else if (diagrams.length > 1) {
                            var mapping = {};
                            var pages = [];
                            var i0 = 0;

                            // Adds first page to current page if current page is only page and empty
                            if (this.pages != null && this.pages.length == 1 && this.isDiagramEmpty()) {
                                node = Editor.parseDiagramNode(diagrams[0]);
                                crop = false;
                                i0 = 1;
                            }

                            for (var i = i0; i < diagrams.length; i++) {
                                // Imported pages must obtain a new ID and
                                // all links to pages must be updated below
                                var oldId = diagrams[i].getAttribute('id')
                                diagrams[i].removeAttribute('id');

                                var page = this.updatePageRoot(new DiagramPage(diagrams[i]));
                                mapping[oldId] = diagrams[i].getAttribute('id');
                                var index = this.pages.length;

                                // Checks for invalid page names
                                if (page.getName() == null) {
                                    page.setName(mxResources.get('pageWithNumber', [index + 1]));
                                }

                                graph.model.execute(new ChangePage(this, page, page, index, true));
                                pages.push(page);
                            }

                            this.updatePageLinks(mapping, pages);
                        }
                    }

                    if (node != null && node.nodeName === 'mxGraphModel') {
                        cells = graph.importGraphModel(node, dx, dy, crop);
                    }
                } finally {
                    graph.model.endUpdate();
                }
            }
        } catch (e) {
            if (!noErrorHandling) {
                this.handleError(e);
            } else {
                throw e;
            }
        }

        return cells;
    };

    /**
     * Updates links to pages in shapes and labels.
     */
    EditorUi.prototype.updatePageLinks = function (mapping, pages) {
        for (var i = 0; i < pages.length; i++) {
            this.updatePageLinksForCell(mapping, pages[i].root);
        }
    };

    /**
     * Updates links to pages in shapes and labels.
     */
    EditorUi.prototype.updatePageLinksForCell = function (mapping, cell) {
        var temp = document.createElement('div');
        var graph = this.editor.graph;
        var href = graph.getLinkForCell(cell);

        if (href != null) {
            graph.setLinkForCell(cell, this.updatePageLink(mapping, href));
        }

        if (graph.isHtmlLabel(cell)) {
            temp.innerHTML = graph.getLabel(cell);
            var links = temp.getElementsByTagName('a');
            var changed = false;

            for (var i = 0; i < links.length; i++) {
                href = links[i].getAttribute('href');

                if (href != null) {
                    links[i].setAttribute('href', this.updatePageLink(mapping, href));
                    changed = true;
                }
            }

            if (changed) {
                graph.labelChanged(cell, temp.innerHTML);
            }
        }

        for (var i = 0; i < graph.model.getChildCount(cell); i++) {
            this.updatePageLinksForCell(mapping, graph.model.getChildAt(cell, i));
        }
    };

    /**
     * Updates links to pages in shapes and labels.
     */
    EditorUi.prototype.updatePageLink = function (mapping, href) {
        if (href.substring(0, 13) == 'data:page/id,') {
            var newId = mapping[href.substring(href.indexOf(',') + 1)];
            href = (newId != null) ? 'data:page/id,' + newId : null;
        } else if (href.substring(0, 17) == 'data:action/json,') {
            try {
                var link = JSON.parse(href.substring(17));

                if (link.actions != null) {
                    for (var i = 0; i < link.actions.length; i++) {
                        var action = link.actions[i];

                        if (action.open != null && action.open.substring(0, 13) == 'data:page/id,') {
                            var newId = mapping[action.open.substring(action.open.indexOf(',') + 1)];

                            if (newId != null) {
                                action.open = 'data:page/id,' + newId;
                            } else {
                                delete action.open;
                            }
                        }
                    }

                    href = 'data:action/json,' + JSON.stringify(link);
                }
            } catch (e) {
                // Ignore
            }
        }

        return href;
    };

    /**
     * Returns true for VSD, VDX and VSS, VSX files.
     */
    EditorUi.prototype.isRemoteVisioFormat = function (filename) {
        return /(\.v(sd|dx))($|\?)/i.test(filename) || /(\.vs(s|x))($|\?)/i.test(filename);
    };

    /**
     * Imports the given Visio file
     */
    EditorUi.prototype.importVisio = function (file, done, onerror, filename) {
        filename = (filename != null) ? filename : file.name;

        onerror = (onerror != null) ? onerror : mxUtils.bind(this, function (e) {
            this.handleError(e);
        });

        var delayed = mxUtils.bind(this, function () {
            this.loadingExtensions = false;

            if (this.doImportVisio) {
                var remote = this.isRemoteVisioFormat(filename);

                try {
                    var ext = 'UNKNOWN-VISIO';
                    var dot = filename.lastIndexOf('.');

                    if (dot >= 0 && dot < filename.length) {
                        ext = filename.substring(dot + 1).toUpperCase();
                    }

                    EditorUi.logEvent({
                        category: ext + '-MS-IMPORT-FILE',
                        action: 'filename_' + filename,
                        label: (remote) ? 'remote' : 'local'
                    });
                } catch (e) {
                    // ignore
                }

                if (remote) {
                    if (VSD_CONVERT_URL != null) {
                        var formData = new FormData();
                        formData.append('file1', file, filename);

                        var xhr = new XMLHttpRequest();
                        xhr.open('POST', VSD_CONVERT_URL);
                        xhr.responseType = 'blob';
                        this.addRemoteServiceSecurityCheck(xhr);

                        xhr.onreadystatechange = mxUtils.bind(this, function () {
                            if (xhr.readyState == 4) {
                                if (xhr.status >= 200 && xhr.status <= 299) {
                                    try {
                                        var resp = xhr.response;

                                        if (resp.type == 'text/xml') {
                                            var reader = new FileReader();

                                            reader.onload = mxUtils.bind(this, function (e) {
                                                try {
                                                    done(e.target.result);
                                                } catch (e) {
                                                    onerror({message: mxResources.get('errorLoadingFile')});
                                                }
                                            });

                                            reader.readAsText(resp);
                                        } else {
                                            this.doImportVisio(resp, done, onerror, filename);
                                        }
                                    } catch (e) {
                                        onerror(e);
                                    }
                                } else {
                                    onerror({});
                                }
                            }
                        });

                        xhr.send(formData);
                    } else {
                        onerror({message: this.getServiceName() == 'conf' ? mxResources.get('vsdNoConfig') : mxResources.get('serviceUnavailableOrBlocked')});
                    }
                } else {
                    try {
                        this.doImportVisio(file, done, onerror, filename);
                    } catch (e) {
                        onerror(e);
                    }
                }
            } else {
                this.spinner.stop();
                this.handleError({message: mxResources.get('serviceUnavailableOrBlocked')});
            }
        });

        if (!this.doImportVisio && !this.loadingExtensions && !this.isOffline(true)) {
            this.loadingExtensions = true;
            mxscript('js/extensions.min.js', delayed);
        } else {
            delayed();
        }
    };

    /**
     * Imports the given GraphML (yEd) file
     */
    EditorUi.prototype.importGraphML = function (xmlData, done, onerror) {
        onerror = (onerror != null) ? onerror : mxUtils.bind(this, function (e) {
            this.handleError(e);
        });

        var delayed = mxUtils.bind(this, function () {
            this.loadingExtensions = false;

            if (this.doImportGraphML) {

                try {
                    this.doImportGraphML(xmlData, done, onerror);
                } catch (e) {
                    onerror(e);
                }
            } else {
                this.spinner.stop();
                this.handleError({message: mxResources.get('serviceUnavailableOrBlocked')});
            }
        });

        if (!this.doImportGraphML && !this.loadingExtensions && !this.isOffline(true)) {
            this.loadingExtensions = true;
            mxscript('js/extensions.min.js', delayed);
        } else {
            delayed();
        }
    };

    /**
     * Export the diagram to VSDX
     */
    EditorUi.prototype.exportVisio = function () {
        var delayed = mxUtils.bind(this, function () {
            this.loadingExtensions = false;

            if (typeof VsdxExport !== 'undefined') {
                try {
                    var expSuccess = new VsdxExport(this).exportCurrentDiagrams();

                    if (!expSuccess) {
                        this.handleError({message: mxResources.get('unknownError')});
                    }
                } catch (e) {
                    this.handleError(e);
                }
            } else {
                this.spinner.stop();
                this.handleError({message: mxResources.get('serviceUnavailableOrBlocked')});
            }
        });

        if (typeof VsdxExport === 'undefined' && !this.loadingExtensions && !this.isOffline(true)) {
            this.loadingExtensions = true;
            mxscript('js/extensions.min.js', delayed);
        } else {
            delayed();
        }
    };

    /**
     * Imports the given Lucidchart data.
     */
    EditorUi.prototype.convertLucidChart = function (data, success, error) {
        var delayed = mxUtils.bind(this, function () {
            this.loadingExtensions = false;

            // Checks for signature method
            if (typeof window.LucidImporter !== 'undefined') {
                try {
                    EditorUi.logEvent({
                        category: 'LUCIDCHART-IMPORT-FILE',
                        action: 'size_' + data.length
                    });
                } catch (e) {
                    // ignore
                }

                try {
                    success(LucidImporter.importState(JSON.parse(data)));
                } catch (e) {
                    error(e);
                }
            } else {
                error({message: mxResources.get('serviceUnavailableOrBlocked')});
            }
        });

        if (typeof window.LucidImporter === 'undefined' &&
            !this.loadingExtensions && !this.isOffline(true)) {
            this.loadingExtensions = true;

            if (urlParams['dev'] == '1') {
                mxscript('js/diagramly/Extensions.js', delayed);
            } else {
                mxscript('js/extensions.min.js', delayed);
            }
        } else {
            // Async needed for selection
            window.setTimeout(delayed, 0);
        }
    };

    /**
     * Inserts the given text as a preformatted HTML text.
     */
    EditorUi.prototype.insertAsPreText = function (text, x, y) {
        var graph = this.editor.graph;
        var cell = null;

        graph.getModel().beginUpdate();
        try {
            cell = graph.insertVertex(null, null, '<pre>' + text + '</pre>',
                x, y, 1, 1, 'text;html=1;align=center;verticalAlign=middle;');
            graph.updateCellSize(cell, true);
        } finally {
            graph.getModel().endUpdate();
        }

        return cell;
    };

    /**
     * Imports the given XML into the existing diagram.
     * TODO: Make this function asynchronous
     */
    EditorUi.prototype.insertTextAt = function (text, dx, dy, html, asImage, crop, resizeImages) {
        crop = (crop != null) ? crop : true;
        resizeImages = (resizeImages != null) ? resizeImages : true;

        // Handles special case for Gliffy data which requires async server-side for parsing
        if (text != null) {
            if (Graph.fileSupport && !this.isOffline() && new XMLHttpRequest().upload && this.isRemoteFileFormat(text)) {
                // Fixes possible parsing problems with ASCII 160 (non-breaking space)
                this.parseFile(new Blob([text.replace(/\s+/g, ' ')], {type: 'application/octet-stream'}), mxUtils.bind(this, function (xhr) {
                    if (xhr.readyState == 4 && xhr.status >= 200 && xhr.status <= 299) {
                        this.editor.graph.setSelectionCells(this.insertTextAt(
                            xhr.responseText, dx, dy, true));
                    }
                }));

                // Returns empty cells array as it is aysynchronous
                return [];
            }
            // Handles special case of data URI which requires async loading for finding size
            else if (text.substring(0, 5) == 'data:' || (!this.isOffline() &&
                (asImage || (/\.(gif|jpg|jpeg|tiff|png|svg)$/i).test(text)))) {
                var graph = this.editor.graph;

                // Checks for embedded XML in PNG
                if (text.substring(0, 22) == 'data:image/png;base64,') {
                    var xml = this.extractGraphModelFromPng(text);
                    var result = this.importXml(xml, dx, dy, crop, true);

                    if (result.length > 0) {
                        return result;
                    }
                }

                // Tries to extract embedded XML from SVG data URI
                if (text.substring(0, 19) == 'data:image/svg+xml;') {
                    try {
                        var xml = null;

                        if (text.substring(0, 26) == 'data:image/svg+xml;base64,') {
                            xml = text.substring(text.indexOf(',') + 1);
                            xml = (window.atob && !mxClient.IS_SF) ? atob(xml) : Base64.decode(xml, true);
                        } else {
                            xml = decodeURIComponent(text.substring(text.indexOf(',') + 1));
                        }

                        var result = this.importXml(xml, dx, dy, crop, true);

                        if (result.length > 0) {
                            return result;
                        }
                    } catch (e) {
                        // Ignore
                    }
                }

                this.loadImage(text, mxUtils.bind(this, function (img) {
                    if (text.substring(0, 5) == 'data:') {
                        this.resizeImage(img, text, mxUtils.bind(this, function (data2, w2, h2) {
                            graph.setSelectionCell(graph.insertVertex(null, null, '', graph.snap(dx), graph.snap(dy),
                                w2, h2, 'shape=image;verticalLabelPosition=bottom;labelBackgroundColor=#ffffff;' +
                                'verticalAlign=top;aspect=fixed;imageAspect=0;image=' + this.convertDataUri(data2) + ';'));
                        }), resizeImages, this.maxImageSize);
                    } else {
                        var s = Math.min(1, Math.min(this.maxImageSize / img.width, this.maxImageSize / img.height));
                        var w = Math.round(img.width * s);
                        var h = Math.round(img.height * s);

                        graph.setSelectionCell(graph.insertVertex(null, null, '', graph.snap(dx), graph.snap(dy),
                            w, h, 'shape=image;verticalLabelPosition=bottom;labelBackgroundColor=#ffffff;' +
                            'verticalAlign=top;aspect=fixed;imageAspect=0;image=' + text + ';'));
                    }
                }), mxUtils.bind(this, function () {
                    var cell = null;

                    // Inserts invalid data URIs as text
                    graph.getModel().beginUpdate();
                    try {
                        cell = graph.insertVertex(graph.getDefaultParent(), null, text,
                            graph.snap(dx), graph.snap(dy), 1, 1, 'text;' + ((html) ? 'html=1;' : ''));
                        graph.updateCellSize(cell);
                        graph.fireEvent(new mxEventObject('textInserted', 'cells', [cell]));
                    } finally {
                        graph.getModel().endUpdate();
                    }

                    graph.setSelectionCell(cell);
                }));

                return [];
            } else {
                text = Graph.zapGremlins(mxUtils.trim(text));

                if (this.isCompatibleString(text)) {
                    return this.importXml(text, dx, dy, crop);
                } else if (text.length > 0) {
                    if (this.isLucidChartData(text)) {
                        this.convertLucidChart(text, mxUtils.bind(this, function (xml) {
                            this.editor.graph.setSelectionCells(
                                this.importXml(xml, dx, dy, crop));
                        }), mxUtils.bind(this, function (e) {
                            this.handleError(e);
                        }));
                    } else {
                        var graph = this.editor.graph;
                        var cell = null;

                        graph.getModel().beginUpdate();
                        try {
                            // Fires cellsInserted to apply the current style to the inserted text.
                            // This requires the value to be empty when the event is fired.
                            cell = graph.insertVertex(graph.getDefaultParent(), null, '',
                                graph.snap(dx), graph.snap(dy), 1, 1, 'text;' + ((html) ? 'html=1;' : ''));
                            graph.fireEvent(new mxEventObject('textInserted', 'cells', [cell]));

                            // Single tag is converted
                            if (text.charAt(0) == '<' && text.indexOf('>') == text.length - 1) {
                                text = mxUtils.htmlEntities(text);
                            }

                            //TODO Refuse unsupported file types early as at this stage a lot of processing has beed done and time is wasted.
                            //		For example, 5 MB PDF files is processed and then only 0.5 MB of meaningless text is added!
                            //Limit labels to maxTextBytes
                            if (text.length > this.maxTextBytes) {
                                text = text.substring(0, this.maxTextBytes) + '...';
                            }

                            // Apply value and updates the cell size to fit the text block
                            cell.value = text;
                            graph.updateCellSize(cell);

                            // See http://stackoverflow.com/questions/6927719/url-regex-does-not-work-in-javascript
                            var regexp = /\b((?:[a-z][\w-]+:(?:\/{1,3}|[a-z0-9%])|www\d{0,3}[.]|[a-z0-9.\-]+[.][a-z]{2,4}\/)(?:[^\s()<>]+|\(([^\s()<>]+|(\([^\s()<>]+\)))*\))+(?:\(([^\s()<>]+|(\([^\s()<>]+\)))*\)|[^\s`!()\[\]{};:'".,<>?«»“”‘’]))/i;

                            if (regexp.test(cell.value)) {
                                graph.setLinkForCell(cell, cell.value);
                            }

                            // Adds spacing
                            cell.geometry.width += graph.gridSize;
                            cell.geometry.height += graph.gridSize;
                        } finally {
                            graph.getModel().endUpdate();
                        }

                        return [cell];
                    }
                }
            }
        }

        return [];
    };

    /**
     * Formats the given file size.
     */
    EditorUi.prototype.formatFileSize = function (size) {
        var units = [' kB', ' MB', ' GB', ' TB', 'PB', 'EB', 'ZB', 'YB'];
        var i = -1;

        do {
            size = size / 1024;
            i++;
        } while (size > 1024);

        return Math.max(size, 0.1).toFixed(1) + units[i];
    };

    /**
     * Imports the given XML into the existing diagram.
     */
    EditorUi.prototype.convertDataUri = function (uri) {
        // Handles special case of data URI which needs to be rewritten
        // to be used in a cell style to remove the semicolon
        if (uri.substring(0, 5) == 'data:') {
            var semi = uri.indexOf(';');

            if (semi > 0) {
                uri = uri.substring(0, semi) + uri.substring(uri.indexOf(',', semi + 1));
            }
        }

        return uri;
    };

    /**
     * Returns true for Gliffy data.
     */
    EditorUi.prototype.isRemoteFileFormat = function (data, filename) {
        return /(\"contentType\":\s*\"application\/gliffy\+json\")/.test(data);
    };

    /**
     * Returns true for Gliffy
     */
    EditorUi.prototype.isLucidChartData = function (data) {
        return data != null && (data.substring(0, 26) ==
            '{"state":"{\\"Properties\\":' ||
            data.substring(0, 14) == '{"Properties":');
    };

    /**
     * Imports a local file from the device or local storage.
     */
    EditorUi.prototype.importLocalFile = function (device, noSplash) {
        if (device && Graph.fileSupport) {
            if (this.importFileInputElt == null) {
                var input = document.createElement('input');
                input.setAttribute('type', 'file');

                mxEvent.addListener(input, 'change', mxUtils.bind(this, function () {
                    if (input.files != null) {
                        // Using null for position will disable crop of input file
                        this.importFiles(input.files, null, null, this.maxImageSize);

                        // Resets input to force change event for same file (type reset required for IE)
                        input.type = '';
                        input.type = 'file';
                        input.value = '';
                    }
                }));

                input.style.display = 'none';
                document.body.appendChild(input);
                this.importFileInputElt = input;
            }

            this.importFileInputElt.click();
        } else {
            window.openNew = false;
            window.openKey = 'import';

            if (!noSplash) {
                var prevValue = Editor.useLocalStorage;
                Editor.useLocalStorage = !device;
            }

            // Closes dialog after open
            window.openFile = new OpenFile(mxUtils.bind(this, function (cancel) {
                this.hideDialog(cancel);
            }));

            window.openFile.setConsumer(mxUtils.bind(this, function (xml, filename) {
                if (filename != null && Graph.fileSupport && /(\.v(dx|sdx?))($|\?)/i.test(filename)) {
                    // "Not a UTF 8 file" when opening VSDX in IE so this is never called
                    var file = new Blob([xml], {type: 'application/octet-stream'})

                    this.importVisio(file, mxUtils.bind(this, function (xml) {
                        this.importXml(xml, 0, 0, true);
                    }), null, filename);
                } else {
                    this.editor.graph.setSelectionCells(this.importXml(xml, 0, 0, true));
                }
            }));

            // Removes openFile if dialog is closed
            this.showDialog(new OpenDialog(this).container, 360, 220, true, true, function () {
                window.openFile = null;
            });

            // Extends dialog close to show splash screen
            if (!noSplash) {
                var dlg = this.dialog;
                var dlgClose = dlg.close;

                this.dialog.close = mxUtils.bind(this, function (cancel) {
                    Editor.useLocalStorage = prevValue;
                    dlgClose.apply(dlg, arguments);

                    if (cancel && this.getCurrentFile() == null && urlParams['embed'] != '1') {
                        this.showSplash();
                    }
                });
            }
        }
    };


    EditorUi.prototype.importZipFile = function (file, success, onerror) {
        var ui = this;

        var delayed = mxUtils.bind(this, function () {
            this.loadingExtensions = false;

            if (typeof JSZip !== 'undefined') {
                JSZip.loadAsync(file)
                    .then(function (zip) {
                        if (Object.keys(zip.files).length == 0) {
                            onerror();
                        } else {
                            var gliffyLatestVer = {version: 0};
                            var drawioFound = false;

                            zip.forEach(function (relativePath, zipEntry) {
                                var name = zipEntry.name.toLowerCase();

                                if (name == 'diagram/diagram.xml') //draw.io zip format has the latest diagram version at diagram/diagram.xml
                                {
                                    drawioFound = true;

                                    zipEntry.async("string").then(function (str) {
                                        if (str.indexOf('<mxfile ') == 0) {
                                            success(str);
                                        } else {
                                            onerror();
                                        }
                                    });
                                } else if (name.indexOf('versions/') == 0) //Gliffy zip format has the versions inside versions folder
                                {
                                    var version = parseInt(name.substr(9)); //9 is the length of versions/

                                    if (version > gliffyLatestVer.version) {
                                        gliffyLatestVer = {version: version, zipEntry: zipEntry}
                                    }
                                }
                            });

                            if (gliffyLatestVer.version > 0) {
                                gliffyLatestVer.zipEntry.async("string").then(function (data) {
                                    if (!ui.isOffline() && new XMLHttpRequest().upload && ui.isRemoteFileFormat(data, file.name)) {
                                        ui.parseFile(new Blob([data], {type: 'application/octet-stream'}), mxUtils.bind(this, function (xhr) {
                                            if (xhr.readyState == 4) {
                                                if (xhr.status >= 200 && xhr.status <= 299) {
                                                    success(xhr.responseText);
                                                } else {
                                                    onerror();
                                                }
                                            }
                                        }), file.name);
                                    } else {
                                        onerror();
                                    }
                                });
                            } else if (!drawioFound) {
                                onerror();
                            }
                        }
                    }, function (e) {
                        onerror(e);
                    });
            } else {
                onerror();
            }
        });

        if (typeof JSZip === 'undefined' && !this.loadingExtensions && !this.isOffline(true)) {
            this.loadingExtensions = true;
            mxscript('js/extensions.min.js', delayed);
        } else {
            delayed();
        }
    };

    /**
     * Imports the given XML into the existing diagram.
     */
    EditorUi.prototype.importFile = function (data, mimeType, dx, dy, w, h, filename, done, file, crop, ignoreEmbeddedXml) {
        crop = (crop != null) ? crop : true;
        var async = false;
        var cells = null;

        var handleResult = mxUtils.bind(this, function (xml) {
            var importedCells = null;

            if (xml != null && xml.substring(0, 10) == '<mxlibrary') {
                this.loadLibrary(new LocalLibrary(this, xml, filename));
            } else {
                importedCells = this.importXml(xml, dx, dy, crop);
            }

            if (done != null) {
                done(importedCells);
            }
        });

        if (mimeType.substring(0, 5) == 'image') {
            var containsModel = false;

            if (mimeType.substring(0, 9) == 'image/png') {
                var xml = (ignoreEmbeddedXml) ? null : this.extractGraphModelFromPng(data);

                if (xml != null && xml.length > 0) {
                    cells = this.importXml(xml, dx, dy, crop);
                    containsModel = true;
                }
            }

            if (!containsModel) {
                var graph = this.editor.graph;

                // Strips encoding bit (eg. ;base64,) for cell style
                var semi = data.indexOf(';');

                if (semi > 0) {
                    data = data.substring(0, semi) + data.substring(data.indexOf(',', semi + 1));
                }

                if (crop && graph.isGridEnabled()) {
                    dx = graph.snap(dx);
                    dy = graph.snap(dy);
                }

                cells = [graph.insertVertex(null, null, '', dx, dy, w, h,
                    'shape=image;verticalLabelPosition=bottom;labelBackgroundColor=#ffffff;' +
                    'verticalAlign=top;aspect=fixed;imageAspect=0;image=' + data + ';')];
            }
        } else if (/(\.*<graphml )/.test(data)) {
            async = true;

            this.importGraphML(data, handleResult);
        } else if (file != null && filename != null && ((/(\.v(dx|sdx?))($|\?)/i.test(filename)) || /(\.vs(x|sx?))($|\?)/i.test(filename))) {
            //  LATER: done and async are a hack before making this asynchronous
            async = true;

            this.importVisio(file, handleResult);
        } else if (!this.isOffline() && new XMLHttpRequest().upload && this.isRemoteFileFormat(data, filename)) {
            //  LATER: done and async are a hack before making this asynchronous
            async = true;

            // Returns empty cells array as it is aysynchronous
            this.parseFile((file != null) ? file : new Blob([data], {type: 'application/octet-stream'}), mxUtils.bind(this, function (xhr) {
                if (xhr.readyState == 4) {
                    if (xhr.status >= 200 && xhr.status <= 299) {
                        handleResult(xhr.responseText);
                    } else if (done != null) {
                        done(null);
                    }
                }
            }), filename);
        } else if (data.indexOf('PK') == 0 && file != null) {
            async = true;

            this.importZipFile(file, handleResult, mxUtils.bind(this, function () {
                //If importing as a zip file failed, just insert as text
                cells = this.insertTextAt(this.validateFileData(data), dx, dy, true, null, crop);
                done(cells);
            }));
        } else if (!/(\.v(sd|dx))($|\?)/i.test(filename) && !/(\.vs(s|x))($|\?)/i.test(filename)) {
            cells = this.insertTextAt(this.validateFileData(data), dx, dy, true, null, crop);
        }

        if (!async && done != null) {
            done(cells);
        }

        return cells;
    };

    /**
     * Base64 encodes the given string. This method seems to be more
     * robust for encoding PNG from binary AJAX responses.
     */
    EditorUi.prototype.base64Encode = function (str) {
        var CHARS = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";
        var out = "", i = 0, len = str.length, c1, c2, c3;

        while (i < len) {
            c1 = str.charCodeAt(i++) & 0xff;

            if (i == len) {
                out += CHARS.charAt(c1 >> 2);
                out += CHARS.charAt((c1 & 0x3) << 4);
                out += "==";
                break;
            }

            c2 = str.charCodeAt(i++);

            if (i == len) {
                out += CHARS.charAt(c1 >> 2);
                out += CHARS.charAt(((c1 & 0x3) << 4) | ((c2 & 0xF0) >> 4));
                out += CHARS.charAt((c2 & 0xF) << 2);
                out += "=";
                break;
            }

            c3 = str.charCodeAt(i++);
            out += CHARS.charAt(c1 >> 2);
            out += CHARS.charAt(((c1 & 0x3) << 4) | ((c2 & 0xF0) >> 4));
            out += CHARS.charAt(((c2 & 0xF) << 2) | ((c3 & 0xC0) >> 6));
            out += CHARS.charAt(c3 & 0x3F);
        }

        return out;
    };

    /**
     *
     */
    EditorUi.prototype.importFiles = function (files, x, y, maxSize, fn, resultFn, filterFn, barrierFn, resizeDialog, maxBytes, resampleThreshold, ignoreEmbeddedXml) {
        x = (x != null) ? x : 0;
        y = (y != null) ? y : 0;
        maxSize = (maxSize != null) ? maxSize : this.maxImageSize;
        maxBytes = (maxBytes != null) ? maxBytes : this.maxImageBytes;

        var crop = x != null && y != null;
        var resizeImages = true;

        // Checks if large images are imported
        var largeImages = false;

        if (!mxClient.IS_CHROMEAPP && files != null) {
            var thresh = resampleThreshold || this.resampleThreshold;

            for (var i = 0; i < files.length; i++) {
                if (files[i].type.substring(0, 6) == 'image/' && files[i].size > thresh) {
                    largeImages = true;

                    break;
                }
            }
        }

        var doImportFiles = mxUtils.bind(this, function () {
            var graph = this.editor.graph;
            var gs = graph.gridSize;

            fn = (fn != null) ? fn : mxUtils.bind(this, function (data, mimeType, x, y, w, h, filename, done, file) {
                if (data != null && data.substring(0, 10) == '<mxlibrary') {
                    this.spinner.stop();
                    this.loadLibrary(new LocalLibrary(this, data, filename));

                    return null;
                } else {
                    return this.importFile(data, mimeType, x, y, w, h, filename, done, file, crop, ignoreEmbeddedXml);
                }
            });

            resultFn = (resultFn != null) ? resultFn : mxUtils.bind(this, function (cells) {
                graph.setSelectionCells(cells);
            });

            if (this.spinner.spin(document.body, mxResources.get('loading'))) {
                var count = files.length;
                var remain = count;
                var queue = [];

                // Barrier waits for all files to be loaded asynchronously
                var barrier = mxUtils.bind(this, function (index, fnc) {
                    queue[index] = fnc;

                    if (--remain == 0) {
                        this.spinner.stop();

                        if (barrierFn != null) {
                            barrierFn(queue);
                        } else {
                            var cells = [];

                            graph.getModel().beginUpdate();
                            try {
                                for (var j = 0; j < queue.length; j++) {
                                    var tmp = queue[j]();

                                    if (tmp != null) {
                                        cells = cells.concat(tmp);
                                    }
                                }
                            } finally {
                                graph.getModel().endUpdate();
                            }
                        }

                        resultFn(cells);
                    }
                });

                for (var i = 0; i < count; i++) {
                    (mxUtils.bind(this, function (index) {
                        var file = files[index];

                        if (file != null) {
                            var reader = new FileReader();

                            reader.onload = mxUtils.bind(this, function (e) {
                                if (filterFn == null || filterFn(file)) {
                                    if (file.type.substring(0, 6) == 'image/') {
                                        if (file.type.substring(0, 9) == 'image/svg') {
                                            // Checks if SVG contains content attribute
                                            var data = e.target.result;
                                            var comma = data.indexOf(',');
                                            var svgText = decodeURIComponent(escape(atob(data.substring(comma + 1))));
                                            var root = mxUtils.parseXml(svgText);
                                            var svgs = root.getElementsByTagName('svg');

                                            if (svgs.length > 0) {
                                                var svgRoot = svgs[0];
                                                var cont = (ignoreEmbeddedXml) ? null : svgRoot.getAttribute('content');

                                                if (cont != null && cont.charAt(0) != '<' && cont.charAt(0) != '%') {
                                                    cont = unescape((window.atob) ? atob(cont) : Base64.decode(cont, true));
                                                }

                                                if (cont != null && cont.charAt(0) == '%') {
                                                    cont = decodeURIComponent(cont);
                                                }

                                                if (cont != null && (cont.substring(0, 8) === '<mxfile ' ||
                                                    cont.substring(0, 14) === '<mxGraphModel ')) {
                                                    barrier(index, mxUtils.bind(this, function () {
                                                        return fn(cont, 'text/xml', x + index * gs, y + index * gs, 0, 0, file.name);
                                                    }));
                                                } else {
                                                    // SVG needs special handling to add viewbox if missing and
                                                    // find initial size from SVG attributes (only for IE11)
                                                    barrier(index, mxUtils.bind(this, function () {
                                                        try {
                                                            var prefix = data.substring(0, comma + 1);

                                                            // Parses SVG and find width and height
                                                            if (root != null) {
                                                                var svgs = root.getElementsByTagName('svg');

                                                                if (svgs.length > 0) {
                                                                    var svgRoot = svgs[0];
                                                                    var w = parseFloat(svgRoot.getAttribute('width'));
                                                                    var h = parseFloat(svgRoot.getAttribute('height'));

                                                                    // Check if viewBox attribute already exists
                                                                    var vb = svgRoot.getAttribute('viewBox');

                                                                    if (vb == null || vb.length == 0) {
                                                                        svgRoot.setAttribute('viewBox', '0 0 ' + w + ' ' + h);
                                                                    }
                                                                        // Uses width and height from viewbox for
                                                                    // missing width and height attributes
                                                                    else if (isNaN(w) || isNaN(h)) {
                                                                        var tokens = vb.split(' ');

                                                                        if (tokens.length > 3) {
                                                                            w = parseFloat(tokens[2]);
                                                                            h = parseFloat(tokens[3]);
                                                                        }
                                                                    }

                                                                    data = this.createSvgDataUri(mxUtils.getXml(svgRoot));
                                                                    var s = Math.min(1, Math.min(maxSize / Math.max(1, w)), maxSize / Math.max(1, h));
                                                                    var cells = fn(data, file.type, x + index * gs, y + index * gs, Math.max(
                                                                        1, Math.round(w * s)), Math.max(1, Math.round(h * s)), file.name);

                                                                    // Hack to fix width and height asynchronously
                                                                    if (isNaN(w) || isNaN(h)) {
                                                                        var img = new Image();

                                                                        img.onload = mxUtils.bind(this, function () {
                                                                            w = Math.max(1, img.width);
                                                                            h = Math.max(1, img.height);

                                                                            cells[0].geometry.width = w;
                                                                            cells[0].geometry.height = h;

                                                                            svgRoot.setAttribute('viewBox', '0 0 ' + w + ' ' + h);
                                                                            data = this.createSvgDataUri(mxUtils.getXml(svgRoot));

                                                                            var semi = data.indexOf(';');

                                                                            if (semi > 0) {
                                                                                data = data.substring(0, semi) + data.substring(data.indexOf(',', semi + 1));
                                                                            }

                                                                            graph.setCellStyles('image', data, [cells[0]]);
                                                                        });

                                                                        img.src = this.createSvgDataUri(mxUtils.getXml(svgRoot));
                                                                    }

                                                                    return cells;
                                                                }
                                                            }
                                                        } catch (e) {
                                                            // ignores any SVG parsing errors
                                                        }

                                                        return null;
                                                    }));
                                                }
                                            } else {
                                                barrier(index, mxUtils.bind(this, function () {
                                                    return null;
                                                }));
                                            }
                                        } else {
                                            // Checks if PNG+XML is available to bypass code below
                                            var containsModel = false;

                                            if (file.type == 'image/png') {
                                                var xml = (ignoreEmbeddedXml) ? null : this.extractGraphModelFromPng(e.target.result);

                                                if (xml != null && xml.length > 0) {
                                                    var img = new Image();
                                                    img.src = e.target.result;

                                                    barrier(index, mxUtils.bind(this, function () {
                                                        return fn(xml, 'text/xml', x + index * gs, y + index * gs,
                                                            img.width, img.height, file.name);
                                                    }));

                                                    containsModel = true;
                                                }
                                            }

                                            // Additional asynchronous step for finding image size
                                            if (!containsModel) {
                                                // Cannot load local files in Chrome App
                                                if (mxClient.IS_CHROMEAPP) {
                                                    this.spinner.stop();
                                                    this.showError(mxResources.get('error'), mxResources.get('dragAndDropNotSupported'),
                                                        mxResources.get('cancel'), mxUtils.bind(this, function () {
                                                            // Hides the dialog
                                                        }), null, mxResources.get('ok'), mxUtils.bind(this, function () {
                                                            // Redirects to import function
                                                            this.actions.get('import').funct();
                                                        })
                                                    );
                                                } else {
                                                    this.loadImage(e.target.result, mxUtils.bind(this, function (img) {
                                                        this.resizeImage(img, e.target.result, mxUtils.bind(this, function (data2, w2, h2) {
                                                            barrier(index, mxUtils.bind(this, function () {
                                                                // Refuses to insert images above a certain size as they kill the app
                                                                if (data2 != null && data2.length < maxBytes) {
                                                                    var s = (!resizeImages || !this.isResampleImage(e.target.result, resampleThreshold)) ? 1 : Math.min(1, Math.min(maxSize / w2, maxSize / h2));

                                                                    return fn(data2, file.type, x + index * gs, y + index * gs, Math.round(w2 * s), Math.round(h2 * s), file.name);
                                                                } else {
                                                                    this.handleError({message: mxResources.get('imageTooBig')});

                                                                    return null;
                                                                }
                                                            }));
                                                        }), resizeImages, maxSize, resampleThreshold);
                                                    }), mxUtils.bind(this, function () {
                                                        this.handleError({message: mxResources.get('invalidOrMissingFile')});
                                                    }));
                                                }
                                            }
                                        }
                                    } else {
                                        fn(e.target.result, file.type, x + index * gs, y + index * gs, 240, 160, file.name, function (cells) {
                                            barrier(index, function () {
                                                return cells;
                                            });
                                        }, file);
                                    }
                                }
                            });

                            // Handles special cases
                            if (/(\.v(dx|sdx?))($|\?)/i.test(file.name) || /(\.vs(x|sx?))($|\?)/i.test(file.name)) {
                                fn(null, file.type, x + index * gs, y + index * gs, 240, 160, file.name, function (cells) {
                                    barrier(index, function () {
                                        return cells;
                                    });
                                }, file);
                            } else if (file.type.substring(0, 5) == 'image') {
                                reader.readAsDataURL(file);
                            } else {
                                reader.readAsText(file);
                            }
                        }
                    }))(i);
                }
            }
        });

        if (largeImages) {
            // Workaround for lost files array in async code
            var tmp = [];

            for (var i = 0; i < files.length; i++) {
                tmp.push(files[i]);
            }

            files = tmp;

            this.confirmImageResize(function (doResize) {
                resizeImages = doResize;
                doImportFiles();
            }, resizeDialog);
        } else {
            doImportFiles();
        }
    };

    /**
     * Parses the file using XHR2 via the server. File can be a blob or file object.
     * Filename is an optional parameter for blobs (that do not have a filename).
     */
    EditorUi.prototype.confirmImageResize = function (fn, force) {
        force = (force != null) ? force : false;
        var resume = (this.spinner != null && this.spinner.pause != null) ? this.spinner.pause() : function () {
        };
        var resizeImages = (isLocalStorage || mxClient.IS_CHROMEAPP) ? mxSettings.getResizeImages() : null;

        var wrapper = function (remember, resize) {
            if (remember || force) {
                mxSettings.setResizeImages((remember) ? resize : null);
                mxSettings.save();
            }

            resume();
            fn(resize);
        };

        if (resizeImages != null && !force) {
            wrapper(false, resizeImages);
        } else {
            this.showDialog(new ConfirmDialog(this, mxResources.get('resizeLargeImages'),
                function (remember) {
                    wrapper(remember, true);
                },
                function (remember) {
                    wrapper(remember, false);
                }, mxResources.get('resize'), mxResources.get('actualSize'),
                '<img style="margin-top:8px;" src="' + Editor.loResImage + '"/>',
                '<img style="margin-top:8px;" src="' + Editor.hiResImage + '"/>',
                isLocalStorage || mxClient.IS_CHROMEAPP).container, 340,
                (isLocalStorage || mxClient.IS_CHROMEAPP) ? 220 : 200, true, true);
        }
    };

    /**
     * Parses the file using XHR2 via the server. File can be a blob or file object.
     * Filename is an optional parameter for blobs (that do not have a filename).
     */
    EditorUi.prototype.parseFile = function (file, fn, filename) {
        filename = (filename != null) ? filename : file.name;

        var formData = new FormData();
        formData.append('format', 'xml');
        formData.append('upfile', file, filename);

        var xhr = new XMLHttpRequest();
        xhr.open('POST', OPEN_URL);

        xhr.onreadystatechange = function () {
            fn(xhr);
        };

        xhr.send(formData);

        try {
            EditorUi.logEvent({
                category: 'GLIFFY-IMPORT-FILE',
                action: 'size_' + file.size
            });
        } catch (e) {
            // ignore
        }
    };

    /**
     *
     */
    EditorUi.prototype.isResampleImage = function (data, thresh) {
        thresh = (thresh != null) ? thresh : this.resampleThreshold;

        return data.length > thresh;
    };

    /**
     * Resizes the given image if <maxImageBytes> is not null.
     */
    EditorUi.prototype.resizeImage = function (img, data, fn, enabled, maxSize, thresh) {
        maxSize = (maxSize != null) ? maxSize : this.maxImageSize;
        var w = Math.max(1, img.width);
        var h = Math.max(1, img.height);

        if (enabled && this.isResampleImage(data, thresh)) {
            try {
                var factor = Math.max(w / maxSize, h / maxSize);

                if (factor > 1) {
                    var w2 = Math.round(w / factor);
                    var h2 = Math.round(h / factor);

                    var canvas = document.createElement('canvas');
                    canvas.width = w2;
                    canvas.height = h2;

                    var ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, w2, h2);

                    var tmp = canvas.toDataURL();

                    // Uses new image if smaller
                    if (tmp.length < data.length) {
                        // Checks if the image is empty by comparing
                        // with an empty image of the same size
                        var canvas2 = document.createElement('canvas');
                        canvas2.width = w2;
                        canvas2.height = h2;
                        var tmp2 = canvas2.toDataURL();

                        if (tmp !== tmp2) {
                            data = tmp;
                            w = w2;
                            h = h2;
                        }
                    }
                }
            } catch (e) {
                // ignores image scaling errors
            }
        }

        fn(data, w, h);
    };

    EditorUi.prototype.crcTable = [];

    for (var n = 0; n < 256; n++) {
        var c = n;

        for (var k = 0; k < 8; k++) {
            if ((c & 1) == 1) {
                c = 0xedb88320 ^ (c >>> 1);
            } else {
                c >>>= 1;
            }

            EditorUi.prototype.crcTable[n] = c;
        }
    }

    EditorUi.prototype.updateCRC = function (crc, data, off, len) {
        var c = crc;

        for (var n = 0; n < len; n++) {
            c = EditorUi.prototype.crcTable[(c ^ data.charCodeAt(off + n)) & 0xff] ^ (c >>> 8);
        }

        return c;
    };

    EditorUi.prototype.crc32 = function (str) {
        this.crcTable = this.crcTable || this.createCrcTable();
        var crc = 0 ^ (-1);

        for (var i = 0; i < str.length; i++) {
            crc = (crc >>> 8) ^ this.crcTable[(crc ^ str.charCodeAt(i)) & 0xFF];
        }

        return (crc ^ (-1)) >>> 0;
    };

    /**
     * Adds the given text to the compressed or non-compressed text chunk.
     */
    EditorUi.prototype.writeGraphModelToPng = function (data, type, key, value, error) {
        var base64 = data.substring(data.indexOf(',') + 1);
        var f = (window.atob) ? atob(base64) : Base64.decode(base64, true);
        var pos = 0;

        function fread(d, count) {
            var start = pos;
            pos += count;

            return d.substring(start, pos);
        };

        // Reads unsigned long 32 bit big endian
        function _freadint(d) {
            var bytes = fread(d, 4);

            return bytes.charCodeAt(3) + (bytes.charCodeAt(2) << 8) +
                (bytes.charCodeAt(1) << 16) + (bytes.charCodeAt(0) << 24);
        };

        function writeInt(num) {
            return String.fromCharCode((num >> 24) & 0x000000ff, (num >> 16) & 0x000000ff,
                (num >> 8) & 0x000000ff, num & 0x000000ff);
        };

        // Checks signature
        if (fread(f, 8) != String.fromCharCode(137) + 'PNG' + String.fromCharCode(13, 10, 26, 10)) {
            if (error != null) {
                error();
            }

            return;
        }

        // Reads header chunk
        fread(f, 4);

        if (fread(f, 4) != 'IHDR') {
            if (error != null) {
                error();
            }

            return;
        }

        fread(f, 17);
        var result = f.substring(0, pos);

        do {
            var n = _freadint(f);
            var chunk = fread(f, 4);

            if (chunk == 'IDAT') {
                result = f.substring(0, pos - 8);

                if (type == 'pHYs' && key == 'dpi') {
                    var dpm = Math.round(value / 0.0254); //One inch is equal to exactly 0.0254 meters.
                    var chunkData = writeInt(dpm) + writeInt(dpm) + String.fromCharCode(1);
                } else {
                    var chunkData = key + String.fromCharCode(0) +
                        ((type == 'zTXt') ? String.fromCharCode(0) : '') +
                        value;
                }

                var crc = 0xffffffff;
                crc = this.updateCRC(crc, type, 0, 4);
                crc = this.updateCRC(crc, chunkData, 0, chunkData.length);

                result += writeInt(chunkData.length) + type + chunkData + writeInt(crc ^ 0xffffffff);
                result += f.substring(pos - 8, f.length);

                break;
            }

            result += f.substring(pos - 8, pos - 4 + n);
            fread(f, n);
            fread(f, 4);
        }
        while (n);

        return 'data:image/png;base64,' + ((window.btoa) ? btoa(result) : Base64.encode(result, true));
    };

    /**
     * Extracts the XML from the compressed or non-compressed text chunk.
     */
    EditorUi.prototype.extractGraphModelFromPng = function (data) {
        return Editor.extractGraphModelFromPng(data);
    };

    /**
     * Loads the image from the given URI.
     *
     * @param {number} dx X-coordinate of the translation.
     * @param {number} dy Y-coordinate of the translation.
     */
    EditorUi.prototype.loadImage = function (uri, onload, onerror) {
        try {
            var img = new Image();

            img.onload = function () {
                onload(img);
            }

            if (onerror != null) {
                img.onerror = onerror;
            }

            img.src = uri;
        } catch (e) {
            if (onerror != null) {
                onerror(e);
            } else {
                throw e;
            }
        }
    };

    // Initializes the user interface
    var editorUiInit = EditorUi.prototype.init;
    EditorUi.prototype.init = function () {
        mxStencilRegistry.allowEval = mxStencilRegistry.allowEval && !this.isOfflineApp();

        // Must be set before UI is created in superclass
        if (typeof window.mxSettings !== 'undefined') {
            this.formatWidth = mxSettings.getFormatWidth();
        }

        var ui = this;
        var graph = this.editor.graph;

        // Redirects custom link title via UI for page links
        graph.getLinkTitle = function (href) {
            return ui.getLinkTitle(href);
        };

        // Redirects custom link via UI for page link handling
        graph.customLinkClicked = function (link) {
            var done = false;

            try {
                ui.handleCustomLink(link);
                done = true;
            } catch (e) {
                ui.handleError(e);
            }

            return done;
        };

        // Extends clear default style to clear persisted settings
        var clearDefaultStyle = this.clearDefaultStyle;

        this.clearDefaultStyle = function () {
            clearDefaultStyle.apply(this, arguments);
        };

        // Sets help link for placeholders
        if (!this.isOffline() && typeof window.EditDataDialog !== 'undefined') {
            EditDataDialog.placeholderHelpLink = 'https://desk.draw.io/support/solutions/articles/16000051979';
        }

        // Passes current page to editor window
        var editorGetEditBlankUrl = ui.editor.getEditBlankUrl;

        this.editor.getEditBlankUrl = function (params) {
            params = (params != null) ? params : '';

            if (ui.pages != null && ui.currentPage != null) {
                for (var i = 0; i < ui.pages.length; i++) {
                    if (ui.pages[i] == ui.currentPage) {
                        if (i > 0) {
                            params += ((params.length > 0) ? '&' : '?') + 'page=' + i;
                        }

                        break;
                    }
                }
            }

            if (urlParams['dev'] == '1') {
                params += ((params.length > 0) ? '&' : '?') + 'dev=1&drawdev=1';
            }

            return editorGetEditBlankUrl.apply(this, arguments);
        };

        // For chromeless mode and lightbox mode in viewer
        // Must be overridden before supercall to be applied
        // in case of chromeless initialization
        var graphAddClickHandler = graph.addClickHandler;

        graph.addClickHandler = function (highlight, beforeClick, onClick) {
            var tmp = beforeClick;

            beforeClick = function (evt, href) {
                if (href == null) {
                    var source = mxEvent.getSource(evt);

                    if (source.nodeName.toLowerCase() == 'a') {
                        href = source.getAttribute('href');
                    }
                }

                if (href != null && graph.isCustomLink(href) &&
                    (mxEvent.isTouchEvent(evt) ||
                        !mxEvent.isPopupTrigger(evt)) &&
                    graph.customLinkClicked(href)) {
                    mxEvent.consume(evt);
                }

                if (tmp != null) {
                    tmp(evt, href);
                }
            };

            // For some reason, local argument override is not enough in this case...
            graphAddClickHandler.call(this, highlight, beforeClick, onClick);
        };

        editorUiInit.apply(this, arguments);

        if (mxClient.IS_SVG) {
            // LATER: Add shadow for labels in graph.container (eg. math, NO_FO), scaling
            this.editor.graph.addSvgShadow(graph.view.canvas.ownerSVGElement, null, true);
        }

        // Specifies the default filename
        this.defaultFilename = mxResources.get('untitledDiagram');

        // Adds export for %page%, %pagenumber% and %pagecount% placeholders
        var graphGetExportVariables = graph.getExportVariables;

        graph.getExportVariables = function () {
            var vars = graphGetExportVariables.apply(this, arguments);

            vars['pagecount'] = (ui.pages != null) ? ui.pages.length : 1;
            vars['page'] = (ui.currentPage != null) ? ui.currentPage.getName() : '';
            vars['pagenumber'] = (ui.pages != null && ui.currentPage != null) ?
                mxUtils.indexOf(ui.pages, ui.currentPage) + 1 : 1;

            return vars;
        };

        // Adds %page%, %pagenumber% and %pagecount% placeholders
        var graphGetGlobalVariable = graph.getGlobalVariable;

        graph.getGlobalVariable = function (name) {
            if (name == 'page' && ui.currentPage != null) {
                return ui.currentPage.getName();
            } else if (name == 'pagenumber') {
                if (ui.currentPage != null && ui.pages != null) {
                    return mxUtils.indexOf(ui.pages, ui.currentPage) + 1;
                } else {
                    return 1;
                }
            } else if (name == 'pagecount') {
                return (ui.pages != null) ? ui.pages.length : 1;
            }

            return graphGetGlobalVariable.apply(this, arguments);
        };

        var graphLabelLinkClicked = graph.labelLinkClicked;

        graph.labelLinkClicked = function (state, elt, evt) {
            var href = elt.getAttribute('href');

            if (href != null && graph.isCustomLink(href) &&
                (mxEvent.isTouchEvent(evt) ||
                    !mxEvent.isPopupTrigger(evt))) {
                // Active links are moved to the hint
                if (!graph.isEnabled() || (state != null && graph.isCellLocked(state.cell))) {
                    graph.customLinkClicked(href);

                    // Resets rubberband after click on locked cell
                    graph.getRubberband().reset();
                }

                mxEvent.consume(evt);
            } else {
                graphLabelLinkClicked.apply(this, arguments);
            }
        };

        // Overrides editor filename
        this.editor.getOrCreateFilename = function () {
            var filename = ui.defaultFilename;
            var file = ui.getCurrentFile();

            if (file != null) {
                filename = (file.getTitle() != null) ? file.getTitle() : filename;
            }

            return filename;
        };

        // Installs additional keyboard shortcuts for editor
        if (!this.editor.chromeless || this.editor.editable) {
            // Defines additional hotkeys
            this.keyHandler.bindAction(70, true, 'find'); // Ctrl+F
            this.keyHandler.bindAction(67, true, 'copyStyle', true); // Ctrl+Shift+C
            this.keyHandler.bindAction(86, true, 'pasteStyle', true); // Ctrl+Shift+V
            this.keyHandler.bindAction(77, true, 'editGeometry', true); // Ctrl+Shift+M
            this.keyHandler.bindAction(88, true, 'insertText', true); // Ctrl+Shift+X
            this.keyHandler.bindAction(75, true, 'insertRectangle'); // Ctrl+K
            this.keyHandler.bindAction(75, true, 'insertEllipse', true); // Ctrl+Shift+K

            this.installImagePasteHandler();
            this.installNativeClipboardHandler();
        }
        ;

        var y = Math.max(document.body.clientHeight || 0, document.documentElement.clientHeight || 0) / 2;
        var x = document.body.clientWidth / 2 - 2;

        // Holds the x-coordinate of the point
        this.spinner = this.createSpinner(x, y, 24);

        // Installs drag and drop handler for rich text editor
        if (Graph.fileSupport) {
            this.editor.graph.addListener(mxEvent.EDITING_STARTED, mxUtils.bind(this, function (evt) {
                // Setup the dnd listeners
                var graph = this.editor.graph;
                var textElt = graph.cellEditor.text2;
                var dropElt = null;

                if (textElt != null) {
                    mxEvent.addListener(textElt, 'dragleave', function (evt) {
                        if (dropElt != null) {
                            dropElt.parentNode.removeChild(dropElt);
                            dropElt = null;
                        }

                        evt.stopPropagation();
                        evt.preventDefault();
                    });

                    mxEvent.addListener(textElt, 'dragover', mxUtils.bind(this, function (evt) {
                        // IE 10 does not implement pointer-events so it can't have a drop highlight
                        if (dropElt == null && (!mxClient.IS_IE || document.documentMode > 10)) {
                            dropElt = this.highlightElement(textElt);
                        }

                        evt.stopPropagation();
                        evt.preventDefault();
                    }));

                    mxEvent.addListener(textElt, 'drop', mxUtils.bind(this, function (evt) {
                        if (dropElt != null) {
                            dropElt.parentNode.removeChild(dropElt);
                            dropElt = null;
                        }

                        if (evt.dataTransfer.files.length > 0) {
                            this.importFiles(evt.dataTransfer.files, 0, 0, this.maxImageSize, function (data, mimeType, x, y, w, h) {
                                // Inserts image into current text box
                                graph.insertImage(data, w, h);
                            }, function () {
                                // No post processing
                            }, function (file) {
                                // Handles only images
                                return file.type.substring(0, 6) == 'image/';
                            }, function (queue) {
                                // Invokes elements of queue in order
                                for (var i = 0; i < queue.length; i++) {
                                    queue[i]();
                                }
                            }, mxEvent.isControlDown(evt));
                        } else if (mxUtils.indexOf(evt.dataTransfer.types, 'text/uri-list') >= 0) {
                            var uri = evt.dataTransfer.getData('text/uri-list');

                            if ((/\.(gif|jpg|jpeg|tiff|png|svg)$/i).test(uri)) {
                                this.loadImage(decodeURIComponent(uri), mxUtils.bind(this, function (img) {
                                    var w = Math.max(1, img.width);
                                    var h = Math.max(1, img.height);
                                    var maxSize = this.maxImageSize;

                                    var s = Math.min(1, Math.min(maxSize / Math.max(1, w)), maxSize / Math.max(1, h));
                                    graph.insertImage(decodeURIComponent(uri), w * s, h * s);
                                }));
                            } else {
                                document.execCommand('insertHTML', false, evt.dataTransfer.getData('text/plain'));
                            }
                        } else {
                            if (mxUtils.indexOf(evt.dataTransfer.types, 'text/html') >= 0) {
                                document.execCommand('insertHTML', false, evt.dataTransfer.getData('text/html'));
                            } else if (mxUtils.indexOf(evt.dataTransfer.types, 'text/plain') >= 0) {
                                document.execCommand('insertHTML', false, evt.dataTransfer.getData('text/plain'));
                            }
                        }

                        evt.stopPropagation();
                        evt.preventDefault();
                    }));
                }
            }));
        }

        // Adding mxRuler to editor
        if (typeof window.mxSettings !== 'undefined') {
            var view = this.editor.graph.view;
            view.setUnit(mxSettings.getUnit());

            view.addListener('unitChanged', function (sender, evt) {
                mxSettings.setUnit(evt.getProperty('unit'));
                mxSettings.save();
            });

            var showRuler = urlParams['ruler'] == '1' || (mxSettings.isRulerOn() && urlParams['lightbox'] != '1');
            if (urlParams['preview_header'] == '1') {
                showRuler = false;
            }

            this.ruler = showRuler ? new mxDualRuler(this, view.unit) : null;
            this.refresh();
        }

        // Adds an element to edit the style in the footer in test mode
        if (urlParams['styledev'] == '1') {
            var footer = document.getElementById('geFooter');

            if (footer != null) {
                this.styleInput = document.createElement('input');
                this.styleInput.setAttribute('type', 'text');
                this.styleInput.style.position = 'absolute';
                this.styleInput.style.top = '14px';
                this.styleInput.style.left = '2px';
                // Workaround for ignore right CSS property in FF
                this.styleInput.style.width = '98%';
                this.styleInput.style.visibility = 'hidden';
                this.styleInput.style.opacity = '0.9';

                mxEvent.addListener(this.styleInput, 'change', mxUtils.bind(this, function () {
                    this.editor.graph.getModel().setStyle(this.editor.graph.getSelectionCell(), this.styleInput.value);
                }));

                footer.appendChild(this.styleInput);

                this.editor.graph.getSelectionModel().addListener(mxEvent.CHANGE, mxUtils.bind(this, function (sender, evt) {
                    if (this.editor.graph.getSelectionCount() > 0) {
                        var cell = this.editor.graph.getSelectionCell();
                        var style = this.editor.graph.getModel().getStyle(cell);

                        this.styleInput.value = style || '';
                        this.styleInput.style.visibility = 'visible';
                    } else {
                        this.styleInput.style.visibility = 'hidden';
                    }
                }));
            }

            var isSelectionAllowed = this.isSelectionAllowed;
            this.isSelectionAllowed = function (evt) {
                if (mxEvent.getSource(evt) == this.styleInput) {
                    return true;
                }

                return isSelectionAllowed.apply(this, arguments);
            };
        }

        // Removes info text in page
        var info = document.getElementById('geInfo');

        if (info != null) {
            info.parentNode.removeChild(info);
        }

        // Installs drag and drop handler for files
        // Enables dropping files
        if (Graph.fileSupport && (!this.editor.chromeless || this.editor.editable)) {
            // Setup the dnd listeners
            var dropElt = null;

            mxEvent.addListener(graph.container, 'dragleave', function (evt) {
                if (graph.isEnabled()) {
                    if (dropElt != null) {
                        dropElt.parentNode.removeChild(dropElt);
                        dropElt = null;
                    }

                    evt.stopPropagation();
                    evt.preventDefault();
                }
            });

            mxEvent.addListener(graph.container, 'dragover', mxUtils.bind(this, function (evt) {
                // IE 10 does not implement pointer-events so it can't have a drop highlight
                if (dropElt == null && (!mxClient.IS_IE || document.documentMode > 10)) {
                    dropElt = this.highlightElement(graph.container);
                }

                if (this.sidebar != null) {
                    this.sidebar.hideTooltip();
                }

                evt.stopPropagation();
                evt.preventDefault();
            }));

            mxEvent.addListener(graph.container, 'drop', mxUtils.bind(this, function (evt) {
                if (dropElt != null) {
                    dropElt.parentNode.removeChild(dropElt);
                    dropElt = null;
                }

                if (graph.isEnabled()) {
                    var pt = mxUtils.convertPoint(graph.container, mxEvent.getClientX(evt), mxEvent.getClientY(evt));
                    var tr = graph.view.translate;
                    var scale = graph.view.scale;
                    var x = pt.x / scale - tr.x;
                    var y = pt.y / scale - tr.y;

                    if (mxEvent.isAltDown(evt)) {
                        x = 0;
                        y = 0;
                    }

                    if (evt.dataTransfer.files.length > 0) {
                        this.importFiles(evt.dataTransfer.files, x, y, this.maxImageSize, null, null, null, null,
                            mxEvent.isControlDown(evt), null, null, mxEvent.isShiftDown(evt));
                    } else {
                        var uri = (mxUtils.indexOf(evt.dataTransfer.types, 'text/uri-list') >= 0) ?
                            evt.dataTransfer.getData('text/uri-list') : null;
                        var data = this.extractGraphModelFromEvent(evt, this.pages != null);

                        if (data != null) {
                            graph.setSelectionCells(this.importXml(data, x, y, true));
                        } else if (mxUtils.indexOf(evt.dataTransfer.types, 'text/html') >= 0) {
                            var html = evt.dataTransfer.getData('text/html');
                            var div = document.createElement('div');
                            div.innerHTML = html;

                            // The default is based on the extension
                            var asImage = null;

                            // Extracts single image
                            var imgs = div.getElementsByTagName('img');

                            if (imgs != null && imgs.length == 1) {
                                html = imgs[0].getAttribute('src');

                                // Handles special case where the src attribute has no valid extension
                                // in which case the text would be inserted as text with a link
                                if (!(/\.(gif|jpg|jpeg|tiff|png|svg)$/i).test(html)) {
                                    asImage = true;
                                }
                            } else {
                                // Extracts single link
                                var a = div.getElementsByTagName('a');

                                if (a != null && a.length == 1) {
                                    html = a[0].getAttribute('href');
                                }
                            }

                            var resizeImages = true;

                            var doInsert = mxUtils.bind(this, function () {
                                graph.setSelectionCells(this.insertTextAt(html, x, y, true, asImage, null, resizeImages));
                            });

                            if (asImage && html.length > this.resampleThreshold) {
                                this.confirmImageResize(function (doResize) {
                                    resizeImages = doResize;
                                    doInsert();
                                }, mxEvent.isControlDown(evt));
                            } else {
                                doInsert();
                            }
                        } else if (uri != null && (/\.(gif|jpg|jpeg|tiff|png|svg)$/i).test(uri)) {
                            this.loadImage(decodeURIComponent(uri), mxUtils.bind(this, function (img) {
                                var w = Math.max(1, img.width);
                                var h = Math.max(1, img.height);
                                var maxSize = this.maxImageSize;

                                var s = Math.min(1, Math.min(maxSize / Math.max(1, w)), maxSize / Math.max(1, h));

                                graph.setSelectionCell(graph.insertVertex(null, null, '', x, y, w * s, h * s,
                                    'shape=image;verticalLabelPosition=bottom;labelBackgroundColor=#ffffff;' +
                                    'verticalAlign=top;aspect=fixed;imageAspect=0;image=' + uri + ';'));
                            }), mxUtils.bind(this, function (img) {
                                graph.setSelectionCells(this.insertTextAt(uri, x, y, true));
                            }));
                        } else if (mxUtils.indexOf(evt.dataTransfer.types, 'text/plain') >= 0) {
                            graph.setSelectionCells(this.insertTextAt(evt.dataTransfer.getData('text/plain'), x, y, true));
                        }
                    }
                }

                evt.stopPropagation();
                evt.preventDefault();
            }), false);
        }

        this.initPages();

        // Installs listener for fixing references in undo history in
        // collaborative editing where terminals may have vanished
        // Undo/Redo listener to update edit's references before executing undo/redo
        this.editUpdateListener = mxUtils.bind(this, function (sender, evt) {
            var edit = evt.getProperty('edit');

            if (edit != null) {
                this.updateEditReferences(edit);
            }
        });

        this.editor.undoManager.addListener(mxEvent.BEFORE_UNDO, this.editUpdateListener);
        this.editor.undoManager.addListener(mxEvent.BEFORE_REDO, this.editUpdateListener);

        this.installSettings();
    };

    /**
     * Installs handler for pasting image from clipboard.
     */
    EditorUi.prototype.installImagePasteHandler = function () {
        if (!mxClient.IS_IE) {
            var graph = this.editor.graph;

            graph.container.addEventListener('paste', mxUtils.bind(this, function (evt) {
                if (!mxEvent.isConsumed(evt)) {
                    try {
                        var data = (evt.clipboardData || evt.originalEvent.clipboardData);
                        var containsText = false;

                        // Workaround for asynchronous paste event processing in textInput
                        // is to ignore this event if it contains text/html/rtf (see below).
                        // NOTE: Image is not pasted into textInput so can't listen there.
                        for (var i = 0; i < data.types.length; i++) {
                            if (data.types[i].substring(0, 5) === 'text/') {
                                containsText = true;
                                break;
                            }
                        }

                        if (!containsText) {
                            var items = data.items;

                            for (index in items) {
                                var item = items[index];

                                if (item.kind === 'file') {
                                    if (graph.isEditing()) {
                                        this.importFiles([item.getAsFile()], 0, 0, this.maxImageSize, function (data, mimeType, x, y, w, h) {
                                            // Inserts image into current text box
                                            graph.insertImage(data, w, h);
                                        }, function () {
                                            // No post processing
                                        }, function (file) {
                                            // Handles only images
                                            return file.type.substring(0, 6) == 'image/';
                                        }, function (queue) {
                                            // Invokes elements of queue in order
                                            for (var i = 0; i < queue.length; i++) {
                                                queue[i]();
                                            }
                                        });
                                    } else {
                                        var pt = this.editor.graph.getInsertPoint();
                                        this.importFiles([item.getAsFile()], pt.x, pt.y, this.maxImageSize);
                                        mxEvent.consume(evt);
                                    }

                                    break;
                                }
                            }
                        }
                    } catch (e) {
                        // ignore
                    }
                }
            }), false);
        }
    };

    /**
     * Installs the native clipboard support.
     */
    EditorUi.prototype.installNativeClipboardHandler = function () {
        var graph = this.editor.graph;

        // Focused but invisible textarea during control or meta key events
        var textInput = document.createElement('div');
        textInput.setAttribute('autocomplete', 'off');
        textInput.setAttribute('autocorrect', 'off');
        textInput.setAttribute('autocapitalize', 'off');
        textInput.setAttribute('spellcheck', 'false');
        textInput.style.position = 'absolute';
        textInput.style.whiteSpace = 'nowrap';
        textInput.style.overflow = 'hidden';
        textInput.style.display = 'block';
        textInput.contentEditable = true;
        mxUtils.setOpacity(textInput, 0);
        textInput.style.width = '1px';
        textInput.style.height = '1px';
        textInput.innerHTML = '&nbsp;';

        var restoreFocus = false;

        // Disables built-in cut, copy and paste shortcuts
        this.keyHandler.bindControlKey(88, null);
        this.keyHandler.bindControlKey(67, null);
        this.keyHandler.bindControlKey(86, null);

        // Shows a textare when control/cmd is pressed to handle native clipboard actions
        mxEvent.addListener(document, 'keydown', mxUtils.bind(this, function (evt) {
            // No dialog visible
            var source = mxEvent.getSource(evt);

            if (graph.container != null && graph.isEnabled() && !graph.isMouseDown && !graph.isEditing() &&
                this.dialog == null && source.nodeName != 'INPUT' && source.nodeName != 'TEXTAREA') {
                if (evt.keyCode == 224 /* FF */ || (!mxClient.IS_MAC && evt.keyCode == 17 /* Control */) ||
                    (mxClient.IS_MAC && evt.keyCode == 91 /* Meta */)) {
                    // Cannot use parentNode for check in IE
                    if (!restoreFocus) {
                        // Avoid autoscroll but allow handling of all pass-through ctrl shortcuts
                        textInput.style.left = (graph.container.scrollLeft + 10) + 'px';
                        textInput.style.top = (graph.container.scrollTop + 10) + 'px';

                        graph.container.appendChild(textInput);
                        restoreFocus = true;

                        // Workaround for selected document content in quirks mode
                        if (mxClient.IS_QUIRKS) {
                            window.setTimeout(function () {
                                textInput.focus();
                                document.execCommand('selectAll', false, null);
                            }, 0);
                        } else {
                            textInput.focus();
                            document.execCommand('selectAll', false, null);
                        }
                    }
                }
            }
        }));

        // Clears input and restores focus and selection
        function clearInput() {
            window.setTimeout(function () {
                textInput.innerHTML = '&nbsp;';
                textInput.focus();
                document.execCommand('selectAll', false, null);
            }, 0);
        };

        mxEvent.addListener(document, 'keyup', mxUtils.bind(this, function (evt) {
            // Workaround for asynchronous event read invalid in IE quirks mode
            var keyCode = evt.keyCode;

            // Asynchronous workaround for scroll to origin after paste if the
            // Ctrl-key is not pressed for long enough in FF on Windows
            window.setTimeout(mxUtils.bind(this, function () {
                if (restoreFocus && (keyCode == 224 /* FF */ || keyCode == 17 /* Control */ ||
                    keyCode == 91 /* Meta */)) {
                    restoreFocus = false;

                    if (!graph.isEditing() && this.dialog == null && graph.container != null) {
                        graph.container.focus();
                    }

                    textInput.parentNode.removeChild(textInput);

                    // Workaround for lost cursor in focused element
                    if (this.dialog == null) {
                        mxUtils.clearSelection();
                    }
                }
            }), 0);
        }));

        mxEvent.addListener(textInput, 'copy', mxUtils.bind(this, function (evt) {
            if (graph.isEnabled()) {
                try {
                    mxClipboard.copy(graph);
                    this.copyCells(textInput);
                    clearInput();
                } catch (e) {
                    this.handleError(e);
                }
            }
        }));

        mxEvent.addListener(textInput, 'cut', mxUtils.bind(this, function (evt) {
            if (graph.isEnabled()) {
                try {
                    mxClipboard.copy(graph);
                    this.copyCells(textInput, true);
                    clearInput();
                } catch (e) {
                    this.handleError(e);
                }
            }
        }));

        mxEvent.addListener(textInput, 'paste', mxUtils.bind(this, function (evt) {
            if (graph.isEnabled() && !graph.isCellLocked(graph.getDefaultParent())) {
                textInput.innerHTML = '&nbsp;';
                textInput.focus();

                window.setTimeout(mxUtils.bind(this, function () {
                    this.pasteCells(evt, textInput);
                    textInput.innerHTML = '&nbsp;';
                }), 0);
            }
        }), true);

        // Needed for IE11
        var isSelectionAllowed2 = this.isSelectionAllowed;
        this.isSelectionAllowed = function (evt) {
            if (mxEvent.getSource(evt) == textInput) {
                return true;
            }

            return isSelectionAllowed2.apply(this, arguments);
        };
    };

    /**
     *
     */
    EditorUi.prototype.getLinkTitle = function (href) {
        var title = Graph.prototype.getLinkTitle.apply(this, arguments);

        if (href.substring(0, 13) == 'data:page/id,') {
            var comma = href.indexOf(',');

            if (comma > 0) {
                var page = this.getPageById(href.substring(comma + 1));

                if (page != null) {
                    title = page.getName();
                } else {
                    title = mxResources.get('pageNotFound');
                }
            }
        } else if (href.substring(0, 5) == 'data:') {
            title = mxResources.get('action');
        }

        return title;
    };

    /**
     *
     */
    EditorUi.prototype.handleCustomLink = function (href) {
        if (href.substring(0, 13) == 'data:page/id,') {
            var comma = href.indexOf(',');
            var page = this.getPageById(href.substring(comma + 1));

            if (page) {
                this.selectPage(page)
            } else {
                // Needs fallback for missing resource in case of viewer lightbox
                throw new Error(mxResources.get('pageNotFound') || 'Page not found');
            }
        } else {
            this.editor.graph.handleCustomLink(href);
        }
    };

    /**
     *
     */
    EditorUi.prototype.isSettingsEnabled = function () {
        return typeof window.mxSettings !== 'undefined' && (isLocalStorage || mxClient.IS_CHROMEAPP);
    };

    /**
     * Creates the format panel and adds overrides.
     */
    EditorUi.prototype.installSettings = function () {
        if (this.isSettingsEnabled()) {
            // Gets recent colors from settings
            ColorDialog.recentColors = mxSettings.getRecentColors();

            // Updates UI to reflect current edge style
            this.fireEvent(new mxEventObject('styleChanged', 'keys', [], 'values', [], 'cells', []));

            /**
             * Persists custom fonts.
             */
            this.menus.customFonts = mxSettings.getCustomFonts();

            this.addListener('customFontsChanged', mxUtils.bind(this, function (sender, evt) {
                mxSettings.setCustomFonts(this.menus.customFonts);
                mxSettings.save();
            }));

            /**
             * Persists copy on connect switch.
             */
            this.editor.graph.connectionHandler.setCreateTarget(mxSettings.isCreateTarget());
            this.fireEvent(new mxEventObject('copyConnectChanged'));

            this.addListener('copyConnectChanged', mxUtils.bind(this, function (sender, evt) {
                mxSettings.setCreateTarget(this.editor.graph.connectionHandler.isCreateTarget());
                mxSettings.save();
            }));

            /**
             * Persists default page format.
             */
            this.editor.graph.pageFormat = mxSettings.getPageFormat();

            this.addListener('pageFormatChanged', mxUtils.bind(this, function (sender, evt) {
                mxSettings.setPageFormat(this.editor.graph.pageFormat);
                mxSettings.save();
            }));

            /**
             * Persists default grid color.
             */
            this.editor.graph.view.gridColor = mxSettings.getGridColor();

            this.addListener('gridColorChanged', mxUtils.bind(this, function (sender, evt) {
                mxSettings.setGridColor(this.editor.graph.view.gridColor);
                mxSettings.save();
            }));

            /**
             * Persists autosave switch in Chrome app.
             */
            if (mxClient.IS_CHROMEAPP || EditorUi.isElectronApp) {
                this.editor.addListener('autosaveChanged', mxUtils.bind(this, function (sender, evt) {
                    mxSettings.setAutosave(this.editor.autosave);
                    mxSettings.save();
                }));

                this.editor.autosave = mxSettings.getAutosave();
            }

            /**
             *
             */
            if (this.sidebar != null) {
                this.sidebar.showPalette('search', mxSettings.settings.search);
            }

            // Saves app defaults for UI
            this.addListener('formatWidthChanged', function () {
                mxSettings.setFormatWidth(this.formatWidth);
                mxSettings.save();
            });
        }
    };

    /**
     * Creates the format panel and adds overrides.
     */
    EditorUi.prototype.copyCells = function (elt, removeCells) {
        var graph = this.editor.graph;

        if (!graph.isSelectionEmpty()) {
            var cells = mxUtils.sortCells(graph.model.getTopmostCells(graph.getSelectionCells()));

            // LATER: Add span with XML in data attribute
            // var span = document.createElement('span');
            // span.setAttribute('data-jgraph-type', 'application/vnd.jgraph.xml');
            // span.setAttribute('data-jgraph-content', mxUtils.getXml(graph.encodeCells(clones)));

            // Fixes cross-platform clipboard UTF8 issues by encoding as URI
            var xml = mxUtils.getXml(this.editor.graph.encodeCells(cells));
            mxUtils.setTextContent(elt, encodeURIComponent(xml));

            if (removeCells) {
                graph.removeCells(cells, false);
                graph.lastPasteXml = null;
            } else {
                graph.lastPasteXml = xml;
                graph.pasteCounter = 0;
            }

            elt.focus();
            document.execCommand('selectAll', false, null);
        } else {
            // Disables copy on focused element
            elt.innerHTML = '';
        }
    };

    /**
     * Creates the format panel and adds overrides.
     */
    EditorUi.prototype.pasteCells = function (evt, elt) {
        if (!mxEvent.isConsumed(evt)) {
            var spans = elt.getElementsByTagName('span');

            if (spans != null && spans.length > 0 && spans[0].getAttribute('data-lucid-type') ===
                'application/vnd.lucid.chart.objects') {
                var content = spans[0].getAttribute('data-lucid-content');

                if (content != null && content.length > 0) {
                    this.convertLucidChart(content, mxUtils.bind(this, function (xml) {
                        var graph = this.editor.graph;
                        graph.setSelectionCells(this.importXml(xml, 0, 0));
                        graph.scrollCellToVisible(graph.getSelectionCell());
                    }), mxUtils.bind(this, function (e) {
                        this.handleError(e);
                    }));

                    mxEvent.consume(evt);
                }
            } else {
                var graph = this.editor.graph;
                var xml = mxUtils.trim((mxClient.IS_QUIRKS || document.documentMode == 8) ?
                    mxUtils.getTextContent(elt) : elt.textContent);
                var compat = false;

                // Workaround for junk after XML in VM
                try {
                    var idx = xml.lastIndexOf('%3E');

                    if (idx >= 0 && idx < xml.length - 3) {
                        xml = xml.substring(0, idx + 3);
                    }
                } catch (e) {
                    // ignore
                }

                // Checks for embedded XML content
                try {
                    var spans = elt.getElementsByTagName('span');
                    var tmp = (spans != null && spans.length > 0) ?
                        mxUtils.trim(decodeURIComponent(spans[0].textContent)) :
                        decodeURIComponent(xml);

                    if (this.isCompatibleString(tmp)) {
                        compat = true;
                        xml = tmp;
                    }
                } catch (e) {
                    // ignore
                }

                if (graph.lastPasteXml == xml) {
                    graph.pasteCounter++;
                } else {
                    graph.lastPasteXml = xml;
                    graph.pasteCounter = 0;
                }

                var dx = graph.pasteCounter * graph.gridSize;

                if (xml != null && xml.length > 0) {
                    if (compat || this.isCompatibleString(xml)) {
                        graph.setSelectionCells(this.importXml(xml, dx, dx));
                    } else {
                        var pt = graph.getInsertPoint();

                        if (graph.isMouseInsertPoint()) {
                            dx = 0;

                            // No offset for insert at mouse position
                            if (graph.lastPasteXml == xml && graph.pasteCounter > 0) {
                                graph.pasteCounter--;
                            }
                        }

                        graph.setSelectionCells(this.insertTextAt(xml, pt.x + dx, pt.y + dx, true));
                    }

                    if (!graph.isSelectionEmpty()) {
                        graph.scrollCellToVisible(graph.getSelectionCell());

                        if (this.hoverIcons != null) {
                            this.hoverIcons.update(graph.view.getState(graph.getSelectionCell()));
                        }

                        try {
                            mxEvent.consume(evt);
                        } catch (e) {
                            // ignore event no longer exists in async handler in IE8-
                        }
                    }
                }
            }
        }
    };

    /**
     * Adds a file drop handler for opening local files.
     */
    EditorUi.prototype.addFileDropHandler = function (elts) {
        // Installs drag and drop handler for files
        if (Graph.fileSupport) {
            var dropElt = null;

            for (var i = 0; i < elts.length; i++) {
                // Setup the dnd listeners
                mxEvent.addListener(elts[i], 'dragleave', function (evt) {
                    if (dropElt != null) {
                        dropElt.parentNode.removeChild(dropElt);
                        dropElt = null;
                    }

                    evt.stopPropagation();
                    evt.preventDefault();
                });

                mxEvent.addListener(elts[i], 'dragover', mxUtils.bind(this, function (evt) {
                    if (this.editor.graph.isEnabled() || urlParams['embed'] != '1') {
                        // IE 10 does not implement pointer-events so it can't have a drop highlight
                        if (dropElt == null && (!mxClient.IS_IE || (document.documentMode > 10 && document.documentMode < 12))) {
                            dropElt = this.highlightElement();
                        }
                    }

                    evt.stopPropagation();
                    evt.preventDefault();
                }));

                mxEvent.addListener(elts[i], 'drop', mxUtils.bind(this, function (evt) {
                    if (dropElt != null) {
                        dropElt.parentNode.removeChild(dropElt);
                        dropElt = null;
                    }

                    if (this.editor.graph.isEnabled() || urlParams['embed'] != '1') {
                        if (evt.dataTransfer.files.length > 0) {
                            this.hideDialog();

                            // Never open files in embed mode
                            if (urlParams['embed'] == '1') {
                                this.importFiles(evt.dataTransfer.files, 0, 0, this.maxImageSize, null, null,
                                    null, null, !mxEvent.isControlDown(evt) && !mxEvent.isShiftDown(evt));
                            } else {
                                this.openFiles(evt.dataTransfer.files, true);
                            }
                        } else {
                            // Handles open special files via text drag and drop
                            var data = this.extractGraphModelFromEvent(evt);

                            // Tries additional and async parsing of text content such as HTML, Gliffy data
                            if (data == null) {
                                var provider = (evt.dataTransfer != null) ? evt.dataTransfer : evt.clipboardData;

                                if (provider != null) {
                                    if (document.documentMode == 10 || document.documentMode == 11) {
                                        data = provider.getData('Text');
                                    } else {
                                        var data = null;

                                        if (mxUtils.indexOf(provider.types, 'text/uri-list') >= 0) {
                                            var data = evt.dataTransfer.getData('text/uri-list');
                                        } else {
                                            data = (mxUtils.indexOf(provider.types, 'text/html') >= 0) ? provider.getData('text/html') : null;
                                        }

                                        if (data != null && data.length > 0) {
                                            var div = document.createElement('div');
                                            div.innerHTML = data;

                                            // Extracts single image
                                            var imgs = div.getElementsByTagName('img');

                                            if (imgs.length > 0) {
                                                data = imgs[0].getAttribute('src');
                                            }
                                        } else if (mxUtils.indexOf(provider.types, 'text/plain') >= 0) {
                                            data = provider.getData('text/plain');
                                        }
                                    }

                                    if (data != null) {
                                        // Checks for embedded XML in PNG
                                        if (data.substring(0, 22) == 'data:image/png;base64,') {
                                            var xml = this.extractGraphModelFromPng(data);

                                            if (xml != null && xml.length > 0) {
                                                this.openLocalFile(xml, null, true);
                                            }
                                        } else if (!this.isOffline() && this.isRemoteFileFormat(data)) {
                                            new mxXmlRequest(OPEN_URL, 'format=xml&data=' + encodeURIComponent(data)).send(mxUtils.bind(this, function (req) {
                                                if (req.getStatus() >= 200 && req.getStatus() <= 299) {
                                                    this.openLocalFile(req.getText(), null, true);
                                                }
                                            }));
                                        } else if (/^https?:\/\//.test(data)) {
                                            if (this.getCurrentFile() == null) {
                                                window.location.hash = '#U' + encodeURIComponent(data);
                                            } else {
                                                window.openWindow(((mxClient.IS_CHROMEAPP) ?
                                                    (EditorUi.drawHost + '/') : 'https://' + location.host + '/') +
                                                    window.location.search + '#U' + encodeURIComponent(data));
                                            }
                                        }
                                    }
                                }
                            } else {
                                this.openLocalFile(data, null, true);
                            }
                        }
                    }

                    evt.stopPropagation();
                    evt.preventDefault();
                }));
            }
        }
    };

    /**
     * Highlights the given element
     */
    EditorUi.prototype.highlightElement = function (elt) {
        var x = 0;
        var y = 0;
        var w = 0;
        var h = 0;

        if (elt == null) {
            var b = document.body;
            var d = document.documentElement;

            w = (b.clientWidth || d.clientWidth) - 3;
            h = Math.max(b.clientHeight || 0, d.clientHeight) - 3;
        } else {
            x = elt.offsetTop;
            y = elt.offsetLeft;
            w = elt.clientWidth;
            h = elt.clientHeight;
        }

        var hl = document.createElement('div');
        hl.style.zIndex = mxPopupMenu.prototype.zIndex + 2;
        hl.style.border = '3px dotted rgb(254, 137, 12)';
        hl.style.pointerEvents = 'none';
        hl.style.position = 'absolute';
        hl.style.top = x + 'px';
        hl.style.left = y + 'px';
        hl.style.width = Math.max(0, w - 3) + 'px';
        hl.style.height = Math.max(0, h - 3) + 'px';

        if (elt != null && elt.parentNode == this.editor.graph.container) {
            this.editor.graph.container.appendChild(hl);
        } else {
            document.body.appendChild(hl);
        }

        return hl;
    };

    /**
     * Highlights the given element
     */
    EditorUi.prototype.stringToCells = function (xml) {
        var doc = mxUtils.parseXml(xml);
        var node = this.editor.extractGraphModel(doc.documentElement);
        var cells = [];

        if (node != null) {
            var codec = new mxCodec(node.ownerDocument);
            var model = new mxGraphModel();
            codec.decode(node, model);

            var parent = model.getChildAt(model.getRoot(), 0);

            for (var j = 0; j < model.getChildCount(parent); j++) {
                cells.push(model.getChildAt(parent, j));
            }
        }

        return cells;
    };

    /**
     * Opens the given files in the editor.
     */
    EditorUi.prototype.openFiles = function (files, temp) {
        if (this.spinner.spin(document.body, mxResources.get('loading'))) {
            for (var i = 0; i < files.length; i++) {
                (mxUtils.bind(this, function (file) {
                    var reader = new FileReader();

                    reader.onload = mxUtils.bind(this, function (e) {
                        try {
                            var data = e.target.result;
                            var name = file.name;

                            if (name != null && name.length > 0) {
                                if (!this.useCanvasForExport && /(\.png)$/i.test(name)) {
                                    name = name.substring(0, name.length - 4) + '.drawio';
                                }

                                var handleResult = mxUtils.bind(this, function (xml) {
                                    var dot = name.lastIndexOf('.');

                                    if (dot >= 0) {
                                        name = name.substring(0, name.lastIndexOf('.')) + '.drawio';
                                    } else {
                                        name = name + '.drawio';
                                    }

                                    if (xml.substring(0, 10) == '<mxlibrary') {
                                        // Creates new temporary file if library is dropped in splash screen
                                        if (this.getCurrentFile() == null && urlParams['embed'] != '1') {
                                            this.openLocalFile(this.emptyDiagramXml, this.defaultFilename, temp);
                                        }

                                        try {
                                            this.loadLibrary(new LocalLibrary(this, xml, name));
                                        } catch (e) {
                                            this.handleError(e, mxResources.get('errorLoadingFile'));
                                        }
                                    } else {
                                        this.openLocalFile(xml, name, temp);
                                    }
                                });

                                if (/(\.v(dx|sdx?))($|\?)/i.test(name) || /(\.vs(x|sx?))($|\?)/i.test(name)) {
                                    this.importVisio(file, mxUtils.bind(this, function (xml) {
                                        this.spinner.stop();
                                        handleResult(xml);
                                    }));
                                } else if (/(\.*<graphml )/.test(data)) {
                                    this.importGraphML(data, mxUtils.bind(this, function (xml) {
                                        this.spinner.stop();
                                        handleResult(xml);
                                    }));
                                } else if (Graph.fileSupport && !this.isOffline() && new XMLHttpRequest().upload &&
                                    this.isRemoteFileFormat(data, name)) {
                                    this.parseFile(file, mxUtils.bind(this, function (xhr) {
                                        if (xhr.readyState == 4) {
                                            this.spinner.stop();

                                            if (xhr.status >= 200 && xhr.status <= 299) {
                                                handleResult(xhr.responseText);
                                            } else {
                                                this.handleError({
                                                        message: mxResources.get((xhr.status == 413) ?
                                                            'drawingTooLarge' : 'invalidOrMissingFile')
                                                    },
                                                    mxResources.get('errorLoadingFile'));
                                            }
                                        }
                                    }));
                                } else if (this.isLucidChartData(data)) {
                                    if (/(\.json)$/i.test(name)) {
                                        name = name.substring(0, name.length - 5) + '.drawio';
                                    }

                                    // LATER: Add import step that produces cells and use callback
                                    this.convertLucidChart(data, mxUtils.bind(this, function (xml) {
                                        this.spinner.stop();
                                        this.openLocalFile(xml, name, temp);
                                    }), mxUtils.bind(this, function (e) {
                                        this.spinner.stop();
                                        this.handleError(e);
                                    }));
                                } else if (e.target.result.substring(0, 10) == '<mxlibrary') {
                                    this.spinner.stop();

                                    // Creates new temporary file if library is dropped in splash screen
                                    if (this.getCurrentFile() == null && urlParams['embed'] != '1') {
                                        this.openLocalFile(this.emptyDiagramXml, this.defaultFilename, temp);
                                    }

                                    try {
                                        this.loadLibrary(new LocalLibrary(this, e.target.result, file.name));
                                    } catch (e) {
                                        this.handleError(e, mxResources.get('errorLoadingFile'));
                                    }
                                } else if (data.indexOf('PK') == 0) {
                                    this.importZipFile(file, mxUtils.bind(this, function (xml) {
                                        this.spinner.stop();
                                        handleResult(xml);
                                    }), mxUtils.bind(this, function () {
                                        this.spinner.stop();
                                        this.openLocalFile(data, name, temp);
                                    }));
                                } else {
                                    if (file.type.substring(0, 9) == 'image/png') {
                                        data = this.extractGraphModelFromPng(data);
                                    }

                                    this.spinner.stop();
                                    this.openLocalFile(data, name, temp);
                                }
                            }
                        } catch (e) {
                            this.handleError(e);
                        }
                    });

                    reader.onerror = mxUtils.bind(this, function (e) {
                        this.spinner.stop();
                        this.handleError(e);
                        window.openFile = null;
                    });

                    if (file.type.substring(0, 5) === 'image' && file.type.substring(0, 9) !== 'image/svg') {
                        reader.readAsDataURL(file);
                    } else {
                        reader.readAsText(file);
                    }
                }))(files[i]);
            }
        }
    };

    /**
     * Shows the layers dialog if the graph has more than one layer.
     */
    EditorUi.prototype.openLocalFile = function (data, name, temp) {
        var currentFile = this.getCurrentFile();

        var fn = mxUtils.bind(this, function () {
            window.openFile = null;

            if (name == null && this.getCurrentFile() != null && this.isDiagramEmpty()) {
                var doc = mxUtils.parseXml(data);

                if (doc != null) {
                    this.editor.setGraphXml(doc.documentElement);
                    this.editor.graph.selectAll();
                }
            } else {
                this.fileLoaded(new LocalFile(this, data, name || this.defaultFilename, temp));
            }
        });

        if (data != null && data.length > 0) {
            if (currentFile == null || (!currentFile.isModified() &&
                (mxClient.IS_CHROMEAPP || EditorUi.isElectronApp))) {
                fn();
            } else if ((mxClient.IS_CHROMEAPP || EditorUi.isElectronApp) &&
                currentFile != null && currentFile.isModified()) {
                this.confirm(mxResources.get('allChangesLost'), null, fn,
                    mxResources.get('cancel'), mxResources.get('discardChanges'));
            } else {
                window.openFile = new OpenFile(function () {
                    window.openFile = null;
                });

                window.openFile.setData(data, name);
                window.openWindow(this.getUrl(), null, mxUtils.bind(this, function () {
                    if (currentFile != null && currentFile.isModified()) {
                        this.confirm(mxResources.get('allChangesLost'), null, fn,
                            mxResources.get('cancel'), mxResources.get('discardChanges'));
                    } else {
                        fn();
                    }
                }));
            }
        } else {
            throw new Error(mxResources.get('notADiagramFile'));
        }
    };

    /**
     * Returns a list of all shapes used in the current file.
     */
    EditorUi.prototype.getBasenames = function () {
        var basenames = {};

        if (this.pages != null) {
            for (var i = 0; i < this.pages.length; i++) {
                this.updatePageRoot(this.pages[i]);
                this.addBasenamesForCell(this.pages[i].root, basenames);
            }
        } else {
            this.addBasenamesForCell(this.editor.graph.model.getRoot(), basenames);
        }

        var result = [];

        for (var key in basenames) {
            result.push(key);
        }

        return result;
    };

    /**
     * Returns a list of all shapes used in the current file.
     */
    EditorUi.prototype.addBasenamesForCell = function (cell, basenames) {
        function addName(name) {
            if (name != null) {
                // LATER: Check if this case exists
                var dot = name.lastIndexOf('.');

                if (dot > 0) {
                    name = name.substring(dot + 1, name.length);
                }

                if (basenames[name] == null) {
                    basenames[name] = true;
                }
            }
        };

        var graph = this.editor.graph;
        var style = graph.getCellStyle(cell);
        var shape = style[mxConstants.STYLE_SHAPE];
        addName(mxStencilRegistry.getBasenameForStencil(shape));

        // Adds package names for markers in edges
        if (graph.model.isEdge(cell)) {
            addName(mxMarker.getPackageForType(style[mxConstants.STYLE_STARTARROW]));
            addName(mxMarker.getPackageForType(style[mxConstants.STYLE_ENDARROW]));
        }

        var childCount = graph.model.getChildCount(cell);

        for (var i = 0; i < childCount; i++) {
            this.addBasenamesForCell(graph.model.getChildAt(cell, i), basenames);
        }
    };

    /**
     * Shows the layers dialog if the graph has more than one layer.
     */
    EditorUi.prototype.setGraphEnabled = function (enabled) {
        this.diagramContainer.style.visibility = (enabled) ? '' : 'hidden';
        this.formatContainer.style.visibility = (enabled) ? '' : 'hidden';
        this.sidebarFooterContainer.style.display = (enabled) ? '' : 'none';
        this.sidebarContainer.style.display = (enabled) ? '' : 'none';
        this.hsplit.style.display = (enabled) ? '' : 'none';
        this.editor.graph.setEnabled(enabled);

        if (this.ruler != null) {
            this.ruler.hRuler.container.style.visibility = (enabled) ? '' : 'hidden';
            this.ruler.vRuler.container.style.visibility = (enabled) ? '' : 'hidden';
        }

        if (this.tabContainer != null) {
            this.tabContainer.style.visibility = (enabled) ? '' : 'hidden';
        }

        if (!enabled) {
            if (this.actions.outlineWindow != null) {
                this.actions.outlineWindow.window.setVisible(false);
            }

            if (this.actions.layersWindow != null) {
                this.actions.layersWindow.window.setVisible(false);
            }

            if (this.menus.tagsWindow != null) {
                this.menus.tagsWindow.window.setVisible(false);
            }

            if (this.menus.findWindow != null) {
                this.menus.findWindow.window.setVisible(false);
            }
        }
    };

    /**
     * Shows the layers dialog if the graph has more than one layer.
     */
    EditorUi.prototype.showLayersDialog = function () {
        if (this.editor.graph.getModel().getChildCount(this.editor.graph.getModel().getRoot()) > 1) {
            if (this.actions.layersWindow == null) {
                this.actions.get('layers').funct();
            } else {
                this.actions.layersWindow.window.setVisible(true);
            }
        }
    };

    /**
     * Tries to find a public URL for the given file.
     */
    EditorUi.prototype.getPublicUrl = function (file, fn) {
        if (file != null) {
            file.getPublicUrl(fn);
        } else {
            fn(null);
        }
    };

    /**
     * Adds the buttons for embedded mode.
     */
    EditorUi.prototype.createLoadMessage = function (eventName) {
        var graph = this.editor.graph;

        return {
            event: eventName, pageVisible: graph.pageVisible, translate: graph.view.translate,
            bounds: graph.getGraphBounds(), currentPage: this.getSelectedPageIndex(),
            scale: graph.view.scale, page: graph.view.getBackgroundPageBounds()
        };
    };

    /**
     * Adds the buttons for embedded mode.
     */
    EditorUi.prototype.installMessageHandler = function (fn) {
        var changeListener = null;
        var ignoreChange = false;
        var autosave = false;
        var lastData = null;

        var updateStatus = mxUtils.bind(this, function (sender, eventObject) {
            if (!this.editor.modified || urlParams['modified'] == '0') {
                this.editor.setStatus('');
            } else if (urlParams['modified'] != null) {
                this.editor.setStatus(mxUtils.htmlEntities(mxResources.get(urlParams['modified'])));
            }
        });

        this.editor.graph.model.addListener(mxEvent.CHANGE, updateStatus);

        // Receives XML message from opener and puts it into the graph
        mxEvent.addListener(window, 'message', mxUtils.bind(this, function (evt) {
            var validSource = window.opener || window.parent;

            if (evt.source != validSource) {
                return;
            }

            var data = evt.data;

            var extractDiagramXml = mxUtils.bind(this, function (data) {
                if (data != null && typeof data.charAt === 'function' && data.charAt(0) != '<') {
                    try {
                        if (data.substring(0, 22) == 'data:image/png;base64,') {
                            data = this.extractGraphModelFromPng(data);
                        } else if (data.substring(0, 26) == 'data:image/svg+xml;base64,') {
                            data = atob(data.substring(26));
                        } else if (data.substring(0, 24) == 'data:image/svg+xml;utf8,') {
                            data = data.substring(24);
                        }

                        if (data != null) {
                            if (data.charAt(0) == '%') {
                                data = decodeURIComponent(data);
                            } else if (data.charAt(0) != '<') {
                                data = Graph.decompress(data);
                            }
                        }
                    } catch (e) {
                        // ignore compression errors and use empty data
                    }
                }

                return data;
            });

            if (urlParams['proto'] == 'json') {
                try {
                    data = JSON.parse(data);
                } catch (e) {
                    data = null;
                }

                if (data == null) {
                    // Ignore
                    return;
                } else if (data.action == 'dialog') {
                    this.showError((data.titleKey != null) ? mxResources.get(data.titleKey) : data.title,
                        (data.messageKey != null) ? mxResources.get(data.messageKey) : data.message,
                        (data.buttonKey != null) ? mxResources.get(data.buttonKey) : data.button);

                    if (data.modified != null) {
                        this.editor.modified = data.modified;
                    }

                    return;
                } else if (data.action == 'prompt') {
                    this.spinner.stop();

                    var dlg = new FilenameDialog(this, data.defaultValue || '',
                        (data.okKey != null) ? mxResources.get(data.okKey) : null, function (value) {
                            if (value != null) {
                                parent.postMessage(JSON.stringify({event: 'prompt', value: value, message: data}), '*');
                            }
                        }, (data.titleKey != null) ? mxResources.get(data.titleKey) : data.title);
                    this.showDialog(dlg.container, 300, 80, true, false);
                    dlg.init();

                    return;
                } else if (data.action == 'draft') {
                    var tmp = extractDiagramXml(data.xml);
                    this.spinner.stop();

                    var dlg = new DraftDialog(this, mxResources.get('draftFound', [data.name || this.defaultFilename]),
                        tmp, mxUtils.bind(this, function () {
                            this.hideDialog();
                            parent.postMessage(JSON.stringify({event: 'draft', result: 'edit', message: data}), '*');
                        }), mxUtils.bind(this, function () {
                            this.hideDialog();
                            parent.postMessage(JSON.stringify({event: 'draft', result: 'discard', message: data}), '*');
                        }), (data.editKey) ? mxResources.get(data.editKey) : null,
                        (data.discardKey) ? mxResources.get(data.discardKey) : null,
                        (data.ignore) ? mxUtils.bind(this, function () {
                            this.hideDialog();
                            parent.postMessage(JSON.stringify({event: 'draft', result: 'ignore', message: data}), '*');
                        }) : null);
                    this.showDialog(dlg.container, 640, 480, true, false, mxUtils.bind(this, function (cancel) {
                        if (cancel) {
                            this.actions.get('exit').funct();
                        }
                    }));

                    try {
                        dlg.init();
                    } catch (e) {
                        parent.postMessage(JSON.stringify({event: 'draft', error: e.toString(), message: data}), '*');
                    }

                    return;
                } else if (data.action == 'template') {
                    this.spinner.stop();

                    var enableRecentDocs = data.enableRecent == 1;
                    var enableSearchDocs = data.enableSearch == 1;
                    var enableCustomTemp = data.enableCustomTemp == 1;

                    var dlg = new NewDialog(this, false, data.callback != null, mxUtils.bind(this, function (xml, name) {
                            xml = xml || this.emptyDiagramXml;

                            // LATER: Add autosave option in template message
                            if (data.callback != null) {
                                parent.postMessage(JSON.stringify({
                                    event: 'template', xml: xml,
                                    blank: xml == this.emptyDiagramXml, name: name
                                }), '*');
                            } else {
                                fn(xml, evt, xml != this.emptyDiagramXml);

                                // Workaround for status updated before modified applied
                                if (!this.editor.modified) {
                                    this.editor.setStatus('');
                                }
                            }
                        }), null, null, null, null, null, null, null,
                        enableRecentDocs ? mxUtils.bind(this, function (recentReadyCallback) {
                            this.remoteInvoke('getRecentDiagrams', null, null, recentReadyCallback, function () {
                                recentReadyCallback(null, 'Network Error!');
                            });
                        }) : null,
                        enableSearchDocs ? mxUtils.bind(this, function (searchStr, searchReadyCallback) {
                            this.remoteInvoke('searchDiagrams', [searchStr], null, searchReadyCallback, function () {
                                searchReadyCallback(null, 'Network Error!');
                            });
                        }) : null,
                        mxUtils.bind(this, function (url, info, name) {
                            //If binary files are possible, we can get the file content using remote invokation, imported it, and send final mxFile back
                            parent.postMessage(JSON.stringify({
                                event: 'template', docUrl: url, info: info,
                                name: name
                            }), '*');
                        }), null, null,
                        enableCustomTemp ? mxUtils.bind(this, function (customTempCallback) {
                            this.remoteInvoke('getCustomTemplates', null, null, customTempCallback, function () {
                                customTempCallback({}, 0); //ignore error by sending empty templates
                            });
                        }) : null);

                    this.showDialog(dlg.container, 620, 440, true, false, mxUtils.bind(this, function (cancel) {
                        if (cancel) {
                            this.actions.get('exit').funct();
                        }
                    }));
                    dlg.init();

                    return;
                } else if (data.action == 'textContent') {
                    //TODO Remove this message and use remove invokation instead
                    var allPagesTxt = this.getDiagramTextContent();
                    parent.postMessage(JSON.stringify({event: 'textContent', data: allPagesTxt, message: data}), '*');
                    return;
                } else if (data.action == 'status') {
                    if (data.messageKey != null) {
                        this.editor.setStatus(mxUtils.htmlEntities(mxResources.get(data.messageKey)));
                    } else if (data.message != null) {
                        this.editor.setStatus(mxUtils.htmlEntities(data.message));
                    }

                    if (data.modified != null) {
                        this.editor.modified = data.modified;
                    }

                    return;
                } else if (data.action == 'spinner') {
                    var msg = (data.messageKey != null) ? mxResources.get(data.messageKey) : data.message;

                    if (data.show != null && !data.show) {
                        this.spinner.stop();
                    } else {
                        this.spinner.spin(document.body, msg)
                    }

                    return;
                } else if (data.action == 'export') {
                    if (data.format == 'png' || data.format == 'xmlpng') {
                        if ((data.spin == null && data.spinKey == null) || this.spinner.spin(document.body,
                            (data.spinKey != null) ? mxResources.get(data.spinKey) : data.spin)) {
                            var xml = (data.xml != null) ? data.xml : this.getFileData(true);
                            this.editor.graph.setEnabled(false);
                            var graph = this.editor.graph;

                            var postDataBack = mxUtils.bind(this, function (uri) {
                                this.editor.graph.setEnabled(true);
                                this.spinner.stop();

                                var msg = this.createLoadMessage('export');
                                msg.format = data.format;
                                msg.message = data;
                                msg.data = uri;
                                msg.xml = encodeURIComponent(xml);
                                parent.postMessage(JSON.stringify(msg), '*');
                            });

                            var processUri = mxUtils.bind(this, function (uri) {
                                if (uri == null) {
                                    uri = Editor.blankImage;
                                }

                                if (data.format == 'xmlpng') {
                                    uri = this.writeGraphModelToPng(uri, 'tEXt', 'mxfile',
                                        encodeURIComponent(xml));
                                }

                                // Removes temporary graph from DOM
                                if (graph != this.editor.graph) {
                                    graph.container.parentNode.removeChild(graph.container);
                                }

                                postDataBack(uri);
                            });

                            // LATER: Uses external export if current page (not first page) has mathEnabled
                            if (this.isExportToCanvas()) {
                                // Exports PNG for first page while other page is visible by creating a graph
                                // LATER: Add caching for the graph or SVG while not on first page
                                if (this.pages != null && this.currentPage != this.pages[0]) {
                                    var graphGetGlobalVariable = graph.getGlobalVariable;
                                    graph = this.createTemporaryGraph(graph.getStylesheet());
                                    var page = this.pages[0];

                                    graph.getGlobalVariable = function (name) {
                                        if (name == 'page') {
                                            return page.getName();
                                        } else if (name == 'pagenumber') {
                                            return 1;
                                        }

                                        return graphGetGlobalVariable.apply(this, arguments);
                                    };

                                    document.body.appendChild(graph.container);
                                    graph.model.setRoot(page.root);
                                }

                                this.exportToCanvas(mxUtils.bind(this, function (canvas) {
                                    processUri(canvas.toDataURL('image/png'));
                                }), null, null, null, mxUtils.bind(this, function () {
                                    processUri(null);
                                }), null, null, data.scale, null, null, null, graph);
                            } else {
                                // Data from server is base64 encoded to avoid binary XHR
                                // Double encoding for XML arg is needed for UTF8 encoding
                                var req = new mxXmlRequest(EXPORT_URL, 'format=png&embedXml=' +
                                    ((data.format == 'xmlpng') ? '1' : '0') +
                                    (data.scale != null ? '&scale=' + data.scale : '') + '&base64=1&xml=' +
                                    encodeURIComponent(encodeURIComponent(xml)));

                                req.send(mxUtils.bind(this, function (req) {
                                    // Temp graph was never created at this point so we can
                                    // skip processUri since it already contains the XML
                                    if (req.getStatus() >= 200 && req.getStatus() <= 299) {
                                        postDataBack('data:image/png;base64,' + req.getText());
                                    } else {
                                        processUri(null);
                                    }
                                }), mxUtils.bind(this, function () {
                                    processUri(null);
                                }));
                            }
                        }
                    } else {
                        // SVG is generated from graph so parse optional XML
                        if (data.xml != null && data.xml.length > 0) {
                            this.setFileData(data.xml);
                        }

                        var msg = this.createLoadMessage('export');

                        // Forces new HTML format if pages exists
                        if (data.format == 'html2' || (data.format == 'html' && (urlParams['pages'] != '0' ||
                            (this.pages != null && this.pages.length > 1)))) {
                            var node = this.getXmlFileData();
                            msg.xml = mxUtils.getXml(node);
                            msg.data = this.getFileData(null, null, true, null, null, null, node);
                            msg.format = data.format;
                        } else if (data.format == 'html') {
                            var xml = this.editor.getGraphXml();
                            msg.data = this.getHtml(xml, this.editor.graph);
                            msg.xml = mxUtils.getXml(xml);
                            msg.format = data.format;
                        } else {
                            // Creates a preview with no alt text for unsupported browsers
                            mxSvgCanvas2D.prototype.foAltText = null;

                            var bg = this.editor.graph.background;

                            if (bg == mxConstants.NONE) {
                                bg = null;
                            }

                            msg.xml = this.getFileData(true, null, null, null, null,
                                null, null, null, null, false);
                            msg.format = 'svg';

                            if (data.embedImages || data.embedImages == null) {
                                if ((data.spin == null && data.spinKey == null) || this.spinner.spin(document.body,
                                    (data.spinKey != null) ? mxResources.get(data.spinKey) : data.spin)) {
                                    this.editor.graph.setEnabled(false);

                                    if (data.format == 'xmlsvg') {
                                        this.getEmbeddedSvg(msg.xml, this.editor.graph, null, true, mxUtils.bind(this, function (svg) {
                                            this.editor.graph.setEnabled(true);
                                            this.spinner.stop();

                                            msg.data = this.createSvgDataUri(svg);
                                            parent.postMessage(JSON.stringify(msg), '*');
                                        }));
                                    } else {
                                        this.convertImages(this.editor.graph.getSvg(bg), mxUtils.bind(this, function (svgRoot) {
                                            this.editor.graph.setEnabled(true);
                                            this.spinner.stop();

                                            msg.data = this.createSvgDataUri(mxUtils.getXml(svgRoot));
                                            parent.postMessage(JSON.stringify(msg), '*');
                                        }));
                                    }
                                }

                                return;
                            } else {
                                var svg = (data.format == 'xmlsvg') ? this.getEmbeddedSvg(this.getFileData(true),
                                    this.editor.graph, null, true) : mxUtils.getXml(this.editor.graph.getSvg(bg));
                                msg.data = this.createSvgDataUri(svg);
                            }
                        }

                        parent.postMessage(JSON.stringify(msg), '*');
                    }

                    return;
                } else if (data.action == 'load') {
                    autosave = data.autosave == 1;
                    this.hideDialog();

                    if (data.modified != null && urlParams['modified'] == null) {
                        urlParams['modified'] = data.modified;
                    }

                    if (data.saveAndExit != null && urlParams['saveAndExit'] == null) {
                        urlParams['saveAndExit'] = data.saveAndExit;
                    }

                    if (data.title != null && this.buttonContainer != null) {
                        var tmp = document.createElement('span');
                        mxUtils.write(tmp, data.title);

                        if (uiTheme == 'atlas') {
                            this.buttonContainer.style.paddingRight = '12px';
                            this.buttonContainer.style.paddingTop = '6px';
                            this.buttonContainer.style.right = '25px';
                        } else if (uiTheme != 'min') {
                            this.buttonContainer.style.paddingRight = '38px';
                            this.buttonContainer.style.paddingTop = '6px';
                        }

                        if (this.embedFilenameSpan != null) {
                            this.embedFilenameSpan.parentNode.removeChild(this.embedFilenameSpan);
                        }

                        this.buttonContainer.appendChild(tmp);
                        this.embedFilenameSpan = tmp;
                    }

                    if (data.xmlpng != null) {
                        data = this.extractGraphModelFromPng(data.xmlpng);
                    } else {
                        data = data.xml;
                    }
                } else if (data.action == 'remoteInvokeReady') {
                    this.handleRemoteInvokeReady(parent);
                    return;
                } else if (data.action == 'remoteInvoke') {
                    this.handleRemoteInvoke(data);
                    return;
                } else if (data.action == 'remoteInvokeResponse') {
                    this.handleRemoteInvokeResponse(data);
                    return;
                } else {
                    // Unknown message must stop execution
                    parent.postMessage(JSON.stringify({error: 'unknownMessage', data: JSON.stringify(data)}), '*');

                    return;
                }
            }

            var doLoad = mxUtils.bind(this, function (data, evt) {
                ignoreChange = true;
                try {
                    fn(data, evt);
                } catch (e) {
                    this.handleError(e);
                }
                ignoreChange = false;

                if (urlParams['modified'] != null) {
                    this.editor.setStatus('');
                }

                var getData = mxUtils.bind(this, function () {
                    return (urlParams['pages'] != '0' || (this.pages != null && this.pages.length > 1)) ?
                        this.getFileData(true) : mxUtils.getXml(this.editor.getGraphXml());
                });
                ;

                lastData = getData();

                if (autosave && changeListener == null) {
                    changeListener = mxUtils.bind(this, function (sender, eventObject) {
                        var data = getData();

                        if (data != lastData && !ignoreChange) {
                            var msg = this.createLoadMessage('autosave');
                            msg.xml = data;
                            data = JSON.stringify(msg);

                            var parent = window.opener || window.parent;
                            parent.postMessage(data, '*');
                        }

                        lastData = data;
                    });

                    this.editor.graph.model.addListener(mxEvent.CHANGE, changeListener);

                    // Some options trigger autosave
                    this.editor.graph.addListener('gridSizeChanged', changeListener);
                    this.editor.graph.addListener('shadowVisibleChanged', changeListener);
                    this.addListener('pageFormatChanged', changeListener);
                    this.addListener('pageScaleChanged', changeListener);
                    this.addListener('backgroundColorChanged', changeListener);
                    this.addListener('backgroundImageChanged', changeListener);
                    this.addListener('foldingEnabledChanged', changeListener);
                    this.addListener('mathEnabledChanged', changeListener);
                    this.addListener('gridEnabledChanged', changeListener);
                    this.addListener('guidesEnabledChanged', changeListener);
                    this.addListener('pageViewChanged', changeListener);
                }

                // Sends the bounds of the graph to the host after parsing
                if (urlParams['returnbounds'] == '1' || urlParams['proto'] == 'json') {
                    parent.postMessage(JSON.stringify(this.createLoadMessage('load')), '*');
                }
            });

            if (data != null && typeof data.substring === 'function' && data.substring(0, 34) == 'data:application/vnd.visio;base64,') {
                // Checks VND binary magic number in base64
                var filename = (data.substring(34, 45) == '0M8R4KGxGuE') ? 'raw.vsd' : 'raw.vsdx';

                this.importVisio(this.base64ToBlob(data.substring(data.indexOf(',') + 1)), function (xml) {
                    doLoad(xml, evt);
                }, mxUtils.bind(this, function (e) {
                    this.handleError(e);
                }), filename);
            } else if (data != null && typeof data.substring === 'function' && !this.isOffline() && new XMLHttpRequest().upload && this.isRemoteFileFormat(data, '')) {
                // Asynchronous parsing via server
                this.parseFile(new Blob([data], {type: 'application/octet-stream'}), mxUtils.bind(this, function (xhr) {
                    if (xhr.readyState == 4 && xhr.status >= 200 && xhr.status <= 299 &&
                        xhr.responseText.substring(0, 13) == '<mxGraphModel') {
                        doLoad(xhr.responseText, evt);
                    }
                }), '');
            } else if (data != null && typeof data.substring === 'function' && this.isLucidChartData(data)) {
                this.convertLucidChart(data, mxUtils.bind(this, function (xml) {
                    doLoad(xml);
                }), mxUtils.bind(this, function (e) {
                    this.handleError(e);
                }));
            } else {
                data = extractDiagramXml(data);
                doLoad(data, evt);
            }
        }));

        // Requests data from the sender. This is a workaround for not allowing
        // the opener to listen for the onload event if not in the same origin.
        var parent = window.opener || window.parent;
        var msg = (urlParams['proto'] == 'json') ? JSON.stringify({event: 'init'}) : (urlParams['ready'] || 'ready');
        parent.postMessage(msg, '*');
    };

    /**
     * Adds the buttons for embedded mode.
     */
    EditorUi.prototype.addEmbedButtons = function () {
        if (this.menubar != null) {
            var div = document.createElement('div');
            div.style.display = 'inline-block';
            div.style.position = 'absolute';
            div.style.paddingTop = (uiTheme == 'atlas') ? '2px' : '0px';
            div.style.paddingLeft = '8px';
            div.style.paddingBottom = '2px';

            var button = document.createElement('button');
            button.className = 'geBigButton';

            if (urlParams['noSaveBtn'] == '1') {
                mxUtils.write(button, mxResources.get('saveAndExit'));
                button.setAttribute('title', mxResources.get('saveAndExit'));

                mxEvent.addListener(button, 'click', mxUtils.bind(this, function () {
                    this.actions.get('saveAndExit').funct();
                }));

                div.appendChild(button);
            } else {
                mxUtils.write(button, mxResources.get('save'));
                button.setAttribute('title', mxResources.get('save') + ' (' + Editor.ctrlKey + '+S)');

                mxEvent.addListener(button, 'click', mxUtils.bind(this, function () {
                    this.actions.get('save').funct();
                }));

                div.appendChild(button);

                if (urlParams['saveAndExit'] == '1') {
                    button = document.createElement('a');
                    mxUtils.write(button, mxResources.get('saveAndExit'));
                    button.setAttribute('title', mxResources.get('saveAndExit'));
                    button.className = 'geBigButton geBigStandardButton';
                    button.style.marginLeft = '6px';

                    mxEvent.addListener(button, 'click', mxUtils.bind(this, function () {
                        this.actions.get('saveAndExit').funct();
                    }));

                    div.appendChild(button);
                }
            }

            button = document.createElement('a');
            mxUtils.write(button, mxResources.get('exit'));
            button.setAttribute('title', mxResources.get('exit'));
            button.className = 'geBigButton geBigStandardButton';
            button.style.marginLeft = '6px';
            button.style.marginRight = '20px';

            mxEvent.addListener(button, 'click', mxUtils.bind(this, function () {
                this.actions.get('exit').funct();
            }));

            div.appendChild(button);

            this.toolbar.container.appendChild(div);
            this.toolbar.staticElements.push(div);
            div.style.right = (uiTheme != 'atlas') ? '52px' : '42px';
        }
    };

    /**
     *
     */
    EditorUi.prototype.showImportCsvDialog = function () {
        if (this.importCsvDialog == null) {
            this.importCsvDialog = new TextareaDialog(this, mxResources.get('csv') + ':',
                Editor.defaultCsvValue, mxUtils.bind(this, function (newValue) {
                    this.importCsv(newValue);
                }), null, null, 620, 430, null, true, true, mxResources.get('import'),
                !this.isOffline() ? 'https://about.draw.io/import-from-csv-to-drawio/' : null);
        }

        this.showDialog(this.importCsvDialog.container, 675, 540, true, true, null, null, null, null, true);
        this.importCsvDialog.init();
    };


    /**
     * Runs the layout from the given JavaScript array which is of the form [{layout: name, config: obj}, ...]
     * where name is the layout constructor name and config contains the properties of the layout instance.
     */
    EditorUi.prototype.executeLayoutList = function (layoutList, done) {
        var graph = this.editor.graph;
        var cells = graph.getSelectionCells();

        for (var i = 0; i < layoutList.length; i++) {
            var layout = new window[layoutList[i].layout](graph);

            if (layoutList[i].config != null) {
                for (var key in layoutList[i].config) {
                    layout[key] = layoutList[i].config[key];
                }
            }

            this.executeLayout(function () {
                layout.execute(graph.getDefaultParent(), cells.length == 0 ? null : cells);
            }, i == layoutList.length - 1, done);
        }
    };

    /**
     *
     */
    EditorUi.prototype.importCsv = function (text, done) {
        try {
            var lines = text.split('\n');
            var allCells = [];
            var cells = [];
            var dups = {};

            if (lines.length > 0) {
                // Internal lookup table
                var lookups = {};

                // Default values
                var style = null;
                var styles = null;
                var stylename = null;
                var labelname = null;
                var labels = null;
                var parentstyle = null;
                var identity = null;
                var parent = null;
                var namespace = '';
                var width = 'auto';
                var height = 'auto';
                var left = null;
                var top = null;
                var edgespacing = 40;
                var nodespacing = 40;
                var levelspacing = 100;
                var padding = 0;

                var graph = this.editor.graph;
                var view = graph.view;
                var bds = graph.getGraphBounds();

                // Delayed after optional layout
                var afterInsert = function () {
                    if (done != null) {
                        done(select);
                    } else {
                        graph.setSelectionCells(select);
                        graph.scrollCellToVisible(graph.getSelectionCell());
                    }
                };

                // Computes unscaled, untranslated graph bounds
                var pt = graph.getFreeInsertPoint();
                var x0 = pt.x;
                var y0 = pt.y;
                var y = y0;

                // Default label value depends on column names
                var label = null;

                // Default layout to run.
                var layout = 'auto';

                // Name of the attribute that contains the parent reference
                var parent = null;

                // Name of the attribute that contains the references for creating edges
                var edges = [];

                // Name of the column for hyperlinks
                var link = null;

                // String array of names to remove from metadata
                var ignore = null;

                // Read processing instructions first
                var index = 0;

                while (index < lines.length && lines[index].charAt(0) == '#') {
                    var text = lines[index];
                    index++;

                    while (index < lines.length && text.charAt(text.length - 1) == '\\' &&
                    lines[index].charAt(0) == '#') {
                        text = text.substring(0, text.length - 1) + mxUtils.trim(lines[index].substring(1));
                        index++;
                    }

                    if (text.charAt(1) != '#') {
                        // Processing instruction
                        var idx = text.indexOf(':');

                        if (idx > 0) {
                            var key = mxUtils.trim(text.substring(1, idx));
                            var value = mxUtils.trim(text.substring(idx + 1));

                            if (key == 'label') {
                                label = graph.sanitizeHtml(value);
                            } else if (key == 'labelname' && value.length > 0 && value != '-') {
                                labelname = value;
                            } else if (key == 'labels' && value.length > 0 && value != '-') {
                                labels = JSON.parse(value);
                            } else if (key == 'style') {
                                style = value;
                            } else if (key == 'parentstyle') {
                                parentstyle = value;
                            } else if (key == 'stylename' && value.length > 0 && value != '-') {
                                stylename = value;
                            } else if (key == 'styles' && value.length > 0 && value != '-') {
                                styles = JSON.parse(value);
                            } else if (key == 'identity' && value.length > 0 && value != '-') {
                                identity = value;
                            } else if (key == 'parent' && value.length > 0 && value != '-') {
                                parent = value;
                            } else if (key == 'namespace' && value.length > 0 && value != '-') {
                                namespace = value;
                            } else if (key == 'width') {
                                width = value;
                            } else if (key == 'height') {
                                height = value;
                            } else if (key == 'left' && value.length > 0) {
                                left = value;
                            } else if (key == 'top' && value.length > 0) {
                                top = value;
                            } else if (key == 'ignore') {
                                ignore = value.split(',');
                            } else if (key == 'connect') {
                                edges.push(JSON.parse(value));
                            } else if (key == 'link') {
                                link = value;
                            } else if (key == 'padding') {
                                padding = parseFloat(value);
                            } else if (key == 'edgespacing') {
                                edgespacing = parseFloat(value);
                            } else if (key == 'nodespacing') {
                                nodespacing = parseFloat(value);
                            } else if (key == 'levelspacing') {
                                levelspacing = parseFloat(value);
                            } else if (key == 'layout') {
                                layout = value;
                            }
                        }
                    }
                }

                if (lines[index] == null) {
                    throw new Error(mxResources.get('invalidOrMissingFile'));
                }

                var keys = this.editor.csvToArray(lines[index]);

                // Converts name of identity and parent to indexes of column
                var identityIndex = null;
                var parentIndex = null;

                if (identity != null || parent != null) {
                    for (var i = 0; i < keys.length; i++) {
                        if (identity == keys[i]) {
                            identityIndex = i;
                        }

                        if (parent == keys[i]) {
                            parentIndex = i;
                        }
                    }
                }

                if (label == null) {
                    label = '%' + keys[0] + '%';
                }

                if (edges != null) {
                    for (var e = 0; e < edges.length; e++) {
                        if (lookups[edges[e].to] == null) {
                            lookups[edges[e].to] = {};
                        }
                    }
                }

                graph.model.beginUpdate();
                try {
                    for (var i = index + 1; i < lines.length; i++) {
                        var values = this.editor.csvToArray(lines[i]);

                        if (values == null) {
                            var short = (lines[i].length > 40) ? lines[i].substring(0, 40) + '...' : lines[i];

                            throw new Error(i + ' (' + short + ') ' + mxResources.get('containsValidationErrors'));
                        } else if (values.length == keys.length) {
                            var cell = null;
                            var id = (identityIndex != null) ? namespace + values[identityIndex] : null;

                            if (id != null) {
                                cell = graph.model.getCell(id);
                            }

                            var exists = cell != null;
                            var newCell = new mxCell(label, new mxGeometry(x0, y,
                                0, 0), style || 'whiteSpace=wrap;html=1;');
                            newCell.vertex = true;
                            newCell.id = id;

                            for (var j = 0; j < values.length; j++) {
                                graph.setAttributeForCell(newCell, keys[j], values[j]);
                            }

                            if (labelname != null && labels != null) {
                                var tempLabel = labels[newCell.getAttribute(labelname)];

                                if (tempLabel != null) {
                                    graph.labelChanged(newCell, tempLabel);
                                }
                            }

                            if (stylename != null && styles != null) {
                                var tempStyle = styles[newCell.getAttribute(stylename)];

                                if (tempStyle != null) {
                                    newCell.style = tempStyle;
                                }
                            }

                            graph.setAttributeForCell(newCell, 'placeholders', '1');
                            newCell.style = graph.replacePlaceholders(newCell, newCell.style);

                            if (exists) {
                                graph.model.setGeometry(cell, newCell.geometry);
                                graph.model.setStyle(cell, newCell.style);

                                if (mxUtils.indexOf(cells, cell) < 0) {
                                    cells.push(cell);
                                }
                            }

                            cell = newCell;

                            if (!exists) {
                                for (var e = 0; e < edges.length; e++) {
                                    lookups[edges[e].to][cell.getAttribute(edges[e].to)] = cell;
                                }
                            }

                            if (link != null && link != 'link') {
                                graph.setLinkForCell(cell, cell.getAttribute(link));

                                // Removes attribute
                                graph.setAttributeForCell(cell, link, null);
                            }

                            // Sets the size
                            graph.fireEvent(new mxEventObject('cellsInserted', 'cells', [cell]));
                            var size = this.editor.graph.getPreferredSizeForCell(cell);

                            if (cell.vertex) {
                                if (left != null && cell.getAttribute(left) != null) {
                                    cell.geometry.x = x0 + parseFloat(cell.getAttribute(left));
                                }

                                if (top != null && cell.getAttribute(top) != null) {
                                    cell.geometry.y = y0 + parseFloat(cell.getAttribute(top));
                                }

                                if (width.charAt(0) == '@' && cell.getAttribute(width.substring(1)) != null) {
                                    cell.geometry.width = parseFloat(cell.getAttribute(width.substring(1)));
                                } else {
                                    cell.geometry.width = (width == 'auto') ? size.width + padding : parseFloat(width);
                                }

                                if (height.charAt(0) == '@' && cell.getAttribute(height.substring(1)) != null) {
                                    cell.geometry.height = parseFloat(cell.getAttribute(height.substring(1)));
                                } else {
                                    cell.geometry.height = (height == 'auto') ? size.height + padding : parseFloat(height);
                                }

                                y += cell.geometry.height + nodespacing;
                            }

                            if (!exists) {
                                var parent = (parentIndex != null) ? graph.model.getCell(
                                    namespace + values[parentIndex]) : null;
                                allCells.push(cell);

                                if (parent != null) {
                                    parent.style = graph.replacePlaceholders(parent, parentstyle);
                                    graph.addCell(cell, parent);
                                } else {
                                    cells.push(graph.addCell(cell));
                                }
                            } else {
                                if (dups[id] == null) {
                                    dups[id] = [];
                                }

                                dups[id].push(cell);
                            }
                        }
                    }

                    var roots = cells.slice();
                    var select = cells.slice();

                    for (var e = 0; e < edges.length; e++) {
                        var edge = edges[e];

                        for (var i = 0; i < cells.length; i++) {
                            var cell = cells[i];

                            var insertEdge = mxUtils.bind(this, function (realCell, dataCell, edge) {
                                var tmp = dataCell.getAttribute(edge.from);

                                if (tmp != null) {
                                    // Removes attribute
                                    graph.setAttributeForCell(dataCell, edge.from, null);
                                    var refs = tmp.split(',');

                                    for (var j = 0; j < refs.length; j++) {
                                        var ref = lookups[edge.to][refs[j]];

                                        if (ref != null) {
                                            var label = edge.label;

                                            if (edge.fromlabel != null) {
                                                label = (dataCell.getAttribute(edge.fromlabel) || '') + (label || '');
                                            }

                                            if (edge.tolabel != null) {
                                                label = (label || '') + (ref.getAttribute(edge.tolabel) || '');
                                            }

                                            select.push(graph.insertEdge(null, null, label || '',
                                                (edge.invert) ? ref : realCell, (edge.invert) ? realCell : ref,
                                                edge.style || graph.createCurrentEdgeStyle()));
                                            mxUtils.remove((edge.invert) ? realCell : ref, roots);
                                        }
                                    }
                                }
                            });

                            insertEdge(cell, cell, edge);

                            // Checks more entries
                            if (dups[cell.id] != null) {
                                for (var j = 0; j < dups[cell.id].length; j++) {
                                    insertEdge(cell, dups[cell.id][j], edge);
                                }
                            }
                        }
                    }

                    // Removes ignored attributes after processing above
                    if (ignore != null) {
                        for (var i = 0; i < allCells.length; i++) {
                            var cell = allCells[i];

                            for (var j = 0; j < ignore.length; j++) {
                                graph.setAttributeForCell(cell, mxUtils.trim(ignore[j]), null);
                            }
                        }
                    }

                    if (cells.length > 0) {
                        var edgeLayout = new mxParallelEdgeLayout(graph);
                        edgeLayout.spacing = edgespacing;

                        var postProcess = function () {
                            if (edgeLayout.spacing > 0) {
                                edgeLayout.execute(graph.getDefaultParent());
                            }

                            // Aligns cells to grid and/or rounds positions
                            for (var i = 0; i < cells.length; i++) {
                                var geo = graph.getCellGeometry(cells[i]);
                                geo.x = Math.round(graph.snap(geo.x));
                                geo.y = Math.round(graph.snap(geo.y));

                                if (width == 'auto') {
                                    geo.width = Math.round(graph.snap(geo.width));
                                }

                                if (height == 'auto') {
                                    geo.height = Math.round(graph.snap(geo.height));
                                }
                            }
                        };

                        if (layout.charAt(0) == '[') {
                            // Required for layouts to work with new cells
                            var temp = afterInsert;
                            graph.view.validate();
                            this.executeLayoutList(JSON.parse(layout), function () {
                                postProcess();
                                temp();
                            });
                            afterInsert = null;
                        } else if (layout == 'circle') {
                            var circleLayout = new mxCircleLayout(graph);
                            circleLayout.resetEdges = false;

                            var circleLayoutIsVertexIgnored = circleLayout.isVertexIgnored;

                            // Ignore other cells
                            circleLayout.isVertexIgnored = function (vertex) {
                                return circleLayoutIsVertexIgnored.apply(this, arguments) ||
                                    mxUtils.indexOf(cells, vertex) < 0;
                            };

                            this.executeLayout(function () {
                                circleLayout.execute(graph.getDefaultParent());
                                postProcess();
                            }, true, afterInsert);

                            afterInsert = null;
                        } else if (layout == 'horizontaltree' || layout == 'verticaltree' ||
                            (layout == 'auto' && select.length == 2 * cells.length - 1 && roots.length == 1)) {
                            // Required for layouts to work with new cells
                            graph.view.validate();

                            var treeLayout = new mxCompactTreeLayout(graph, layout == 'horizontaltree');
                            treeLayout.levelDistance = nodespacing;
                            treeLayout.edgeRouting = false;
                            treeLayout.resetEdges = false;

                            this.executeLayout(function () {
                                treeLayout.execute(graph.getDefaultParent(), (roots.length > 0) ? roots[0] : null);
                            }, true, afterInsert);

                            afterInsert = null;
                        } else if (layout == 'horizontalflow' || layout == 'verticalflow' ||
                            (layout == 'auto' && roots.length == 1)) {
                            // Required for layouts to work with new cells
                            graph.view.validate();

                            var flowLayout = new mxHierarchicalLayout(graph,
                                (layout == 'horizontalflow') ? mxConstants.DIRECTION_WEST : mxConstants.DIRECTION_NORTH);
                            flowLayout.intraCellSpacing = nodespacing;
                            flowLayout.parallelEdgeSpacing = edgespacing;
                            flowLayout.interRankCellSpacing = levelspacing;
                            flowLayout.disableEdgeStyle = false;

                            this.executeLayout(function () {
                                flowLayout.execute(graph.getDefaultParent(), select);

                                // Workaround for flow layout moving cells to origin
                                graph.moveCells(select, x0, y0);
                            }, true, afterInsert);

                            afterInsert = null;
                        } else if (layout == 'organic' || (layout == 'auto' &&
                            select.length > cells.length)) {
                            // Required for layouts to work with new cells
                            graph.view.validate();

                            var organicLayout = new mxFastOrganicLayout(graph);
                            organicLayout.forceConstant = nodespacing * 3;
                            organicLayout.resetEdges = false;

                            var organicLayoutIsVertexIgnored = organicLayout.isVertexIgnored;

                            // Ignore other cells
                            organicLayout.isVertexIgnored = function (vertex) {
                                return organicLayoutIsVertexIgnored.apply(this, arguments) ||
                                    mxUtils.indexOf(cells, vertex) < 0;
                            };

                            var edgeLayout = new mxParallelEdgeLayout(graph);
                            edgeLayout.spacing = edgespacing;

                            this.executeLayout(function () {
                                organicLayout.execute(graph.getDefaultParent());
                                postProcess();
                            }, true, afterInsert);

                            afterInsert = null;
                        }
                    }

                    this.hideDialog();
                } finally {
                    graph.model.endUpdate();
                }

                if (afterInsert != null) {
                    afterInsert();
                }
            }
        } catch (e) {
            this.handleError(e);
        }
    };

    /**
     * Translates this point by the given vector.
     *
     * @param {number} dx X-coordinate of the translation.
     * @param {number} dy Y-coordinate of the translation.
     */
    EditorUi.prototype.getSearch = function (exclude) {
        var result = '';

        if (urlParams['offline'] != '1' && urlParams['demo'] != '1' && exclude != null && window.location.search.length > 0) {
            var amp = '?';

            for (var key in urlParams) {
                if (mxUtils.indexOf(exclude, key) < 0 && urlParams[key] != null) {
                    result += amp + key + '=' + urlParams[key];
                    amp = '&';
                }
            }
        } else {
            result = window.location.search;
        }

        return result;
    };

    /**
     * Returns the URL for a copy of this editor with no state.
     */
    EditorUi.prototype.getUrl = function (pathname) {
        var href = (pathname != null) ? pathname : window.location.pathname;
        var parms = (href.indexOf('?') > 0) ? 1 : 0;

        if (urlParams['offline'] == '1') {
            href += window.location.search;
        } else {
            var ignored = ['tmp', 'libs', 'clibs', 'state', 'fileId', 'code', 'share', 'notitle',
                'data', 'url', 'embed', 'client', 'create', 'title', 'splash'];

            // Removes template URL parameter for new blank diagram
            for (var key in urlParams) {
                if (mxUtils.indexOf(ignored, key) < 0) {
                    if (parms == 0) {
                        href += '?';
                    } else {
                        href += '&';
                    }

                    if (urlParams[key] != null) {
                        href += key + '=' + urlParams[key];
                        parms++;
                    }
                }
            }
        }

        return href;
    };

    /**
     * Overrides link dialog.
     */
    EditorUi.prototype.showLinkDialog = function (value, btnLabel, fn) {
        var dlg = new LinkDialog(this, value, btnLabel, fn, true);
        this.showDialog(dlg.container, 560, 200, true, true);
        dlg.init();
    };

    /**
     * Overrides createOutline
     */
    var editorUiCreateOutline = EditorUi.prototype.createOutline;

    EditorUi.prototype.createOutline = function (wnd) {
        var outline = editorUiCreateOutline.apply(this, arguments);
        var graph = this.editor.graph;

        var outlineGetSourceGraphBounds = outline.getSourceGraphBounds;
        outline.getSourceGraphBounds = function () {
            if (mxUtils.hasScrollbars(graph.container) && graph.pageVisible && this.source.minimumGraphSize != null) {
                var pb = this.source.getPagePadding();
                var s = this.source.view.scale;

                var result = new mxRectangle(0, 0, Math.ceil(this.source.minimumGraphSize.width - 2 * pb.x / s),
                    Math.ceil(this.source.minimumGraphSize.height - 2 * pb.y / s));

                return result;
            }

            return outlineGetSourceGraphBounds.apply(this, arguments);
        };

        var outlineGetSourceContainerSize = outline.getSourceContainerSize;
        outline.getSourceContainerSize = function () {
            if (mxUtils.hasScrollbars(graph.container) && this.source.minimumGraphSize != null) {
                var pad = this.source.getPagePadding();
                var s = this.source.view.scale;

                return new mxRectangle(0, 0, Math.ceil(this.source.minimumGraphSize.width * s - 2 * pad.x),
                    Math.ceil(this.source.minimumGraphSize.height * s - 2 * pad.y));
            }

            return outlineGetSourceContainerSize.apply(this, arguments);
        };

        outline.getOutlineOffset = function (scale) {
            if (mxUtils.hasScrollbars(graph.container) && this.source.minimumGraphSize != null) {
                var pb = this.source.getPagePadding();

                var dx = Math.max(0, (outline.outline.container.clientWidth / scale - (this.source.minimumGraphSize.width - 2 * pb.x)) / 2);
                var dy = Math.max(0, (outline.outline.container.clientHeight / scale - (this.source.minimumGraphSize.height - 2 * pb.y)) / 2);

                // Why is vertical offset negative relative to dy
                return new mxPoint(Math.round(dx - pb.x), Math.round(dy - pb.y - 5 / scale));
            }

            return new mxPoint(8 / scale, 8 / scale);
        };

        var outlineInit = outline.init;
        outline.init = function () {
            outlineInit.apply(this, arguments);

            // Problem: Need to override a function in the view but the view is created
            // with the graph so a refresh of the page is needed to see this change.
            outline.outline.view.getBackgroundPageBounds = function () {
                var layout = graph.getPageLayout();
                var page = graph.getPageSize();

                return new mxRectangle(this.scale * (this.translate.x + layout.x * page.width),
                    this.scale * (this.translate.y + layout.y * page.height),
                    this.scale * layout.width * page.width,
                    this.scale * layout.height * page.height);
            };

            outline.outline.view.validateBackgroundPage();
        };

        this.editor.addListener('pageSelected', function (sender, evt) {
            var change = evt.getProperty('change');

            var graph = outline.source;
            var g = outline.outline;

            g.pageScale = graph.pageScale;
            g.pageFormat = graph.pageFormat;
            g.background = graph.background;
            g.pageVisible = graph.pageVisible;
            g.background = graph.background;

            var current = mxUtils.getCurrentStyle(graph.container);
            g.container.style.backgroundColor = current.backgroundColor;

            if (graph.view.backgroundPageShape != null && g.view.backgroundPageShape != null) {
                g.view.backgroundPageShape.fill = graph.view.backgroundPageShape.fill;
            }

            outline.outline.view.clear(change.previousPage.root, true);
            outline.outline.view.validate();
        });

        return outline;
    };

    /**
     * Returns the number of storage options enabled
     */
    EditorUi.prototype.getServiceCount = function (allowBrowser, splash) {
        var serviceCount = 1;

        if (this.drive != null || typeof window.DriveClient === 'function') {
            serviceCount++
        }

        if (!splash && (this.dropbox != null || typeof window.DropboxClient === 'function')) {
            serviceCount++
        }

        if (this.oneDrive != null || typeof window.OneDriveClient === 'function') {
            serviceCount++
        }

        if (!splash && (this.gitHub != null)) {
            serviceCount++
        }

        if (!splash && (this.gitLab != null)) {
            serviceCount++
        }

        if (splash && allowBrowser && isLocalStorage && urlParams['browser'] == '1') {
            serviceCount++
        }

        return serviceCount;
    }

    /**
     * Updates action and menu states depending on the file.
     */
    EditorUi.prototype.updateUi = function () {
        this.updateButtonContainer();
        this.updateActionStates();

        // Action states that only need update for new files
        var file = this.getCurrentFile();
        var active = file != null || (urlParams['embed'] == '1' &&
            this.editor.graph.isEnabled());
        this.menus.get('viewPanels').setEnabled(active);
        this.menus.get('viewZoom').setEnabled(active);

        var restricted = (urlParams['embed'] != '1' ||
            !this.editor.graph.isEnabled()) &&
            (file == null || file.isRestricted());

        // Disables libraries and extras menu in embed mode
        // while waiting for file data
        var libsEnabled = urlParams['embed'] != '1' ||
            this.editor.graph.isEnabled();

        // Disables actions in the toolbar
        var editable = (urlParams['embed'] == '1' &&
            this.editor.graph.isEnabled()) ||
            (file != null && file.isEditable());
        this.actions.get('image').setEnabled(active);
        this.actions.get('zoomIn').setEnabled(active);
        this.actions.get('zoomOut').setEnabled(active);
        this.actions.get('resetView').setEnabled(active);

        // Updates undo history states
        this.actions.get('undo').setEnabled(this.canUndo() && editable);
        this.actions.get('redo').setEnabled(this.canRedo() && editable);

        // Disables connection drop downs in toolbar
        if (this.toolbar != null) {
            if (this.toolbar.edgeShapeMenu != null) {
                this.toolbar.edgeShapeMenu.setEnabled(editable);
            }

            if (this.toolbar.edgeStyleMenu != null) {
                this.toolbar.edgeStyleMenu.setEnabled(editable);
            }
        }

        if (this.isAppCache()) {
            var appCache = applicationCache;

            // NOTE: HTML5 Cache is deprecated
            if (appCache != null && this.offlineStatus == null) {
                this.offlineStatus = document.createElement('div');
                this.offlineStatus.className = 'geItem';
                this.offlineStatus.style.position = 'absolute';
                this.offlineStatus.style.fontSize = '8pt';
                this.offlineStatus.style.top = '2px';
                this.offlineStatus.style.right = '12px';
                this.offlineStatus.style.color = '#666';
                this.offlineStatus.style.margin = '4px';
                this.offlineStatus.style.padding = '2px';
                this.offlineStatus.style.verticalAlign = 'middle';
                this.offlineStatus.innerHTML = '';

                this.menubarContainer.appendChild(this.offlineStatus);

                mxEvent.addListener(this.offlineStatus, 'click', mxUtils.bind(this, function () {
                    var img = this.offlineStatus.getElementsByTagName('img');

                    if (img != null && img.length > 0) {
                        this.alert(img[0].getAttribute('title'));
                    }
                }));

                var appCache = window.applicationCache;
                var lastStatus = null;

                var updateStatus = mxUtils.bind(this, function () {
                    var newStatus = appCache.status;
                    var html = '';

                    if (newStatus == appCache.CHECKING) {
                        newStatus = appCache.DOWNLOADING;
                    }

                    switch (newStatus) {
                        case appCache.UNCACHED: // UNCACHED == 0
                            html = '';
                            break;
                        case appCache.IDLE: // IDLE == 1
                            html = (uiTheme == 'min') ? '' : '<img title="draw.io is up to date." border="0" src="' + IMAGE_PATH + '/checkmark.gif"/>';
                            break;
                        case appCache.DOWNLOADING: // DOWNLOADING == 3
                            html = '<img title="Downloading new version..." border="0" src="' + IMAGE_PATH + '/spin.gif"/>';
                            break;
                        case appCache.UPDATEREADY:  // UPDATEREADY == 4
                            html = '<img title="' + mxUtils.htmlEntities(mxResources.get('restartForChangeRequired')) +
                                '" border="0" src="' + IMAGE_PATH + '/download.png"/>';
                            break;
                        case appCache.OBSOLETE: // OBSOLETE == 5
                            html = '<img title="Obsolete" border="0" src="' + IMAGE_PATH + '/clear.gif"/>';
                            break;
                        default:
                            html = '<img title="Unknown" border="0" src="' + IMAGE_PATH + '/clear.gif"/>';
                            break;
                    }

                    if (newStatus != lastStatus) {
                        this.offlineStatus.innerHTML = html;
                        lastStatus = newStatus;
                    }
                });

                mxEvent.addListener(appCache, 'checking', updateStatus);
                mxEvent.addListener(appCache, 'noupdate', updateStatus);
                mxEvent.addListener(appCache, 'downloading', updateStatus);
                mxEvent.addListener(appCache, 'progress', updateStatus);
                mxEvent.addListener(appCache, 'cached', updateStatus);
                mxEvent.addListener(appCache, 'updateready', updateStatus);
                mxEvent.addListener(appCache, 'obsolete', updateStatus);
                mxEvent.addListener(appCache, 'error', updateStatus);

                updateStatus();
            }
        } else {
            this.updateUserElement();
        }
    };

    /**
     * Hook for subclassers
     */
    EditorUi.prototype.updateButtonContainer = function () {
        // do nothing
    };

    /**
     * Hook for subclassers
     */
    EditorUi.prototype.updateUserElement = function () {
        // do nothing
    };

    /**
     * Hook for subclassers
     */
    EditorUi.prototype.scheduleSanityCheck = function () {
        // do nothing
    };

    /**
     * Hook for subclassers
     */
    EditorUi.prototype.stopSanityCheck = function () {
        // do nothing
    };

    /**
     * Returns true if a diagram is cative and editable.
     */
    EditorUi.prototype.isDiagramActive = function () {
        var file = this.getCurrentFile();

        return (file != null && file.isEditable()) ||
            (urlParams['embed'] == '1' && this.editor.graph.isEnabled());
    };

    /**
     * Updates action states depending on the selection.
     */
    var editorUiUpdateActionStates = EditorUi.prototype.updateActionStates;
    EditorUi.prototype.updateActionStates = function () {
        editorUiUpdateActionStates.apply(this, arguments);

        var graph = this.editor.graph;
        var active = this.isDiagramActive();
        var file = this.getCurrentFile();
        var enabled = file != null || urlParams['embed'] == '1';
        this.actions.get('pageSetup').setEnabled(active);
        this.actions.get('autosave').setEnabled(file != null && file.isEditable() && file.isAutosaveOptional());
        this.actions.get('guides').setEnabled(active);
        this.actions.get('editData').setEnabled(active);
        this.actions.get('shadowVisible').setEnabled(active);
        this.actions.get('connectionArrows').setEnabled(active);
        this.actions.get('connectionPoints').setEnabled(active);
        this.actions.get('copyStyle').setEnabled(active && !graph.isSelectionEmpty());
        this.actions.get('pasteStyle').setEnabled(active && !graph.isSelectionEmpty());
        this.actions.get('editGeometry').setEnabled(graph.getModel().isVertex(graph.getSelectionCell()));
        this.actions.get('createShape').setEnabled(active);
        this.actions.get('find').setEnabled(this.diagramContainer.style.visibility != 'hidden');
        this.actions.get('layers').setEnabled(this.diagramContainer.style.visibility != 'hidden');
        this.actions.get('outline').setEnabled(this.diagramContainer.style.visibility != 'hidden');

        var state = graph.view.getState(graph.getSelectionCell());
        this.actions.get('editShape').setEnabled(active && state != null && state.shape != null && state.shape.stencil != null);
    };

    /**
     * Overridden to remove export dialog in chromeless lightbox.
     */
    var editoUiDestroy = EditorUi.prototype.destroy;

    EditorUi.prototype.destroy = function () {
        if (this.editUpdateListener) {
            this.editor.undoManager.removeListener(this.editUpdateListener);
            this.editUpdateListener = null;
        }

        if (this.exportDialog != null) {
            this.exportDialog.parentNode.removeChild(this.exportDialog);
            this.exportDialog = null;
        }

        editoUiDestroy.apply(this, arguments);
    };

    /**
     * Overrides export dialog for using ui functions for save and setting global switches.
     */
    if (window.ExportDialog != null) {
        ExportDialog.showXmlOption = false;
        ExportDialog.showGifOption = false;

        ExportDialog.exportFile = function (editorUi, name, format, bg, s, b, dpi) {
            var graph = editorUi.editor.graph;

            if (format == 'xml') {
                editorUi.hideDialog();
                editorUi.saveData(name, 'xml', mxUtils.getXml(editorUi.editor.getGraphXml()), 'text/xml');
            } else if (format == 'svg') {
                editorUi.hideDialog();
                editorUi.saveData(name, 'svg', mxUtils.getXml(graph.getSvg(bg, s, b)), 'image/svg+xml');
            } else {
                var data = editorUi.getFileData(true, null, null, null, null, true);
                var bounds = graph.getGraphBounds();
                var w = Math.floor(bounds.width * s / graph.view.scale);
                var h = Math.floor(bounds.height * s / graph.view.scale);

                if (data.length <= MAX_REQUEST_SIZE && w * h < MAX_AREA) {
                    editorUi.hideDialog();

                    if ((format == 'png' || format == 'jpg' || format == 'jpeg') && editorUi.isExportToCanvas()) {
                        if (format == 'png') {
                            editorUi.exportImage(s, bg == null || bg == 'none', true,
                                false, false, b, true, false, null, null, dpi);
                        } else {
                            editorUi.exportImage(s, false, true,
                                false, false, b, true, false, 'jpeg');
                        }
                    } else {
                        var extras = {globalVars: graph.getExportVariables()};

                        editorUi.saveRequest(name, format,
                            function (newTitle, base64) {
                                return new mxXmlRequest(EXPORT_URL, 'format=' + format + '&base64=' + (base64 || '0') +
                                    ((newTitle != null) ? '&filename=' + encodeURIComponent(newTitle) : '') +
                                    '&extras=' + encodeURIComponent(JSON.stringify(extras)) +
                                    (dpi > 0 ? '&dpi=' + dpi : '') +
                                    '&bg=' + ((bg != null) ? bg : 'none') + '&w=' + w + '&h=' + h +
                                    '&border=' + b + '&xml=' + encodeURIComponent(data));
                            });
                    }
                } else {
                    mxUtils.alert(mxResources.get('drawingTooLarge'));
                }
            }
        };
    }

    /*********************************************************************************************
     * This section is a fix for undo/redo edits having stale 1st- and 2nd-order references      *
     * The code might be reworked or even thrown out when a conceptually nicer solution is found *
     *********************************************************************************************/

    /**
     * Updates all references in all edits and their changes in order to correspond to current model
     */
    EditorUi.prototype.updateEditReferences = function (edit) {
        for (var i = 0; i < edit.changes.length; i++) {
            var change = edit.changes[i];

            if (change != null && change.constructor == mxChildChange) {
                if (change.child != null) {
                    var child = change.child;

                    if (child.source != null && child.source.id != null) {
                        var modelSource = this.getFutureCellForEdit(change.model, edit, child.source.id);

                        if (modelSource != child.source) {
                            child.source = modelSource
                        }
                    }

                    if (child.target != null && child.target.id != null) {
                        var modelTarget = this.getFutureCellForEdit(change.model, edit, child.target.id);

                        if (modelTarget != child.target) {
                            child.target = modelTarget
                        }
                    }
                }
            }
        }
    };

    /**
     * Looks ahead in edit's changes to see if the last child change containing ID is one that creates a cell, then returns it.
     * If cell already exists in a model, returns it first.
     */
    EditorUi.prototype.getFutureCellForEdit = function (model, edit, id) {
        var result = model.getCell(id);

        if (result == null) {
            // Scans changes backwards
            for (var i = edit.changes.length - 1; i >= 0; i--) {
                var change = edit.changes[i];

                if (change.constructor == mxChildChange) {
                    // Checks if child is being added in this change
                    if (change.child != null && change.child.id == id) {
                        // Checks if cell is being removed
                        if (model.contains(change.previous)) {
                            result = change.child;
                        }

                        // Stops scan in any case, at the end of the edit
                        // the cell will be either added or deleted
                        break;
                    }
                }
            }
        }

        return result;
    };

    EditorUi.prototype.getDiagramTextContent = function () {
        this.editor.graph.setEnabled(false);
        var graph = this.editor.graph;

        var allPagesTxt = '';

        if (this.pages != null) {
            for (var i = 0; i < this.pages.length; i++) {
                var pageGraph = graph;

                if (this.currentPage != this.pages[i]) {
                    pageGraph = this.createTemporaryGraph(graph.getStylesheet());
                    pageGraph.model.setRoot(this.pages[i].root);
                }
                allPagesTxt += this.pages[i].getName() + ' ' + pageGraph.getIndexableText() + ' ';
            }
        } else {
            allPagesTxt = graph.getIndexableText();
        }

        this.editor.graph.setEnabled(true);
        return allPagesTxt;
    };

    EditorUi.prototype.showRemotelyStoredLibrary = function (title) {
        var selectedLibs = {};
        var div = document.createElement('div');
        div.style.whiteSpace = 'nowrap';
        var graph = this.editor.graph;

        var hd = document.createElement('h3');
        mxUtils.write(hd, mxUtils.htmlEntities(title));
        hd.style.cssText = 'width:100%;text-align:center;margin-top:0px;margin-bottom:12px';
        div.appendChild(hd);

        var libsSection = document.createElement('div');
        libsSection.style.cssText = 'border:1px solid lightGray;overflow: auto;height:300px';

        libsSection.innerHTML = '<div style="text-align:center;padding:8px;"><img src="/images/spin.gif"></div>';

        var loadedLibs = {};

        try {
            var custLibs = mxSettings.getCustomLibraries();

            for (var j = 0; j < custLibs.length; j++) {
                var l = custLibs[j];

                if (l.substring(0, 1) == 'R') {
                    var libDesc = JSON.parse(decodeURIComponent(l.substring(1)));
                    loadedLibs[libDesc[0]] = {
                        id: libDesc[0],
                        title: libDesc[1],
                        downloadUrl: libDesc[2]
                    };
                }
            }
        } catch (e) {
        }

        this.remoteInvoke('getCustomLibraries', null, null, function (libsList) {
            libsSection.innerHTML = '';

            if (libsList.length == 0) {
                libsSection.innerHTML = '<div style="text-align:center;padding-top:20px;color:gray;">' +
                    mxUtils.htmlEntities(mxResources.get('noLibraries')) + '</div>';
            } else {
                for (var i = 0; i < libsList.length; i++) {
                    var lib = libsList[i];

                    if (loadedLibs[lib.id]) {
                        selectedLibs[lib.id] = lib;
                    }

                    var libCheck = this.addCheckbox(libsSection, lib.title, loadedLibs[lib.id]);

                    (function (lib2, check) {
                        mxEvent.addListener(check, 'change', function () {
                            if (this.checked) {
                                selectedLibs[lib2.id] = lib2;
                            } else {
                                delete selectedLibs[lib2.id];
                            }
                        });
                    })(lib, libCheck)
                }
            }
        }, mxUtils.bind(this, function (e) {
            libsSection.innerHTML = '';
            var status = document.createElement('div');
            status.style.padding = '8px';
            status.style.textAlign = 'center';
            mxUtils.write(status, mxResources.get('error') + ': ');
            mxUtils.write(status, (e != null && e.message != null) ?
                e.message : mxResources.get('unknownError'));
            libsSection.appendChild(status);
        }));

        div.appendChild(libsSection);

        var dlg = new CustomDialog(this, div, mxUtils.bind(this, function () {
            this.spinner.spin(document.body, mxResources.get('loading'));
            var pendingLibs = 0;

            for (var id in selectedLibs) {
                if (loadedLibs[id] != null) continue; //already loaded!

                pendingLibs++;

                (mxUtils.bind(this, function (lib) {
                    this.remoteInvoke('getFileContent', [lib.downloadUrl], null, mxUtils.bind(this, function (libContent) {
                        pendingLibs--;

                        if (pendingLibs == 0) this.spinner.stop();

                        try {
                            this.loadLibrary(new RemoteLibrary(this, libContent, lib));
                        } catch (e) {
                            this.handleError(e, mxResources.get('errorLoadingFile'));
                        }
                    }), mxUtils.bind(this, function () {
                        pendingLibs--;

                        if (pendingLibs == 0) this.spinner.stop();

                        this.handleError(null, mxResources.get('errorLoadingFile'));
                    }));
                }))(selectedLibs[id]);
            }

            for (var id in loadedLibs) {
                if (!selectedLibs[id]) //Removed
                {
                    this.closeLibrary(new RemoteLibrary(this, null, loadedLibs[id])); //create a dummy library such that we can call closeLibrary
                }
            }

            if (pendingLibs == 0) this.spinner.stop();
        }), null, null, 'https://desk.draw.io/support/solutions/articles/16000092763');
        this.showDialog(dlg.container, 340, 375, true, true, null, null, null, null, true);
    };

    //Remote invokation, currently limited to functions in EditorUi (and its sub objects) for security reasons
    //White-listed functions and some info about it
    EditorUi.prototype.remoteInvokableFns = {
        getDiagramTextContent: {isAsync: false}
    };

    EditorUi.prototype.remoteInvokeCallbacks = [];
    EditorUi.prototype.remoteInvokeQueue = [];

    EditorUi.prototype.handleRemoteInvokeReady = function (remoteWin) {
        this.remoteWin = remoteWin;

        for (var i = 0; i < this.remoteInvokeQueue.length; i++) {
            remoteWin.postMessage(this.remoteInvokeQueue[i], '*');
        }

        this.remoteInvokeQueue = [];
    };

    EditorUi.prototype.handleRemoteInvokeResponse = function (msg) {
        var msgMarkers = msg.msgMarkers;
        var callback = this.remoteInvokeCallbacks[msgMarkers.callbackId];

        if (msg.error) {
            if (callback.error) callback.error(msg.error.errResp);
        } else if (callback.callback) {
            callback.callback.apply(this, msg.resp);
        }

        this.remoteInvokeCallbacks[msgMarkers.callbackId] = null; //set it to null only to keep the index
    };

    EditorUi.prototype.remoteInvoke = function (remoteFn, remoteFnArgs, msgMarkers, callback, error) {
        var acceptResponse = true;

        var timeoutThread = window.setTimeout(mxUtils.bind(this, function () {
            acceptResponse = false;
            error({code: App.ERROR_TIMEOUT, message: mxResources.get('timeout')});
        }), this.timeout);

        var wrapper = mxUtils.bind(this, function () {
            window.clearTimeout(timeoutThread);

            if (acceptResponse) {
                callback.apply(this, arguments);
            }
        });

        msgMarkers = msgMarkers || {};
        msgMarkers.callbackId = this.remoteInvokeCallbacks.length;
        this.remoteInvokeCallbacks.push({callback: wrapper, error: error});
        var msg = JSON.stringify({
            event: 'remoteInvoke',
            funtionName: remoteFn,
            functionArgs: remoteFnArgs,
            msgMarkers: msgMarkers
        });

        if (this.remoteWin != null) //remote invoke is ready
        {
            this.remoteWin.postMessage(msg, '*');
        } else {
            this.remoteInvokeQueue.push(msg);
        }
    };

    EditorUi.prototype.handleRemoteInvoke = function (msg) {
        var sendResponse = mxUtils.bind(this, function (resp, error) {
            var respMsg = {event: 'remoteInvokeResponse', msgMarkers: msg.msgMarkers};

            if (error != null) {
                respMsg.error = {errResp: error};
            } else if (resp != null) {
                respMsg.resp = resp;
            }

            this.remoteWin.postMessage(JSON.stringify(respMsg), '*');
        });

        try {
            //Remote invoke are allowed to call functions in AC
            var funtionName = msg.funtionName;
            var functionInfo = this.remoteInvokableFns[funtionName];

            if (functionInfo != null && typeof this[funtionName] === 'function') {
                var functionArgs = msg.functionArgs;

                //Confirm functionArgs are not null and is array, otherwise, discard it
                if (!Array.isArray(functionArgs)) {
                    functionArgs = [];
                }

                //for functions with callbacks (async) we assume last two arguments are success, error
                if (functionInfo.isAsync) {
                    //success
                    functionArgs.push(function () {
                        sendResponse(Array.prototype.slice.apply(arguments));
                    });

                    //error
                    functionArgs.push(function (err) {
                        sendResponse(null, err || 'Unkown Error');
                    });

                    this[funtionName].apply(this, functionArgs);
                } else {
                    var resp = this[funtionName].apply(this, functionArgs);

                    sendResponse([resp]);
                }
            } else {
                sendResponse(null, 'Invalid Call: ' + funtionName + ' is not found.');
            }
        } catch (e) {
            sendResponse(null, 'Invalid Call: An error occured, ' + e.message);
        }
    };

    /**
     *
     * Comments: We need these functions as wrapper of File functions in order to facilitate overriding them if comments are needed without having a file
     *             (e.g. Confluence Plugin)
     *
     */

    /**
     * Are comments supported
     */
    EditorUi.prototype.commentsSupported = function () {
        var file = this.getCurrentFile();

        return file != null ? file.commentsSupported() : false;
    };

    /**
     * Show refresh button?
     */
    EditorUi.prototype.commentsRefreshNeeded = function () {
        var file = this.getCurrentFile();

        return file != null ? file.commentsRefreshNeeded() : true;
    };

    /**
     * Show save button?
     */
    EditorUi.prototype.commentsSaveNeeded = function () {
        var file = this.getCurrentFile();

        return file != null ? file.commentsSaveNeeded() : false;
    };

    /**
     * Get comments
     */
    EditorUi.prototype.getComments = function (success, error) {
        var file = this.getCurrentFile();

        if (file != null) {
            file.getComments(success, error);
        } else {
            success([]); //placeholder
        }
    };

    /**
     * Add a comment
     */
    EditorUi.prototype.addComment = function (comment, success, error) {
        var file = this.getCurrentFile();

        if (file != null) {
            file.addComment(comment, success, error);
        } else {
            success(Date.now()); //placeholder
        }
    };

    /**
     * Can add a reply to a reply
     */
    EditorUi.prototype.canReplyToReplies = function () {
        var file = this.getCurrentFile();

        return file != null ? file.canReplyToReplies() : true;
    };

    /**
     * Can add comments (The permission to comment)
     */
    EditorUi.prototype.canComment = function () {
        var file = this.getCurrentFile();

        return file != null ? file.canComment() : true;
    };

    /**
     * Get a new comment object
     */
    EditorUi.prototype.newComment = function (content, user) {
        var file = this.getCurrentFile();

        if (file != null) {
            return file.newComment(content, user)
        } else {
            return new DrawioComment(this, null, content, Date.now(), Date.now(), false, user);
        }
    };

    //==================================================== End of comments =================================================================

    /**
     * Does revisions history available
     */
    EditorUi.prototype.isRevisionHistorySupported = function () {
        var file = this.getCurrentFile();

        return file != null && file.isRevisionHistorySupported();
    };

    /**
     * Get revisions of current file
     */
    EditorUi.prototype.getRevisions = function (success, error) {
        var file = this.getCurrentFile();

        if (file != null && file.getRevisions) {
            file.getRevisions(success, error);
        } else {
            error({message: mxResources.get('unknownError')});
        }
    };

    /**
     * Is revisions history enabled
     */
    EditorUi.prototype.isRevisionHistoryEnabled = function () {
        var file = this.getCurrentFile();

        return file != null &&
            ((file.constructor == DriveFile && file.isEditable()));
    };

    //===========Adding methods to find the service running draw.io and allowing calling draw.io remote services
    EditorUi.prototype.getServiceName = function () {
        return 'draw.io';
    };

    EditorUi.prototype.addRemoteServiceSecurityCheck = function (xhr) {
        //Using a standard header with specific sequence
        xhr.setRequestHeader('Content-Language', 'da, mi, en, de-DE');
    };
})();

/**
 * Comments Window, It is used by both editor and viewer. So, it is here in a common place
 */
var CommentsWindow = function (editorUi, x, y, w, h, saveCallback) {
    var readOnly = !editorUi.canComment();
    var canReplyToReplies = editorUi.canReplyToReplies();
    var curEdited = null;

    var div = document.createElement('div');
    div.className = 'geCommentsWin';
    div.style.background = (Dialog.backdropColor == 'white') ? 'whiteSmoke' : Dialog.backdropColor;

    var tbarHeight = (!EditorUi.compactUi) ? '30px' : '26px';

    var listDiv = document.createElement('div');
    listDiv.className = 'geCommentsList';
    listDiv.style.backgroundColor = (Dialog.backdropColor == 'white') ? 'whiteSmoke' : Dialog.backdropColor;
    listDiv.style.bottom = (parseInt(tbarHeight) + 7) + 'px';
    div.appendChild(listDiv);

    var noComments = document.createElement('span');
    noComments.style.cssText = 'display:none;padding-top:10px;text-align:center;';
    mxUtils.write(noComments, mxResources.get('noCommentsFound'));

    var selectionComment = null;

    var ldiv = document.createElement('div');

    ldiv.className = 'geToolbarContainer geCommentsToolbar';
    ldiv.style.height = tbarHeight;
    ldiv.style.padding = (!EditorUi.compactUi) ? '1px' : '4px 0px 3px 0px';
    ldiv.style.backgroundColor = (Dialog.backdropColor == 'white') ? 'whiteSmoke' : Dialog.backdropColor;

    if (mxClient.IS_QUIRKS) {
        ldiv.style.filter = 'none';
    }

    var link = document.createElement('a');
    link.className = 'geButton';

    if (mxClient.IS_QUIRKS) {
        link.style.filter = 'none';
    }

    function updateNoComments() {
        var divs = listDiv.getElementsByTagName('div');
        var visibleCount = 0;

        for (var i = 0; i < divs.length; i++) {
            if (divs[i].style.display != 'none' && divs[i].parentNode == listDiv) {
                visibleCount++;
            }
        }

        noComments.style.display = (visibleCount == 0) ? 'block' : 'none';
    };

    function editComment(comment, cdiv, saveCallback, deleteOnCancel) {
        curEdited = {div: cdiv, comment: comment, saveCallback: saveCallback, deleteOnCancel: deleteOnCancel};

        var commentTxt = cdiv.querySelector('.geCommentTxt');
        var actionsDiv = cdiv.querySelector('.geCommentActionsList');

        var textArea = document.createElement('textarea');
        textArea.className = 'geCommentEditTxtArea';
        textArea.style.minHeight = commentTxt.offsetHeight + 'px';
        textArea.value = comment.content;
        cdiv.insertBefore(textArea, commentTxt);

        var btnDiv = document.createElement('div');
        btnDiv.className = 'geCommentEditBtns';

        function reset() {
            cdiv.removeChild(textArea);
            cdiv.removeChild(btnDiv);
            actionsDiv.style.display = 'block';
            commentTxt.style.display = 'block';
        };

        var cancelBtn = mxUtils.button(mxResources.get('cancel'), function () {
            if (deleteOnCancel) {
                cdiv.parentNode.removeChild(cdiv);
                updateNoComments();
            } else {
                reset();
            }

            curEdited = null;
        });

        cancelBtn.className = 'geCommentEditBtn';
        btnDiv.appendChild(cancelBtn);

        var saveBtn = mxUtils.button(mxResources.get('save'), function () {
            commentTxt.innerHTML = '';
            comment.content = textArea.value;
            mxUtils.write(commentTxt, comment.content);
            reset();
            saveCallback(comment);
            curEdited = null;
        });

        // Updates modified state and handles placeholder text
        mxEvent.addListener(textArea, 'keydown', mxUtils.bind(this, function (evt) {
            if (!mxEvent.isConsumed(evt)) {
                if ((mxEvent.isControlDown(evt) || (mxClient.IS_MAC &&
                    mxEvent.isMetaDown(evt))) && evt.keyCode == 13 /* Ctrl+Enter */) {
                    saveBtn.click();
                    mxEvent.consume(evt);
                } else if (evt.keyCode == 27 /* Escape */) {
                    cancelBtn.click();
                    mxEvent.consume(evt);
                }
            }
        }));

        // Focused to include in viewport before focusin textbox
        saveBtn.focus();
        saveBtn.className = 'geCommentEditBtn gePrimaryBtn';
        btnDiv.appendChild(saveBtn);

        cdiv.insertBefore(btnDiv, commentTxt);
        actionsDiv.style.display = 'none';
        commentTxt.style.display = 'none';
        textArea.focus();
    };

    function writeCommentDate(comment, dateDiv) {
        dateDiv.innerHTML = '';
        var ts = new Date(comment.modifiedDate);
        var str = editorUi.timeSince(ts);

        if (str == null) {
            str = mxResources.get('lessThanAMinute');
        }

        mxUtils.write(dateDiv, mxResources.get('timeAgo', [str], '{1} ago'));
        dateDiv.setAttribute('title', ts.toLocaleDateString() + ' ' +
            ts.toLocaleTimeString());
    };

    function showBusy(commentDiv) {
        var busyImg = document.createElement('img');
        busyImg.className = 'geCommentBusyImg';
        busyImg.src = IMAGE_PATH + '/spin.gif';
        commentDiv.appendChild(busyImg);
        commentDiv.busyImg = busyImg;
    };

    function showError(commentDiv) {
        commentDiv.style.border = '1px solid red';
        commentDiv.removeChild(commentDiv.busyImg);
    };

    function showDone(commentDiv) {
        commentDiv.style.border = '';
        commentDiv.removeChild(commentDiv.busyImg);
    };

    function addComment(comment, parentArr, parent, level, showResolved) {
        //Skip resolved comments if showResolved is not set
        if (!showResolved && comment.isResolved) {
            return;
        }

        noComments.style.display = 'none';

        var cdiv = document.createElement('div');
        cdiv.className = 'geCommentContainer';
        cdiv.setAttribute('data-commentId', comment.id);
        cdiv.style.marginLeft = (level * 20 + 5) + 'px';

        if (comment.isResolved && uiTheme != 'dark') {
            cdiv.style.backgroundColor = 'ghostWhite';
        }

        var headerDiv = document.createElement('div');
        headerDiv.className = 'geCommentHeader';

        var userImg = document.createElement('img');
        userImg.className = 'geCommentUserImg';
        userImg.src = comment.user.pictureUrl || Editor.userImage;
        headerDiv.appendChild(userImg);

        var headerTxt = document.createElement('div');
        headerTxt.className = 'geCommentHeaderTxt';
        headerDiv.appendChild(headerTxt);

        var usernameDiv = document.createElement('div');
        usernameDiv.className = 'geCommentUsername';
        mxUtils.write(usernameDiv, comment.user.displayName || '');
        headerTxt.appendChild(usernameDiv);

        var dateDiv = document.createElement('div');
        dateDiv.className = 'geCommentDate';
        dateDiv.setAttribute('data-commentId', comment.id);
        writeCommentDate(comment, dateDiv);
        headerTxt.appendChild(dateDiv);
        cdiv.appendChild(headerDiv);

        var commentTxtDiv = document.createElement('div');
        commentTxtDiv.className = 'geCommentTxt';
        mxUtils.write(commentTxtDiv, comment.content || '');
        cdiv.appendChild(commentTxtDiv);

        var actionsDiv = document.createElement('div');
        actionsDiv.className = 'geCommentActions';
        var actionsList = document.createElement('ul');
        actionsList.className = 'geCommentActionsList';
        actionsDiv.appendChild(actionsList);

        function addAction(name, evtHandler, hide) {
            var action = document.createElement('li');
            action.className = 'geCommentAction';
            var actionLnk = document.createElement('a');
            actionLnk.className = 'geCommentActionLnk';
            mxUtils.write(actionLnk, name);
            action.appendChild(actionLnk);

            mxEvent.addListener(actionLnk, 'click', function (evt) {
                evtHandler(evt, comment);
                evt.preventDefault();
                mxEvent.consume(evt);
            });

            actionsList.appendChild(action);

            if (hide) action.style.display = 'none';
        };

        function collectReplies() {
            var replies = [];
            var pdiv = cdiv;

            function collectReplies(comment) {
                replies.push(pdiv);

                if (comment.replies != null) {
                    for (var i = 0; i < comment.replies.length; i++) {
                        pdiv = pdiv.nextSibling;
                        collectReplies(comment.replies[i]);
                    }
                }
            }

            collectReplies(comment);

            return {pdiv: pdiv, replies: replies};
        };

        function addReply(initContent, editIt, saveCallback, doResolve, doReopen) {
            var pdiv = collectReplies().pdiv;

            var newReply = editorUi.newComment(initContent, editorUi.getCurrentUser());
            newReply.pCommentId = comment.id;

            if (comment.replies == null) comment.replies = [];

            var replyComment = addComment(newReply, comment.replies, pdiv, level + 1);

            function doAddReply() {
                showBusy(replyComment);

                comment.addReply(newReply, function (id) {
                    newReply.id = id;
                    comment.replies.push(newReply);
                    showDone(replyComment);

                    if (saveCallback) saveCallback();

                }, function (err) {
                    doEdit();
                    showError(replyComment);
                    editorUi.handleError(err, null, null, null,
                        mxUtils.htmlEntities(mxResources.get('objectNotFound')));
                }, doResolve, doReopen);
            };

            function doEdit() {
                editComment(newReply, replyComment, function (newReply) {
                    doAddReply();
                }, true);
            };

            if (editIt) {
                doEdit();
            } else {
                doAddReply();
            }
        };

        if (!readOnly && (level == 0 || canReplyToReplies)) {
            addAction(mxResources.get('reply'), function () {
                addReply('', true);
            }, comment.isResolved);
        }

        var user = editorUi.getCurrentUser();

        if (user != null && user.id == comment.user.id && !readOnly) {
            addAction(mxResources.get('edit'), function () {
                function doEditComment() {
                    editComment(comment, cdiv, function () {
                        showBusy(cdiv);

                        comment.editComment(comment.content, function () {
                            showDone(cdiv);
                        }, function (err) {
                            showError(cdiv);
                            doEditComment();
                            editorUi.handleError(err, null, null, null,
                                mxUtils.htmlEntities(mxResources.get('objectNotFound')));
                        });
                    });
                };

                doEditComment();
            }, comment.isResolved);

            addAction(mxResources.get('delete'), function () {
                editorUi.confirm(mxResources.get('areYouSure'), function () {
                    showBusy(cdiv);

                    comment.deleteComment(function () {
                        var replies = collectReplies(comment).replies;

                        for (var i = 0; i < replies.length; i++) {
                            listDiv.removeChild(replies[i]);
                        }

                        for (var i = 0; i < parentArr.length; i++) {
                            if (parentArr[i] == comment) {
                                parentArr.splice(i, 1);
                                break;
                            }
                        }

                        noComments.style.display = (listDiv.getElementsByTagName('div').length == 0) ? 'block' : 'none';
                    }, function (err) {
                        showError(cdiv);
                        editorUi.handleError(err, null, null, null,
                            mxUtils.htmlEntities(mxResources.get('objectNotFound')));
                    });
                });
            }, comment.isResolved);
        }

        if (!readOnly && level == 0) //Resolve is a top-level action only
        {
            function toggleResolve(evt) {
                function doToggle() {
                    var resolveActionLnk = evt.target;
                    resolveActionLnk.innerHTML = '';

                    comment.isResolved = !comment.isResolved;
                    mxUtils.write(resolveActionLnk, comment.isResolved ? mxResources.get('reopen') : mxResources.get('resolve'));
                    var actionsDisplay = comment.isResolved ? 'none' : '';
                    var replies = collectReplies(comment).replies;
                    var color = (uiTheme == 'dark') ? 'transparent' : (comment.isResolved ? 'ghostWhite' : 'white');

                    for (var i = 0; i < replies.length; i++) {
                        replies[i].style.backgroundColor = color;

                        var forOpenActions = replies[i].querySelectorAll('.geCommentAction');

                        for (var j = 0; j < forOpenActions.length; j++) {
                            if (forOpenActions[j] == resolveActionLnk.parentNode) continue;

                            forOpenActions[j].style.display = actionsDisplay;
                        }

                        if (!resolvedChecked) {
                            replies[i].style.display = 'none';
                        }
                    }

                    updateNoComments();
                };

                if (comment.isResolved) {
                    addReply(mxResources.get('reOpened') + ': ', true, doToggle, false, true);
                } else {
                    addReply(mxResources.get('markedAsResolved'), false, doToggle, true);
                }
            };

            addAction(comment.isResolved ? mxResources.get('reopen') : mxResources.get('resolve'), toggleResolve);
        }

        cdiv.appendChild(actionsDiv);

        if (parent != null) {
            listDiv.insertBefore(cdiv, parent.nextSibling);
        } else {
            listDiv.appendChild(cdiv);
        }

        for (var i = 0; comment.replies != null && i < comment.replies.length; i++) {
            var reply = comment.replies[i];
            reply.isResolved = comment.isResolved; //copy isResolved to child comments (replies)
            addComment(reply, comment.replies, null, level + 1, showResolved);
        }

        if (curEdited != null) {
            if (curEdited.comment.id == comment.id) {
                var origContent = comment.content;
                comment.content = curEdited.comment.content;
                editComment(comment, cdiv, curEdited.saveCallback, curEdited.deleteOnCancel);
                comment.content = origContent;
            } else if (curEdited.comment.id == null && curEdited.comment.pCommentId == comment.id) {
                listDiv.appendChild(curEdited.div);
                editComment(curEdited.comment, curEdited.div, curEdited.saveCallback, curEdited.deleteOnCancel);
            }
        }

        return cdiv;
    };

    if (!readOnly) {
        var addLink = link.cloneNode();
        addLink.innerHTML = '<div class="geSprite geSprite-plus" style="display:inline-block;"></div>';
        addLink.setAttribute('title', mxResources.get('create') + '...');

        mxEvent.addListener(addLink, 'click', function (evt) {
            var newComment = editorUi.newComment('', editorUi.getCurrentUser());
            var newCommentDiv = addComment(newComment, comments, null, 0);

            function doAddComment() {
                editComment(newComment, newCommentDiv, function (newComment) {
                    showBusy(newCommentDiv);

                    editorUi.addComment(newComment, function (id) {
                        newComment.id = id;
                        comments.push(newComment);
                        showDone(newCommentDiv);
                    }, function (err) {
                        showError(newCommentDiv);
                        doAddComment();
                        editorUi.handleError(err, null, null, null,
                            mxUtils.htmlEntities(mxResources.get('objectNotFound')));
                    });
                }, true);
            }

            doAddComment();
            evt.preventDefault();
            mxEvent.consume(evt);
        });

        ldiv.appendChild(addLink);
    }

    var resolvedLink = link.cloneNode();
    resolvedLink.innerHTML = '<img src="' + IMAGE_PATH + '/check.png" style="width: 16px; padding: 2px;">';
    resolvedLink.setAttribute('title', mxResources.get('showResolved'));
    var resolvedChecked = false;

    if (uiTheme == 'dark') {
        resolvedLink.style.filter = 'invert(100%)';
    }

    mxEvent.addListener(resolvedLink, 'click', function (evt) {
        resolvedChecked = !resolvedChecked;

        this.className = resolvedChecked ? 'geButton geCheckedBtn' : 'geButton';
        refresh();

        evt.preventDefault();
        mxEvent.consume(evt);
    });

    ldiv.appendChild(resolvedLink);

    if (editorUi.commentsRefreshNeeded()) {
        var refreshLink = link.cloneNode();
        refreshLink.innerHTML = '<img src="' + IMAGE_PATH + '/update16.png" style="width: 16px; padding: 2px;">';
        refreshLink.setAttribute('title', mxResources.get('refresh'));

        if (uiTheme == 'dark') {
            refreshLink.style.filter = 'invert(100%)';
        }

        mxEvent.addListener(refreshLink, 'click', function (evt) {
            refresh();

            evt.preventDefault();
            mxEvent.consume(evt);
        });

        ldiv.appendChild(refreshLink);
    }

    if (editorUi.commentsSaveNeeded()) {
        var saveLink = link.cloneNode();
        saveLink.innerHTML = '<img src="' + IMAGE_PATH + '/save.png" style="width: 20px; padding: 2px;">';
        saveLink.setAttribute('title', mxResources.get('save'));

        if (uiTheme == 'dark') {
            saveLink.style.filter = 'invert(100%)';
        }

        mxEvent.addListener(saveLink, 'click', function (evt) {
            saveCallback();

            evt.preventDefault();
            mxEvent.consume(evt);
        });

        ldiv.appendChild(saveLink);
    }

    div.appendChild(ldiv);

    var comments = [];

    var refresh = mxUtils.bind(this, function () {
        this.hasError = false;

        if (curEdited != null) {
            curEdited.div = curEdited.div.cloneNode(true);
            var commentEditTxt = curEdited.div.querySelector('.geCommentEditTxtArea');
            var commentEditBtns = curEdited.div.querySelector('.geCommentEditBtns');

            curEdited.comment.content = commentEditTxt.value;
            commentEditTxt.parentNode.removeChild(commentEditTxt);
            commentEditBtns.parentNode.removeChild(commentEditBtns);
        }

        listDiv.innerHTML = '<div style="padding-top:10px;text-align:center;"><img src="' + IMAGE_PATH + '/spin.gif" valign="middle"> ' +
            mxUtils.htmlEntities(mxResources.get('loading')) + '...</div>';

        canReplyToReplies = editorUi.canReplyToReplies();

        if (editorUi.commentsSupported()) {
            editorUi.getComments(function (list) {
                function sortReplies(replies) {
                    if (replies != null) {
                        //Sort replies old to new
                        replies.sort(function (r1, r2) {
                            return new Date(r1.modifiedDate) - new Date(r2.modifiedDate);
                        });

                        for (var i = 0; i < replies.length; i++) {
                            sortReplies(replies[i].replies);
                        }
                    }
                };

                //Sort comments old to new
                list.sort(function (c1, c2) {
                    return new Date(c1.modifiedDate) - new Date(c2.modifiedDate);
                });

                listDiv.innerHTML = '';
                listDiv.appendChild(noComments);
                noComments.style.display = 'block';
                comments = list;

                for (var i = 0; i < comments.length; i++) {
                    sortReplies(comments[i].replies);
                    addComment(comments[i], comments, null, 0, resolvedChecked);
                }

                //New comment case
                if (curEdited != null && curEdited.comment.id == null && curEdited.comment.pCommentId == null) {
                    listDiv.appendChild(curEdited.div);
                    editComment(curEdited.comment, curEdited.div, curEdited.saveCallback, curEdited.deleteOnCancel);
                }

            }, mxUtils.bind(this, function (err) {
                listDiv.innerHTML = mxUtils.htmlEntities(mxResources.get('error') + (err && err.message ? ': ' + err.message : ''));
                this.hasError = true;
            }));
        } else {
            //TODO if comments are not supported, close the dialog
            listDiv.innerHTML = mxUtils.htmlEntities(mxResources.get('error'));
        }
    });

    refresh();

    this.refreshComments = refresh;

    //Refresh the modified date of each comment if the window is visible
    var refreshCommentsTime = mxUtils.bind(this, function () {
        if (!this.window.isVisible()) return; //only update if it is visible

        var modDateDivs = listDiv.querySelectorAll('.geCommentDate');
        var modDateDivsMap = {};

        for (var i = 0; i < modDateDivs.length; i++) {
            var div = modDateDivs[i];
            modDateDivsMap[div.getAttribute('data-commentId')] = div;
        }

        function processComment(comment) {
            var div = modDateDivsMap[comment.id];

            if (div == null) return; //resolved comments

            writeCommentDate(comment, div);

            for (var i = 0; comment.replies != null && i < comment.replies.length; i++) {
                processComment(comment.replies[i]);
            }
        };

        for (var i = 0; i < comments.length; i++) {
            processComment(comments[i]);
        }
    });

    //Periodically refresh time every one minute
    setInterval(refreshCommentsTime, 60000);
    this.refreshCommentsTime = refreshCommentsTime;

    this.window = new mxWindow(mxResources.get('comments'), div, x, y, w, h, true, true);
    this.window.minimumSize = new mxRectangle(0, 0, 300, 200);
    this.window.destroyOnClose = false;
    this.window.setMaximizable(false);
    this.window.setResizable(true);
    this.window.setClosable(true);
    this.window.setVisible(true);

    this.window.addListener(mxEvent.SHOW, mxUtils.bind(this, function () {
        this.window.fit();
    }));

    this.window.setLocation = function (x, y) {
        var iw = window.innerWidth || document.body.clientWidth || document.documentElement.clientWidth;
        var ih = window.innerHeight || document.body.clientHeight || document.documentElement.clientHeight;

        x = Math.max(0, Math.min(x, iw - this.table.clientWidth));
        y = Math.max(0, Math.min(y, ih - this.table.clientHeight - 48));

        if (this.getX() != x || this.getY() != y) {
            mxWindow.prototype.setLocation.apply(this, arguments);
        }
    };

    var resizeListener = mxUtils.bind(this, function () {
        var x = this.window.getX();
        var y = this.window.getY();

        this.window.setLocation(x, y);
    });

    mxEvent.addListener(window, 'resize', resizeListener);

    this.destroy = function () {
        mxEvent.removeListener(window, 'resize', resizeListener);
        this.window.destroy();
    }
};

/**
 *
 */
var ConfirmDialog = function (editorUi, message, okFn, cancelFn, okLabel, cancelLabel, okImg, cancelImg, showRememberOption, imgSrc) {
    var div = document.createElement('div');
    div.style.textAlign = 'center';

    var p2 = document.createElement('div');
    p2.style.padding = '6px';
    p2.style.overflow = 'auto';
    p2.style.maxHeight = '44px';
    p2.style.lineHeight = '1.2em';

    if (mxClient.IS_QUIRKS) {
        p2.style.height = '60px';
    }

    mxUtils.write(p2, message);
    div.appendChild(p2);

    if (imgSrc != null) {
        var p3 = document.createElement('div');
        p3.style.padding = '6px 0 6px 0';
        var img = document.createElement('img');
        img.setAttribute('src', imgSrc);
        p3.appendChild(img);
        div.appendChild(p3);
    }

    var btns = document.createElement('div');
    btns.style.textAlign = 'center';
    btns.style.whiteSpace = 'nowrap';

    var cb = document.createElement('input');
    cb.setAttribute('type', 'checkbox');

    var cancelBtn = mxUtils.button(cancelLabel || mxResources.get('cancel'), function () {
        editorUi.hideDialog();

        if (cancelFn != null) {
            cancelFn(cb.checked);
        }
    });
    cancelBtn.className = 'geBtn';

    if (cancelImg != null) {
        cancelBtn.innerHTML = cancelImg + '<br>' + cancelBtn.innerHTML;
        cancelBtn.style.paddingBottom = '8px';
        cancelBtn.style.paddingTop = '8px';
        cancelBtn.style.height = 'auto';
        cancelBtn.style.width = '40%';
    }

    if (editorUi.editor.cancelFirst) {
        btns.appendChild(cancelBtn);
    }

    var okBtn = mxUtils.button(okLabel || mxResources.get('ok'), function () {
        editorUi.hideDialog();

        if (okFn != null) {
            okFn(cb.checked);
        }
    });
    btns.appendChild(okBtn);

    if (okImg != null) {
        okBtn.innerHTML = okImg + '<br>' + okBtn.innerHTML + '<br>';
        okBtn.style.paddingBottom = '8px';
        okBtn.style.paddingTop = '8px';
        okBtn.style.height = 'auto';
        okBtn.className = 'geBtn';
        okBtn.style.width = '40%';
    } else {
        okBtn.className = 'geBtn gePrimaryBtn';
    }

    if (!editorUi.editor.cancelFirst) {
        btns.appendChild(cancelBtn);
    }

    div.appendChild(btns);

    if (showRememberOption) {
        btns.style.marginTop = '10px';
        var p2 = document.createElement('p');
        p2.style.marginTop = '20px';
        p2.appendChild(cb);
        var span = document.createElement('span');
        mxUtils.write(span, ' ' + mxResources.get('rememberThisSetting'));
        p2.appendChild(span);
        div.appendChild(p2);

        mxEvent.addListener(span, 'click', function (evt) {
            cb.checked = !cb.checked;
            mxEvent.consume(evt);
        });
    } else {
        btns.style.marginTop = '12px';
    }

    this.init = function () {
        okBtn.focus();
    };

    this.container = div;
};

/**
 * Copyright (c) 2006-2017, JGraph Ltd
 * Copyright (c) 2006-2017, Gaudenz Alder
 */
/**
 * Removes all labels, user objects and styles from the given node in-place.
 */
EditorUi.DIFF_INSERT = 'i';

/**
 * Removes all labels, user objects and styles from the given node in-place.
 */
EditorUi.DIFF_REMOVE = 'r';

/**
 * Removes all labels, user objects and styles from the given node in-place.
 */
EditorUi.DIFF_UPDATE = 'u';

/**
 * Shared codec.
 */
EditorUi.prototype.codec = new mxCodec();

/**
 * Contains all view state properties that should not be ignored in diff sync.
 */
EditorUi.prototype.viewStateProperties = {
    background: true, backgroundImage: true, shadowVisible: true,
    foldingEnabled: true, pageScale: true, mathEnabled: true, pageFormat: true
};

/**
 * Contains all known cell properties that should be ignored for a generic cell diff.
 */
EditorUi.prototype.cellProperties = {
    id: true, value: true, xmlValue: true, vertex: true, edge: true,
    visible: true, collapsed: true, connectable: true, parent: true, children: true, previous: true,
    source: true, target: true, edges: true, geometry: true, style: true,
    mxObjectId: true, mxTransient: true
};

/**
 * Removes all labels, user objects and styles from the given node in-place.
 */
EditorUi.prototype.patchPages = function (pages, diff, markPages, resolver, updateEdgeParents) {
    var resolverLookup = {};
    var newPages = [];
    var inserted = {};
    var removed = {};
    var lookup = {};
    var moved = {};

    if (resolver != null && resolver[EditorUi.DIFF_UPDATE] != null) {
        for (var id in resolver[EditorUi.DIFF_UPDATE]) {
            resolverLookup[id] = resolver[EditorUi.DIFF_UPDATE][id];
        }
    }

    if (diff[EditorUi.DIFF_REMOVE] != null) {
        for (var i = 0; i < diff[EditorUi.DIFF_REMOVE].length; i++) {
            removed[diff[EditorUi.DIFF_REMOVE][i]] = true;
        }
    }

    if (diff[EditorUi.DIFF_INSERT] != null) {
        for (var i = 0; i < diff[EditorUi.DIFF_INSERT].length; i++) {
            inserted[diff[EditorUi.DIFF_INSERT][i].previous] = diff[EditorUi.DIFF_INSERT][i];
        }
    }

    if (diff[EditorUi.DIFF_UPDATE] != null) {
        for (var id in diff[EditorUi.DIFF_UPDATE]) {
            var pageDiff = diff[EditorUi.DIFF_UPDATE][id];

            if (pageDiff.previous != null) {
                moved[pageDiff.previous] = id;
            }
        }
    }

    // Restores existing order and creates lookup
    if (pages != null) {
        var prev = '';

        for (var i = 0; i < pages.length; i++) {
            var pageId = pages[i].getId();
            lookup[pageId] = pages[i];

            if (moved[prev] == null && !removed[pageId] &&
                (diff[EditorUi.DIFF_UPDATE] == null ||
                    diff[EditorUi.DIFF_UPDATE][pageId] == null ||
                    diff[EditorUi.DIFF_UPDATE][pageId].previous == null)) {
                moved[prev] = pageId;
            }

            prev = pageId;
        }
    }

    // FIXME: Workaround for possible duplicate pages
    var added = {};

    var addPage = mxUtils.bind(this, function (page) {
        var id = (page != null) ? page.getId() : '';

        if (page != null && !added[id]) {
            added[id] = true;
            newPages.push(page);
            var pageDiff = (diff[EditorUi.DIFF_UPDATE] != null) ?
                diff[EditorUi.DIFF_UPDATE][id] : null;

            if (pageDiff != null) {
                this.updatePageRoot(page);

                if (pageDiff.name != null) {
                    page.setName(pageDiff.name);
                }

                if (pageDiff.view != null) {
                    this.patchViewState(page, pageDiff.view);
                }

                if (pageDiff.cells != null) {
                    this.patchPage(page, pageDiff.cells,
                        resolverLookup[page.getId()],
                        updateEdgeParents);
                }

                if (markPages && (pageDiff.cells != null ||
                    pageDiff.view != null)) {
                    page.needsUpdate = true;
                }
            }
        }

        var mov = moved[id];

        if (mov != null) {
            delete moved[id];
            addPage(lookup[mov]);
        }

        var ins = inserted[id];

        if (ins != null) {
            delete inserted[id];
            insertPage(ins);
        }
    });

    var insertPage = mxUtils.bind(this, function (ins) {
        var diagram = mxUtils.parseXml(ins.data).documentElement;
        var newPage = new DiagramPage(diagram);
        this.updatePageRoot(newPage);
        var page = lookup[newPage.getId()];

        if (page == null) {
            addPage(newPage);
        } else {
            // Updates root if page already in UI
            page.root = newPage.root;

            if (this.currentPage == page) {
                this.editor.graph.model.setRoot(page.root);
            } else if (markPages) {
                page.needsUpdate = true;
            }
        }
    });

    addPage();

    // Handles orphaned moved pages
    for (var id in moved) {
        addPage(lookup[moved[id]]);
        delete moved[id];
    }

    // Handles orphaned inserted pages
    for (var id in inserted) {
        insertPage(inserted[id]);
        delete inserted[id];
    }

    return newPages;
};

/**
 * Removes all labels, user objects and styles from the given node in-place.
 */
EditorUi.prototype.patchViewState = function (page, diff) {
    if (page.viewState != null && diff != null) {
        if (page == this.currentPage) {
            page.viewState = this.editor.graph.getViewState();
        }

        for (var key in diff) {
            page.viewState[key] = JSON.parse(diff[key]);
        }

        if (page == this.currentPage) {
            this.editor.graph.setViewState(page.viewState);
        }
    }
};

/**
 * Removes all labels, user objects and styles from the given node in-place.
 */
EditorUi.prototype.createParentLookup = function (model, diff) {
    var parentLookup = {};

    function getLookup(id) {
        var result = parentLookup[id];

        if (result == null) {
            result = {inserted: [], moved: {}};
            parentLookup[id] = result;
        }

        return result;
    };

    if (diff[EditorUi.DIFF_INSERT] != null) {
        for (var i = 0; i < diff[EditorUi.DIFF_INSERT].length; i++) {
            var temp = diff[EditorUi.DIFF_INSERT][i];
            var par = (temp.parent != null) ? temp.parent : '';
            var prev = (temp.previous != null) ? temp.previous : '';
            getLookup(par).inserted[prev] = temp;
        }
    }

    if (diff[EditorUi.DIFF_UPDATE] != null) {
        for (var id in diff[EditorUi.DIFF_UPDATE]) {
            var temp = diff[EditorUi.DIFF_UPDATE][id];

            if (temp.previous != null) {
                var par = temp.parent;

                if (par == null) {
                    var cell = model.getCell(id);

                    if (cell != null) {
                        var parent = model.getParent(cell);

                        if (parent != null) {
                            par = parent.getId();
                        }
                    }
                }

                if (par != null) {
                    getLookup(par).moved[temp.previous] = id;
                }
            }
        }
    }

    return parentLookup;
};

/**
 * Removes all labels, user objects and styles from the given node in-place.
 */
EditorUi.prototype.patchPage = function (page, diff, resolver, updateEdgeParents) {
    var model = (page == this.currentPage) ? this.editor.graph.model : new mxGraphModel(page.root);
    var parentLookup = this.createParentLookup(model, diff);

    model.beginUpdate();
    try {
        // Disables or delays update of edge parents to after patch
        var prev = model.updateEdgeParent;
        var dict = new mxDictionary();
        var pendingUpdates = [];

        model.updateEdgeParent = function (edge, root) {
            if (!dict.get(edge) && updateEdgeParents) {
                dict.put(edge, true);
                pendingUpdates.push(edge);
            }
        };

        // Handles new root cells
        var temp = parentLookup[''];
        var cellDiff = (temp != null && temp.inserted != null) ? temp.inserted[''] : null;
        var root = null;

        if (cellDiff != null) {
            root = this.getCellForJson(cellDiff);
        }

        // Handles cells becoming root (very unlikely but possible)
        if (root == null) {
            var id = (temp != null && temp.moved != null) ? temp.moved[''] : null;

            if (id != null) {
                root = model.getCell(id);
            }
        }

        if (root != null) {
            model.setRoot(root);
            page.root = root;
        }

        // Inserts and updates previous and parent (hierarchy update)
        this.patchCellRecursive(page, model, model.root, parentLookup, diff);

        // Removes cells after parents have been updated above
        if (diff[EditorUi.DIFF_REMOVE] != null) {
            for (var i = 0; i < diff[EditorUi.DIFF_REMOVE].length; i++) {
                var cell = model.getCell(diff[EditorUi.DIFF_REMOVE][i]);

                if (cell != null) {
                    model.remove(cell);
                }
            }
        }

        // Updates cell states and terminals
        if (diff[EditorUi.DIFF_UPDATE] != null) {
            var res = (resolver != null && resolver.cells != null) ?
                resolver.cells[EditorUi.DIFF_UPDATE] : null;

            for (var id in diff[EditorUi.DIFF_UPDATE]) {
                this.patchCell(model, model.getCell(id),
                    diff[EditorUi.DIFF_UPDATE][id],
                    (res != null) ? res[id] : null);
            }
        }

        // Updates terminals for inserted cells
        if (diff[EditorUi.DIFF_INSERT] != null) {
            for (var i = 0; i < diff[EditorUi.DIFF_INSERT].length; i++) {
                var cellDiff = diff[EditorUi.DIFF_INSERT][i];
                var cell = model.getCell(cellDiff.id);

                if (cell != null) {
                    model.setTerminal(cell, model.getCell(cellDiff.source), true);
                    model.setTerminal(cell, model.getCell(cellDiff.target), false);
                }
            }
        }

        // Delayed update of edge parents
        model.updateEdgeParent = prev;

        if (updateEdgeParents && pendingUpdates.length > 0) {
            for (var i = 0; i < pendingUpdates.length; i++) {
                if (model.contains(pendingUpdates[i])) {
                    model.updateEdgeParent(pendingUpdates[i]);
                }
            }
        }
    } finally {
        model.endUpdate();
    }
};

/**
 * Removes all labels, user objects and styles from the given node in-place.
 */
EditorUi.prototype.patchCellRecursive = function (page, model, cell, parentLookup, diff) {
    if (cell != null) {
        var temp = parentLookup[cell.getId()];
        var inserted = (temp != null && temp.inserted != null) ? temp.inserted : {};
        var moved = (temp != null && temp.moved != null) ? temp.moved : {};
        var index = 0;

        // Restores existing order
        var childCount = model.getChildCount(cell);
        var prev = '';

        for (var i = 0; i < childCount; i++) {
            var cellId = model.getChildAt(cell, i).getId();

            if (moved[prev] == null &&
                (diff[EditorUi.DIFF_UPDATE] == null ||
                    diff[EditorUi.DIFF_UPDATE][cellId] == null ||
                    (diff[EditorUi.DIFF_UPDATE][cellId].previous == null &&
                        diff[EditorUi.DIFF_UPDATE][cellId].parent == null))) {
                moved[prev] = cellId;
            }

            prev = cellId;
        }

        var addCell = mxUtils.bind(this, function (child, insert) {
            var id = (child != null) ? child.getId() : '';

            // Ignores the insert if the cell is already in the model
            if (child != null && insert) {
                var ex = model.getCell(id);

                if (ex != null && ex != child) {
                    child = null;
                }
            }

            if (child != null) {
                if (model.getChildAt(cell, index) != child) {
                    model.add(cell, child, index);
                }

                this.patchCellRecursive(page, model,
                    child, parentLookup, diff);
                index++;
            }

            return id;
        });

        // Uses stack to avoid recursion for children
        var children = [null];

        while (children.length > 0) {
            var entry = children.shift();
            var child = (entry != null) ? entry.child : null;
            var insert = (entry != null) ? entry.insert : false;
            var id = addCell(child, insert);

            // Move and insert are mutually exclusive per predecessor
            // since an insert changes the predecessor of existing cells
            // and is therefore ignored in the loop above where the order
            // for existing cells is added to the moved object
            var mov = moved[id];

            if (mov != null) {
                delete moved[id];
                children.push({child: model.getCell(mov)});
            }

            var ins = inserted[id];

            if (ins != null) {
                delete inserted[id];
                children.push({child: this.getCellForJson(ins), insert: true});
            }

            // Orphaned moves and inserts are operations where the previous cell vanished
            // in the local model so their position in the child array cannot be determined.
            // In this case those cells are appended. Dependencies between orphans are
            // maintained because for-in loops enumerate the IDs in order of insertion.
            if (children.length == 0) {
                // Handles orphaned moved pages
                for (var id in moved) {
                    children.push({child: model.getCell(moved[id])});
                    delete moved[id];
                }

                // Handles orphaned inserted pages
                for (var id in inserted) {
                    children.push({child: this.getCellForJson(inserted[id]), insert: true});
                    delete inserted[id];
                }
            }
        }
    }
};

/**
 * Removes all labels, user objects and styles from the given node in-place.
 */
EditorUi.prototype.patchCell = function (model, cell, diff, resolve) {
    if (cell != null && diff != null) {
        // Last write wins for value except if label is empty
        if (resolve == null || (resolve.xmlValue == null &&
            (resolve.value == null || resolve.value == ''))) {
            if ('value' in diff) {
                model.setValue(cell, diff.value);
            } else if (diff.xmlValue != null) {
                model.setValue(cell, mxUtils.parseXml(diff.xmlValue).documentElement);
            }
        }

        // Last write wins for style
        if ((resolve == null || resolve.style == null) && diff.style != null) {
            model.setStyle(cell, diff.style);
        }

        if (diff.visible != null) {
            model.setVisible(cell, diff.visible == 1);
        }

        if (diff.collapsed != null) {
            model.setCollapsed(cell, diff.collapsed == 1);
        }

        if (diff.vertex != null) {
            // Changes vertex state in-place
            cell.vertex = diff.vertex == 1;
        }

        if (diff.edge != null) {
            // Changes edge state in-place
            cell.edge = diff.edge == 1;
        }

        if (diff.connectable != null) {
            // Changes connectable state in-place
            cell.connectable = diff.connectable == 1;
        }

        if (diff.geometry != null) {
            model.setGeometry(cell, this.codec.decode(mxUtils.parseXml(
                diff.geometry).documentElement));
        }

        if (diff.source != null) {
            model.setTerminal(cell, model.getCell(diff.source), true);
        }

        if (diff.target != null) {
            model.setTerminal(cell, model.getCell(diff.target), false);
        }

        for (var key in diff) {
            if (!this.cellProperties[key]) {
                cell[key] = diff[key];
            }
        }
    }
};

/**
 * Gets a file node that is comparable with a remote file node
 * so that using isEqualNode returns true if the files can be
 * considered equal.
 */
EditorUi.prototype.getPagesForNode = function (node, nodeName) {
    var tmp = this.editor.extractGraphModel(node, true);

    if (tmp != null) {
        node = tmp;
    }

    var diagrams = node.getElementsByTagName(nodeName || 'diagram');
    var pages = [];

    if (diagrams.length > 0) {
        for (var i = 0; i < diagrams.length; i++) {
            var page = new DiagramPage(diagrams[i]);
            this.updatePageRoot(page);
            pages.push(page);
        }
    } else if (node.nodeName == 'mxGraphModel') {
        var graph = this.editor.graph;
        var page = new DiagramPage(node.ownerDocument.createElement('diagram'));
        page.setName(mxResources.get('pageWithNumber', [1]));
        mxUtils.setTextContent(page.node, Graph.compressNode(node));
        pages.push(page);
    }

    return pages;
};

/**
 * Removes all labels, user objects and styles from the given node in-place.
 */
EditorUi.prototype.diffPages = function (oldPages, newPages) {
    var graph = this.editor.graph;
    var inserted = [];
    var removed = [];
    var result = {};
    var lookup = {};
    var diff = {};
    var prev = null;

    for (var i = 0; i < newPages.length; i++) {
        lookup[newPages[i].getId()] = {page: newPages[i], prev: prev};
        prev = newPages[i];
    }

    prev = null;

    for (var i = 0; i < oldPages.length; i++) {
        var id = oldPages[i].getId();
        var newPage = lookup[id];

        if (newPage == null) {
            removed.push(id);
        } else {
            var temp = this.diffPage(oldPages[i], newPage.page);
            var pageDiff = {};

            if (Object.keys(temp).length > 0) {
                pageDiff.cells = temp;
            }

            var view = this.diffViewState(oldPages[i], newPage.page);

            if (Object.keys(view).length > 0) {
                pageDiff.view = view;
            }

            if (((newPage.prev != null) ? prev == null : prev != null) ||
                (prev != null && newPage.prev != null &&
                    prev.getId() != newPage.prev.getId())) {
                pageDiff.previous = (newPage.prev != null) ? newPage.prev.getId() : '';
            }

            // FIXME: Check why names can be null in newer files
            // ignore in hash and do not diff null names for now
            if (newPage.page.getName() != null &&
                oldPages[i].getName() != newPage.page.getName()) {
                pageDiff.name = newPage.page.getName();
            }

            if (Object.keys(pageDiff).length > 0) {
                diff[id] = pageDiff;
            }
        }

        delete lookup[oldPages[i].getId()];
        prev = oldPages[i];
    }

    for (var id in lookup) {
        var newPage = lookup[id];
        inserted.push({
            data: mxUtils.getXml(newPage.page.node),
            previous: (newPage.prev != null) ?
                newPage.prev.getId() : ''
        });
    }

    if (Object.keys(diff).length > 0) {
        result[EditorUi.DIFF_UPDATE] = diff;
    }

    if (removed.length > 0) {
        result[EditorUi.DIFF_REMOVE] = removed;
    }

    if (inserted.length > 0) {
        result[EditorUi.DIFF_INSERT] = inserted;
    }

    return result;
};

/**
 * Removes all labels, user objects and styles from the given node in-place.
 */
EditorUi.prototype.createCellLookup = function (cell, prev, lookup) {
    lookup = (lookup != null) ? lookup : {};
    lookup[cell.getId()] = {cell: cell, prev: prev};

    var childCount = cell.getChildCount();
    prev = null;

    for (var i = 0; i < childCount; i++) {
        var child = cell.getChildAt(i);
        this.createCellLookup(child, prev, lookup);
        prev = child;
    }

    return lookup;
};

/**
 * Removes all labels, user objects and styles from the given node in-place.
 */
EditorUi.prototype.diffCellRecursive = function (cell, prev, lookup, diff, removed) {
    diff = (diff != null) ? diff : {};
    var newCell = lookup[cell.getId()];
    delete lookup[cell.getId()];

    if (newCell == null) {
        removed.push(cell.getId());
    } else {
        var temp = this.diffCell(cell, newCell.cell);

        if (temp.parent != null ||
            (((newCell.prev != null) ? prev == null : prev != null) ||
                (prev != null && newCell.prev != null &&
                    prev.getId() != newCell.prev.getId()))) {
            temp.previous = (newCell.prev != null) ? newCell.prev.getId() : '';
        }

        if (Object.keys(temp).length > 0) {
            diff[cell.getId()] = temp;
        }
    }

    var childCount = cell.getChildCount();
    prev = null;

    for (var i = 0; i < childCount; i++) {
        var child = cell.getChildAt(i);
        this.diffCellRecursive(child, prev, lookup, diff, removed);
        prev = child;
    }

    return diff;
};

/**
 * Removes all labels, user objects and styles from the given node in-place.
 */
EditorUi.prototype.diffPage = function (oldPage, newPage) {
    var inserted = [];
    var removed = [];
    var result = {};

    this.updatePageRoot(oldPage);
    this.updatePageRoot(newPage);

    var lookup = this.createCellLookup(newPage.root);
    var diff = this.diffCellRecursive(oldPage.root, null, lookup, diff, removed);

    for (var id in lookup) {
        var newCell = lookup[id];
        inserted.push(this.getJsonForCell(newCell.cell, newCell.prev));
    }

    if (Object.keys(diff).length > 0) {
        result[EditorUi.DIFF_UPDATE] = diff;
    }

    if (removed.length > 0) {
        result[EditorUi.DIFF_REMOVE] = removed;
    }

    if (inserted.length > 0) {
        result[EditorUi.DIFF_INSERT] = inserted;
    }

    return result;
};

/**
 * Removes all labels, user objects and styles from the given node in-place.
 */
EditorUi.prototype.diffViewState = function (oldPage, newPage) {
    var source = oldPage.viewState;
    var target = newPage.viewState;
    var result = {};

    if (newPage == this.currentPage) {
        target = this.editor.graph.getViewState();
    }

    if (source != null && target != null) {
        for (var key in this.viewStateProperties) {
            // LATER: Check if normalization is needed for
            // object attribute order to compare JSON
            var old = JSON.stringify(source[key]);
            var now = JSON.stringify(target[key]);

            if (old != now) {
                result[key] = now;
            }
        }
    }

    return result;
};

/**
 * Removes all labels, user objects and styles from the given node in-place.
 */
EditorUi.prototype.getCellForJson = function (json) {
    var geometry = (json.geometry != null) ? this.codec.decode(
        mxUtils.parseXml(json.geometry).documentElement) : null;
    var value = json.value;

    if (json.xmlValue != null) {
        value = mxUtils.parseXml(json.xmlValue).documentElement;
    }

    var cell = new mxCell(value, geometry, json.style);
    cell.connectable = json.connectable != 0;
    cell.collapsed = json.collapsed == 1;
    cell.visible = json.visible != 0;
    cell.vertex = json.vertex == 1;
    cell.edge = json.edge == 1;
    cell.id = json.id;

    for (var key in json) {
        if (!this.cellProperties[key]) {
            cell[key] = json[key];
        }
    }

    return cell;
};

/**
 * Removes all labels, user objects and styles from the given node in-place.
 */
EditorUi.prototype.getJsonForCell = function (cell, previous) {
    var result = {id: cell.getId()};

    if (cell.vertex) {
        result.vertex = 1;
    }

    if (cell.edge) {
        result.edge = 1;
    }

    if (!cell.connectable) {
        result.connectable = 0;
    }

    if (cell.parent != null) {
        result.parent = cell.parent.getId();
    }

    if (previous != null) {
        result.previous = previous.getId();
    }

    if (cell.source != null) {
        result.source = cell.source.getId();
    }

    if (cell.target != null) {
        result.target = cell.target.getId();
    }

    if (cell.style != null) {
        result.style = cell.style;
    }

    if (cell.geometry != null) {
        result.geometry = mxUtils.getXml(this.codec.encode(cell.geometry));
    }

    if (cell.collapsed) {
        result.collapsed = 1;
    }

    if (!cell.visible) {
        result.visible = 0;
    }

    if (cell.value != null) {
        if (typeof cell.value === 'object' && typeof cell.value.nodeType === 'number' &&
            typeof cell.value.nodeName === 'string' && typeof cell.value.getAttribute === 'function') {
            result.xmlValue = mxUtils.getXml(cell.value);
        } else {
            result.value = cell.value;
        }
    }

    for (var key in cell) {
        if (!this.cellProperties[key] &&
            typeof cell[key] !== 'function') {
            result[key] = cell[key];
        }
    }

    return result;
};

/**
 * Removes all labels, user objects and styles from the given node in-place.
 */
EditorUi.prototype.diffCell = function (oldCell, newCell) {
    var diff = {};

    if (oldCell.vertex != newCell.vertex) {
        diff.vertex = (newCell.vertex) ? 1 : 0;
    }

    if (oldCell.edge != newCell.edge) {
        diff.edge = (newCell.edge) ? 1 : 0;
    }

    if (oldCell.connectable != newCell.connectable) {
        diff.connectable = (newCell.connectable) ? 1 : 0;
    }

    if (((oldCell.parent != null) ? newCell.parent == null : newCell.parent != null) ||
        (oldCell.parent != null && newCell.parent != null &&
            oldCell.parent.getId() != newCell.parent.getId())) {
        diff.parent = (newCell.parent != null) ? newCell.parent.getId() : '';
    }

    if (((oldCell.source != null) ? newCell.source == null : newCell.source != null) ||
        (oldCell.source != null && newCell.source != null &&
            oldCell.source.getId() != newCell.source.getId())) {
        diff.source = (newCell.source != null) ? newCell.source.getId() : '';
    }

    if (((oldCell.target != null) ? newCell.target == null : newCell.target != null) ||
        (oldCell.target != null && newCell.target != null &&
            oldCell.target.getId() != newCell.target.getId())) {
        diff.target = (newCell.target != null) ? newCell.target.getId() : '';
    }

    function isNode(value) {
        return value != null && typeof value === 'object' && typeof value.nodeType === 'number' &&
            typeof value.nodeName === 'string' && typeof value.getAttribute === 'function';
    };

    if (isNode(oldCell.value) && isNode(newCell.value)) {
        if (!oldCell.value.isEqualNode(newCell.value)) {
            diff.xmlValue = mxUtils.getXml(newCell.value);
        }
    } else if (oldCell.value != newCell.value) {
        if (isNode(newCell.value)) {
            diff.xmlValue = mxUtils.getXml(newCell.value);
        } else {
            diff.value = (newCell.value != null) ? newCell.value : null;
        }
    }

    if (oldCell.style != newCell.style) {
        // LATER: Split into keys and do fine-grained diff
        diff.style = newCell.style;
    }

    if (oldCell.visible != newCell.visible) {
        diff.visible = (newCell.visible) ? 1 : 0;
    }

    if (oldCell.collapsed != newCell.collapsed) {
        diff.collapsed = (newCell.collapsed) ? 1 : 0;
    }

    // FIXME: Proto only needed because source.geometry has no constructor (wrong type?)
    if (!this.isObjectEqual(oldCell.geometry, newCell.geometry, new mxGeometry())) {
        var node = this.codec.encode(newCell.geometry);

        if (node != null) {
            diff.geometry = mxUtils.getXml(node);
        }
    }

    // Compares all keys from oldCell to newCell and uses null in the diff
    // to force the attribute to be removed in the receiving client
    for (var key in oldCell) {
        if (!this.cellProperties[key] && typeof oldCell[key] !== 'function' &&
            typeof newCell[key] !== 'function' && oldCell[key] != newCell[key]) {
            diff[key] = (newCell[key] === undefined) ? null : newCell[key];
        }
    }

    // Compares the remaining keys in newCell with oldCell
    for (var key in newCell) {
        if (!(key in oldCell) &&
            !this.cellProperties[key] && typeof oldCell[key] !== 'function' &&
            typeof newCell[key] !== 'function' && oldCell[key] != newCell[key]) {
            diff[key] = (newCell[key] === undefined) ? null : newCell[key];
        }
    }

    return diff;
};

/**
 *
 */
EditorUi.prototype.isObjectEqual = function (source, target, proto) {
    if (source == null && target == null) {
        return true;
    } else if ((source != null) ? target == null : target != null) {
        return false;
    } else {
        var replacer = function (key, value) {
            return (proto == null || proto[key] != value) ? ((value === true) ? 1 : value) : undefined;
        };

        //console.log('eq', JSON.stringify(source, replacer), JSON.stringify(target, replacer));

        return JSON.stringify(source, replacer) == JSON.stringify(target, replacer);
    }
};

/**
 * Copyright (c) 2006-2017, JGraph Ltd
 * Copyright (c) 2006-2017, Gaudenz Alder
 */
/**
 * Contains current settings.
 */
var mxSettings =
    {
        /**
         * Defines current version of settings.
         */
        currentVersion: 18,

        defaultFormatWidth: (screen.width < 600) ? '0' : '240',

        // NOTE: Hardcoded in index.html due to timing of JS loading
        key: '.drawio-config',

        getLanguage: function () {
            return mxSettings.settings.language;
        },
        setLanguage: function (lang) {
            mxSettings.settings.language = lang;
        },
        getUi: function () {
            return mxSettings.settings.ui;
        },
        setUi: function (ui) {
            mxSettings.settings.ui = ui;
        },
        getShowStartScreen: function () {
            return true;
        },
        setShowStartScreen: function (showStartScreen) {
            mxSettings.settings.showStartScreen = showStartScreen;
        },
        getGridColor: function () {
            return mxSettings.settings.gridColor;
        },
        setGridColor: function (gridColor) {
            mxSettings.settings.gridColor = gridColor;
        },
        getAutosave: function () {
            return mxSettings.settings.autosave;
        },
        setAutosave: function (autosave) {
            mxSettings.settings.autosave = autosave;
        },
        getResizeImages: function () {
            return mxSettings.settings.resizeImages;
        },
        setResizeImages: function (resizeImages) {
            mxSettings.settings.resizeImages = resizeImages;
        },
        getOpenCounter: function () {
            return mxSettings.settings.openCounter;
        },
        setOpenCounter: function (openCounter) {
            mxSettings.settings.openCounter = openCounter;
        },
        setCustomFonts: function (fonts) {
            mxSettings.settings.customFonts = fonts;
        },
        getCustomFonts: function (fonts) {
            return mxSettings.settings.customFonts;
        },
        getLibraries: function () {
            return mxSettings.settings.libraries;
        },
        setLibraries: function (libs) {
            mxSettings.settings.libraries = libs;
        },
        addCustomLibrary: function (id) {
            // Makes sure to update the latest data from the localStorage
            mxSettings.load();

            if (mxUtils.indexOf(mxSettings.settings.customLibraries, id) < 0) {
                // Makes sure scratchpad is below search in sidebar
                if (id === 'L.scratchpad') {
                    mxSettings.settings.customLibraries.splice(0, 0, id);
                } else {
                    mxSettings.settings.customLibraries.push(id);
                }
            }

            mxSettings.save();
        },
        removeCustomLibrary: function (id) {
            // Makes sure to update the latest data from the localStorage
            mxSettings.load();
            mxUtils.remove(id, mxSettings.settings.customLibraries);
            mxSettings.save();
        },
        getCustomLibraries: function () {
            return mxSettings.settings.customLibraries;
        },
        getPlugins: function () {
            return mxSettings.settings.plugins;
        },
        setPlugins: function (plugins) {
            mxSettings.settings.plugins = plugins;
        },
        getRecentColors: function () {
            return mxSettings.settings.recentColors;
        },
        setRecentColors: function (recentColors) {
            mxSettings.settings.recentColors = recentColors;
        },
        getFormatWidth: function () {
            return parseInt(mxSettings.settings.formatWidth);
        },
        setFormatWidth: function (formatWidth) {
            mxSettings.settings.formatWidth = formatWidth;
        },
        isCreateTarget: function () {
            return mxSettings.settings.createTarget;
        },
        setCreateTarget: function (value) {
            mxSettings.settings.createTarget = value;
        },
        getPageFormat: function () {
            return mxSettings.settings.pageFormat;
        },
        setPageFormat: function (value) {
            mxSettings.settings.pageFormat = value;
        },
        getUnit: function () {
            return mxSettings.settings.unit || mxConstants.MILLIMETERS;
        },
        setUnit: function (value) {
            mxSettings.settings.unit = value;
        },
        isRulerOn: function () {
            return mxSettings.settings.isRulerOn;
        },
        setRulerOn: function (value) {
            mxSettings.settings.isRulerOn = value;
        },
        init: function () {
            mxSettings.settings =
                {
                    language: '',
                    configVersion: Editor.configVersion,
                    customFonts: [],
                    libraries: Sidebar.prototype.defaultEntries,
                    customLibraries: Editor.defaultCustomLibraries,
                    plugins: [],
                    recentColors: [],
                    formatWidth: mxSettings.defaultFormatWidth,
                    createTarget: false,
                    pageFormat: mxGraph.prototype.pageFormat,
                    search: true,
                    showStartScreen: true,
                    gridColor: mxGraphView.prototype.gridColor,
                    autosave: true,
                    resizeImages: null,
                    openCounter: 0,
                    version: mxSettings.currentVersion,
                    // Only defined and true for new settings which haven't been saved
                    isNew: true,
                    unit: mxConstants.MILLIMETERS,
                    isRulerOn: true
                };
        },
        save: function () {
            if (isLocalStorage && typeof (JSON) !== 'undefined') {
                try {
                    delete mxSettings.settings.isNew;
                    mxSettings.settings.version = mxSettings.currentVersion;
                    localStorage.setItem(mxSettings.key, JSON.stringify(mxSettings.settings));
                } catch (e) {
                    // ignores quota exceeded
                }
            }
        },
        load: function () {
            if (isLocalStorage && typeof (JSON) !== 'undefined') {
                mxSettings.parse(localStorage.getItem(mxSettings.key));
            }

            if (mxSettings.settings == null) {
                mxSettings.init();
            }
        },
        parse: function (value) {
            if (value != null) {
                var temp = JSON.parse(value);

                if ((Editor.config != null && Editor.config.override) ||
                    temp.configVersion != Editor.configVersion) {
                    mxSettings.settings = null;
                } else {
                    mxSettings.settings = temp;

                    if (mxSettings.settings.plugins == null) {
                        mxSettings.settings.plugins = [];
                    }

                    if (mxSettings.settings.recentColors == null) {
                        mxSettings.settings.recentColors = [];
                    }

                    if (mxSettings.settings.customFonts == null) {
                        mxSettings.settings.customFonts = [];
                    }

                    if (mxSettings.settings.libraries == null) {
                        mxSettings.settings.libraries = Sidebar.prototype.defaultEntries;
                    }

                    if (mxSettings.settings.customLibraries == null) {
                        mxSettings.settings.customLibraries = Editor.defaultCustomLibraries;
                    }

                    if (mxSettings.settings.ui == null) {
                        mxSettings.settings.ui = '';
                    }

                    if (mxSettings.settings.formatWidth == null) {
                        mxSettings.settings.formatWidth = mxSettings.defaultFormatWidth;
                    }

                    if (mxSettings.settings.lastAlert != null) {
                        delete mxSettings.settings.lastAlert;
                    }

                    if (mxSettings.settings.createTarget == null) {
                        mxSettings.settings.createTarget = false;
                    }

                    if (mxSettings.settings.pageFormat == null) {
                        mxSettings.settings.pageFormat = mxGraph.prototype.pageFormat;
                    }

                    if (mxSettings.settings.search == null) {
                        mxSettings.settings.search = true;
                    }

                    if (mxSettings.settings.showStartScreen == null) {
                        mxSettings.settings.showStartScreen = true;
                    }

                    if (mxSettings.settings.gridColor == null) {
                        mxSettings.settings.gridColor = mxGraphView.prototype.gridColor;
                    }

                    if (mxSettings.settings.autosave == null) {
                        mxSettings.settings.autosave = true;
                    }

                    if (mxSettings.settings.scratchpadSeen != null) {
                        delete mxSettings.settings.scratchpadSeen;
                    }
                }
            }
        },
        clear: function () {
            if (isLocalStorage) {
                localStorage.removeItem(mxSettings.key);
            }
        }
    }

/**
 * Variable: mxLoadSettings
 *
 * Optional global config variable to toggle loading the settings. Default is true.
 *
 * (code)
 * <script type="text/javascript">
 *        var mxLoadSettings = false;
 * </script>
 * (end)
 */
if (typeof (mxLoadSettings) == 'undefined' || mxLoadSettings) {
    // Loads initial content
    mxSettings.load();
}

DriveComment = function (file, id, content, modifiedDate, createdDate, isResolved, user, pCommentId) {
    DrawioComment.call(this, file, id, content, modifiedDate, createdDate, isResolved, user);
    this.pCommentId = pCommentId; //a reply
};

DriveComment.prototype.addReply = function (reply, success, error, doResolve, doReopen) {
    var body = {'content': reply.content};

    if (doResolve) {
        body.verb = 'resolve';
    } else if (doReopen) {
        body.verb = 'reopen';
    }

    this.file.ui.drive.executeRequest(gapi.client.drive.replies.insert(
        {
            'fileId': this.file.getId(),
            'commentId': this.id,
            'resource': body
        }),
        mxUtils.bind(this, function (resp) {
            success(resp.replyId); //pass comment id
        }), error);
};

DriveComment.prototype.editComment = function (newContent, success, error) {
    this.content = newContent;
    var body = {'content': newContent};

    this.file.ui.drive.executeRequest(
        this.pCommentId ?
            gapi.client.drive.replies.patch({
                'fileId': this.file.getId(),
                'commentId': this.pCommentId,
                'replyId': this.id,
                'resource': body
            }) :
            gapi.client.drive.comments.patch({
                'fileId': this.file.getId(),
                'commentId': this.id,
                'resource': body
            }),
        success, error);
};

DriveComment.prototype.deleteComment = function (success, error) {
    this.file.ui.drive.executeRequest(
        this.pCommentId ?
            gapi.client.drive.replies.delete({
                'fileId': this.file.getId(),
                'commentId': this.pCommentId,
                'replyId': this.id
            }) :
            gapi.client.drive.comments.delete({
                'fileId': this.file.getId(),
                'commentId': this.id
            }),
        success, error);
};

/**
 * Copyright (c) 2006-2017, JGraph Ltd
 * Copyright (c) 2006-2017, Gaudenz Alder
 */
/**
 * Constructs a new point for the optional x and y coordinates. If no
 * coordinates are given, then the default values for <x> and <y> are used.
 * @constructor
 * @class Implements a basic 2D point. Known subclassers = {@link mxRectangle}.
 * @param {number} x X-coordinate of the point.
 * @param {number} y Y-coordinate of the point.
 */
UrlLibrary = function (ui, data, title) {
    StorageFile.call(this, ui, data, title);

    var fname = title;
    var last = fname.lastIndexOf('/');

    if (last >= 0) {
        fname = fname.substring(last + 1);
    }

    this.fname = fname;
};

//Extends mxEventSource
mxUtils.extend(UrlLibrary, StorageFile);

/**
 * Translates this point by the given vector.
 *
 * @param {number} dx X-coordinate of the translation.
 * @param {number} dy Y-coordinate of the translation.
 */
UrlLibrary.prototype.getHash = function () {
    return 'U' + encodeURIComponent(this.title);
};

/**
 * Translates this point by the given vector.
 *
 * @param {number} dx X-coordinate of the translation.
 * @param {number} dy Y-coordinate of the translation.
 */
UrlLibrary.prototype.getTitle = function () {
    return this.fname;
};

/**
 * Translates this point by the given vector.
 *
 * @param {number} dx X-coordinate of the translation.
 * @param {number} dy Y-coordinate of the translation.
 */
UrlLibrary.prototype.isAutosave = function () {
    return false;
};

/**
 * Overridden to avoid updating data with current file.
 */
UrlLibrary.prototype.isEditable = function (title, success, error) {
    return false;
};

/**
 * Overridden to avoid updating data with current file.
 */
UrlLibrary.prototype.saveAs = function (title, success, error) {
    // Cannot be saved
};

/**
 * Returns the location as a new object.
 * @type mx.Point
 */
UrlLibrary.prototype.open = function () {
    // Do nothing - this should never be called
};

/**
 * Copyright (c) 2006-2017, JGraph Ltd
 * Copyright (c) 2006-2017, Gaudenz Alder
 */
DriveFile = function (ui, data, desc) {
    DrawioFile.call(this, ui, data);

    this.desc = desc;
};

//Extends mxEventSource
mxUtils.extend(DriveFile, DrawioFile);

/**
 * Delay for last save in ms.
 */
DriveFile.prototype.saveDelay = 0;

/**
 * Delay for last save in ms.
 */
DriveFile.prototype.allChangesSavedKey = 'allChangesSavedInDrive';

/**
 * Specifies if notify events should be ignored.
 */
DriveFile.prototype.getSize = function () {
    return this.desc.fileSize;
};

/**
 * Returns true if copy, export and print are not allowed for this file.
 */
DriveFile.prototype.isRestricted = function () {
    return this.desc.userPermission != null && this.desc.labels != null &&
        this.desc.userPermission.role == 'reader' && this.desc.labels.restricted;
};

/**
 * Adds the listener for automatically saving the diagram for local changes.
 */
DriveFile.prototype.isConflict = function (err) {
    return err != null && err.error != null && err.error.code == 412;
};

/**
 * Overridden to enable the autosave option in the document properties dialog
 * if realtime is not used.
 */
DriveFile.prototype.isAutosaveOptional = function () {
    return true;
};

/**
 * Translates this point by the given vector.
 *
 * @param {number} dx X-coordinate of the translation.
 * @param {number} dy Y-coordinate of the translation.
 */
DriveFile.prototype.isRenamable = function () {
    return this.isEditable() && DrawioFile.prototype.isEditable.apply(this, arguments);
};

/**
 * Translates this point by the given vector.
 *
 * @param {number} dx X-coordinate of the translation.
 * @param {number} dy Y-coordinate of the translation.
 */
DriveFile.prototype.isMovable = function () {
    return this.isEditable();
};

/**
 * Translates this point by the given vector.
 *
 * @param {number} dx X-coordinate of the translation.
 * @param {number} dy Y-coordinate of the translation.
 */
DriveFile.prototype.save = function (revision, success, error, unloading, overwrite) {
    DrawioFile.prototype.save.apply(this, [revision, mxUtils.bind(this, function () {
        this.saveFile(null, revision, success, error, unloading, overwrite);
    }), error, unloading, overwrite]);
};

/**
 * Translates this point by the given vector.
 *
 * @param {number} dx X-coordinate of the translation.
 * @param {number} dy Y-coordinate of the translation.
 */
DriveFile.prototype.saveFile = function (title, revision, success, error, unloading, overwrite) {
    try {
        if (!this.isEditable()) {
            if (success != null) {
                success();
            }
        } else if (!this.savingFile) {
            var doSave = mxUtils.bind(this, function (realOverwrite, realRevision) {
                var prevModified = null;
                var modified = null;

                try {
                    // Makes sure no changes get lost while the file is saved
                    prevModified = this.isModified;
                    modified = this.isModified();
                    this.setModified(false);
                    this.savingFileTime = new Date();
                    this.savingFile = true;

                    // Waits for success for modified state to be visible
                    this.isModified = function () {
                        return true;
                    };

                    var lastDesc = this.desc;

                    this.ui.drive.saveFile(this, realRevision, mxUtils.bind(this, function (resp, savedData) {
                        try {
                            this.savingFile = false;
                            this.isModified = prevModified;

                            // Handles special case where resp is false eg
                            // if the old file was converted to realtime
                            if (resp != false) {
                                if (revision) {
                                    this.lastAutosaveRevision = new Date().getTime();
                                }

                                // Adaptive autosave delay
                                this.autosaveDelay = Math.min(8000,
                                    Math.max(this.saveDelay + 500,
                                        DriveFile.prototype.autosaveDelay));
                                this.desc = resp;

                                this.fileSaved(savedData, lastDesc, mxUtils.bind(this, function () {
                                    this.contentChanged();

                                    if (success != null) {
                                        success(resp);
                                    }
                                }), error);
                            } else {
                                this.setModified(modified || this.isModified());

                                if (error != null) {
                                    error(resp);
                                }
                            }
                        } catch (e) {
                            this.setModified(modified || this.isModified());

                            if (error != null) {
                                error(e);
                            } else {
                                throw e;
                            }
                        }
                    }), mxUtils.bind(this, function (err, desc) {
                        try {
                            this.savingFile = false;
                            this.isModified = prevModified;
                            this.setModified(modified || this.isModified());

                            if (this.isConflict(err)) {
                                this.inConflictState = true;

                                if (this.sync != null) {
                                    this.savingFile = true;
                                    this.savingFileTime = new Date();

                                    this.sync.fileConflict(desc, mxUtils.bind(this, function () {
                                        // Adds random cool-off
                                        window.setTimeout(mxUtils.bind(this, function () {
                                            this.updateFileData();
                                            doSave(realOverwrite, true);
                                        }), 100 + Math.random() * 500);
                                    }), mxUtils.bind(this, function () {
                                        this.savingFile = false;

                                        if (error != null) {
                                            error();
                                        }
                                    }));
                                } else if (error != null) {
                                    error();
                                }
                            } else if (error != null) {
                                error(err);
                            }
                        } catch (e) {
                            this.setModified(modified || this.isModified());

                            if (error != null) {
                                error(e);
                            } else {
                                throw e;
                            }
                        }
                    }), unloading, unloading, realOverwrite);
                } catch (e) {
                    this.savingFile = false;

                    if (prevModified != null) {
                        this.isModified = prevModified;
                    }

                    if (modified != null) {
                        this.setModified(modified || this.isModified());
                    }

                    if (error != null) {
                        error(e);
                    } else {
                        throw e;
                    }
                }
            });

            doSave(overwrite, revision);
        }
    } catch (e) {
        if (error != null) {
            error(e);
        } else {
            throw e;
        }
    }
};

/**
 * Shows a conflict dialog to the user.
 */
DriveFile.prototype.copyFile = function (success, error) {
    if (!this.isRestricted()) {
        this.makeCopy(mxUtils.bind(this, function () {
            if (this.ui.spinner.spin(document.body, mxResources.get('saving'))) {
                try {
                    this.save(true, success, error)
                } catch (e) {
                    error(e);
                }
            }
        }), error, true);
    } else {
        DrawioFile.prototype.copyFile.apply(this, arguments);
    }
};

/**
 * Shows a conflict dialog to the user.
 */
DriveFile.prototype.makeCopy = function (success, error, timestamp) {
    if (this.ui.spinner.spin(document.body, mxResources.get('saving'))) {
        // Uses copyFile internally which is a remote REST call with the advantage of keeping
        // the parents of the file in-place, but copies the remote file contents so needs to
        // be updated as soon as we have the ID.
        this.saveAs(this.ui.getCopyFilename(this, timestamp), mxUtils.bind(this, function (resp) {
            this.desc = resp;
            this.ui.spinner.stop();
            this.setModified(false);

            this.backupPatch = null;
            this.invalidChecksum = false;
            this.inConflictState = false;

            this.descriptorChanged();
            success();
        }), mxUtils.bind(this, function () {
            this.ui.spinner.stop();

            if (error != null) {
                error();
            }
        }));
    }
};

/**
 * Translates this point by the given vector.
 *
 * @param {number} dx X-coordinate of the translation.
 * @param {number} dy Y-coordinate of the translation.
 */
DriveFile.prototype.saveAs = function (filename, success, error) {
    this.ui.drive.copyFile(this.getId(), filename, success, error);
};

/**
 * Translates this point by the given vector.
 *
 * @param {number} dx X-coordinate of the translation.
 * @param {number} dy Y-coordinate of the translation.
 */
DriveFile.prototype.rename = function (title, success, error) {
    var etag = this.getCurrentEtag();

    this.ui.drive.renameFile(this.getId(), title, mxUtils.bind(this, function (desc) {
        if (!this.hasSameExtension(title, this.getTitle())) {
            this.desc = desc;

            if (this.sync != null) {
                this.sync.descriptorChanged(etag);
            }

            this.save(true, success, error);
        } else {
            this.desc = desc;
            this.descriptorChanged();

            if (this.sync != null) {
                this.sync.descriptorChanged(etag);
            }

            if (success != null) {
                success(desc);
            }
        }
    }), error);
};

/**
 * Translates this point by the given vector.
 *
 * @param {number} dx X-coordinate of the translation.
 * @param {number} dy Y-coordinate of the translation.
 */
DriveFile.prototype.move = function (folderId, success, error) {
    this.ui.drive.moveFile(this.getId(), folderId, mxUtils.bind(this, function (resp) {
        this.desc = resp;
        this.descriptorChanged();

        if (success != null) {
            success(resp);
        }
    }), error);
};

/**
 * Translates this point by the given vector.
 *
 * @param {number} dx X-coordinate of the translation.
 * @param {number} dy Y-coordinate of the translation.
 */
DriveFile.prototype.getTitle = function () {
    return this.desc.title;
};

/**
 * Translates this point by the given vector.
 *
 * @param {number} dx X-coordinate of the translation.
 * @param {number} dy Y-coordinate of the translation.
 */
DriveFile.prototype.getHash = function () {
    return 'G' + this.getId();
};

/**
 * Translates this point by the given vector.
 *
 * @param {number} dx X-coordinate of the translation.
 * @param {number} dy Y-coordinate of the translation.
 */
DriveFile.prototype.getId = function () {
    return this.desc.id;
};

/**
 * Translates this point by the given vector.
 *
 * @param {number} dx X-coordinate of the translation.
 * @param {number} dy Y-coordinate of the translation.
 */
DriveFile.prototype.isEditable = function () {
    return DrawioFile.prototype.isEditable.apply(this, arguments) &&
        this.desc.editable;
};

/**
 * Hook for subclassers.
 */
DriveFile.prototype.isSyncSupported = function () {
    return true;
};

/**
 * Hook for subclassers.
 */
DriveFile.prototype.isRevisionHistorySupported = function () {
    return true;
};

/**
 * Hook for subclassers.
 */
DriveFile.prototype.getRevisions = function (success, error) {
    this.ui.drive.executeRequest(gapi.client.drive.revisions.list({'fileId': this.getId()}),
        mxUtils.bind(this, function (resp) {
            for (var i = 0; i < resp.items.length; i++) {
                (mxUtils.bind(this, function (item) {
                    // Redirects title to originalFilename to
                    // match expected descriptor interface
                    item.title = item.originalFilename;

                    item.getXml = mxUtils.bind(this, function (itemSuccess, itemError) {
                        this.ui.drive.getXmlFile(item, mxUtils.bind(this, function (file) {
                            itemSuccess(file.getData());
                        }), itemError);
                    });

                    item.getUrl = mxUtils.bind(this, function (page) {
                        return this.ui.getUrl(window.location.pathname + '?rev=' + item.id +
                            '&chrome=0&nav=1&layers=1&edit=_blank' + ((page != null) ?
                                '&page=' + page : '')) + window.location.hash;
                    });
                }))(resp.items[i]);
            }

            success(resp.items);
        }), error);
};

/**
 * Adds the listener for automatically saving the diagram for local changes.
 */
DriveFile.prototype.getLatestVersion = function (success, error) {
    this.ui.drive.getFile(this.getId(), success, error, true);
};

/**
 * Adds all listeners.
 */
DriveFile.prototype.getChannelId = function () {
    var chan = this.ui.drive.getCustomProperty(this.desc, 'channel');

    if (chan != null) {
        chan = 'G-' + this.getId() + '.' + chan;
    }

    return chan;
};

/**
 * Gets the channel ID from the given descriptor.
 */
DriveFile.prototype.getChannelKey = function () {
    return this.ui.drive.getCustomProperty(this.desc, 'key');
};

/**
 * Adds all listeners.
 */
DriveFile.prototype.getLastModifiedDate = function () {
    return new Date(this.desc.modifiedDate);
};

/**
 * Adds all listeners.
 */
DriveFile.prototype.getDescriptor = function () {
    return this.desc;
};

/**
 * Updates the descriptor of this file with the one from the given file.
 */
DriveFile.prototype.setDescriptor = function (desc) {
    this.desc = desc;
};

/**
 * Returns the etag from the given descriptor.
 */
DriveFile.prototype.getDescriptorSecret = function (desc) {
    return this.ui.drive.getCustomProperty(desc, 'secret');
};

/**
 * Adds all listeners.
 */
DriveFile.prototype.getDescriptorEtag = function (desc) {
    return desc.etag;
};

/**
 * Adds the listener for automatically saving the diagram for local changes.
 */
DriveFile.prototype.setDescriptorEtag = function (desc, etag) {
    desc.etag = etag;
};

/**
 * Adds the listener for automatically saving the diagram for local changes.
 */
DriveFile.prototype.loadPatchDescriptor = function (success, error) {
    this.ui.drive.executeRequest(gapi.client.drive.files.get({
            'fileId': this.getId(),
            'fields': this.ui.drive.catchupFields, 'supportsTeamDrives': true
        }),
        mxUtils.bind(this, function (desc) {
            success(desc);
        }), error);
};

/**
 * Adds the listener for automatically saving the diagram for local changes.
 */
DriveFile.prototype.patchDescriptor = function (desc, patch) {
    DrawioFile.prototype.patchDescriptor.apply(this, arguments);

    desc.headRevisionId = patch.headRevisionId;
    desc.modifiedDate = patch.modifiedDate;
};

/**
 * Adds the listener for automatically saving the diagram for local changes.
 */
DriveFile.prototype.loadDescriptor = function (success, error) {
    this.ui.drive.loadDescriptor(this.getId(), success, error);
};

/**
 * Are comments supported
 */
DriveFile.prototype.commentsSupported = function () {
    return true;
};

/**
 * Get comments of the file
 */
DriveFile.prototype.getComments = function (success, error) {
    var currentUser = this.ui.getCurrentUser();

    function driveCommentToDrawio(file, gComment, pCommentId) {
        if (gComment.deleted) return null; //skip deleted comments

        var comment = new DriveComment(file, gComment.commentId || gComment.replyId, gComment.content,
            gComment.modifiedDate, gComment.createdDate, gComment.status == 'resolved',
            gComment.author.isAuthenticatedUser ? currentUser :
                new DrawioUser(gComment.author.permissionId, gComment.author.emailAddress,
                    gComment.author.displayName, gComment.author.picture.url), pCommentId);

        for (var i = 0; gComment.replies != null && i < gComment.replies.length; i++) {
            comment.addReplyDirect(driveCommentToDrawio(file, gComment.replies[i], gComment.commentId));
        }

        return comment;
    };

    this.ui.drive.executeRequest(gapi.client.drive.comments.list({'fileId': this.getId()}),
        mxUtils.bind(this, function (resp) {
            var comments = [];

            for (var i = 0; i < resp.items.length; i++) {
                var comment = driveCommentToDrawio(this, resp.items[i]);

                if (comment != null) comments.push(comment);
            }

            success(comments);
        }), error);
};

/**
 * Add a comment to the file
 */
DriveFile.prototype.addComment = function (comment, success, error) {
    var body = {'content': comment.content};

    this.ui.drive.executeRequest(gapi.client.drive.comments.insert({'fileId': this.getId(), 'resource': body}),
        mxUtils.bind(this, function (resp) {
            success(resp.commentId); //pass comment id
        }), error);
};

/**
 * Can add a reply to a reply
 */
DriveFile.prototype.canReplyToReplies = function () {
    return false;
};

/**
 * Can add comments (The permission to comment to this file)
 */
DriveFile.prototype.canComment = function () {
    return this.desc.canComment;
};

/**
 * Get a new comment object
 */
DriveFile.prototype.newComment = function (content, user) {
    return new DriveComment(this, null, content, Date.now(), Date.now(), false, user);
};

/**
 * Copyright (c) 2006-2017, JGraph Ltd
 * Copyright (c) 2006-2017, Gaudenz Alder
 */
DriveLibrary = function (ui, data, desc) {
    DriveFile.call(this, ui, data, desc);
};

//Extends mxEventSource
mxUtils.extend(DriveLibrary, DriveFile);

/**
 * Translates this point by the given vector.
 *
 * @param {number} dx X-coordinate of the translation.
 * @param {number} dy Y-coordinate of the translation.
 */
DriveLibrary.prototype.isAutosave = function () {
    return true;
};

/**
 * Translates this point by the given vector.
 *
 * @param {number} dx X-coordinate of the translation.
 * @param {number} dy Y-coordinate of the translation.
 */
DriveLibrary.prototype.save = function (revision, success, error) {
    this.ui.drive.saveFile(this, revision, mxUtils.bind(this, function (resp) {
        this.desc = resp;

        if (success != null) {
            success(resp);
        }
    }), error);
};

/**
 * Returns the location as a new object.
 * @type mx.Point
 */
DriveLibrary.prototype.open = function () {
    // Do nothing - this should never be called
};

/**
 * Copyright (c) 2006-2019, JGraph Ltd
 * Copyright (c) 2006-2019, draw.io AG
 */
DriveClient = function (editorUi) {
    mxEventSource.call(this);

    /**
     * Holds a reference to the UI. Needed for the sharing client.
     */
    this.ui = editorUi;

    // New mime type for XML files
    this.xmlMimeType = 'application/vnd.jgraph.mxfile';
    this.mimeType = 'application/vnd.jgraph.mxfile.realtime';

    // Reading files now possible with no initial click in drive
    if (this.ui.editor.chromeless && !this.ui.editor.editable && urlParams['rt'] != '1') {
        this.appId = window.DRAWIO_GOOGLE_VIEWER_APP_ID || '850530949725';
        this.clientId = window.DRAWIO_GOOGLE_VIEWER_CLIENT_ID || '850530949725.apps.googleusercontent.com';
        this.scopes = ['https://www.googleapis.com/auth/drive.readonly',
            'https://www.googleapis.com/auth/userinfo.profile'];
    } else {
        this.appId = window.DRAWIO_GOOGLE_APP_ID || '671128082532';
        this.clientId = window.DRAWIO_GOOGLE_CLIENT_ID || '671128082532-jhphbq6d0e1gnsus9mn7vf8a6fjn10mp.apps.googleusercontent.com';
    }

    this.mimeTypes = this.xmlMimeType + 'application/mxe,application/mxr,' +
        'application/vnd.jgraph.mxfile.realtime,application/vnd.jgraph.mxfile.rtlegacy';

    if (urlParams['photos'] == '1') {
        this.scopes.push('https://www.googleapis.com/auth/photos.upload');
    }
};

// Extends mxEventSource
mxUtils.extend(DriveClient, mxEventSource);

/**
 * OAuth 2.0 scopes for installing Drive Apps.
 */
DriveClient.prototype.scopes = ['https://www.googleapis.com/auth/drive.file',
    'https://www.googleapis.com/auth/drive.install',
    'https://www.googleapis.com/auth/userinfo.profile'];

/**
 * Contains the hostname of the old app.
 */
DriveClient.prototype.allFields = 'kind,id,parents,headRevisionId,etag,title,mimeType,modifiedDate,' +
    'editable,copyable,canComment,labels,properties,downloadUrl,webContentLink,userPermission,fileSize';

/**
 * Fields required for catchin up.
 *
 * TODO: Limit to etag and ekey property only
 */
DriveClient.prototype.catchupFields = 'etag,headRevisionId,modifiedDate,properties(key,value)';

/**
 * Specifies if thumbnails should be enabled. Default is true.
 * LATER: If thumbnails are disabled, make sure to replace the
 * existing thumbnail with the placeholder only once.
 */
DriveClient.prototype.enableThumbnails = true;

/**
 * Specifies the width for thumbnails. Default is 1000. This value
 * must be between 220 and 1600.
 */
DriveClient.prototype.thumbnailWidth = 1000;

/**
 * The maximum number of bytes per thumbnail. Default is 2000000.
 */
DriveClient.prototype.maxThumbnailSize = 2000000;

/**
 * Defines the base64url PNG to be used if no thumbnail was generated
 * (including the case where thumbnails are disabled).
 */
DriveClient.prototype.placeholderThumbnail = 'iVBORw0KGgoAAAANSUhEUgAAAJYAAACWCAMAAAAL34HQAAACN1BMVEXwhwXvhgX4iwXzhwXgbQzvhgXhbAzocgzqcwzldAoAAADhbgvjcQnmdgrlbgDwhgXsfwXufgjwhgXwgQfziAXxgADibgz4iwX4jAX3iwTpcwr1igXoewjsfgj3igX4iwXqcQv4jAX3iwXtfQnndQrvhAbibArwhwXgbQz//////v39jwX6jQX+/v7fagHfawzdVQDwhADgbhPgbhXwhwPocQ3uvKvwiA/faQDscgzxiAT97+XgciTgcSP6jAXgbQ3gcCHwiRfpcQzwhwfeXQD77ef74NLvhgTvegD66uPgbAf66+TvfADwjCzgcCfwiSD67ObhcjjwiBHhczvwiyrgbxj///777ujgcSHgcB/xiRzgbhveWgDeVwDhdEDgbRDqfgffYgDfXwD97+bvfQDxiz7//vvwiRr118rrcgztggbfZgDfZAD++PT98+3gbBPsgAb99vD33tPgcB7icAvuhAX//Pn66N/00sTyy7vuuqbjekLwhwzkcgr88er449n++vfutp/kh1vgcBvhbwvmdwnwgwDwgADeWQD87eLxxrTssJjqpIf0roHmjWTkhFP759n63czvvanomnjnlHDhczD22cr4y6/wwa/3xKX2wJ3rqpH0tY7qp4vpnoDymlbjf0vxjjntcwzldAroegj/kgX12s7518PzqnnnkWfynmLieUjpewjrdAD40Lj1uZTzpm3idTbiciLydQzzfwnyiQTsfgD3xqnzp3TxlkzgbCrdTwDdSwBLKUlNAAAAJ3RSTlP8/b2X/YH8wb+FAIuIggJbQin5opAM9+a/ubaubyD78NjSyr2WgRp4sjN4AAAI70lEQVR42u2cZ38SQRDGT8WGvfde4E4BxVMRRaKiUURRlJhQRDCCSgQVO/bee++9994+nMt5ywoezFJd/fm8uITi3p9n5mbYkcCpO6rVnVu2YEXd+3dRIySuo7pLv4GjGNKg7j3UHTl1l14PajmG9OFBnx7Ird4PumpYEtf1QXc112l0M7OGKXEfeg3guo3iNIyJG92Jaz61mYYxcaNacs1H/8f6j6X5j1WI/mMVIsawRFEzI49SjwOqAJa43emclk8Rp2c7AFZ+LDGyvXE2kmO2Q1Lq17RSd6ND48QIwFVuLNHTOPbEpTOz8ujMpccHGz0AV5mxIo4TpwUeUPj0YwfAVVYs0Tn7VZjnBUA8v+n6CyfERY8FR/DEJj7MQ6oL85vOvfDUAsuVC8s19s5yXuAppOPnvPk4EeSCsehCeBVTwVzHfE6RcFUQa4an8Qw91kpbw2oz4aoc1sSxniO0WAI/J24wriabmEpizZtM79bc+fr4/tUarEpiLabGElJYRsOGjbJfjGDpJCxtmosRLOEnVpqLESzZLYlLg65H1rAkLo2GESwcROwXI1jELcS1Y6OGQSzEVaupZQJLDiLhYtCtFBcbbslYhOueqKllDwtzwVhTq4RFuBh0C3EdEBl0C3OBWNUrEISLvSD+5GLQLYmLoSqfwcUiFuaqzhYDxiJc981lxqqdVsCGbHPcQLBgrtK3rwLt9tWqhblKxxI9hW3267U5ZHhuBrCKzXl4NIJTS5FrmbmMWGIEDZIouOp0/O6boYQ2jxBXWcdu13fzRILuF/2Ku+aGr96uBbhALHo5Z38+XcfXyVRZVx/+Ed513ldDCCCu0rFE0Xlo2mu5TAj8ki0XV0q6ePHilhi+d/15b9ACQGGusg3AFzc+XSMBCPzu89+CNlnB7zfD8t1z4iaLXUvDVT6sGdMOnv5pi47f6r9Qk9YF3xZ0l8S11UfMArlgLMpZM6bamYy6rWnta9q7TrZrzZPgPgoqg3atubY8WK6D8lQXHfb4p/wSK7vFfxmxSsAPQ96AlZ4LxoLNeompdkUDGQVznL5mLr4ar5ESD3PBWHA9fbpbjlT4pq1Bm6H6w9dwfOd69ePouNDYt3S3ULPGZ96S3YqtAW/Tepz1E8bgAANc+xEXhAX36ut1cslcd6rJq81SIvgEe7lmL3kY5iqxVYvOI9isswp22KeMOcrriJlWai5giwHl+yec73Ma9Mbfz+qOJndKz6hLpR5V1uPxavFuTTt0K1XfpbNeO0wKeUaR2IPBN5sMRlqu1eY8bsFmPeIFUpi0CjIGTLvSZY2EGeYSi3VL9Dgeb0I+SQl9MlcZT4TObZKzfmfS5NZSx1GsLQ5r+8Sxp7ERR/1TtDlUn2qNuGXCrZGM5URlLDiEVzDVkje5fdjXdDsm27XpXChBz4XG0UpYcDOMYaxjGc3wtyJxFtu1PohaI71f2K2imqEONcN4nrMZ9TWbMf81wg9z3VNwC26Gr3enY4ObobLqbccFefuz5AKONpVfzQp2y3NoVvrN32GLNl9orA22lTiM+Nqg5CJY1DueOjkwsdtNgAP7gidR2SWVhFqt3o9QwoKHIuiwDcwX+xT/UWztSlvCaqXGmtQBY1GadQmfh6anuE0XlkhhRFs3tGGkd+tuIVhiJN0M+brj0mlAu46lX0bcbizVLbgZrgwl4JhYA+NQa9TJQUetsSJYHscJvAVct7eJKoUbQudxPYmdirqzsYsIojhjoitD01yadH287J+vpZF1/uGt2K4ttinjshQo2C2XMzI2U64X6WY4tyZq99a7wZS3eA3BpNyrUPn1x00Z0uM1ACzilOfg7EN3VmRo8dN16WYYerYw6G9qCOSDCjQ0jQkufRbalt65LVyapaA/2mClxhK3Rxy3rsyavDxDR/DL5sMLFiyYu/7sXps7z8VldPv2Xl6PnjlTwOOuJQuytH7CXpvXCOQWoZrYeHWd4nw2Q+v22OLGnFSG0Nk1PCi0xjgjpVvTGi8hht9F+ARBGq8dtXmtOSLoDm1FhUSHnihkTecESalHkPAaWVhtFbA8jqvQGBmbt8fWkKtNn0Xw9GvAWK6DX9bBVHjzqtyvvcG9a+jXyC5oKoKV/a4YFG7Yij2ofszlgtaA3ZoRwW+pIOH3w0qZFURNh3oNtKsDsAr9LNvMC0pj93H6hTPpX9ocg8FIgTVvcgFYC03jFLBMi6ix0MDAoi8/lh7Cgt2q0VfNrSX0ayhjTa2IW0tKdotNrMq4NbPkILKZW+xdiSoGgshogfh7Ul7FcIEoFevfrPLC3+XWf6y/CEvHZoFQqlts9sQigqjLxFpQCJauakFcsqhKPXH79rGb6bE2B5Qmu0b91zn0WJtN8Wys9tgtIqfjEf2SWw7XKI8gHuKQ0X0eDsQSI44TaGBN6dYN5dlI/eFj9I7f8GWtoUJYOIgkiq6Ds/gw5T7dZDUqTrfscbLbB9eIB7JmEKsUgiii/4uO8ToBfJlhfif5tEGWEsGTMT4Mr6HDa0BBlP5Y88lcnkdkCtLhnyjMM0+Gcn2WzW6xnd/J8zn+LZq4SUeEvUBaA8LCs6Tk1p1AetXt3JoMWexWZSyr3RK6vSUGrRHbmkRUVgCLpP1HW/L4tgl5tO140mdKKFFhrkTUdxta4xleA8DCXC6n/vCYvPJFa9zAWL4m6qNaA8IiqjW73lreWnJrSj0AJYFZpvwq6RZRzjVUGEtB5tX7DdoqCXaL+PXHuEjdYsuvVqva4Sqv6NdabdW4YLeIKsoFYzHGhYPIGBd2izGuVpPaSVgAV7VEsOQgsuUXdosxLuwWxLVMW0WRK5ExLiiIpN4vq2YYVTiIbPmFgii5xRiXimCBqmIcVSS3WMqvdMqz5VcKqzdKeca4UrnVT/ryR6bi2Opuf64TwYJlfl4FLqu2Zxeux5BRXZnisvZ8103NqTtzoziuGa24+wZVRdVK9W7wyNSX1nYeOmrU6JSmjp6KhH5BR+kGvk++Ld0c/X66rPH4SEQeGl+kpq8a33eAumPqK347durWpzm9hrWhUevi1Hd4ZzVC+gGMHY0TYnDOYwAAAABJRU5ErkJggg=='.replace(/\+/g, '-').replace(/\//g, '_');

/**
 * Mime type for the paceholder thumbnail.
 */
DriveClient.prototype.placeholderMimeType = 'image/png';

/**
 * Executes the first step for connecting to Google Drive.
 */
DriveClient.prototype.libraryMimeType = 'application/vnd.jgraph.mxlibrary';

/**
 * Contains the hostname of the new app.
 */
DriveClient.prototype.newAppHostname = 'www.draw.io';

/**
 * Executes the first step for connecting to Google Drive.
 */
DriveClient.prototype.extension = '.drawio';

/**
 * Interval for updating the access token.
 */
DriveClient.prototype.tokenRefreshInterval = 0;

/**
 * Interval for updating the access token.
 */
DriveClient.prototype.lastTokenRefresh = 0;

/**
 * Executes the first step for connecting to Google Drive.
 */
DriveClient.prototype.maxRetries = 5;

/**
 * Executes the first step for connecting to Google Drive.
 */
DriveClient.prototype.coolOff = 1000;

/**
 * Executes the first step for connecting to Google Drive.
 */
DriveClient.prototype.mimeTypeCheckCoolOff = 60000;

/**
 * Executes the first step for connecting to Google Drive.
 */
DriveClient.prototype.user = null;

/**
 * Authorizes the client, gets the userId and calls <open>.
 */
DriveClient.prototype.setUser = function (user) {
    this.user = user;

    if (this.user == null && this.tokenRefreshThread != null) {
        window.clearTimeout(this.tokenRefreshThread);
        this.tokenRefreshThread = null;
    }

    this.fireEvent(new mxEventObject('userChanged'));
};

/**
 * Authorizes the client, gets the userId and calls <open>.
 */
DriveClient.prototype.getUser = function () {
    return this.user;
};

/**
 * Authorizes the client, gets the userId and calls <open>.
 */
DriveClient.prototype.setUserId = function (userId, remember) {
    if (remember) {
        if (isLocalStorage) {
            localStorage.setItem('.guid', userId);
        } else if (typeof (Storage) != 'undefined') {
            try {
                var expiry = new Date();
                expiry.setYear(expiry.getFullYear() + 1);
                document.cookie = 'GUID=' + userId + '; expires=' + expiry.toUTCString();
            } catch (e) {
                // any errors for storing the user ID can be safely ignored
            }
        }
    }
};

/**
 * Authorizes the client, gets the userId and calls <open>.
 */
DriveClient.prototype.clearUserId = function () {
    if (isLocalStorage) {
        localStorage.removeItem('.guid');
    } else if (typeof (Storage) != 'undefined') {
        var expiry = new Date();
        expiry.setYear(expiry.getFullYear() - 1);
        document.cookie = 'GUID=; expires=' + expiry.toUTCString();
    }
};

/**
 * Authorizes the client, gets the userId and calls <open>.
 */
DriveClient.prototype.getUserId = function () {
    var uid = null;

    if (this.user != null) {
        uid = this.user.id;
    }

    if (uid == null && isLocalStorage) {
        uid = localStorage.getItem('.guid');
    }

    if (uid == null && typeof (Storage) != 'undefined') {
        var cookies = document.cookie.split(";");

        for (var i = 0; i < cookies.length; i++) {
            // Removes spaces around cookie
            var cookie = mxUtils.trim(cookies[i]);

            if (cookie.substring(0, 5) == 'GUID=') {
                uid = cookie.substring(5);
                break;
            }
        }

        if (uid != null && isLocalStorage) {
            // Moves to local storage
            var expiry = new Date();
            expiry.setYear(expiry.getFullYear() - 1);
            document.cookie = 'GUID=; expires=' + expiry.toUTCString();
            localStorage.setItem('.guid', uid);
        }
    }

    return uid;
};

/**
 * Authorizes the client, gets the userId and calls <open>.
 */
DriveClient.prototype.execute = function (fn) {
    // Handles error in immediate authorize call via callback that shows a
    // UI with a button that executes the second non-immediate authorize
    var fallback = mxUtils.bind(this, function (resp) {
        // Remember is an argument for the callback that executes
        // when the user clicks the authorize button in the UI and
        // success executes after successful authorization.
        this.ui.showAuthDialog(this, true, mxUtils.bind(this, function (remember, success) {
            this.authorize(false, mxUtils.bind(this, function () {
                if (success != null) {
                    success();
                }

                fn();
            }), mxUtils.bind(this, function (resp) {
                var msg = mxResources.get('cannotLogin');

                // Handles special domain policy errors
                if (resp != null && resp.error != null) {
                    if (resp.error.code == 403 &&
                        resp.error.data != null && resp.error.data.length > 0 &&
                        resp.error.data[0].reason == 'domainPolicy') {
                        msg = resp.error.message;
                    }
                }

                this.ui.drive.clearUserId();
                this.ui.drive.setUser(null);
                gapi.auth.signOut();

                this.ui.showError(mxResources.get('error'), msg, mxResources.get('help'), mxUtils.bind(this, function () {
                    this.ui.openLink('https://desk.draw.io/support/solutions/articles/16000074659');
                }), null, mxResources.get('ok'));
            }), remember);
        }));
    });

    // First immediate authorize attempt
    this.authorize(true, fn, fallback);
};

/**
 * Executes the given request.
 */
DriveClient.prototype.executeRequest = function (req, success, error) {
    try {
        var acceptResponse = true;
        var timeoutThread = null;
        var retryCount = 0;

        // Cancels any pending requests
        if (this.requestThread != null) {
            window.clearTimeout(this.requestThread);
        }

        var fn = mxUtils.bind(this, function () {
            try {
                this.requestThread = null;
                this.currentRequest = req;

                if (timeoutThread != null) {
                    window.clearTimeout(timeoutThread);
                }

                timeoutThread = window.setTimeout(mxUtils.bind(this, function () {
                    acceptResponse = false;

                    if (error != null) {
                        error({code: App.ERROR_TIMEOUT, message: mxResources.get('timeout'), retry: fn});
                    }
                }), this.ui.timeout);

                req.execute(mxUtils.bind(this, function (resp) {
                    try {
                        window.clearTimeout(timeoutThread);

                        if (acceptResponse) {
                            if (resp != null && resp.error == null) {
                                if (success != null) {
                                    success(resp);
                                }
                            } else {
                                // Errors for put request are in data instead of errors
                                var data = (resp != null && resp.error != null) ? ((resp.error.data != null) ?
                                    resp.error.data : resp.error.errors) : null;
                                var reason = (data != null && data.length > 0) ? data[0].reason : null;

                                // Handles special error for saving old file where mime was changed to new
                                // LATER: Check if 403 is never auth error, for now we check the message for a specific
                                // case where the old app mime type was overridden by the new app
                                if (error != null && resp != null && resp.error != null && (resp.error.code == -1 ||
                                    (resp.error.code == 403 && (reason == 'domainPolicy' || resp.error.message ==
                                        'The requested mime type change is forbidden.')))) {
                                    error(resp);
                                }
                                // Handles authentication error
                                else if (resp != null && resp.error != null && (resp.error.code == 401 ||
                                    (resp.error.code == 403 && reason != 'rateLimitExceeded'))) {
                                    // Shows an error if we're authenticated but the server still doesn't allow it
                                    if ((resp.error.code == 403 && this.user != null) ||
                                        (resp.error.code == 401 && this.user != null && reason == 'authError')) {
                                        if (error != null) {
                                            error(resp);
                                        }
                                    } else {
                                        this.execute(fn);
                                    }
                                }
                                // Schedules a retry if no new request was executed
                                else if (resp != null && resp.error != null && resp.error.code != 412 && resp.error.code != 404 &&
                                    resp.error.code != 400 && this.currentRequest == req && retryCount < this.maxRetries) {
                                    retryCount++;
                                    var jitter = 1 + 0.1 * (Math.random() - 0.5);
                                    this.requestThread = window.setTimeout(fn,
                                        Math.round(Math.pow(2, retryCount) *
                                            jitter * this.coolOff));
                                } else if (error != null) {
                                    error(resp);
                                }
                            }
                        }
                    } catch (e) {
                        if (error != null) {
                            error(e);
                        } else {
                            throw e;
                        }
                    }
                }));
            } catch (e) {
                if (error != null) {
                    error(e);
                } else {
                    throw e;
                }
            }
        });

        // Must get token before first request in this case
        if (gapi.auth.getToken() == null) {
            this.execute(fn);
        } else {
            fn();
        }
    } catch (e) {
        if (error != null) {
            error(e);
        } else {
            throw e;
        }
    }
},

    /**
     * Authorizes the client, gets the userId and calls <open>.
     */
    DriveClient.prototype.authorize = function (immediate, success, error, remember) {
        try {
            var userId = this.getUserId();

            // Takes userId from state URL parameter
            if (this.ui.stateArg != null && this.ui.stateArg.userId != null) {
                userId = this.ui.stateArg.userId;
            }

            // Immediate only possible with userId
            if (immediate && userId == null) {
                if (error != null) {
                    error();
                }
            } else {
                var params =
                    {
                        scope: this.scopes,
                        client_id: this.clientId
                    };

                if (immediate && userId != null) {
                    params.immediate = true;
                    params.user_id = userId;
                } else {
                    params.immediate = false;
                    params.authuser = -1;
                }

                gapi.auth.authorize(params, mxUtils.bind(this, function (resp) {
                    try {
                        // Updates the current user info
                        if (resp != null && resp.error == null) {
                            if (this.user == null || !immediate || this.user.id != userId) {
                                this.updateUser(success, error, remember);
                            } else if (success != null) {
                                success();
                            }
                        } else if (error != null) {
                            error(resp);
                        }

                        this.resetTokenRefresh(resp);
                    } catch (e) {
                        if (error != null) {
                            error(e);
                        } else {
                            throw e;
                        }
                    }
                }));
            }
        } catch (e) {
            if (error != null) {
                error(e);
            } else {
                throw e;
            }
        }
    };

/**
 * Checks if the client is authorized and calls the next step.
 */
DriveClient.prototype.resetTokenRefresh = function (resp) {
    if (this.tokenRefreshThread != null) {
        window.clearTimeout(this.tokenRefreshThread);
        this.tokenRefreshThread = null;
    }

    // Starts timer to refresh token before it expires
    if (resp != null && resp.error == null && resp.expires_in > 0) {
        this.tokenRefreshInterval = parseInt(resp.expires_in) * 1000;
        this.lastTokenRefresh = new Date().getTime();

        this.tokenRefreshThread = window.setTimeout(mxUtils.bind(this, function () {
            this.authorize(true, mxUtils.bind(this, function () {
                //console.log('tokenRefresh: refreshed', gapi.auth.getToken());
            }), mxUtils.bind(this, function () {
                //console.log('tokenRefresh: error refreshing', gapi.auth.getToken());
            }));
        }), resp.expires_in * 900);
    }
};

/**
 * Checks if the client is authorized and calls the next step.
 */
DriveClient.prototype.checkToken = function (fn) {
    var connected = this.lastTokenRefresh > 0;
    var delta = new Date().getTime() - this.lastTokenRefresh;

    if (delta > this.tokenRefreshInterval || this.tokenRefreshThread == null) {
        // Uses execute instead of authorize to allow a fallback authorization if cookie was lost
        this.execute(mxUtils.bind(this, function () {
            fn();

            if (connected) {
                this.fireEvent(new mxEventObject('disconnected'));
            }
        }));
    } else {
        fn();
    }
};

/**
 * Checks if the client is authorized and calls the next step.
 */
DriveClient.prototype.updateUser = function (success, error, remember) {
    try {
        var token = gapi.auth.getToken().access_token;
        var url = 'https://www.googleapis.com/oauth2/v2/userinfo?alt=json&access_token=' + token;

        this.ui.loadUrl(url, mxUtils.bind(this, function (data) {
            var info = JSON.parse(data);

            // Requests more information about the user (email address is sometimes not in info)
            this.executeRequest(gapi.client.drive.about.get(), mxUtils.bind(this, function (resp) {
                var email = mxResources.get('notAvailable');
                var name = email;
                var pic = null;

                if (resp != null && resp.user != null) {
                    email = resp.user.emailAddress;
                    name = resp.user.displayName;
                    pic = (resp.user.picture != null) ? resp.user.picture.url : null;
                }

                this.setUser(new DrawioUser(info.id, email, name, pic, info.locale));
                this.setUserId(info.id, remember);

                if (success != null) {
                    success();
                }
            }), error);
        }), error);
    } catch (e) {
        if (error != null) {
            error(e);
        } else {
            throw e;
        }
    }
};

/**
 * Translates this point by the given vector.
 *
 * @param {number} dx X-coordinate of the translation.
 * @param {number} dy Y-coordinate of the translation.
 */
DriveClient.prototype.copyFile = function (id, title, success, error) {
    if (id != null && title != null) {
        this.executeRequest(gapi.client.drive.files.copy({
                'fileId': id,
                'fields': this.allFields, 'supportsTeamDrives': true,
                'resource': {
                    'title': title, 'properties':
                        [{'key': 'channel', 'value': Editor.guid()}]
                }
            }),
            success, error);
    }
};

/**
 * Translates this point by the given vector.
 *
 * @param {number} dx X-coordinate of the translation.
 * @param {number} dy Y-coordinate of the translation.
 */
DriveClient.prototype.renameFile = function (id, title, success, error) {
    if (id != null && title != null) {
        this.executeRequest(this.createDriveRequest(
            id, {'title': title}), success, error);
    }
};

/**
 * Translates this point by the given vector.
 *
 * @param {number} dx X-coordinate of the translation.
 * @param {number} dy Y-coordinate of the translation.
 */
DriveClient.prototype.moveFile = function (id, folderId, success, error) {
    if (id != null && folderId != null) {
        this.executeRequest(this.createDriveRequest(id, {
            'parents': [{
                'kind':
                    'drive#fileLink', 'id': folderId
            }]
        }), success, error);
    }
};

/**
 * Translates this point by the given vector.
 *
 * @param {number} dx X-coordinate of the translation.
 * @param {number} dy Y-coordinate of the translation.
 */
DriveClient.prototype.createDriveRequest = function (id, body) {
    return gapi.client.request({
        'path': '/drive/v2/files/' + id,
        'method': 'PUT',
        'params': {'uploadType': 'multipart', 'supportsTeamDrives': true},
        'headers': {'Content-Type': 'application/json; charset=UTF-8'},
        'body': JSON.stringify(body)
    });
};

/**
 * Loads the given file as a library file.
 */
DriveClient.prototype.getLibrary = function (id, success, error) {
    return this.getFile(id, success, error, true, true);
};

/**
 * Loads the descriptorf for the given file ID.
 */
DriveClient.prototype.loadDescriptor = function (id, success, error, fields) {
    this.executeRequest(gapi.client.drive.files.get({
        'fileId': id,
        'fields': (fields != null) ? fields : this.allFields,
        'supportsTeamDrives': true
    }), success, error);
};

/**
 * Gets the channel ID from the given descriptor.
 */
DriveClient.prototype.getCustomProperty = function (desc, key) {
    var props = desc.properties;
    var result = null;

    if (props != null) {
        for (var i = 0; i < props.length; i++) {
            if (props[i].key == key) {
                result = props[i].value;

                break;
            }
        }
    }

    return result;
};

/**
 * Checks if the client is authorized and calls the next step. The optional
 * readXml argument is used for import. Default is false. The optional
 * readLibrary argument is used for reading libraries. Default is false.
 */
DriveClient.prototype.getFile = function (id, success, error, readXml, readLibrary) {
    readXml = (readXml != null) ? readXml : false;
    readLibrary = (readLibrary != null) ? readLibrary : false;

    if (urlParams['rev'] != null) {

    } else {
        this.loadDescriptor(id, mxUtils.bind(this, function (resp) {
            try {
                if (this.user != null) {
                    var binary = /\.png$/i.test(resp.title);

                    // Handles .vsdx, .vsd, .vdx, Gliffy and PNG+XML files by creating a temporary file
                    if (/\.v(dx|sdx?)$/i.test(resp.title) || /\.gliffy$/i.test(resp.title) ||
                        (!this.ui.useCanvasForExport && binary)) {
                        var url = resp.downloadUrl + '&access_token=' + gapi.auth.getToken().access_token;
                        this.ui.convertFile(url, resp.title, resp.mimeType, this.extension, success, error);
                    } else {
                        // Handles converted realtime files as XML files
                        if (readXml || readLibrary || resp.mimeType == this.libraryMimeType ||
                            resp.mimeType == this.xmlMimeType) {
                            this.getXmlFile(resp, success, error, true, readLibrary);
                        } else {
                            if (this.isGoogleRealtimeMimeType(resp.mimeType)) {
                                this.convertRealtimeFile(resp, success, error);
                            } else {
                                this.getXmlFile(resp, success, error);
                            }
                        }
                    }
                } else {
                    error({message: mxResources.get('loggedOut')});
                }
            } catch (e) {
                if (error != null) {
                    error(e);
                } else {
                    throw e;
                }
            }
        }), error);
    }
};

/**
 * Returns true if the given mime type is for Google Realtime files.
 */
DriveClient.prototype.isGoogleRealtimeMimeType = function (mimeType) {
    return mimeType != null && mimeType.substring(0, 30) == 'application/vnd.jgraph.mxfile.';
};

/**
 * Checks if the client is authorized and calls the next step.
 */
DriveClient.prototype.getRealtimeData = function (id, success, error, retryCount) {
    if (App.GOOGLE_REALTIME_EOL - Date.now() < 0) {
        error({message: 'Google Realtime API export endpoint no longer available'});
    } else {
        this.executeRequest(gapi.client.drive.realtime.get({
            'fileId': id,
            'supportsTeamDrives': true
        }), mxUtils.bind(this, function (resp) {
            var json = (resp.result != null) ? resp.result.data : null;

            if (json != null && json.value != null && json.value.diagrams != null) {
                success(json);
            } else if (error != null) {
                error({message: 'realtime.get returned invalid data for ' + id});
            }
        }), mxUtils.bind(this, function (resp) {
            if (retryCount == null) {
                retryCount = 0;
            }

            if (retryCount < 3) {
                window.setTimeout(mxUtils.bind(this, function () {
                    this.getRealtimeData(id, success, error, retryCount + 1);
                }), (retryCount + 1) * 100);
            } else if (error != null) {
                error({message: 'realtime.get failed for ' + id});
            }
        }));
    }
};

/**
 * Checks if the client is authorized and calls the next step. The ignoreMime argument is
 * used for import via getFile. Default is false. The optional
 * readLibrary argument is used for reading libraries. Default is false.
 */
DriveClient.prototype.getXmlFile = function (resp, success, error, ignoreMime, readLibrary) {
    try {
        var token = gapi.auth.getToken().access_token;
        var url = resp.downloadUrl + '&access_token=' + token;

        // Loads XML to initialize realtime document if realtime is empty
        this.ui.loadUrl(url, mxUtils.bind(this, function (data) {
            try {
                if (data == null) {
                    // TODO: Optional redirect to legacy if link is for old file
                    error({message: mxResources.get('invalidOrMissingFile')});
                } else if (resp.mimeType == this.libraryMimeType || readLibrary) {
                    if (resp.mimeType == this.libraryMimeType && !readLibrary) {
                        error({message: mxResources.get('notADiagramFile')});
                    } else {
                        success(new DriveLibrary(this.ui, data, resp));
                    }
                } else {
                    var importFile = false;

                    if (/\.png$/i.test(resp.title)) {
                        var index = data.lastIndexOf(',');

                        if (index > 0) {
                            var xml = this.ui.extractGraphModelFromPng(data.substring(index + 1));

                            if (xml != null && xml.length > 0) {
                                data = xml;
                            } else {
                                // Checks if the file contains XML data which can happen when we insert
                                // the file and then don't post-process it when loaded into the UI which
                                // is required for creating the images for .PNG and .SVG files.
                                try {
                                    var xml = data.substring(index + 1);
                                    var temp = (window.atob && !mxClient.IS_IE && !mxClient.IS_IE11) ?
                                        atob(xml) : Base64.decode(xml);
                                    var node = this.ui.editor.extractGraphModel(
                                        mxUtils.parseXml(temp).documentElement, true);

                                    if (node == null || node.getElementsByTagName('parsererror').length > 0) {
                                        importFile = true;
                                    } else {
                                        data = temp;
                                    }
                                } catch (e) {
                                    importFile = true;
                                }
                            }
                        }
                    }
                    // Checks for base64 encoded mxfile
                    else if (data.substring(0, 32) == 'data:image/png;base64,PG14ZmlsZS') {
                        var temp = data.substring(22);
                        data = (window.atob && !mxClient.IS_SF) ? atob(temp) : Base64.decode(temp);
                    }

                    if (Graph.fileSupport && new XMLHttpRequest().upload && this.ui.isRemoteFileFormat(data, url)) {
                        this.ui.parseFile(new Blob([data], {type: 'application/octet-stream'}), mxUtils.bind(this, function (xhr) {
                            try {
                                if (xhr.readyState == 4) {
                                    if (xhr.status >= 200 && xhr.status <= 299) {
                                        success(new LocalFile(this.ui, xhr.responseText, resp.title + this.extension, true));
                                    } else if (error != null) {
                                        error({message: mxResources.get('errorLoadingFile')});
                                    }
                                }
                            } catch (e) {
                                if (error != null) {
                                    error(e);
                                } else {
                                    throw e;
                                }
                            }
                        }), resp.title);
                    } else {
                        success((importFile) ? new LocalFile(this.ui, data, resp.title, true) : new DriveFile(this.ui, data, resp));
                    }
                }
            } catch (e) {
                if (error != null) {
                    error(e);
                } else {
                    throw e;
                }
            }
        }), error, ((resp.mimeType != null && resp.mimeType.substring(0, 6) == 'image/' &&
            resp.mimeType.substring(0, 9) != 'image/svg')) || /\.png$/i.test(resp.title) ||
            /\.jpe?g$/i.test(resp.title));
    } catch (e) {
        if (error != null) {
            error(e);
        } else {
            throw e;
        }
    }
};

/**
 * Translates this point by the given vector.
 *
 * @param {number} dx X-coordinate of the translation.
 * @param {number} dy Y-coordinate of the translation.
 */
DriveClient.prototype.saveFile = function (file, revision, success, errFn, noCheck, unloading, overwrite, properties) {
    try {
        file.saveLevel = 1;

        var error = mxUtils.bind(this, function (e) {
            file.saveLevel = null;

            if (errFn != null) {
                errFn(e);
            } else {
                throw e;
            }

            // Logs failed save
            try {
                if (!file.isConflict(e)) {
                    var err = 'error_' + (file.getErrorMessage(e) || 'unknown');

                    if (e != null && e.error != null && e.error.code != null) {
                        err += '-code_' + e.error.code;
                    }

                    EditorUi.logEvent({
                        category: 'ERROR-SAVE-FILE-' + file.getHash() + '-rev_' +
                            file.desc.headRevisionId + '-mod_' + file.desc.modifiedDate +
                            '-size_' + file.getSize() + '-mime_' + file.desc.mimeType +
                            ((this.ui.editor.autosave) ? '' : '-nosave') +
                            ((file.isAutosave()) ? '' : '-noauto') +
                            ((file.changeListenerEnabled) ? '' : '-nolisten') +
                            ((file.inConflictState) ? '-conflict' : '') +
                            ((file.invalidChecksum) ? '-invalid' : ''),
                        action: err, label: ((this.user != null) ? ('user_' + this.user.id) : 'nouser') +
                            ((file.sync != null) ? ('-client_' + file.sync.clientId) : '-nosync')
                    });
                }
            } catch (ex) {
                // ignore
            }
        });

        var criticalError = mxUtils.bind(this, function (e) {
            error(e);

            try {
                EditorUi.logError(e.message, null, null, e);

                EditorUi.sendReport('Critical error in DriveClient.saveFile ' +
                    new Date().toISOString() + ':' +
                    '\n\nBrowser=' + navigator.userAgent +
                    '\nFile=' + file.desc.id + '.' + file.desc.headRevisionId +
                    '\nUser=' + ((this.user != null) ? this.user.id : 'nouser') +
                    ((file.sync != null) ? '-client_' + file.sync.clientId : '-nosync') +
                    '\nMessage=' + e.message +
                    '\n\nStack:\n' + e.stack);
            } catch (e) {
                // ignore
            }
        });

        if (file.isEditable() && file.desc != null) {
            var t0 = new Date().getTime();
            var etag0 = file.desc.etag;
            var mod0 = file.desc.modifiedDate;
            var head0 = file.desc.headRevisionId;
            var saveAsPng = this.ui.useCanvasForExport && /(\.png)$/i.test(file.getTitle());
            noCheck = (noCheck != null) ? noCheck : urlParams['ignoremime'] == '1';

            // NOTE: Unloading arg is currently ignored, saving during unload/beforeUnload is not possible using
            // asynchronous code, which is needed to create the thumbnail, or asynchronous requests which is the only
            // way to execute the gapi request below.
            // If no thumbnail is created and noCheck is true (which is always true if unloading is true) in which case
            // this code is synchronous, the executeRequest call is reached but the request is still not sent. This is
            // true for both, calls from beforeUnload and unload handlers. Note sure how to make the call synchronous
            // which is said to fix this when called from beforeUnload.
            // However, this would result in a missing thumbnail in most cases so a better solution might be to reduce
            // the autosave interval in DriveRealtime, but that would increase the number of requests.
            unloading = (unloading != null) ? unloading : false;

            // Adds optional thumbnail to upload request
            var doSave = mxUtils.bind(this, function (thumb, thumbMime, keepExisting) {
                try {
                    file.saveLevel = 3;
                    var prevDesc = null;
                    var pinned = false;
                    var meta =
                        {
                            'mimeType': file.desc.mimeType,
                            'title': file.getTitle()
                        };

                    // Overrides old mime type and creates a revision
                    if (this.isGoogleRealtimeMimeType(file.desc.mimeType)) {
                        meta.mimeType = this.xmlMimeType;
                        prevDesc = file.desc;
                        revision = true;
                        pinned = true;
                    }
                    // Overrides mime type for unknown file type uploads
                    else if (meta.mimeType == 'application/octet-stream') {
                        meta.mimeType = this.xmlMimeType;
                    }

                    if (file.constructor == DriveFile) {
                        if (properties == null) {
                            properties = [];
                        }

                        // Channel ID appended to file ID for comms
                        if (file.getChannelId() == null) {
                            properties.push({'key': 'channel', 'value': Editor.guid(32)});
                        }

                        // Key for encryption of comms
                        if (file.getChannelKey() == null) {
                            properties.push({'key': 'key', 'value': Editor.guid(32)});
                        }

                        // Pass to access cache for each etag
                        properties.push({'key': 'secret', 'value': Editor.guid(32)});
                    }

                    // Specifies that no thumbnail should be uploaded in which case the existing thumbnail is used
                    if (!keepExisting) {
                        // Uses placeholder thumbnail to replace existing one except when unloading
                        // in which case the XML is updated but the existing thumbnail is not in order
                        // to avoid executing asynchronous code and get the XML to the server instead
                        if (thumb == null && !unloading) {
                            thumb = this.placeholderThumbnail;
                            thumbMime = this.placeholderMimeType;
                        }

                        // Adds metadata for thumbnail
                        if (thumb != null && thumbMime != null) {
                            meta.thumbnail =
                                {
                                    'image': thumb,
                                    'mimeType': thumbMime
                                };
                        }
                    }

                    var savedData = file.getData();

                    // Updates saveDelay on drive file
                    var wrapper = mxUtils.bind(this, function (resp) {
                        try {
                            file.saveDelay = new Date().getTime() - t0;

                            // Checks if modified time is in the future and head revision has changed
                            var delta = new Date(resp.modifiedDate).getTime() - new Date(mod0).getTime();

                            if (delta <= 0 || etag0 == resp.etag || (revision && head0 == resp.headRevisionId)) {
                                var reasons = [];

                                if (delta <= 0) {
                                    reasons.push('invalid modified time');
                                }

                                if (etag0 == resp.etag) {
                                    reasons.push('stale etag');
                                }

                                if (revision && head0 == resp.headRevisionId) {
                                    reasons.push('stale revision');
                                }

                                var temp = reasons.join(', ');
                                error({message: mxResources.get('errorSavingFile') + ': ' + temp}, resp);

                                // Logs failed save
                                try {
                                    EditorUi.sendReport('Critical: Error saving to Google Drive ' +
                                        new Date().toISOString() + ':' + '\n\nBrowser=' + navigator.userAgent +
                                        '\nFile=' + file.desc.id + ' ' + file.desc.mimeType +
                                        '\nUser=' + ((this.user != null) ? this.user.id : 'nouser') +
                                        ((file.sync != null) ? '-client_' + file.sync.clientId : '-nosync') +
                                        '\nErrors=' + temp + '\nOld=' + head0 + ' ' + mod0 + ' etag-hash=' +
                                        this.ui.hashValue(etag0) + '\nNew=' + resp.headRevisionId + ' ' +
                                        resp.modifiedDate + ' etag-hash=' + this.ui.hashValue(resp.etag))
                                    EditorUi.logError('Critical: Error saving to Google Drive ' + file.desc.id,
                                        null, 'from-' + head0 + '.' + mod0 + '-' + this.ui.hashValue(etag0) +
                                        '-to-' + resp.headRevisionId + '.' + resp.modifiedDate + '-' +
                                        this.ui.hashValue(resp.etag) + ((temp.length > 0) ? '-errors-' + temp : ''),
                                        'user-' + ((this.user != null) ? this.user.id : 'nouser') +
                                        ((file.sync != null) ? '-client_' + file.sync.clientId : '-nosync'));
                                } catch (e) {
                                    // ignore
                                }
                            } else {
                                file.saveLevel = null;
                                success(resp, savedData);

                                if (prevDesc != null) {
                                    // Pins previous revision
                                    this.executeRequest(gapi.client.drive.revisions.get(
                                        {
                                            'fileId': prevDesc.id,
                                            'revisionId': prevDesc.headRevisionId,
                                            'supportsTeamDrives': true
                                        }), mxUtils.bind(this, mxUtils.bind(this, function (resp) {
                                        resp.pinned = true;

                                        this.executeRequest(gapi.client.drive.revisions.update(
                                            {
                                                'fileId': prevDesc.id,
                                                'revisionId': prevDesc.headRevisionId,
                                                'resource': resp
                                            }));
                                    })));

                                    // Logs conversion
                                    try {
                                        EditorUi.logEvent({
                                            category: file.convertedFrom + '-CONVERT-FILE-' + file.getHash(),
                                            action: 'from_' + prevDesc.id + '.' + prevDesc.headRevisionId +
                                                '-to_' + file.desc.id + '.' + file.desc.headRevisionId,
                                            label: (this.user != null) ? ('user_' + this.user.id) : 'nouser' +
                                                ((file.sync != null) ? '-client_' + file.sync.clientId : 'nosync')
                                        });
                                    } catch (e) {
                                        // ignore
                                    }
                                }

                                // Logs successful save
                                try {
                                    EditorUi.logEvent({
                                        category: 'SUCCESS-SAVE-FILE-' + file.getHash() +
                                            '-rev0_' + head0 + '-mod0_' + mod0,
                                        action: 'rev-' + resp.headRevisionId +
                                            '-mod_' + resp.modifiedDate + '-size_' + file.getSize() +
                                            '-mime_' + file.desc.mimeType +
                                            ((this.ui.editor.autosave) ? '' : '-nosave') +
                                            ((file.isAutosave()) ? '' : '-noauto') +
                                            ((file.changeListenerEnabled) ? '' : '-nolisten') +
                                            ((file.inConflictState) ? '-conflict' : '') +
                                            ((file.invalidChecksum) ? '-invalid' : ''),
                                        label: ((this.user != null) ? ('user_' + this.user.id) : 'nouser') +
                                            ((file.sync != null) ? ('-client_' + file.sync.clientId) : '-nosync')
                                    });
                                } catch (e) {
                                    // ignore
                                }
                            }
                        } catch (e) {
                            criticalError(e);
                        }
                    });

                    var doExecuteRequest = mxUtils.bind(this, function (data, binary) {
                        file.saveLevel = 4;

                        try {
                            if (properties != null) {
                                meta.properties = properties;
                            }

                            // Used to check if file was changed externally
                            var etag = (!overwrite && file.constructor == DriveFile &&
                                (DrawioFile.SYNC == 'manual' || DrawioFile.SYNC == 'auto')) ?
                                file.getCurrentEtag() : null;
                            var retryCount = 0;

                            var executeSave = mxUtils.bind(this, function (realOverwrite) {
                                file.saveLevel = 5;

                                try {
                                    var unknown = file.desc.mimeType != this.xmlMimeType && file.desc.mimeType != this.mimeType &&
                                        file.desc.mimeType != this.libraryMimeType;
                                    var acceptResponse = true;

                                    // Allow for re-auth flow with 4x timeout
                                    var timeoutThread = window.setTimeout(mxUtils.bind(this, function () {
                                        acceptResponse = false;
                                        error({code: App.ERROR_TIMEOUT, message: mxResources.get('timeout')});
                                    }), 4 * this.ui.timeout);

                                    this.executeRequest(this.createUploadRequest(file.getId(), meta,
                                        data, revision || realOverwrite || unknown, binary,
                                        (realOverwrite) ? null : etag, pinned), mxUtils.bind(this, function (resp) {
                                        window.clearTimeout(timeoutThread);

                                        if (acceptResponse) {
                                            wrapper(resp);
                                        }
                                    }), mxUtils.bind(this, function (err) {
                                        window.clearTimeout(timeoutThread);

                                        if (acceptResponse) {
                                            file.saveLevel = 6;

                                            try {
                                                if (!file.isConflict(err)) {
                                                    error(err);
                                                } else {
                                                    // Check for stale etag which can happen if a file is being saved or if
                                                    // the etag simply isn't change but system still returns a 412 error (stale)
                                                    this.executeRequest(gapi.client.drive.files.get({
                                                            'fileId': file.getId(),
                                                            'fields': this.catchupFields, 'supportsTeamDrives': true
                                                        }),
                                                        mxUtils.bind(this, function (resp) {
                                                            file.saveLevel = 7;

                                                            try {
                                                                // Stale etag detected, retry with delay
                                                                if (resp != null && resp.etag == etag) {
                                                                    if (retryCount < this.maxRetries) {
                                                                        retryCount++;
                                                                        var jitter = 1 + 0.1 * (Math.random() - 0.5);
                                                                        var delay = retryCount * 2 * this.coolOff * jitter;
                                                                        window.setTimeout(executeSave, delay);
                                                                    } else {
                                                                        executeSave(true);

                                                                        // Logs overwrite
                                                                        try {
                                                                            EditorUi.logError('Warning: Stale Etag Overwrite ' + file.getHash(),
                                                                                null, file.desc.id + '.' + file.desc.headRevisionId,
                                                                                ((this.user != null) ? ('user_' + this.user.id) : 'nouser') +
                                                                                ((file.sync != null) ? ('-client_' + file.sync.clientId) : '-nosync'));
                                                                        } catch (e) {
                                                                            // ignore
                                                                        }
                                                                    }
                                                                } else {
                                                                    error(err, resp);
                                                                }
                                                            } catch (e) {
                                                                criticalError(e);
                                                            }
                                                        }), mxUtils.bind(this, function () {
                                                            error(err);
                                                        }));
                                                }
                                            } catch (e) {
                                                criticalError(e);
                                            }
                                        }
                                    }));
                                } catch (e) {
                                    criticalError(e);
                                }
                            });

                            // Uses saved PNG data for thumbnail
                            if (saveAsPng && thumb == null) {
                                file.saveLevel = 8;
                                var img = new Image();

                                img.onload = mxUtils.bind(this, function () {
                                    try {
                                        var s = this.thumbnailWidth / img.width;

                                        var canvas = document.createElement('canvas');
                                        canvas.width = this.thumbnailWidth;
                                        canvas.height = Math.floor(img.height * s);

                                        var ctx = canvas.getContext('2d');
                                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

                                        var temp = canvas.toDataURL();
                                        temp = temp.substring(temp.indexOf(',') + 1).replace(/\+/g, '-').replace(/\//g, '_');

                                        meta.thumbnail =
                                            {
                                                'image': temp,
                                                'mimeType': 'image/png'
                                            };

                                        executeSave(false);
                                    } catch (e) {
                                        executeSave(false)
                                    }
                                });

                                img.src = 'data:image/png;base64,' + data;
                            } else {
                                executeSave(false);
                            }
                        } catch (e) {
                            criticalError(e);
                        }
                    });

                    if (saveAsPng) {
                        this.ui.getEmbeddedPng(mxUtils.bind(this, function (data) {
                            doExecuteRequest(data, true);
                        }), error, (this.ui.getCurrentFile() != file) ? savedData : null);
                    } else {
                        doExecuteRequest(savedData, false);
                    }
                } catch (e) {
                    criticalError(e);
                }
            });

            // Indirection to generate thumbnails if enabled and supported
            // (required because generation of thumbnails is asynchronous)
            var fn = mxUtils.bind(this, function () {
                try {
                    file.saveLevel = 2;

                    // NOTE: getThumbnail is asynchronous and returns false if no thumbnails can be created
                    if (unloading || saveAsPng || file.constructor == DriveLibrary || !this.enableThumbnails || urlParams['thumb'] == '0' ||
                        (file.desc.mimeType != null && file.desc.mimeType.substring(0, 29) != 'application/vnd.jgraph.mxfile') ||
                        !this.ui.getThumbnail(this.thumbnailWidth, mxUtils.bind(this, function (canvas) {
                            // Callback for getThumbnail
                            try {
                                file.thumbTime = null;
                                var thumb = null;

                                try {
                                    if (canvas != null) {
                                        // Security errors are possible
                                        thumb = canvas.toDataURL('image/png');
                                    }

                                    // Maximum thumbnail size is 2MB
                                    if (thumb != null) {
                                        if (thumb.length > this.maxThumbnailSize) {
                                            thumb = null;
                                        } else {
                                            // Converts base64 data into required format for Drive (base64url with no prefix)
                                            thumb = thumb.substring(thumb.indexOf(',') + 1).replace(/\+/g, '-').replace(/\//g, '_');
                                        }
                                    }
                                } catch (e) {
                                    thumb = null;
                                }

                                doSave(thumb, 'image/png');
                            } catch (e) {
                                criticalError(e);
                            }
                        }))) {
                        // If-branch
                        file.thumbTime = null;
                        doSave(null, null, file.constructor != DriveLibrary);
                    }
                } catch (e) {
                    criticalError(e);
                }
            });

            // New revision is required if mime type changes, but the mime type should not be replaced
            // if the file has been converted to the new realtime format. To check this we make sure
            // that the mime type has not changed before updating it in the case of the legacy app.
            // Note: We need to always check the mime type because saveFile cancels previous save
            // attempts so if the save frequency is higher than the time for all retries than you
            // will never see the error message and accumulate lots of changes that will be lost.
            if (noCheck || !revision) {
                fn();
            } else {
                this.verifyMimeType(file.getId(), fn, true);
            }
        } else {
            this.ui.editor.graph.reset();
            error({message: mxResources.get('readOnly')});
        }
    } catch (e) {
        criticalError(e);
    }
};

/**
 * Verifies the mime type of the given file ID.
 */
DriveClient.prototype.verifyMimeType = function (fileId, fn, force, error) {
    if (this.lastMimeCheck == null) {
        this.lastMimeCheck = 0;
    }

    var now = new Date().getTime();

    if (force || now - this.lastMimeCheck > this.mimeTypeCheckCoolOff) {
        this.lastMimeCheck = now;

        if (!this.checkingMimeType) {
            this.checkingMimeType = true;

            this.executeRequest(gapi.client.drive.files.get({
                'fileId': fileId, 'fields': 'mimeType',
                'supportsTeamDrives': true
            }), mxUtils.bind(this, function (resp) {
                this.checkingMimeType = false;

                if (resp != null && resp.mimeType == 'application/vnd.jgraph.mxfile.realtime') {
                    this.redirectToNewApp(error, fileId);
                } else if (fn != null) {
                    fn();
                }
            }));
        }
    }
};

/**
 * Checks if the client is authorized and calls the next step.
 */
DriveClient.prototype.redirectToNewApp = function (error, fileId) {
    this.ui.spinner.stop();

    if (!this.redirectDialogShowing) {
        this.redirectDialogShowing = true;

        var url = window.location.protocol + '//' + this.newAppHostname + '/' + this.ui.getSearch(
            ['create', 'title', 'mode', 'url', 'drive', 'splash', 'state']) + '#G' + fileId;

        var redirect = mxUtils.bind(this, function () {
            this.redirectDialogShowing = false;

            if (window.location.href == url) {
                window.location.reload();
            } else {
                window.location.href = url;
            }
        });

        if (error != null) {
            this.ui.confirm(mxResources.get('redirectToNewApp'), redirect, mxUtils.bind(this, function () {
                this.redirectDialogShowing = false;

                if (error != null) {
                    error();
                }
            }));
        } else {
            this.ui.alert(mxResources.get('redirectToNewApp'), redirect);
        }
    }
};

/**
 * Translates this point by the given vector.
 *
 * @param {number} dx X-coordinate of the translation.
 * @param {number} dy Y-coordinate of the translation.
 */
DriveClient.prototype.insertFile = function (title, data, folderId, success, error, mimeType, binary) {
    mimeType = (mimeType != null) ? mimeType : this.xmlMimeType;

    var metadata =
        {
            'mimeType': mimeType,
            'title': title
        };

    if (folderId != null) {
        metadata.parents = [{'kind': 'drive#fileLink', 'id': folderId}];
    }

    // NOTE: Cannot create thumbnail on insert since no ui has no current file
    this.executeRequest(this.createUploadRequest(null, metadata, data, false, binary), mxUtils.bind(this, function (resp) {
        if (mimeType == this.libraryMimeType) {
            success(new DriveLibrary(this.ui, data, resp));
        } else if (resp == false) {
            if (error != null) {
                error({message: mxResources.get('errorSavingFile')});
            }
        } else {
            success(new DriveFile(this.ui, data, resp));
        }
    }), error);
};

/**
 * Translates this point by the given vector.
 *
 * @param {number} dx X-coordinate of the translation.
 * @param {number} dy Y-coordinate of the translation.
 */
DriveClient.prototype.createUploadRequest = function (id, metadata, data, revision, binary, etag, pinned) {
    binary = (binary != null) ? binary : false;
    var bd = '-------314159265358979323846';
    var delim = '\r\n--' + bd + '\r\n';
    var close = '\r\n--' + bd + '--';
    var ctype = 'application/octect-stream';

    var headers = {'Content-Type': 'multipart/mixed; boundary="' + bd + '"'};

    if (etag != null) {
        headers['If-Match'] = etag;
    }

    var reqObj =
        {
            'path': '/upload/drive/v2/files' + (id != null ? '/' + id : ''),
            'method': (id != null) ? 'PUT' : 'POST',
            'params': {'uploadType': 'multipart'},
            'headers': headers,
            'body': delim + 'Content-Type: application/json\r\n\r\n' + JSON.stringify(metadata) + delim +
                'Content-Type: ' + ctype + '\r\n' + 'Content-Transfer-Encoding: base64\r\n' + '\r\n' +
                ((data != null) ? (binary) ? data : Base64.encode(data) : '') + close
        }

    if (!revision) {
        reqObj.params['newRevision'] = false;
    }

    if (pinned) {
        reqObj.params['pinned'] = true;
    }

    reqObj.params['supportsTeamDrives'] = true;
    reqObj.params['fields'] = this.allFields;

    return gapi.client.request(reqObj);
};

/**
 * Translates this point by the given vector.
 *
 * @param {number} dx X-coordinate of the translation.
 * @param {number} dy Y-coordinate of the translation.
 */
DriveClient.prototype.pickFile = function (fn, acceptAllFiles) {
    this.filePickerCallback = (fn != null) ? fn : mxUtils.bind(this, function (id) {
        this.ui.loadFile('G' + id);
    });

    this.filePicked = mxUtils.bind(this, function (data) {
        if (data.action == google.picker.Action.PICKED) {
            this.filePickerCallback(data.docs[0].id);
        }
    });

    if (this.ui.spinner.spin(document.body, mxResources.get('authorizing'))) {
        this.execute(mxUtils.bind(this, function () {
            try {
                this.ui.spinner.stop();

                // Reuses picker as long as token doesn't change.
                var token = gapi.auth.getToken().access_token;
                var name = (acceptAllFiles) ? 'genericPicker' : 'filePicker';

                // Click on background closes dialog as workaround for blocking dialog
                // states such as 401 where the dialog cannot be closed and blocks UI
                var exit = mxUtils.bind(this, function (evt) {
                    // Workaround for click from appIcon on second call
                    if (mxEvent.getSource(evt).className == 'picker modal-dialog-bg picker-dialog-bg') {
                        mxEvent.removeListener(document, 'click', exit);
                        this[name].setVisible(false);
                    }
                });

                if (this[name] == null || this[name + 'Token'] != token) {
                    // FIXME: Dispose not working
                    //				if (this[name] != null)
                    //				{
                    //					console.log(name, this[name]);
                    //					this[name].dispose();
                    //				}

                    this[name + 'Token'] = token;

                    // Pseudo-hierarchical directory view, see
                    // https://groups.google.com/forum/#!topic/google-picker-api/FSFcuJe7icQ
                    var view = new google.picker.DocsView(google.picker.ViewId.FOLDERS)
                        .setParent('root')
                        .setIncludeFolders(true);

                    var view2 = new google.picker.DocsView()
                        .setIncludeFolders(true);

                    var view3 = new google.picker.DocsView()
                        .setEnableTeamDrives(true)
                        .setIncludeFolders(true);

                    var view4 = new google.picker.DocsUploadView()
                        .setIncludeFolders(true);

                    if (!acceptAllFiles) {
                        view.setMimeTypes(this.mimeTypes);
                        view2.setMimeTypes(this.mimeTypes);
                        view3.setMimeTypes(this.mimeTypes);
                    } else {
                        view.setMimeTypes('*/*');
                        view2.setMimeTypes('*/*');
                        view3.setMimeTypes('*/*');
                    }

                    this[name] = new google.picker.PickerBuilder()
                        .setOAuthToken(this[name + 'Token'])
                        .setLocale(mxLanguage)
                        .setAppId(this.appId)
                        .enableFeature(google.picker.Feature.SUPPORT_TEAM_DRIVES)
                        .addView(view)
                        .addView(view2)
                        .addView(view3)
                        .addView(google.picker.ViewId.RECENTLY_PICKED)
                        .addView(view4)
                        .setCallback(mxUtils.bind(this, function (data) {
                            if (data.action == google.picker.Action.PICKED ||
                                data.action == google.picker.Action.CANCEL) {
                                mxEvent.removeListener(document, 'click', exit);
                            }

                            if (data.action == google.picker.Action.PICKED) {
                                this.filePicked(data);
                            }
                        })).build();
                }

                mxEvent.addListener(document, 'click', exit);
                this[name].setVisible(true);
            } catch (e) {
                this.ui.spinner.stop();
                this.ui.handleError(e);
            }
        }));
    }
};

/**
 * Translates this point by the given vector.
 *
 * @param {number} dx X-coordinate of the translation.
 * @param {number} dy Y-coordinate of the translation.
 */
DriveClient.prototype.pickFolder = function (fn, force) {
    this.folderPickerCallback = fn;

    // Picker is initialized once and points to this function
    // which is overridden each time to the picker is shown
    var showPicker = mxUtils.bind(this, function () {
        try {
            if (this.ui.spinner.spin(document.body, mxResources.get('authorizing'))) {
                this.execute(mxUtils.bind(this, function () {
                    try {
                        this.ui.spinner.stop();

                        // Reuses picker as long as token doesn't change.
                        var token = gapi.auth.getToken().access_token;
                        var name = 'folderPicker';

                        // Click on background closes dialog as workaround for blocking dialog
                        // states such as 401 where the dialog cannot be closed and blocks UI
                        var exit = mxUtils.bind(this, function (evt) {
                            // Workaround for click from appIcon on second call
                            if (mxEvent.getSource(evt).className == 'picker modal-dialog-bg picker-dialog-bg') {
                                mxEvent.removeListener(document, 'click', exit);
                                this[name].setVisible(false);
                            }
                        });

                        if (this[name] == null || this[name + 'Token'] != token) {
                            // FIXME: Dispose not working
                            //				if (this[name] != null)
                            //				{
                            //					console.log(name, this[name]);
                            //					this[name].dispose();
                            //				}

                            this[name + 'Token'] = token;

                            // Pseudo-hierarchical directory view, see
                            // https://groups.google.com/forum/#!topic/google-picker-api/FSFcuJe7icQ
                            var view = new google.picker.DocsView(google.picker.ViewId.FOLDERS)
                                .setParent('root')
                                .setIncludeFolders(true)
                                .setSelectFolderEnabled(true)
                                .setMimeTypes('application/vnd.google-apps.folder');

                            var view2 = new google.picker.DocsView()
                                .setIncludeFolders(true)
                                .setSelectFolderEnabled(true)
                                .setMimeTypes('application/vnd.google-apps.folder');

                            var view3 = new google.picker.DocsView()
                                .setIncludeFolders(true)
                                .setEnableTeamDrives(true)
                                .setSelectFolderEnabled(true)
                                .setMimeTypes('application/vnd.google-apps.folder');

                            this[name] = new google.picker.PickerBuilder()
                                .setSelectableMimeTypes('application/vnd.google-apps.folder')
                                .setOAuthToken(this[name + 'Token'])
                                .setLocale(mxLanguage)
                                .setAppId(this.appId)
                                .enableFeature(google.picker.Feature.SUPPORT_TEAM_DRIVES)
                                .addView(view)
                                .addView(view2)
                                .addView(view3)
                                .addView(google.picker.ViewId.RECENTLY_PICKED)
                                .setTitle(mxResources.get('pickFolder'))
                                .setCallback(mxUtils.bind(this, function (data) {
                                    if (data.action == google.picker.Action.PICKED ||
                                        data.action == google.picker.Action.CANCEL) {
                                        mxEvent.removeListener(document, 'click', exit);
                                    }

                                    this.folderPickerCallback(data);
                                })).build();
                        }

                        mxEvent.addListener(document, 'click', exit);
                        this[name].setVisible(true);
                    } catch (e) {
                        this.ui.spinner.stop();
                        this.ui.handleError(e);
                    }
                }));
            }
        } catch (e) {
            this.ui.handleError(e);
        }
    });

    if (force) {
        showPicker();
    } else {
        this.ui.confirm(mxResources.get('useRootFolder'), mxUtils.bind(this, function () {
            this.folderPickerCallback({
                action: google.picker.Action.PICKED,
                docs: [{type: 'folder', id: 'root'}]
            });
        }), mxUtils.bind(this, function () {
            showPicker();
        }), mxResources.get('yes'), mxResources.get('noPickFolder') + '...', true);
    }
};

/**
 * Translates this point by the given vector.
 *
 * @param {number} dx X-coordinate of the translation.
 * @param {number} dy Y-coordinate of the translation.
 */
DriveClient.prototype.pickLibrary = function (fn) {
    this.filePickerCallback = fn;

    this.filePicked = mxUtils.bind(this, function (data) {
        if (data.action == google.picker.Action.PICKED) {
            this.filePickerCallback(data.docs[0].id);
        } else if (data.action == google.picker.Action.CANCEL && this.ui.getCurrentFile() == null) {
            this.ui.showSplash();
        }
    });

    if (this.ui.spinner.spin(document.body, mxResources.get('authorizing'))) {
        this.execute(mxUtils.bind(this, function () {
            try {
                this.ui.spinner.stop();

                // Click on background closes dialog as workaround for blocking dialog
                // states such as 401 where the dialog cannot be closed and blocks UI
                var exit = mxUtils.bind(this, function (evt) {
                    // Workaround for click from appIcon on second call
                    if (mxEvent.getSource(evt).className == 'picker modal-dialog-bg picker-dialog-bg') {
                        mxEvent.removeListener(document, 'click', exit);
                        this.libraryPicker.setVisible(false);
                    }
                });

                // Reuses picker as long as token doesn't change
                var token = gapi.auth.getToken().access_token;

                if (this.libraryPicker == null || this.libraryPickerToken != token) {
                    // FIXME: Dispose not working
                    //				if (this[name] != null)
                    //				{
                    //					console.log(name, this[name]);
                    //					this[name].dispose();
                    //				}

                    this.libraryPickerToken = token;

                    // Pseudo-hierarchical directory view, see
                    // https://groups.google.com/forum/#!topic/google-picker-api/FSFcuJe7icQ
                    var view = new google.picker.DocsView(google.picker.ViewId.FOLDERS)
                        .setParent('root')
                        .setIncludeFolders(true)
                        .setMimeTypes(this.libraryMimeType + ',application/xml,text/plain,application/octet-stream');

                    var view2 = new google.picker.DocsView()
                        .setIncludeFolders(true)
                        .setMimeTypes(this.libraryMimeType + ',application/xml,text/plain,application/octet-stream');

                    var view3 = new google.picker.DocsView()
                        .setEnableTeamDrives(true)
                        .setIncludeFolders(true)
                        .setMimeTypes(this.libraryMimeType + ',application/xml,text/plain,application/octet-stream');

                    var view4 = new google.picker.DocsUploadView()
                        .setIncludeFolders(true);

                    this.libraryPicker = new google.picker.PickerBuilder()
                        .setOAuthToken(this.libraryPickerToken)
                        .setLocale(mxLanguage)
                        .setAppId(this.appId)
                        .enableFeature(google.picker.Feature.SUPPORT_TEAM_DRIVES)
                        .addView(view)
                        .addView(view2)
                        .addView(view3)
                        .addView(google.picker.ViewId.RECENTLY_PICKED)
                        .addView(view4)
                        .setCallback(mxUtils.bind(this, function (data) {
                            if (data.action == google.picker.Action.PICKED ||
                                data.action == google.picker.Action.CANCEL) {
                                mxEvent.removeListener(document, 'click', exit);
                            }

                            if (data.action == google.picker.Action.PICKED) {
                                this.filePicked(data);
                            }
                        })).build();
                }

                mxEvent.addListener(document, 'click', exit);
                this.libraryPicker.setVisible(true);
            } catch (e) {
                this.ui.spinner.stop();
                this.ui.handleError(e);
            }
        }));
    }
};

/**
 * Translates this point by the given vector.
 *
 * @param {number} dx X-coordinate of the translation.
 * @param {number} dy Y-coordinate of the translation.
 */
DriveClient.prototype.showPermissions = function (id) {
    var fallback = mxUtils.bind(this, function () {
        var dlg = new ConfirmDialog(this.ui, mxResources.get('googleSharingNotAvailable'), mxUtils.bind(this, function () {
            this.ui.editor.graph.openLink('https://drive.google.com/open?id=' + id);
        }), null, mxResources.get('open'), null, null, null, null, IMAGE_PATH + '/google-share.png');
        this.ui.showDialog(dlg.container, 360, 190, true, true);
        dlg.init();
    });

    if (this.sharingFailed) {
        fallback();
    } else {
        this.checkToken(mxUtils.bind(this, function () {
            try {
                var shareClient = new gapi.drive.share.ShareClient(this.appId);
                shareClient.setOAuthToken(gapi.auth.getToken().access_token);
                shareClient.setItemIds([id]);
                shareClient.showSettingsDialog();

                // Workaround for https://stackoverflow.com/questions/54753169 is to check
                // if "sharing is unavailable" is showing and invoke a fallback dialog
                if ('MutationObserver' in window) {
                    if (this.sharingObserver != null) {
                        this.sharingObserver.disconnect();
                        this.sharingObserver = null;
                    }

                    // Tries again even if observer was still around as the user may have
                    // closed the dialog while waiting. TODO: Find condition to disconnect
                    // observer when dialog is closed (use removedNodes?).
                    this.sharingObserver = new MutationObserver(mxUtils.bind(this, function (mutations) {
                        var done = false;

                        for (var i = 0; i < mutations.length; i++) {
                            for (var j = 0; j < mutations[i].addedNodes.length; j++) {
                                var child = mutations[i].addedNodes[j];

                                if (child.nodeName == 'BUTTON' && child.getAttribute('name') == 'ok' &&
                                    child.parentNode != null && child.parentNode.parentNode != null &&
                                    child.parentNode.parentNode.getAttribute('role') == 'dialog') {
                                    this.sharingFailed = true;
                                    child.click();
                                    fallback();
                                    done = true;
                                } else if (child.nodeName == 'DIV' && child.className == 'shr-q-shr-r-shr-xb') {
                                    done = true;
                                }
                            }
                        }

                        if (done) {
                            this.sharingObserver.disconnect();
                            this.sharingObserver = null;
                        }

                    }));

                    this.sharingObserver.observe(document, {childList: true, subtree: true});
                }
            } catch (e) {
                this.ui.handleError(e);
            }
        }));
    }
};

/**
 * Converts the given file from realtime to XML.
 */
DriveClient.prototype.getRealtimeAge = function (desc, json) {
    var mod = (json != null && json.value != null && json.value.modifiedDate != null) ?
        json.value.modifiedDate.json : null;
    var result = 0;

    if (mod != null && mod > 0) {
        var ts = new Date(desc.modifiedDate);
        var rt = new Date(mod);
        result = ts.getTime() - rt.getTime();
    }

    return result;
};

/**
 * Converts the given file from realtime to XML.
 */
DriveClient.prototype.convertRealtimeFile = function (desc, success, error) {
    var xmlSuccess = mxUtils.bind(this, function (file) {
        file.convertedFrom = 'xml';
        success(file);
    });

    var jsonSuccess = mxUtils.bind(this, function (file) {
        file.convertedFrom = 'json';
        success(file);
    });

    this.getRealtimeData(desc.id, mxUtils.bind(this, function (json) {
        try {
            var age = this.getRealtimeAge(desc, json);

            // Uses realtime if newer or less than 5 minutes old
            if (age < 300000) {
                jsonSuccess(new DriveFile(this.ui, mxUtils.getXml(
                    this.convertJsonToXml(json)), desc));
            } else {
                this.getXmlFile(desc, xmlSuccess, mxUtils.bind(this, function () {
                    try {
                        jsonSuccess(new DriveFile(this.ui, mxUtils.getXml(
                            this.convertJsonToXml(json)), desc));

                    } catch (e) {
                        this.getXmlFile(desc, xmlSuccess, error);
                    }
                }));
            }
        } catch (e) {
            this.getXmlFile(desc, xmlSuccess, error);
        }
    }), mxUtils.bind(this, function () {
        this.getXmlFile(desc, xmlSuccess, error);
    }));
};

/**
 * Returns the location as a new object.
 */
DriveClient.prototype.convertJsonToXml = function (json, uncompressed) {
    if (json.value == null || json.value.diagrams == null) {
        throw Error('Invalid JSON: no diagrams in root map');
    } else {
        var node = mxUtils.createXmlDocument().createElement('mxfile');
        var diagrams = json.value.diagrams.value;

        for (var i = 0; i < diagrams.length; i++) {
            try {
                var diagramNode = this.decodeJsonPage(diagrams[i].value,
                    node.ownerDocument.createElement('diagram'),
                    uncompressed);

                //if (diagramNode.getAttribute('name') == null)
                //{
                // TODO: Should only use when converting but not when comparing
                //diagramNode.setAttribute('name', mxResources.get('pageWithNumber', [i + 1]));
                //}

                node.appendChild(diagramNode);
            } catch (e) {
                throw Error('Error on page ' + i + ': ' + e.stack);
            }
        }

        //console.log('leaving convertJson', mxUtils.getPrettyXml(node));

        return node;
    }
};

/**
 * Returns true if copy, export and print are not allowed for this file.
 */
DriveClient.prototype.decodeJsonPage = function (json, node, uncompressed) {
    if (json == null) {
        throw Error('Invalid JSON: json for page is null');
    } else {
        var codec = new mxCodec();
        var root = this.createJsonCell(json.root, codec);

        if (root == null) {
            throw Error('Invalid JSON: no root cell for page');
        } else {
            // Dummy model for encoding
            var modelNode = codec.encode(new mxGraphModel(root));
            this.decodeJsonViewState(json, modelNode);

            if (uncompressed) {
                node.appendChild(modelNode);
            } else {
                mxUtils.setTextContent(node, Graph.compressNode(modelNode));
            }

            // Adds attributes to diagram node
            if (json.id != null) {
                node.setAttribute('id', json.id.json);
            } else {
                // Workaround for missing page ID in JSON
                node.setAttribute('id', Editor.guid());
            }

            if (json.name != null) {
                node.setAttribute('name', json.name.json);
            }
        }
    }

    //console.log('decoded json page', json, node);

    return node;
};

/**
 * Writes the view state to the given node.
 */
DriveClient.prototype.decodeJsonViewState = function (json, node) {
    // Page format is stored as "width,height"
    var pf = (json.pageFormat != null) ? json.pageFormat.json : null;

    if (pf != null && pf.length > 0) {
        var values = pf.split(',');

        if (values.length > 1) {
            node.setAttribute('pageWidth', values[0]);
            node.setAttribute('pageHeight', values[1]);
        }
    }

    var bg = (json.backgroundColor != null) ? json.backgroundColor.json : null;

    if (bg != null && bg.length > 0) {
        node.setAttribute('background', bg);
    }

    var img = (json.backgroundImage != null) ? json.backgroundImage.json : null;

    if (img != null && img.length > 0) {
        node.setAttribute('backgroundImage', img);
    }

    node.setAttribute('fold', (json.foldingEnabled != null) ? json.foldingEnabled.json : '0');
    node.setAttribute('pageScale', (json.pageScale != null) ? json.pageScale.json : mxGraph.prototype.pageScale);
    node.setAttribute('math', (json.mathEnabled != null) ? json.mathEnabled.json : '0');
    node.setAttribute('shadow', (json.shadowVisible != null) ? json.shadowVisible.json : '0');

    return node;
};

/**
 * Syncs initial state from collab model to graph model.
 */
DriveClient.prototype.createJsonCell = function (json, codec) {
    if (json != null && json.id != null) {
        var val = json.value;
        var cell = this.jsonToCell(val, codec);
        codec.putObject(json.id, cell);

        cell.source = (val.source != null) ? this.createJsonCell(val.source, codec) : null;
        cell.target = (val.target != null) ? this.createJsonCell(val.target, codec) : null;

        // Cells can be serialized as parents of terminals
        this.createJsonCell(val.parent, codec)

        for (var i = 0; i < val.children.value.length; i++) {
            var child = this.createJsonCell(val.children.value[i], codec);

            if (child != null) {
                cell.insert(child);
            } else {
                throw Error('Invalid JSON: no child ' + i + ' for cell ' + json.id);
            }
        }

        return cell;
    } else if (json != null && json.ref != null) {
        return codec.objects[json.ref];
    } else {
        return null;
    }
};

/**
 * Adds the listener for automatically saving the diagram for local changes.
 */
DriveClient.prototype.jsonToCell = function (val, codec) {
    var cell = new mxCell();

    cell.id = val.cellId.json;
    cell.vertex = val.type.json == 'vertex';
    cell.edge = val.type.json == 'edge';
    cell.connectable = val.connectable.json != '0';
    cell.collapsed = val.collapsed.json == '1';
    cell.visible = val.visible.json != '0';
    cell.style = (val.style != null) ? val.style.json : null;
    cell.value = (val.xmlValue != null) ?
        mxUtils.parseXml(val.xmlValue.json).documentElement :
        ((val.value != null) ? val.value.json : null);
    cell.geometry = (val.geometry != null) ?
        codec.decode(mxUtils.parseXml(val.geometry.json).documentElement) : null;

    return cell;
};

/**
 * Invokes the given function if the user has writeable realtime files
 * that must be converted.
 */
DriveClient.prototype.checkRealtimeFiles = function (fn) {
    var email = (this.user != null && this.user.email != null) ? this.user.email : null;

    this.executeRequest(gapi.client.drive.files.list({
        'maxResults': 1, 'q':
            'mimeType=\'application/vnd.jgraph.mxfile.realtime\'' +
            ((email != null) ? ' and \'' + email + '\' in writers' : ''),
        'includeTeamDriveItems': true, 'supportsTeamDrives': true
    }), mxUtils.bind(this, function (res) {
        if (res != null && (res.nextPageToken != null || (res.items != null && res.items.length > 0))) {
            fn();
        }
    }));
};

/**
 * Converts all old realtime files. Invoke this using
 * https://www.draw.io/?mode=google&convert-realtime=1
 */
DriveClient.prototype.convertRealtimeFiles = function () {
    var output = document.createElement('div');
    output.style.cssText = 'position:absolute;top:0px;left:0px;right:0px;bottom:0px;padding:8px;' +
        'background:#ffffff;z-index:2;overflow:auto;white-space:nowrap;line-height:1.5em;';
    document.body.appendChild(output);
    var t0 = Date.now();

    var print = mxUtils.bind(this, function (msg, noBr) {
        output.innerHTML += msg + ((noBr) ? '' : '<br>');
        output.scrollTop = output.scrollHeight;
    });

    if (App.GOOGLE_REALTIME_EOL - Date.now() < 0) {
        print('draw.io (' + EditorUi.VERSION + '): Google Realtime API export endpoint no longer available');
    } else {
        print('draw.io (' + EditorUi.VERSION + ') is searching files to be converted...');
        print('<a href="https://desk.draw.io/support/solutions/articles/16000092210" target="_blank">Click here for help</a>');

        if (this.ui.spinner.spin(document.body, 'Searching files...')) {
            this.checkToken(mxUtils.bind(this, function () {
                var convertDelay = 2000;
                var convertedIds = {};
                var converted = 0;
                var fromJson = 0;
                var fromXml = 0;
                var loadFail = 0;
                var invalid = 0;
                var saveFail = 0;
                var failed = 0;
                var total = 0;
                var queryFail = 0;

                var email = (this.user != null && this.user.email != null) ? this.user.email : null;
                var q = 'mimeType=\'application/vnd.jgraph.mxfile.realtime\'' +
                    ((email != null) ? ' and \'' + email + '\' in writers' : '');

                var done = mxUtils.bind(this, function () {
                    this.ui.spinner.stop();
                    print('<br>Conversion complete. Successfully converted ' + converted + ' file(s).', true);

                    if (failed > 0) {
                        print(' Failed to convert ' + failed + ' file(s).<br><br><b>ACTION REQUIRED:</b><br><ul><li>Click ' +
                            '<a target="_blank" href="https://drive.google.com/drive/u/0/search?q=type:application/vnd.jgraph.mxfile.realtime">here</a> ' +
                            'to list all affected files</li><li>Open each file in turn by right-clicking the file and selecting open with draw.io</li>' +
                            '<li>Open each file in turn. When loaded, select File->Save</li></ul>');
                    } else {
                        print('<br><br>This window can now be closed.')
                    }

                    try {
                        var dt = Date.now() - t0;

                        // Logs conversion
                        EditorUi.logEvent({
                            category: 'AUTO-CONVERT',
                            action: 'total_' + total + '-done_' + converted +
                                '-fail_' + failed + '-xml_' + fromXml + '-json_' + fromJson +
                                '-load_' + loadFail + '-save_' + saveFail +
                                '-invalid_' + invalid + '-dt-' + Math.round(dt / 1000),
                            label: (this.user != null) ? ('user_' + this.user.id) : '-nouser'
                        });
                    } catch (e) {
                        // ignore
                    }
                });

                var getMessage = function (err) {
                    return (err == null) ? '' : ((err.message != null) ? err.message : ((err.error != null &&
                        err.error.message != null) ? err.error.message : ''));
                };

                var doConvert = mxUtils.bind(this, function () {
                    if (this.ui.spinner.spin(document.body, 'Converting ' + total + ' file(s)')) {
                        print('Found ' + total + ' file(s). This will take up to ' + Math.ceil((total * (convertDelay + 3000)) / 60000) +
                            ' minute(s). <b>Please do not close this window!</b><br>');
                        var counter = 0;

                        // Does not show picker if there are no folders in the root
                        var nextPage = mxUtils.bind(this, function (token, delay) {
                            var query = {
                                'maxResults': 1,
                                'q': q,
                                'includeTeamDriveItems': true,
                                'supportsTeamDrives': true
                            };

                            if (token != null) {
                                query.pageToken = token;
                            }

                            var acceptResponse = true;

                            var timeoutThread = window.setTimeout(mxUtils.bind(this, function () {
                                acceptResponse = false;
                                nextPage(token, delay);
                            }), this.ui.timeout);

                            this.executeRequest(gapi.client.drive.files.list(query), mxUtils.bind(this, function (res) {
                                window.clearTimeout(timeoutThread);

                                if (acceptResponse) {
                                    var doNextPage = mxUtils.bind(this, function () {
                                        if (res.nextPageToken != null) {
                                            nextPage(res.nextPageToken);
                                        } else {
                                            done();
                                        }
                                    });

                                    if (res != null && res.error != null) {
                                        queryFail++;

                                        if (queryFail < 4) {
                                            nextPage(token, delay);
                                        } else {
                                            this.ui.spinner.stop();
                                            print('Query for next file failed multiple times. Exiting.<br><br>This window can now be closed.');
                                        }
                                    } else if (res != null && (res.items == null || res.items.length == 0) &&
                                        res.nextPageToken != null) {
                                        // Next page can still contain results, see
                                        // https://stackoverflow.com/questions/23741845
                                        nextPage(res.nextPageToken, 10000);
                                    } else if (res != null && res.items != null && res.items.length > 0) {
                                        var fileId = res.items[0].id;
                                        this.ui.spinner.stop();
                                        counter++;

                                        if (this.ui.spinner.spin(document.body, 'Converting file ' + counter + ' of ' + total)) {
                                            print('Converting ' + counter + ' of ' + total + ': "' + mxUtils.htmlEntities(res.items[0].title) +
                                                '" (<a href="https://drive.google.com/open?id=' + fileId + '" target="_blank">' + fileId + '</a>)... ', true);

                                            window.setTimeout(mxUtils.bind(this, function () {
                                                // Exits if same file is returned twice
                                                if (convertedIds[fileId] == null) {
                                                    convertedIds[fileId] = true;

                                                    acceptResponse = true;

                                                    timeoutThread = window.setTimeout(mxUtils.bind(this, function () {
                                                        acceptResponse = false;

                                                        failed++;
                                                        loadFail++;
                                                        print('<img src="' + this.ui.editor.graph.warningImage.src + '" border="0" valign="absmiddle"/> Timeout');
                                                        doNextPage();
                                                    }), this.ui.timeout);

                                                    this.getFile(fileId, mxUtils.bind(this, function (file) {
                                                        window.clearTimeout(timeoutThread);

                                                        if (acceptResponse) {
                                                            if (file.constructor == DriveFile) {
                                                                if (file.convertedFrom == 'json') {
                                                                    fromJson++;
                                                                } else {
                                                                    fromXml++;
                                                                }

                                                                acceptResponse = true;

                                                                timeoutThread = window.setTimeout(mxUtils.bind(this, function () {
                                                                    acceptResponse = false;

                                                                    failed++;
                                                                    saveFail++;
                                                                    print('<img src="' + this.ui.editor.graph.warningImage.src + '" border="0" valign="absmiddle"/> Timeout');
                                                                    doNextPage();
                                                                }), this.ui.timeout);

                                                                this.saveFile(file, null, mxUtils.bind(this, function () {
                                                                    window.clearTimeout(timeoutThread);

                                                                    if (acceptResponse) {
                                                                        converted++;
                                                                        print('OK <img src="' + Editor.checkmarkImage + '" border="0" valign="middle"/>');
                                                                        doNextPage();
                                                                    }
                                                                }), mxUtils.bind(this, function (err) {
                                                                    window.clearTimeout(timeoutThread);

                                                                    if (acceptResponse) {
                                                                        var msg = getMessage(err);
                                                                        failed++;
                                                                        saveFail++;
                                                                        print('<img src="' + this.ui.editor.graph.warningImage.src + '" border="0" valign="absmiddle"/> ' + msg);
                                                                        doNextPage();
                                                                    }
                                                                }));
                                                            } else {
                                                                failed++;
                                                                invalid++;
                                                                print('<img src="' + this.ui.editor.graph.warningImage.src + '" border="0" valign="absmiddle"/> Invalid file');
                                                                doNextPage();
                                                            }
                                                        }
                                                    }), mxUtils.bind(this, function (err) {
                                                        window.clearTimeout(timeoutThread);

                                                        if (acceptResponse) {
                                                            var msg = getMessage(err);
                                                            failed++;
                                                            loadFail++;
                                                            print('<img src="' + this.ui.editor.graph.warningImage.src + '" border="0" valign="absmiddle"/> ' + msg);
                                                            doNextPage();
                                                        }
                                                    }));
                                                } else {
                                                    this.ui.spinner.stop();
                                                    print('Search returned duplicate file ' + fileId + '. Exiting.<br><br>This window can now be closed.');
                                                }
                                            }), (delay != null) ? delay : convertDelay)
                                        }
                                    } else {
                                        done();
                                    }
                                }
                            }));
                        });

                        nextPage();
                    }
                });

                var totals = {'maxResults': 10000, 'q': q, 'includeTeamDriveItems': true, 'supportsTeamDrives': true};

                var count = mxUtils.bind(this, function (token) {
                    if (token != null) {
                        totals.pageToken = token;
                    }

                    this.executeRequest(gapi.client.drive.files.list(totals), mxUtils.bind(this, function (res) {
                        total += (res != null && res.items != null) ? res.items.length : 0;

                        if (res.nextPageToken != null) {
                            count(res.nextPageToken);
                        } else {
                            this.ui.spinner.stop();

                            this.ui.showError('Confirm', 'You are about to convert ' + total + ' file(s)',
                                'Cancel', mxUtils.bind(this, function () {
                                    print('Cancelled by user.<br><br>This window can now be closed.');
                                }), null, 'OK', doConvert, 'Help', function () {
                                    window.open('https://desk.draw.io/support/solutions/articles/16000092210');
                                }, 340, 120);
                        }
                    }));
                });

                count();
            }));
        } else {
            this.ui.spinner.stop();
            print('Busy. <br><br>This window can now be closed.');
        }
    }
};

/**
 * Copyright (c) 2006-2019, JGraph Ltd
 * Copyright (c) 2006-2019, draw.io AG
 */

/**
 * Constructs a new point for the optional x and y coordinates. If no
 * coordinates are given, then the default values for <x> and <y> are used.
 * @constructor
 * @class Implements a basic 2D point. Known subclassers = {@link mxRectangle}.
 * @param {number} x X-coordinate of the point.
 * @param {number} y Y-coordinate of the point.
 */
App = function (editor, container, lightbox) {
    EditorUi.call(this, editor, container, (lightbox != null) ? lightbox :
        (urlParams['lightbox'] == '1' || (uiTheme == 'min' &&
            urlParams['chrome'] != '0')));

    // Logs unloading of window with modifications for Google Drive file
    if (!mxClient.IS_CHROMEAPP && !EditorUi.isElectronApp) {
        window.onunload = mxUtils.bind(this, function () {
            var file = this.getCurrentFile();

            if (file != null && file.isModified()) {
                var evt = {
                    category: 'DISCARD-FILE-' + file.getHash(),
                    action: ((file.savingFile) ? 'saving' : '') +
                        ((file.savingFile && file.savingFileTime != null) ? '_' +
                            Math.round((Date.now() - file.savingFileTime.getTime()) / 1000) : '') +
                        ((file.saveLevel != null) ? ('-sl_' + file.saveLevel) : '') +
                        '-age_' + ((file.ageStart != null) ? Math.round((Date.now() - file.ageStart.getTime()) / 1000) : 'x') +
                        ((this.editor.autosave) ? '' : '-nosave') +
                        ((file.isAutosave()) ? '' : '-noauto') +
                        '-open_' + ((file.opened != null) ? Math.round((Date.now() - file.opened.getTime()) / 1000) : 'x') +
                        '-save_' + ((file.lastSaved != null) ? Math.round((Date.now() - file.lastSaved.getTime()) / 1000) : 'x') +
                        '-change_' + ((file.lastChanged != null) ? Math.round((Date.now() - file.lastChanged.getTime()) / 1000) : 'x') +
                        '-alive_' + Math.round((Date.now() - App.startTime.getTime()) / 1000),
                    label: (file.sync != null) ? ('client_' + file.sync.clientId) : 'nosync'
                };

                if (file.constructor == DriveFile && file.desc != null && this.drive != null) {
                    evt.label += ((this.drive.user != null) ? ('-user_' + this.drive.user.id) : '-nouser') + '-rev_' +
                        file.desc.headRevisionId + '-mod_' + file.desc.modifiedDate + '-size_' + file.getSize() +
                        '-mime_' + file.desc.mimeType;
                }

                EditorUi.logEvent(evt);
            }
        });
    }

    // Logs changes to autosave
    this.editor.addListener('autosaveChanged', mxUtils.bind(this, function () {
        var file = this.getCurrentFile();

        if (file != null) {
            EditorUi.logEvent({
                category: ((this.editor.autosave) ? 'ON' : 'OFF') +
                    '-AUTOSAVE-FILE-' + file.getHash(), action: 'changed',
                label: 'autosave_' + ((this.editor.autosave) ? 'on' : 'off')
            });
        }
    }));

    // Pre-fetches images
    if (mxClient.IS_SVG) {
        mxGraph.prototype.warningImage.src = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAE7SURBVHjaYvz//z8DJQAggBjwGXDuHMP/tWuD/uPTCxBAOA0AaQRK/f/+XeJ/cbHlf1wGAAQQTgPu3QNLgfHSpZo4DQAIIKwGwGyH4e/fFbG6AiQJEEAs2Ew2NFzH8OOHBMO6dT/A/KCg7wxGRh+wuhQggDBcALMdFIAcHBxgDGJjcwVIIUAAYbhAUXEdVos4OO4DXcGBIQ4QQCguQPY7sgtgAYruCpAgQACx4LJdU1OCwctLEcyWlLwPJF+AXQE0EMUBAAEEdwF6yMOiD4RRY0QT7gqQAEAAseDzu6XldYYPH9DD4joQa8L5AAEENgWb7SBcXa0JDQMBrK4AcQACiAlfyOMCEFdAnAYQQEz4FLa0XGf4/v0H0IIPONUABBAjyBmMjIwMS5cK/L927QORbtBkaG29DtYLEGAAH6f7oq3Zc+kAAAAASUVORK5CYII=';
    } else {
        var img = new Image();
        img.src = mxGraph.prototype.warningImage.src;
    }

    // Global helper method to deal with popup blockers
    window.openWindow = mxUtils.bind(this, function (url, pre, fallback) {
        var wnd = null;

        try {
            wnd = window.open(url);
        } catch (e) {
            // ignore
        }

        if (wnd == null || wnd === undefined) {
            this.showDialog(new PopupDialog(this, url, pre, fallback).container, 320, 140, true, true);
        } else if (pre != null) {
            pre();
        }
    });

    // Initial state for toolbar items is disabled
    this.updateDocumentTitle();
    this.updateUi();

    // Global helper method to display error messages
    window.showOpenAlert = mxUtils.bind(this, function (message) {
        // Cancel must be called before showing error message
        if (window.openFile != null) {
            window.openFile.cancel(true);
        }

        this.handleError(message);
    });

    // Handles opening files via drag and drop
    if (!this.editor.chromeless || this.editor.editable) {
        this.addFileDropHandler([document]);
    }

    // Process the queue for waiting plugins
    if (App.DrawPlugins != null) {
        for (var i = 0; i < App.DrawPlugins.length; i++) {
            try {
                App.DrawPlugins[i](this);
            } catch (e) {
                if (window.console != null) {
                    console.log('Plugin Error:', e, App.DrawPlugins[i]);
                }
            } finally {
                App.embedModePluginsCount--;
            }
        }

        // Installs global callback for plugins
        window.Draw.loadPlugin = mxUtils.bind(this, function (callback) {
            try {
                callback(this);
            } finally {
                App.embedModePluginsCount--;
            }
        });

        //Set a timeout in case a plugin doesn't load quickly or doesn't load at all
        setTimeout(mxUtils.bind(this, function () {
            //Force finish loading if its not yet called
            if (App.embedModePluginsCount > 0) {
                App.embedModePluginsCount = 0;
            }
        }), 5000); //5 sec timeout
    }

    this.load();
};

/**
 * Timeout error
 */
App.ERROR_TIMEOUT = 'timeout';

/**
 * Busy error
 */
App.ERROR_BUSY = 'busy';

/**
 * Unknown error
 */
App.ERROR_UNKNOWN = 'unknown';

/**
 * Device Mode
 */
App.MODE_DEVICE = 'device';

/**
 * Browser Mode
 */
App.MODE_BROWSER = 'browser';

/**
 * Function: authorize
 *
 * Authorizes the client, gets the userId and calls <open>.
 */
App.startTime = new Date();

/**
 * Defines plugin IDs for loading via p URL parameter. Update the table at
 * https://desk.draw.io/solution/articles/16000042546
 */
App.pluginRegistry = {
    '4xAKTrabTpTzahoLthkwPNUn': '/plugins/explore.js',
    'ex': '/plugins/explore.js', 'p1': '/plugins/p1.js',
    'ac': '/plugins/connect.js', 'acj': '/plugins/connectJira.js',
    'ac148': '/plugins/cConf-1-4-8.js', 'voice': '/plugins/voice.js',
    'tips': '/plugins/tooltips.js', 'svgdata': '/plugins/svgdata.js',
    'number': '/plugins/number.js', 'sql': '/plugins/sql.js',
    'props': '/plugins/props.js', 'text': '/plugins/text.js',
    'anim': '/plugins/animation.js', 'update': '/plugins/update.js',
    'trees': '/plugins/trees/trees.js', 'import': '/plugins/import.js',
    'replay': '/plugins/replay.js', 'anon': '/plugins/anonymize.js',
    'f5': '/plugins/rackF5.js',
    'tickets': '/plugins/tickets.js', 'flow': '/plugins/flow.js',
    'webcola': '/plugins/webcola/webcola.js', 'rnd': '/plugins/random.js',
    'page': '/plugins/page.js',
    'tags': '/plugins/tags.js'
};

/**
 * Function: authorize
 *
 * Authorizes the client, gets the userId and calls <open>.
 */
App.getStoredMode = function () {
    var mode = null;

    if (mode == null && isLocalStorage) {
        mode = localStorage.getItem('.mode');
    }

    if (mode == null && typeof (Storage) != 'undefined') {
        var cookies = document.cookie.split(";");

        for (var i = 0; i < cookies.length; i++) {
            // Removes spaces around cookie
            var cookie = mxUtils.trim(cookies[i]);

            if (cookie.substring(0, 5) == 'MODE=') {
                mode = cookie.substring(5);
                break;
            }
        }

        if (mode != null && isLocalStorage) {
            // Moves to local storage
            var expiry = new Date();
            expiry.setYear(expiry.getFullYear() - 1);
            document.cookie = 'MODE=; expires=' + expiry.toUTCString();
            localStorage.setItem('.mode', mode);
        }
    }

    return mode;
};

/**
 * Static Application initializer executed at load-time.
 */
(function () {
    if (!mxClient.IS_CHROMEAPP) {
        if (urlParams['offline'] != '1') {
            App.mode = urlParams['mode'];

            if (App.mode == null) {
                // Stored mode overrides preferred mode
                App.mode = App.getStoredMode();
            }
        }
    }
})();

/**
 * Program flow starts here.
 *
 * Optional callback is called with the app instance.
 */
App.main = function (callback, createUi) {
    // Logs uncaught errors
    window.onerror = function (message, url, linenumber, colno, err) {
        EditorUi.logError(message, url, linenumber, colno, err);
    };

    // Removes info text in embed mode
    if (urlParams['lightbox'] == '1') {
        var geInfo = document.getElementById('geInfo');

        if (geInfo != null) {
            geInfo.parentNode.removeChild(geInfo);
        }
    }

    if (window.mxscript != null) {
        // Loads plugins
        if (urlParams['plugins'] != '0' && urlParams['offline'] != '1') {
            // mxSettings is not yet initialized in configure mode, redirect parameter
            // to p URL parameter in caller for plugins in embed mode
            var plugins = (mxSettings.settings != null) ? mxSettings.getPlugins() : null;

            // Configured plugins in embed mode with configure=1 URL should be loaded so we
            // look ahead here and parse the config to fetch the list of custom plugins
            if (mxSettings.settings == null && isLocalStorage && typeof (JSON) !== 'undefined') {
                try {
                    var temp = JSON.parse(localStorage.getItem(mxSettings.key));

                    if (temp != null) {
                        plugins = temp.plugins;
                    }
                } catch (e) {
                    // ignore
                }
            }

            var temp = urlParams['p'];
            App.initPluginCallback();

            if (temp != null) {
                // Mapping from key to URL in App.plugins
                App.loadPlugins(temp.split(';'));
            }

            if (plugins != null && plugins.length > 0 && urlParams['plugins'] != '0') {
                // Loading plugins inside the asynchronous block below stops the page from loading so a
                // hardcoded message for the warning dialog is used since the resources are loadd below
                var warning = 'The page has requested to load the following plugin(s):\n \n {1}\n \n Would you like to load these plugin(s) now?\n \n NOTE : Only allow plugins to run if you fully understand the security implications of doing so.\n';
                var tmp = window.location.protocol + '//' + window.location.host;
                var local = true;

                for (var i = 0; i < plugins.length && local; i++) {
                    if (plugins[i].charAt(0) != '/' && plugins[i].substring(0, tmp.length) != tmp) {
                        local = false;
                    }
                }

                if (local || mxUtils.confirm(mxResources.replacePlaceholders(warning, [plugins.join('\n')]).replace(/\\n/g, '\n'))) {
                    for (var i = 0; i < plugins.length; i++) {
                        try {
                            if (App.pluginsLoaded[plugins[i]] == null) {
                                App.pluginsLoaded[plugins[i]] = true;
                                App.embedModePluginsCount++;

                                if (plugins[i].charAt(0) == '/') {
                                    plugins[i] = PLUGINS_BASE_PATH + plugins[i];
                                }

                                mxscript(plugins[i]);
                            }
                        } catch (e) {
                            // ignore
                        }
                    }
                }
            }
        }

        window.DriveClient = null;
    }

    function doLoad(bundle) {
        // Prefetches asynchronous requests so that below code runs synchronous
        // Loading the correct bundle (one file) via the fallback system in mxResources. The stylesheet
        // is compiled into JS in the build process and is only needed for local development.
        mxUtils.getAll([bundle,
            STYLE_PATH + '/default.xml', STYLE_PATH + '/dark-default.xml'], function (xhr) {
            // Adds bundle text to resources
            mxResources.parse(xhr[0].getText());

            // Prepares themes with mapping from old default-style to old XML file
            if (xhr.length > 2) {
                Graph.prototype.defaultThemes['default-style2'] = xhr[1].getDocumentElement();
                Graph.prototype.defaultThemes['darkTheme'] = xhr[2].getDocumentElement();
            }

            // Main
            var ui = (createUi != null) ? createUi() : new App(new Editor(
                urlParams['chrome'] == '0' || uiTheme == 'min',
                null, null, null, urlParams['chrome'] != '0'));
            if (callback != null) {
                callback(ui);
            }
        }, function (xhr) {
            var st = document.getElementById('geStatus');

            if (st != null) {
                st.innerHTML = 'Error loading page. <a>Please try refreshing.</a>';

                // Tries reload with default resources in case any language resources were not available
                st.getElementsByTagName('a')[0].onclick = function () {
                    mxLanguage = 'en';
                    doLoad(mxResources.getDefaultBundle(RESOURCE_BASE, mxLanguage) ||
                        mxResources.getSpecialBundle(RESOURCE_BASE, mxLanguage));
                };
            }
        });
    };

    function doMain() {
        // Adds required resources (disables loading of fallback properties, this can only
        // be used if we know that all keys are defined in the language specific file)
        mxResources.loadDefaultBundle = false;
        doLoad(mxResources.getDefaultBundle(RESOURCE_BASE, mxLanguage) ||
            mxResources.getSpecialBundle(RESOURCE_BASE, mxLanguage));
    };

    // Optional override for autosaveDelay and defaultEdgeLength
    try {
        if (mxSettings.settings != null) {
            if (mxSettings.settings.autosaveDelay != null) {
                var val = parseInt(mxSettings.settings.autosaveDelay);

                if (!isNaN(val) && val > 0) {
                    DrawioFile.prototype.autosaveDelay = val;

                    if (window.console != null) {
                        console.log('Setting autosaveDelay to ' + DrawioFile.prototype.autosaveDelay);
                    }
                } else {
                    if (window.console != null) {
                        console.log('Invalid value for autosaveDelay');
                    }
                }
            }

            if (mxSettings.settings.defaultEdgeLength != null) {
                var val = parseInt(mxSettings.settings.defaultEdgeLength);

                if (!isNaN(val) && val > 0) {
                    Graph.prototype.defaultEdgeLength = val;

                    if (window.console != null) {
                        console.log('Setting defaultEdgeLength to ' + Graph.prototype.defaultEdgeLength);
                    }
                } else {
                    if (window.console != null) {
                        console.log('Invalid value for defaultEdgeLength');
                    }
                }
            }
        }
    } catch (e) {
        if (window.console != null) {
            console.error(e);
        }
    }

    if (window.DRAWIO_CONFIG != null) {
        try {
            Editor.configure(window.DRAWIO_CONFIG, true);
        } catch (e) {
            if (window.console != null) {
                console.log('Error in global configuration: ' + e, window.DRAWIO_CONFIG);
            }
        }
    }

    // Sends load event if configuration is requested and waits for configure action
    if (urlParams['configure'] == '1') {
        var op = window.opener || window.parent;

        var configHandler = function (evt) {
            if (evt.source == op) {
                try {
                    var data = JSON.parse(evt.data);

                    if (data != null && data.action == 'configure') {
                        mxEvent.removeListener(window, 'message', configHandler);
                        Editor.configure(data.config, true);
                        mxSettings.load();
                        doMain();
                    }
                } catch (e) {
                    if (window.console != null) {
                        console.log('Error in configuration: ' + e);
                    }
                }
            }
        };

        // Receives XML message from opener and puts it into the graph
        mxEvent.addListener(window, 'message', configHandler);
        op.postMessage(JSON.stringify({event: 'configure'}), '*');
    } else {
        doMain();
    }
};

//Extends EditorUi
mxUtils.extend(App, EditorUi);

/**
 *
 */
App.prototype.shareImage = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2RpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDowOTgwMTE3NDA3MjA2ODExODhDNkFGMDBEQkQ0RTgwOSIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDoxMjU2NzdEMTcwRDIxMUUxQjc0MDkxRDhCNUQzOEFGRCIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDoxMjU2NzdEMDcwRDIxMUUxQjc0MDkxRDhCNUQzOEFGRCIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IFdpbmRvd3MiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDowNjgwMTE3NDA3MjA2ODExODcxRkM4MUY1OTFDMjQ5OCIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDowNzgwMTE3NDA3MjA2ODExODhDNkFGMDBEQkQ0RTgwOSIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PrM/fs0AAADgSURBVHjaYmDAA/7//88MwgzkAKDGFiD+BsQ/QWxSNaf9RwN37twpI8WAS+gGfP78+RpQSoRYA36iG/D379+vQClNdLVMOMz4gi7w79+/n0CKg1gD9qELvH379hzIHGK9oA508ieY8//8+fO5rq4uFCilRKwL1JmYmNhhHEZGRiZ+fn6Q2meEbDYG4u3/cYCfP38uA7kOm0ZOIJ7zn0jw48ePPiDFhmzArv8kgi9fvuwB+w5qwH9ykjswbFSZyM4sEMDPBDTlL5BxkFSd7969OwZ2BZKYGhDzkmjOJ4AAAwBhpRqGnEFb8QAAAABJRU5ErkJggg==';

/**
 *
 */
App.prototype.chevronUpImage = (!mxClient.IS_SVG) ? IMAGE_PATH + '/chevron-up.png' : 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAMAAAAoLQ9TAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyJpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBNYWNpbnRvc2giIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6NDg2NEE3NUY1MUVBMTFFM0I3MUVEMTc0N0YyOUI4QzEiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6NDg2NEE3NjA1MUVBMTFFM0I3MUVEMTc0N0YyOUI4QzEiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDo0ODY0QTc1RDUxRUExMUUzQjcxRUQxNzQ3RjI5QjhDMSIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDo0ODY0QTc1RTUxRUExMUUzQjcxRUQxNzQ3RjI5QjhDMSIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/Pg+qUokAAAAMUExURQAAANnZ2b+/v////5bgre4AAAAEdFJOU////wBAKqn0AAAAL0lEQVR42mJgRgMMRAswMKAKMDDARBjg8lARBoR6KImkH0wTbygT6YaS4DmAAAMAYPkClOEDDD0AAAAASUVORK5CYII=';

/**
 *
 */
App.prototype.chevronDownImage = (!mxClient.IS_SVG) ? IMAGE_PATH + '/chevron-down.png' : 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAMAAAAoLQ9TAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyJpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBNYWNpbnRvc2giIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6NDg2NEE3NUI1MUVBMTFFM0I3MUVEMTc0N0YyOUI4QzEiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6NDg2NEE3NUM1MUVBMTFFM0I3MUVEMTc0N0YyOUI4QzEiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDo0ODY0QTc1OTUxRUExMUUzQjcxRUQxNzQ3RjI5QjhDMSIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDo0ODY0QTc1QTUxRUExMUUzQjcxRUQxNzQ3RjI5QjhDMSIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PsCtve8AAAAMUExURQAAANnZ2b+/v////5bgre4AAAAEdFJOU////wBAKqn0AAAALUlEQVR42mJgRgMMRAkwQEXBNAOcBSPhclB1cNVwfcxI+vEZykSpoSR6DiDAAF23ApT99bZ+AAAAAElFTkSuQmCC';

/**
 *
 */
App.prototype.formatShowImage = (!mxClient.IS_SVG) ? IMAGE_PATH + '/format-show.png' : 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAMAAAAoLQ9TAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyJpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBNYWNpbnRvc2giIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6ODdCREY5REY1NkQ3MTFFNTkyNjNEMTA5NjgwODUyRTgiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6ODdCREY5RTA1NkQ3MTFFNTkyNjNEMTA5NjgwODUyRTgiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDo4N0JERjlERDU2RDcxMUU1OTI2M0QxMDk2ODA4NTJFOCIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDo4N0JERjlERTU2RDcxMUU1OTI2M0QxMDk2ODA4NTJFOCIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PlnMQ/8AAAAJUExURQAAAP///3FxcTfTiAsAAAACdFJOU/8A5bcwSgAAACFJREFUeNpiYEQDDEQJMMABTAAixcQ00ALoDiPRcwABBgB6DADly9Yx8wAAAABJRU5ErkJggg==';

/**
 *
 */
App.prototype.formatHideImage = (!mxClient.IS_SVG) ? IMAGE_PATH + '/format-hide.png' : 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAMAAAAoLQ9TAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyJpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBNYWNpbnRvc2giIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6ODdCREY5REI1NkQ3MTFFNTkyNjNEMTA5NjgwODUyRTgiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6ODdCREY5REM1NkQ3MTFFNTkyNjNEMTA5NjgwODUyRTgiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDo4N0JERjlEOTU2RDcxMUU1OTI2M0QxMDk2ODA4NTJFOCIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDo4N0JERjlEQTU2RDcxMUU1OTI2M0QxMDk2ODA4NTJFOCIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PqjT9SMAAAAGUExURQAAAP///6XZn90AAAACdFJOU/8A5bcwSgAAAB9JREFUeNpiYEQDDEQJMMABTAAmNdAC6A4j0XMAAQYAcbwA1Xvj1CgAAAAASUVORK5CYII=';

/**
 *
 */
App.prototype.fullscreenImage = (!mxClient.IS_SVG) ? IMAGE_PATH + '/fullscreen.png' : 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQAQMAAAAlPW0iAAAABlBMVEUAAAAAAAClZ7nPAAAAAXRSTlMAQObYZgAAABpJREFUCNdjgAAbGxAy4AEh5gNwBBGByoIBAIueBd12TUjqAAAAAElFTkSuQmCC';

/**
 * Interval to show dialog for unsaved data if autosave is on.
 * Default is 300000 (5 minutes).
 */
App.prototype.warnInterval = 300000;

/**
 * Overriden UI settings depending on mode.
 */
if (urlParams['embed'] != '1') {
    App.prototype.menubarHeight = 64;
} else {
    App.prototype.footerHeight = 0;
}

/**
 * Queue for loading plugins and wait for UI instance
 */
App.initPluginCallback = function () {
    if (App.DrawPlugins == null) {
        // Workaround for need to load plugins now but wait for UI instance
        App.DrawPlugins = [];

        // Global entry point for plugins is Draw.loadPlugin. This is the only
        // long-term supported solution for access to the EditorUi instance.
        window.Draw = new Object();
        window.Draw.loadPlugin = function (callback) {
            App.DrawPlugins.push(callback);
        };
    }
};

/**
 *
 */
App.pluginsLoaded = {};
App.embedModePluginsCount = 0;

/**
 * Queue for loading plugins and wait for UI instance
 */
App.loadPlugins = function (plugins, useInclude) {
    for (var i = 0; i < plugins.length; i++) {
        if (plugins[i] != null && plugins[i].length > 0) {
            try {
                var url = App.pluginRegistry[plugins[i]];

                if (url != null) {
                    if (App.pluginsLoaded[url] == null) {
                        App.pluginsLoaded[url] = true;
                        App.embedModePluginsCount++;

                        if (typeof window.drawDevUrl === 'undefined') {
                            if (useInclude) {
                                mxinclude(url);
                            } else {
                                mxscript(url);
                            }
                        } else {
                            if (useInclude) {
                                mxinclude(url);
                            } else {
                                mxscript(drawDevUrl + url);
                            }
                        }
                    }
                } else if (window.console != null) {
                    console.log('Unknown plugin:', plugins[i]);
                }
            } catch (e) {
                if (window.console != null) {
                    console.log('Error loading plugin:', plugins[i], e);
                }
            }
        }
    }
};

/**
 * TODO: Define viewer protocol and implement new viewer style toolbar
 */
App.prototype.initializeViewerMode = function () {
    var parent = window.opener || window.parent;

    if (parent != null) {
        this.editor.graph.addListener(mxEvent.SIZE, mxUtils.bind(this, function () {
            parent.postMessage(JSON.stringify(this.createLoadMessage('size')), '*');
        }));
    }
};

/**
 * Translates this point by the given vector.
 *
 * @param {number} dx X-coordinate of the translation.
 * @param {number} dy Y-coordinate of the translation.
 */
App.prototype.init = function () {
    EditorUi.prototype.init.apply(this, arguments);

    /**
     * Specifies the default filename.
     */
    this.defaultLibraryName = mxResources.get('untitledLibrary');

    /**
     * Holds the listener for description changes.
     */
    this.descriptorChangedListener = mxUtils.bind(this, this.descriptorChanged);

    var createFooter = mxUtils.bind(this, function (label, link, className, closeHandler, helpLink) {
        var footer = document.createElement('div');
        footer.style.cssText = 'position:absolute;bottom:0px;max-width:90%;padding:10px;padding-right:26px;' +
            'white-space:nowrap;left:50%;bottom:2px;';
        footer.className = className;

        var icn = ((className == 'geStatusAlert') ? '<img src="' + mxClient.imageBasePath + '/warning.gif" border="0" ' +
            'style="margin-top:-4px;margin-right:8px;margin-left:8px;" valign="middle"/>' : '');

        mxUtils.setPrefixedStyle(footer.style, 'transform', 'translate(-50%,110%)');
        mxUtils.setPrefixedStyle(footer.style, 'transition', 'all 1s ease');
        footer.style.whiteSpace = 'nowrap';
        footer.innerHTML = '<a href="' + link +
            '" target="_blank" style="display:inline;text-decoration:none;font-weight:700;font-size:13px;opacity:1;">' +
            icn + label + icn + '</a>' + ((helpLink != null) ? '<a href="' + helpLink +
                '" target="_blank" style="display:inline;text-decoration:none;font-weight:700;font-size:13px;opacity:1;margin-right:8px;">Help</a>' : '');

        var img = document.createElement('img');

        img.setAttribute('src', Dialog.prototype.closeImage);
        img.setAttribute('title', mxResources.get('close'));
        img.style.position = 'absolute';
        img.style.cursor = 'pointer';
        img.style.right = '10px';
        img.style.top = '12px';

        footer.appendChild(img);

        if (closeHandler) {
            mxEvent.addListener(img, 'click', closeHandler);
        }

        return footer;
    });

    if (urlParams['embed'] != '1') {
        /**
         * Holds the background element.
         */
        this.bg = this.createBackground();
        document.body.appendChild(this.bg);
        this.diagramContainer.style.visibility = 'hidden';
        this.formatContainer.style.visibility = 'hidden';
        this.hsplit.style.display = 'none';
        this.sidebarContainer.style.display = 'none';
        this.sidebarFooterContainer.style.display = 'none';

        // Sets the initial mode
        if (urlParams['local'] == '1') {
            this.setMode(App.MODE_DEVICE);
        } else {
            this.mode = App.mode;
        }

        if (!mxClient.IS_CHROMEAPP && !EditorUi.isElectronApp && urlParams['embed'] != '1' &&
            urlParams['stealth'] != '1' && urlParams['offline'] != '1' &&
            (!this.editor.chromeless || this.editor.editable)) {
            // Checks if the cache is alive
            var acceptResponse = true;

            var timeoutThread = window.setTimeout(mxUtils.bind(this, function () {
                acceptResponse = false;
                EditorUi.logEvent({category: 'TIMEOUT-CACHE-CHECK', action: 'timeout', label: 408});
            }), this.timeout);

            var t0 = new Date().getTime();

            mxUtils.get(EditorUi.cacheUrl + '?alive', mxUtils.bind(this, function (req) {
                window.clearTimeout(timeoutThread);

//				if (acceptResponse)
//				{
//					EditorUi.logEvent({category: 'ALIVE-CACHE-CHECK', action: 'alive', label:
//						req.getStatus() + '.' + (new Date().getTime() - t0)});
//				}
            }));

            this.editor.addListener('fileLoaded', mxUtils.bind(this, function () {
                var file = this.getCurrentFile();

                if (file.mode == App.MODE_DEVICE && (!isLocalStorage || mxSettings.settings == null ||
                    mxSettings.settings.closeDesktopFooter == null) &&
                    (!this.editor.chromeless || this.editor.editable) &&
                    !this.footerShowing && urlParams['open'] == null) {
                    var footer = createFooter(mxResources.get('downloadDesktop') + '...',
                        'https://get.draw.io/',
                        'geStatusMessage',
                        mxUtils.bind(this, function () {
                            footer.parentNode.removeChild(footer);
                            this.hideFooter();

                            // Close permanently
                            if (isLocalStorage && mxSettings.settings != null) {
                                mxSettings.settings.closeDesktopFooter = Date.now();
                                mxSettings.save();
                            }
                        }));

                    document.body.appendChild(footer);
                    this.footerShowing = true;

                    window.setTimeout(mxUtils.bind(this, function () {
                        mxUtils.setPrefixedStyle(footer.style, 'transform', 'translate(-50%,0%)');
                    }), 1500);

                    window.setTimeout(mxUtils.bind(this, function () {
                        mxUtils.setPrefixedStyle(footer.style, 'transform', 'translate(-50%,110%)');
                        this.footerShowing = false;
                    }), 15000);
                }
            }));
        }
    } else if (this.menubar != null) {
        this.menubar.container.style.paddingTop = '0px';
    }

    this.updateHeader();

    if (this.menubar != null) {
        this.buttonContainer = document.createElement('div');
        this.buttonContainer.style.display = 'inline-block';
        this.buttonContainer.style.paddingRight = '48px';
        this.buttonContainer.style.position = 'absolute';
        this.buttonContainer.style.right = '0px';

        this.menubar.container.appendChild(this.buttonContainer);
    }

    if (uiTheme == 'atlas' && this.menubar != null) {
        if (this.toggleElement != null) {
            this.toggleElement.click();
            this.toggleElement.style.display = 'none';
        }

        this.icon = document.createElement('img');
        this.icon.setAttribute('src', IMAGE_PATH + '/janus-logo-circle.png');
        this.icon.setAttribute('title', mxResources.get('draw.io'));
        this.icon.style.width = '35px';
        this.icon.style.padding = '6px';
        this.icon.style.cursor = 'pointer';

        mxEvent.addListener(this.icon, 'click', mxUtils.bind(this, function (evt) {
            this.appIconClicked(evt);
        }));

        if (mxClient.IS_QUIRKS) {
            this.icon.style.marginTop = '12px';
        }

        this.menubar.container.insertBefore(this.icon, this.menubar.container.firstChild);
    }

    if (this.editor.graph.isViewer()) {
        this.initializeViewerMode();
    }
};

App.prototype.scheduleSanityCheck = function () {
    if (this.sanityCheckThread == null) {
        this.sanityCheckThread = window.setTimeout(mxUtils.bind(this, function () {
            this.sanityCheckThread = null;
            this.sanityCheck();
        }), this.warnInterval);
    }
};

App.prototype.stopSanityCheck = function () {
    if (this.sanityCheckThread != null) {
        window.clearTimeout(this.sanityCheckThread);
        this.sanityCheckThread = null;
    }
};

App.prototype.sanityCheck = function () {
    var file = this.getCurrentFile();

    if (file != null && file.isModified() && file.isAutosave() && file.isOverdue()) {
        var evt = {
            category: 'WARN-FILE-' + file.getHash(),
            action: ((file.savingFile) ? 'saving' : '') +
                ((file.savingFile && file.savingFileTime != null) ? '_' +
                    Math.round((Date.now() - file.savingFileTime.getTime()) / 1000) : '') +
                ((file.saveLevel != null) ? ('-sl_' + file.saveLevel) : '') +
                '-age_' + ((file.ageStart != null) ? Math.round((Date.now() - file.ageStart.getTime()) / 1000) : 'x') +
                ((this.editor.autosave) ? '' : '-nosave') +
                ((file.isAutosave()) ? '' : '-noauto') +
                '-open_' + ((file.opened != null) ? Math.round((Date.now() - file.opened.getTime()) / 1000) : 'x') +
                '-save_' + ((file.lastSaved != null) ? Math.round((Date.now() - file.lastSaved.getTime()) / 1000) : 'x') +
                '-change_' + ((file.lastChanged != null) ? Math.round((Date.now() - file.lastChanged.getTime()) / 1000) : 'x') +
                '-alive_' + Math.round((Date.now() - App.startTime.getTime()) / 1000),
            label: (file.sync != null) ? ('client_' + file.sync.clientId) : 'nosync'
        };

        if (file.constructor == DriveFile && file.desc != null && this.drive != null) {
            evt.label += ((this.drive.user != null) ? ('-user_' + this.drive.user.id) : '-nouser') + '-rev_' +
                file.desc.headRevisionId + '-mod_' + file.desc.modifiedDate + '-size_' + file.getSize() +
                '-mime_' + file.desc.mimeType;
        }

        EditorUi.logEvent(evt);

        var msg = mxResources.get('ensureDataSaved');

        if (file.lastSaved != null) {
            var str = this.timeSince(file.lastSaved);

            if (str == null) {
                str = mxResources.get('lessThanAMinute');
            }

            msg = mxResources.get('lastSaved', [str]);
        }

        this.showError(mxResources.get('unsavedChanges'), msg, mxResources.get('ignore'),
            mxUtils.bind(this, function () {
                this.hideDialog();
            }), null, mxResources.get('save'), mxUtils.bind(this, function () {
                this.stopSanityCheck();
                this.actions.get((this.mode == null || !file.isEditable()) ?
                    'saveAs' : 'save').funct();
            }), null, null, 360, 120, null, mxUtils.bind(this, function () {
                this.scheduleSanityCheck();
            }));
    }
};

/**
 * Returns true if the current domain is for the new drive app.
 */
App.prototype.isDriveDomain = function () {
    return urlParams['drive'] != '0' &&
        (window.location.hostname == 'test.draw.io' ||
            window.location.hostname == 'www.draw.io' ||
            window.location.hostname == 'drive.draw.io' ||
            window.location.hostname == 'jgraph.github.io');
};

/**
 * Returns true if the current domain is for the new drive app.
 */
App.prototype.handleLicense = function (lic, domain) {
    if (lic != null && lic.plugins != null) {
        App.loadPlugins(lic.plugins.split(';'), true);
    }
};

/**
 *
 */
App.prototype.getEditBlankXml = function () {
    var file = this.getCurrentFile();

    if (file != null && this.editor.isChromelessView() && this.editor.graph.isLightboxView()) {
        return file.getData();
    } else {
        return this.getFileData(true);
    }
};

/**
 * Updates action states depending on the selection.
 */
App.prototype.updateActionStates = function () {
    EditorUi.prototype.updateActionStates.apply(this, arguments);
};

/**
 * Updates draft in local storage
 */
App.prototype.updateDraft = function () {
    if (isLocalStorage && localStorage != null) {
        localStorage.setItem('.draft', JSON.stringify({
            modified:
                new Date().getTime(), data: this.getFileData()
        }));
    }
};

/**
 * Returns the draft in local storage
 */
App.prototype.getDraft = function () {
    // FIXME: Handle multiple tabs
//	if (isLocalStorage && localStorage != null)
//	{
//		try
//		{
//			var draft = localStorage.getItem('.draft');
//
//			if (draft != null)
//			{
//				return JSON.parse(draft);
//			}
//		}
//		catch (e)
//		{
//			// ignore quota etc
//		}
//	}

    return null;
};

/**
 * Adds the specified entry to the recent file list in local storage
 */
App.prototype.addRecent = function (entry) {
    if (isLocalStorage && localStorage != null) {
        var recent = this.getRecent();

        if (recent == null) {
            recent = [];
        } else {
            for (var i = 0; i < recent.length; i++) {
                if (recent[i].id == entry.id) {
                    recent.splice(i, 1);
                }
            }
        }

        if (recent != null) {
            recent.unshift(entry);
            recent = recent.slice(0, 10);
            localStorage.setItem('.recent', JSON.stringify(recent));
        }
    }
};

/**
 * Returns the recent file list from local storage
 */
App.prototype.getRecent = function () {
    if (isLocalStorage && localStorage != null) {
        try {
            var recent = localStorage.getItem('.recent');

            if (recent != null) {
                return JSON.parse(recent);
            }
        } catch (e) {
            // ignore
        }

        return null;
    }
};

/**
 * Clears the recent file list in local storage
 */
App.prototype.resetRecent = function (entry) {
    if (isLocalStorage && localStorage != null) {
        try {
            localStorage.removeItem('.recent');
        } catch (e) {
            // ignore
        }
    }
};

/**
 * Clears the draft save in local storage
 */
App.prototype.removeDraft = function () {
    if (isLocalStorage && localStorage != null && urlParams['splash'] == '0') {
        try {
            localStorage.removeItem('.draft');
        } catch (e) {
            // ignore quota etc
        }
    }
};

/**
 * Sets the onbeforeunload for the application
 */
App.prototype.onBeforeUnload = function () {
    if (urlParams['embed'] == '1' && this.editor.modified) {
        return mxResources.get('allChangesLost');
    } else {
        var file = this.getCurrentFile();

        if (file != null) {
            // KNOWN: Message is ignored by most browsers
            if (file.constructor == LocalFile && file.getHash() == '' && !file.isModified() &&
                urlParams['nowarn'] != '1' && !this.isDiagramEmpty() && urlParams['url'] == null &&
                !this.editor.isChromelessView()) {
                return mxResources.get('ensureDataSaved');
            } else if (file.isModified()) {
                return mxResources.get('allChangesLost');
            } else {
                file.close(true);
            }
        }
    }
};

/**
 * Translates this point by the given vector.
 *
 * @param {number} dx X-coordinate of the translation.
 * @param {number} dy Y-coordinate of the translation.
 */
App.prototype.updateDocumentTitle = function () {
    if (!this.editor.graph.isLightboxView()) {
        var title = this.editor.appName;
        var file = this.getCurrentFile();

        if (this.isOfflineApp()) {
            title += ' app';
        }

        if (file != null) {
            var filename = (file.getTitle() != null) ? file.getTitle() : this.defaultFilename;
            title = filename + ' - ' + title;
        }

        document.title = title;
    }
};

/**
 * Authorizes the client, gets the userId and calls <open>.
 */
App.prototype.createCrcTable = function () {
    var crcTable = [];
    var c;

    for (var n = 0; n < 256; n++) {
        c = n;

        for (var k = 0; k < 8; k++) {
            c = ((c & 1) ? (0xEDB88320 ^ (c >>> 1)) : (c >>> 1));
        }

        crcTable[n] = c;
    }

    return crcTable;
};

/**
 * Returns a thumbnail of the current file.
 */
App.prototype.getThumbnail = function (width, fn) {
    var result = false;

    try {
        var acceptResponse = true;

        var timeoutThread = window.setTimeout(mxUtils.bind(this, function () {
            acceptResponse = false;
            fn(null);
        }), this.timeout);

        var success = mxUtils.bind(this, function (canvas) {
            window.clearTimeout(timeoutThread);

            if (acceptResponse) {
                fn(canvas);
            }
        });

        if (this.thumbImageCache == null) {
            this.thumbImageCache = new Object();
        }

        var graph = this.editor.graph;

        // Exports PNG for first page while other page is visible by creating a graph
        // LATER: Add caching for the graph or SVG while not on first page
        // To avoid refresh during save dark theme uses separate graph instance
        var darkTheme = graph.themes != null && graph.defaultThemeName == 'darkTheme';

        if (this.pages != null && (this.currentPage != this.pages[0] || darkTheme)) {
            var graphGetGlobalVariable = graph.getGlobalVariable;
            graph = this.createTemporaryGraph((darkTheme) ? graph.getDefaultStylesheet() : graph.getStylesheet());
            var page = this.pages[0];

            // Avoids override of stylesheet in getSvg for dark mode
            if (darkTheme) {
                graph.defaultThemeName = 'default';
            }

            graph.getGlobalVariable = function (name) {
                if (name == 'page') {
                    return page.getName();
                } else if (name == 'pagenumber') {
                    return 1;
                }

                return graphGetGlobalVariable.apply(this, arguments);
            };

            graph.getGlobalVariable = graphGetGlobalVariable;
            document.body.appendChild(graph.container);
            graph.model.setRoot(page.root);
        }

        // Uses client-side canvas export
        if (mxClient.IS_CHROMEAPP || (!graph.mathEnabled && this.useCanvasForExport)) {
            this.exportToCanvas(mxUtils.bind(this, function (canvas) {
                try {
                    // Removes temporary graph from DOM
                    if (graph != this.editor.graph && graph.container.parentNode != null) {
                        graph.container.parentNode.removeChild(graph.container);
                    }
                } catch (e) {
                    canvas = null;
                }

                success(canvas);
            }), width, this.thumbImageCache, '#ffffff', function () {
                // Continues with null in error case
                success();
            }, null, null, null, null, null, null, graph);

            result = true;
        } else if (this.canvasSupported && this.getCurrentFile() != null) {
            var canvas = document.createElement('canvas');
            var bounds = graph.getGraphBounds();
            var scale = width / bounds.width;

            // Limits scale to 1 or 2 * width / height
            scale = Math.min(1, Math.min((width * 3) / (bounds.height * 4), scale));

            var x0 = Math.floor(bounds.x);
            var y0 = Math.floor(bounds.y);

            canvas.setAttribute('width', Math.ceil(scale * (bounds.width + 4)));
            canvas.setAttribute('height', Math.ceil(scale * (bounds.height + 4)));

            var ctx = canvas.getContext('2d');

            // Configures the canvas
            ctx.scale(scale, scale);
            ctx.translate(-x0, -y0);

            // Paint white background instead of transparent
            var bg = graph.background;

            if (bg == null || bg == '' || bg == mxConstants.NONE) {
                bg = '#ffffff';
            }

            // Paints background
            ctx.save();
            ctx.fillStyle = bg;
            ctx.fillRect(x0, y0, Math.ceil(bounds.width + 4), Math.ceil(bounds.height + 4));
            ctx.restore();

            var htmlCanvas = new mxJsCanvas(canvas);

            // NOTE: htmlCanvas passed into async canvas is only used for image
            // and canvas caching (canvas caching not used in this case as we do
            // not render text). To reuse that cache via the thumbImageCache we
            // pass that into the async canvas and override the image cache in
            // the newly created html canvas with that of the thumbImageCache.
            // LATER: Is clear thumbImageCache needed if file changes?
            var asynCanvas = new mxAsyncCanvas(this.thumbImageCache);
            htmlCanvas.images = this.thumbImageCache.images;

            // Render graph
            var imgExport = new mxImageExport();

            imgExport.drawShape = function (state, canvas) {
                if (state.shape instanceof mxShape && state.shape.checkBounds()) {
                    canvas.save();
                    canvas.translate(0.5, 0.5);
                    state.shape.paint(canvas);
                    canvas.translate(-0.5, -0.5);
                    canvas.restore();
                }
            };

            imgExport.drawText = function (state, canvas) {
                // No text output for thumbnails
            };

            imgExport.drawState(graph.getView().getState(graph.model.root), asynCanvas);

            asynCanvas.finish(mxUtils.bind(this, function () {
                try {
                    imgExport.drawState(graph.getView().getState(graph.model.root), htmlCanvas);

                    // Removes temporary graph from DOM
                    if (graph != this.editor.graph && graph.container.parentNode != null) {
                        graph.container.parentNode.removeChild(graph.container);
                    }
                } catch (e) {
                    canvas = null;
                }

                success(canvas);
            }));

            result = true;
        }
    } catch (e) {
        result = false;

        // Removes temporary graph from DOM
        if (graph != null && graph != this.editor.graph && graph.container.parentNode != null) {
            graph.container.parentNode.removeChild(graph.container);
        }
    }

    return result;
};

/**
 * Translates this point by the given vector.
 *
 * @param {number} dx X-coordinate of the translation.
 * @param {number} dy Y-coordinate of the translation.
 */
App.prototype.createBackground = function () {
    var bg = this.createDiv('background');
    bg.style.position = 'absolute';
    bg.style.background = 'white';
    bg.style.left = '0px';
    bg.style.top = '0px';
    bg.style.bottom = '0px';
    bg.style.right = '0px';

    mxUtils.setOpacity(bg, 100);

    if (mxClient.IS_QUIRKS) {
        new mxDivResizer(bg);
    }

    return bg;
};

/**
 * Translates this point by the given vector.
 *
 * @param {number} dx X-coordinate of the translation.
 * @param {number} dy Y-coordinate of the translation.
 */
(function () {
    var editorUiSetMode = EditorUi.prototype.setMode;

    App.prototype.setMode = function (mode, remember) {
        editorUiSetMode.apply(this, arguments);

        // Note: UseLocalStorage affects the file dialogs
        // and should not be modified if mode is undefined
        if (this.mode != null) {
            Editor.useLocalStorage = this.mode == App.MODE_BROWSER;
        }

        if (this.appIcon != null) {
            var file = this.getCurrentFile();
            mode = (file != null) ? file.getMode() : mode;


            this.appIcon.removeAttribute('title');
            this.appIcon.style.cursor = (mode == App.MODE_DEVICE) ? 'pointer' : 'default';
        }

        if (remember) {
            try {
                if (isLocalStorage) {
                    localStorage.setItem('.mode', mode);
                } else if (typeof (Storage) != 'undefined') {
                    var expiry = new Date();
                    expiry.setYear(expiry.getFullYear() + 1);
                    document.cookie = 'MODE=' + mode + '; expires=' + expiry.toUTCString();
                }
            } catch (e) {
                // ignore possible access denied
            }
        }
    };
})();

/**
 * Function: authorize
 *
 * Authorizes the client, gets the userId and calls <open>.
 */
App.prototype.appIconClicked = function (evt) {
    if (mxEvent.isAltDown(evt)) {
        this.showSplash(true);
    } else {
        var file = this.getCurrentFile();
        var mode = (file != null) ? file.getMode() : null;

    }

    mxEvent.consume(evt);
};

/**
 * Function: authorize
 *
 * Authorizes the client, gets the userId and calls <open>.
 */
App.prototype.clearMode = function () {
    if (isLocalStorage) {
        localStorage.removeItem('.mode');
    } else if (typeof (Storage) != 'undefined') {
        var expiry = new Date();
        expiry.setYear(expiry.getFullYear() - 1);
        document.cookie = 'MODE=; expires=' + expiry.toUTCString();
    }
};

/**
 * Translates this point by the given vector.
 *
 * @param {number} dx X-coordinate of the translation.
 * @param {number} dy Y-coordinate of the translation.
 */
App.prototype.getDiagramId = function () {
    var id = window.location.hash;

    // Strips the hash sign
    if (id != null && id.length > 0) {
        id = id.substring(1);
    }

    // Workaround for Trello client appending data after hash
    if (id != null && id.length > 1 && id.charAt(0) == 'T') {
        var idx = id.indexOf('#');

        if (idx > 0) {
            id = id.substring(0, idx);
        }
    }

    return id;
};

/**
 * Opens any file specified in the URL parameters.
 */
App.prototype.open = function () {
    // Cross-domain window access is not allowed in FF, so if we
    // were opened from another domain then this will fail.
    try {
        // If the create URL param is used in embed mode then
        // we try to open the XML from window.opener[value].
        // Use this for embedding via tab to bypass the timing
        // issues when passing messages without onload event.
        if (window.opener != null) {
            var value = urlParams['create'];

            if (value != null) {
                value = decodeURIComponent(value);
            }

            if (value != null && value.length > 0 && value.substring(0, 7) != 'http://' &&
                value.substring(0, 8) != 'https://') {
                var doc = mxUtils.parseXml(window.opener[value]);
                this.editor.setGraphXml(doc.documentElement);
            } else if (window.opener.openFile != null) {
                window.opener.openFile.setConsumer(mxUtils.bind(this, function (xml, filename, temp) {
                    this.spinner.stop();

                    if (filename == null) {
                        var title = urlParams['title'];
                        temp = true;

                        if (title != null) {
                            filename = decodeURIComponent(title);
                        } else {
                            filename = this.defaultFilename;
                        }
                    }

                    // Replaces PNG with XML extension
                    var dot = (!this.useCanvasForExport) ? filename.substring(filename.length - 4) == '.png' : -1;

                    if (dot > 0) {
                        filename = filename.substring(0, filename.length - 4) + '.drawio';
                    }

                    this.fileLoaded((mxClient.IS_IOS) ?
                        new StorageFile(this, xml, filename) :
                        new LocalFile(this, xml, filename, temp));
                }));
            }
        }
    } catch (e) {
        // ignore
    }
};

/**
 * Main function. Program starts here.
 *
 * @param {number} dx X-coordinate of the translation.
 * @param {number} dy Y-coordinate of the translation.
 */
App.prototype.load = function () {
    // Checks if we're running in embedded mode
    if (urlParams['embed'] != '1') {
        if (this.spinner.spin(document.body, mxResources.get('starting'))) {
            try {
                this.stateArg = (urlParams['state'] != null && this.drive != null) ? JSON.parse(decodeURIComponent(urlParams['state'])) : null;
            } catch (e) {
                // ignores invalid state args
            }

            this.editor.graph.setEnabled(this.getCurrentFile() != null);

            // Passes the userId from the state parameter to the client
            if ((window.location.hash == null || window.location.hash.length == 0) &&
                this.drive != null && this.stateArg != null && this.stateArg.userId != null) {
                this.drive.setUserId(this.stateArg.userId);
            }

            // Legacy support for fileId parameter which is moved to the hash tag
            if (urlParams['fileId'] != null) {
                window.location.hash = 'G' + urlParams['fileId'];
                window.location.search = this.getSearch(['fileId']);
            } else {
                // Asynchronous or disabled loading of client
                if (this.drive == null) {

                    this.start();
                } else {
                    this.loadGapi(mxUtils.bind(this, function () {
                        if (urlParams['convert-realtime'] == '1') {
                            this.spinner.stop();
                            this.drive.convertRealtimeFiles();
                        } else {
                            this.start();
                        }
                    }));
                }
            }
        }
    } else {
        this.restoreLibraries();

        if (urlParams['gapi'] == '1') {
            this.loadGapi(function () {
            });
        }
    }
};

/**
 * Adds the listener for automatically saving the diagram for local changes.
 */
App.prototype.showRefreshDialog = function (title, message) {
    if (!this.showingRefreshDialog) {
        this.showingRefreshDialog = true;

        this.showError(title || mxResources.get('externalChanges'),
            message || mxResources.get('redirectToNewApp'),
            mxResources.get('refresh'), mxUtils.bind(this, function () {
                var file = this.getCurrentFile();

                if (file != null) {
                    file.setModified(false);
                }

                this.spinner.spin(document.body, mxResources.get('connecting'));
                this.editor.graph.setEnabled(false);
                window.location.reload();
            }), null, null, null, null, null, 340, 180);

        // Adds important notice to dialog
        if (this.dialog != null && this.dialog.container != null) {
            var alert = this.createRealtimeNotice();
            alert.style.left = '0';
            alert.style.right = '0';
            alert.style.borderRadius = '0';
            alert.style.borderLeftStyle = 'none';
            alert.style.borderRightStyle = 'none';
            alert.style.marginBottom = '26px';
            alert.style.padding = '8px 0 8px 0';

            this.dialog.container.appendChild(alert);
        }
    }
};

/**
 * Called in start after the spinner stops.
 */
App.prototype.showAlert = function (message) {
    if (message != null && message.length > 0) {
        var div = document.createElement('div');
        div.className = 'geAlert';
        div.style.zIndex = 2e9;
        div.style.left = '50%';
        div.style.top = '-100%';
        mxUtils.setPrefixedStyle(div.style, 'transform', 'translate(-50%,0%)');
        mxUtils.setPrefixedStyle(div.style, 'transition', 'all 1s ease');

        div.innerHTML = message;

        var close = document.createElement('a');
        close.className = 'geAlertLink';
        close.style.textAlign = 'right';
        close.style.marginTop = '20px';
        close.style.display = 'block';
        close.setAttribute('title', mxResources.get('close'));
        close.innerHTML = mxResources.get('close');
        div.appendChild(close);

        mxEvent.addListener(close, 'click', function (evt) {
            if (div.parentNode != null) {
                div.parentNode.removeChild(div);
                mxEvent.consume(evt);
            }
        });

        document.body.appendChild(div);

        // Delayed to get smoother animation after DOM rendering
        window.setTimeout(function () {
            div.style.top = '30px';
        }, 10);

        // Fades out the alert after 15 secs
        window.setTimeout(function () {
            mxUtils.setPrefixedStyle(div.style, 'transition', 'all 2s ease');
            div.style.opacity = '0';

            window.setTimeout(function () {
                if (div.parentNode != null) {
                    div.parentNode.removeChild(div);
                }
            }, 2000);
        }, 15000);
    }
};

/**
 * Translates this point by the given vector.
 *
 * @param {number} dx X-coordinate of the translation.
 * @param {number} dy Y-coordinate of the translation.
 */
App.prototype.start = function () {
    this.bg.parentNode.removeChild(this.bg);
    this.restoreLibraries();
    this.spinner.stop();

    try {
        // Listens to changes of the hash if not in embed or client mode
        if (urlParams['client'] != '1' && urlParams['embed'] != '1') {
            // KNOWN: Does not work in quirks mode
            mxEvent.addListener(window, 'hashchange', mxUtils.bind(this, function (evt) {
                try {
                    this.hideDialog();
                    var id = this.getDiagramId();
                    var file = this.getCurrentFile();

                    if (file == null || file.getHash() != id) {
                        this.loadFile(id, true);
                    }
                } catch (e) {
                    // Workaround for possible scrollWidth of null in Dialog ctor
                    if (document.body != null) {
                        this.handleError(e, mxResources.get('errorLoadingFile'), mxUtils.bind(this, function () {
                            var file = this.getCurrentFile();
                            window.location.hash = (file != null) ? file.getHash() : '';
                        }));
                    }
                }
            }));
        }

        // Redirects old url URL parameter to new #U format
        if ((window.location.hash == null || window.location.hash.length <= 1) && urlParams['url'] != null) {
            this.loadFile('U' + urlParams['url'], true);
        } else if (this.getCurrentFile() == null) {
            var done = mxUtils.bind(this, function () {
                if (this.dialog == null) {
                    var waiting = false;

                    // Checks if we're waiting for some asynchronous file to be loaded
                    // Cross-domain window access is not allowed in FF, so if we
                    // were opened from another domain then this will fail.
                    try {
                        waiting = window.opener != null && window.opener.openFile != null;
                    } catch (e) {
                        // ignore
                    }

                    if (waiting) {
                        // Spinner is stopped in App.open
                        this.spinner.spin(document.body, mxResources.get('loading'))
                    } else {
                        /*aric.chen load id from url*/
                        // this.loadFile();
                        this.loadNeptuneFile();
                    }
                }
            });

            done();
        }
    } catch (e) {
        this.handleError(e);
    }
};

/**
 * Translates this point by the given vector.
 *
 * @param {number} dx X-coordinate of the translation.
 * @param {number} dy Y-coordinate of the translation.
 */
App.prototype.showSplash = function (force) {
    var serviceCount = this.getServiceCount(true, true);

    var showSecondDialog = mxUtils.bind(this, function () {
        var dlg = new SplashDialog(this);

        this.showDialog(dlg.container, 340, (mxClient.IS_CHROMEAPP || EditorUi.isElectronApp) ? 200 :
            ((serviceCount < 2) ? 230 : 260), true, true,
            mxUtils.bind(this, function (cancel) {
                // Creates a blank diagram if the dialog is closed
                if (cancel && !mxClient.IS_CHROMEAPP) {
                    var prev = Editor.useLocalStorage;
                    this.createFile(this.defaultFilename, null, null, null, null, null, null,
                        urlParams['local'] != '1');
                    Editor.useLocalStorage = prev;
                }
            }), true);
    });

    if (this.editor.isChromelessView()) {
        this.handleError({message: mxResources.get('noFileSelected')},
            mxResources.get('errorLoadingFile'), mxUtils.bind(this, function () {
                this.showSplash();
            }));
    } else if (!mxClient.IS_CHROMEAPP && (this.mode == null || force)) {
        var rowLimit = (serviceCount == 4) ? 2 : 3;

        var dlg = new StorageDialog(this, mxUtils.bind(this, function () {
            this.hideDialog();
            showSecondDialog();
        }), rowLimit);

        this.showDialog(dlg.container, (rowLimit < 3) ? 240 : 300,
            (serviceCount >= 4) ? 440 : ((this.isOfflineApp()) ? 300 : 320), true, false);
        dlg.init();
    } else if (urlParams['create'] == null) {
        showSecondDialog();
    }
};

/**
 * Translates this point by the given vector.
 *
 * @param {number} dx X-coordinate of the translation.
 * @param {number} dy Y-coordinate of the translation.
 */
App.prototype.addLanguageMenu = function (elt, addLabel) {
    var img = null;

    if (!this.isOfflineApp() || mxClient.IS_CHROMEAPP) {
        var langMenu = this.menus.get('language');

        if (langMenu != null) {
            img = document.createElement('div');
            img.setAttribute('title', mxResources.get('language'));
            img.className = 'geIcon geSprite geSprite-globe';
            img.style.position = 'absolute';
            img.style.cursor = 'pointer';
            img.style.bottom = '20px';
            img.style.right = '20px';

            if (addLabel) {
                img.style.direction = 'rtl';
                img.style.textAlign = 'right';
                img.style.right = '24px';

                var label = document.createElement('span');
                label.style.display = 'inline-block';
                label.style.fontSize = '12px';
                label.style.margin = '5px 24px 0 0';
                label.style.color = 'gray';
                label.style.userSelect = 'none';

                mxUtils.write(label, mxResources.get('language'));
                img.appendChild(label);
            }

            mxEvent.addListener(img, 'click', mxUtils.bind(this, function (evt) {
                this.editor.graph.popupMenuHandler.hideMenu();
                var menu = new mxPopupMenu(this.menus.get('language').funct);
                menu.div.className += ' geMenubarMenu';
                menu.smartSeparators = true;
                menu.showDisabled = true;
                menu.autoExpand = true;

                // Disables autoexpand and destroys menu when hidden
                menu.hideMenu = mxUtils.bind(this, function () {
                    mxPopupMenu.prototype.hideMenu.apply(menu, arguments);
                    menu.destroy();
                });

                var offset = mxUtils.getOffset(img);
                menu.popup(offset.x, offset.y + img.offsetHeight, null, evt);

                // Allows hiding by clicking on document
                this.setCurrentMenu(menu);
            }));

            elt.appendChild(img);
        }
    }

    return img;
};

/**
 * Translates this point by the given vector.
 *
 * @param {number} dx X-coordinate of the translation.
 * @param {number} dy Y-coordinate of the translation.
 */
App.prototype.pickFile = function (mode) {
    try {
        mode = (mode != null) ? mode : this.mode;

        var peer = this.getPeerForMode(mode);

        if (peer != null) {
            peer.pickFile();
        } else if (mode == App.MODE_DEVICE && Graph.fileSupport) {
            if (this.openFileInputElt == null) {
                var input = document.createElement('input');
                input.setAttribute('type', 'file');

                mxEvent.addListener(input, 'change', mxUtils.bind(this, function () {
                    if (input.files != null) {
                        this.openFiles(input.files);

                        // Resets input to force change event for same file (type reset required for IE)
                        input.type = '';
                        input.type = 'file';
                        input.value = '';
                    }
                }));

                input.style.display = 'none';
                document.body.appendChild(input);
                this.openFileInputElt = input;
            }

            this.openFileInputElt.click();
        } else {
            this.hideDialog();
            window.openNew = this.getCurrentFile() != null && !this.isDiagramEmpty();
            window.baseUrl = this.getUrl();
            window.openKey = 'open';
            var prevValue = Editor.useLocalStorage;
            Editor.useLocalStorage = (mode == App.MODE_BROWSER);
            this.openFile();

            // Installs local handler for opened files in same window
            window.openFile.setConsumer(mxUtils.bind(this, function (xml, filename) {
                // Replaces PNG with XML extension
                var dot = !this.useCanvasForExport && filename.substring(filename.length - 4) == '.png';

                if (dot) {
                    filename = filename.substring(0, filename.length - 4) + '.drawio';
                }

                this.fileLoaded((mode == App.MODE_BROWSER) ?
                    new StorageFile(this, xml, filename) :
                    new LocalFile(this, xml, filename));
            }));

            // Extends dialog close to show splash screen
            var dlg = this.dialog;
            var dlgClose = dlg.close;

            this.dialog.close = mxUtils.bind(this, function (cancel) {
                Editor.useLocalStorage = prevValue;
                dlgClose.apply(dlg, arguments);

                if (this.getCurrentFile() == null) {
                    this.showSplash();
                }
            });
        }
    } catch (e) {
        this.handleError(e);
    }
};

/**
 * Translates this point by the given vector.
 *
 * @param {number} dx X-coordinate of the translation.
 * @param {number} dy Y-coordinate of the translation.
 */
App.prototype.pickLibrary = function (mode) {
    mode = (mode != null) ? mode : this.mode;

    if (mode == App.MODE_DEVICE && Graph.fileSupport) {
        if (this.libFileInputElt == null) {
            var input = document.createElement('input');
            input.setAttribute('type', 'file');

            mxEvent.addListener(input, 'change', mxUtils.bind(this, function () {
                if (input.files != null) {
                    for (var i = 0; i < input.files.length; i++) {
                        (mxUtils.bind(this, function (file) {
                            var reader = new FileReader();

                            reader.onload = mxUtils.bind(this, function (e) {
                                try {
                                    this.loadLibrary(new LocalLibrary(this, e.target.result, file.name));
                                } catch (e) {
                                    this.handleError(e, mxResources.get('errorLoadingFile'));
                                }
                            });

                            reader.readAsText(file);
                        }))(input.files[i]);
                    }

                    // Resets input to force change event for same file (type reset required for IE)
                    input.type = '';
                    input.type = 'file';
                    input.value = '';
                }
            }));

            input.style.display = 'none';
            document.body.appendChild(input);
            this.libFileInputElt = input;
        }

        this.libFileInputElt.click();
    } else {
        window.openNew = false;
        window.openKey = 'open';

        var prevValue = Editor.useLocalStorage;
        Editor.useLocalStorage = mode == App.MODE_BROWSER;

        // Closes dialog after open
        window.openFile = new OpenFile(mxUtils.bind(this, function (cancel) {
            this.hideDialog(cancel);
        }));

        window.openFile.setConsumer(mxUtils.bind(this, function (xml, filename) {
            try {
                this.loadLibrary((mode == App.MODE_BROWSER) ? new StorageLibrary(this, xml, filename) :
                    new LocalLibrary(this, xml, filename));
            } catch (e) {
                this.handleError(e, mxResources.get('errorLoadingFile'));
            }
        }));

        // Removes openFile if dialog is closed
        this.showDialog(new OpenDialog(this).container, (Editor.useLocalStorage) ? 640 : 360,
            (Editor.useLocalStorage) ? 480 : 220, true, true, function () {
                Editor.useLocalStorage = prevValue;
                window.openFile = null;
            });
    }
};

/**
 * Translates this point by the given vector.
 *
 * @param {number} dx X-coordinate of the translation.
 * @param {number} dy Y-coordinate of the translation.
 */
App.prototype.saveLibrary = function (name, images, file, mode, noSpin, noReload, fn) {
    try {
        mode = (mode != null) ? mode : this.mode;
        noSpin = (noSpin != null) ? noSpin : false;
        noReload = (noReload != null) ? noReload : false;
        var xml = this.createLibraryDataFromImages(images);

        var error = mxUtils.bind(this, function (resp) {
            this.spinner.stop();

            if (fn != null) {
                fn();
            }

            this.handleError(resp, (resp != null) ? mxResources.get('errorSavingFile') : null);
        });

        // Handles special case for local libraries
        if (file == null && mode == App.MODE_DEVICE) {
            file = new LocalLibrary(this, xml, name);
        }

        if (file == null) {
            this.pickFolder(mode, mxUtils.bind(this, function (folderId) {
                if (mode == App.MODE_BROWSER) {
                    var fn = mxUtils.bind(this, function () {
                        var file = new StorageLibrary(this, xml, name);

                        // Inserts data into local storage
                        file.saveFile(name, false, mxUtils.bind(this, function () {
                            this.hideDialog(true);
                            this.libraryLoaded(file, images);
                        }), error);
                    });

                    if (localStorage.getItem(name) == null) {
                        fn();
                    } else {
                        this.confirm(mxResources.get('replaceIt', [name]), fn);
                    }
                } else {
                    this.handleError({message: mxResources.get('serviceUnavailableOrBlocked')});
                }
            }));
        } else if (noSpin || this.spinner.spin(document.body, mxResources.get('saving'))) {
            file.setData(xml);

            var doSave = mxUtils.bind(this, function () {
                file.save(true, mxUtils.bind(this, function (resp) {
                    this.spinner.stop();
                    this.hideDialog(true);

                    if (!noReload) {
                        this.libraryLoaded(file, images);
                    }

                    if (fn != null) {
                        fn();
                    }
                }), error);
            });

            if (name != file.getTitle()) {
                var oldHash = file.getHash();

                file.rename(name, mxUtils.bind(this, function (resp) {
                    // Change hash in stored settings
                    if (file.constructor != LocalLibrary && oldHash != file.getHash()) {
                        mxSettings.removeCustomLibrary(oldHash);
                        mxSettings.addCustomLibrary(file.getHash());
                    }

                    // Workaround for library files changing hash so
                    // the old library cannot be removed from the
                    // sidebar using the updated file in libraryLoaded
                    this.removeLibrarySidebar(oldHash);

                    doSave();
                }), error)
            } else {
                doSave();
            }
        }
    } catch (e) {
        this.handleError(e);
    }
};

/**
 * Adds the label menu items to the given menu and parent.
 */
App.prototype.saveFile = function (forceDialog, success) {
    var file = this.getCurrentFile();

    if (file != null) {
        // FIXME: Invoke for local files
        var done = mxUtils.bind(this, function () {
            this.removeDraft();

            if (this.getCurrentFile() != file && !file.isModified()) {
                // Workaround for possible status update while save as dialog is showing
                // is to show no saved status for device files
                if (file.getMode() != App.MODE_DEVICE) {
                    this.editor.setStatus(mxUtils.htmlEntities(mxResources.get('allChangesSaved')));
                } else {
                    this.editor.setStatus('');
                }
            }

            if (success != null) {
                success();
            }
        });

        if (!forceDialog && file.getTitle() != null && this.mode != null) {
            this.save(file.getTitle(), done);
        } else {
            var filename = (file.getTitle() != null) ? file.getTitle() : this.defaultFilename;
            var allowTab = !mxClient.IS_IOS || !navigator.standalone;
            var prev = this.mode;
            var serviceCount = this.getServiceCount(true);

            if (isLocalStorage) {
                serviceCount++;
            }

            var rowLimit = (serviceCount <= 4) ? 2 : (serviceCount > 6 ? 4 : 3);

            var dlg = new CreateDialog(this, filename, mxUtils.bind(this, function (name, mode) {
                    if (name != null && name.length > 0) {
                        if (prev == null && mode == App.MODE_DEVICE) {
                            this.setMode(App.MODE_DEVICE);
                            this.save(name, done);
                        } else if (mode == 'download') {
                            var tmp = new LocalFile(this, null, name);
                            tmp.save();
                        } else if (mode == '_blank') {
                            window.openFile = new OpenFile(function () {
                                window.openFile = null;
                            });

                            // Do not use a filename to use undefined mode
                            window.openFile.setData(this.getFileData(true));
                            this.openLink(this.getUrl(window.location.pathname), null, true);
                        } else if (prev != mode) {
                            this.pickFolder(mode, mxUtils.bind(this, function (folderId) {
                                this.createFile(name, this.getFileData(/(\.xml)$/i.test(name) ||
                                    name.indexOf('.') < 0 || /(\.drawio)$/i.test(name),
                                    /(\.svg)$/i.test(name), /(\.html)$/i.test(name)),
                                    null, mode, done, this.mode == null, folderId);
                            }));
                        } else if (mode != null) {
                            this.save(name, done);
                        }
                    }
                }), mxUtils.bind(this, function () {
                    this.hideDialog();
                }), mxResources.get('saveAs'), mxResources.get('download'), null, null, allowTab,
                null, true, rowLimit, null, null, null, this.editor.fileExtensions);

            this.showDialog(dlg.container, 400, (serviceCount > rowLimit) ? 390 : 270, true, true);
            dlg.init();
        }
    }
};

/**
 * Translates this point by the given vector.
 *
 * @param {number} dx X-coordinate of the translation.
 * @param {number} dy Y-coordinate of the translation.
 */
App.prototype.loadTemplate = function (url, onload, onerror, templateFilename) {
    var base64 = false;
    var realUrl = url;

    if (!this.editor.isCorsEnabledForUrl(realUrl)) {
        // Always uses base64 response to check magic numbers for file type
        var nocache = 't=' + new Date().getTime();
        realUrl = PROXY_URL + '?url=' + encodeURIComponent(url) + '&base64=1&' + nocache;
        base64 = true;
    }

    var filterFn = (templateFilename != null) ? templateFilename : url;

    this.loadUrl(realUrl, mxUtils.bind(this, function (responseData) {
        try {
            var data = (!base64) ? responseData : ((window.atob && !mxClient.IS_IE && !mxClient.IS_IE11) ?
                atob(responseData) : Base64.decode(responseData));

            if (/(\.v(dx|sdx?))($|\?)/i.test(filterFn) || this.isVisioData(data)) {
                this.importVisio(this.base64ToBlob(responseData.substring(responseData.indexOf(',') + 1)), function (xml) {
                    onload(xml);
                }, onerror, filterFn);
            } else if (!this.isOffline() && new XMLHttpRequest().upload && this.isRemoteFileFormat(data, filterFn)) {
                // Asynchronous parsing via server
                this.parseFile(new Blob([data], {type: 'application/octet-stream'}), mxUtils.bind(this, function (xhr) {
                    if (xhr.readyState == 4 && xhr.status >= 200 && xhr.status <= 299 &&
                        xhr.responseText.substring(0, 13) == '<mxGraphModel') {
                        onload(xhr.responseText);
                    }
                }), url);
            } else if (this.isLucidChartData(data)) {
                this.convertLucidChart(data, mxUtils.bind(this, function (xml) {
                    onload(xml);
                }), mxUtils.bind(this, function (e) {
                    onerror(e);
                }));
            } else {
                if (/(\.png)($|\?)/i.test(filterFn) || this.isPngData(data)) {
                    data = this.extractGraphModelFromPng(responseData);
                }

                onload(data);
            }
        } catch (e) {
            onerror(e);
        }
    }), onerror, /(\.png)($|\?)/i.test(filterFn) || /(\.v(dx|sdx?))($|\?)/i.test(filterFn), null, null, base64);
};

/**
 * Translates this point by the given vector.
 *
 * @param {number} dx X-coordinate of the translation.
 * @param {number} dy Y-coordinate of the translation.
 */
App.prototype.getPeerForMode = function (mode) {
    return null;
};

/**
 * Translates this point by the given vector.
 *
 * @param {number} dx X-coordinate of the translation.
 * @param {number} dy Y-coordinate of the translation.
 */
App.prototype.createFile = function (title, data, libs, mode, done, replace, folderId, tempFile, clibs) {
    mode = (tempFile) ? null : ((mode != null) ? mode : this.mode);

    if (title != null && this.spinner.spin(document.body, mxResources.get('inserting'))) {
        data = (data != null) ? data : this.emptyDiagramXml;

        var complete = mxUtils.bind(this, function () {
            this.spinner.stop();
        });

        var error = mxUtils.bind(this, function (resp) {
            complete();

            if (resp == null && this.getCurrentFile() == null && this.dialog == null) {
                this.showSplash();
            } else if (resp != null) {
                this.handleError(resp);
            }
        });

        try {
            if (mode == App.MODE_BROWSER) {
                complete();

                var fn = mxUtils.bind(this, function () {
                    var file = new StorageFile(this, data, title);

                    // Inserts data into local storage
                    file.saveFile(title, false, mxUtils.bind(this, function () {
                        this.fileCreated(file, libs, replace, done, clibs);
                    }), error);
                });

                if (localStorage.getItem(title) == null) {
                    fn();
                } else {
                    this.confirm(mxResources.get('replaceIt', [title]), fn, mxUtils.bind(this, function () {
                        if (this.getCurrentFile() == null && this.dialog == null) {
                            this.showSplash();
                        }
                    }));
                }
            } else {
                complete();
                this.fileCreated(new LocalFile(this, data, title, mode == null), libs, replace, done, clibs);
            }
        } catch (e) {
            complete();
            this.handleError(e);
        }
    }
};

/**
 * Translates this point by the given vector.
 *
 * @param {number} dx X-coordinate of the translation.
 * @param {number} dy Y-coordinate of the translation.
 */
App.prototype.fileCreated = function (file, libs, replace, done, clibs) {
    var url = window.location.pathname;

    if (libs != null && libs.length > 0) {
        url += '?libs=' + libs;
    }

    if (clibs != null && clibs.length > 0) {
        url += '?clibs=' + clibs;
    }

    url = this.getUrl(url);

    // Always opens a new tab for local files to avoid losing changes
    if (file.getMode() != App.MODE_DEVICE) {
        url += '#' + file.getHash();
    }

    // Makes sure to produce consistent output with finalized files via createFileData this needs
    // to save the file again since it needs the newly created file ID for redirecting in HTML
    if (this.spinner.spin(document.body, mxResources.get('inserting'))) {
        var data = file.getData();
        var dataNode = (data.length > 0) ? this.editor.extractGraphModel(
            mxUtils.parseXml(data).documentElement, true) : null;
        var redirect = window.location.protocol + '//' + window.location.hostname + url;
        var node = dataNode;
        var graph = null;

        // Handles special case where SVG files need a rendered graph to be saved
        if (dataNode != null && /\.svg$/i.test(file.getTitle())) {
            graph = this.createTemporaryGraph(this.editor.graph.getStylesheet());
            document.body.appendChild(graph.container);
            node = this.decodeNodeIntoGraph(node, graph);
        }

        file.setData(this.createFileData(dataNode, graph, file, redirect));

        if (graph != null) {
            graph.container.parentNode.removeChild(graph.container);
        }

        var complete = mxUtils.bind(this, function () {
            this.spinner.stop();
        });

        var fn = mxUtils.bind(this, function () {
            complete();

            var currentFile = this.getCurrentFile();

            if (replace == null && currentFile != null) {
                replace = !currentFile.isModified() && currentFile.getMode() == null;
            }

            var fn3 = mxUtils.bind(this, function () {
                window.openFile = null;
                this.fileLoaded(file);

                if (replace) {
                    file.addAllSavedStatus();
                }

                if (libs != null) {
                    this.sidebar.showEntries(libs);
                }

                if (clibs != null) {
                    var temp = [];
                    var tokens = clibs.split(';');

                    for (var i = 0; i < tokens.length; i++) {
                        temp.push(decodeURIComponent(tokens[i]));
                    }

                    this.loadLibraries(temp);
                }
            });

            var fn2 = mxUtils.bind(this, function () {
                if (replace || currentFile == null || !currentFile.isModified()) {
                    fn3();
                } else {
                    this.confirm(mxResources.get('allChangesLost'), null, fn3,
                        mxResources.get('cancel'), mxResources.get('discardChanges'));
                }
            });

            if (done != null) {
                done();
            }

            // Opens the file in a new window
            if (replace != null && !replace) {
                // Opens local file in a new window
                if (file.constructor == LocalFile) {
                    window.openFile = new OpenFile(function () {
                        window.openFile = null;
                    });

                    window.openFile.setData(file.getData(), file.getTitle(), file.getMode() == null);
                }

                if (done != null) {
                    done();
                }

                window.openWindow(url, null, fn2);
            } else {
                fn2();
            }
        });

        // Updates data in memory for local files
        if (file.constructor == LocalFile) {
            fn();
        } else {
            file.saveFile(file.getTitle(), false, mxUtils.bind(this, function () {
                fn();
            }), mxUtils.bind(this, function (resp) {
                complete();
                this.handleError(resp);
            }));
        }
    }
};

/*Aric.chen Load File from Neptune*/

App.prototype.loadNeptuneFile = function () {
    /*get draw id*/
    var self = this;

    var id = NeptuneUtils.findGetParameter('id');
    NeptuneHttp.get('monitor_developer/loadMonitor', {
        id: id
    }).done(function (response) {
        self.fileLoaded(new StorageFile(self, response.xml, response.name));
    });
}

/**
 * Translates this point by the given vector.
 *
 * @param {number} dx X-coordinate of the translation.
 * @param {number} dy Y-coordinate of the translation.
 */
App.prototype.loadFile = function (id, sameWindow, file, success, force) {
    this.hideDialog();
    var fn2 = mxUtils.bind(this, function () {
        if (id == null || id.length == 0) {
            this.editor.setStatus('');
            this.fileLoaded(null);
        } else if (this.spinner.spin(document.body, mxResources.get('loading'))) {
            // Handles files from localStorage
            if (id.charAt(0) == 'L') {
                this.spinner.stop();

                if (!isLocalStorage) {
                    this.handleError({message: mxResources.get('serviceUnavailableOrBlocked')}, mxResources.get('errorLoadingFile'), mxUtils.bind(this, function () {
                        var tempFile = this.getCurrentFile();
                        window.location.hash = (tempFile != null) ? tempFile.getHash() : '';
                    }));
                } else {
                    try {
                        id = decodeURIComponent(id.substring(1));
                        var data = localStorage.getItem(id);

                        if (data != null) {
                            this.fileLoaded(new StorageFile(this, data, id));

                            if (success != null) {
                                success();
                            }
                        } else {
                            throw {message: mxResources.get('fileNotFound')};
                        }
                    } catch (e) {
                        this.handleError(e, mxResources.get('errorLoadingFile'), mxUtils.bind(this, function () {
                            var tempFile = this.getCurrentFile();
                            window.location.hash = (tempFile != null) ? tempFile.getHash() : '';
                        }));
                    }
                }
            } else if (file != null) {
                // File already loaded
                this.spinner.stop();
                this.fileLoaded(file);

                if (success != null) {
                    success();
                }
            } else if (id.charAt(0) == 'S') {
                this.spinner.stop();

                try {
                    this.loadDescriptor(JSON.parse(Graph.decompress(id.substring(1))),
                        success, mxUtils.bind(this, function (e) {
                            this.handleError(e, mxResources.get('errorLoadingFile'));
                        }));
                } catch (e) {
                    this.handleError(e, mxResources.get('errorLoadingFile'));
                }
            } else if (id.charAt(0) == 'R') {
                // Raw file encoded into URL
                this.spinner.stop();
                var data = decodeURIComponent(id.substring(1));

                if (data.charAt(0) != '<') {
                    data = Graph.decompress(data);
                }

                var tempFile = new LocalFile(this, data, (urlParams['title'] != null) ?
                    decodeURIComponent(urlParams['title']) : this.defaultFilename, true);
                tempFile.getHash = function () {
                    return id;
                };
                this.fileLoaded(tempFile);

                if (success != null) {
                    success();
                }
            } else if (id.charAt(0) == 'U') {
                var url = decodeURIComponent(id.substring(1));

                var doFallback = mxUtils.bind(this, function () {
                    // Fallback for non-public Google Drive files
                    if (url.substring(0, 31) == 'https://drive.google.com/uc?id=' &&
                        (this.drive != null || typeof window.DriveClient === 'function')) {
                        this.hideDialog();

                        var fallback = mxUtils.bind(this, function () {
                            this.spinner.stop();

                            if (this.drive != null) {
                                var tempId = url.substring(31, url.lastIndexOf('&ex'));

                                this.loadFile('G' + tempId, sameWindow, null, mxUtils.bind(this, function () {
                                    var currentFile = this.getCurrentFile();

                                    if (currentFile != null && this.editor.chromeless && !this.editor.editable) {
                                        currentFile.getHash = function () {
                                            return 'G' + tempId;
                                        };

                                        window.location.hash = '#' + currentFile.getHash();
                                    }

                                    if (success != null) {
                                        success();
                                    }
                                }));

                                return true;
                            } else {
                                return false;
                            }
                        });

                        if (!fallback() && this.spinner.spin(document.body, mxResources.get('loading'))) {
                            this.addListener('clientLoaded', fallback);
                        }

                        return true;
                    } else {
                        return false;
                    }
                });

                this.loadTemplate(url, mxUtils.bind(this, function (text) {
                    this.spinner.stop();

                    if (text != null && text.length > 0) {
                        var filename = this.defaultFilename;

                        // Tries to find name from URL with valid extensions
                        if (urlParams['title'] == null && urlParams['notitle'] != '1') {
                            var tmp = url;
                            var dot = url.lastIndexOf('.');
                            var slash = tmp.lastIndexOf('/');

                            if (dot > slash && slash > 0) {
                                tmp = tmp.substring(slash + 1, dot);
                                var ext = url.substring(dot);

                                if (!this.useCanvasForExport && ext == '.png') {
                                    ext = '.drawio';
                                }

                                if (ext === '.svg' || ext === '.xml' ||
                                    ext === '.html' || ext === '.png' ||
                                    ext === '.drawio') {
                                    filename = tmp + ext;
                                }
                            }
                        }

                        var tempFile = new LocalFile(this, text, (urlParams['title'] != null) ?
                            decodeURIComponent(urlParams['title']) : filename, true);
                        tempFile.getHash = function () {
                            return id;
                        };

                        if (!this.fileLoaded(tempFile, true) && !doFallback()) {
                            this.handleError({message: mxResources.get('fileNotFound')},
                                mxResources.get('errorLoadingFile'));
                        }
                    } else if (!doFallback()) {
                        this.handleError({message: mxResources.get('fileNotFound')},
                            mxResources.get('errorLoadingFile'));
                    }
                }), mxUtils.bind(this, function () {
                    if (!doFallback()) {
                        this.spinner.stop();
                        this.handleError({message: mxResources.get('fileNotFound')},
                            mxResources.get('errorLoadingFile'));
                    }
                }), (urlParams['template-filename'] != null) ?
                    decodeURIComponent(urlParams['template-filename']) : null);
            } else {
                // Google Drive files are handled as default file types
                var peer = null;

                if (id.charAt(0) == 'G') {
                    peer = this.drive;
                } else if (id.charAt(0) == 'D') {
                    peer = this.dropbox;
                } else if (id.charAt(0) == 'W') {
                    peer = this.oneDrive;
                } else if (id.charAt(0) == 'H') {
                    peer = this.gitHub;
                } else if (id.charAt(0) == 'A') {
                    peer = this.gitLab;
                } else if (id.charAt(0) == 'T') {
                    peer = this.trello;
                }

                if (peer == null) {
                    this.handleError({message: mxResources.get('serviceUnavailableOrBlocked')}, mxResources.get('errorLoadingFile'), mxUtils.bind(this, function () {
                        var currentFile = this.getCurrentFile();
                        window.location.hash = (currentFile != null) ? currentFile.getHash() : '';
                    }));
                } else {
                    var peerChar = id.charAt(0);
                    id = decodeURIComponent(id.substring(1));

                    peer.getFile(id, mxUtils.bind(this, function (file) {
                        this.spinner.stop();
                        this.fileLoaded(file);
                        var currentFile = this.getCurrentFile();

                        if (currentFile == null) {
                            window.location.hash = '';
                            this.showSplash();
                        } else if (this.editor.chromeless && !this.editor.editable) {
                            // Keeps ID even for converted files in chromeless mode for refresh to work
                            currentFile.getHash = function () {
                                return peerChar + id;
                            };

                            window.location.hash = '#' + currentFile.getHash();
                        } else if (file == currentFile && file.getMode() == null) {
                            // Shows a warning if a copy was opened which happens
                            // eg. for .png files in IE as they cannot be written
                            var status = mxResources.get('copyCreated');
                            this.editor.setStatus('<div title="' + status + '" class="geStatusAlert" style="overflow:hidden;">' + status + '</div>');
                        }

                        if (success != null) {
                            success();
                        }
                    }), mxUtils.bind(this, function (resp) {
                        // Makes sure the file does not save the invalid UI model and overwrites anything important
                        if (window.console != null && resp != null) {
                            console.log('error in loadFile:', id, resp);
                        }

                        this.handleError(resp, (resp != null) ? mxResources.get('errorLoadingFile') : null, mxUtils.bind(this, function () {
                            var currentFile = this.getCurrentFile();

                            if (currentFile == null) {
                                window.location.hash = '';
                                this.showSplash();
                            } else {
                                window.location.hash = '#' + currentFile.getHash();
                            }
                        }));
                    }));
                }
            }
        }
    });

    var currentFile = this.getCurrentFile();

    var fn = mxUtils.bind(this, function () {
        if (force || currentFile == null || !currentFile.isModified()) {
            fn2();
        } else {
            this.confirm(mxResources.get('allChangesLost'), mxUtils.bind(this, function () {
                if (currentFile != null) {
                    window.location.hash = currentFile.getHash();
                }
            }), fn2, mxResources.get('cancel'), mxResources.get('discardChanges'));
        }
    });

    if (id == null || id.length == 0) {
        fn();
    } else if (currentFile != null && currentFile.isModified() && !sameWindow) {
        window.openWindow(this.getUrl() + '#' + id, null, fn);
    } else {
        fn();
    }
};

/**
 * Translates this point by the given vector.
 *
 * @param {number} dx X-coordinate of the translation.
 * @param {number} dy Y-coordinate of the translation.
 */
App.prototype.getLibraryStorageHint = function (file) {
    var tip = file.getTitle();

    if (file.constructor != LocalLibrary) {
        tip += '\n' + file.getHash();
    }

    if (file.constructor == DriveLibrary) {
        tip += ' (' + mxResources.get('googleDrive') + ')';
    } else if (file.constructor == GitHubLibrary) {
        tip += ' (' + mxResources.get('github') + ')';
    } else if (file.constructor == TrelloLibrary) {
        tip += ' (' + mxResources.get('trello') + ')';
    } else if (file.constructor == DropboxLibrary) {
        tip += ' (' + mxResources.get('dropbox') + ')';
    } else if (file.constructor == OneDriveLibrary) {
        tip += ' (' + mxResources.get('oneDrive') + ')';
    } else if (file.constructor == StorageLibrary) {
        tip += ' (' + mxResources.get('browser') + ')';
    } else if (file.constructor == LocalLibrary) {
        tip += ' (' + mxResources.get('device') + ')';
    }

    return tip;
};

/**
 * Updates action states depending on the selection.
 */
App.prototype.restoreLibraries = function () {
    this.loadLibraries(mxSettings.getCustomLibraries(), mxUtils.bind(this, function () {
        this.loadLibraries((urlParams['clibs'] || '').split(';'));
    }));
};

/**
 * Updates action states depending on the selection.
 */
App.prototype.loadLibraries = function (libs, done) {
    if (this.sidebar != null) {
        if (this.pendingLibraries == null) {
            this.pendingLibraries = new Object();
        }

        // Ignores this library next time
        var ignore = mxUtils.bind(this, function (id, keep) {
            if (!keep) {
                mxSettings.removeCustomLibrary(id);
            }

            delete this.pendingLibraries[id];
        });

        var waiting = 0;
        var files = [];

        // Loads in order of libs array
        var checkDone = mxUtils.bind(this, function () {
            if (waiting == 0) {
                if (libs != null) {
                    for (var i = libs.length - 1; i >= 0; i--) {
                        if (files[i] != null) {
                            this.loadLibrary(files[i]);
                        }
                    }
                }

                if (done != null) {
                    done();
                }
            }
        });

        if (libs != null) {
            for (var i = 0; i < libs.length; i++) {
                var name = encodeURIComponent(decodeURIComponent(libs[i]));

                (mxUtils.bind(this, function (id, index) {
                    if (id != null && id.length > 0 && this.pendingLibraries[id] == null &&
                        this.sidebar.palettes[id] == null) {
                        // Waits for all libraries to load
                        waiting++;

                        var onload = mxUtils.bind(this, function (file) {
                            delete this.pendingLibraries[id];
                            files[index] = file;
                            waiting--;
                            checkDone();
                        });

                        var onerror = mxUtils.bind(this, function (keep) {
                            ignore(id, keep);
                            waiting--;
                            checkDone();
                        });

                        this.pendingLibraries[id] = true;
                        var service = id.substring(0, 1);

                        if (service == 'L') {
                            if (isLocalStorage || mxClient.IS_CHROMEAPP) {
                                // Make asynchronous for barrier to work
                                window.setTimeout(mxUtils.bind(this, function () {
                                    try {
                                        var name = decodeURIComponent(id.substring(1));

                                        var xml = this.getLocalData(name, mxUtils.bind(this, function (xml) {
                                            if (name == '.scratchpad' && xml == null) {
                                                xml = this.emptyLibraryXml;
                                            }

                                            if (xml != null) {
                                                onload(new StorageLibrary(this, xml, name));
                                            } else {
                                                onerror();
                                            }
                                        }));
                                    } catch (e) {
                                        onerror();
                                    }
                                }), 0);
                            }
                        } else if (service == 'U') {
                            var url = decodeURIComponent(id.substring(1));

                            if (!this.isOffline()) {
                                var realUrl = url;

                                if (!this.editor.isCorsEnabledForUrl(realUrl)) {
                                    var nocache = 't=' + new Date().getTime();
                                    realUrl = PROXY_URL + '?url=' + encodeURIComponent(url) + '&' + nocache;
                                }

                                try {
                                    // Uses proxy to avoid CORS issues
                                    mxUtils.get(realUrl, mxUtils.bind(this, function (req) {
                                        if (req.getStatus() >= 200 && req.getStatus() <= 299) {
                                            try {
                                                onload(new UrlLibrary(this, req.getText(), url));
                                            } catch (e) {
                                                onerror();
                                            }
                                        } else {
                                            onerror();
                                        }
                                    }), function () {
                                        onerror();
                                    });
                                } catch (e) {
                                    onerror();
                                }
                            }
                        } else if (service == 'R') {
                            var libDesc = decodeURIComponent(id.substring(1));

                            if (!this.isOffline()) {
                                try {
                                    libDesc = JSON.parse(libDesc);
                                    var libObj = {
                                        id: libDesc[0],
                                        title: libDesc[1],
                                        downloadUrl: libDesc[2]
                                    }

                                    this.remoteInvoke('getFileContent', [libObj.downloadUrl], null, mxUtils.bind(this, function (libContent) {
                                        try {
                                            onload(new RemoteLibrary(this, libContent, libObj));
                                        } catch (e) {
                                            onerror();
                                        }
                                    }), function () {
                                        onerror();
                                    });
                                } catch (e) {
                                    onerror();
                                }
                            }
                        } else if (service == 'S' && this.loadDesktopLib != null) {
                            try {
                                this.loadDesktopLib(decodeURIComponent(id.substring(1)), function (desktopLib) {
                                    onload(desktopLib);
                                }, onerror);
                            } catch (e) {
                                onerror();
                            }
                        } else {
                            var peer = null;

                            if (service == 'G') {
                                if (this.drive != null && this.drive.user != null) {
                                    peer = this.drive;
                                }
                            } else if (service == 'H') {
                                if (this.gitHub != null && this.gitHub.getUser() != null) {
                                    peer = this.gitHub;
                                }
                            } else if (service == 'T') {
                                if (this.trello != null && this.trello.isAuthorized()) {
                                    peer = this.trello;
                                }
                            } else if (service == 'D') {
                                if (this.dropbox != null && this.dropbox.getUser() != null) {
                                    peer = this.dropbox;
                                }
                            } else if (service == 'W') {
                                if (this.oneDrive != null && this.oneDrive.getUser() != null) {
                                    peer = this.oneDrive;
                                }
                            }

                            if (peer != null) {
                                peer.getLibrary(decodeURIComponent(id.substring(1)), mxUtils.bind(this, function (file) {
                                    try {
                                        onload(file);
                                    } catch (e) {
                                        onerror();
                                    }
                                }), function (resp) {
                                    onerror();
                                });
                            } else {
                                onerror(true);
                            }
                        }
                    }
                }))(name, i);
            }

            checkDone();
        } else {
            checkDone();
        }
    }
};

/**
 * Translates this point by the given vector.
 *
 * @param {number} dx X-coordinate of the translation.
 * @param {number} dy Y-coordinate of the translation.
 */
App.prototype.updateButtonContainer = function () {
    if (this.buttonContainer != null) {
        var file = this.getCurrentFile();

        // Comments
        if (this.commentsSupported()) {
            if (this.commentButton == null) {
                this.commentButton = document.createElement('a');
                this.commentButton.setAttribute('title', mxResources.get('comments'));
                this.commentButton.className = 'geToolbarButton';
                this.commentButton.style.cssText = 'display:inline-block;position:relative;box-sizing:border-box;' +
                    'margin-right:4px;float:left;cursor:pointer;width:24px;height:24px;background-size:24px 24px;' +
                    'background-position:center center;background-repeat:no-repeat;background-image:' +
                    'url(' + Editor.commentImage + ');';

                if (uiTheme == 'atlas') {
                    this.commentButton.style.marginRight = '10px';
                    this.commentButton.style.marginTop = '-3px';
                } else if (uiTheme == 'min') {
                    this.commentButton.style.marginTop = '1px';
                } else {
                    this.commentButton.style.marginTop = '-5px';
                }

                mxEvent.addListener(this.commentButton, 'click', mxUtils.bind(this, function () {
                    this.actions.get('comments').funct();
                }));

                this.buttonContainer.appendChild(this.commentButton);

                if (uiTheme == 'dark' || uiTheme == 'atlas') {
                    this.commentButton.style.filter = 'invert(100%)';
                }
            }
        } else if (this.commentButton != null) {
            this.commentButton.parentNode.removeChild(this.commentButton);
            this.commentButton = null;
        }

        // Share
        if (file != null && file.constructor == DriveFile) {
            if (this.shareButton == null) {
                this.shareButton = document.createElement('div');
                this.shareButton.className = 'geBtn gePrimaryBtn';
                this.shareButton.style.display = 'inline-block';
                this.shareButton.style.backgroundColor = '#F2931E';
                this.shareButton.style.borderColor = '#F08705';
                this.shareButton.style.backgroundImage = 'none';
                this.shareButton.style.padding = '2px 10px 0 10px';
                this.shareButton.style.marginTop = '-10px';
                this.shareButton.style.height = '28px';
                this.shareButton.style.lineHeight = '28px';
                this.shareButton.style.minWidth = '0px';
                this.shareButton.style.cssFloat = 'right';
                this.shareButton.setAttribute('title', mxResources.get('share'));

                var icon = document.createElement('img');
                icon.setAttribute('src', this.shareImage);
                icon.setAttribute('align', 'absmiddle');
                icon.style.marginRight = '4px';
                icon.style.marginTop = '-3px';
                this.shareButton.appendChild(icon);

                if (uiTheme != 'dark' && uiTheme != 'atlas') {
                    this.shareButton.style.color = 'black';
                    icon.style.filter = 'invert(100%)';
                }

                mxUtils.write(this.shareButton, mxResources.get('share'));

                mxEvent.addListener(this.shareButton, 'click', mxUtils.bind(this, function () {
                    this.actions.get('share').funct();
                }));

                this.buttonContainer.appendChild(this.shareButton);
            }
        } else if (this.shareButton != null) {
            this.shareButton.parentNode.removeChild(this.shareButton);
            this.shareButton = null;
        }
    }
};

/**
 * Translates this point by the given vector.
 *
 * @param {number} dx X-coordinate of the translation.
 * @param {number} dy Y-coordinate of the translation.
 */
App.prototype.save = function (name, done) {
    var file = this.getCurrentFile();
    var msg = mxResources.get('saving');

    if (file != null && this.spinner.spin(document.body, msg)) {
        this.editor.setStatus('');

        if (this.editor.graph.isEditing()) {
            this.editor.graph.stopEditing();
        }

        var success = mxUtils.bind(this, function () {
            file.handleFileSuccess(true);

            if (done != null) {
                done();
            }
        });

        var error = mxUtils.bind(this, function (err) {
            file.handleFileError(err, true);
        });

        try {
            if (name == file.getTitle()) {
                file.save(true, success, error);
            } else {
                file.saveAs(name, success, error)
            }
        } catch (err) {
            file.handleFileError(err, true);
        }
    }
};

/**
 * Invokes callback with null if mode does not support folder or not null
 * if a valid folder was chosen for a mode that supports it. No callback
 * is made if no folder was chosen for a mode that supports it.
 */
App.prototype.pickFolder = function (mode, fn, enabled, direct, force) {
    enabled = (enabled != null) ? enabled : true;
    var resume = this.spinner.pause();

    EditorUi.prototype.pickFolder.apply(this, arguments);
};

/**
 *
 */
App.prototype.exportFile = function (data, filename, mimeType, base64Encoded, mode, folderId) {
    if (mode == App.MODE_BROWSER) {
        var fn = mxUtils.bind(this, function () {
            localStorage.setItem(filename, data);
        });

        if (localStorage.getItem(filename) == null) {
            fn();
        } else {
            this.confirm(mxResources.get('replaceIt', [filename]), fn);
        }
    }
};

/**
 * Translates this point by the given vector.
 *
 * @param {number} dx X-coordinate of the translation.
 * @param {number} dy Y-coordinate of the translation.
 */
App.prototype.descriptorChanged = function () {
    var file = this.getCurrentFile();

    if (file != null) {
        if (this.fname != null) {
            this.fnameWrapper.style.display = 'block';
            this.fname.innerHTML = '';
            var filename = (file.getTitle() != null) ? file.getTitle() : this.defaultFilename;
            mxUtils.write(this.fname, filename);
            this.fname.setAttribute('title', filename + ' - ' + mxResources.get('rename'));
        }

        var graph = this.editor.graph;
        var editable = file.isEditable() && !file.invalidChecksum;

        if (graph.isEnabled() && !editable) {
            graph.reset();
        }

        graph.setEnabled(editable);

        // Ignores title and hash for revisions
        if (urlParams['rev'] == null) {
            this.updateDocumentTitle();
            var newHash = file.getHash();

            if (newHash.length > 0) {
                window.location.hash = newHash;
            } else if (window.location.hash.length > 0) {
                window.location.hash = '';
            }
        }
    }

    this.updateUi();

    if (this.format != null && this.editor.graph.isSelectionEmpty()) {
        this.format.refresh();
    }
};

/**
 * Adds the listener for automatically saving the diagram for local changes.
 */
App.prototype.showAuthDialog = function (peer, showRememberOption, fn, closeFn) {
    var resume = this.spinner.pause();

    this.showDialog(new AuthDialog(this, peer, showRememberOption, mxUtils.bind(this, function (remember) {
        try {
            if (fn != null) {
                fn(remember, mxUtils.bind(this, function () {
                    this.hideDialog();
                    resume();
                }));
            }
        } catch (e) {
            this.editor.setStatus(mxUtils.htmlEntities(e.message));
        }
    })).container, 300, (showRememberOption) ? 220 : 140, true, true, mxUtils.bind(this, function (cancel) {
        if (closeFn != null) {
            closeFn();
        }

        if (cancel && this.getCurrentFile() == null && this.dialog == null) {
            this.showSplash();
        }
    }));
};

/**
 * Checks if the client is authorized and calls the next step. The optional
 * readXml argument is used for import. Default is false. The optional
 * readLibrary argument is used for reading libraries. Default is false.
 */
App.prototype.convertFile = function (url, filename, mimeType, extension, success, error) {
    var name = filename;

    // SVG file extensions are valid and needed for image import
    if (!/\.svg$/i.test(name)) {
        name = name.substring(0, filename.lastIndexOf('.')) + extension;
    }

    var gitHubUrl = false;

    if (this.gitHub != null && url.substring(0, this.gitHub.baseUrl.length) == this.gitHub.baseUrl) {
        gitHubUrl = true;
    }

    // Workaround for wrong binary response with VSD(X) & VDX files
    if (/\.v(dx|sdx?)$/i.test(filename) && Graph.fileSupport && new XMLHttpRequest().upload &&
        typeof new XMLHttpRequest().responseType === 'string') {
        var req = new XMLHttpRequest();
        req.open('GET', url, true);

        if (!gitHubUrl) {
            req.responseType = 'blob';
        }

        req.onload = mxUtils.bind(this, function () {
            if (req.status >= 200 && req.status <= 299) {
                var blob = null;

                if (gitHubUrl) {
                    var file = JSON.parse(req.responseText);
                    blob = this.base64ToBlob(file.content, 'application/octet-stream');
                } else {
                    blob = new Blob([req.response], {type: 'application/octet-stream'});
                }

                this.importVisio(blob, mxUtils.bind(this, function (xml) {
                    success(new LocalFile(this, xml, name, true));
                }), error, filename)
            } else if (error != null) {
                error({message: mxResources.get('errorLoadingFile')});
            }
        });

        req.onerror = error;
        req.send();
    } else {
        var handleData = mxUtils.bind(this, function (data) {
            try {
                if (/\.png$/i.test(filename)) {
                    temp = this.extractGraphModelFromPng(data);

                    if (temp != null) {
                        success(new LocalFile(this, temp, name, true));
                    } else {
                        success(new LocalFile(this, data, filename, true));
                    }
                } else if (Graph.fileSupport && new XMLHttpRequest().upload && this.isRemoteFileFormat(data, url)) {
                    this.parseFile(new Blob([data], {type: 'application/octet-stream'}), mxUtils.bind(this, function (xhr) {
                        if (xhr.readyState == 4) {
                            if (xhr.status >= 200 && xhr.status <= 299) {
                                success(new LocalFile(this, xhr.responseText, name, true));
                            } else if (error != null) {
                                error({message: mxResources.get('errorLoadingFile')});
                            }
                        }
                    }), filename);
                } else {
                    success(new LocalFile(this, data, name, true));
                }
            } catch (e) {
                if (error != null) {
                    error(e);
                }
            }
        });

        var binary = /\.png$/i.test(filename) || /\.jpe?g$/i.test(filename) || (mimeType != null &&
            mimeType.substring(0, 6) == 'image/');

        // NOTE: Cannot force non-binary request via loadUrl so needs separate
        // code as decoding twice on content with binary data did not work
        if (gitHubUrl) {
            mxUtils.get(url, mxUtils.bind(this, function (req) {
                if (req.getStatus() >= 200 && req.getStatus() <= 299) {
                    if (success != null) {
                        var file = JSON.parse(req.getText());
                        var data = file.content;

                        if (file.encoding === 'base64') {
                            if (/\.png$/i.test(filename)) {
                                data = 'data:image/png;base64,' + data;
                            } else {
                                // Workaround for character encoding issues in IE10/11
                                data = (window.atob && !mxClient.IS_IE && !mxClient.IS_IE11) ? atob(data) : Base64.decode(data);
                            }
                        }

                        handleData(data);
                    }
                } else if (error != null) {
                    error({code: App.ERROR_UNKNOWN});
                }
            }), function () {
                if (error != null) {
                    error({code: App.ERROR_UNKNOWN});
                }
            }, false, this.timeout, function () {
                if (error != null) {
                    error({code: App.ERROR_TIMEOUT, retry: fn});
                }
            });
        } else {
            this.loadUrl(url, handleData, error, binary);
        }
    }
};

/**
 * Adds the listener for automatically saving the diagram for local changes.
 */
App.prototype.updateHeader = function () {
    if (this.menubar != null) {
        this.appIcon = document.createElement('a');
        this.appIcon.style.display = 'block';
        this.appIcon.style.position = 'absolute';
        this.appIcon.style.width = '36px';
        this.appIcon.style.height = (this.menubarHeight - 28) + 'px';
        this.appIcon.style.margin = '14px 0px 8px 20px';
        this.appIcon.style.opacity = '0.75';
        this.appIcon.style.borderRadius = '3px';

        // if (uiTheme != 'dark') {
        //     this.appIcon.style.backgroundColor = '#f08705';
        // }

        mxEvent.disableContextMenu(this.appIcon);

        mxEvent.addListener(this.appIcon, 'click', mxUtils.bind(this, function (evt) {
            this.appIconClicked(evt);
        }));

        // LATER: Use Alpha image loader in IE6
        // NOTE: This uses the diagram bit of the old logo as it looks better in this case
        //this.appIcon.style.filter = 'progid:DXImageTransform.Microsoft.AlphaImageLoader(src=' + IMAGE_PATH + '/logo-white.png,sizingMethod=\'scale\')';
        var logo = 'url(\'' + IMAGE_PATH + '/janus-logo-circle.png\')';
        this.appIcon.style.backgroundImage = logo;
        this.appIcon.style.backgroundPosition = 'center center';
        this.appIcon.style.backgroundSize = '100% 100%';
        this.appIcon.style.backgroundRepeat = 'no-repeat';

        mxUtils.setPrefixedStyle(this.appIcon.style, 'transition', 'all 125ms linear');

        mxEvent.addListener(this.appIcon, 'mouseover', mxUtils.bind(this, function () {
            var file = this.getCurrentFile();

            if (file != null) {
                var mode = file.getMode();
            }
        }));

        mxEvent.addListener(this.appIcon, 'mouseout', mxUtils.bind(this, function () {
            this.appIcon.style.backgroundImage = logo;
            this.appIcon.style.backgroundSize = '90% 90%';
        }));

        if (urlParams['embed'] != '1') {
            this.menubarContainer.appendChild(this.appIcon);
        }

        this.fnameWrapper = document.createElement('div');
        this.fnameWrapper.style.position = 'absolute';
        this.fnameWrapper.style.right = '120px';
        this.fnameWrapper.style.left = '60px';
        this.fnameWrapper.style.top = '9px';
        this.fnameWrapper.style.height = '26px';
        this.fnameWrapper.style.display = 'none';
        this.fnameWrapper.style.overflow = 'hidden';
        this.fnameWrapper.style.textOverflow = 'ellipsis';

        this.fname = document.createElement('a');
        this.fname.setAttribute('title', mxResources.get('rename'));
        this.fname.className = 'geItem';
        this.fname.style.padding = '2px 8px 2px 8px';
        this.fname.style.display = 'inline';
        this.fname.style.fontSize = '18px';
        this.fname.style.whiteSpace = 'nowrap';

        // Prevents focus
        mxEvent.addListener(this.fname, (mxClient.IS_POINTER) ? 'pointerdown' : 'mousedown',
            mxUtils.bind(this, function (evt) {
                evt.preventDefault();
            }));

        mxEvent.addListener(this.fname, 'click', mxUtils.bind(this, function (evt) {
            var file = this.getCurrentFile();

            if (file != null && file.isRenamable()) {
                if (this.editor.graph.isEditing()) {
                    this.editor.graph.stopEditing();
                }

                this.actions.get('rename').funct();
            }

            mxEvent.consume(evt);
        }));

        this.fnameWrapper.appendChild(this.fname);

        if (urlParams['embed'] != '1') {
            this.menubarContainer.appendChild(this.fnameWrapper);

            this.menubar.container.style.position = 'absolute';
            this.menubar.container.style.paddingLeft = '59px';
            this.toolbar.container.style.paddingLeft = '16px';
            this.menubar.container.style.boxSizing = 'border-box';
            this.menubar.container.style.top = '34px';
        }

        /**
         * Adds format panel toggle.
         */
        this.toggleFormatElement = document.createElement('a');
        this.toggleFormatElement.setAttribute('title', mxResources.get('formatPanel') + ' (' + Editor.ctrlKey + '+Shift+P)');
        this.toggleFormatElement.style.position = 'absolute';
        this.toggleFormatElement.style.display = 'inline-block';
        this.toggleFormatElement.style.top = (uiTheme == 'atlas') ? '8px' : '6px';
        this.toggleFormatElement.style.right = (uiTheme != 'atlas' && urlParams['embed'] != '1') ? '30px' : '10px';
        this.toggleFormatElement.style.padding = '2px';
        this.toggleFormatElement.style.fontSize = '14px';
        this.toggleFormatElement.className = (uiTheme != 'atlas') ? 'geButton' : '';
        this.toggleFormatElement.style.width = '16px';
        this.toggleFormatElement.style.height = '16px';
        this.toggleFormatElement.style.backgroundPosition = '50% 50%';
        this.toggleFormatElement.style.backgroundRepeat = 'no-repeat';
        this.toolbarContainer.appendChild(this.toggleFormatElement);

        if (uiTheme == 'dark') {
            this.toggleFormatElement.style.filter = 'invert(100%)';
        }

        // Prevents focus
        mxEvent.addListener(this.toggleFormatElement, (mxClient.IS_POINTER) ? 'pointerdown' : 'mousedown',
            mxUtils.bind(this, function (evt) {
                evt.preventDefault();
            }));

        mxEvent.addListener(this.toggleFormatElement, 'click', mxUtils.bind(this, function (evt) {
            this.actions.get('formatPanel').funct();
            mxEvent.consume(evt);
        }));

        var toggleFormatPanel = mxUtils.bind(this, function () {
            if (this.formatWidth > 0) {
                this.toggleFormatElement.style.backgroundImage = 'url(\'' + this.formatShowImage + '\')';
            } else {
                this.toggleFormatElement.style.backgroundImage = 'url(\'' + this.formatHideImage + '\')';
            }
        });

        this.addListener('formatWidthChanged', toggleFormatPanel);
        toggleFormatPanel();

        this.fullscreenElement = document.createElement('a');
        this.fullscreenElement.setAttribute('title', mxResources.get('fullscreen'));
        this.fullscreenElement.style.position = 'absolute';
        this.fullscreenElement.style.display = 'inline-block';
        this.fullscreenElement.style.top = (uiTheme == 'atlas') ? '8px' : '6px';
        this.fullscreenElement.style.right = (uiTheme != 'atlas' && urlParams['embed'] != '1') ? '50px' : '30px';
        this.fullscreenElement.style.padding = '2px';
        this.fullscreenElement.style.fontSize = '14px';
        this.fullscreenElement.className = (uiTheme != 'atlas') ? 'geButton' : '';
        this.fullscreenElement.style.width = '16px';
        this.fullscreenElement.style.height = '16px';
        this.fullscreenElement.style.backgroundPosition = '50% 50%';
        this.fullscreenElement.style.backgroundRepeat = 'no-repeat';
        this.fullscreenElement.style.backgroundImage = 'url(\'' + this.fullscreenImage + '\')';
        this.toolbarContainer.appendChild(this.fullscreenElement);

        // Prevents focus
        mxEvent.addListener(this.fullscreenElement, (mxClient.IS_POINTER) ? 'pointerdown' : 'mousedown',
            mxUtils.bind(this, function (evt) {
                evt.preventDefault();
            }));

        // Some style changes in Atlas theme
        if (uiTheme == 'atlas') {
            mxUtils.setOpacity(this.toggleFormatElement, 70);
            mxUtils.setOpacity(this.fullscreenElement, 70);
        }

        var initialPosition = this.hsplitPosition;
        var collapsed = false;

        if (uiTheme == 'dark') {
            this.fullscreenElement.style.filter = 'invert(100%)';
        }

        mxEvent.addListener(this.fullscreenElement, 'click', mxUtils.bind(this, function (evt) {
            if (uiTheme != 'atlas' && urlParams['embed'] != '1') {
                this.toggleCompactMode(!collapsed);
            }

            this.toggleFormatPanel(!collapsed);
            this.hsplitPosition = (!collapsed) ? 0 : initialPosition;
            this.hideFooter();
            collapsed = !collapsed;
            mxEvent.consume(evt);
        }));

        /**
         * Adds compact UI toggle.
         */
        if (urlParams['embed'] != '1') {
            this.toggleElement = document.createElement('a');
            this.toggleElement.setAttribute('title', mxResources.get('collapseExpand'));
            this.toggleElement.className = 'geButton';
            this.toggleElement.style.position = 'absolute';
            this.toggleElement.style.display = 'inline-block';
            this.toggleElement.style.width = '16px';
            this.toggleElement.style.height = '16px';
            this.toggleElement.style.color = '#666';
            this.toggleElement.style.top = (uiTheme == 'atlas') ? '8px' : '6px';
            this.toggleElement.style.right = '10px';
            this.toggleElement.style.padding = '2px';
            this.toggleElement.style.fontSize = '14px';
            this.toggleElement.style.textDecoration = 'none';
            this.toggleElement.style.backgroundImage = 'url(\'' + this.chevronUpImage + '\')';

            this.toggleElement.style.backgroundPosition = '50% 50%';
            this.toggleElement.style.backgroundRepeat = 'no-repeat';

            if (uiTheme == 'dark') {
                this.toggleElement.style.filter = 'invert(100%)';
            }

            // Prevents focus
            mxEvent.addListener(this.toggleElement, (mxClient.IS_POINTER) ? 'pointerdown' : 'mousedown',
                mxUtils.bind(this, function (evt) {
                    evt.preventDefault();
                }));

            // Toggles compact mode
            mxEvent.addListener(this.toggleElement, 'click', mxUtils.bind(this, function (evt) {
                this.toggleCompactMode();
                mxEvent.consume(evt);
            }));

            if (uiTheme != 'atlas') {
                this.toolbarContainer.appendChild(this.toggleElement);
            }

            // Enable compact mode for small screens except for Firefox where the height is wrong
            if (!mxClient.IS_FF && screen.height <= 740 && typeof this.toggleElement.click !== 'undefined') {
                window.setTimeout(mxUtils.bind(this, function () {
                    this.toggleElement.click();
                }), 0);
            }
        }
    }
};

/**
 * Adds the listener for automatically saving the diagram for local changes.
 */
App.prototype.toggleCompactMode = function (forceHide) {
    if (!forceHide && this.appIcon.style.display == 'none') {
        this.menubar.container.style.position = 'absolute';
        this.menubar.container.style.paddingLeft = '59px';
        this.menubar.container.style.paddingTop = '';
        this.menubar.container.style.paddingBottom = '';
        this.menubar.container.style.top = '34px';
        this.toolbar.container.style.paddingLeft = '16px';
        this.buttonContainer.style.visibility = 'visible';
        this.appIcon.style.display = 'block';
        this.fnameWrapper.style.display = 'block';
        this.fnameWrapper.style.visibility = 'visible';
        this.menubarHeight = App.prototype.menubarHeight;
        this.refresh();
        this.toggleElement.style.backgroundImage = 'url(\'' + this.chevronUpImage + '\')';
    } else {
        this.menubar.container.style.position = 'relative';
        this.menubar.container.style.paddingLeft = '4px';
        this.menubar.container.style.paddingTop = '0px';
        this.menubar.container.style.paddingBottom = '0px';
        this.menubar.container.style.top = '0px';
        this.toolbar.container.style.paddingLeft = '8px';
        this.buttonContainer.style.visibility = 'hidden';
        this.appIcon.style.display = 'none';
        this.fnameWrapper.style.display = 'none';
        this.fnameWrapper.style.visibility = 'hidden';
        this.menubarHeight = EditorUi.prototype.menubarHeight;
        this.refresh();
        this.toggleElement.style.backgroundImage = 'url(\'' + this.chevronDownImage + '\')';
    }
};

/**
 * Adds the listener for automatically saving the diagram for local changes.
 */
App.prototype.updateUserElement = function () {
    if ((this.drive == null || this.drive.getUser() == null) &&
        (this.oneDrive == null || this.oneDrive.getUser() == null) &&
        (this.dropbox == null || this.dropbox.getUser() == null) &&
        (this.gitHub == null || this.gitHub.getUser() == null) &&
        (this.gitLab == null || this.gitLab.getUser() == null) &&
        (this.trello == null || !this.trello.isAuthorized())) //TODO Trello no user issue
    {
        if (this.userElement != null) {
            this.userElement.parentNode.removeChild(this.userElement);
            this.userElement = null;
        }
    } else {
        if (this.userElement == null) {
            this.userElement = document.createElement('a');
            this.userElement.className = 'geItem';
            this.userElement.style.position = 'absolute';
            this.userElement.style.fontSize = '8pt';
            this.userElement.style.top = (uiTheme == 'atlas') ? '8px' : '2px';
            this.userElement.style.right = '30px';
            this.userElement.style.margin = '4px';
            this.userElement.style.padding = '2px';
            this.userElement.style.paddingRight = '16px';
            this.userElement.style.verticalAlign = 'middle';
            this.userElement.style.backgroundImage = 'url(' + IMAGE_PATH + '/expanded.gif)';
            this.userElement.style.backgroundPosition = '100% 60%';
            this.userElement.style.backgroundRepeat = 'no-repeat';

            this.menubarContainer.appendChild(this.userElement);

            // Prevents focus
            mxEvent.addListener(this.userElement, (mxClient.IS_POINTER) ? 'pointerdown' : 'mousedown',
                mxUtils.bind(this, function (evt) {
                    evt.preventDefault();
                }));

            mxEvent.addListener(this.userElement, 'click', mxUtils.bind(this, function (evt) {
                if (this.userPanel == null) {
                    var div = document.createElement('div');
                    div.className = 'geDialog';
                    div.style.position = 'absolute';
                    div.style.top = (this.userElement.clientTop + this.userElement.clientHeight + 6) + 'px';
                    div.style.right = '36px';
                    div.style.padding = '0px';
                    div.style.cursor = 'default';

                    this.userPanel = div;
                }

                if (this.userPanel.parentNode != null) {
                    this.userPanel.parentNode.removeChild(this.userPanel);
                } else {
                    var connected = false;
                    this.userPanel.innerHTML = '';

                    var img = document.createElement('img');

                    img.setAttribute('src', Dialog.prototype.closeImage);
                    img.setAttribute('title', mxResources.get('close'));
                    img.className = 'geDialogClose';
                    img.style.top = '8px';
                    img.style.right = '8px';

                    mxEvent.addListener(img, 'click', mxUtils.bind(this, function () {
                        if (this.userPanel.parentNode != null) {
                            this.userPanel.parentNode.removeChild(this.userPanel);
                        }
                    }));

                    this.userPanel.appendChild(img);

                    if (this.drive != null) {
                        var driveUser = this.drive.getUser();

                        if (driveUser != null) {
                            connected = true;
                            this.userPanel.innerHTML += '<table title="User ID: ' + driveUser.id +
                                '" style="font-size:10pt;padding:20px 20px 10px 10px;">' +
                                '<tr><td valign="middle">' +
                                ((driveUser.pictureUrl != null) ?
                                    '<img width="50" height="50" style="margin-right:8px;border-radius:50%;" src="' + driveUser.pictureUrl + '"/>' :
                                    '<img width="46" height="46" style="margin-right:4px;margin-top:0px;" src="' + this.defaultUserPicture + '"/>') +
                                '</td><td valign="top" style="white-space:nowrap;' +
                                ((driveUser.pictureUrl != null) ? 'padding-top:4px;' : '') +
                                '">' + mxUtils.htmlEntities(driveUser.displayName) + '<br>' +
                                '<small style="color:gray;">' + mxUtils.htmlEntities(driveUser.email) +
                                '</small><div style="margin-top:4px;"><i>' +
                                mxResources.get('googleDrive') + '</i></div></tr></table>';
                            var div = document.createElement('div');
                            div.style.textAlign = 'center';
                            div.style.paddingBottom = '12px';
                            div.style.whiteSpace = 'nowrap';

                            // LATER: Cannot change user while file is open since close will not work with new
                            // credentials and closing the file using fileLoaded(null) will show splash dialog.
                            var btn = mxUtils.button(mxResources.get('signOut'), mxUtils.bind(this, function () {
                                var file = this.getCurrentFile();

                                if (file != null && file.constructor == DriveFile) {
                                    this.confirm(mxResources.get('areYouSure'), mxUtils.bind(this, function () {
                                        this.spinner.spin(document.body, mxResources.get('signOut'));

                                        this.diagramContainer.style.display = 'none';
                                        this.formatContainer.style.display = 'none';
                                        this.hsplit.style.display = 'none';
                                        this.sidebarContainer.style.display = 'none';
                                        this.sidebarFooterContainer.style.display = 'none';

                                        if (this.tabContainer != null) {
                                            this.tabContainer.style.display = 'none';
                                        }

                                        file.close();

                                        // LATER: Use callback to wait for thumbnail update
                                        window.setTimeout(mxUtils.bind(this, function () {
                                            // Workaround to disable the splash screen before reload
                                            this.showDialog = function () {
                                            };
                                            window.location.hash = '';
                                            this.drive.clearUserId();
                                            gapi.auth.signOut();

                                            // Reload page to reset client auth
                                            window.location.reload();
                                        }), (file != null && file.constructor == DriveFile) ? 2000 : 0);
                                    }));
                                } else {
                                    this.drive.clearUserId();
                                    this.drive.setUser(null);
                                    gapi.auth.signOut();
                                }
                            }));
                            btn.className = 'geBtn';
                            div.appendChild(btn);
                            this.userPanel.appendChild(div);
                        }
                    }

                    var addUser = mxUtils.bind(this, function (user, logo, logout, label) {
                        if (user != null) {
                            if (connected) {
                                this.userPanel.appendChild(document.createElement('hr'));
                            }

                            connected = true;
                            this.userPanel.innerHTML += '<table style="font-size:10pt;padding:20px 20px 10px 10px;"><tr><td valign="top">' +
                                ((logo != null) ? '<img style="margin-right:6px;" src="' + logo + '" width="40" height="40"/></td>' : '') +
                                '<td valign="middle" style="white-space:nowrap;">' + mxUtils.htmlEntities(user.displayName) +
                                ((user.email != null) ? '<br><small style="color:gray;">' + mxUtils.htmlEntities(user.email) + '</small>' : '') +
                                ((label != null) ? '<div style="margin-top:4px;"><i>' + mxUtils.htmlEntities(label) + '</i></div>' : '') +
                                '</td></tr></table>';
                            var div = document.createElement('div');
                            div.style.textAlign = 'center';
                            div.style.paddingBottom = '12px';
                            div.style.whiteSpace = 'nowrap';

                            if (logout != null) {
                                var btn = mxUtils.button(mxResources.get('signOut'), logout);
                                btn.className = 'geBtn';
                                div.appendChild(btn);
                            }

                            this.userPanel.appendChild(div);
                        }
                    });

                    if (this.dropbox != null) {
                        addUser(this.dropbox.getUser(), IMAGE_PATH + '/dropbox-logo.svg', mxUtils.bind(this, function () {
                            var file = this.getCurrentFile();

                            if (file != null && file.constructor == DropboxFile) {
                                var doLogout = mxUtils.bind(this, function () {
                                    this.dropbox.logout();
                                    window.location.hash = '';
                                });

                                if (!file.isModified()) {
                                    doLogout();
                                } else {
                                    this.confirm(mxResources.get('allChangesLost'), null, doLogout,
                                        mxResources.get('cancel'), mxResources.get('discardChanges'));
                                }
                            } else {
                                this.dropbox.logout();
                            }
                        }), mxResources.get('dropbox'));
                    }

                    if (this.oneDrive != null) {
                        addUser(this.oneDrive.getUser(), IMAGE_PATH + '/onedrive-logo.svg', mxUtils.bind(this, function () {
                            var file = this.getCurrentFile();

                            if (file != null && file.constructor == OneDriveFile) {
                                var doLogout = mxUtils.bind(this, function () {
                                    this.oneDrive.logout();
                                    window.location.hash = '';
                                });

                                if (!file.isModified()) {
                                    doLogout();
                                } else {
                                    this.confirm(mxResources.get('allChangesLost'), null, doLogout,
                                        mxResources.get('cancel'), mxResources.get('discardChanges'));
                                }
                            } else {
                                this.oneDrive.logout();
                            }
                        }), mxResources.get('oneDrive'));
                    }

                    if (this.gitHub != null) {
                        addUser(this.gitHub.getUser(), IMAGE_PATH + '/github-logo.svg', mxUtils.bind(this, function () {
                            var file = this.getCurrentFile();

                            if (file != null && file.constructor == GitHubFile) {
                                var doLogout = mxUtils.bind(this, function () {
                                    this.gitHub.logout();
                                    window.location.hash = '';
                                });

                                if (!file.isModified()) {
                                    doLogout();
                                } else {
                                    this.confirm(mxResources.get('allChangesLost'), null, doLogout,
                                        mxResources.get('cancel'), mxResources.get('discardChanges'));
                                }
                            } else {
                                this.gitHub.logout();
                            }
                        }), mxResources.get('github'));
                    }

                    if (this.gitLab != null) {
                        addUser(this.gitLab.getUser(), IMAGE_PATH + '/gitlab-logo.svg', mxUtils.bind(this, function () {
                            var file = this.getCurrentFile();

                            if (file != null && file.constructor == GitLabFile) {
                                var doLogout = mxUtils.bind(this, function () {
                                    this.gitLab.logout();
                                    window.location.hash = '';
                                });

                                if (!file.isModified()) {
                                    doLogout();
                                } else {
                                    this.confirm(mxResources.get('allChangesLost'), null, doLogout,
                                        mxResources.get('cancel'), mxResources.get('discardChanges'));
                                }
                            } else {
                                this.gitLab.logout();
                            }
                        }), mxResources.get('gitlab'));
                    }

                    //TODO We have no user info from Trello, how we can create a user?
                    if (this.trello != null) {
                        addUser(this.trello.getUser(), IMAGE_PATH + '/trello-logo.svg', mxUtils.bind(this, function () {
                            var file = this.getCurrentFile();

                            if (file != null && file.constructor == TrelloFile) {
                                var doLogout = mxUtils.bind(this, function () {
                                    this.trello.logout();
                                    window.location.hash = '';
                                });

                                if (!file.isModified()) {
                                    doLogout();
                                } else {
                                    this.confirm(mxResources.get('allChangesLost'), null, doLogout,
                                        mxResources.get('cancel'), mxResources.get('discardChanges'));
                                }
                            } else {
                                this.trello.logout();
                            }
                        }), mxResources.get('trello'));
                    }

                    if (!connected) {
                        var div = document.createElement('div');
                        div.style.textAlign = 'center';
                        div.style.padding = '20px 20px 10px 10px';
                        div.innerHTML = mxResources.get('notConnected');

                        this.userPanel.appendChild(div);
                    }

                    var div = document.createElement('div');
                    div.style.textAlign = 'center';
                    div.style.padding = '12px';
                    div.style.background = 'whiteSmoke';
                    div.style.borderTop = '1px solid #e0e0e0';
                    div.style.whiteSpace = 'nowrap';

                    var btn = mxUtils.button(mxResources.get('close'), mxUtils.bind(this, function () {
                        if (!mxEvent.isConsumed(evt) && this.userPanel != null && this.userPanel.parentNode != null) {
                            this.userPanel.parentNode.removeChild(this.userPanel);
                        }
                    }));
                    btn.className = 'geBtn';
                    div.appendChild(btn);
                    this.userPanel.appendChild(div);

                    document.body.appendChild(this.userPanel);
                }

                mxEvent.consume(evt);
            }));

            mxEvent.addListener(document.body, 'click', mxUtils.bind(this, function (evt) {
                if (!mxEvent.isConsumed(evt) && this.userPanel != null && this.userPanel.parentNode != null) {
                    this.userPanel.parentNode.removeChild(this.userPanel);
                }
            }));
        }

        var user = null;

        if (this.drive != null && this.drive.getUser() != null) {
            user = this.drive.getUser();
        } else if (this.oneDrive != null && this.oneDrive.getUser() != null) {
            user = this.oneDrive.getUser();
        } else if (this.dropbox != null && this.dropbox.getUser() != null) {
            user = this.dropbox.getUser();
        } else if (this.gitHub != null && this.gitHub.getUser() != null) {
            user = this.gitHub.getUser();
        } else if (this.gitLab != null && this.gitLab.getUser() != null) {
            user = this.gitLab.getUser();
        }
        //TODO Trello no user issue

        if (user != null) {
            this.userElement.innerHTML = '';

            if (screen.width > 560) {
                mxUtils.write(this.userElement, user.displayName);
                this.userElement.style.display = 'block';
            }
        } else {
            this.userElement.style.display = 'none';
        }
    }
};

//TODO Use this function to get the currently logged in user
App.prototype.getCurrentUser = function () {
    var user = null;

    if (this.drive != null && this.drive.getUser() != null) {
        user = this.drive.getUser();
    } else if (this.oneDrive != null && this.oneDrive.getUser() != null) {
        user = this.oneDrive.getUser();
    } else if (this.dropbox != null && this.dropbox.getUser() != null) {
        user = this.dropbox.getUser();
    } else if (this.gitHub != null && this.gitHub.getUser() != null) {
        user = this.gitHub.getUser();
    }
    //TODO Trello no user issue

    return user;
}
/**
 * Override depends on mxSettings which is not defined in the minified viewer.
 */
var editorResetGraph = Editor.prototype.resetGraph;
Editor.prototype.resetGraph = function () {
    editorResetGraph.apply(this, arguments);

    // Overrides default with persisted value
    this.graph.pageFormat = mxSettings.getPageFormat();
};

/**
 * Copyright (c) 2006-2019, JGraph Ltd
 * Copyright (c) 2006-2019, draw.io AG
 */
(function () {
    // Adds scrollbars for menus that exceed the page height
    var mxPopupMenuShowMenu = mxPopupMenu.prototype.showMenu;
    mxPopupMenu.prototype.showMenu = function () {
        mxPopupMenuShowMenu.apply(this, arguments);

        this.div.style.overflowY = 'auto';
        this.div.style.overflowX = 'hidden';
        var h0 = Math.max(document.body.clientHeight, document.documentElement.clientHeight);
        this.div.style.maxHeight = (h0 - 10) + 'px';
    };

    Menus.prototype.createHelpLink = function (href) {
        var link = document.createElement('span');
        link.setAttribute('title', mxResources.get('help'));
        link.style.cssText = 'color:blue;text-decoration:underline;margin-left:8px;cursor:help;';

        var icon = document.createElement('img');
        mxUtils.setOpacity(icon, 50);
        icon.style.height = '16px';
        icon.style.width = '16px';
        icon.setAttribute('border', '0');
        icon.setAttribute('valign', 'bottom');
        icon.setAttribute('src', Editor.helpImage);
        link.appendChild(icon);

        mxEvent.addGestureListeners(link, mxUtils.bind(this, function (evt) {
            if (this.editorUi.menubar != null) {
                this.editorUi.menubar.hideMenu();
            }

            this.editorUi.openLink(href);
            mxEvent.consume(evt);
        }));

        return link;
    };

    Menus.prototype.addLinkToItem = function (item, href) {
        if (item != null) {
            item.firstChild.nextSibling.appendChild(this.createHelpLink(href));
        }
    };

    var menusInit = Menus.prototype.init;
    Menus.prototype.init = function () {
        menusInit.apply(this, arguments);
        var editorUi = this.editorUi;
        var graph = editorUi.editor.graph;
        var isGraphEnabled = mxUtils.bind(graph, graph.isEnabled);

        var rulerAction = editorUi.actions.addAction('ruler', function () {
            mxSettings.setRulerOn(!mxSettings.isRulerOn());
            mxSettings.save();

            if (editorUi.ruler != null) {
                editorUi.ruler.destroy();
                editorUi.ruler = null;
                editorUi.refresh();
            } else {
                editorUi.ruler = new mxDualRuler(editorUi, editorUi.editor.graph.view.unit);
                editorUi.refresh();
            }
        });
        rulerAction.setToggleAction(true);
        rulerAction.setSelectedCallback(function () {
            return editorUi.ruler != null;
        });

        editorUi.actions.addAction('editShape...', mxUtils.bind(this, function () {
            var cells = graph.getSelectionCells();

            if (graph.getSelectionCount() == 1) {
                var cell = graph.getSelectionCell();
                var state = graph.view.getState(cell);

                if (state != null && state.shape != null && state.shape.stencil != null) {
                    var dlg = new EditShapeDialog(editorUi, cell, mxResources.get('editShape') + ':', 630, 400);
                    editorUi.showDialog(dlg.container, 640, 480, true, false);
                    dlg.init();
                }
            }
        }));

        var autosaveAction = editorUi.actions.addAction('autosave', function () {
            editorUi.editor.setAutosave(!editorUi.editor.autosave);
        });

        autosaveAction.setToggleAction(true);
        autosaveAction.setSelectedCallback(function () {
            return autosaveAction.isEnabled() && editorUi.editor.autosave;
        });

        editorUi.actions.addAction('editGeometry...', function () {
            var cells = graph.getSelectionCells();
            var vertices = [];

            for (var i = 0; i < cells.length; i++) {
                if (graph.getModel().isVertex(cells[i])) {
                    vertices.push(cells[i]);
                }
            }

            if (vertices.length > 0) {
                var dlg = new EditGeometryDialog(editorUi, vertices);
                editorUi.showDialog(dlg.container, 300, 285, true, true);
                dlg.init();
            }
        }, null, null, Editor.ctrlKey + '+Shift+M');

        var copiedStyles = ['rounded', 'shadow', 'dashed', 'dashPattern', 'fontFamily', 'fontSize', 'fontColor', 'fontStyle',
            'align', 'verticalAlign', 'strokeColor', 'strokeWidth', 'fillColor', 'gradientColor', 'swimlaneFillColor',
            'textOpacity', 'gradientDirection', 'glass', 'labelBackgroundColor', 'labelBorderColor', 'opacity',
            'spacing', 'spacingTop', 'spacingLeft', 'spacingBottom', 'spacingRight', 'endFill', 'endArrow',
            'endSize', 'targetPerimeterSpacing', 'startFill', 'startArrow', 'startSize', 'sourcePerimeterSpacing',
            'arcSize'];

        editorUi.actions.addAction('copyStyle', function () {
            var state = graph.view.getState(graph.getSelectionCell());

            if (graph.isEnabled() && state != null) {
                editorUi.copiedStyle = mxUtils.clone(state.style);

                // Handles special case for value "none"
                var cellStyle = graph.getModel().getStyle(state.cell);
                var tokens = (cellStyle != null) ? cellStyle.split(';') : [];

                for (var j = 0; j < tokens.length; j++) {
                    var tmp = tokens[j];
                    var pos = tmp.indexOf('=');

                    if (pos >= 0) {
                        var key = tmp.substring(0, pos);
                        var value = tmp.substring(pos + 1);

                        if (editorUi.copiedStyle[key] == null && value == 'none') {
                            editorUi.copiedStyle[key] = 'none';
                        }
                    }
                }
            }
        }, null, null, Editor.ctrlKey + '+Shift+C');

        editorUi.actions.addAction('pasteStyle', function () {
            if (graph.isEnabled() && !graph.isSelectionEmpty() && editorUi.copiedStyle != null) {
                graph.getModel().beginUpdate();

                try {
                    var cells = graph.getSelectionCells();

                    for (var i = 0; i < cells.length; i++) {
                        var state = graph.view.getState(cells[i]);

                        for (var j = 0; j < copiedStyles.length; j++) {
                            var key = copiedStyles[j];
                            var value = editorUi.copiedStyle[key];

                            if (state.style[key] != value) {
                                graph.setCellStyles(key, value, [cells[i]]);
                            }
                        }
                    }
                } finally {
                    graph.getModel().endUpdate();
                }
            }
        }, null, null, Editor.ctrlKey + '+Shift+V');

        editorUi.actions.put('pageBackgroundImage', new Action(mxResources.get('backgroundImage') + '...', function () {
            if (!editorUi.isOffline()) {
                var apply = function (image) {
                    editorUi.setBackgroundImage(image);
                };

                var dlg = new BackgroundImageDialog(editorUi, apply);
                editorUi.showDialog(dlg.container, 320, 170, true, true);
                dlg.init();
            }
        }));

        action = editorUi.actions.put('shadowVisible', new Action(mxResources.get('shadow'), function () {
            graph.setShadowVisible(!graph.shadowVisible);
        }));
        action.setToggleAction(true);
        action.setSelectedCallback(function () {
            return graph.shadowVisible;
        });

        action = editorUi.actions.addAction('find...', mxUtils.bind(this, function () {
            if (this.findWindow == null) {
                this.findWindow = new FindWindow(editorUi, document.body.offsetWidth - 300, 110, 240, 140);
                this.findWindow.window.addListener('show', function () {
                    editorUi.fireEvent(new mxEventObject('find'));
                });
                this.findWindow.window.addListener('hide', function () {
                    editorUi.fireEvent(new mxEventObject('find'));
                });
                this.findWindow.window.setVisible(true);
                editorUi.fireEvent(new mxEventObject('find'));
            } else {
                this.findWindow.window.setVisible(!this.findWindow.window.isVisible());
            }
        }));
        action.setToggleAction(true);
        action.setSelectedCallback(mxUtils.bind(this, function () {
            return this.findWindow != null && this.findWindow.window.isVisible();
        }));

        // Adds language menu to options only if localStorage is available for
        // storing the choice. We do not want to use cookies for older browsers.
        // Note that the URL param lang=XX is available for setting the language
        // in older browsers. URL param has precedence over the saved setting.

        editorUi.customLayoutConfig = [{
            'layout': 'mxHierarchicalLayout',
            'config':
                {
                    'orientation': 'west',
                    'intraCellSpacing': 30,
                    'interRankCellSpacing': 100,
                    'interHierarchySpacing': 60,
                    'parallelEdgeSpacing': 10
                }
        }];

        editorUi.actions.addAction('shapes...', function () {
            if (mxClient.IS_CHROMEAPP || !editorUi.isOffline()) {
                editorUi.showDialog(new MoreShapesDialog(editorUi, true).container, 700, (isLocalStorage) ?
                    ((mxClient.IS_IOS) ? 480 : 460) : 440, true, true);
            } else {
                editorUi.showDialog(new MoreShapesDialog(editorUi, false).container, 360, (isLocalStorage) ?
                    ((mxClient.IS_IOS) ? 300 : 280) : 260, true, true);
            }
        });

        editorUi.actions.put('createShape', new Action(mxResources.get('shape') + '...', function (evt) {
            if (graph.isEnabled()) {
                var cell = new mxCell('', new mxGeometry(0, 0, 120, 120), editorUi.defaultCustomShapeStyle);
                cell.vertex = true;

                var dlg = new EditShapeDialog(editorUi, cell, mxResources.get('editShape') + ':', 630, 400);
                editorUi.showDialog(dlg.container, 680, 520, true, false);
                dlg.init();
            }
        })).isEnabled = isGraphEnabled;

        // Adds plugins menu item only if localStorage is available for storing the plugins
        if (isLocalStorage || mxClient.IS_CHROMEAPP) {
            editorUi.actions.addAction('plugins...', function () {
                editorUi.showDialog(new PluginsDialog(editorUi).container, 400, 230, true, false);
            });
        }

        var action = editorUi.actions.addAction('search', function () {
            var visible = editorUi.sidebar.isEntryVisible('search');
            editorUi.sidebar.showPalette('search', !visible);

            if (isLocalStorage) {
                mxSettings.settings.search = !visible;
                mxSettings.save();
            }
        });

        action.setToggleAction(true);
        action.setSelectedCallback(function () {
            return editorUi.sidebar.isEntryVisible('search');
        });

        var addInsertItem = function (menu, parent, title, method) {
            if (method != 'plantUml' || (EditorUi.enablePlantUml && !editorUi.isOffline())) {
                menu.addItem(title, null, mxUtils.bind(this, function () {
                    if (method == 'fromText' || method == 'formatSql' || method == 'plantUml') {
                        var dlg = new ParseDialog(editorUi, title, method);
                        editorUi.showDialog(dlg.container, 650, 465, true, false);
                        editorUi.dialog.container.style.overflow = 'auto';
                        dlg.init();
                    } else {
                        var dlg = new CreateGraphDialog(editorUi, title, method);
                        editorUi.showDialog(dlg.container, 650, 465, true, false);
                        // Executed after dialog is added to dom
                        dlg.init();
                    }
                }), parent, null, isGraphEnabled());
            }
        };

        var insertVertex = function (value, w, h, style) {
            var pt = (graph.isMouseInsertPoint()) ? graph.getInsertPoint() : graph.getFreeInsertPoint();
            var cell = new mxCell(value, new mxGeometry(pt.x, pt.y, w, h), style);
            cell.vertex = true;

            graph.getModel().beginUpdate();
            try {
                cell = graph.addCell(cell);
                graph.fireEvent(new mxEventObject('cellsInserted', 'cells', [cell]));
            } finally {
                graph.getModel().endUpdate();
            }

            graph.scrollCellToVisible(cell);
            graph.setSelectionCell(cell);
            graph.container.focus();

            if (graph.editAfterInsert) {
                graph.startEditing(cell);
            }

            return cell;
        };

        editorUi.actions.put('insertText', new Action(mxResources.get('text'), function () {
            if (graph.isEnabled() && !graph.isCellLocked(graph.getDefaultParent())) {
                graph.startEditingAtCell(insertVertex('Text', 40, 20, 'text;html=1;resizable=0;autosize=1;' +
                    'align=center;verticalAlign=middle;points=[];fillColor=none;strokeColor=none;rounded=0;'));
            }
        }), null, null, Editor.ctrlKey + '+Shift+X').isEnabled = isGraphEnabled;

        editorUi.actions.put('insertRectangle', new Action(mxResources.get('rectangle'), function () {
            if (graph.isEnabled() && !graph.isCellLocked(graph.getDefaultParent())) {
                insertVertex('', 120, 60, 'whiteSpace=wrap;html=1;');
            }
        }), null, null, Editor.ctrlKey + '+K').isEnabled = isGraphEnabled;

        editorUi.actions.put('insertEllipse', new Action(mxResources.get('ellipse'), function () {
            if (graph.isEnabled() && !graph.isCellLocked(graph.getDefaultParent())) {
                insertVertex('', 80, 80, 'ellipse;whiteSpace=wrap;html=1;');
            }
        }), null, null, Editor.ctrlKey + '+Shift+K').isEnabled = isGraphEnabled;

        var addInsertMenuItems = mxUtils.bind(this, function (menu, parent, methods) {
            for (var i = 0; i < methods.length; i++) {
                if (methods[i] == '-') {
                    menu.addSeparator(parent);
                } else {
                    addInsertItem(menu, parent, mxResources.get(methods[i]) + '...', methods[i]);
                }
            }
        });

        var action = editorUi.actions.addAction('comments', mxUtils.bind(this, function () {
            if (this.commentsWindow == null) {
                // LATER: Check outline window for initial placement
                this.commentsWindow = new CommentsWindow(editorUi, document.body.offsetWidth - 380, 120, 300, 350);
                //TODO Are these events needed?
                this.commentsWindow.window.addListener('show', function () {
                    editorUi.fireEvent(new mxEventObject('comments'));
                });
                this.commentsWindow.window.addListener('hide', function () {
                    editorUi.fireEvent(new mxEventObject('comments'));
                });
                this.commentsWindow.window.setVisible(true);
                editorUi.fireEvent(new mxEventObject('comments'));
            } else {
                var isVisible = !this.commentsWindow.window.isVisible();
                this.commentsWindow.window.setVisible(isVisible);

                this.commentsWindow.refreshCommentsTime();

                if (isVisible && this.commentsWindow.hasError) {
                    this.commentsWindow.refreshComments();
                }
            }
        }));
        action.setToggleAction(true);
        action.setSelectedCallback(mxUtils.bind(this, function () {
            return this.commentsWindow != null && this.commentsWindow.window.isVisible();
        }));

        // Destroys comments window to force update or disable if not supported
        editorUi.editor.addListener('fileLoaded', mxUtils.bind(this, function () {
            if (this.commentsWindow != null) {
                this.commentsWindow.destroy();
                this.commentsWindow = null;
            }
        }));

        // Extends toolbar dropdown to add comments
        var viewPanelsMenu = this.get('viewPanels');
        var viewPanelsFunct = viewPanelsMenu.funct;

        viewPanelsMenu.funct = function (menu, parent) {
            viewPanelsFunct.apply(this, arguments);

            if (editorUi.commentsSupported()) {
                editorUi.menus.addMenuItems(menu, ['comments'], parent);
            }
        };
    };
})();

/**
 * Copyright (c) 2006-2016, JGraph Ltd
 * Copyright (c) 2006-2016, Gaudenz Alder
 */

/**
 * Constructs a new point for the optional x and y coordinates. If no
 * coordinates are given, then the default values for <x> and <y> are used.
 * @constructor
 * @class Implements a basic 2D point. Known subclassers = {@link mxRectangle}.
 * @param {number} x X-coordinate of the point.
 * @param {number} y Y-coordinate of the point.
 */
/**
 * Global types
 */
function DiagramPage(node, id) {
    this.node = node;

    if (id != null) {
        this.node.setAttribute('id', id);
    } else if (this.getId() == null) {
        this.node.setAttribute('id', Editor.guid());
    }
};

/**
 * Holds the diagram node for the page.
 */
DiagramPage.prototype.node = null;

/**
 * Holds the root cell for the page.
 */
DiagramPage.prototype.root = null;

/**
 * Holds the view state for the page.
 */
DiagramPage.prototype.viewState = null;

/**
 *
 */
DiagramPage.prototype.getId = function () {
    return this.node.getAttribute('id');
};

/**
 *
 */
DiagramPage.prototype.getName = function () {
    return this.node.getAttribute('name');
};

/**
 *
 */
DiagramPage.prototype.setName = function (value) {
    if (value == null) {
        this.node.removeAttribute('name');
    } else {
        this.node.setAttribute('name', value);
    }
};

/**
 * Change types
 */
function RenamePage(ui, page, name) {
    this.ui = ui;
    this.page = page;
    this.name = name;
    this.previous = name;
}

/**
 * Implementation of the undoable page rename.
 */
RenamePage.prototype.execute = function () {
    var tmp = this.page.getName();
    this.page.setName(this.previous);
    this.name = this.previous;
    this.previous = tmp;

    // Required to update page name in placeholders
    this.ui.editor.graph.updatePlaceholders();
    this.ui.editor.fireEvent(new mxEventObject('pageRenamed'));
};

/**
 * Undoable change of page title.
 */
function MovePage(ui, oldIndex, newIndex) {
    this.ui = ui;
    this.oldIndex = oldIndex;
    this.newIndex = newIndex;
}

/**
 * Implementation of the undoable page rename.
 */
MovePage.prototype.execute = function () {
    this.ui.pages.splice(this.newIndex, 0, this.ui.pages.splice(this.oldIndex, 1)[0]);
    var tmp = this.oldIndex;
    this.oldIndex = this.newIndex;
    this.newIndex = tmp;

    // Required to update page numbers in placeholders
    this.ui.editor.graph.updatePlaceholders();
    this.ui.editor.fireEvent(new mxEventObject('pageMoved'));
};

/**
 * Class: mxCurrentRootChange
 *
 * Action to change the current root in a view.
 *
 * Constructor: mxCurrentRootChange
 *
 * Constructs a change of the current root in the given view.
 */
function SelectPage(ui, page, viewState) {
    this.ui = ui;
    this.page = page;
    this.previousPage = page;
    this.neverShown = true;

    if (page != null) {
        this.neverShown = page.viewState == null;
        this.ui.updatePageRoot(page);

        if (viewState != null) {
            page.viewState = viewState;
            this.neverShown = false;
        }
    }
};

/**
 * Executes selection of a new page.
 */
SelectPage.prototype.execute = function () {
    var prevIndex = mxUtils.indexOf(this.ui.pages, this.previousPage);

    if (this.page != null && prevIndex >= 0) {
        var page = this.ui.currentPage;
        var editor = this.ui.editor;
        var graph = editor.graph;

        // Stores current diagram state in the page
        var data = Graph.compressNode(editor.getGraphXml(true));
        mxUtils.setTextContent(page.node, data);
        page.viewState = graph.getViewState();
        page.root = graph.model.root;

        if (page.model != null) {
            // Updates internal structures of offpage model
            page.model.rootChanged(page.root);
        }

        // Transitions for switching pages
//		var curIndex = mxUtils.indexOf(this.ui.pages, page);
//		mxUtils.setPrefixedStyle(graph.view.canvas.style, 'transition', null);
//		mxUtils.setPrefixedStyle(graph.view.canvas.style, 'transform',
//			(curIndex > prevIndex) ? 'translate(-50%,0)' : 'translate(50%,0)');

        // Removes the previous cells and clears selection
        graph.view.clear(page.root, true);
        graph.clearSelection();

        // Switches the current page
        this.ui.currentPage = this.previousPage;
        this.previousPage = page;
        page = this.ui.currentPage;

        // Switches the root cell and sets the view state
        graph.model.prefix = Editor.guid() + '-';
        graph.model.rootChanged(page.root);
        graph.setViewState(page.viewState);

        // Handles grid state in chromeless mode which is stored in Editor instance
        graph.gridEnabled = graph.gridEnabled && (!this.ui.editor.isChromelessView() ||
            urlParams['grid'] == '1');

        // Updates the display
        editor.updateGraphComponents();
        graph.view.validate();
        graph.blockMathRender = true;
        graph.sizeDidChange();
        graph.blockMathRender = false;

//		mxUtils.setPrefixedStyle(graph.view.canvas.style, 'transition', 'transform 0.2s');
//		mxUtils.setPrefixedStyle(graph.view.canvas.style, 'transform', 'translate(0,0)');

        if (this.neverShown) {
            this.neverShown = false;
            graph.selectUnlockedLayer();
        }

        // Fires events
        editor.graph.fireEvent(new mxEventObject(mxEvent.ROOT));
        editor.fireEvent(new mxEventObject('pageSelected', 'change', this));
    }
};

/**
 *
 */
function ChangePage(ui, page, select, index, noSelect) {
    SelectPage.call(this, ui, select);
    this.relatedPage = page;
    this.index = index;
    this.previousIndex = null;
    this.noSelect = noSelect;
};

mxUtils.extend(ChangePage, SelectPage);

/**
 * Function: execute
 *
 * Changes the current root of the view.
 */
ChangePage.prototype.execute = function () {
    // Fires event to setting view state from realtime
    this.ui.editor.fireEvent(new mxEventObject('beforePageChange', 'change', this));
    this.previousIndex = this.index;

    if (this.index == null) {
        var tmp = mxUtils.indexOf(this.ui.pages, this.relatedPage);
        this.ui.pages.splice(tmp, 1);
        this.index = tmp;
    } else {
        this.ui.pages.splice(this.index, 0, this.relatedPage);
        this.index = null;
    }

    if (!this.noSelect) {
        SelectPage.prototype.execute.apply(this, arguments);
    }
};

/**
 * Specifies the height of the tab container. Default is 38.
 */
EditorUi.prototype.tabContainerHeight = 38;

/**
 * Returns the index of the selected page.
 */
EditorUi.prototype.getSelectedPageIndex = function () {
    var result = null;

    if (this.pages != null && this.currentPage != null) {
        for (var i = 0; i < this.pages.length; i++) {
            if (this.pages[i] == this.currentPage) {
                result = i;

                break;
            }
        }
    }

    return result;
};

/**
 * Returns true if the given string contains an mxfile.
 */
EditorUi.prototype.getPageById = function (id) {
    if (this.pages != null) {
        for (var i = 0; i < this.pages.length; i++) {
            if (this.pages[i].getId() == id) {
                return this.pages[i];
            }
        }
    }

    return null;
};

/**
 * Returns true if the given string contains an mxfile.
 */
EditorUi.prototype.initPages = function () {
    if (!this.editor.graph.standalone) {
        this.actions.addAction('previousPage', mxUtils.bind(this, function () {
            this.selectNextPage(false);
        }));

        this.actions.addAction('nextPage', mxUtils.bind(this, function () {
            this.selectNextPage(true);
        }));

        this.keyHandler.bindAction(33, true, 'previousPage', true); // Ctrl+Shift+PageUp
        this.keyHandler.bindAction(34, true, 'nextPage', true); // Ctrl+Shift+PageDown

        // Updates the tabs after loading the diagram
        var graph = this.editor.graph;
        var graphViewValidateBackground = graph.view.validateBackground;

        graph.view.validateBackground = mxUtils.bind(this, function () {
            if (this.tabContainer != null) {
                var prevHeight = this.tabContainer.style.height;

                if (this.fileNode == null || this.pages == null ||
                    (this.pages.length == 1 && urlParams['pages'] == '0')) {
                    this.tabContainer.style.height = '0px';
                } else {
                    this.tabContainer.style.height = this.tabContainerHeight + 'px';
                }

                if (prevHeight != this.tabContainer.style.height) {
                    this.refresh(false);
                }
            }

            graphViewValidateBackground.apply(graph.view, arguments);
        });

        var lastPage = null;

        var updateTabs = mxUtils.bind(this, function () {
            this.updateTabContainer();

            // Updates scrollbar positions and backgrounds after validation
            var p = this.currentPage;

            if (p != null && p != lastPage) {
                if (p.viewState == null || p.viewState.scrollLeft == null) {
                    this.resetScrollbars();

                    if (graph.isLightboxView()) {
                        this.lightboxFit();
                    }

                    if (this.chromelessResize != null) {
                        graph.container.scrollLeft = 0;
                        graph.container.scrollTop = 0;
                        this.chromelessResize();
                    }
                } else {
                    graph.container.scrollLeft = graph.view.translate.x * graph.view.scale + p.viewState.scrollLeft;
                    graph.container.scrollTop = graph.view.translate.y * graph.view.scale + p.viewState.scrollTop;
                }

                lastPage = p;
            }

            // Updates layers window
            if (this.actions.layersWindow != null) {
                this.actions.layersWindow.refreshLayers();
            }
        });

        // Adds a graph model listener to update the view
        this.editor.graph.model.addListener(mxEvent.CHANGE, mxUtils.bind(this, function (sender, evt) {
            var edit = evt.getProperty('edit');
            var changes = edit.changes;

            for (var i = 0; i < changes.length; i++) {
                if (changes[i] instanceof SelectPage ||
                    changes[i] instanceof RenamePage ||
                    changes[i] instanceof MovePage ||
                    changes[i] instanceof mxRootChange) {
                    updateTabs();
                    break;
                }
            }
        }));

        // Updates zoom in toolbar
        if (this.toolbar != null) {
            this.editor.addListener('pageSelected', this.toolbar.updateZoom);
        }
    }
};

/**
 * Adds the listener for automatically saving the diagram for local changes.
 */
EditorUi.prototype.restoreViewState = function (page, viewState, selection) {
    var newPage = (page != null) ? this.getPageById(page.getId()) : null;
    var graph = this.editor.graph;

    if (newPage != null && this.currentPage != null && this.pages != null) {
        if (newPage != this.currentPage) {
            this.selectPage(newPage, true, viewState);
        } else {
            // TODO: Pass viewState to setGraphXml
            graph.setViewState(viewState);
            this.editor.updateGraphComponents();
            graph.view.revalidate();
            graph.sizeDidChange();
        }

        graph.container.scrollLeft = graph.view.translate.x * graph.view.scale + viewState.scrollLeft;
        graph.container.scrollTop = graph.view.translate.y * graph.view.scale + viewState.scrollTop;
        graph.restoreSelection(selection);
    }
};

/**
 * Overrides setDefaultParent
 */
Graph.prototype.createViewState = function (node) {
    var pv = node.getAttribute('page');
    var ps = parseFloat(node.getAttribute('pageScale'));
    var pw = parseFloat(node.getAttribute('pageWidth'));
    var ph = parseFloat(node.getAttribute('pageHeight'));
    var bg = node.getAttribute('background');
    var temp = node.getAttribute('backgroundImage');
    var bgImg = (temp != null && temp.length > 0) ? JSON.parse(temp) : null;

    return {
        gridEnabled: node.getAttribute('grid') != '0',
        //gridColor: node.getAttribute('gridColor') || mxSettings.getGridColor(),
        gridSize: parseFloat(node.getAttribute('gridSize')) || mxGraph.prototype.gridSize,
        guidesEnabled: node.getAttribute('guides') != '0',
        foldingEnabled: node.getAttribute('fold') != '0',
        shadowVisible: node.getAttribute('shadow') == '1',
        pageVisible: (this.isLightboxView()) ? false : ((pv != null) ? (pv != '0') : this.defaultPageVisible),
        background: (bg != null && bg.length > 0) ? bg : null,
        backgroundImage: (bgImg != null) ? new mxImage(bgImg.src, bgImg.width, bgImg.height) : null,
        pageScale: (!isNaN(ps)) ? ps : mxGraph.prototype.pageScale,
        pageFormat: (!isNaN(pw) && !isNaN(ph)) ? new mxRectangle(0, 0, pw, ph) : mxSettings.getPageFormat(),
        tooltips: node.getAttribute('tooltips') != '0',
        connect: node.getAttribute('connect') != '0',
        arrows: node.getAttribute('arrows') != '0',
        mathEnabled: node.getAttribute('math') == '1',
        selectionCells: null,
        defaultParent: null,
        scrollbars: this.defaultScrollbars,
        scale: 1
    };
};

/**
 * Writes the graph properties from the realtime model to the given mxGraphModel node.
 */
Graph.prototype.saveViewState = function (vs, node, ignoreTransient) {
    if (!ignoreTransient) {
        node.setAttribute('grid', (vs == null || vs.gridEnabled) ? '1' : '0');
        node.setAttribute('gridSize', (vs != null) ? vs.gridSize : mxGraph.prototype.gridSize);
        node.setAttribute('guides', (vs == null || vs.guidesEnabled) ? '1' : '0');
        node.setAttribute('tooltips', (vs == null || vs.tooltips) ? '1' : '0');
        node.setAttribute('connect', (vs == null || vs.connect) ? '1' : '0');
        node.setAttribute('arrows', (vs == null || vs.arrows) ? '1' : '0');
        node.setAttribute('page', ((vs == null && this.defaultPageVisible) ||
            (vs != null && vs.pageVisible)) ? '1' : '0');

        // Ignores fold to avoid checksum errors for lightbox mode
        node.setAttribute('fold', (vs == null || vs.foldingEnabled) ? '1' : '0');
    }

    node.setAttribute('pageScale', (vs != null && vs.pageScale != null) ? vs.pageScale : mxGraph.prototype.pageScale);

    var pf = (vs != null) ? vs.pageFormat : mxSettings.getPageFormat();

    if (pf != null) {
        node.setAttribute('pageWidth', pf.width);
        node.setAttribute('pageHeight', pf.height);
    }

    if (vs != null && vs.background != null) {
        node.setAttribute('background', vs.background);
    }

    if (vs != null && vs.backgroundImage != null) {
        node.setAttribute('backgroundImage', JSON.stringify(vs.backgroundImage));
    }

    node.setAttribute('math', (vs != null && vs.mathEnabled) ? '1' : '0');
    node.setAttribute('shadow', (vs != null && vs.shadowVisible) ? '1' : '0');
};

/**
 * Overrides setDefaultParent
 */
Graph.prototype.getViewState = function () {
    return {
        defaultParent: this.defaultParent,
        currentRoot: this.view.currentRoot,
        gridEnabled: this.gridEnabled,
        //gridColor: this.view.gridColor,
        gridSize: this.gridSize,
        guidesEnabled: this.graphHandler.guidesEnabled,
        foldingEnabled: this.foldingEnabled,
        shadowVisible: this.shadowVisible,
        scrollbars: this.scrollbars,
        pageVisible: this.pageVisible,
        background: this.background,
        backgroundImage: this.backgroundImage,
        pageScale: this.pageScale,
        pageFormat: this.pageFormat,
        tooltips: this.tooltipHandler.isEnabled(),
        connect: this.connectionHandler.isEnabled(),
        arrows: this.connectionArrowsEnabled,
        scale: this.view.scale,
        scrollLeft: this.container.scrollLeft - this.view.translate.x * this.view.scale,
        scrollTop: this.container.scrollTop - this.view.translate.y * this.view.scale,
        translate: this.view.translate.clone(),
        lastPasteXml: this.lastPasteXml,
        pasteCounter: this.pasteCounter,
        mathEnabled: this.mathEnabled
    };
};

/**
 * Overrides setDefaultParent
 */
Graph.prototype.setViewState = function (state) {
    if (state != null) {
        this.lastPasteXml = state.lastPasteXml;
        this.pasteCounter = state.pasteCounter || 0;
        this.mathEnabled = state.mathEnabled;
        this.gridEnabled = state.gridEnabled;
        //this.view.gridColor = state.gridColor;
        this.gridSize = state.gridSize;
        this.graphHandler.guidesEnabled = state.guidesEnabled;
        this.foldingEnabled = state.foldingEnabled;
        this.setShadowVisible(state.shadowVisible, false);
        this.scrollbars = state.scrollbars;
        this.pageVisible = !this.isViewer() && state.pageVisible;
        this.background = state.background;
        this.backgroundImage = state.backgroundImage;
        this.pageScale = state.pageScale;
        this.pageFormat = state.pageFormat;
        this.view.currentRoot = state.currentRoot;
        this.defaultParent = state.defaultParent;
        this.connectionArrowsEnabled = state.arrows;
        this.setTooltips(state.tooltips);
        this.setConnectable(state.connect);

        if (state.scale != null) {
            this.view.scale = state.scale;
        } else {
            this.view.scale = 1;
        }

        // Checks if current root or default parent have been removed
        if (this.view.currentRoot != null &&
            !this.model.contains(this.view.currentRoot)) {
            this.view.currentRoot = null;
        }

        if (this.defaultParent != null &&
            !this.model.contains(this.defaultParent)) {
            this.setDefaultParent(null);
            this.selectUnlockedLayer();
        }

        if (state.translate != null) {
            this.view.translate = state.translate;
        }
    } else {
        this.view.currentRoot = null;
        this.view.scale = 1;
        this.gridEnabled = true;
        this.gridSize = mxGraph.prototype.gridSize;
        this.pageScale = mxGraph.prototype.pageScale;
        this.pageFormat = mxSettings.getPageFormat();
        this.pageVisible = this.defaultPageVisible;
        this.background = null;
        this.backgroundImage = null;
        this.scrollbars = this.defaultScrollbars;
        this.graphHandler.guidesEnabled = true;
        this.foldingEnabled = true;
        this.setShadowVisible(false, false);
        this.defaultParent = null;
        this.setTooltips(true);
        this.setConnectable(true);
        this.lastPasteXml = null;
        this.pasteCounter = 0;
        this.mathEnabled = false;
        this.connectionArrowsEnabled = true;
    }

    // Implicit settings
    this.pageBreaksVisible = this.pageVisible;
    this.preferPageSize = this.pageVisible;
    this.fireEvent(new mxEventObject('viewStateChanged', 'state', state));
};

/**
 * Executes selection of a new page.
 */
EditorUi.prototype.updatePageRoot = function (page) {
    if (page.root == null) {
        var node = this.editor.extractGraphModel(page.node);
        var cause = Editor.extractParserError(node);

        if (cause) {
            throw new Error(cause);
        } else if (node != null) {
            page.graphModelNode = node;

            // Converts model XML into page object with root cell
            page.viewState = this.editor.graph.createViewState(node);
            var codec = new mxCodec(node.ownerDocument);
            page.root = codec.decode(node).root;
        } else {
            // Initializes page object with new empty root
            page.root = this.editor.graph.model.createRoot();
        }
    } else if (page.viewState == null) {
        if (page.graphModelNode == null) {
            var node = this.editor.extractGraphModel(page.node);

            var cause = Editor.extractParserError(node);

            if (cause) {
                throw new Error(cause);
            } else if (node != null) {
                page.graphModelNode = node;
            }
        }

        if (page.graphModelNode != null) {
            page.viewState = this.editor.graph.createViewState(page.graphModelNode);
        }
    }

    return page;
};

/**
 * Returns true if the given string contains an mxfile.
 */
EditorUi.prototype.selectPage = function (page, quiet, viewState) {
    try {
        if (page != this.currentPage) {
            if (this.editor.graph.isEditing()) {
                this.editor.graph.stopEditing(false);
            }

            quiet = (quiet != null) ? quiet : false;
            this.editor.graph.isMouseDown = false;
            this.editor.graph.reset();

            var edit = this.editor.graph.model.createUndoableEdit();

            // Special flag to bypass autosave for this edit
            edit.ignoreEdit = true;

            var change = new SelectPage(this, page, viewState);
            change.execute();
            edit.add(change);
            edit.notify();

            this.editor.graph.tooltipHandler.hide();

            if (!quiet) {
                this.editor.graph.model.fireEvent(new mxEventObject(mxEvent.UNDO, 'edit', edit));
            }
        }
    } catch (e) {
        this.handleError(e);
    }
};

/**
 *
 */
EditorUi.prototype.selectNextPage = function (forward) {
    var next = this.currentPage;

    if (next != null && this.pages != null) {
        var tmp = mxUtils.indexOf(this.pages, next);

        if (forward) {
            this.selectPage(this.pages[mxUtils.mod(tmp + 1, this.pages.length)]);
        } else if (!forward) {
            this.selectPage(this.pages[mxUtils.mod(tmp - 1, this.pages.length)]);
        }
    }
};

/**
 * Returns true if the given string contains an mxfile.
 */
EditorUi.prototype.insertPage = function (page, index) {
    if (this.editor.graph.isEnabled()) {
        if (this.editor.graph.isEditing()) {
            this.editor.graph.stopEditing(false);
        }

        page = (page != null) ? page : this.createPage(null, this.createPageId());
        index = (index != null) ? index : this.pages.length;

        // Uses model to fire event and trigger autosave
        var change = new ChangePage(this, page, page, index);
        this.editor.graph.model.execute(change);
    }

    return page;
};

/**
 * Returns a unique page ID.
 */
EditorUi.prototype.createPageId = function () {
    var id = null;

    do {
        id = Editor.guid();
    } while (this.getPageById(id) != null)

    return id;
};

/**
 * Returns a new DiagramPage instance.
 */
EditorUi.prototype.createPage = function (name, id) {
    var page = new DiagramPage(this.fileNode.ownerDocument.createElement('diagram'), id);
    page.setName((name != null) ? name : this.createPageName());

    return page;
};

/**
 * Returns a page name.
 */
EditorUi.prototype.createPageName = function () {
    // Creates a lookup with names
    var existing = {};

    for (var i = 0; i < this.pages.length; i++) {
        var tmp = this.pages[i].getName();

        if (tmp != null && tmp.length > 0) {
            existing[tmp] = tmp;
        }
    }

    // Avoids existing names
    var nr = this.pages.length;
    var name = null;

    do {
        name = mxResources.get('pageWithNumber', [++nr]);
    }
    while (existing[name] != null);

    return name;
};

/**
 * Removes the given page.
 */
EditorUi.prototype.removePage = function (page) {
    try {
        var graph = this.editor.graph;
        var tmp = mxUtils.indexOf(this.pages, page);

        if (graph.isEnabled() && tmp >= 0) {
            if (this.editor.graph.isEditing()) {
                this.editor.graph.stopEditing(false);
            }

            graph.model.beginUpdate();
            try {
                var next = this.currentPage;

                if (next == page && this.pages.length > 1) {
                    if (tmp == this.pages.length - 1) {
                        tmp--;
                    } else {
                        tmp++;
                    }

                    next = this.pages[tmp];
                } else if (this.pages.length <= 1) {
                    // Removes label with incorrect page number to force
                    // default page name which is OK for a single page
                    next = this.insertPage();
                    graph.model.execute(new RenamePage(this, next,
                        mxResources.get('pageWithNumber', [1])));
                }

                // Uses model to fire event to trigger autosave
                graph.model.execute(new ChangePage(this, page, next));
            } finally {
                graph.model.endUpdate();
            }
        }
    } catch (e) {
        this.handleError(e);
    }

    return page;
};

/**
 * Duplicates the given page.
 */
EditorUi.prototype.duplicatePage = function (page, name) {
    var newPage = null;

    try {
        var graph = this.editor.graph;

        if (graph.isEnabled()) {
            if (graph.isEditing()) {
                graph.stopEditing();
            }

            // Clones the current page and takes a snapshot of the graph model and view state
            var node = page.node.cloneNode(false);
            node.removeAttribute('id');

            var newPage = new DiagramPage(node);
            newPage.root = graph.cloneCell(graph.model.root);
            newPage.viewState = graph.getViewState();

            // Resets zoom and scrollbar positions
            newPage.viewState.scale = 1;
            newPage.viewState.scrollLeft = null;
            newPage.viewState.scrollTop = null;
            newPage.viewState.currentRoot = null;
            newPage.viewState.defaultParent = null;
            newPage.setName(name);

            newPage = this.insertPage(newPage, mxUtils.indexOf(this.pages, page) + 1);
        }
    } catch (e) {
        this.handleError(e);
    }

    return newPage;
};

/**
 * Renames the given page using a dialog.
 */
EditorUi.prototype.renamePage = function (page) {
    var graph = this.editor.graph;

    if (graph.isEnabled()) {
        var dlg = new FilenameDialog(this, page.getName(), mxResources.get('rename'), mxUtils.bind(this, function (name) {
            if (name != null && name.length > 0) {
                this.editor.graph.model.execute(new RenamePage(this, page, name));
            }
        }), mxResources.get('rename'));
        this.showDialog(dlg.container, 300, 130, true, true);
        dlg.init();
    }

    return page;
}

/**
 * Returns true if the given string contains an mxfile.
 */
EditorUi.prototype.movePage = function (oldIndex, newIndex) {
    this.editor.graph.model.execute(new MovePage(this, oldIndex, newIndex));
}

/**
 * Returns true if the given string contains an mxfile.
 */
EditorUi.prototype.createTabContainer = function () {
    var div = document.createElement('div');
    div.className = 'geTabContainer';
    div.style.position = 'absolute';
    div.style.whiteSpace = 'nowrap';
    div.style.overflow = 'hidden';
    div.style.height = '0px';

    return div;
};

/**
 * Returns true if the given string contains an mxfile.
 */
EditorUi.prototype.updateTabContainer = function () {
    if (this.tabContainer != null && this.pages != null) {
        var graph = this.editor.graph;
        var wrapper = document.createElement('div');
        wrapper.style.position = 'relative';
        wrapper.style.display = (mxClient.IS_QUIRKS) ? 'inline' : 'inline-block';
        wrapper.style.verticalAlign = 'top';
        wrapper.style.height = this.tabContainer.style.height;
        wrapper.style.whiteSpace = 'nowrap';
        wrapper.style.overflow = 'hidden';
        wrapper.style.fontSize = '13px';

        // Allows for negative left margin of first tab
        wrapper.style.marginLeft = '30px';

        // Automatic tab width to match available width
        // TODO: Fix tabWidth in chromeless mode
        var btnWidth = (this.editor.isChromelessView()) ? 29 : 59;
        var tabWidth = Math.min(140, Math.max(20, (this.tabContainer.clientWidth - btnWidth) / this.pages.length) + 1);
        var startIndex = null;

        for (var i = 0; i < this.pages.length; i++) {
            // Install drag and drop for page reorder
            (mxUtils.bind(this, function (index, tab) {
                if (this.pages[index] == this.currentPage) {
                    tab.className = 'geActivePage';
                    tab.style.backgroundColor = (uiTheme == 'dark') ? '#2a2a2a' : '#fff';
                } else {
                    tab.className = 'geInactivePage';
                }

                tab.setAttribute('draggable', 'true');

                mxEvent.addListener(tab, 'dragstart', mxUtils.bind(this, function (evt) {
                    if (graph.isEnabled()) {
                        // Workaround for no DnD on DIV in FF
                        if (mxClient.IS_FF) {
                            // LATER: Check what triggers a parse as XML on this in FF after drop
                            evt.dataTransfer.setData('Text', '<diagram/>');
                        }

                        startIndex = index;
                    } else {
                        // Blocks event
                        mxEvent.consume(evt);
                    }
                }));

                mxEvent.addListener(tab, 'dragend', mxUtils.bind(this, function (evt) {
                    startIndex = null;
                    evt.stopPropagation();
                    evt.preventDefault();
                }));

                mxEvent.addListener(tab, 'dragover', mxUtils.bind(this, function (evt) {
                    if (startIndex != null) {
                        evt.dataTransfer.dropEffect = 'move';
                    }

                    evt.stopPropagation();
                    evt.preventDefault();
                }));

                mxEvent.addListener(tab, 'drop', mxUtils.bind(this, function (evt) {
                    if (startIndex != null && index != startIndex) {
                        // TODO: Shift drag for insert/merge?
                        this.movePage(startIndex, index);
                    }

                    evt.stopPropagation();
                    evt.preventDefault();
                }));

                wrapper.appendChild(tab);
            }))(i, this.createTabForPage(this.pages[i], tabWidth, this.pages[i] != this.currentPage, i + 1));
        }

        this.tabContainer.innerHTML = '';
        this.tabContainer.appendChild(wrapper);

        // Adds floating menu with all pages and insert option
        var menutab = this.createPageMenuTab();
        this.tabContainer.appendChild(menutab);
        var insertTab = null;

        // Not chromeless and not read-only file
        if (this.isPageInsertTabVisible()) {
            insertTab = this.createPageInsertTab();
            this.tabContainer.appendChild(insertTab);
        }

        if (wrapper.clientWidth > this.tabContainer.clientWidth - btnWidth) {
            if (insertTab != null) {
                insertTab.style.position = 'absolute';
                insertTab.style.right = '0px';
                wrapper.style.marginRight = '30px';
            }

            var temp = this.createControlTab(4, '&nbsp;&#10094;&nbsp;');
            temp.style.position = 'absolute';
            temp.style.right = (this.editor.chromeless) ? '29px' : '55px';
            temp.style.fontSize = '13pt';

            this.tabContainer.appendChild(temp);

            var temp2 = this.createControlTab(4, '&nbsp;&#10095;');
            temp2.style.position = 'absolute';
            temp2.style.right = (this.editor.chromeless) ? '0px' : '29px';
            temp2.style.fontSize = '13pt';

            this.tabContainer.appendChild(temp2);

            // TODO: Scroll to current page
            var dx = Math.max(0, this.tabContainer.clientWidth - ((this.editor.chromeless) ? 86 : 116));
            wrapper.style.width = dx + 'px';

            var fade = 50;

            mxEvent.addListener(temp, 'click', mxUtils.bind(this, function (evt) {
                wrapper.scrollLeft -= Math.max(20, dx - 20);
                mxUtils.setOpacity(temp, (wrapper.scrollLeft > 0) ? 100 : fade);
                mxUtils.setOpacity(temp2, (wrapper.scrollLeft < wrapper.scrollWidth - wrapper.clientWidth) ? 100 : fade);
                mxEvent.consume(evt);
            }));

            mxUtils.setOpacity(temp, (wrapper.scrollLeft > 0) ? 100 : fade);
            mxUtils.setOpacity(temp2, (wrapper.scrollLeft < wrapper.scrollWidth - wrapper.clientWidth) ? 100 : fade);

            mxEvent.addListener(temp2, 'click', mxUtils.bind(this, function (evt) {
                wrapper.scrollLeft += Math.max(20, dx - 20);
                mxUtils.setOpacity(temp, (wrapper.scrollLeft > 0) ? 100 : fade);
                mxUtils.setOpacity(temp2, (wrapper.scrollLeft < wrapper.scrollWidth - wrapper.clientWidth) ? 100 : fade);
                mxEvent.consume(evt);
            }));
        }
    }
};

/**
 * Returns true if the given string contains an mxfile.
 */
EditorUi.prototype.isPageInsertTabVisible = function () {
    return urlParams['embed'] == 1 || (this.getCurrentFile() != null &&
        this.getCurrentFile().isEditable());
};

/**
 * Returns true if the given string contains an mxfile.
 */
EditorUi.prototype.createTab = function (hoverEnabled) {
    var tab = document.createElement('div');
    tab.style.display = (mxClient.IS_QUIRKS) ? 'inline' : 'inline-block';
    tab.style.whiteSpace = 'nowrap';
    tab.style.boxSizing = 'border-box';
    tab.style.position = 'relative';
    tab.style.overflow = 'hidden';
    tab.style.textAlign = 'center';
    tab.style.marginLeft = '-1px';
    tab.style.height = this.tabContainer.clientHeight + 'px';
    tab.style.padding = '12px 4px 8px 4px';
    tab.style.border = (uiTheme == 'dark') ? '1px solid #505759' : '1px solid #e8eaed';
    tab.style.borderTopStyle = 'none';
    tab.style.borderBottomStyle = 'none';
    tab.style.backgroundColor = this.tabContainer.style.backgroundColor;
    tab.style.cursor = 'move';
    tab.style.color = 'gray';

    if (hoverEnabled) {
        mxEvent.addListener(tab, 'mouseenter', mxUtils.bind(this, function (evt) {
            if (!this.editor.graph.isMouseDown) {
                tab.style.backgroundColor = (uiTheme == 'dark') ? 'black' : '#e8eaed';
                mxEvent.consume(evt);
            }
        }));

        mxEvent.addListener(tab, 'mouseleave', mxUtils.bind(this, function (evt) {
            tab.style.backgroundColor = this.tabContainer.style.backgroundColor;
            mxEvent.consume(evt);
        }));
    }

    return tab;
};

/**
 * Returns true if the given string contains an mxfile.
 */
EditorUi.prototype.createControlTab = function (paddingTop, html) {
    var tab = this.createTab(true);
    tab.style.lineHeight = this.tabContainerHeight + 'px';
    tab.style.paddingTop = paddingTop + 'px';
    tab.style.cursor = 'pointer';
    tab.style.width = '30px';
    tab.innerHTML = html;

    if (tab.firstChild != null && tab.firstChild.style != null) {
        mxUtils.setOpacity(tab.firstChild, 40);
    }

    return tab;
};

/**
 * Returns true if the given string contains an mxfile.
 */
EditorUi.prototype.createPageMenuTab = function () {
    var tab = this.createControlTab(3, '<div class="geSprite geSprite-dots" style="display:inline-block;margin-top:5px;width:21px;height:21px;"></div>');
    tab.setAttribute('title', mxResources.get('pages'));
    tab.style.position = 'absolute';
    tab.style.marginLeft = '0px';
    tab.style.top = '0px';
    tab.style.left = '1px';

    mxEvent.addListener(tab, 'click', mxUtils.bind(this, function (evt) {
        this.editor.graph.popupMenuHandler.hideMenu();
        var menu = new mxPopupMenu(mxUtils.bind(this, function (menu, parent) {
            for (var i = 0; i < this.pages.length; i++) {
                (mxUtils.bind(this, function (index) {
                    var item = menu.addItem(this.pages[index].getName(), null, mxUtils.bind(this, function () {
                        this.selectPage(this.pages[index]);
                    }), parent);

                    // Adds checkmark to current page
                    if (this.pages[index] == this.currentPage) {
                        menu.addCheckmark(item, Editor.checkmarkImage);
                    }
                }))(i);
            }

            if (this.editor.graph.isEnabled()) {
                menu.addSeparator(parent);

                var item = menu.addItem(mxResources.get('insertPage'), null, mxUtils.bind(this, function () {
                    this.insertPage();
                }), parent);

                var page = this.currentPage;

                if (page != null) {
                    menu.addSeparator(parent);

                    menu.addItem(mxResources.get('delete'), null, mxUtils.bind(this, function () {
                        this.removePage(page);
                    }), parent);

                    menu.addItem(mxResources.get('rename'), null, mxUtils.bind(this, function () {
                        this.renamePage(page, page.getName());
                    }), parent);

                    menu.addSeparator(parent);

                    menu.addItem(mxResources.get('duplicate'), null, mxUtils.bind(this, function () {
                        this.duplicatePage(page, mxResources.get('copyOf', [page.getName()]));
                    }), parent);
                }
            }
        }));

        menu.div.className += ' geMenubarMenu';
        menu.smartSeparators = true;
        menu.showDisabled = true;
        menu.autoExpand = true;

        // Disables autoexpand and destroys menu when hidden
        menu.hideMenu = mxUtils.bind(this, function () {
            mxPopupMenu.prototype.hideMenu.apply(menu, arguments);
            menu.destroy();
        });

        var x = mxEvent.getClientX(evt);
        var y = mxEvent.getClientY(evt);
        menu.popup(x, y, null, evt);

        // Allows hiding by clicking on document
        this.setCurrentMenu(menu);

        mxEvent.consume(evt);
    }));

    return tab;
};

/**
 * Returns true if the given string contains an mxfile.
 */
EditorUi.prototype.createPageInsertTab = function () {
    var tab = this.createControlTab(4, '<div class="geSprite geSprite-plus" style="display:inline-block;width:21px;height:21px;"></div>');
    tab.setAttribute('title', mxResources.get('insertPage'));
    var graph = this.editor.graph;

    mxEvent.addListener(tab, 'click', mxUtils.bind(this, function (evt) {
        this.insertPage();
        mxEvent.consume(evt);
    }));

    return tab;
};

/**
 * Returns true if the given string contains an mxfile.
 */
EditorUi.prototype.createTabForPage = function (page, tabWidth, hoverEnabled, pageNumber) {
    var tab = this.createTab(hoverEnabled);
    var name = page.getName() || mxResources.get('untitled');
    var id = page.getId();
    tab.setAttribute('title', name + ((id != null) ? ' (' + id + ')' : '') + ' [' + pageNumber + ']');
    mxUtils.write(tab, name);
    tab.style.maxWidth = tabWidth + 'px';
    tab.style.width = tabWidth + 'px';
    this.addTabListeners(page, tab);

    if (tabWidth > 42) {
        tab.style.textOverflow = 'ellipsis';
    }

    return tab;
};

/**
 * Translates this point by the given vector.
 *
 * @param {number} dx X-coordinate of the translation.
 * @param {number} dy Y-coordinate of the translation.
 */
EditorUi.prototype.addTabListeners = function (page, tab) {
    mxEvent.disableContextMenu(tab);
    var graph = this.editor.graph;
    var model = graph.model;

    mxEvent.addListener(tab, 'dblclick', mxUtils.bind(this, function (evt) {
        this.renamePage(page)
        mxEvent.consume(evt);
    }));

    var menuWasVisible = false;
    var pageWasActive = false;

    mxEvent.addGestureListeners(tab, mxUtils.bind(this, function (evt) {
        // Do not consume event here to allow for drag and drop of tabs
        menuWasVisible = this.currentMenu != null;
        pageWasActive = page == this.currentPage;

        if (!graph.isMouseDown && !pageWasActive) {
            this.selectPage(page);
        }
    }), null, mxUtils.bind(this, function (evt) {
        if (graph.isEnabled() && !graph.isMouseDown &&
            ((mxEvent.isTouchEvent(evt) && pageWasActive) ||
                mxEvent.isPopupTrigger(evt))) {
            graph.popupMenuHandler.hideMenu();
            this.hideCurrentMenu();

            if (!mxEvent.isTouchEvent(evt) || !menuWasVisible) {
                var menu = new mxPopupMenu(this.createPageMenu(page));

                menu.div.className += ' geMenubarMenu';
                menu.smartSeparators = true;
                menu.showDisabled = true;
                menu.autoExpand = true;

                // Disables autoexpand and destroys menu when hidden
                menu.hideMenu = mxUtils.bind(this, function () {
                    mxPopupMenu.prototype.hideMenu.apply(menu, arguments);
                    this.resetCurrentMenu();
                    menu.destroy();
                });

                var x = mxEvent.getClientX(evt);
                var y = mxEvent.getClientY(evt);
                menu.popup(x, y, null, evt);
                this.setCurrentMenu(menu, tab);
            }

            mxEvent.consume(evt);
        }
    }));
};

/**
 * Returns true if the given string contains an mxfile.
 */
EditorUi.prototype.createPageMenu = function (page, label) {
    return mxUtils.bind(this, function (menu, parent) {
        var graph = this.editor.graph;
        var model = graph.model;

        menu.addItem(mxResources.get('insert'), null, mxUtils.bind(this, function () {
            this.insertPage(null, mxUtils.indexOf(this.pages, page) + 1);
        }), parent);

        menu.addItem(mxResources.get('delete'), null, mxUtils.bind(this, function () {
            this.removePage(page);
        }), parent);

        menu.addItem(mxResources.get('rename'), null, mxUtils.bind(this, function () {
            this.renamePage(page, label);
        }), parent);

        menu.addSeparator(parent);

        menu.addItem(mxResources.get('duplicate'), null, mxUtils.bind(this, function () {
            this.duplicatePage(page, mxResources.get('copyOf', [page.getName()]));
        }), parent);
    });
};

// Overrides refresh to repaint tab container
(function () {
    var editorUiRefresh = EditorUi.prototype.refresh;

    EditorUi.prototype.refresh = function (sizeDidChange) {
        editorUiRefresh.apply(this, arguments);
        this.updateTabContainer();
    }
})();

//Overrides ChangePageSetup codec to exclude page
(function () {
    var codec = mxCodecRegistry.getCodec(ChangePageSetup);
    codec.exclude.push('page');
})();

//Registers codec for MovePage
(function () {
    var codec = new mxObjectCodec(new MovePage(), ['ui']);

    codec.beforeDecode = function (dec, node, obj) {
        obj.ui = dec.ui;

        return node;
    };

    codec.afterDecode = function (dec, node, obj) {
        var tmp = obj.oldIndex;
        obj.oldIndex = obj.newIndex;
        obj.newIndex = tmp;

        return obj;
    };

    mxCodecRegistry.register(codec);
})();

//Registers codec for RenamePage
(function () {
    var codec = new mxObjectCodec(new RenamePage(), ['ui', 'page']);

    codec.beforeDecode = function (dec, node, obj) {
        obj.ui = dec.ui;

        return node;
    };

    codec.afterDecode = function (dec, node, obj) {
        var tmp = obj.previous;
        obj.previous = obj.name;
        obj.name = tmp;

        return obj;
    };

    mxCodecRegistry.register(codec);
})();

//Registers codec for ChangePage
(function () {
    var codec = new mxObjectCodec(new ChangePage(), ['ui', 'relatedPage',
        'index', 'neverShown', 'page', 'previousPage']);

    var viewStateIgnored = ['defaultParent', 'currentRoot', 'scrollLeft',
        'scrollTop', 'scale', 'translate', 'lastPasteXml', 'pasteCounter'];

    codec.afterEncode = function (enc, obj, node) {
        node.setAttribute('relatedPage', obj.relatedPage.getId())

        if (obj.index == null) {
            node.setAttribute('name', obj.relatedPage.getName());

            if (obj.relatedPage.viewState != null) {
                node.setAttribute('viewState', JSON.stringify(
                    obj.relatedPage.viewState, function (key, value) {
                        return (mxUtils.indexOf(viewStateIgnored, key) < 0) ? value : undefined;
                    }));
            }

            if (obj.relatedPage.root != null) {
                enc.encodeCell(obj.relatedPage.root, node);
            }
        }

        return node;
    };

    codec.beforeDecode = function (dec, node, obj) {
        obj.ui = dec.ui;
        obj.relatedPage = obj.ui.getPageById(node.getAttribute('relatedPage'));

        if (obj.relatedPage == null) {
            var temp = node.ownerDocument.createElement('diagram');
            temp.setAttribute('id', node.getAttribute('relatedPage'));
            temp.setAttribute('name', node.getAttribute('name'));
            obj.relatedPage = new DiagramPage(temp);

            var vs = node.getAttribute('viewState');

            if (vs != null) {
                obj.relatedPage.viewState = JSON.parse(vs);
                node.removeAttribute('viewState');
            }

            // Makes sure the original node isn't modified
            node = node.cloneNode(true);
            var tmp = node.firstChild;

            if (tmp != null) {
                obj.relatedPage.root = dec.decodeCell(tmp, false);

                var tmp2 = tmp.nextSibling;
                tmp.parentNode.removeChild(tmp);
                tmp = tmp2;

                while (tmp != null) {
                    tmp2 = tmp.nextSibling;

                    if (tmp.nodeType == mxConstants.NODETYPE_ELEMENT) {
                        // Ignores all existing cells because those do not need to
                        // be re-inserted into the model. Since the encoded version
                        // of these cells contains the new parent, this would leave
                        // to an inconsistent state on the model (ie. a parent
                        // change without a call to parentForCellChanged).
                        var id = tmp.getAttribute('id');

                        if (dec.lookup(id) == null) {
                            dec.decodeCell(tmp);
                        }
                    }

                    tmp.parentNode.removeChild(tmp);
                    tmp = tmp2;
                }
            }
        }

        return node;
    };

    codec.afterDecode = function (dec, node, obj) {
        obj.index = obj.previousIndex;

        return obj;
    };

    mxCodecRegistry.register(codec);
})();
/**
 * Copyright (c) 2006-2017, JGraph Ltd
 * Copyright (c) 2006-2017, Gaudenz Alder
 */
(function () {
    /**
     * Defines resources.
     */
    var moveImage = (!mxClient.IS_SVG) ? IMAGE_PATH + '/move.png' :
        'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABIAAAASCAMAAABhEH5lAAAASFBMVEUAAAAAAAB/f3/9/f319fUfHx/7+/s+Pj69vb0AAAAAAAAAAAAAAAAAAAAAAAAAAAB2dnZ1dXUAAAAAAAAVFRX///8ZGRkGBgbOcI1hAAAAE3RSTlMA+vr9/f38+fb1893Bo00u+/tFvPJUBQAAAIRJREFUGNM0jEcSxCAQAxlydGqD///TNWxZBx1aXVIrWysplbapL3sFxgDq/idXBnHgBPK1nIxwc55vCXl6dRFtrV6svs/A/UjsPcpzA5tqyByD92HqQlMFh45BG6ND1DiKSoPDdm96N77bg5F+wyaEqRGb8ZiOwHQqdg9hehszcLAEIQB2lQ4p/sEpnAAAAABJRU5ErkJggg==';
    EditorUi.prototype.altShiftActions[68] = 'selectDescendants'; // Alt+Shift+D

    /**
     * Overrides folding based on treeFolding style.
     */
    var graphFoldCells = Graph.prototype.foldCells;

    Graph.prototype.foldCells = function (collapse, recurse, cells, checkFoldable, evt) {
        recurse = (recurse != null) ? recurse : false;

        if (cells == null) {
            cells = this.getFoldableCells(this.getSelectionCells(), collapse);
        }

        this.stopEditing();

        this.model.beginUpdate();
        try {
            var newCells = cells.slice();
            var tmp = [];

            for (var i = 0; i < cells.length; i++) {
                var state = this.view.getState(cells[i]);
                var style = (state != null) ? state.style : this.getCellStyle(cells[i]);

                if (mxUtils.getValue(style, 'treeFolding', '0') == '1') {
                    this.traverse(cells[i], true, mxUtils.bind(this, function (vertex, edge) {
                        if (edge != null) {
                            tmp.push(edge);
                        }

                        if (vertex != cells[i]) {
                            tmp.push(vertex);
                        }

                        // Stop traversal on collapsed vertices
                        return vertex == cells[i] || !this.model.isCollapsed(vertex);
                    }));

                    this.model.setCollapsed(cells[i], collapse);
                }
            }

            for (var i = 0; i < tmp.length; i++) {
                this.model.setVisible(tmp[i], !collapse);
            }

            cells = newCells;
            cells = graphFoldCells.apply(this, arguments);
        } finally {
            this.model.endUpdate();
        }

        return cells;
    };

    /**
     * Overrides functionality in editor.
     */
    var editorUiInit = EditorUi.prototype.init;

    EditorUi.prototype.init = function () {
        editorUiInit.apply(this, arguments);

        if (!this.editor.isChromelessView() || this.editor.editable) {
            this.addTrees();
        }
    };

    EditorUi.prototype.addTrees = function () {
        var ui = this;
        var graph = ui.editor.graph;
        var model = graph.getModel();
        var spacing = 10;
        var level = 40;

        function isTreeVertex(cell) {
            return model.isVertex(cell) && hasTreeParent(cell);
        };

        function isTreeMoving(cell) {
            var result = false;

            if (cell != null) {
                var state = graph.view.getState(cell);
                var style = (state != null) ? state.style : graph.getCellStyle(cell);

                result = style['treeMoving'] == '1';
            }

            return result;
        };

        function hasTreeParent(cell) {
            var result = false;

            if (cell != null) {
                var parent = model.getParent(cell);
                var pstate = graph.view.getState(parent);
                var style = (pstate != null) ? pstate.style : graph.getCellStyle(parent);

                result = style['containerType'] == 'tree';
            }

            return result;
        };

        function hasLayoutParent(cell) {
            var result = false;

            if (cell != null) {
                var parent = model.getParent(cell);
                var pstate = graph.view.getState(parent);

                var state = graph.view.getState(parent);
                var style = (pstate != null) ? pstate.style : graph.getCellStyle(parent);

                result = style['childLayout'] != null;
            }

            return result;
        };

        var uiCreatePopupMenu = ui.menus.createPopupMenu;
        ui.menus.createPopupMenu = function (menu, cell, evt) {
            uiCreatePopupMenu.apply(this, arguments);

            if (graph.getSelectionCount() == 1) {
                var cell = graph.getSelectionCell();
                var sib = graph.getOutgoingEdges(cell);
                menu.addSeparator();

                if (sib != null && sib.length > 0) {
                    if (isTreeVertex(graph.getSelectionCell())) {
                        this.addMenuItems(menu, ['selectChildren'], null, evt);
                    }

                    this.addMenuItems(menu, ['selectDescendants'], null, evt);
                }

                if (isTreeVertex(graph.getSelectionCell())) {
                    menu.addSeparator();

                    if (graph.getIncomingEdges(cell).length > 0) {
                        this.addMenuItems(menu, ['selectSiblings', 'selectParent'], null, evt);
                    }
                }
            }
        };

        // Adds actions
        ui.actions.addAction('selectChildren', function () {
            if (graph.isEnabled() && graph.getSelectionCount() == 1) {
                var cell = graph.getSelectionCell();
                var sib = graph.getOutgoingEdges(cell);

                if (sib != null) {
                    var tmp = [];

                    for (var i = 0; i < sib.length; i++) {
                        tmp.push(graph.model.getTerminal(sib[i], false));
                    }

                    graph.setSelectionCells(tmp);
                }
            }
        }, null, null, 'Alt+Shift+X');

        // Adds actions
        ui.actions.addAction('selectSiblings', function () {
            if (graph.isEnabled() && graph.getSelectionCount() == 1) {
                var cell = graph.getSelectionCell();
                var edges = graph.getIncomingEdges(cell);

                if (edges != null && edges.length > 0) {
                    var sib = graph.getOutgoingEdges(graph.model.getTerminal(edges[0], true));

                    if (sib != null) {
                        var tmp = [];

                        for (var i = 0; i < sib.length; i++) {
                            tmp.push(graph.model.getTerminal(sib[i], false));
                        }

                        graph.setSelectionCells(tmp);
                    }
                }
            }
        }, null, null, 'Alt+Shift+S');

        // Adds actions
        ui.actions.addAction('selectParent', function () {
            if (graph.isEnabled() && graph.getSelectionCount() == 1) {
                var cell = graph.getSelectionCell();
                var edges = graph.getIncomingEdges(cell);

                if (edges != null && edges.length > 0) {
                    graph.setSelectionCell(graph.model.getTerminal(edges[0], true));
                }
            }
        }, null, null, 'Alt+Shift+P');

        ui.actions.addAction('selectDescendants', function () {
            if (graph.isEnabled() && graph.getSelectionCount() == 1) {
                var cell = graph.getSelectionCell();
                // Makes space for new parent
                var subtree = [];

                graph.traverse(cell, true, function (vertex, edge) {
                    if (edge != null) {
                        subtree.push(edge);
                    }

                    subtree.push(vertex);

                    return true;
                });

                graph.setSelectionCells(subtree);
            }
        }, null, null, 'Alt+Shift+D');

        /**
         * Overriddes
         */
        var graphRemoveCells = graph.removeCells;

        graph.removeCells = function (cells, includeEdges) {
            includeEdges = (includeEdges != null) ? includeEdges : true;

            if (cells == null) {
                cells = this.getDeletableCells(this.getSelectionCells());
            }

            // Adds all edges to the cells
            if (includeEdges) {
                // FIXME: Remove duplicate cells in result or do not add if
                // in cells or descendant of cells
                cells = this.getDeletableCells(this.addAllEdges(cells));
            }

            var tmp = [];

            for (var i = 0; i < cells.length; i++) {
                var target = cells[i];

                if (model.isEdge(target) && hasTreeParent(target)) {
                    tmp.push(target);
                    target = model.getTerminal(target, false);
                }

                if (isTreeVertex(target)) {
                    graph.traverse(target, true, function (vertex, edge) {
                        if (edge != null) {
                            tmp.push(edge);
                        }

                        tmp.push(vertex);

                        return true;
                    });

                    var edges = graph.getIncomingEdges(cells[i]);
                    cells = cells.concat(edges);
                } else {
                    tmp.push(cells[i]);
                }
            }

            cells = tmp;

            return graphRemoveCells.apply(this, arguments);
        };

        ui.hoverIcons.getStateAt = function (state, x, y) {
            return (isTreeVertex(state.cell)) ? null : this.graph.view.getState(this.graph.getCellAt(x, y));
        };

        var graphDuplicateCells = graph.duplicateCells;

        graph.duplicateCells = function (cells, append) {
            cells = (cells != null) ? cells : this.getSelectionCells();
            var temp = cells.slice(0);

            for (var i = 0; i < temp.length; i++) {
                var cell = temp[i];
                var state = graph.view.getState(cell);

                if (state != null && isTreeVertex(state.cell)) {
                    // Avoids disconnecting subtree by removing all incoming edges
                    var edges = graph.getIncomingEdges(state.cell);

                    for (var j = 0; j < edges.length; j++) {
                        mxUtils.remove(edges[j], cells);
                    }
                }
            }

            this.model.beginUpdate();
            try {
                var result = graphDuplicateCells.call(this, cells, append);

                if (result.length == cells.length) {
                    for (var i = 0; i < cells.length; i++) {
                        if (isTreeVertex(cells[i])) {
                            var newEdges = graph.getIncomingEdges(result[i]);
                            var edges = graph.getIncomingEdges(cells[i]);

                            if (newEdges.length == 0 && edges.length > 0) {
                                var clone = this.cloneCell(edges[0]);
                                this.addEdge(clone, graph.getDefaultParent(),
                                    this.model.getTerminal(edges[0], true), result[i]);
                            }
                        }
                    }
                }
            } finally {
                this.model.endUpdate();
            }

            return result;
        };

        var graphMoveCells = graph.moveCells;

        graph.moveCells = function (cells, dx, dy, clone, target, evt, mapping) {
            var result = null;

            this.model.beginUpdate();
            try {
                var newSource = target;
                var state = this.view.getState(target);
                var style = (state != null) ? state.style : this.getCellStyle(target);

                if (cells != null && isTreeVertex(target) && mxUtils.getValue(style, 'treeFolding', '0') == '1') {
                    // Handles only drag from tree or from sidebar with dangling edges
                    for (var i = 0; i < cells.length; i++) {
                        if (isTreeVertex(cells[i]) || (graph.model.isEdge(cells[i]) &&
                            graph.model.getTerminal(cells[i], true) == null)) {
                            target = graph.model.getParent(cells[i]);
                            break;
                        }
                    }

                    // Applies distance between previous and current parent for non-sidebar drags
                    if (newSource != null && target != newSource && this.view.getState(cells[0]) != null) {
                        var edges = graph.getIncomingEdges(cells[0]);

                        if (edges.length > 0) {
                            var state1 = graph.view.getState(graph.model.getTerminal(edges[0], true));

                            if (state1 != null) {
                                var state2 = graph.view.getState(newSource);

                                if (state2 != null) {
                                    dx = (state2.getCenterX() - state1.getCenterX()) / graph.view.scale;
                                    dy = (state2.getCenterY() - state1.getCenterY()) / graph.view.scale;
                                }
                            }
                        }
                    }
                }

                result = graphMoveCells.apply(this, arguments);

                if (result != null && cells != null && result.length == cells.length) {
                    for (var i = 0; i < result.length; i++) {
                        // Connects all dangling edges from the sidebar
                        // when dropped into drop target (not hover icon)
                        if (this.model.isEdge(result[i])) {
                            if (isTreeVertex(newSource) && mxUtils.indexOf(result,
                                this.model.getTerminal(result[i], true)) < 0) {
                                this.model.setTerminal(result[i], newSource, true);
                            }
                        } else if (isTreeVertex(cells[i])) {
                            var edges = graph.getIncomingEdges(cells[i]);

                            if (edges.length > 0) {
                                if (!clone) {
                                    if (isTreeVertex(newSource) && mxUtils.indexOf(cells,
                                        this.model.getTerminal(edges[0], true)) < 0) {
                                        this.model.setTerminal(edges[0], newSource, true);
                                    }
                                } else {
                                    var newEdges = graph.getIncomingEdges(result[i]);

                                    if (newEdges.length == 0) {
                                        var temp = newSource;

                                        if (temp == null || temp == graph.model.getParent(cells[i])) {
                                            temp = graph.model.getTerminal(edges[0], true);
                                        }

                                        var clone = this.cloneCell(edges[0]);
                                        this.addEdge(clone, graph.getDefaultParent(), temp, result[i]);
                                    }
                                }
                            }
                        }
                    }
                }
            } finally {
                this.model.endUpdate();
            }

            return result;
        };

        // Connects all dangling edges from the sidebar (by
        // default only first dangling edge gets connected)
        if (ui.sidebar != null) {
            var sidebarDropAndConnect = ui.sidebar.dropAndConnect;

            ui.sidebar.dropAndConnect = function (source, targets, direction, dropCellIndex) {
                var model = graph.model;
                var result = null;

                model.beginUpdate();
                try {
                    result = sidebarDropAndConnect.apply(this, arguments);

                    if (isTreeVertex(source)) {
                        for (var i = 0; i < result.length; i++) {
                            if (model.isEdge(result[i]) && model.getTerminal(result[i], true) == null) {
                                model.setTerminal(result[i], source, true);
                                var geo = graph.getCellGeometry(result[i]);
                                geo.points = null;

                                if (geo.getTerminalPoint(true) != null) {
                                    geo.setTerminalPoint(null, true);
                                }
                            }
                        }
                    }
                } finally {
                    model.endUpdate();
                }

                return result;
            };
        }

        /**
         * Checks source point of incoming edge relative to target terminal.
         */
        function getTreeDirection(cell) {
            var state = graph.view.getState(cell);

            if (state != null) {
                var edges = graph.getIncomingEdges(state.cell);

                if (edges.length > 0) {
                    var edgeState = graph.view.getState(edges[0]);

                    if (edgeState != null) {
                        var abs = edgeState.absolutePoints;

                        if (abs != null && abs.length > 0) {
                            var pt = abs[abs.length - 1];

                            if (pt != null) {
                                if (pt.y == state.y && Math.abs(pt.x - state.getCenterX()) < state.width / 2) {
                                    return mxConstants.DIRECTION_SOUTH;
                                } else if (pt.y == state.y + state.height && Math.abs(pt.x - state.getCenterX()) < state.width / 2) {
                                    return mxConstants.DIRECTION_NORTH;
                                } else if (pt.x > state.getCenterX()) {
                                    return mxConstants.DIRECTION_WEST;
                                }
                            }
                        }
                    }
                }
            }

            return mxConstants.DIRECTION_EAST;
        };

        function addSibling(cell, after) {
            after = (after != null) ? after : true;

            graph.model.beginUpdate();
            try {
                var parent = graph.model.getParent(cell);
                var edges = graph.getIncomingEdges(cell);
                var clones = graph.cloneCells([edges[0], cell]);
                graph.model.setTerminal(clones[0], graph.model.getTerminal(edges[0], true), true);

                var dir = getTreeDirection(cell);
                var pgeo = parent.geometry;

                if (dir == mxConstants.DIRECTION_SOUTH || dir == mxConstants.DIRECTION_NORTH) {
                    clones[1].geometry.x += (after) ? cell.geometry.width + spacing :
                        -clones[1].geometry.width - spacing;
                } else {
                    clones[1].geometry.y += (after) ? cell.geometry.height + spacing :
                        -clones[1].geometry.height - spacing;
                }

                if (graph.view.currentRoot != parent) {
                    clones[1].geometry.x -= pgeo.x;
                    clones[1].geometry.y -= pgeo.y;
                }

                // Moves existing siblings
                var state = graph.view.getState(cell);
                var s = graph.view.scale;

                if (state != null) {
                    var bbox = mxRectangle.fromRectangle(state);

                    if (dir == mxConstants.DIRECTION_SOUTH ||
                        dir == mxConstants.DIRECTION_NORTH) {
                        bbox.x += ((after) ? cell.geometry.width + spacing :
                            -clones[1].geometry.width - spacing) * s;
                    } else {
                        bbox.y += ((after) ? cell.geometry.height + spacing :
                            -clones[1].geometry.height - spacing) * s;
                    }

                    var sib = graph.getOutgoingEdges(graph.model.getTerminal(edges[0], true));

                    if (sib != null) {
                        var hor = (dir == mxConstants.DIRECTION_SOUTH || dir == mxConstants.DIRECTION_NORTH);
                        var dx = 0;
                        var dy = 0;

                        for (var i = 0; i < sib.length; i++) {
                            var temp = graph.model.getTerminal(sib[i], false);

                            if (dir == getTreeDirection(temp)) {
                                var sibling = graph.view.getState(temp);

                                if (temp != cell && sibling != null) {
                                    if ((hor && after != sibling.getCenterX() < state.getCenterX()) ||
                                        (!hor && after != sibling.getCenterY() < state.getCenterY())) {
                                        if (mxUtils.intersects(bbox, sibling)) {
                                            dx = spacing + Math.max(dx, (Math.min(bbox.x + bbox.width,
                                                sibling.x + sibling.width) - Math.max(bbox.x, sibling.x)) / s);
                                            dy = spacing + Math.max(dy, (Math.min(bbox.y + bbox.height,
                                                sibling.y + sibling.height) - Math.max(bbox.y, sibling.y)) / s);
                                        }
                                    }
                                }
                            }
                        }

                        if (hor) {
                            dy = 0;
                        } else {
                            dx = 0;
                        }

                        for (var i = 0; i < sib.length; i++) {
                            var temp = graph.model.getTerminal(sib[i], false);

                            if (dir == getTreeDirection(temp)) {
                                var sibling = graph.view.getState(temp);

                                if (temp != cell && sibling != null) {
                                    if ((hor && after != sibling.getCenterX() < state.getCenterX()) ||
                                        (!hor && after != sibling.getCenterY() < state.getCenterY())) {
                                        var subtree = [];

                                        graph.traverse(sibling.cell, true, function (vertex, edge) {
                                            if (edge != null) {
                                                subtree.push(edge);
                                            }

                                            subtree.push(vertex);

                                            return true;
                                        });

                                        graph.moveCells(subtree, ((after) ? 1 : -1) * dx, ((after) ? 1 : -1) * dy);
                                    }
                                }
                            }
                        }
                    }
                }

                return graph.addCells(clones, parent);
            } finally {
                graph.model.endUpdate();
            }
        };

        function addParent(cell) {
            graph.model.beginUpdate();
            try {
                var dir = getTreeDirection(cell);
                var edges = graph.getIncomingEdges(cell);
                var clones = graph.cloneCells([edges[0], cell]);
                graph.model.setTerminal(edges[0], clones[1], false);
                graph.model.setTerminal(clones[0], clones[1], true);
                graph.model.setTerminal(clones[0], cell, false);

                // Makes space for new parent
                var parent = graph.model.getParent(cell);
                var pgeo = parent.geometry;
                var subtree = [];

                if (graph.view.currentRoot != parent) {
                    clones[1].geometry.x -= pgeo.x;
                    clones[1].geometry.y -= pgeo.y;
                }

                graph.traverse(cell, true, function (vertex, edge) {
                    if (edge != null) {
                        subtree.push(edge);
                    }

                    subtree.push(vertex);

                    return true;
                });

                var dx = cell.geometry.width + level;
                var dy = cell.geometry.height + level;

                if (dir == mxConstants.DIRECTION_SOUTH) {
                    dx = 0;
                } else if (dir == mxConstants.DIRECTION_NORTH) {
                    dx = 0;
                    dy = -dy;
                } else if (dir == mxConstants.DIRECTION_WEST) {
                    dx = -dx;
                    dy = 0;
                } else if (dir == mxConstants.DIRECTION_EAST) {
                    dy = 0;
                }

                graph.moveCells(subtree, dx, dy);

                return graph.addCells(clones, parent);
            } finally {
                graph.model.endUpdate();
            }
        };

        function addChild(cell) {
            graph.model.beginUpdate();
            try {
                var parent = graph.model.getParent(cell);
                var edges = graph.getIncomingEdges(cell);
                var clones = graph.cloneCells([edges[0], cell]);
                graph.model.setTerminal(clones[0], cell, true);

                // Finds free space
                var edges = graph.getOutgoingEdges(cell);
                var pgeo = parent.geometry;
                var targets = [];

                // Not offset if inside group
                if (graph.view.currentRoot == parent) {
                    pgeo = new mxRectangle();
                }

                for (var i = 0; i < edges.length; i++) {
                    var target = graph.model.getTerminal(edges[i], false);

                    if (target != null) {
                        targets.push(target);
                    }
                }

                var bbox = graph.view.getBounds(targets);
                var dir = getTreeDirection(cell);
                var tr = graph.view.translate;
                var s = graph.view.scale;

                if (dir == mxConstants.DIRECTION_SOUTH) {
                    clones[1].geometry.x = (bbox == null) ? cell.geometry.x + (cell.geometry.width -
                        clones[1].geometry.width) / 2 : (bbox.x + bbox.width) / s - tr.x -
                        pgeo.x + spacing;
                    clones[1].geometry.y += clones[1].geometry.height - pgeo.y + level;
                } else if (dir == mxConstants.DIRECTION_NORTH) {
                    clones[1].geometry.x = (bbox == null) ? cell.geometry.x + (cell.geometry.width -
                        clones[1].geometry.width) / 2 : (bbox.x + bbox.width) / s - tr.x + -
                        pgeo.x + spacing;
                    clones[1].geometry.y -= clones[1].geometry.height + pgeo.y + level;
                } else if (dir == mxConstants.DIRECTION_WEST) {
                    clones[1].geometry.x -= clones[1].geometry.width + pgeo.x + level;
                    clones[1].geometry.y = (bbox == null) ? cell.geometry.y + (cell.geometry.height -
                        clones[1].geometry.height) / 2 : (bbox.y + bbox.height) / s - tr.y + -
                        pgeo.y + spacing;
                } else {
                    clones[1].geometry.x += clones[1].geometry.width - pgeo.x + level;
                    clones[1].geometry.y = (bbox == null) ? cell.geometry.y + (cell.geometry.height -
                        clones[1].geometry.height) / 2 : (bbox.y + bbox.height) / s - tr.y + -
                        pgeo.y + spacing;
                }

                return graph.addCells(clones, parent);
            } finally {
                graph.model.endUpdate();
            }
        };

        function getOrderedTargets(cell, horizontal, ref) {
            var sib = graph.getOutgoingEdges(cell);
            var state = graph.view.getState(ref);
            var targets = [];

            if (state != null && sib != null) {
                for (var i = 0; i < sib.length; i++) {
                    var temp = graph.view.getState(graph.model.getTerminal(sib[i], false));

                    if (temp != null && ((!horizontal && (Math.min(temp.x + temp.width,
                        state.x + state.width) >= Math.max(temp.x, state.x))) ||
                        (horizontal && (Math.min(temp.y + temp.height, state.y + state.height) >=
                            Math.max(temp.y, state.y))))) {
                        targets.push(temp);
                    }
                }

                targets.sort(function (a, b) {
                    return (horizontal) ? a.x + a.width - b.x - b.width : a.y + a.height - b.y - b.height;
                });
            }

            return targets;
        };

        function selectCell(cell, direction) {
            var dir = getTreeDirection(cell);
            var h1 = dir == mxConstants.DIRECTION_EAST || dir == mxConstants.DIRECTION_WEST;
            var h2 = direction == mxConstants.DIRECTION_EAST || direction == mxConstants.DIRECTION_WEST;

            if (h1 == h2 && dir != direction) {
                ui.actions.get('selectParent').funct();
            } else if (dir == direction) {
                var sib = graph.getOutgoingEdges(cell);

                if (sib != null && sib.length > 0) {
                    graph.setSelectionCell(graph.model.getTerminal(sib[0], false));
                }
            } else {
                var edges = graph.getIncomingEdges(cell);

                if (edges != null && edges.length > 0) {
                    var targets = getOrderedTargets(graph.model.getTerminal(edges[0], true), h2, cell);
                    var state = graph.view.getState(cell);

                    if (state != null) {
                        var idx = mxUtils.indexOf(targets, state);

                        if (idx >= 0) {
                            idx += (direction == mxConstants.DIRECTION_NORTH || direction == mxConstants.DIRECTION_WEST) ? -1 : 1;

                            if (idx >= 0 && idx <= targets.length - 1) {
                                graph.setSelectionCell(targets[idx].cell);
                            }
                        }
                    }
                }
            }
        };

        // Overrides keyboard shortcuts inside tree containers
        var altShiftActions = {
            88: ui.actions.get('selectChildren'), // Alt+Shift+X
            84: ui.actions.get('selectSubtree'), // Alt+Shift+T
            80: ui.actions.get('selectParent'), // Alt+Shift+P
            83: ui.actions.get('selectSiblings')
        } // Alt+Shift+S

        var editorUiOnKeyDown = ui.onKeyDown;

        ui.onKeyDown = function (evt) {
            try {
                if (graph.isEnabled() && !graph.isEditing() &&
                    isTreeVertex(graph.getSelectionCell()) &&
                    graph.getSelectionCount() == 1) {
                    var cells = null;

                    if (graph.getIncomingEdges(graph.getSelectionCell()).length > 0) {
                        if (evt.which == 9) // Tab adds child
                        {
                            cells = (mxEvent.isShiftDown(evt)) ?
                                addParent(graph.getSelectionCell()) :
                                addChild(graph.getSelectionCell());
                        } else if (evt.which == 13) // Enter adds sibling
                        {
                            cells = addSibling(graph.getSelectionCell(), !mxEvent.isShiftDown(evt));
                        }
                    }

                    if (cells != null && cells.length > 0) {
                        if (cells.length == 1 && graph.model.isEdge(cells[0])) {
                            graph.setSelectionCell(graph.model.getTerminal(cells[0], false));
                        } else {
                            graph.setSelectionCell(cells[cells.length - 1]);
                        }

                        if (ui.hoverIcons != null) {
                            ui.hoverIcons.update(graph.view.getState(graph.getSelectionCell()));
                        }

                        graph.startEditingAtCell(graph.getSelectionCell());
                        mxEvent.consume(evt);
                    } else {
                        if (mxEvent.isAltDown(evt) && mxEvent.isShiftDown(evt)) {
                            var action = altShiftActions[evt.keyCode];

                            if (action != null) {
                                action.funct(evt);
                                mxEvent.consume(evt);
                            }
                        } else {
                            if (evt.keyCode == 37) // left
                            {
                                selectCell(graph.getSelectionCell(), mxConstants.DIRECTION_WEST);
                                mxEvent.consume(evt);
                            } else if (evt.keyCode == 38) // up
                            {
                                selectCell(graph.getSelectionCell(), mxConstants.DIRECTION_NORTH);
                                mxEvent.consume(evt);
                            } else if (evt.keyCode == 39) // right
                            {
                                selectCell(graph.getSelectionCell(), mxConstants.DIRECTION_EAST);
                                mxEvent.consume(evt);
                            } else if (evt.keyCode == 40) // down
                            {
                                selectCell(graph.getSelectionCell(), mxConstants.DIRECTION_SOUTH);
                                mxEvent.consume(evt);
                            }
                        }
                    }
                }
            } catch (e) {
                console.log('error', e);
            }

            if (!mxEvent.isConsumed(evt)) {
                editorUiOnKeyDown.apply(this, arguments);
            }
        };

        var graphConnectVertex = graph.connectVertex;

        graph.connectVertex = function (source, direction, length, evt, forceClone, ignoreCellAt) {
            var edges = graph.getIncomingEdges(source);

            if (isTreeVertex(source) && edges.length > 0) {
                var dir = getTreeDirection(source);
                var h1 = dir == mxConstants.DIRECTION_EAST || dir == mxConstants.DIRECTION_WEST;
                var h2 = direction == mxConstants.DIRECTION_EAST || direction == mxConstants.DIRECTION_WEST;

                if (dir == direction) {
                    return addChild(source);
                } else if (h1 == h2) {
                    return addParent(source);
                } else {
                    return addSibling(source, direction != mxConstants.DIRECTION_NORTH &&
                        direction != mxConstants.DIRECTION_WEST);
                }
            } else {
                return graphConnectVertex.call(this, source, direction,
                    length, evt, forceClone, ignoreCellAt);
            }
        };

        graph.getSubtree = function (initialCell) {
            var cells = [initialCell];

            if ((isTreeMoving(initialCell) || isTreeVertex(initialCell)) && !hasLayoutParent(initialCell)) {
                // Gets the subtree from cell downwards
                graph.traverse(initialCell, true, function (vertex, edge) {
                    // LATER: Use dictionary to avoid duplicates
                    if (edge != null && mxUtils.indexOf(cells, edge) < 0) {
                        cells.push(edge);
                    }

                    if (mxUtils.indexOf(cells, vertex) < 0) {
                        cells.push(vertex);
                    }

                    return true;
                });
            }

            return cells;
        };


        var vertexHandlerInit = mxVertexHandler.prototype.init;

        mxVertexHandler.prototype.init = function () {
            vertexHandlerInit.apply(this, arguments);

            if ((isTreeMoving(this.state.cell) || isTreeVertex(this.state.cell)) && this.graph.getOutgoingEdges(this.state.cell).length > 0) {
                this.moveHandle = mxUtils.createImage(moveImage);
                this.moveHandle.setAttribute('title', 'Move Subtree');
                this.moveHandle.style.position = 'absolute';
                this.moveHandle.style.cursor = 'pointer';
                this.moveHandle.style.width = '18px';
                this.moveHandle.style.height = '18px';
                this.graph.container.appendChild(this.moveHandle);

                mxEvent.addGestureListeners(this.moveHandle, mxUtils.bind(this, function (evt) {
                    this.graph.graphHandler.start(this.state.cell, mxEvent.getClientX(evt), mxEvent.getClientY(evt));
                    this.graph.graphHandler.cells = this.graph.getSubtree(this.state.cell);
                    this.graph.graphHandler.bounds = this.state.view.getBounds(this.graph.graphHandler.cells);
                    this.graph.graphHandler.pBounds = this.graph.graphHandler.getPreviewBounds(this.graph.graphHandler.cells);
                    this.graph.graphHandler.cellWasClicked = true;
                    this.graph.isMouseTrigger = mxEvent.isMouseEvent(evt);
                    this.graph.isMouseDown = true;
                    mxEvent.consume(evt);
                }));
            }
        };

        var vertexHandlerRedrawHandles = mxVertexHandler.prototype.redrawHandles;

        mxVertexHandler.prototype.redrawHandles = function () {
            vertexHandlerRedrawHandles.apply(this, arguments);

            if (this.moveHandle != null) {
                this.moveHandle.style.left = this.state.x + this.state.width +
                    ((this.state.width < 40) ? 10 : 0) + 2 + 'px';
                this.moveHandle.style.top = this.state.y + this.state.height +
                    ((this.state.height < 40) ? 10 : 0) + 2 + 'px';
            }
        };

        var vertexHandlerDestroy = mxVertexHandler.prototype.destroy;

        mxVertexHandler.prototype.destroy = function (sender, me) {
            vertexHandlerDestroy.apply(this, arguments);

            if (this.moveHandle != null) {
                this.moveHandle.parentNode.removeChild(this.moveHandle);
                this.moveHandle = null;
            }
        };
    };

    /**
     * Adds shapes to sidebar in edit mode.
     */
    if (typeof Sidebar !== 'undefined') {
        var sidebarCreateAdvancedShapes = Sidebar.prototype.createAdvancedShapes;
        Sidebar.prototype.createAdvancedShapes = function () {
            var result = sidebarCreateAdvancedShapes.apply(this, arguments);
            var graph = this.graph;

            return result.concat([
                this.addEntry('tree container', function () {
                    var cell = new mxCell('Tree Container', new mxGeometry(0, 0, 220, 160),
                        'swimlane;html=1;startSize=20;horizontal=1;containerType=tree;');
                    cell.vertex = true;

                    return sb.createVertexTemplateFromCells([cell], cell.geometry.width,
                        cell.geometry.height, cell.value);
                }),
                this.addEntry('tree mindmap mindmaps central idea branch topic', function () {
                    var mindmap = new mxCell('Mindmap', new mxGeometry(0, 0, 420, 126),
                        'swimlane;html=1;startSize=20;horizontal=1;containerType=tree;');
                    mindmap.vertex = true;

                    var cell = new mxCell('Central Idea', new mxGeometry(160, 60, 100, 40),
                        'ellipse;whiteSpace=wrap;html=1;align=center;' +
                        'container=1;recursiveResize=0;treeFolding=1;treeMoving=1;');
                    cell.vertex = true;

                    var cell2 = new mxCell('Topic', new mxGeometry(320, 40, 80, 20),
                        'whiteSpace=wrap;html=1;rounded=1;arcSize=50;align=center;verticalAlign=middle;' +
                        'container=1;recursiveResize=0;strokeWidth=1;autosize=1;spacing=4;treeFolding=1;treeMoving=1;');
                    cell2.vertex = true;

                    var edge = new mxCell('', new mxGeometry(0, 0, 0, 0), 'edgeStyle=entityRelationEdgeStyle;' +
                        'startArrow=none;endArrow=none;segment=10;curved=1;');
                    edge.geometry.relative = true;
                    edge.edge = true;

                    cell.insertEdge(edge, true);
                    cell2.insertEdge(edge, false);

                    var cell3 = new mxCell('Branch', new mxGeometry(320, 80, 72, 26),
                        'whiteSpace=wrap;html=1;shape=partialRectangle;top=0;left=0;bottom=1;right=0;points=[[0,1],[1,1]];' +
                        'strokeColor=#000000;fillColor=none;align=center;verticalAlign=bottom;routingCenterY=0.5;' +
                        'snapToPoint=1;container=1;recursiveResize=0;autosize=1;treeFolding=1;treeMoving=1;');
                    cell3.vertex = true;

                    var edge2 = new mxCell('', new mxGeometry(0, 0, 0, 0), 'edgeStyle=entityRelationEdgeStyle;' +
                        'startArrow=none;endArrow=none;segment=10;curved=1;');
                    edge2.geometry.relative = true;
                    edge2.edge = true;

                    cell.insertEdge(edge2, true);
                    cell3.insertEdge(edge2, false);

                    var cell4 = new mxCell('Topic', new mxGeometry(20, 40, 80, 20),
                        'whiteSpace=wrap;html=1;rounded=1;arcSize=50;align=center;verticalAlign=middle;' +
                        'container=1;recursiveResize=0;strokeWidth=1;autosize=1;spacing=4;treeFolding=1;treeMoving=1;');
                    cell4.vertex = true;

                    var edge3 = new mxCell('', new mxGeometry(0, 0, 0, 0), 'edgeStyle=entityRelationEdgeStyle;' +
                        'startArrow=none;endArrow=none;segment=10;curved=1;');
                    edge3.geometry.relative = true;
                    edge3.edge = true;

                    cell.insertEdge(edge3, true);
                    cell4.insertEdge(edge3, false);

                    var cell5 = new mxCell('Branch', new mxGeometry(20, 80, 72, 26),
                        'whiteSpace=wrap;html=1;shape=partialRectangle;top=0;left=0;bottom=1;right=0;points=[[0,1],[1,1]];' +
                        'strokeColor=#000000;fillColor=none;align=center;verticalAlign=bottom;routingCenterY=0.5;' +
                        'snapToPoint=1;container=1;recursiveResize=0;autosize=1;treeFolding=1;treeMoving=1;');
                    cell5.vertex = true;

                    var edge4 = new mxCell('', new mxGeometry(0, 0, 0, 0), 'edgeStyle=entityRelationEdgeStyle;' +
                        'startArrow=none;endArrow=none;segment=10;curved=1;');
                    edge4.geometry.relative = true;
                    edge4.edge = true;

                    cell.insertEdge(edge4, true);
                    cell5.insertEdge(edge4, false);

                    mindmap.insert(edge);
                    mindmap.insert(edge2);
                    mindmap.insert(edge3);
                    mindmap.insert(edge4);
                    mindmap.insert(cell);
                    mindmap.insert(cell2);
                    mindmap.insert(cell3);
                    mindmap.insert(cell4);
                    mindmap.insert(cell5);

                    return sb.createVertexTemplateFromCells([mindmap], mindmap.geometry.width,
                        mindmap.geometry.height, mindmap.value);
                }),
                this.addEntry('tree mindmap mindmaps central idea', function () {
                    var cell = new mxCell('Central Idea', new mxGeometry(0, 0, 100, 40),
                        'ellipse;whiteSpace=wrap;html=1;align=center;' +
                        'container=1;recursiveResize=0;treeFolding=1;treeMoving=1;');
                    cell.vertex = true;

                    return sb.createVertexTemplateFromCells([cell], cell.geometry.width,
                        cell.geometry.height, cell.value);
                }),
                this.addEntry('tree mindmap mindmaps branch', function () {
                    var cell = new mxCell('Branch', new mxGeometry(0, 0, 80, 20),
                        'whiteSpace=wrap;html=1;shape=partialRectangle;top=0;left=0;bottom=1;right=0;points=[[0,1],[1,1]];' +
                        'strokeColor=#000000;fillColor=none;align=center;verticalAlign=bottom;routingCenterY=0.5;' +
                        'snapToPoint=1;container=1;recursiveResize=0;autosize=1;treeFolding=1;treeMoving=1;');
                    cell.vertex = true;

                    var edge = new mxCell('', new mxGeometry(0, 0, 0, 0), 'edgeStyle=entityRelationEdgeStyle;' +
                        'startArrow=none;endArrow=none;segment=10;curved=1;');
                    edge.geometry.setTerminalPoint(new mxPoint(-40, 40), true);
                    edge.geometry.relative = true;
                    edge.edge = true;

                    cell.insertEdge(edge, false);

                    return sb.createVertexTemplateFromCells([cell, edge], cell.geometry.width,
                        cell.geometry.height, cell.value);
                }),
                this.addEntry('tree mindmap mindmaps sub topic', function () {
                    var cell = new mxCell('Sub Topic', new mxGeometry(0, 0, 72, 26),
                        'whiteSpace=wrap;html=1;rounded=1;arcSize=50;align=center;verticalAlign=middle;' +
                        'container=1;recursiveResize=0;strokeWidth=1;autosize=1;spacing=4;treeFolding=1;treeMoving=1;');
                    cell.vertex = true;

                    var edge = new mxCell('', new mxGeometry(0, 0, 0, 0), 'edgeStyle=entityRelationEdgeStyle;' +
                        'startArrow=none;endArrow=none;segment=10;curved=1;');
                    edge.geometry.setTerminalPoint(new mxPoint(-40, 40), true);
                    edge.geometry.relative = true;
                    edge.edge = true;

                    cell.insertEdge(edge, false);

                    return sb.createVertexTemplateFromCells([cell, edge], cell.geometry.width,
                        cell.geometry.height, cell.value);
                }),
                this.addEntry('tree orgchart organization division', function () {
                    var orgchart = new mxCell('Orgchart', new mxGeometry(0, 0, 280, 220),
                        'swimlane;html=1;startSize=20;horizontal=1;containerType=tree;');
                    orgchart.vertex = true;

                    var cell = new mxCell('Organization', new mxGeometry(80, 40, 120, 60),
                        'whiteSpace=wrap;html=1;align=center;treeFolding=1;treeMoving=1;' +
                        'container=1;recursiveResize=0;');
                    graph.setAttributeForCell(cell, 'treeRoot', '1');
                    cell.vertex = true;

                    var cell2 = new mxCell('Division', new mxGeometry(20, 140, 100, 60),
                        'whiteSpace=wrap;html=1;align=center;verticalAlign=middle;' +
                        'container=1;recursiveResize=0;treeFolding=1;treeMoving=1;');
                    cell2.vertex = true;

                    var edge = new mxCell('', new mxGeometry(0, 0, 0, 0),
                        'edgeStyle=elbowEdgeStyle;elbow=vertical;' +
                        'startArrow=none;endArrow=none;rounded=0;');
                    edge.geometry.relative = true;
                    edge.edge = true;

                    cell.insertEdge(edge, true);
                    cell2.insertEdge(edge, false);

                    var cell3 = new mxCell('Division', new mxGeometry(160, 140, 100, 60),
                        'whiteSpace=wrap;html=1;align=center;verticalAlign=middle;' +
                        'container=1;recursiveResize=0;treeFolding=1;treeMoving=1;');
                    cell3.vertex = true;

                    var edge2 = new mxCell('', new mxGeometry(0, 0, 0, 0),
                        'edgeStyle=elbowEdgeStyle;elbow=vertical;' +
                        'startArrow=none;endArrow=none;rounded=0;');
                    edge2.geometry.relative = true;
                    edge2.edge = true;

                    cell.insertEdge(edge2, true);
                    cell3.insertEdge(edge2, false);

                    orgchart.insert(edge);
                    orgchart.insert(edge2);
                    orgchart.insert(cell);
                    orgchart.insert(cell2);
                    orgchart.insert(cell3);

                    return sb.createVertexTemplateFromCells([orgchart], orgchart.geometry.width,
                        orgchart.geometry.height, orgchart.value);
                }),
                this.addEntry('tree root', function () {
                    var cell = new mxCell('Organization', new mxGeometry(0, 0, 120, 60),
                        'whiteSpace=wrap;html=1;align=center;treeFolding=1;treeMoving=1;' +
                        'container=1;recursiveResize=0;');
                    graph.setAttributeForCell(cell, 'treeRoot', '1');
                    cell.vertex = true;

                    return sb.createVertexTemplateFromCells([cell], cell.geometry.width,
                        cell.geometry.height, cell.value);
                }),
                this.addEntry('tree division', function () {
                    var cell = new mxCell('Division', new mxGeometry(20, 40, 100, 60),
                        'whiteSpace=wrap;html=1;align=center;verticalAlign=middle;' +
                        'container=1;recursiveResize=0;treeFolding=1;treeMoving=1;');
                    cell.vertex = true;

                    var edge = new mxCell('', new mxGeometry(0, 0, 0, 0),
                        'edgeStyle=elbowEdgeStyle;elbow=vertical;' +
                        'startArrow=none;endArrow=none;rounded=0;');
                    edge.geometry.setTerminalPoint(new mxPoint(0, 0), true);
                    edge.geometry.relative = true;
                    edge.edge = true;

                    cell.insertEdge(edge, false);

                    return sb.createVertexTemplateFromCells([cell, edge], cell.geometry.width,
                        cell.geometry.height, cell.value);
                }),
                this.addEntry('tree sub sections', function () {
                    var cell = new mxCell('Sub Section', new mxGeometry(0, 0, 100, 60),
                        'whiteSpace=wrap;html=1;align=center;verticalAlign=middle;' +
                        'container=1;recursiveResize=0;treeFolding=1;treeMoving=1;');
                    cell.vertex = true;

                    var edge = new mxCell('', new mxGeometry(0, 0, 0, 0), 'edgeStyle=orthogonalEdgeStyle;' +
                        'startArrow=none;endArrow=none;rounded=0;targetPortConstraint=eastwest;sourcePortConstraint=northsouth;');
                    edge.geometry.setTerminalPoint(new mxPoint(110, -40), true);
                    edge.geometry.relative = true;
                    edge.edge = true;

                    cell.insertEdge(edge, false);

                    var cell2 = new mxCell('Sub Section', new mxGeometry(120, 0, 100, 60),
                        'whiteSpace=wrap;html=1;align=center;verticalAlign=middle;' +
                        'container=1;recursiveResize=0;treeFolding=1;treeMoving=1;');
                    cell2.vertex = true;

                    var edge2 = new mxCell('', new mxGeometry(0, 0, 0, 0), 'edgeStyle=orthogonalEdgeStyle;' +
                        'startArrow=none;endArrow=none;rounded=0;targetPortConstraint=eastwest;sourcePortConstraint=northsouth;');
                    edge2.geometry.setTerminalPoint(new mxPoint(110, -40), true);
                    edge2.geometry.relative = true;
                    edge2.edge = true;

                    cell2.insertEdge(edge2, false);

                    return sb.createVertexTemplateFromCells([edge, edge2, cell, cell2], 220, 60, 'Sub Sections');
                })
            ]);
        };
    }
})();

/**
 * Code for the minimal UI theme.
 */
EditorUi.initMinimalTheme = function () {
    // Disabled in lightbox and chromeless mode
    if (urlParams['lightbox'] == '1' || urlParams['chrome'] == '0' || typeof window.Format === 'undefined' || typeof window.Menus === 'undefined') {
        window.uiTheme = null;

        return;
    }

    var iw = window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth;

    try {
        var style = document.createElement('style')
        style.type = 'text/css';
        style.innerHTML = '* { -webkit-font-smoothing: antialiased; }' +
            'html body .mxWindow button.geBtn { font-size:12px !important; margin-left: 0; }' +
            'html body table.mxWindow td.mxWindowPane div.mxWindowPane *:not(svg *) { font-size:9pt; }' +
            'table.mxWindow * { font-size:13px; }' +
            'html body div.diagramContainer button, html body button.geBtn { font-size:14px; font-weight:700;border-radius: 5px; }' +
            'html body button.geBtn:active { opacity: 0.6; }' +
            'html body a.geMenuItem { opacity: 0.75; cursor: pointer; user-select:none; }' +
            'html body a.geMenuItem[disabled] { opacity: 0.2; }' +
            'html body a.geMenuItem[disabled]:active { opacity: 0.2; }' +
            'html body div.geActivePage { opacity: 0.7; }' +
            'html body a.geMenuItem:active { opacity: 0.2; }' +
            'html body .geToolbarButton { opacity: 0.3; }' +
            'html body .geToolbarButton:active { opacity: 0.15; }' +
            'html body .geStatus:active { opacity: 0.5; }' +
            'html table.mxPopupMenu tr.mxPopupMenuItemHover:active { opacity:0.7; }' +
            'html body .geDialog input, html body .geToolbarContainer input, html body .mxWindow input {padding:2px;display:inline-block; }' +
            'div.geDialog { border-radius: 5px; }' +
            'html body div.geDialog button.geBigButton { color: #fff !important; border: none !important; }' +
            '.mxWindow button, .geDialog select, .mxWindow select { display:inline-block; }' +
            'html body .mxWindow .geColorBtn, html body .geDialog .geColorBtn { background: none; }' +
            'html body div.diagramContainer button, html body .mxWindow button, html body .geDialog button { min-width: 0px; border-radius: 5px; color: #353535 !important; border-style: solid; border-width: 1px; border-color: rgb(216, 216, 216); }' +
            'html body div.diagramContainer button:hover, html body .mxWindow button:hover, html body .geDialog button:hover { border-color: rgb(177, 177, 177); }' +
            'html body div.diagramContainer button:active, html body .mxWindow button:active, html body .geDialog button:active { opacity: 0.6; }' +
            'div.diagramContainer button.geBtn, .mxWindow button.geBtn, .geDialog button.geBtn { min-width:72px; font-weight: 600; background: none; }' +
            'div.diagramContainer button.gePrimaryBtn, .mxWindow button.gePrimaryBtn, .geDialog button.gePrimaryBtn, html body .gePrimaryBtn { background: #29b6f2; color: #fff !important; border: none; box-shadow: none; }' +
            'html body .gePrimaryBtn:hover { background: #29b6f2; border: none; box-shadow: inherit; }' +
            'html body button.gePrimaryBtn:hover { background: #29b6f2; border: none; }' +
            '.geBtn button { min-width:72px !important; }' +
            'div.geToolbarContainer a.geButton { margin:0px; padding: 0 2px 4px 2px; } ' +
            '.geDialog, .mxWindow td.mxWindowPane *, div.geSprite, td.mxWindowTitle, .geDiagramContainer { box-sizing:content-box; }' +
            '.mxWindow div button.geStyleButton { box-sizing: border-box; }' +
            'table.mxWindow td.mxWindowPane button.geColorBtn { padding:0px; box-sizing: border-box; }' +
            'td.mxWindowPane .geSidebarContainer button { padding:2px; box-sizing: border-box; }' +
            'html body .geMenuItem { font-size:14px; text-decoration: none; font-weight: normal; padding: 6px 10px 6px 10px; border: none; border-radius: 5px; color: #353535; box-shadow: inset 0 0 0 1px rgba(0,0,0,.11), inset 0 -1px 0 0 rgba(0,0,0,.08), 0 1px 2px 0 rgba(0,0,0,.04); }' +
            // Styling for Minimal
            '.geToolbarContainer { background:#fff !important; }' +
            'div.geSidebarContainer { background-color: #ffffff; }' +
            'div.geSidebarContainer .geTitle { background-color:#fdfdfd; }' +
            'div.mxWindow td.mxWindowPane button { background-image: none; float: none; }' +
            'td.mxWindowTitle { height: 22px !important; background: none !important; font-size: 13px !important; text-align:center !important; border-bottom:1px solid lightgray; }' +
            'div.mxWindow, div.mxWindowTitle { background-image: none !important; background-color:#fff !important; }' +
            'div.mxWindow { border-radius:5px; box-shadow: 0px 0px 2px #C0C0C0 !important;}' +
            'div.mxWindow * { font-family: inherit !important; }' +
            // Minimal Style UI
            'html div.geVerticalHandle { position:absolute;bottom:0px;left:50%;cursor:row-resize;width:11px;height:11px;background:white;margin-bottom:-6px; margin-left:-6px; border: none; border-radius: 6px; box-shadow: inset 0 0 0 1px rgba(0,0,0,.11), inset 0 -1px 0 0 rgba(0,0,0,.08), 0 1px 2px 0 rgba(0,0,0,.04); }' +
            'html div.geInactivePage { background: rgb(249, 249, 249) !important; color:lightgray !important; } ' +
            'html div.geActivePage { background: white !important;color: #353535 !important; } ' +
            'html div.mxRubberband { border:1px solid; border-color: #29b6f2 !important; background:rgba(41,182,242,0.5) !important; } ' +
            'html body div.mxPopupMenu { border-radius:5px; border:1px solid #c0c0c0; padding:5px 0 5px 0; box-shadow: 0px 4px 17px -4px rgba(96,96,96,1); } ' +
            'html table.mxPopupMenu td.mxPopupMenuItem { color: #353535; font-size: 14px; padding-top: 4px; padding-bottom: 4px; }' +
            'html table.mxPopupMenu tr.mxPopupMenuItemHover { background-color: #29b6f2; }' +
            'html tr.mxPopupMenuItemHover td.mxPopupMenuItem, html tr.mxPopupMenuItemHover td.mxPopupMenuItem span { color: #fff !important; }' +
            'html tr.mxPopupMenuItem, html td.mxPopupMenuItem { transition-property: none !important; }' +
            'html table.mxPopupMenu hr { height: 2px; background-color: rgba(0,0,0,.07); margin: 5px 0; }' +
            // Fixes checkbox and radio size on iOS
            ((mxClient.IS_IOS) ? 'html input[type=checkbox], html input[type=radio] { height:12px; }' : '');
        document.getElementsByTagName('head')[0].appendChild(style);
    } catch (e) {
        // ignore
    }

    /**
     *
     */
    var WrapperWindow = function (editorUi, title, x, y, w, h, fn) {
        var graph = editorUi.editor.graph;

        var div = document.createElement('div');
        div.className = 'geSidebarContainer';
        div.style.position = 'absolute';
        div.style.width = '100%';
        div.style.height = '100%';
        div.style.border = '1px solid whiteSmoke';
        div.style.overflowX = 'hidden';
        div.style.overflowY = 'auto';

        fn(div);

        this.window = new mxWindow(title, div, x, y, w, h, true, true);
        this.window.destroyOnClose = false;
        this.window.setMaximizable(false);
        this.window.setResizable(true);
        this.window.setClosable(true);
        this.window.setVisible(true);

        this.window.setLocation = function (x, y) {
            var iiw = window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth;
            var ih = window.innerHeight || document.documentElement.clientHeight || document.body.clientHeight;

            x = Math.max(0, Math.min(x, iiw - this.table.clientWidth));
            y = Math.max(0, Math.min(y, ih - this.table.clientHeight - 48));

            if (this.getX() != x || this.getY() != y) {
                mxWindow.prototype.setLocation.apply(this, arguments);
            }
        };

        // Workaround for text selection starting in Safari
        // when dragging shapes outside of window
        if (mxClient.IS_SF) {
            this.window.div.onselectstart = mxUtils.bind(this, function (evt) {
                if (evt == null) {
                    evt = window.event;
                }

                return (evt != null && editorUi.isSelectionAllowed(evt));
            });
        }
    };

    function toggleFormat(ui) {
        var graph = ui.editor.graph;
        graph.popupMenuHandler.hideMenu();

        if (ui.formatWindow == null) {
            ui.formatWindow = new WrapperWindow(ui, mxResources.get('format'),
                Math.max(20, ui.diagramContainer.clientWidth - 240 - 12), 56,
                240, Math.min(566, graph.container.clientHeight - 10), function (container) {
                    var format = ui.createFormat(container);
                    format.init();

                    return format;
                });

            ui.formatWindow.window.minimumSize = new mxRectangle(0, 0, 240, 80);
            ui.formatWindow.window.setVisible(true);
        } else {
            ui.formatWindow.window.setVisible(!ui.formatWindow.window.isVisible());
        }

        if (ui.formatWindow.window.isVisible()) {
            ui.formatWindow.window.fit();
        }
    };

    function toggleShapes(ui) {
        var graph = ui.editor.graph;
        graph.popupMenuHandler.hideMenu();
        var rect = new mxRectangle();

        if (ui.sidebarWindow == null) {
            var w = Math.min(graph.container.clientWidth - 10, 218);

            ui.sidebarWindow = new WrapperWindow(ui, mxResources.get('shapes'), 10, 56,
                w - 6, Math.min(650, graph.container.clientHeight - 30),
                function (container) {
                    var div = document.createElement('div');
                    div.style.cssText = 'position:absolute;left:0;right:0;border-top:1px solid lightgray;' +
                        'height:24px;bottom:31px;text-align:center;cursor:pointer;padding:6px 0 0 0;';
                    div.className = 'geTitle';
                    div.innerHTML = '<span style="font-size:18px;margin-right:5px;">+</span>';
                    mxUtils.write(div, mxResources.get('moreShapes'));
                    container.appendChild(div);

                    mxEvent.addListener(div, 'click', function () {
                        ui.actions.get('shapes').funct();
                    });

                    var menuObj = new Menubar(ui, container);

                    function addMenu(id, label) {
                        var menu = ui.menus.get(id);

                        var elt = menuObj.addMenu(label, mxUtils.bind(this, function () {
                            // Allows extensions of menu.functid
                            menu.funct.apply(this, arguments);
                        }));

                        elt.style.cssText = 'position:absolute;border-top:1px solid lightgray;width:50%;' +
                            'height:24px;bottom:0px;text-align:center;cursor:pointer;padding:6px 0 0 0;cusor:pointer;';
                        elt.className = 'geTitle';
                        container.appendChild(elt);

                        return elt;
                    }

                    if (Editor.enableCustomLibraries && (urlParams['embed'] != '1' || urlParams['libraries'] == '1')) {
                        // Defined in native apps together with openLibrary
                        if (ui.actions.get('newLibrary') != null) {
                            var div = document.createElement('div');
                            div.style.cssText = 'position:absolute;left:0px;width:50%;border-top:1px solid lightgray;' +
                                'height:30px;bottom:0px;text-align:center;cursor:pointer;padding:0px;';
                            div.className = 'geTitle';
                            var span = document.createElement('span');
                            span.style.cssText = 'position:relative;top:6px;';
                            mxUtils.write(span, mxResources.get('newLibrary'));
                            div.appendChild(span);
                            container.appendChild(div);

                            mxEvent.addListener(div, 'click', ui.actions.get('newLibrary').funct);

                            var div = document.createElement('div');
                            div.style.cssText = 'position:absolute;left:50%;width:50%;border-top:1px solid lightgray;' +
                                'height:30px;bottom:0px;text-align:center;cursor:pointer;padding:0px;border-left: 1px solid lightgray;';
                            div.className = 'geTitle';
                            var span = document.createElement('span');
                            span.style.cssText = 'position:relative;top:6px;';
                            mxUtils.write(span, mxResources.get('openLibrary'));
                            div.appendChild(span);
                            container.appendChild(div);

                            mxEvent.addListener(div, 'click', ui.actions.get('openLibrary').funct);
                        } else {
                            var elt = addMenu('newLibrary', mxResources.get('newLibrary'));
                            elt.style.boxSizing = 'border-box';
                            elt.style.paddingRight = '6px';
                            elt.style.paddingLeft = '6px';
                            elt.style.height = '32px';
                            elt.style.left = '0';

                            var elt = addMenu('openLibraryFrom', mxResources.get('openLibraryFrom'));
                            elt.style.borderLeft = '1px solid lightgray';
                            elt.style.boxSizing = 'border-box';
                            elt.style.paddingRight = '6px';
                            elt.style.paddingLeft = '6px';
                            elt.style.height = '32px';
                            elt.style.left = '50%';
                        }
                    } else {
                        div.style.bottom = '0';
                    }

                    container.appendChild(ui.sidebar.container);
                    container.style.overflow = 'hidden';

                    return container;
                });

            ui.sidebarWindow.window.minimumSize = new mxRectangle(0, 0, 90, 90);
            ui.sidebarWindow.window.setVisible(true);

            ui.getLocalData('sidebar', function (value) {
                ui.sidebar.showEntries(value, null, true);
            });

            ui.restoreLibraries();
        } else {
            ui.sidebarWindow.window.setVisible(!ui.sidebarWindow.window.isVisible());
        }

        if (ui.sidebarWindow.window.isVisible()) {
            ui.sidebarWindow.window.fit();
        }
    };

    // Changes colors for some UI elements
    var fill = '#29b6f2';
    var stroke = '#ffffff';

    Editor.checkmarkImage = Graph.createSvgImage(22, 18, '<path transform="translate(4 0)" d="M7.181,15.007a1,1,0,0,1-.793-0.391L3.222,10.5A1,1,0,1,1,4.808,9.274L7.132,12.3l6.044-8.86A1,1,0,1,1,14.83,4.569l-6.823,10a1,1,0,0,1-.8.437H7.181Z" fill="' + fill + '"/>').src;
    mxWindow.prototype.closeImage = Graph.createSvgImage(18, 10, '<path d="M 5 1 L 13 9 M 13 1 L 5 9" stroke="#C0C0C0" stroke-width="2"/>').src;
    mxWindow.prototype.minimizeImage = Graph.createSvgImage(14, 10, '<path d="M 3 7 L 7 3 L 11 7" stroke="#C0C0C0" stroke-width="2" fill="#ffffff"/>').src;
    mxWindow.prototype.normalizeImage = Graph.createSvgImage(14, 10, '<path d="M 3 3 L 7 7 L 11 3" stroke="#C0C0C0" stroke-width="2" fill="#ffffff"/>').src;
    mxConstraintHandler.prototype.pointImage = Graph.createSvgImage(5, 5, '<path d="m 0 0 L 5 5 M 0 5 L 5 0" stroke="' + fill + '"/>');
    mxOutline.prototype.sizerImage = null;

    mxConstants.VERTEX_SELECTION_COLOR = '#C0C0C0';
    mxConstants.EDGE_SELECTION_COLOR = '#C0C0C0';
    mxConstants.CONNECT_HANDLE_FILLCOLOR = '#cee7ff';

    mxConstants.DEFAULT_VALID_COLOR = fill;
    mxConstants.GUIDE_COLOR = '#C0C0C0';

    mxConstants.HIGHLIGHT_STROKEWIDTH = 5;
    mxConstants.HIGHLIGHT_OPACITY = 35;
    mxConstants.OUTLINE_COLOR = '#29b6f2';
    mxConstants.OUTLINE_HANDLE_FILLCOLOR = '#29b6f2';
    mxConstants.OUTLINE_HANDLE_STROKECOLOR = '#fff';

    Graph.prototype.svgShadowColor = '#3D4574';
    Graph.prototype.svgShadowOpacity = '0.4';
    Graph.prototype.svgShadowSize = '0.6';
    Graph.prototype.svgShadowBlur = '1.2';

    Format.prototype.inactiveTabBackgroundColor = '#f0f0f0';
    mxGraphHandler.prototype.previewColor = '#C0C0C0';
    mxRubberband.prototype.defaultOpacity = 50;
    HoverIcons.prototype.inactiveOpacity = 25;
    Format.prototype.showCloseButton = false;
    EditorUi.prototype.closableScratchpad = false;
    EditorUi.prototype.toolbarHeight = 46;
    EditorUi.prototype.footerHeight = 0;
    Graph.prototype.editAfterInsert = true;

    /**
     * Sets the XML node for the current diagram.
     */
    Editor.prototype.isChromelessView = function () {
        return false;
    };

    /**
     * Sets the XML node for the current diagram.
     */
    Graph.prototype.isLightboxView = function () {
        return false;
    };

    // Overridden to ignore tabContainer height for diagramContainer
    var editorUiUpdateTabContainer = EditorUi.prototype.updateTabContainer;

    EditorUi.prototype.updateTabContainer = function () {
        if (this.tabContainer != null) {
            // Makes room for view zoom menu
            this.tabContainer.style.right = '70px';
            this.diagramContainer.style.bottom = this.tabContainerHeight + 'px';
        }

        editorUiUpdateTabContainer.apply(this, arguments);
    };

    // Overridden to update save menu state
    /**
     * Updates action states depending on the selection.
     */
    var editorUiUpdateActionStates = EditorUi.prototype.updateActionStates;

    EditorUi.prototype.updateActionStates = function () {
        editorUiUpdateActionStates.apply(this, arguments);

        this.menus.get('save').setEnabled(this.getCurrentFile() != null || urlParams['embed'] == '1');
    };

    // Hides keyboard shortcuts in menus
    var menusAddShortcut = Menus.prototype.addShortcut;

    Menus.prototype.addShortcut = function (item, action) {
        if (action.shortcut != null && iw < 900 && !mxClient.IS_IOS) {
            var td = item.firstChild.nextSibling;
            td.setAttribute('title', action.shortcut);
        } else {
            menusAddShortcut.apply(this, arguments);
        }
    };

    var appUpdateUserElement = App.prototype.updateUserElement;

    App.prototype.updateUserElement = function () {
        appUpdateUserElement.apply(this, arguments);

        if (this.userElement != null) {
            var elt = this.userElement;
            elt.style.cssText = 'position:relative;margin-right:4px;cursor:pointer;display:' + elt.style.display;
            elt.className = 'geToolbarButton';
            elt.innerHTML = '';
            elt.style.backgroundImage = 'url(' + Editor.userImage + ')';
            elt.style.backgroundPosition = 'center center';
            elt.style.backgroundRepeat = 'no-repeat';
            elt.style.backgroundSize = '24px 24px';
            elt.style.height = '24px';
            elt.style.width = '24px';
            elt.style.cssFloat = 'right';
            elt.setAttribute('title', mxResources.get('changeUser'));

            if (elt.style.display != 'none') {
                elt.style.display = 'inline-block';
            }
        }
    };

    var appUpdateButtonContainer = App.prototype.updateButtonContainer;

    App.prototype.updateButtonContainer = function () {
        appUpdateButtonContainer.apply(this, arguments);

        if (this.shareButton != null) {
            var elt = this.shareButton;
            elt.style.cssText = 'display:inline-block;position:relative;box-sizing:border-box;margin-right:4px;cursor:pointer;';
            elt.className = 'geToolbarButton';
            elt.innerHTML = '';
            elt.style.backgroundImage = 'url(' + Editor.shareImage + ')';
            elt.style.backgroundPosition = 'center center';
            elt.style.backgroundRepeat = 'no-repeat';
            elt.style.backgroundSize = '24px 24px';
            elt.style.height = '24px';
            elt.style.width = '24px';
        }
    };

    EditorUi.prototype.addEmbedButtons = function () {
        if (this.buttonContainer != null) {
            var div = document.createElement('div');
            div.style.display = 'inline-block';
            div.style.position = 'relative';
            div.style.marginTop = '8px';
            div.style.marginRight = '4px';

            var button = document.createElement('a');
            button.className = 'geMenuItem gePrimaryBtn';
            button.style.marginLeft = '8px';
            button.style.padding = '6px';

            if (urlParams['noSaveBtn'] == '1') {
                mxUtils.write(button, mxResources.get('saveAndExit'));
                button.setAttribute('title', mxResources.get('saveAndExit'));

                mxEvent.addListener(button, 'click', mxUtils.bind(this, function () {
                    this.actions.get('saveAndExit').funct();
                }));

                div.appendChild(button);
            } else {
                mxUtils.write(button, mxResources.get('save'));
                button.setAttribute('title', mxResources.get('save') + ' (' + Editor.ctrlKey + '+S)');

                mxEvent.addListener(button, 'click', mxUtils.bind(this, function () {
                    this.actions.get('save').funct();
                }));

                div.appendChild(button);

                if (urlParams['saveAndExit'] == '1') {
                    button = document.createElement('a');
                    mxUtils.write(button, mxResources.get('saveAndExit'));
                    button.setAttribute('title', mxResources.get('saveAndExit'));
                    button.className = 'geMenuItem';
                    button.style.marginLeft = '6px';
                    button.style.padding = '6px';

                    mxEvent.addListener(button, 'click', mxUtils.bind(this, function () {
                        this.actions.get('saveAndExit').funct();
                    }));

                    div.appendChild(button);
                }
            }

            button = document.createElement('a');
            mxUtils.write(button, mxResources.get('exit'));
            button.setAttribute('title', mxResources.get('exit'));
            button.className = 'geMenuItem';
            button.style.marginLeft = '6px';
            button.style.padding = '6px';

            mxEvent.addListener(button, 'click', mxUtils.bind(this, function () {
                this.actions.get('exit').funct();
            }));

            div.appendChild(button);
            this.buttonContainer.appendChild(div);
            this.buttonContainer.style.top = '6px';
        }
    };

    // Fixes sidebar tooltips (previews)
    Sidebar.prototype.getTooltipOffset = function () {
        var off = mxUtils.getOffset(this.editorUi.sidebarWindow.window.div);
        off.y += 40;

        return off;
    };

    // Adds context menu items
    var menuCreatePopupMenu = Menus.prototype.createPopupMenu;

    Menus.prototype.createPopupMenu = function (menu, cell, evt) {
        var graph = this.editorUi.editor.graph;
        menu.smartSeparators = true;
        menuCreatePopupMenu.apply(this, arguments);

        var promptSpacing = mxUtils.bind(this, function (defaultValue, fn) {
            var dlg = new FilenameDialog(this.editorUi, defaultValue, mxResources.get('apply'), function (newValue) {
                fn(parseFloat(newValue));
            }, mxResources.get('spacing'));
            this.editorUi.showDialog(dlg.container, 300, 80, true, true);
            dlg.init();
        });

        if (graph.getSelectionCount() == 1) {
            this.addMenuItems(menu, ['editTooltip', '-', 'editStyle', 'editGeometry', '-'], null, evt);

            if (graph.isCellFoldable(graph.getSelectionCell())) {
                this.addMenuItems(menu, (graph.isCellCollapsed(cell)) ? ['expand'] : ['collapse'], null, evt);
            }

            this.addMenuItems(menu, ['collapsible', '-', 'lockUnlock', 'enterGroup'], null, evt);
            menu.addSeparator();
            this.addSubmenu('layout', menu);
        } else if (graph.isSelectionEmpty() && graph.isEnabled()) {
            menu.addSeparator();
            this.addMenuItems(menu, ['editData'], null, evt);
            menu.addSeparator();
            this.addSubmenu('layout', menu);
            this.addSubmenu('view', menu, null, mxResources.get('options'));
            this.addMenuItems(menu, ['-', 'exitGroup'], null, evt);
        } else if (graph.isEnabled()) {
            this.addMenuItems(menu, ['-', 'lockUnlock'], null, evt);
        }
    };

    // Overridden to toggle window instead
    EditorUi.prototype.toggleFormatPanel = function (forceHide) {
        if (this.formatWindow != null) {
            this.formatWindow.window.setVisible((forceHide) ?
                false : !this.formatWindow.window.isVisible());
        } else {
            toggleFormat(this);
        }
    };

    DiagramFormatPanel.prototype.isMathOptionVisible = function () {
        return true;
    };

    // Initializes the user interface
    var editorUiDestroy = EditorUi.prototype.destroy;
    EditorUi.prototype.destroy = function () {
        if (this.sidebarWindow != null) {
            this.sidebarWindow.window.setVisible(false);
            this.sidebarWindow.window.destroy();
            this.sidebarWindow = null;
        }

        if (this.formatWindow != null) {
            this.formatWindow.window.setVisible(false);
            this.formatWindow.window.destroy();
            this.formatWindow = null;
        }

        if (this.actions.outlineWindow != null) {
            this.actions.outlineWindow.window.setVisible(false);
            this.actions.outlineWindow.window.destroy();
            this.actions.outlineWindow = null;
        }

        if (this.actions.layersWindow != null) {
            this.actions.layersWindow.window.setVisible(false);
            this.actions.layersWindow.window.destroy();
            this.actions.layersWindow = null;
        }

        if (this.menus.tagsWindow != null) {
            this.menus.tagsWindow.window.setVisible(false);
            this.menus.tagsWindow.window.destroy();
            this.menus.tagsWindow = null;
        }

        if (this.menus.findWindow != null) {
            this.menus.findWindow.window.setVisible(false);
            this.menus.findWindow.window.destroy();
            this.menus.findWindow = null;
        }

        editorUiDestroy.apply(this, arguments);
    };

    // Hides windows when a file is closed
    var editorUiSetGraphEnabled = EditorUi.prototype.setGraphEnabled;

    EditorUi.prototype.setGraphEnabled = function (enabled) {
        editorUiSetGraphEnabled.apply(this, arguments);

        if (!enabled) {
            if (this.sidebarWindow != null) {
                this.sidebarWindow.window.setVisible(false);
            }

            if (this.formatWindow != null) {
                this.formatWindow.window.setVisible(false);
            }
        }
    };

    // Disables centering of graph after iframe resize
    EditorUi.prototype.chromelessWindowResize = function () {
    };

    // Adds actions and menus
    var menusInit = Menus.prototype.init;
    Menus.prototype.init = function () {
        menusInit.apply(this, arguments);

        var ui = this.editorUi;
        var graph = ui.editor.graph;

        ui.actions.get('createShape').label = mxResources.get('shape') + '...';
        ui.actions.get('outline').label = mxResources.get('outline') + '...';
        ui.actions.get('layers').label = mxResources.get('layers') + '...';

        ui.actions.put('importCsv', new Action(mxResources.get('csv') + '...', function () {
            graph.popupMenuHandler.hideMenu();
            ui.showImportCsvDialog();
        }));
        ui.actions.put('importText', new Action(mxResources.get('text') + '...', function () {
            var dlg = new ParseDialog(ui, 'Insert from Text');
            ui.showDialog(dlg.container, 620, 420, true, false);
            dlg.init();
        }));
        ui.actions.put('formatSql', new Action(mxResources.get('formatSql') + '...', function () {
            var dlg = new ParseDialog(ui, 'Insert from Text', 'formatSql');
            ui.showDialog(dlg.container, 620, 420, true, false);
            dlg.init();
        }));

        ui.actions.put('toggleShapes', new Action(mxResources.get('shapes') + '...', function () {
            toggleShapes(ui);
        }));
        ui.actions.put('toggleFormat', new Action(mxResources.get('format') + '...', function () {
            toggleFormat(ui);
        }));

        if (EditorUi.enablePlantUml && !ui.isOffline()) {
            ui.actions.put('plantUml', new Action(mxResources.get('plantUml') + '...', function () {
                var dlg = new ParseDialog(ui, 'Insert from Text', 'plantUml');
                ui.showDialog(dlg.container, 620, 420, true, false);
                dlg.init();
            }));
        }

        this.put('diagram', new Menu(mxUtils.bind(this, function (menu, parent) {
            var file = ui.getCurrentFile();
            ui.menus.addSubmenu('extras', menu, parent, mxResources.get('preferences'));
            menu.addSeparator(parent);

            if (mxClient.IS_CHROMEAPP || EditorUi.isElectronApp) {
                ui.menus.addMenuItems(menu, ['new', 'open', '-'], parent);

                if (EditorUi.isElectronApp) {
                    ui.menus.addMenuItems(menu, ['synchronize', '-'], parent);
                }

                ui.menus.addMenuItems(menu, ['save', 'saveAs', '-'], parent);
            } else if (urlParams['embed'] == '1') {
                ui.menus.addMenuItems(menu, ['-', 'save'], parent);

                if (urlParams['saveAndExit'] == '1') {
                    ui.menus.addMenuItems(menu, ['saveAndExit'], parent);
                }

                menu.addSeparator(parent);
            } else {
                ui.menus.addMenuItems(menu, ['new'], parent);
                ui.menus.addSubmenu('openFrom', menu, parent);

                if (isLocalStorage) {
                    this.addSubmenu('openRecent', menu, parent);
                }

                menu.addSeparator(parent);

                if (file != null && file.constructor == DriveFile) {
                    ui.menus.addMenuItems(menu, ['share'], parent);
                }

                if (!mxClient.IS_CHROMEAPP && !EditorUi.isElectronApp &&
                    file != null && file.constructor != LocalFile) {
                    ui.menus.addMenuItems(menu, ['synchronize'], parent);
                }

                menu.addSeparator(parent);
                ui.menus.addSubmenu('save', menu, parent);
            }

            ui.menus.addMenuItems(menu, ['-', 'outline', 'layers'], parent);

            if (ui.commentsSupported()) {
                ui.menus.addMenuItems(menu, ['comments'], parent);
            }

            ui.menus.addMenuItems(menu, ['-', 'find'], parent);

            ui.menus.addSubmenu('help', menu, parent);

            if (urlParams['embed'] == '1') {
                ui.menus.addMenuItems(menu, ['-', 'exit'], parent);
            } else {
                ui.menus.addMenuItems(menu, ['-', 'close']);
            }
        })));

        this.put('save', new Menu(mxUtils.bind(this, function (menu, parent) {
            var file = ui.getCurrentFile();

            if (file != null && file.constructor == DriveFile) {
                ui.menus.addMenuItems(menu, ['save', 'makeCopy', '-', 'rename', 'moveToFolder'], parent);
            } else {
                ui.menus.addMenuItems(menu, ['save', 'saveAs', '-', 'rename'], parent);

                if (ui.isOfflineApp()) {
                    if (navigator.onLine && urlParams['stealth'] != '1') {
                        this.addMenuItems(menu, ['upload'], parent);
                    }
                } else {
                    ui.menus.addMenuItems(menu, ['makeCopy'], parent);
                }
            }

            ui.menus.addMenuItems(menu, ['-', 'autosave'], parent);

            if (file != null && file.isRevisionHistorySupported()) {
                ui.menus.addMenuItems(menu, ['-', 'revisionHistory'], parent);
            }
        })));

        // Augments the existing export menu
        var exportAsMenu = this.get('exportAs');

        this.put('exportAs', new Menu(mxUtils.bind(this, function (menu, parent) {
            exportAsMenu.funct(menu, parent);

            if (!mxClient.IS_CHROMEAPP && !EditorUi.isElectronApp) {
                // Publish menu contains only one element by default...
                //ui.menus.addSubmenu('publish', menu, parent);
                ui.menus.addMenuItems(menu, ['publishLink'], parent);
            }

            menu.addSeparator(parent);
            ui.menus.addSubmenu('embed', menu, parent);
        })));

        var langMenu = this.get('language');

        // Extras menu is labelled preferences but keeps ID for extensions
        this.put('extras', new Menu(mxUtils.bind(this, function (menu, parent) {
            if (langMenu != null) {
                ui.menus.addSubmenu('language', menu, parent);
            }

            ui.menus.addSubmenu('units', menu, parent);
            menu.addSeparator(parent);
            ui.menus.addMenuItems(menu, ['scrollbars', 'tooltips', 'ruler'], parent);

            // Adds trailing separator in case new plugin entries are added
            menu.addSeparator(parent);
        })));

        this.put('insertAdvanced', new Menu(mxUtils.bind(this, function (menu, parent) {
            ui.menus.addMenuItems(menu, ['importText', 'plantUml', '-', 'formatSql', 'importCsv', '-', 'createShape'], parent);
        })));

        this.put('insert', new Menu(mxUtils.bind(this, function (menu, parent) {
            ui.menus.addMenuItems(menu, ['insertRectangle', 'insertEllipse', 'insertRhombus', '-',
                'insertText', 'insertLink', '-', 'insertImage'], parent);

            if (ui.insertTemplateEnabled && !ui.isOffline()) {
                ui.menus.addMenuItems(menu, ['insertTemplate'], parent);
            }

            menu.addSeparator(parent);
            this.addMenuItems(menu, ['createShape', 'insertFreehand', '-'], parent);
            this.addSubmenu('insertLayout', menu, parent, mxResources.get('layout'));
            this.addSubmenu('insertAdvanced', menu, parent, mxResources.get('advanced'));
            menu.addSeparator(parent);

            if (mxClient.IS_CHROMEAPP || EditorUi.isElectronApp) {
                ui.menus.addMenuItems(menu, ['import'], parent);
            } else {
                ui.menus.addSubmenu('importFrom', menu, parent);
            }
        })));

        var methods = ['horizontalFlow', 'verticalFlow', '-', 'horizontalTree', 'verticalTree',
            'radialTree', '-', 'organic', 'circle'];

        var addInsertItem = function (menu, parent, title, method) {
            menu.addItem(title, null, mxUtils.bind(this, function () {
                var dlg = new CreateGraphDialog(ui, title, method);
                ui.showDialog(dlg.container, 620, 420, true, false);
                // Executed after dialog is added to dom
                dlg.init();
            }), parent);
        };

        this.put('insertLayout', new Menu(mxUtils.bind(this, function (menu, parent) {
            for (var i = 0; i < methods.length; i++) {
                if (methods[i] == '-') {
                    menu.addSeparator(parent);
                } else {
                    addInsertItem(menu, parent, mxResources.get(methods[i]) + '...', methods[i]);
                }
            }
        })));

        // Overrides view for plugins but label it options
        this.put('view', new Menu(mxUtils.bind(this, function (menu, parent) {
            ui.menus.addMenuItems(menu, ['grid', 'guides', '-', 'connectionArrows', 'connectionPoints', '-'], parent);

            ui.menus.addMenuItems(menu, ['copyConnect', 'collapseExpand', '-', 'pageScale'], parent);
        })));
    };

    // Initializes the user interface
    var editorUiInit = EditorUi.prototype.init;

    EditorUi.prototype.init = function () {
        editorUiInit.apply(this, arguments);

        var div = document.createElement('div');
        div.style.cssText = 'position:absolute;left:0px;right:0px;top:0px;overflow-y:auto;overflow-x:hidden;';
        div.style.bottom = (urlParams['embed'] != '1' || urlParams['libraries'] == '1') ? '63px' : '32px';
        this.sidebar = this.createSidebar(div);

        if (urlParams['clibs'] != null || urlParams['libs'] != null) {
            toggleShapes(this);
        }

        // Needed for creating elements in Format panel
        var ui = this;
        var graph = ui.editor.graph;
        ui.toolbar = this.createToolbar(ui.createDiv('geToolbar'));
        ui.defaultLibraryName = mxResources.get('untitledLibrary');

        var menubar = document.createElement('div');
        menubar.style.cssText = 'position:absolute;left:0px;right:0px;top:0px;height:30px;padding:8px;border-bottom:1px solid lightgray;background-color:#ffffff;text-align:left;white-space:nowrap;';

        var before = null;
        var menuObj = new Menubar(ui, menubar);

        function addMenu(id, small, img) {
            var menu = ui.menus.get(id);

            var elt = menuObj.addMenu(mxResources.get(id), mxUtils.bind(this, function () {
                // Allows extensions of menu.functid
                menu.funct.apply(this, arguments);
            }), before);

            elt.className = 'geMenuItem';
            elt.style.display = 'inline-block';
            elt.style.boxSizing = 'border-box';
            elt.style.top = '6px';
            elt.style.marginRight = '6px';
            elt.style.height = '30px';
            elt.style.paddingTop = '6px';
            elt.style.paddingBottom = '6px';
            elt.style.cursor = 'pointer';
            elt.setAttribute('title', mxResources.get(id));
            ui.menus.menuCreated(menu, elt, 'geMenuItem');

            if (img != null) {
                elt.style.backgroundImage = 'url(' + img + ')';
                elt.style.backgroundPosition = 'center center';
                elt.style.backgroundRepeat = 'no-repeat';
                elt.style.backgroundSize = '24px 24px';
                elt.style.width = '34px';
                elt.innerHTML = '';
            } else if (!small) {
                elt.style.backgroundImage = 'url(' + mxWindow.prototype.normalizeImage + ')';
                elt.style.backgroundPosition = 'right 6px center';
                elt.style.backgroundRepeat = 'no-repeat';
                elt.style.paddingRight = '22px';
            }

            return elt;
        };

        function addMenuItem(label, fn, small, tooltip, action, img) {
            var btn = document.createElement('a');
            btn.className = 'geMenuItem';
            btn.style.display = 'inline-block';
            btn.style.boxSizing = 'border-box';
            btn.style.height = '30px';
            btn.style.padding = '6px';
            btn.style.position = 'relative';
            btn.style.verticalAlign = 'top';
            btn.style.top = '0px';

            if (ui.statusContainer != null) {
                menubar.insertBefore(btn, ui.statusContainer);
            } else {
                menubar.appendChild(btn);
            }

            if (img != null) {
                btn.style.backgroundImage = 'url(' + img + ')';
                btn.style.backgroundPosition = 'center center';
                btn.style.backgroundRepeat = 'no-repeat';
                btn.style.backgroundSize = '24px 24px';
                btn.style.width = '34px';
            } else {
                mxUtils.write(btn, label);
            }

            // Prevents focus
            mxEvent.addListener(btn, (mxClient.IS_POINTER) ? 'pointerdown' : 'mousedown',
                mxUtils.bind(this, function (evt) {
                    evt.preventDefault();
                }));

            mxEvent.addListener(btn, 'click', function (evt) {
                if (btn.getAttribute('disabled') != 'disabled') {
                    fn(evt);
                }

                mxEvent.consume(evt);
            });

            if (small == null) {
                btn.style.marginRight = '4px';
            }

            if (tooltip != null) {
                btn.setAttribute('title', tooltip);
            }

            if (action != null) {
                function updateState() {
                    if (action.isEnabled()) {
                        btn.removeAttribute('disabled');
                        btn.style.cursor = 'pointer';
                    } else {
                        btn.setAttribute('disabled', 'disabled');
                        btn.style.cursor = 'default';
                    }
                };

                action.addListener('stateChanged', updateState);
                updateState();
            }

            return btn;
        };

        function createGroup(btns, op) {
            var btnGroup = document.createElement('div');
            btnGroup.className = 'geMenuItem';
            btnGroup.style.display = 'inline-block';
            btnGroup.style.verticalAlign = 'top';
            btnGroup.style.marginRight = '6px';
            btnGroup.style.padding = '0 4px 0 4px';
            btnGroup.style.height = '30px';
            btnGroup.style.position = 'relative';
            btnGroup.style.top = '0px';

            for (var i = 0; i < btns.length; i++) {
                if (btns[i] != null) {
                    btns[i].style.margin = '0px';
                    btns[i].style.boxShadow = 'none';
                    btnGroup.appendChild(btns[i]);
                }
            }

            if (op != null) {
                mxUtils.setOpacity(btnGroup, op);
            }

            if (ui.statusContainer != null) {
                menubar.insertBefore(btnGroup, ui.statusContainer);
            } else {
                menubar.appendChild(btnGroup);
            }

            return btnGroup;
        };

        ui.statusContainer = ui.createStatusContainer();
        ui.statusContainer.style.position = 'relative';
        ui.statusContainer.style.maxWidth = '';
        ui.statusContainer.style.marginTop = '7px';
        ui.statusContainer.style.marginLeft = '6px';
        ui.statusContainer.style.color = 'gray';
        ui.statusContainer.style.cursor = 'default';

        function updateTitle() {
            var file = ui.getCurrentFile();

            if (file != null && file.getTitle() != null) {
                var mode = file.getMode();

                if (mode == 'google') {
                    mode = 'googleDrive';
                } else if (mode == 'github') {
                    mode = 'gitHub';
                } else if (mode == 'gitlab') {
                    mode = 'gitLab';
                } else if (mode == 'onedrive') {
                    mode = 'oneDrive';
                }

                mode = mxResources.get(mode);
                menubar.setAttribute('title', file.getTitle() + ((mode != null) ? ' (' + mode + ')' : ''));
            } else {
                menubar.removeAttribute('title');
            }
        };

        // Connects the status bar to the editor status
        ui.editor.addListener('statusChanged', mxUtils.bind(this, function () {
            ui.setStatusText(ui.editor.getStatus());
        }));

        // Connects the status bar to the editor status
        var uiDescriptorChanged = ui.descriptorChanged;

        ui.descriptorChanged = function () {
            uiDescriptorChanged.apply(this, arguments);
            updateTitle();
        };

        ui.setStatusText(ui.editor.getStatus());
        menubar.appendChild(ui.statusContainer);

        ui.buttonContainer = document.createElement('div');
        ui.buttonContainer.style.cssText = 'position:absolute;right:0px;padding-right:34px;top:10px;' +
            'white-space:nowrap;padding-top:2px;background-color:inherit;';
        menubar.appendChild(ui.buttonContainer);

        // Container for the user element
        ui.menubarContainer = ui.buttonContainer;

        ui.tabContainer = document.createElement('div');
        ui.tabContainer.style.cssText = 'position:absolute;left:0px;right:0px;bottom:0px;height:30px;white-space:nowrap;' +
            'border-bottom:1px solid lightgray;background-color:#ffffff;border-top:1px solid lightgray;margin-bottom:-2px;' +
            'visibility:hidden;';

        var previousParent = ui.diagramContainer.parentNode;

        var wrapper = document.createElement('div');
        wrapper.style.cssText = 'position:absolute;top:0px;left:0px;right:0px;bottom:0px;overflow:hidden;';
        ui.diagramContainer.style.top = '47px';

        var viewZoomMenu = ui.menus.get('viewZoom');
        var viewZoomMenuElt = null;

        if (viewZoomMenu != null) {
            this.tabContainer.style.right = '70px';
            var elt = menuObj.addMenu('100%', viewZoomMenu.funct);
            elt.setAttribute('title', mxResources.get('zoom') + ' (Alt+Mousewheel)');
            elt.style.whiteSpace = 'nowrap';
            elt.style.backgroundImage = 'url(' + mxWindow.prototype.minimizeImage + ')';
            elt.style.backgroundPosition = 'right 6px center';
            elt.style.backgroundRepeat = 'no-repeat';
            elt.style.backgroundColor = '#ffffff';
            elt.style.paddingRight = '10px';
            elt.style.display = 'block';
            elt.style.position = 'absolute';
            elt.style.textDecoration = 'none';
            elt.style.textDecoration = 'none';
            elt.style.right = '0px';
            elt.style.bottom = '0px';
            elt.style.overflow = 'hidden';
            elt.style.visibility = 'hidden';
            elt.style.textAlign = 'center';
            elt.style.color = '#000';
            elt.style.fontSize = '12px';
            elt.style.color = '#707070';
            elt.style.width = '59px';
            elt.style.cursor = 'pointer';
            elt.style.borderTop = '1px solid lightgray';
            elt.style.borderLeft = '1px solid lightgray';
            elt.style.height = (parseInt(ui.tabContainerHeight) - 1) + 'px';
            elt.style.lineHeight = (parseInt(ui.tabContainerHeight) + 1) + 'px';
            wrapper.appendChild(elt);

            // Updates the label if the scale changes
            var updateZoom = mxUtils.bind(this, function () {
                elt.innerHTML = Math.round(ui.editor.graph.view.scale * 100) + '%';
            });

            ui.editor.graph.view.addListener(mxEvent.EVENT_SCALE, updateZoom);
            ui.editor.addListener('resetGraphView', updateZoom);
            ui.editor.addListener('pageSelected', updateZoom);

            // Augments setGraphEnabled to update visible state
            var uiSetGraphEnabled = ui.setGraphEnabled;

            ui.setGraphEnabled = function () {
                uiSetGraphEnabled.apply(this, arguments);

                if (this.tabContainer != null) {
                    elt.style.visibility = this.tabContainer.style.visibility;
                    this.diagramContainer.style.bottom = (this.tabContainer.style.visibility != 'hidden') ?
                        this.tabContainerHeight + 'px' : '0px';
                }
            };
        }

        wrapper.appendChild(ui.tabContainer);
        wrapper.appendChild(menubar);
        wrapper.appendChild(ui.diagramContainer);
        previousParent.appendChild(wrapper);
        ui.updateTabContainer();

        var langMenuElt = null;

        function refreshMenu() {
            // Removes all existing menu items
            var node = menubar.firstChild;

            while (node != null) {
                var temp = node.nextSibling;

                if (node.className == 'geMenuItem' || node.className == 'geItem') {
                    node.parentNode.removeChild(node);
                }

                node = temp;
            }

            before = menubar.firstChild;
            iw = window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth;
            var small = iw < 1000;

            if (!small) {
                addMenu('diagram');
            }

            createGroup([((small) ? addMenu('diagram', null, IMAGE_PATH + '/drawlogo.svg') : null),
                    addMenuItem(mxResources.get('shapes'), ui.actions.get('toggleShapes').funct, null, mxResources.get('shapes'), ui.actions.get('image'),
                        (small) ? 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0Ij48cGF0aCBkPSJNMTMgMTN2OGg4di04aC04ek0zIDIxaDh2LThIM3Y4ek0zIDN2OGg4VjNIM3ptMTMuNjYtMS4zMUwxMSA3LjM0IDE2LjY2IDEzbDUuNjYtNS42Ni01LjY2LTUuNjV6Ii8+PC9zdmc+' : null),
                    addMenuItem(mxResources.get('format'), ui.actions.get('toggleFormat').funct, null,
                        mxResources.get('format') + ' (' + ui.actions.get('formatPanel').shortcut + ')', ui.actions.get('image'),
                        (small) ? 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0Ij48cGF0aCBkPSJNMTIgM2MtNC45NyAwLTkgNC4wMy05IDlzNC4wMyA5IDkgOWMuODMgMCAxLjUtLjY3IDEuNS0xLjUgMC0uMzktLjE1LS43NC0uMzktMS4wMS0uMjMtLjI2LS4zOC0uNjEtLjM4LS45OSAwLS44My42Ny0xLjUgMS41LTEuNUgxNmMyLjc2IDAgNS0yLjI0IDUtNSAwLTQuNDItNC4wMy04LTktOHptLTUuNSA5Yy0uODMgMC0xLjUtLjY3LTEuNS0xLjVTNS42NyA5IDYuNSA5IDggOS42NyA4IDEwLjUgNy4zMyAxMiA2LjUgMTJ6bTMtNEM4LjY3IDggOCA3LjMzIDggNi41UzguNjcgNSA5LjUgNXMxLjUuNjcgMS41IDEuNVMxMC4zMyA4IDkuNSA4em01IDBjLS44MyAwLTEuNS0uNjctMS41LTEuNVMxMy42NyA1IDE0LjUgNXMxLjUuNjcgMS41IDEuNVMxNS4zMyA4IDE0LjUgOHptMyA0Yy0uODMgMC0xLjUtLjY3LTEuNS0xLjVTMTYuNjcgOSAxNy41IDlzMS41LjY3IDEuNSAxLjUtLjY3IDEuNS0xLjUgMS41eiIvPjwvc3ZnPg==' : null)],
                (small) ? 60 : null);
            var elt = addMenu('insert', true, (small) ? 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0Ij48cGF0aCBkPSJNMTkgMTNoLTZ2NmgtMnYtNkg1di0yaDZWNWgydjZoNnYyeiIvPjwvc3ZnPg==' : null);
            createGroup([elt, addMenuItem(mxResources.get('delete'), ui.actions.get('delete').funct, null, mxResources.get('delete'), ui.actions.get('delete'),
                (small) ? 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0Ij48cGF0aCBkPSJNNiAxOWMwIDEuMS45IDIgMiAyaDhjMS4xIDAgMi0uOSAyLTJWN0g2djEyek0xOSA0aC0zLjVsLTEtMWgtNWwtMSAxSDV2MmgxNFY0eiIvPjwvc3ZnPg==' : null)],
                (small) ? 60 : null);

            var undoAction = ui.actions.get('undo');
            var redoAction = ui.actions.get('redo');
            var undoElt = addMenuItem('', undoAction.funct, null, mxResources.get('undo') + ' (' + undoAction.shortcut + ')', undoAction,
                'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0Ij48cGF0aCBkPSJNMTIuNSA4Yy0yLjY1IDAtNS4wNS45OS02LjkgMi42TDIgN3Y5aDlsLTMuNjItMy42MmMxLjM5LTEuMTYgMy4xNi0xLjg4IDUuMTItMS44OCAzLjU0IDAgNi41NSAyLjMxIDcuNiA1LjVsMi4zNy0uNzhDMjEuMDggMTEuMDMgMTcuMTUgOCAxMi41IDh6Ii8+PC9zdmc+');
            var redoElt = addMenuItem('', redoAction.funct, null, mxResources.get('redo') + ' (' + redoAction.shortcut + ')', redoAction,
                'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0Ij48cGF0aCBkPSJNMTguNCAxMC42QzE2LjU1IDguOTkgMTQuMTUgOCAxMS41IDhjLTQuNjUgMC04LjU4IDMuMDMtOS45NiA3LjIyTDMuOSAxNmMxLjA1LTMuMTkgNC4wNS01LjUgNy42LTUuNSAxLjk1IDAgMy43My43MiA1LjEyIDEuODhMMTMgMTZoOVY3bC0zLjYgMy42eiIvPjwvc3ZnPg==');
            createGroup([undoElt, redoElt], 60);

            var zoomInAction = ui.actions.get('zoomIn');
            var zoomOutAction = ui.actions.get('zoomOut');
            var resetViewAction = ui.actions.get('resetView');

            createGroup([addMenuItem('', function () {
                    graph.popupMenuHandler.hideMenu();
                    var scale = graph.view.scale;
                    var tx = graph.view.translate.x;
                    var ty = graph.view.translate.y;
                    ui.actions.get('resetView').funct();
                    // Toggle scale if nothing has changed
                    if (Math.abs(scale - graph.view.scale) < 0.00001 && tx == graph.view.translate.x && ty == graph.view.translate.y) {
                        ui.actions.get((graph.pageVisible) ? 'fitPage' : 'fitWindow').funct();
                    }
                }, true, mxResources.get('fit') + ' (' + Editor.ctrlKey + '+H)', resetViewAction,
                'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0Ij48cGF0aCBkPSJNMyA1djRoMlY1aDRWM0g1Yy0xLjEgMC0yIC45LTIgMnptMiAxMEgzdjRjMCAxLjEuOSAyIDIgMmg0di0ySDV2LTR6bTE0IDRoLTR2Mmg0YzEuMSAwIDItLjkgMi0ydi00aC0ydjR6bTAtMTZoLTR2Mmg0djRoMlY1YzAtMS4xLS45LTItMi0yeiIvPjwvc3ZnPg=='),
                (iw >= 640) ? addMenuItem('', zoomInAction.funct, true, mxResources.get('zoomIn') + ' (' + Editor.ctrlKey + ' +)', zoomInAction,
                    'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0Ij48cGF0aCBkPSJNMTUuNSAxNGgtLjc5bC0uMjgtLjI3QzE1LjQxIDEyLjU5IDE2IDExLjExIDE2IDkuNSAxNiA1LjkxIDEzLjA5IDMgOS41IDNTMyA1LjkxIDMgOS41IDUuOTEgMTYgOS41IDE2YzEuNjEgMCAzLjA5LS41OSA0LjIzLTEuNTdsLjI3LjI4di43OWw1IDQuOTlMMjAuNDkgMTlsLTQuOTktNXptLTYgMEM3LjAxIDE0IDUgMTEuOTkgNSA5LjVTNy4wMSA1IDkuNSA1IDE0IDcuMDEgMTQgOS41IDExLjk5IDE0IDkuNSAxNHptMi41LTRoLTJ2Mkg5di0ySDdWOWgyVjdoMXYyaDJ2MXoiLz48L3N2Zz4=') : null,
                (iw >= 640) ? addMenuItem('', zoomOutAction.funct, true, mxResources.get('zoomOut') + ' (' + Editor.ctrlKey + ' -)', zoomOutAction,
                    'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0Ij48cGF0aCBkPSJNMTUuNSAxNGgtLjc5bC0uMjgtLjI3QzE1LjQxIDEyLjU5IDE2IDExLjExIDE2IDkuNSAxNiA1LjkxIDEzLjA5IDMgOS41IDNTMyA1LjkxIDMgOS41IDUuOTEgMTYgOS41IDE2YzEuNjEgMCAzLjA5LS41OSA0LjIzLTEuNTdsLjI3LjI4di43OWw1IDQuOTlMMjAuNDkgMTlsLTQuOTktNXptLTYgMEM3LjAxIDE0IDUgMTEuOTkgNSA5LjVTNy4wMSA1IDkuNSA1IDE0IDcuMDEgMTQgOS41IDExLjk5IDE0IDkuNSAxNHpNNyA5aDV2MUg3eiIvPjwvc3ZnPg==') : null], 60);
        };
        refreshMenu();

        mxEvent.addListener(window, 'resize', function () {
            refreshMenu();

            if (ui.sidebarWindow != null) {
                ui.sidebarWindow.window.fit();
            }

            if (ui.formatWindow != null) {
                ui.formatWindow.window.fit();
            }

            if (ui.actions.outlineWindow != null) {
                ui.actions.outlineWindow.window.fit();
            }

            if (ui.actions.layersWindow != null) {
                ui.actions.layersWindow.window.fit();
            }

            if (ui.menus.tagsWindow != null) {
                ui.menus.tagsWindow.window.fit();
            }

            if (ui.menus.findWindow != null) {
                ui.menus.findWindow.window.fit();
            }
        });
    };
};

(function () {
    var initialized = false;

    // ChromeApp has async local storage
    if (uiTheme == 'min' && !initialized && !mxClient.IS_CHROMEAPP) {
        EditorUi.initMinimalTheme();
        initialized = true;
    }

    var uiInitTheme = EditorUi.initTheme;

    // For async startup like chromeos
    EditorUi.initTheme = function () {
        uiInitTheme.apply(this, arguments);

        if (uiTheme == 'min' && !initialized) {
            this.initMinimalTheme();
            initialized = true;
        }
    };
})();

/**
 * Copyright (c) 2017, CTI LOGIC
 * Copyright (c) 2006-2017, JGraph Ltd
 * Copyright (c) 2006-2017, Gaudenz Alder
 *
 * Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:
 *
 * 1. Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer.
 *
 * 2. Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer in the documentation and/or other materials provided with the distribution.
 *
 * 3. Neither the name of the copyright holder nor the names of its contributors may be used to endorse or promote products derived from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY
 * AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
 * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,
 * WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

//TODO integrate this code in mxGuide (Especially as this is now affecting the other guides)
(function () {
    var guideMove = mxGuide.prototype.move;

    mxGuide.prototype.move = function (bounds, delta, gridEnabled, clone) {
        var yShift = delta.y;
        var xShift = delta.x;
        var hasHorGuides = false;
        var hasVerGuides = false;

        if (this.states != null && bounds != null && delta != null) {
            var guide = this;
            var newState = new mxCellState();
            var scale = this.graph.getView().scale;
            var tolerance = Math.max(2, this.getGuideTolerance() / 2);

            newState.x = bounds.x + xShift;
            newState.y = bounds.y + yShift;
            newState.width = bounds.width;
            newState.height = bounds.height;
            var verticalCells = [];
            var horizontalCells = [];

            //although states are defined as cellState, it has some mxRectangles!
            var states = [];

            for (var i = 0; i < this.states.length; i++) {
                var state = this.states[i];
                var found = false;

                if (state instanceof mxCellState) {
                    if (clone || !this.graph.isCellSelected(state.cell)) {
                        if (((newState.x >= state.x && newState.x <= (state.x + state.width))
                            || (state.x >= newState.x && state.x <= (newState.x + newState.width)))
                            && (newState.y > state.y + state.height + 4 || newState.y + newState.height + 4 < state.y)) // + 4 to avoid having dy = 0 considered which cause a bug with 3 cells case
                        {
                            verticalCells.push(state);
                        } else if (((newState.y >= state.y && newState.y <= (state.y + state.height))
                            || (state.y >= newState.y && state.y <= (newState.y + newState.height)))
                            && (newState.x > state.x + state.width + 4 || newState.x + newState.width + 4 < state.x)) // + 4 to avoid having dy = 0 considered which cause a bug with 3 cells case
                        {
                            horizontalCells.push(state);
                        }
                    }
                }
            }

            var eqCy = 0;
            var dy = 0;
            var fixedDy = 0;
            var midDy = 0;
            var eqCx = 0;
            var dx = 0;
            var fixedDx = 0;
            var midDx = 0;
            var shift = 5 * scale;

            if (verticalCells.length > 1) {
                verticalCells.push(newState);

                verticalCells.sort(function (s1, s2) {
                    return s1.y - s2.y;
                });

                var newStatePassed = false;
                var firstMoving = newState == verticalCells[0];
                var lastMoving = newState == verticalCells[verticalCells.length - 1];

                //find the mid space and use it as dy and fixedDy
                if (!firstMoving && !lastMoving) {
                    for (var i = 1; i < verticalCells.length - 1; i++) {
                        if (newState == verticalCells[i]) {
                            var s1 = verticalCells[i - 1];
                            var s3 = verticalCells[i + 1];
                            midDy = (s3.y - s1.y - s1.height - newState.height) / 2;
                            dy = midDy;
                            fixedDy = dy;
                            break;
                        }
                    }
                }

                for (var i = 0; i < verticalCells.length - 1; i++) {
                    var s1 = verticalCells[i];
                    var s2 = verticalCells[i + 1];
                    var isMovingOne = newState == s1 || newState == s2;
                    var curDy = s2.y - s1.y - s1.height;

                    newStatePassed |= newState == s1;

                    if (dy == 0 && eqCy == 0) {
                        dy = curDy;
                        eqCy = 1;
                    } else if (Math.abs(dy - curDy) <= (isMovingOne || (i == 1 && newStatePassed) ? tolerance : 0)) //non-moving cells must have exact same dy, must handle the case of having the first cell moving so we allow tolerance for second cell (until fixedDy is non-zero)
                    {
                        eqCy += 1;
                    } else if (eqCy > 1 && newStatePassed) //stop and ignore the following cells
                    {
                        verticalCells = verticalCells.slice(0, i + 1);
                        break;
                    } else if (verticalCells.length - i >= 3 && !newStatePassed) //reset and start counting again
                    {
                        eqCy = 0;
                        dy = midDy != 0 ? midDy : 0;
                        fixedDy = dy;
                        verticalCells.splice(0, i == 0 ? 1 : i);
                        i = -1;
                    } else {
                        break;
                    }

                    if (fixedDy == 0 && !isMovingOne) {
                        fixedDy = curDy;
                        //Update dy such that following cells shows equal distance guides without tolerance
                        dy = fixedDy;
                    }
                }

                if (verticalCells.length == 3 && verticalCells[1] == newState) {
                    fixedDy = 0;
                }
            }

            if (horizontalCells.length > 1) {
                horizontalCells.push(newState)

                horizontalCells.sort(function (s1, s2) {
                    return s1.x - s2.x;
                });

                var newStatePassed = false;
                var firstMoving = newState == horizontalCells[0];
                var lastMoving = newState == horizontalCells[horizontalCells.length - 1];

                //find the mid space and use it as dx and fixedDx
                if (!firstMoving && !lastMoving) {
                    for (var i = 1; i < horizontalCells.length - 1; i++) {
                        if (newState == horizontalCells[i]) {
                            var s1 = horizontalCells[i - 1];
                            var s3 = horizontalCells[i + 1];
                            midDx = (s3.x - s1.x - s1.width - newState.width) / 2;
                            dx = midDx;
                            fixedDx = dx;
                            break;
                        }
                    }
                }

                for (var i = 0; i < horizontalCells.length - 1; i++) {
                    var s1 = horizontalCells[i];
                    var s2 = horizontalCells[i + 1];
                    var isMovingOne = newState == s1 || newState == s2;
                    var curDx = s2.x - s1.x - s1.width;

                    newStatePassed |= newState == s1;

                    if (dx == 0 && eqCx == 0) {
                        dx = curDx;
                        eqCx = 1;
                    } else if (Math.abs(dx - curDx) <= (isMovingOne || (i == 1 && newStatePassed) ? tolerance : 0)) {
                        eqCx += 1;
                    } else if (eqCx > 1 && newStatePassed) //stop and ignore the following cells
                    {
                        horizontalCells = horizontalCells.slice(0, i + 1);
                        break;
                    } else if (horizontalCells.length - i >= 3 && !newStatePassed) //reset and start counting again
                    {
                        eqCx = 0;
                        dx = midDx != 0 ? midDx : 0;
                        fixedDx = dx;
                        horizontalCells.splice(0, i == 0 ? 1 : i);
                        i = -1;
                    } else {
                        break;
                    }

                    if (fixedDx == 0 && !isMovingOne) {
                        fixedDx = curDx;
                        //Update dx such that following cells shows equal distance guides without tolerance
                        dx = fixedDx;
                    }
                }
                if (horizontalCells.length == 3 && horizontalCells[1] == newState) {
                    fixedDx = 0;
                }
            }

            var createEqGuide = function (p1, p2, curGuide, isVer) {
                var points = [];
                var dx = 0
                var dy = 0;

                if (isVer) {
                    dx = shift;
                    dy = 0;
                } else {
                    dx = 0;
                    dy = shift;
                }

                points.push(new mxPoint(p1.x - dx, p1.y - dy));
                points.push(new mxPoint(p1.x + dx, p1.y + dy));
                points.push(p1);
                points.push(p2);
                points.push(new mxPoint(p2.x - dx, p2.y - dy));
                points.push(new mxPoint(p2.x + dx, p2.y + dy));

                if (curGuide != null) {
                    curGuide.points = points;
                    return curGuide;
                } else {
                    var guideEq = new mxPolyline(points, mxConstants.GUIDE_COLOR, mxConstants.GUIDE_STROKEWIDTH);
                    guideEq.dialect = mxConstants.DIALECT_SVG;
                    guideEq.pointerEvents = false;
                    guideEq.init(guide.graph.getView().getOverlayPane());
                    return guideEq;
                }
            };

            var hideEqGuides = function (horizontal, vertical) {
                if (horizontal && guide.guidesArrHor != null) {
                    for (var i = 0; i < guide.guidesArrHor.length; i++) {
                        guide.guidesArrHor[i].node.style.visibility = "hidden";
                    }
                }

                if (vertical && guide.guidesArrVer != null) {
                    for (var i = 0; i < guide.guidesArrVer.length; i++) {
                        guide.guidesArrVer[i].node.style.visibility = "hidden";
                    }
                }
            };

            if (eqCx > 1 && eqCx == horizontalCells.length - 1) {
                var guidesArr = [];
                var curArr = guide.guidesArrHor;
                var hPoints = [];
                var newX = 0;

                //If the newState (moving cell) is the first one, use the next one for x coordinate such that the guide doesn't move with the cell
                var firstI = horizontalCells[0] == newState ? 1 : 0;
                var firstY = horizontalCells[firstI].y + horizontalCells[firstI].height;

                if (fixedDx > 0) {
                    for (var i = 0; i < horizontalCells.length - 1; i++) {
                        var s1 = horizontalCells[i];
                        var s2 = horizontalCells[i + 1];

                        if (newState == s1) {
                            newX = s2.x - s1.width - fixedDx;
                            hPoints.push(new mxPoint(newX + s1.width + shift, firstY));
                            hPoints.push(new mxPoint(s2.x - shift, firstY));
                        } else if (newState == s2) {
                            hPoints.push(new mxPoint(s1.x + s1.width + shift, firstY));
                            newX = s1.x + s1.width + fixedDx;
                            hPoints.push(new mxPoint(newX - shift, firstY));
                        } else {
                            hPoints.push(new mxPoint(s1.x + s1.width + shift, firstY));
                            hPoints.push(new mxPoint(s2.x - shift, firstY));
                        }
                    }
                } else //this is the case when there are 3 cells and the middle one is moving
                {
                    var s1 = horizontalCells[0];
                    var s3 = horizontalCells[2];
                    newX = s1.x + s1.width + (s3.x - s1.x - s1.width - newState.width) / 2;
                    hPoints.push(new mxPoint(s1.x + s1.width + shift, firstY));
                    hPoints.push(new mxPoint(newX - shift, firstY));
                    hPoints.push(new mxPoint(newX + newState.width + shift, firstY));
                    hPoints.push(new mxPoint(s3.x - shift, firstY));
                }

                for (var i = 0; i < hPoints.length; i += 2) {
                    var p1 = hPoints[i];
                    var p2 = hPoints[i + 1];
                    var guideEq = createEqGuide(p1, p2, curArr != null ? curArr[i / 2] : null);
                    guideEq.node.style.visibility = "visible";
                    guideEq.redraw();
                    guidesArr.push(guideEq);
                }

                //destroy old non-recycled guides
                for (var i = hPoints.length / 2; curArr != null && i < curArr.length; i++) {
                    curArr[i].destroy();
                }

                guide.guidesArrHor = guidesArr;

                xShift = newX - bounds.x;
                hasHorGuides = true;
            } else {
                hideEqGuides(true);
            }

            if (eqCy > 1 && eqCy == verticalCells.length - 1) {
                var guidesArr = [];
                var curArr = guide.guidesArrVer;
                var vPoints = [];
                var newY = 0;

                //If the newState (moving cell) is the first one, use the next one for x coordinate such that the guide doesn't move with the cell
                var firstI = verticalCells[0] == newState ? 1 : 0;
                var firstX = verticalCells[firstI].x + verticalCells[firstI].width;

                if (fixedDy > 0) {
                    for (var i = 0; i < verticalCells.length - 1; i++) {
                        var s1 = verticalCells[i];
                        var s2 = verticalCells[i + 1];

                        if (newState == s1) {
                            newY = s2.y - s1.height - fixedDy;
                            vPoints.push(new mxPoint(firstX, newY + s1.height + shift));
                            vPoints.push(new mxPoint(firstX, s2.y - shift));
                        } else if (newState == s2) {
                            vPoints.push(new mxPoint(firstX, s1.y + s1.height + shift));
                            newY = s1.y + s1.height + fixedDy;
                            vPoints.push(new mxPoint(firstX, newY - shift));
                        } else {
                            vPoints.push(new mxPoint(firstX, s1.y + s1.height + shift));
                            vPoints.push(new mxPoint(firstX, s2.y - shift));
                        }
                    }
                } else //this is the case when there are 3 cells and the middle one is moving
                {
                    var s1 = verticalCells[0];
                    var s3 = verticalCells[2];
                    newY = s1.y + s1.height + (s3.y - s1.y - s1.height - newState.height) / 2;
                    vPoints.push(new mxPoint(firstX, s1.y + s1.height + shift));
                    vPoints.push(new mxPoint(firstX, newY - shift));
                    vPoints.push(new mxPoint(firstX, newY + newState.height + shift));
                    vPoints.push(new mxPoint(firstX, s3.y - shift));
                }

                for (var i = 0; i < vPoints.length; i += 2) {
                    var p1 = vPoints[i];
                    var p2 = vPoints[i + 1];
                    var guideEq = createEqGuide(p1, p2, curArr != null ? curArr[i / 2] : null, true);
                    guideEq.node.style.visibility = "visible";
                    guideEq.redraw();
                    guidesArr.push(guideEq);
                }

                //destroy old non-recycled guides
                for (var i = vPoints.length / 2; curArr != null && i < curArr.length; i++) {
                    curArr[i].destroy();
                }

                guide.guidesArrVer = guidesArr;

                yShift = newY - bounds.y;
                hasVerGuides = true;
            } else {
                hideEqGuides(false, true);
            }
        }

        if (hasHorGuides || hasVerGuides) {
            var eqPoint = new mxPoint(xShift, yShift);
            var newPoint = guideMove.call(this, bounds, eqPoint, gridEnabled, clone);

            //Adjust our point to match non-conflicting other guides
            if (hasHorGuides && !hasVerGuides) {
                eqPoint.y = newPoint.y;
            } else if (hasVerGuides && !hasHorGuides) {
                eqPoint.x = newPoint.x;
            }

            //Hide other guide if this guide overrides them
            if (newPoint.y != eqPoint.y) {
                if (this.guideY != null && this.guideY.node != null) {
                    this.guideY.node.style.visibility = 'hidden';
                }
            }
            if (newPoint.x != eqPoint.x) {
                if (this.guideX != null && this.guideX.node != null) {
                    this.guideX.node.style.visibility = 'hidden';
                }
            }

            return eqPoint;
        } else {
            hideEqGuides(true, true);
            return guideMove.apply(this, arguments);
        }
    };

    var guideSetVisible = mxGuide.prototype.setVisible;

    mxGuide.prototype.setVisible = function (visible) {
        var guide = this;
        guideSetVisible.call(guide, visible);

        var guidesArrVer = guide.guidesArrVer;
        var guidesArrHor = guide.guidesArrHor;

        if (guidesArrVer != null) {
            for (var i = 0; i < guidesArrVer.length; i++) {
                guidesArrVer[i].node.style.visibility = visible ? "visible" : "hidden";
            }
        }

        if (guidesArrHor != null) {
            for (var i = 0; i < guidesArrHor.length; i++) {
                guidesArrHor[i].node.style.visibility = visible ? "visible" : "hidden";
            }
        }
    };

    var guideDestroy = mxGuide.prototype.destroy;

    mxGuide.prototype.destroy = function () {
        guideDestroy.call(this);
        var guidesArrVer = this.guidesArrVer;
        var guidesArrHor = this.guidesArrHor;

        if (guidesArrVer != null) {
            for (var i = 0; i < guidesArrVer.length; i++) {
                guidesArrVer[i].destroy();
            }
            this.guidesArrVer = null;
        }

        if (guidesArrHor != null) {
            for (var i = 0; i < guidesArrHor.length; i++) {
                guidesArrHor[i].destroy();
            }
            this.guidesArrHor = null;
        }
    };
})();
/**
 * Copyright (c) 2017, CTI LOGIC
 * Copyright (c) 2006-2017, JGraph Ltd
 * Copyright (c) 2006-2017, Gaudenz Alder
 *
 * Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:
 *
 * 1. Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer.
 *
 * 2. Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer in the documentation and/or other materials provided with the distribution.
 *
 * 3. Neither the name of the copyright holder nor the names of its contributors may be used to endorse or promote products derived from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS 'AS IS' AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY
 * AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
 * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,
 * WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

function mxRuler(editorUi, unit, isVertical, isSecondery) {
    var RULER_THICKNESS = this.RULER_THICKNESS;
    var ruler = this;
    this.unit = unit;
    var style = window.uiTheme != 'dark' ? {
        bkgClr: '#ffffff',
        outBkgClr: '#e8e9ed',
        cornerClr: '#fbfbfb',
        strokeClr: '#dadce0',
        fontClr: '#BBBBBB',
        guideClr: '#0000BB'
    } : {
        bkgClr: '#202020',
        outBkgClr: '#2a2a2a',
        cornerClr: '#2a2a2a',
        strokeClr: '#505759',
        fontClr: '#BBBBBB',
        guideClr: '#0088cf'
    };
    //create the container
    var container = document.createElement('div');
    container.style.position = 'absolute';
    container.style.background = style.bkgClr;
    container.style[isVertical ? 'borderRight' : 'borderBottom'] = '0.5px solid ' + style.strokeClr;
    container.style.borderLeft = '0.5px solid ' + style.strokeClr;

    document.body.appendChild(container);
    mxEvent.disableContextMenu(container);

    function resizeRulerContainer() {
        var diagCont = editorUi.diagramContainer;

        container.style.top = (diagCont.offsetTop - RULER_THICKNESS) + 'px';
        container.style.left = (diagCont.offsetLeft - RULER_THICKNESS) + 'px';
        container.style.width = ((isVertical ? 0 : diagCont.offsetWidth) + RULER_THICKNESS) + 'px';
        container.style.height = ((isVertical ? diagCont.offsetHeight : 0) + RULER_THICKNESS) + 'px';
    };

    this.editorUiRefresh = editorUi.refresh;

    editorUi.refresh = function (minor) {
        ruler.editorUiRefresh.apply(editorUi, arguments);

        resizeRulerContainer();
    };

    resizeRulerContainer();

    var canvas = document.createElement('canvas');
    //initial sizing which is corrected by the graph size event
    canvas.width = container.offsetWidth;
    canvas.height = container.offsetHeight;
    container.style.overflow = 'hidden';
    canvas.style.position = 'relative';
    container.appendChild(canvas);
    //Disable alpha to improve performance as we don't need it?
    var ctx = canvas.getContext('2d');
    this.ui = editorUi;
    var graph = editorUi.editor.graph;
    this.graph = graph;
    this.container = container;
    this.canvas = canvas;

    var drawLine = function (x1, y1, x2, y2, text) {
        //remove all fractions
        x1 = Math.round(x1);
        y1 = Math.round(y1);
        x2 = Math.round(x2);
        y2 = Math.round(y2);
        //adding the 0.5 is necessary to prevent anti-aliasing from making lines thicker!
        ctx.beginPath();
        ctx.moveTo(x1 + 0.5, y1 + 0.5);
        ctx.lineTo(x2 + 0.5, y2 + 0.5);
        ctx.stroke();

        if (text) {
            if (isVertical) {
                ctx.save();
                ctx.translate(x1, y1);
                ctx.rotate(-Math.PI / 2);
                ctx.fillText(text, 0, 0);
                ctx.restore();
            } else {
                ctx.fillText(text, x1, y1);
            }
        }
    };

    var drawRuler = function () {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        ctx.beginPath();
        ctx.lineWidth = 0.7;
        ctx.strokeStyle = style.strokeClr;
        ctx.setLineDash([]);
        ctx.font = '9px Arial';
        ctx.textAlign = 'center';

        var scale = graph.view.scale;
        var bgPages = graph.view.getBackgroundPageBounds();
        var t = graph.view.translate;
        var bounds = graph.view.getGraphBounds();
        var hasPageView = graph.pageVisible;

        //The beginning of the ruler (zero)
        var rStart = hasPageView ? RULER_THICKNESS + (isVertical ? bgPages.y - graph.container.scrollTop : bgPages.x - graph.container.scrollLeft)
            : RULER_THICKNESS + (isVertical ? t.y - graph.container.scrollTop : t.x - graph.container.scrollLeft);

        //handle negative pages
        var pageShift = 0;

        if (hasPageView) {
            if (isVertical) {
                var y = ((bounds.y + 1) / scale - t.y); // + 1 is for overcoming rounding error
                pageShift = Math.floor(y / graph.pageFormat.height) * graph.pageFormat.height * scale;
            } else {
                var x = ((bounds.x + 1) / scale - t.x); // + 1 is for overcoming rounding error
                pageShift = Math.floor(x / graph.pageFormat.width) * graph.pageFormat.width * scale;
            }
        }

        var tickStep, tickSize, len;

        switch (ruler.unit) {
            case mxConstants.POINTS:
                len = 10;
                tickStep = 10;
                tickSize = [3, 5, 5, 5, 5, 10, 5, 5, 5, 5];
                break;
            case mxConstants.MILLIMETERS:
                len = 10;
                tickStep = mxConstants.PIXELS_PER_MM;
                tickSize = [5, 3, 3, 3, 3, 6, 3, 3, 3, 3];
                break;
            case mxConstants.INCHES:
                if (scale <= 0.5 || scale >= 4)
                    len = 8;
                else
                    len = 16;

                tickStep = mxConstants.PIXELS_PER_INCH / len;
                tickSize = [5, 3, 5, 3, 7, 3, 5, 3, 7, 3, 5, 3, 7, 3, 5, 3];
                break;
        }

        //Handle step size and change it with large/small scale
        var step = tickStep;

        if (scale >= 2) {
            step = tickStep / (Math.floor(scale / 2) * 2);
        } else if (scale <= 0.5) {
            step = tickStep * (Math.floor((1 / scale) / 2) * (ruler.unit == mxConstants.MILLIMETERS ? 2 : 1));
        }

        var lastTick = null;

        //End of the ruler (pages end)
        var rEnd = hasPageView ? Math.min(rStart + (isVertical ? bgPages.height : bgPages.width), isVertical ? canvas.height : canvas.width) : (isVertical ? canvas.height : canvas.width);

        if (hasPageView) {
            //Clear the outside page part with a different color
            ctx.fillStyle = style.outBkgClr;

            if (isVertical) {
                ctx.fillRect(0, RULER_THICKNESS, RULER_THICKNESS, rStart - RULER_THICKNESS);
                ctx.fillRect(0, rEnd, RULER_THICKNESS, canvas.height);
            } else {
                ctx.fillRect(RULER_THICKNESS, 0, rStart - RULER_THICKNESS, RULER_THICKNESS);
                ctx.fillRect(rEnd, 0, canvas.width, RULER_THICKNESS);
            }
        }

        //Draw ticks
        ctx.fillStyle = style.fontClr;

        for (var i = hasPageView ? rStart : rStart % (step * scale); i <= rEnd; i += step * scale) {
            var current = Math.round((i - rStart) / scale / step);

            if (i < RULER_THICKNESS || current == lastTick) //Prevent wasting time in drawing non-visible/duplicate lines
            {
                continue;
            }

            lastTick = current;
            var text = null;

            if (current % len == 0) {
                text = ruler.formatText(pageShift + current * step) + '';
            }

            if (isVertical) {
                drawLine(RULER_THICKNESS - tickSize[Math.abs(current) % len], i, RULER_THICKNESS, i, text);
            } else {
                drawLine(i, RULER_THICKNESS - tickSize[Math.abs(current) % len], i, RULER_THICKNESS, text);
            }
        }

        //Draw corner rect
        ctx.lineWidth = 1;
        drawLine(isVertical ? 0 : RULER_THICKNESS, isVertical ? RULER_THICKNESS : 0, RULER_THICKNESS, RULER_THICKNESS);
        ctx.fillStyle = style.cornerClr;
        ctx.fillRect(0, 0, RULER_THICKNESS, RULER_THICKNESS);
    };

    var sizeListener = function () {
        var div = graph.container;

        if (isVertical) {
            var newH = div.offsetHeight + RULER_THICKNESS;

            if (canvas.height != newH) {
                canvas.height = newH;
                container.style.height = newH + 'px';
                drawRuler();
            }
        } else {
            var newW = div.offsetWidth + RULER_THICKNESS;

            if (canvas.width != newW) {
                canvas.width = newW;
                container.style.width = newW + 'px';
                drawRuler();
            }
        }
    };

    this.drawRuler = drawRuler;

    var efficientSizeListener = debounce(sizeListener, 10);
    this.sizeListener = efficientSizeListener;

    this.pageListener = function () {
        drawRuler();
    };

    var efficientScrollListener = debounce(function () {
        var newScroll = isVertical ? graph.container.scrollTop : graph.container.scrollLeft;

        if (ruler.lastScroll != newScroll) {
            ruler.lastScroll = newScroll;
            drawRuler();
        }
    }, 10);

    this.scrollListener = efficientScrollListener;
    this.unitListener = function (sender, evt) {
        ruler.setUnit(evt.getProperty('unit'));
    };

    graph.addListener(mxEvent.SIZE, efficientSizeListener);
    graph.container.addEventListener('scroll', efficientScrollListener);
    graph.view.addListener('unitChanged', this.unitListener);
    editorUi.addListener('pageViewChanged', this.pageListener);
    editorUi.addListener('pageScaleChanged', this.pageListener);
    editorUi.addListener('pageFormatChanged', this.pageListener);

    function debounce(func, wait, immediate) {
        var timeout;
        return function () {
            var context = this, args = arguments;
            var later = function () {
                timeout = null;
                if (!immediate) func.apply(context, args);
            };
            var callNow = immediate && !timeout;
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
            if (callNow) func.apply(context, args);
        };
    };

    this.setStyle = function (newStyle) {
        style = newStyle;
        container.style.background = style.bkgClr;
        drawRuler();
    }

    //Showing guides on cell move
    this.origGuideMove = mxGuide.prototype.move;

    mxGuide.prototype.move = function (bounds, delta, gridEnabled, clone) {
        if (ruler.guidePart != null) {
            ctx.putImageData(ruler.guidePart.imgData1, ruler.guidePart.x1, ruler.guidePart.y1);
            ctx.putImageData(ruler.guidePart.imgData2, ruler.guidePart.x2, ruler.guidePart.y2);
            ctx.putImageData(ruler.guidePart.imgData3, ruler.guidePart.x3, ruler.guidePart.y3);
        }

        var ret = ruler.origGuideMove.apply(this, arguments);

        var x1, y1, imgData1, x2, y2, imgData2, x3, y3, imgData3;
        ctx.lineWidth = 0.5;
        ctx.strokeStyle = style.guideClr;
        ctx.setLineDash([2]);

        if (isVertical) {
            y1 = bounds.y + ret.y + RULER_THICKNESS - this.graph.container.scrollTop;
            x1 = 0;
            y2 = y1 + bounds.height / 2;
            x2 = RULER_THICKNESS / 2;
            y3 = y1 + bounds.height;
            x3 = 0;
            imgData1 = ctx.getImageData(x1, y1, RULER_THICKNESS, 5);
            drawLine(x1, y1, RULER_THICKNESS, y1);
            imgData2 = ctx.getImageData(x2, y2, RULER_THICKNESS, 5);
            drawLine(x2, y2, RULER_THICKNESS, y2);
            imgData3 = ctx.getImageData(x3, y3, RULER_THICKNESS, 5);
            drawLine(x3, y3, RULER_THICKNESS, y3);
        } else {
            y1 = 0;
            x1 = bounds.x + ret.x + RULER_THICKNESS - this.graph.container.scrollLeft;
            y2 = RULER_THICKNESS / 2;
            x2 = x1 + bounds.width / 2;
            y3 = 0;
            x3 = x1 + bounds.width;
            imgData1 = ctx.getImageData(x1, y1, 5, RULER_THICKNESS);
            drawLine(x1, y1, x1, RULER_THICKNESS);
            imgData2 = ctx.getImageData(x2, y2, 5, RULER_THICKNESS);
            drawLine(x2, y2, x2, RULER_THICKNESS);
            imgData3 = ctx.getImageData(x3, y3, 5, RULER_THICKNESS);
            drawLine(x3, y3, x3, RULER_THICKNESS);
        }

        if (ruler.guidePart == null || ruler.guidePart.x1 != x1 || ruler.guidePart.y1 != y1) {
            ruler.guidePart = {
                imgData1: imgData1,
                x1: x1,
                y1: y1,
                imgData2: imgData2,
                x2: x2,
                y2: y2,
                imgData3: imgData3,
                x3: x3,
                y3: y3
            }
        }

        return ret;
    }

    this.origGuideDestroy = mxGuide.prototype.destroy;

    mxGuide.prototype.destroy = function () {
        var ret = ruler.origGuideDestroy.apply(this, arguments);

        if (ruler.guidePart != null) {
            ctx.putImageData(ruler.guidePart.imgData1, ruler.guidePart.x1, ruler.guidePart.y1);
            ctx.putImageData(ruler.guidePart.imgData2, ruler.guidePart.x2, ruler.guidePart.y2);
            ctx.putImageData(ruler.guidePart.imgData3, ruler.guidePart.x3, ruler.guidePart.y3);
            ruler.guidePart = null;
        }

        return ret;
    };
};

mxRuler.prototype.RULER_THICKNESS = 14;
mxRuler.prototype.unit = mxConstants.POINTS;

mxRuler.prototype.setUnit = function (unit) {
    this.unit = unit;
    this.drawRuler();
};

mxRuler.prototype.formatText = function (pixels) {
    switch (this.unit) {
        case mxConstants.POINTS:
            return Math.round(pixels);
        case mxConstants.MILLIMETERS:
            return (pixels / mxConstants.PIXELS_PER_MM).toFixed(1);
        case mxConstants.INCHES:
            return (pixels / mxConstants.PIXELS_PER_INCH).toFixed(2);
    }
};

mxRuler.prototype.destroy = function () {
    this.ui.refresh = this.editorUiRefresh;
    mxGuide.prototype.move = this.origGuideMove;
    mxGuide.prototype.destroy = this.origGuideDestroy;
    this.graph.removeListener(this.sizeListener);
    this.graph.container.removeEventListener('scroll', this.scrollListener);
    this.graph.view.removeListener('unitChanged', this.unitListener);
    this.ui.removeListener('pageViewChanged', this.pageListener);
    this.ui.removeListener('pageScaleChanged', this.pageListener);
    this.ui.removeListener('pageFormatChanged', this.pageListener);

    if (this.container != null) {
        this.container.parentNode.removeChild(this.container);
    }
};

function mxDualRuler(editorUi, unit) {
    var rulerOffset = new mxPoint(mxRuler.prototype.RULER_THICKNESS, mxRuler.prototype.RULER_THICKNESS);
    this.editorUiGetDiagContOffset = editorUi.getDiagramContainerOffset;

    editorUi.getDiagramContainerOffset = function () {
        return rulerOffset;
    };

    this.editorUiRefresh = editorUi.refresh;
    this.ui = editorUi;
    this.origGuideMove = mxGuide.prototype.move;
    this.origGuideDestroy = mxGuide.prototype.destroy;

    this.vRuler = new mxRuler(editorUi, unit, true);
    this.hRuler = new mxRuler(editorUi, unit, false, true);

    // Adds units context menu
    var installMenu = mxUtils.bind(this, function (node) {
        var menuWasVisible = false;

        mxEvent.addGestureListeners(node, mxUtils.bind(this, function (evt) {
            menuWasVisible = editorUi.currentMenu != null;
            mxEvent.consume(evt);
        }), null, mxUtils.bind(this, function (evt) {
            if (editorUi.editor.graph.isEnabled() && !editorUi.editor.graph.isMouseDown &&
                (mxEvent.isTouchEvent(evt) || mxEvent.isPopupTrigger(evt))) {
                editorUi.editor.graph.popupMenuHandler.hideMenu();
                editorUi.hideCurrentMenu();
                mxEvent.consume(evt);
            }
        }));
    });

    installMenu(this.hRuler.container);
    installMenu(this.vRuler.container);

    this.vRuler.drawRuler();
    this.hRuler.drawRuler();
};

mxDualRuler.prototype.setUnit = function (unit) {
    this.vRuler.setUnit(unit);
    this.hRuler.setUnit(unit);
};

mxDualRuler.prototype.setStyle = function (newStyle) {
    this.vRuler.setStyle(newStyle);
    this.hRuler.setStyle(newStyle);
}

mxDualRuler.prototype.destroy = function () {
    this.vRuler.destroy();
    this.hRuler.destroy();
    this.ui.refresh = this.editorUiRefresh;
    mxGuide.prototype.move = this.origGuideMove;
    mxGuide.prototype.destroy = this.origGuideDestroy;
    this.ui.getDiagramContainerOffset = this.editorUiGetDiagContOffset;
};
function mxFreehand(graph) {
    //Graph must have a container
    if (graph.container == null || graph.container.querySelector('svg') == null) {
        return;
    }

    //Code inspired by https://stackoverflow.com/questions/40324313/svg-smooth-freehand-drawing
    var svgElement = graph.container.querySelector('svg');

    var bufferSize = mxFreehand.prototype.NORMAL_SMOOTHING;
    var path = null;
    var partPathes = [];
    var strPath;
    var drawPoints = [];
    var lastPart;
    var closedPath = false;
    var autoClose = true;
    var buffer = []; // Contains the last positions of the mouse cursor
    var enabled = false;
    var stopClickEnabled = false;

    this.setClosedPath = function (isClosed)//TODO add closed settings
    {
        closedPath = isClosed;
    };

    this.setAutoClose = function (isAutoClose)//TODO add auto closed settings
    {
        autoClose = isAutoClose;
    };

    this.setStopClickEnabled = function (enabled) {
        stopClickEnabled = enabled;
    };

    this.setSmoothing = function (smoothing)//TODO add smoothing settings
    {
        bufferSize = smoothing;
    };

    var setEnabled = function (isEnabled) {
        enabled = isEnabled;
        graph.getRubberband().setEnabled(!isEnabled);
        graph.graphHandler.setSelectEnabled(!isEnabled);
        graph.graphHandler.setMoveEnabled(!isEnabled);
        graph.container.style.cursor = (isEnabled) ? 'crosshair' : '';
        graph.fireEvent(new mxEventObject('freehandStateChanged'));
    };

    this.startDrawing = function () {
        setEnabled(true);
    }

    this.isDrawing = function () {
        return enabled;
    };

    var endPath = mxUtils.bind(this, function (e) {
        if (path) {
            // Click stops drawing
            var doStop = stopClickEnabled && drawPoints.length > 0 &&
                lastPart != null && lastPart.length < 2;

            if (!doStop) {
                drawPoints.push.apply(drawPoints, lastPart);
            }

            lastPart = [];
            drawPoints.push(null);
            partPathes.push(path);
            path = null;

            if (doStop) {
                this.stopDrawing();
            }

            mxEvent.consume(e);
        }
    });

    this.stopDrawing = function () {
        if (partPathes.length > 0) {
            var maxX = drawPoints[0].x, minX = drawPoints[0].x, maxY = drawPoints[0].y, minY = drawPoints[0].y;

            for (var i = 1; i < drawPoints.length; i++) {
                if (drawPoints[i] == null) continue;

                maxX = Math.max(maxX, drawPoints[i].x);
                minX = Math.min(minX, drawPoints[i].x);
                maxY = Math.max(maxY, drawPoints[i].y);
                minY = Math.min(minY, drawPoints[i].y);
            }

            var w = maxX - minX, h = maxY - minY;

            if (w > 0 && h > 0) {
                var xScale = 100 / w;
                var yScale = 100 / h;

                drawPoints.map(function (p) {
                    if (p == null) return p;

                    p.x = (p.x - minX) * xScale;
                    p.y = (p.y - minY) * yScale;
                    return p;
                });

                //toFixed(2) to reduce size of output
                var drawShape = '<shape strokewidth="inherit"><foreground>';

                var start = 0;

                for (var i = 0; i < drawPoints.length; i++) {
                    var p = drawPoints[i];

                    if (p == null) {
                        var tmpClosedPath = false;
                        var startP = drawPoints[start], endP = drawPoints[i - 1];

                        if (!closedPath && autoClose) {
                            var xdiff = startP.x - endP.x, ydiff = startP.y - endP.y;
                            var startEndDist = Math.sqrt(xdiff * xdiff + ydiff * ydiff);

                            tmpClosedPath = startEndDist <= graph.tolerance;
                        }

                        if (closedPath || tmpClosedPath) {
                            drawShape += '<line x="' + startP.x.toFixed(2) + '" y="' + startP.y.toFixed(2) + '"/>';
                        }

                        drawShape += '</path>' + ((closedPath || tmpClosedPath) ? '<fillstroke/>' : '<stroke/>');
                        start = i + 1;
                    } else if (i == start) {
                        drawShape += '<path><move x="' + p.x.toFixed(2) + '" y="' + p.y.toFixed(2) + '"/>'
                    } else {
                        drawShape += '<line x="' + p.x.toFixed(2) + '" y="' + p.y.toFixed(2) + '"/>';
                    }
                }

                drawShape += '</foreground></shape>';

                var style = mxConstants.STYLE_SHAPE + '=stencil(' + Graph.compress(drawShape) + ');fillColor=none;';
                var s = graph.view.scale;
                var tr = graph.view.translate;

                var cell = new mxCell('', new mxGeometry(minX / s - tr.x, minY / s - tr.y, w / s, h / s), style);
                cell.vertex = 1;

                graph.model.beginUpdate();
                try {
                    cell = graph.addCell(cell);
                } finally {
                    graph.model.endUpdate();
                }

                graph.fireEvent(new mxEventObject('cellsInserted', 'cells', [cell]));
                graph.fireEvent(new mxEventObject('freehandInserted', 'cell', cell));
                //While mouse is down, we cannot select!
                setTimeout(function () {
                    graph.setSelectionCells([cell]);
                }, 10);
            }

            for (var i = 0; i < partPathes.length; i++) {
                partPathes[i].parentNode.removeChild(partPathes[i]);
            }

            path = null;
            partPathes = [];
            drawPoints = [];
        }

        setEnabled(false);
    };

    mxEvent.addGestureListeners(svgElement, function (e) {
        if (!enabled) {
            return;
        }

        var strokeWidth = parseFloat(graph.currentVertexStyle[mxConstants.STYLE_STROKEWIDTH] || 1);
        strokeWidth = Math.max(1, strokeWidth * graph.view.scale);
        path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        path.setAttribute("fill", "none");
        path.setAttribute("stroke", graph.currentVertexStyle[mxConstants.STYLE_STROKECOLOR] || "#000");
        path.setAttribute("stroke-width", strokeWidth);

        if (graph.currentVertexStyle[mxConstants.STYLE_DASHED] == '1') {
            var dashPattern = graph.currentVertexStyle[mxConstants.STYLE_DASH_PATTERN] || '3 3';

            dashPattern = dashPattern.split(' ').map(function (p) {
                return parseFloat(p) * strokeWidth;
            }).join(' ');
            path.setAttribute('stroke-dasharray', dashPattern);
        }

        buffer = [];
        var pt = getMousePosition(e);
        appendToBuffer(pt);
        strPath = "M" + pt.x + " " + pt.y;
        drawPoints.push(pt);
        lastPart = [];
        path.setAttribute("d", strPath);
        svgElement.appendChild(path);
        mxEvent.consume(e);
    }, function (e) {
        if (path) {
            appendToBuffer(getMousePosition(e));
            updateSvgPath();
            mxEvent.consume(e);
        }
    }, endPath);

    var getMousePosition = function (e) {
        return mxUtils.convertPoint(graph.container, mxEvent.getClientX(e), mxEvent.getClientY(e));
    };

    var appendToBuffer = function (pt) {
        buffer.push(pt);

        while (buffer.length > bufferSize) {
            buffer.shift();
        }
    };

    // Calculate the average point, starting at offset in the buffer
    var getAveragePoint = function (offset) {
        var len = buffer.length;

        if (len % 2 === 1 || len >= bufferSize) {
            var totalX = 0;
            var totalY = 0;
            var pt, i;
            var count = 0;

            for (i = offset; i < len; i++) {
                count++;
                pt = buffer[i];
                totalX += pt.x;
                totalY += pt.y;
            }

            return {
                x: totalX / count,
                y: totalY / count
            }
        }

        return null;
    };

    var updateSvgPath = function () {
        var pt = getAveragePoint(0);

        if (pt) {
            // Get the smoothed part of the path that will not change
            strPath += " L" + pt.x + " " + pt.y;
            drawPoints.push(pt);
            // Get the last part of the path (close to the current mouse position)
            // This part will change if the mouse moves again
            var tmpPath = "";
            lastPart = [];

            for (var offset = 2; offset < buffer.length; offset += 2) {
                pt = getAveragePoint(offset);
                tmpPath += " L" + pt.x + " " + pt.y;
                lastPart.push(pt);
            }

            // Set the complete current path coordinates
            path.setAttribute("d", strPath + tmpPath);
        }
    };
};

mxFreehand.prototype.NO_SMOOTHING = 1;
mxFreehand.prototype.MILD_SMOOTHING = 4;
mxFreehand.prototype.NORMAL_SMOOTHING = 8;
mxFreehand.prototype.VERY_SMOOTH_SMOOTHING = 12;
mxFreehand.prototype.SUPER_SMOOTH_SMOOTHING = 16;
mxFreehand.prototype.HYPER_SMOOTH_SMOOTHING = 20;
